var y8=Object.create;var{getPrototypeOf:C8,defineProperty:i,getOwnPropertyNames:z8}=Object;var F8=Object.prototype.hasOwnProperty;var O8=(U,K,$)=>{$=U!=null?y8(C8(U)):{};let J=K||!U||!U.__esModule?i($,"default",{value:U,enumerable:!0}):$;for(let G of z8(U))if(!F8.call(J,G))i(J,G,{get:()=>U[G],enumerable:!0});return J};var S8=(U,K)=>()=>(K||U((K={exports:{}}).exports,K),K.exports);var B8=S8((JU,R8)=>{var f,l,a,o,p,d,M8,D8;function W8(U){if(U<0.5)U=0.5;var K=Math.exp(0.527076)/U,$=Math.exp(-K),J=Math.exp(-2*K),G=(1-$)*(1-$)/(1+2*K*$-J);return f=G,l=G*(K-1)*$,a=G*(K+1)*$,o=-G*J,p=2*$,d=-J,M8=(f+l)/(1-p-d),D8=(a+o)/(1-p-d),new Float32Array([f,l,a,o,p,d,M8,D8])}function Q8(U,K,$,J,G,M){var Z,A,j,L,Q,D,B,R,E,X,N,q,V,Y,C,O,y,z,P,H,W,F,w,S,h,u,b,T,k,v;for(h=0;h<M;h++){F=h*G,w=h,S=0,Z=U[F],A=Z&255,j=Z>>8&255,L=Z>>16&255,Q=Z>>24&255,z=A*J[6],P=j*J[6],H=L*J[6],W=Q*J[6],Y=z,C=P,O=H,y=W,b=J[0],T=J[1],k=J[4],v=J[5];for(u=0;u<G;u++)Z=U[F],D=Z&255,B=Z>>8&255,R=Z>>16&255,E=Z>>24&255,X=D*b+A*T+Y*k+z*v,N=B*b+j*T+C*k+P*v,q=R*b+L*T+O*k+H*v,V=E*b+Q*T+y*k+W*v,z=Y,P=C,H=O,W=y,Y=X,C=N,O=q,y=V,A=D,j=B,L=R,Q=E,$[S]=Y,$[S+1]=C,$[S+2]=O,$[S+3]=y,S+=4,F++;F--,S-=4,w+=M*(G-1),Z=U[F],A=Z&255,j=Z>>8&255,L=Z>>16&255,Q=Z>>24&255,z=A*J[7],P=j*J[7],H=L*J[7],W=Q*J[7],Y=z,C=P,O=H,y=W,D=A,B=j,R=L,E=Q,b=J[2],T=J[3];for(u=G-1;u>=0;u--)X=D*b+A*T+Y*k+z*v,N=B*b+j*T+C*k+P*v,q=R*b+L*T+O*k+H*v,V=E*b+Q*T+y*k+W*v,z=Y,P=C,H=O,W=y,Y=X,C=N,O=q,y=V,A=D,j=B,L=R,Q=E,Z=U[F],D=Z&255,B=Z>>8&255,R=Z>>16&255,E=Z>>24&255,Z=($[S]+Y<<0)+($[S+1]+C<<8)+($[S+2]+O<<16)+($[S+3]+y<<24),K[w]=Z,F--,S-=4,w-=M}}function b8(U,K,$,J){if(!J)return;var G=new Uint32Array(U.buffer),M=new Uint32Array(G.length),Z=new Float32Array(Math.max(K,$)*4),A=W8(J);Q8(G,M,Z,A,K,$,J),Q8(M,G,Z,A,$,K,J)}R8.exports=b8});var I8=2;function r(U,K,$,J,G,M){let Z=$/U,A=J/K,j=(2*M+I8+1)/G;if(j>0.5)return[{toWidth:$,toHeight:J}];let L=Math.ceil(Math.log(Math.min(Z,A))/Math.log(j));if(L<=1)return[{toWidth:$,toHeight:J}];let Q=[];for(let D=0;D<L;D++){let B=Math.round(Math.pow(Math.pow(U,L-D-1)*Math.pow($,D+1),1/L)),R=Math.round(Math.pow(Math.pow(K,L-D-1)*Math.pow(J,D+1),1/L));Q.push({toWidth:B,toHeight:R})}return Q}function t(U,K,$){let J=new Uint8ClampedArray($.width*$.height*I);for(let G=0;G<$.height;G++){let M=(($.y+G)*K+$.x)*I,Z=G*$.width*I;J.set(U.subarray(M,M+$.width*I),Z)}return J}var U8=0.00001;function g(U){let K=Math.round(U);if(Math.abs(U-K)<U8)return K;return Math.floor(U)}function e(U){let K=Math.round(U);if(Math.abs(U-K)<U8)return K;return Math.ceil(U)}function J8(U,K,$,J,G,M,Z,A,j,L,Q){let D=J/K,B=G/$,R=g(M*D)-2*Z,E=g(M*B)-2*Z;if(R<1||E<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let X,N,q,V,Y,C,O=[];for(V=0;V<G;V+=E)for(q=0;q<J;q+=R){if(X=q-Z,X<0)X=0;if(Y=q+R+Z-X,X+Y>=J)Y=J-X;if(N=V-Z,N<0)N=0;if(C=V+E+Z-N,N+C>=G)C=G-N;let y={toX:X,toY:N,toWidth:Y,toHeight:C,toInnerX:q,toInnerY:V,toInnerWidth:R,toInnerHeight:E,offsetX:X/D-g(X/D),offsetY:N/B-g(N/B),scaleX:D,scaleY:B,x:g(X/D),y:g(N/B),width:e(Y/D),height:e(C/B),initialSize:M,filterPadding:Z,filter:A,unsharpAmount:j,unsharpRadius:L,unsharpThreshold:Q},z=t(U,K,y);O.push({tile:z.buffer,...y})}return O}var I=4;async function K8(U){let K,$,J,G,M,Z;if(U.image instanceof Blob){let j=await createImageBitmap(U.image),Q=new OffscreenCanvas(j.width,j.height).getContext("2d");if(!Q)throw new Error("Canvas 2D context not supported");Q.drawImage(j,0,0),K=Q.getImageData(0,0,j.width,j.height).data,$=j.width,J=j.height,j.close();let B=U.maxDimension/$,R=U.maxDimension/J,E=Math.min(B,R,1),X=Math.floor($*E),N=Math.floor(J*E);Z=r($,J,X,N,U.tileOptions.initialSize,U.tileOptions.filterPadding)}else K=U.image.from,$=U.image.fromWidth,J=U.image.fromHeight,Z=U.image.stages;G=Z[0].toWidth,M=Z[0].toHeight;let A=J8(K,$,J,G,M,U.tileOptions.initialSize,U.tileOptions.filterPadding,U.tileOptions.filter,U.tileOptions.unsharpAmount,U.tileOptions.unsharpRadius,U.tileOptions.unsharpThreshold);return{from:K.buffer,fromWidth:$,fromHeight:J,tileTransforms:A,stages:Z}}function n(U,K,$){let J=new Uint8ClampedArray($.tile);for(let G=0;G<$.toHeight;G++){let M=G*$.toWidth*I,Z=(($.toY+G)*K+$.toX)*I;U.set(J.subarray(M,M+$.toWidth*I),Z)}}var _={box:{win:0.5,fn:(U)=>{if(U<0)U=-U;return U<0.5?1:0}},hamming:{win:1,fn:(U)=>{if(U<0)U=-U;if(U>=1)return 0;if(U<0.00000011920929)return 1;let K=U*Math.PI;return Math.sin(K)/K*(0.54+0.46*Math.cos(K/1))}},lanczos2:{win:2,fn:(U)=>{if(U<0)U=-U;if(U>=2)return 0;if(U<0.00000011920929)return 1;let K=U*Math.PI;return Math.sin(K)/K*Math.sin(K/2)/(K/2)}},lanczos3:{win:3,fn:(U)=>{if(U<0)U=-U;if(U>=3)return 0;if(U<0.00000011920929)return 1;let K=U*Math.PI;return Math.sin(K)/K*Math.sin(K/3)/(K/3)}},mks2013:{win:2.5,fn:(U)=>{if(U<0)U=-U;if(U>=2.5)return 0;if(U>=1.5)return-0.125*(U-2.5)*(U-2.5);if(U>=0.5)return 0.25*(4*U*U-11*U+7);return 1.0625-1.75*U*U}}};var H8=14;function $8(U){return Math.round(U*((1<<H8)-1))}function c(U,K,$,J,G){let M=_[U].fn,Z=1/J,A=Math.min(1,J),j=_[U].win/A,L,Q,D,B,R,E,X,N,q,V,Y,C,O,y,z,P,H,W=Math.floor((j+1)*2),F=new Int16Array((W+2)*$),w=0,S=!F.subarray||!F.set;for(L=0;L<$;L++){Q=(L+0.5)*Z+G,D=Math.max(0,Math.floor(Q-j)),B=Math.min(K-1,Math.ceil(Q+j)),R=B-D+1,E=new Float32Array(R),X=new Int16Array(R),N=0;for(q=D,V=0;q<=B;q++,V++)Y=M((q+0.5-Q)*A),N+=Y,E[V]=Y;C=0;for(V=0;V<E.length;V++)O=E[V]/N,C+=O,X[V]=$8(O);X[$>>1]+=$8(1-C),y=0;while(y<X.length&&X[y]===0)y++;if(y<X.length){z=X.length-1;while(z>0&&X[z]===0)z--;if(P=D+y,H=z-y+1,F[w++]=P,F[w++]=H,!S)F.set(X.subarray(y,z+1),w),w+=H;else for(V=y;V<=z;V++)F[w++]=X[V]}else F[w++]=0,F[w++]=0}return F}function x(U){return U<0?0:U>255?255:U}function m(U){return U>=0?U:0}function Z8(U,K,$,J,G,M){let Z,A,j,L,Q,D,B,R,E,X,N,q=0,V=0;for(E=0;E<J;E++){Q=0;for(X=0;X<G;X++){D=M[Q++],B=M[Q++],R=q+D*4|0,Z=A=j=L=0;for(;B>0;B--)N=M[Q++],L=L+N*U[R+3]|0,j=j+N*U[R+2]|0,A=A+N*U[R+1]|0,Z=Z+N*U[R]|0,R=R+4|0;K[V+3]=m(L>>7),K[V+2]=m(j>>7),K[V+1]=m(A>>7),K[V]=m(Z>>7),V=V+J*4|0}V=(E+1)*4|0,q=(E+1)*$*4|0}}function G8(U,K,$,J,G,M){let Z,A,j,L,Q,D,B,R,E,X,N,q=0,V=0;for(E=0;E<J;E++){Q=0;for(X=0;X<G;X++){D=M[Q++],B=M[Q++],R=q+D*4|0,Z=A=j=L=0;for(;B>0;B--)N=M[Q++],L=L+N*U[R+3]|0,j=j+N*U[R+2]|0,A=A+N*U[R+1]|0,Z=Z+N*U[R]|0,R=R+4|0;Z>>=7,A>>=7,j>>=7,L>>=7,K[V+3]=x(L+8192>>14),K[V+2]=x(j+8192>>14),K[V+1]=x(A+8192>>14),K[V]=x(Z+8192>>14),V=V+J*4|0}V=(E+1)*4|0,q=(E+1)*$*4|0}}function A8(U,K,$,J,G,M){let Z,A,j,L,Q,D,B,R,E,X,N,q,V=0,Y=0;for(X=0;X<J;X++){D=0;for(N=0;N<G;N++){B=M[D++],R=M[D++],E=V+B*4|0,Z=A=j=L=0;for(;R>0;R--)q=M[D++],Q=U[E+3],L=L+q*Q|0,j=j+q*U[E+2]*Q|0,A=A+q*U[E+1]*Q|0,Z=Z+q*U[E]*Q|0,E=E+4|0;j=j/255|0,A=A/255|0,Z=Z/255|0,K[Y+3]=m(L>>7),K[Y+2]=m(j>>7),K[Y+1]=m(A>>7),K[Y]=m(Z>>7),Y=Y+J*4|0}Y=(X+1)*4|0,V=(X+1)*$*4|0}}function j8(U,K,$,J,G,M){let Z,A,j,L,Q,D,B,R,E,X,N,q=0,V=0;for(E=0;E<J;E++){Q=0;for(X=0;X<G;X++){D=M[Q++],B=M[Q++],R=q+D*4|0,Z=A=j=L=0;for(;B>0;B--)N=M[Q++],L=L+N*U[R+3]|0,j=j+N*U[R+2]|0,A=A+N*U[R+1]|0,Z=Z+N*U[R]|0,R=R+4|0;if(Z>>=7,A>>=7,j>>=7,L>>=7,L=x(L+8192>>14),L>0)Z=Z*255/L|0,A=A*255/L|0,j=j*255/L|0;K[V+3]=L,K[V+2]=x(j+8192>>14),K[V+1]=x(A+8192>>14),K[V]=x(Z+8192>>14),V=V+J*4|0}V=(E+1)*4|0,q=(E+1)*$*4|0}}function w8(U,K,$){let J=3,G=K*$*4|0;while(J<G){if(U[J]!==255)return!0;J=J+4|0}return!1}function P8(U,K,$){let J=3,G=K*$*4|0;while(J<G)U[J]=255,J=J+4|0}function L8(U,K,$,J,G,M,Z,A,j,L){let Q=c(K,$,G,Z,j),D=c(K,J,M,A,L),B=new Uint8Array(G*M*4),R=new Uint16Array(G*J*4);if(w8(U,$,J))A8(U,R,$,J,G,Q),j8(R,B,J,G,M,D);else Z8(U,R,$,J,G,Q),G8(R,B,J,G,M,D),P8(B,G,M);return B}var V8=O8(B8(),1);function T8(U,K,$){let J=K*$,G=new Uint16Array(J),M,Z,A,j;for(let L=0;L<J;L++)M=U[4*L],Z=U[4*L+1],A=U[4*L+2],j=M>=Z&&M>=A?M:Z>=A&&Z>=M?Z:A,G[L]=j<<8;return G}function N8(U,K,$,J,G,M){let Z,A,j,L,Q;if(J===0||G<0.5)return;if(G>2)G=2;let D=T8(U,K,$),B=new Uint16Array(D);V8.default(B,K,$,G);let R=J/100*4096+0.5|0,E=M<<8,X=K*$;for(let N=0;N<X;N++)if(Z=D[N],L=Z-B[N],Math.abs(L)>=E)A=Z+(R*L+2048>>12),A=A>65280?65280:A,A=A<0?0:A,Z=Z!==0?Z:1,j=(A<<12)/Z|0,Q=N*4,U[Q]=U[Q]*j+2048>>12,U[Q+1]=U[Q+1]*j+2048>>12,U[Q+2]=U[Q+2]*j+2048>>12}function E8(U){let K=L8(new Uint8ClampedArray(U.tile),U.filter,U.width,U.height,U.toWidth,U.toHeight,U.scaleX,U.scaleY,U.offsetX,U.offsetY);if(U.unsharpAmount)N8(K,U.toWidth,U.toHeight,U.unsharpAmount,U.unsharpRadius,U.unsharpThreshold);return K}var k8=`
var Y8=Object.create;var{getPrototypeOf:y8,defineProperty:o,getOwnPropertyNames:O8}=Object;var C8=Object.prototype.hasOwnProperty;var z8=(M,J,K)=>{K=M!=null?Y8(y8(M)):{};let U=J||!M||!M.__esModule?o(K,"default",{value:M,enumerable:!0}):K;for(let Z of O8(M))if(!C8.call(U,Z))o(U,Z,{get:()=>M[Z],enumerable:!0});return U};var F8=(M,J)=>()=>(J||M((J={exports:{}}).exports,J),J.exports);var V8=F8((RM,E8)=>{var _,f,l,a,h,p,L8,Q8;function b8(M){if(M<0.5)M=0.5;var J=Math.exp(0.527076)/M,K=Math.exp(-J),U=Math.exp(-2*J),Z=(1-K)*(1-K)/(1+2*J*K-U);return _=Z,f=Z*(J-1)*K,l=Z*(J+1)*K,a=-Z*U,h=2*K,p=-U,L8=(_+f)/(1-h-p),Q8=(l+a)/(1-h-p),new Float32Array([_,f,l,a,h,p,L8,Q8])}function B8(M,J,K,U,Z,D){var $,G,A,R,j,N,q,L,E,V,B,X,Q,Y,O,F,y,C,w,I,W,z,H,S,g,n,b,T,k,m;for(g=0;g<D;g++){z=g*Z,H=g,S=0,$=M[z],G="<WORKER_CODE>"255,A=$>>8&255,R=$>>16&255,j=$>>24&255,C=G*U[6],w=A*U[6],I=R*U[6],W=j*U[6],Y=C,O=w,F=I,y=W,b=U[0],T=U[1],k=U[4],m=U[5];for(n=0;n<Z;n++)$=M[z],N="<WORKER_CODE>"255,q=$>>8&255,L=$>>16&255,E=$>>24&255,V=N*b+G*T+Y*k+C*m,B=q*b+A*T+O*k+w*m,X=L*b+R*T+F*k+I*m,Q=E*b+j*T+y*k+W*m,C=Y,w=O,I=F,W=y,Y=V,O=B,F=X,y=Q,G=N,A=q,R=L,j=E,K[S]=Y,K[S+1]=O,K[S+2]=F,K[S+3]=y,S+=4,z++;z--,S-=4,H+=D*(Z-1),$=M[z],G="<WORKER_CODE>"255,A=$>>8&255,R=$>>16&255,j=$>>24&255,C=G*U[7],w=A*U[7],I=R*U[7],W=j*U[7],Y=C,O=w,F=I,y=W,N=G,q=A,L=R,E=j,b=U[2],T=U[3];for(n=Z-1;n>=0;n--)V=N*b+G*T+Y*k+C*m,B=q*b+A*T+O*k+w*m,X=L*b+R*T+F*k+I*m,Q=E*b+j*T+y*k+W*m,C=Y,w=O,I=F,W=y,Y=V,O=B,F=X,y=Q,G=N,A=q,R=L,j=E,$=M[z],N="<WORKER_CODE>"255,q=$>>8&255,L=$>>16&255,E=$>>24&255,$=(K[S]+Y<<0)+(K[S+1]+O<<8)+(K[S+2]+F<<16)+(K[S+3]+y<<24),J[H]=$,z--,S-=4,H-=D}}function T8(M,J,K,U){if(!U)return;var Z=new Uint32Array(M.buffer),D=new Uint32Array(Z.length),$=new Float32Array(Math.max(J,K)*4),G=b8(U);B8(Z,D,$,G,J,K,U),B8(D,Z,$,G,K,J,U)}E8.exports=T8});var S8=2;function s(M,J,K,U,Z,D){let $=K/M,G=U/J,A=(2*D+S8+1)/Z;if(A>0.5)return[{toWidth:K,toHeight:U}];let R=Math.ceil(Math.log(Math.min($,G))/Math.log(A));if(R<=1)return[{toWidth:K,toHeight:U}];let j=[];for(let N=0;N<R;N++){let q=Math.round(Math.pow(Math.pow(M,R-N-1)*Math.pow(K,N+1),1/R)),L=Math.round(Math.pow(Math.pow(J,R-N-1)*Math.pow(U,N+1),1/R));j.push({toWidth:q,toHeight:L})}return j}function i(M,J,K){let U=new Uint8ClampedArray(K.width*K.height*P);for(let Z=0;Z<K.height;Z++){let D=((K.y+Z)*J+K.x)*P,$=Z*K.width*P;U.set(M.subarray(D,D+K.width*P),$)}return U}var r=0.00001;function u(M){let J=Math.round(M);if(Math.abs(M-J)<r)return J;return Math.floor(M)}function t(M){let J=Math.round(M);if(Math.abs(M-J)<r)return J;return Math.ceil(M)}function e(M,J,K,U,Z,D,$,G,A,R,j){let N=U/J,q=Z/K,L=u(D*N)-2*$,E=u(D*q)-2*$;if(L<1||E<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let V,B,X,Q,Y,O,F=[];for(Q=0;Q<Z;Q+=E)for(X=0;X<U;X+=L){if(V=X-$,V<0)V=0;if(Y=X+L+$-V,V+Y>=U)Y=U-V;if(B=Q-$,B<0)B=0;if(O=Q+E+$-B,B+O>=Z)O=Z-B;let y={toX:V,toY:B,toWidth:Y,toHeight:O,toInnerX:X,toInnerY:Q,toInnerWidth:L,toInnerHeight:E,offsetX:V/N-u(V/N),offsetY:B/q-u(B/q),scaleX:N,scaleY:q,x:u(V/N),y:u(B/q),width:t(Y/N),height:t(O/q),initialSize:D,filterPadding:$,filter:G,unsharpAmount:A,unsharpRadius:R,unsharpThreshold:j},C=i(M,J,y);F.push({tile:C.buffer,...y})}return F}var P=4;async function M8(M){let J,K,U,Z,D,$;if(M.image instanceof Blob){let A=await createImageBitmap(M.image),j=new OffscreenCanvas(A.width,A.height).getContext("2d");if(!j)throw new Error("Canvas 2D context not supported");j.drawImage(A,0,0),J=j.getImageData(0,0,A.width,A.height).data,K=A.width,U=A.height,A.close();let q=M.maxDimension/K,L=M.maxDimension/U,E=Math.min(q,L,1),V=Math.floor(K*E),B=Math.floor(U*E);$=s(K,U,V,B,M.tileOptions.initialSize,M.tileOptions.filterPadding)}else J=M.image.from,K=M.image.fromWidth,U=M.image.fromHeight,$=M.image.stages;Z=$[0].toWidth,D=$[0].toHeight;let G=e(J,K,U,Z,D,M.tileOptions.initialSize,M.tileOptions.filterPadding,M.tileOptions.filter,M.tileOptions.unsharpAmount,M.tileOptions.unsharpRadius,M.tileOptions.unsharpThreshold);return{from:J.buffer,fromWidth:K,fromHeight:U,tileTransforms:G,stages:$}}function U8(M,J,K){let U=new Uint8ClampedArray(K.tile);for(let Z=0;Z<K.toHeight;Z++){let D=Z*K.toWidth*P,$=((K.toY+Z)*J+K.toX)*P;M.set(U.subarray(D,D+K.toWidth*P),$)}}var I8="<WORKER_CODE>",J8=new Blob([I8],{type:"application/javascript"});var K8=(()=>{let M=0;return()=>++M})();class $8{#U;#$;#J;#K;constructor(){this.#U=new Map,this.#$=new Map,this.#J=new Map,this.#K=new Map}get count(){return this.#U.size}#Z(M){clearTimeout(this.#$.get(M))}#M(M,J,K,U){this.#U.set(M,J.id),this.#J.set(J.id,M),this.#K.set(J.id,J),M.postMessage(K,U),this.#Z(M)}assignPriority1Task(M,J){let K={taskId:J.id,squishId:J.squishId,taskType:0,image:J.data.image,maxDimension:J.data.maxDimension,tileOptions:J.data.tileOptions};this.#M(M,J,K,[])}assignPriority2Task(M,J){let K={taskId:J.id,squishId:J.squishId,taskType:1,tileTransform:J.data.tileTransform};this.#M(M,J,K,[K.tileTransform.tile])}setWorkerTimeout(M,J){let K=setTimeout(()=>{let U=this.#U.get(M);if(U)this.#J.delete(U);if(U)this.#K.delete(U);this.#$.delete(M),this.#U.delete(M),M.terminate()},J);this.#$.set(M,K)}addWorker(M){this.#U.set(M,null)}getWorker(M){return this.#J.get(M)}getTask(M){return this.#K.get(M)}getAvailableWorker(){for(let[M,J]of this.#U.entries())if(J===null)return M;return null}removeTask(M){let J=this.#J.get(M);if(J)this.#U.set(J,null);this.#J.delete(M),this.#K.delete(M)}}class H8{#U;#$;#J;#K;#Z;#M;constructor(M,J){this.#$=M,this.#U=J,this.#J=new Map,this.#K=[],this.#Z=[],this.#M=new $8}#R(){let M=URL.createObjectURL(J8),J=new Worker(URL.createObjectURL(J8));URL.revokeObjectURL(M),J.onmessage=(K)=>{let U=this.#J.get(K.data.squishId);if(!U)throw new Error("SquishContext not found");if(K.data.error)U.reject(K.data.error);if(K.data.taskType===0){let{squishId:D,output:$}=K.data,G=$.stages[0].toWidth,A=$.stages[0].toHeight;U.from=new Uint8ClampedArray($.from),U.fromWidth=$.fromWidth,U.fromHeight=$.fromHeight,U.to=new Uint8ClampedArray(G*A*P),U.toWidth=G,U.toHeight=A,U.stages=$.stages,U.remainingTileCount=$.tileTransforms.length;for(let R of $.tileTransforms)this.#Z.push({id:K8(),squishId:D,data:{tileTransform:R}}),this.#G()}if(K.data.taskType===1){let{taskId:D,squishId:$,output:G}=K.data;if(!U.to)throw new Error("SquishContext to not found");if(U8(U.to,U.toWidth,G.tileTransform),U.remainingTileCount--,!U.remainingTileCount)if(U.stages.shift(),U.stages[0])this.#K.push({id:D,squishId:$,data:{image:{from:U.to,fromWidth:U.toWidth,fromHeight:U.toHeight,stages:U.stages},maxDimension:U.maxDimension,tileOptions:U.tileOptions}});else{let A=new ImageData(U.to,U.toWidth,U.toHeight);createImageBitmap(A).then((R)=>{this.#J.delete(K.data.squishId),U.resolve(R)})}}let Z=this.#M.getWorker(K.data.taskId);if(Z)this.#M.setWorkerTimeout(Z,this.#U);this.#M.removeTask(K.data.taskId),this.#G()},this.#M.addWorker(J)}#G(){let M=this.#M.getAvailableWorker();if(M){let J=this.#K.shift();if(J)return this.#M.assignPriority1Task(M,J);let K=this.#Z.shift();if(K)return this.#M.assignPriority2Task(M,K)}else if(this.#M.count<this.#$)this.#R(),this.#G()}add(M){return new Promise((J,K)=>{let U=K8();this.#J.set(U,{maxDimension:M.maxDimension,tileOptions:M.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:J,reject:K}),this.#K.push({id:U,squishId:U,data:M}),this.#G()})}}var d={box:{win:0.5,fn:(M)=>{if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:(M)=>{if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;let J=M*Math.PI;return Math.sin(J)/J*(0.54+0.46*Math.cos(J/1))}},lanczos2:{win:2,fn:(M)=>{if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;let J=M*Math.PI;return Math.sin(J)/J*Math.sin(J/2)/(J/2)}},lanczos3:{win:3,fn:(M)=>{if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;let J=M*Math.PI;return Math.sin(J)/J*Math.sin(J/3)/(J/3)}},mks2013:{win:2.5,fn:(M)=>{if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var w8=14;function Z8(M){return Math.round(M*((1<<w8)-1))}function c(M,J,K,U,Z){let D=d[M].fn,$=1/U,G=Math.min(1,U),A=d[M].win/G,R,j,N,q,L,E,V,B,X,Q,Y,O,F,y,C,w,I,W=Math.floor((A+1)*2),z=new Int16Array((W+2)*K),H=0,S=!z.subarray||!z.set;for(R=0;R<K;R++){j=(R+0.5)*$+Z,N=Math.max(0,Math.floor(j-A)),q=Math.min(J-1,Math.ceil(j+A)),L=q-N+1,E=new Float32Array(L),V=new Int16Array(L),B=0;for(X=N,Q=0;X<=q;X++,Q++)Y=D((X+0.5-j)*G),B+=Y,E[Q]=Y;O=0;for(Q=0;Q<E.length;Q++)F=E[Q]/B,O+=F,V[Q]=Z8(F);V[K>>1]+=Z8(1-O),y=0;while(y<V.length&&V[y]===0)y++;if(y<V.length){C=V.length-1;while(C>0&&V[C]===0)C--;if(w=N+y,I=C-y+1,z[H++]=w,z[H++]=I,!S)z.set(V.subarray(y,C+1),H),H+=I;else for(Q=y;Q<=C;Q++)z[H++]=V[Q]}else z[H++]=0,z[H++]=0}return z}function x(M){return M<0?0:M>255?255:M}function v(M){return M>=0?M:0}function G8(M,J,K,U,Z,D){let $,G,A,R,j,N,q,L,E,V,B,X=0,Q=0;for(E=0;E<U;E++){j=0;for(V=0;V<Z;V++){N=D[j++],q=D[j++],L=X+N*4|0,$=G=A=R=0;for(;q>0;q--)B=D[j++],R=R+B*M[L+3]|0,A=A+B*M[L+2]|0,G=G+B*M[L+1]|0,$=$+B*M[L]|0,L=L+4|0;J[Q+3]=v(R>>7),J[Q+2]=v(A>>7),J[Q+1]=v(G>>7),J[Q]=v($>>7),Q=Q+U*4|0}Q=(E+1)*4|0,X=(E+1)*K*4|0}}function R8(M,J,K,U,Z,D){let $,G,A,R,j,N,q,L,E,V,B,X=0,Q=0;for(E=0;E<U;E++){j=0;for(V=0;V<Z;V++){N=D[j++],q=D[j++],L=X+N*4|0,$=G=A=R=0;for(;q>0;q--)B=D[j++],R=R+B*M[L+3]|0,A=A+B*M[L+2]|0,G=G+B*M[L+1]|0,$=$+B*M[L]|0,L=L+4|0;$>>=7,G>>=7,A>>=7,R>>=7,J[Q+3]=x(R+8192>>14),J[Q+2]=x(A+8192>>14),J[Q+1]=x(G+8192>>14),J[Q]=x($+8192>>14),Q=Q+U*4|0}Q=(E+1)*4|0,X=(E+1)*K*4|0}}function A8(M,J,K,U,Z,D){let $,G,A,R,j,N,q,L,E,V,B,X,Q=0,Y=0;for(V=0;V<U;V++){N=0;for(B=0;B<Z;B++){q=D[N++],L=D[N++],E=Q+q*4|0,$=G=A=R=0;for(;L>0;L--)X=D[N++],j=M[E+3],R=R+X*j|0,A=A+X*M[E+2]*j|0,G=G+X*M[E+1]*j|0,$=$+X*M[E]*j|0,E=E+4|0;A=A/255|0,G=G/255|0,$=$/255|0,J[Y+3]=v(R>>7),J[Y+2]=v(A>>7),J[Y+1]=v(G>>7),J[Y]=v($>>7),Y=Y+U*4|0}Y=(V+1)*4|0,Q=(V+1)*K*4|0}}function D8(M,J,K,U,Z,D){let $,G,A,R,j,N,q,L,E,V,B,X=0,Q=0;for(E=0;E<U;E++){j=0;for(V=0;V<Z;V++){N=D[j++],q=D[j++],L=X+N*4|0,$=G=A=R=0;for(;q>0;q--)B=D[j++],R=R+B*M[L+3]|0,A=A+B*M[L+2]|0,G=G+B*M[L+1]|0,$=$+B*M[L]|0,L=L+4|0;if($>>=7,G>>=7,A>>=7,R>>=7,R=x(R+8192>>14),R>0)$=$*255/R|0,G=G*255/R|0,A=A*255/R|0;J[Q+3]=R,J[Q+2]=x(A+8192>>14),J[Q+1]=x(G+8192>>14),J[Q]=x($+8192>>14),Q=Q+U*4|0}Q=(E+1)*4|0,X=(E+1)*K*4|0}}function P8(M,J,K){let U=3,Z=J*K*4|0;while(U<Z){if(M[U]!==255)return!0;U=U+4|0}return!1}function W8(M,J,K){let U=3,Z=J*K*4|0;while(U<Z)M[U]=255,U=U+4|0}function j8(M,J,K,U,Z,D,$,G,A,R){let j=c(J,K,Z,$,A),N=c(J,U,D,G,R),q=new Uint8Array(Z*D*4),L=new Uint16Array(Z*U*4);if(P8(M,K,U))A8(M,L,K,U,Z,j),D8(L,q,U,Z,D,N);else G8(M,L,K,U,Z,j),R8(L,q,U,Z,D,N),W8(q,Z,D);return q}var N8=z8(V8(),1);function k8(M,J,K){let U=J*K,Z=new Uint16Array(U),D,$,G,A;for(let R=0;R<U;R++)D=M[4*R],$=M[4*R+1],G=M[4*R+2],A=D>="<WORKER_CODE>"&D>=G?D:$>=G&&$>=D?$:G,Z[R]=A<<8;return Z}function q8(M,J,K,U,Z,D){let $,G,A,R,j;if(U===0||Z<0.5)return;if(Z>2)Z=2;let N=k8(M,J,K),q=new Uint16Array(N);N8.default(q,J,K,Z);let L=U/100*4096+0.5|0,E=D<<8,V=J*K;for(let B=0;B<V;B++)if($=N[B],R=$-q[B],Math.abs(R)>=E)G=$+(L*R+2048>>12),G=G>65280?65280:G,G=G<0?0:G,$=$!==0?$:1,A=(G<<12)/$|0,j=B*4,M[j]=M[j]*A+2048>>12,M[j+1]=M[j+1]*A+2048>>12,M[j+2]=M[j+2]*A+2048>>12}function X8(M){let J=j8(new Uint8ClampedArray(M.tile),M.filter,M.width,M.height,M.toWidth,M.toHeight,M.scaleX,M.scaleY,M.offsetX,M.offsetY);if(M.unsharpAmount)q8(J,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return J}self.onmessage=async(M)=>{let{taskId:J,squishId:K,taskType:U}=M.data;try{if(U===0){let{image:Z,maxDimension:D,tileOptions:$}=M.data,G=await M8({image:Z,maxDimension:D,tileOptions:$}),A={taskId:J,squishId:K,taskType:U,output:{from:G.from,fromWidth:G.fromWidth,fromHeight:G.fromHeight,tileTransforms:G.tileTransforms,stages:G.stages}},R=G.tileTransforms.map((j)=>j.tile);self.postMessage(A,[G.from,...R])}if(U===1){let{tileTransform:Z}=M.data;Z.tile=X8(Z).buffer;let D={taskId:J,squishId:K,taskType:U,output:{tileTransform:Z}};self.postMessage(D,[Z.tile])}}catch(Z){self.postMessage({taskId:J,squishId:K,taskType:U,error:Z})}};
`,X8=new Blob([k8],{type:"application/javascript"});var q8=(()=>{let U=0;return()=>++U})();class Y8{#U;#$;#J;#Z;constructor(){this.#U=new Map,this.#$=new Map,this.#J=new Map,this.#Z=new Map}get count(){return this.#U.size}#G(U){clearTimeout(this.#$.get(U))}#K(U,K,$,J){this.#U.set(U,K.id),this.#J.set(K.id,U),this.#Z.set(K.id,K),U.postMessage($,J),this.#G(U)}assignPriority1Task(U,K){let $={taskId:K.id,squishId:K.squishId,taskType:0,image:K.data.image,maxDimension:K.data.maxDimension,tileOptions:K.data.tileOptions};this.#K(U,K,$,[])}assignPriority2Task(U,K){let $={taskId:K.id,squishId:K.squishId,taskType:1,tileTransform:K.data.tileTransform};this.#K(U,K,$,[$.tileTransform.tile])}setWorkerTimeout(U,K){let $=setTimeout(()=>{let J=this.#U.get(U);if(J)this.#J.delete(J);if(J)this.#Z.delete(J);this.#$.delete(U),this.#U.delete(U),U.terminate()},K);this.#$.set(U,$)}addWorker(U){this.#U.set(U,null)}getWorker(U){return this.#J.get(U)}getTask(U){return this.#Z.get(U)}getAvailableWorker(){for(let[U,K]of this.#U.entries())if(K===null)return U;return null}removeTask(U){let K=this.#J.get(U);if(K)this.#U.set(K,null);this.#J.delete(U),this.#Z.delete(U)}}class s{#U;#$;#J;#Z;#G;#K;constructor(U,K){this.#$=U,this.#U=K,this.#J=new Map,this.#Z=[],this.#G=[],this.#K=new Y8}#j(){let U=URL.createObjectURL(X8),K=new Worker(URL.createObjectURL(X8));URL.revokeObjectURL(U),K.onmessage=($)=>{let J=this.#J.get($.data.squishId);if(!J)throw new Error("SquishContext not found");if($.data.error)J.reject($.data.error);if($.data.taskType===0){let{squishId:M,output:Z}=$.data,A=Z.stages[0].toWidth,j=Z.stages[0].toHeight;J.from=new Uint8ClampedArray(Z.from),J.fromWidth=Z.fromWidth,J.fromHeight=Z.fromHeight,J.to=new Uint8ClampedArray(A*j*I),J.toWidth=A,J.toHeight=j,J.stages=Z.stages,J.remainingTileCount=Z.tileTransforms.length;for(let L of Z.tileTransforms)this.#G.push({id:q8(),squishId:M,data:{tileTransform:L}}),this.#A()}if($.data.taskType===1){let{taskId:M,squishId:Z,output:A}=$.data;if(!J.to)throw new Error("SquishContext to not found");if(n(J.to,J.toWidth,A.tileTransform),J.remainingTileCount--,!J.remainingTileCount)if(J.stages.shift(),J.stages[0])this.#Z.push({id:M,squishId:Z,data:{image:{from:J.to,fromWidth:J.toWidth,fromHeight:J.toHeight,stages:J.stages},maxDimension:J.maxDimension,tileOptions:J.tileOptions}});else{let j=new ImageData(J.to,J.toWidth,J.toHeight);createImageBitmap(j).then((L)=>{this.#J.delete($.data.squishId),J.resolve(L)})}}let G=this.#K.getWorker($.data.taskId);if(G)this.#K.setWorkerTimeout(G,this.#U);this.#K.removeTask($.data.taskId),this.#A()},this.#K.addWorker(K)}#A(){let U=this.#K.getAvailableWorker();if(U){let K=this.#Z.shift();if(K)return this.#K.assignPriority1Task(U,K);let $=this.#G.shift();if($)return this.#K.assignPriority2Task(U,$)}else if(this.#K.count<this.#$)this.#j(),this.#A()}add(U){return new Promise((K,$)=>{let J=q8();this.#J.set(J,{maxDimension:U.maxDimension,tileOptions:U.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:K,reject:$}),this.#Z.push({id:J,squishId:J,data:U}),this.#A()})}}class v8{#U;#$;constructor(U){let K=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,$=U.maxWorkerPoolSize||Math.min(K,4),J=U.maxWorkerIdleTime||1e4;this.#U=new s($,J),this.#$=U}async#J(U,K,$){let J=null,G,M,Z,A,j,L;for(;;){let D=await K8({image:J||U,maxDimension:K,tileOptions:$});G=new Uint8ClampedArray(D.from),M=D.fromWidth,Z=D.fromHeight,j=D.stages[0].toWidth,L=D.stages[0].toHeight,A=new Uint8ClampedArray(j*L*I);for(let B of D.tileTransforms)B.tile=E8(B).buffer,n(A,j,B);if(D.stages.shift(),J={from:A,fromWidth:j,fromHeight:L,stages:D.stages},!D.stages[0])break}let Q=new ImageData(J.from,J.fromWidth,J.fromHeight);return await createImageBitmap(Q)}async squish(U,K){let $=K?{...this.#$,...K}:this.#$,J=$.maxDimension,G=$.tileSize||1024,M=$.filter||"mks2013",Z=$.unsharpAmount||0,A=$.unsharpRadius||0,j=$.unsharpThreshold||0,L=$.useMainThread,Q=3,D=Math.ceil(Math.max(3,2.5*A|0)),B={initialSize:G,filterPadding:D,filter:M,unsharpAmount:Z,unsharpRadius:A,unsharpThreshold:j};if(L)return await this.#J(U,J,B);return this.#U.add({image:U,maxDimension:J,tileOptions:B})}}export{v8 as PicSquish};
