var N8=Object.create;var{getPrototypeOf:X8,defineProperty:d,getOwnPropertyNames:Y8}=Object;var E8=Object.prototype.hasOwnProperty;var z8=(U,A,J)=>{J=U!=null?N8(X8(U)):{};let D=A||!U||!U.__esModule?d(J,"default",{value:U,enumerable:!0}):J;for(let K of Y8(U))if(!E8.call(D,K))d(D,K,{get:()=>U[K],enumerable:!0});return D};var I8=(U,A)=>()=>(A||U((A={exports:{}}).exports,A),A.exports);var Z8=I8((G1,G8)=>{var x,g,m,n,v,w,J8,K8;function T8(U){if(U<0.5)U=0.5;var A=Math.exp(0.527076)/U,J=Math.exp(-A),D=Math.exp(-2*A),K=(1-J)*(1-J)/(1+2*A*J-D);return x=K,g=K*(A-1)*J,m=K*(A+1)*J,n=-K*D,v=2*J,w=-D,J8=(x+g)/(1-v-w),K8=(m+n)/(1-v-w),new Float32Array([x,g,m,n,v,w,J8,K8])}function $8(U,A,J,D,K,G){var $,Z,j,B,L,b,V,R,Q,q,y,N,M,X;for(Q=0;Q<G;Q++){b=Q*K,V=Q,R=0,$=U[b],L=$*D[6],B=L,y=D[0],N=D[1],M=D[4],X=D[5];for(q=0;q<K;q++)Z=U[b],j=Z*y+$*N+B*M+L*X,L=B,B=j,$=Z,J[R]=B,R++,b++;b--,R--,V+=G*(K-1),$=U[b],L=$*D[7],B=L,Z=$,y=D[2],N=D[3];for(q=K-1;q>=0;q--)j=Z*y+$*N+B*M+L*X,L=B,B=j,$=Z,Z=U[b],A[V]=J[R]+B,b--,R--,V-=G}}function k8(U,A,J,D){if(!D)return;var K=new Uint16Array(U.length),G=new Float32Array(Math.max(A,J)),$=T8(D);$8(U,K,G,$,A,J,D),$8(K,U,G,$,J,A,D)}G8.exports=k8});var E=4;function c(U,A,J){let D=new Uint8ClampedArray(J.tile);for(let K=0;K<J.toHeight;K++){let G=K*J.toWidth*E,$=((J.toY+K)*A+J.toX)*E;U.set(D.subarray(G,G+J.toWidth*E),$)}}var O8=`
var $k=Object.create;var{getPrototypeOf:Ak,defineProperty:m,getOwnPropertyNames:Gk}=Object;var Qk=Object.prototype.hasOwnProperty;var Zk=(k,M,R)=>{R=k!=null?$k(Ak(k)):{};let I=M||!k||!k.__esModule?m(R,"default",{value:k,enumerable:!0}):R;for(let D of Gk(k))if(!Qk.call(I,D))m(I,D,{get:()=>k[D],enumerable:!0});return I};var jk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Rk=jk((sk,Ik)=>{var _,n,x,g,T,H,t,kk;function Xk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,R=Math.exp(-M),I=Math.exp(-2*M),D=(1-R)*(1-R)/(1+2*M*R-I);return _=D,n=D*(M-1)*R,x=D*(M+1)*R,g=-D*I,T=2*R,H=-I,t=(_+n)/(1-T-H),kk=(x+g)/(1-T-H),new Float32Array([_,n,x,g,T,H,t,kk])}function Mk(k,M,R,I,D,K){var q,y,u,U,$,Z,B,J,G,j,Q,L,A,b;for(G=0;G<K;G++){Z=G*D,B=G,J=0,q=k[Z],$=q*I[6],U=$,Q=I[0],L=I[1],A=I[4],b=I[5];for(j=0;j<D;j++)y=k[Z],u=y*Q+q*L+U*A+$*b,$=U,U=u,q=y,R[J]=U,J++,Z++;Z--,J--,B+=K*(D-1),q=k[Z],$=q*I[7],U=$,y=q,Q=I[2],L=I[3];for(j=D-1;j>=0;j--)u=y*Q+q*L+U*A+$*b,$=U,U=u,q=y,y=k[Z],M[B]=R[J]+U,Z--,J--,B-=K}}function Yk(k,M,R,I){if(!I)return;var D=new Uint16Array(k.length),K=new Float32Array(Math.max(M,R)),q=Xk(I);Mk(k,D,K,q,M,R,I),Mk(D,k,K,q,R,M,I)}Ik.exports=Yk});var S=4;var Bk=2;function h(k,M,R,I,D,K){let q=R/k,y=I/M,u=(2*K+Bk+1)/D;if(u>0.5)return[{toWidth:R,toHeight:I}];let U=Math.ceil(Math.log(Math.min(q,y))/Math.log(u));if(U<=1)return[{toWidth:R,toHeight:I}];let $=[];for(let Z=0;Z<U;Z++){let B=Math.round(Math.pow(Math.pow(k,U-Z-1)*Math.pow(R,Z+1),1/U)),J=Math.round(Math.pow(Math.pow(M,U-Z-1)*Math.pow(I,Z+1),1/U));$.push({toWidth:B,toHeight:J})}return $}function Lk(k,M){if(k)k.width=k.height=0;k=M=null}function bk(k,M){let R=new OffscreenCanvas(M.width,M.height),I=R.getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");I.globalCompositeOperation="copy",I.drawImage(k,M.x,M.y,M.width,M.height,0,0,M.width,M.height);let D=I.getImageData(0,0,M.width,M.height).data.buffer;return Lk(R,I),D}function Ck(k,M,R){let I=new Uint8ClampedArray(R.width*R.height*S);for(let D=0;D<R.height;D++){let K=((R.y+D)*M+R.x)*S,q=D*R.width*S;I.set(k.subarray(K,K+R.width*S),q)}return I.buffer}function a(k,M,R){if(k instanceof ImageBitmap)return bk(k,R);else return Ck(k,M,R)}var o=0.00001;function O(k){let M=Math.round(k);if(Math.abs(k-M)<o)return M;return Math.floor(k)}function d(k){let M=Math.round(k);if(Math.abs(k-M)<o)return M;return Math.ceil(k)}function P(k,M,R,I,D,K){let{initialSize:q,filterPadding:y,filter:u,unsharpAmount:U,unsharpRadius:$,unsharpThreshold:Z}=K,B=I/M,J=D/R,G=O(q*B)-2*y,j=O(q*J)-2*y;if(G<1||j<1)throw new Error("Picsquish error: target tile width/height is too small");let Q,L,A,b,z,N,C=[];for(b=0;b<D;b+=j)for(A=0;A<I;A+=G){if(Q=A-y,Q<0)Q=0;if(z=A+G+y-Q,Q+z>=I)z=I-Q;if(L=b-y,L<0)L=0;if(N=b+j+y-L,L+N>=D)N=D-L;let V={toX:Q,toY:L,toWidth:z,toHeight:N,toInnerX:A,toInnerY:b,toInnerWidth:G,toInnerHeight:j,offsetX:Q/B-O(Q/B),offsetY:L/J-O(L/J),scaleX:B,scaleY:J,x:O(Q/B),y:O(L/J),width:d(z/B),height:d(N/J),initialSize:q,filterPadding:y,filter:u,unsharpAmount:U,unsharpRadius:$,unsharpThreshold:Z},F=a(k,M,V);C.push({tile:F,...V})}return C}async function Vk(k,M,R){let I=k instanceof ImageBitmap?k:await createImageBitmap(k),D=[];for(let K of R){let q=I,y=I.width,u=I.height,U=K/y,$=K/u,Z=Math.min(U,$,1),B=Math.floor(y*Z),J=Math.floor(u*Z),G=h(y,u,B,J,M.initialSize,M.filterPadding),j=P(q,y,u,G[0].toWidth,G[0].toHeight,M);D.push({stages:G,tileTransforms:j})}return I.close(),D}function zk(k,M){let R=P(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,M);return[{stages:k.stages,tileTransforms:R}]}async function c(k){if(k.image instanceof Blob||k.image instanceof ImageBitmap)return Vk(k.image,k.tileOptions,k.dimensionLimits);else return zk(k.image,k.tileOptions)}var p={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Nk=14;function s(k){return Math.round(k*((1<<Nk)-1))}function v(k,M,R,I,D){let K=p[k].fn,q=1/I,y=Math.min(1,I),u=p[k].win/y,U,$,Z,B,J,G,j,Q,L,A,b,z,N,C,V,F,W,Jk=Math.floor((u+1)*2),w=new Int16Array((Jk+2)*R),Y=0,Kk=!w.subarray||!w.set;for(U=0;U<R;U++){$=(U+0.5)*q+D,Z=Math.max(0,Math.floor($-u)),B=Math.min(M-1,Math.ceil($+u)),J=B-Z+1,G=new Float32Array(J),j=new Int16Array(J),Q=0;for(L=Z,A=0;L<=B;L++,A++)b=K((L+0.5-$)*y),Q+=b,G[A]=b;z=0;for(A=0;A<G.length;A++)N=G[A]/Q,z+=N,j[A]=s(N);j[R>>1]+=s(1-z),C=0;while(C<j.length&&j[C]===0)C++;if(C<j.length){V=j.length-1;while(V>0&&j[V]===0)V--;if(F=Z+C,W=V-C+1,w[Y++]=F,w[Y++]=W,!Kk)w.set(j.subarray(C,V+1),Y),Y+=W;else for(A=C;A<=V;A++)w[Y++]=j[A]}else w[Y++]=0,w[Y++]=0}return w}function E(k){return k<0?0:k>255?255:k}function X(k){return k>=0?k:0}function f(k,M,R,I,D,K){let q,y,u,U,$,Z,B,J,G,j,Q,L=0,A=0;for(G=0;G<I;G++){$=0;for(j=0;j<D;j++){Z=K[$++],B=K[$++],J=L+Z*4|0,q=y=u=U=0;for(;B>0;B--)Q=K[$++],U=U+Q*k[J+3]|0,u=u+Q*k[J+2]|0,y=y+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;M[A+3]=X(U>>7),M[A+2]=X(u>>7),M[A+1]=X(y>>7),M[A]=X(q>>7),A=A+I*4|0}A=(G+1)*4|0,L=(G+1)*R*4|0}}function l(k,M,R,I,D,K){let q,y,u,U,$,Z,B,J,G,j,Q,L=0,A=0;for(G=0;G<I;G++){$=0;for(j=0;j<D;j++){Z=K[$++],B=K[$++],J=L+Z*4|0,q=y=u=U=0;for(;B>0;B--)Q=K[$++],U=U+Q*k[J+3]|0,u=u+Q*k[J+2]|0,y=y+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;q>>=7,y>>=7,u>>=7,U>>=7,M[A+3]=E(U+8192>>14),M[A+2]=E(u+8192>>14),M[A+1]=E(y+8192>>14),M[A]=E(q+8192>>14),A=A+I*4|0}A=(G+1)*4|0,L=(G+1)*R*4|0}}function r(k,M,R,I,D,K){let q,y,u,U,$,Z,B,J,G,j,Q,L,A=0,b=0;for(j=0;j<I;j++){Z=0;for(Q=0;Q<D;Q++){B=K[Z++],J=K[Z++],G=A+B*4|0,q=y=u=U=0;for(;J>0;J--)L=K[Z++],$=k[G+3],U=U+L*$|0,u=u+L*k[G+2]*$|0,y=y+L*k[G+1]*$|0,q=q+L*k[G]*$|0,G=G+4|0;u=u/255|0,y=y/255|0,q=q/255|0,M[b+3]=X(U>>7),M[b+2]=X(u>>7),M[b+1]=X(y>>7),M[b]=X(q>>7),b=b+I*4|0}b=(j+1)*4|0,A=(j+1)*R*4|0}}function e(k,M,R,I,D,K){let q,y,u,U,$,Z,B,J,G,j,Q,L=0,A=0;for(G=0;G<I;G++){$=0;for(j=0;j<D;j++){Z=K[$++],B=K[$++],J=L+Z*4|0,q=y=u=U=0;for(;B>0;B--)Q=K[$++],U=U+Q*k[J+3]|0,u=u+Q*k[J+2]|0,y=y+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;if(q>>=7,y>>=7,u>>=7,U>>=7,U=E(U+8192>>14),U>0)q=q*255/U|0,y=y*255/U|0,u=u*255/U|0;M[A+3]=U,M[A+2]=E(u+8192>>14),M[A+1]=E(y+8192>>14),M[A]=E(q+8192>>14),A=A+I*4|0}A=(G+1)*4|0,L=(G+1)*R*4|0}}function wk(k,M,R){let I=3,D=M*R*4|0;while(I<D){if(k[I]!==255)return!0;I=I+4|0}return!1}function Ek(k,M,R){let I=3,D=M*R*4|0;while(I<D)k[I]=255,I=I+4|0}function i(k,M,R,I,D,K,q,y,u,U){let $=v(M,R,D,q,u),Z=v(M,I,K,y,U),B=new Uint8Array(D*K*4),J=new Uint16Array(D*I*4);if(wk(k,R,I))r(k,J,R,I,D,$),e(J,B,I,D,K,Z);else f(k,J,R,I,D,$),l(J,B,I,D,K,Z),Ek(B,D,K);return B}var qk=Zk(Rk(),1);function Ok(k,M,R){let I=M*R,D=new Uint16Array(I),K,q,y,u;for(let U=0;U<I;U++)K=k[4*U],q=k[4*U+1],y=k[4*U+2],u=K>=q&&K>=y?K:q>=y&&q>=K?q:y,D[U]=u<<8;return D}function Dk(k,M,R,I,D,K){let q,y,u,U,$;if(I===0||D<0.5)return;if(D>2)D=2;let Z=Ok(k,M,R),B=new Uint16Array(Z);qk.default(B,M,R,D);let J=I/100*4096+0.5|0,G=K<<8,j=M*R;for(let Q=0;Q<j;Q++)if(q=Z[Q],U=q-B[Q],Math.abs(U)>=G)y=q+(J*U+2048>>12),y=y>65280?65280:y,y=y<0?0:y,q=q!==0?q:1,u=(y<<12)/q|0,$=Q*4,k[$]=k[$]*u+2048>>12,k[$+1]=k[$+1]*u+2048>>12,k[$+2]=k[$+2]*u+2048>>12}function yk(k){let M=i(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Dk(M,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return M}async function Uk(k){let{taskId:M,squishId:R,taskType:I,data:D}=k,{image:K,dimensionLimits:q,tileOptions:y}=D;try{let u=await c({image:K,dimensionLimits:q,tileOptions:y});return{taskId:M,squishId:R,taskType:I,output:u}}catch(u){return{taskId:M,squishId:R,taskType:I,output:u}}}function uk(k){let{taskId:M,squishId:R,workspaceIndex:I,taskType:D,data:K}=k,{tileTransform:q}=K;try{return q.tile=yk(q).buffer,{taskId:M,squishId:R,workspaceIndex:I,taskType:D,output:q}}catch(y){return{taskId:M,squishId:R,workspaceIndex:I,taskType:D,output:y}}}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let M=k.data,R=await Uk(M),I=R.output instanceof Error?[]:R.output.flatMap((D)=>D.tileTransforms.map((K)=>K.tile));return self.postMessage(R,I)}case 1:{let M=k.data,R=uk(M),I=R.output instanceof Error?[]:[R.output.tile];return self.postMessage(R,I)}}};
`,C8=new Blob([O8],{type:"application/javascript"});class f{#U;#D;#A;#J;constructor(){this.#U=new Map,this.#D=new Map,this.#A=null,this.#J=null}#K(){if(this.#A===null)return;clearTimeout(this.#A),this.#A=null}prepare(U,A,J){if(this.#U.size)return;this.#J=J;let D=URL.createObjectURL(C8);while(this.#U.size<A){let K=new Worker(D);K.onmessage=U,this.#U.set(K,null)}URL.revokeObjectURL(D)}assignTask(U,A,J,D){this.#U.set(U,A),this.#D.set(A,U),this.#K(),U.postMessage(J,D)}setTimeout(){if(this.#A!==null)return;if(this.#U.size===0)return;this.#A=setTimeout(()=>{for(let U of this.#U.keys())U.terminate();this.#U.clear(),this.#D.clear()},this.#J||0)}getAvailableWorkers(){let U=[];for(let[A,J]of this.#U.entries())if(J===null)U.push(A);return U}removeTask(U){let A=this.#D.get(U);if(A)this.#U.set(A,null);this.#D.delete(U)}}var W=new f;var F8=2;function l(U,A,J,D,K,G){let $=J/U,Z=D/A,j=(2*G+F8+1)/K;if(j>0.5)return[{toWidth:J,toHeight:D}];let B=Math.ceil(Math.log(Math.min($,Z))/Math.log(j));if(B<=1)return[{toWidth:J,toHeight:D}];let L=[];for(let b=0;b<B;b++){let V=Math.round(Math.pow(Math.pow(U,B-b-1)*Math.pow(J,b+1),1/B)),R=Math.round(Math.pow(Math.pow(A,B-b-1)*Math.pow(D,b+1),1/B));L.push({toWidth:V,toHeight:R})}return L}function S8(U,A){if(U)U.width=U.height=0;U=A=null}function H8(U,A){let J=new OffscreenCanvas(A.width,A.height),D=J.getContext("2d");if(!D)throw new Error("Picsquish error: canvas 2D context not supported");D.globalCompositeOperation="copy",D.drawImage(U,A.x,A.y,A.width,A.height,0,0,A.width,A.height);let K=D.getImageData(0,0,A.width,A.height).data.buffer;return S8(J,D),K}function W8(U,A,J){let D=new Uint8ClampedArray(J.width*J.height*E);for(let K=0;K<J.height;K++){let G=((J.y+K)*A+J.x)*E,$=K*J.width*E;D.set(U.subarray(G,G+J.width*E),$)}return D.buffer}function a(U,A,J){if(U instanceof ImageBitmap)return H8(U,J);else return W8(U,A,J)}var s=0.00001;function P(U){let A=Math.round(U);if(Math.abs(U-A)<s)return A;return Math.floor(U)}function o(U){let A=Math.round(U);if(Math.abs(U-A)<s)return A;return Math.ceil(U)}function T(U,A,J,D,K,G){let{initialSize:$,filterPadding:Z,filter:j,unsharpAmount:B,unsharpRadius:L,unsharpThreshold:b}=G,V=D/A,R=K/J,Q=P($*V)-2*Z,q=P($*R)-2*Z;if(Q<1||q<1)throw new Error("Picsquish error: target tile width/height is too small");let y,N,M,X,I,O,Y=[];for(X=0;X<K;X+=q)for(M=0;M<D;M+=Q){if(y=M-Z,y<0)y=0;if(I=M+Q+Z-y,y+I>=D)I=D-y;if(N=X-Z,N<0)N=0;if(O=X+q+Z-N,N+O>=K)O=K-N;let z={toX:y,toY:N,toWidth:I,toHeight:O,toInnerX:M,toInnerY:X,toInnerWidth:Q,toInnerHeight:q,offsetX:y/V-P(y/V),offsetY:N/R-P(N/R),scaleX:V,scaleY:R,x:P(y/V),y:P(N/R),width:o(I/V),height:o(O/R),initialSize:$,filterPadding:Z,filter:j,unsharpAmount:B,unsharpRadius:L,unsharpThreshold:b},_=a(U,A,z);Y.push({tile:_,...z})}return Y}async function P8(U,A,J){let D=U instanceof ImageBitmap?U:await createImageBitmap(U),K=[];for(let G of J){let $=D,Z=D.width,j=D.height,B=G/Z,L=G/j,b=Math.min(B,L,1),V=Math.floor(Z*b),R=Math.floor(j*b),Q=l(Z,j,V,R,A.initialSize,A.filterPadding),q=T($,Z,j,Q[0].toWidth,Q[0].toHeight,A);K.push({stages:Q,tileTransforms:q})}return D.close(),K}function _8(U,A){let J=T(U.from,U.fromWidth,U.fromHeight,U.stages[0].toWidth,U.stages[0].toHeight,A);return[{stages:U.stages,tileTransforms:J}]}async function r(U){if(U.image instanceof Blob||U.image instanceof ImageBitmap)return P8(U.image,U.tileOptions,U.dimensionLimits);else return _8(U.image,U.tileOptions)}var k={box:{win:0.5,fn:(U)=>{if(U<0)U=-U;return U<0.5?1:0}},hamming:{win:1,fn:(U)=>{if(U<0)U=-U;if(U>=1)return 0;if(U<0.00000011920929)return 1;let A=U*Math.PI;return Math.sin(A)/A*(0.54+0.46*Math.cos(A/1))}},lanczos2:{win:2,fn:(U)=>{if(U<0)U=-U;if(U>=2)return 0;if(U<0.00000011920929)return 1;let A=U*Math.PI;return Math.sin(A)/A*Math.sin(A/2)/(A/2)}},lanczos3:{win:3,fn:(U)=>{if(U<0)U=-U;if(U>=3)return 0;if(U<0.00000011920929)return 1;let A=U*Math.PI;return Math.sin(A)/A*Math.sin(A/3)/(A/3)}},mks2013:{win:2.5,fn:(U)=>{if(U<0)U=-U;if(U>=2.5)return 0;if(U>=1.5)return-0.125*(U-2.5)*(U-2.5);if(U>=0.5)return 0.25*(4*U*U-11*U+7);return 1.0625-1.75*U*U}}};var v8=14;function i(U){return Math.round(U*((1<<v8)-1))}function p(U,A,J,D,K){let G=k[U].fn,$=1/D,Z=Math.min(1,D),j=k[U].win/Z,B,L,b,V,R,Q,q,y,N,M,X,I,O,Y,z,_,u,q8=Math.floor((j+1)*2),C=new Int16Array((q8+2)*J),H=0,V8=!C.subarray||!C.set;for(B=0;B<J;B++){L=(B+0.5)*$+K,b=Math.max(0,Math.floor(L-j)),V=Math.min(A-1,Math.ceil(L+j)),R=V-b+1,Q=new Float32Array(R),q=new Int16Array(R),y=0;for(N=b,M=0;N<=V;N++,M++)X=G((N+0.5-L)*Z),y+=X,Q[M]=X;I=0;for(M=0;M<Q.length;M++)O=Q[M]/y,I+=O,q[M]=i(O);q[J>>1]+=i(1-I),Y=0;while(Y<q.length&&q[Y]===0)Y++;if(Y<q.length){z=q.length-1;while(z>0&&q[z]===0)z--;if(_=b+Y,u=z-Y+1,C[H++]=_,C[H++]=u,!V8)C.set(q.subarray(Y,z+1),H),H+=u;else for(M=Y;M<=z;M++)C[H++]=q[M]}else C[H++]=0,C[H++]=0}return C}function F(U){return U<0?0:U>255?255:U}function S(U){return U>=0?U:0}function t(U,A,J,D,K,G){let $,Z,j,B,L,b,V,R,Q,q,y,N=0,M=0;for(Q=0;Q<D;Q++){L=0;for(q=0;q<K;q++){b=G[L++],V=G[L++],R=N+b*4|0,$=Z=j=B=0;for(;V>0;V--)y=G[L++],B=B+y*U[R+3]|0,j=j+y*U[R+2]|0,Z=Z+y*U[R+1]|0,$=$+y*U[R]|0,R=R+4|0;A[M+3]=S(B>>7),A[M+2]=S(j>>7),A[M+1]=S(Z>>7),A[M]=S($>>7),M=M+D*4|0}M=(Q+1)*4|0,N=(Q+1)*J*4|0}}function e(U,A,J,D,K,G){let $,Z,j,B,L,b,V,R,Q,q,y,N=0,M=0;for(Q=0;Q<D;Q++){L=0;for(q=0;q<K;q++){b=G[L++],V=G[L++],R=N+b*4|0,$=Z=j=B=0;for(;V>0;V--)y=G[L++],B=B+y*U[R+3]|0,j=j+y*U[R+2]|0,Z=Z+y*U[R+1]|0,$=$+y*U[R]|0,R=R+4|0;$>>=7,Z>>=7,j>>=7,B>>=7,A[M+3]=F(B+8192>>14),A[M+2]=F(j+8192>>14),A[M+1]=F(Z+8192>>14),A[M]=F($+8192>>14),M=M+D*4|0}M=(Q+1)*4|0,N=(Q+1)*J*4|0}}function U8(U,A,J,D,K,G){let $,Z,j,B,L,b,V,R,Q,q,y,N,M=0,X=0;for(q=0;q<D;q++){b=0;for(y=0;y<K;y++){V=G[b++],R=G[b++],Q=M+V*4|0,$=Z=j=B=0;for(;R>0;R--)N=G[b++],L=U[Q+3],B=B+N*L|0,j=j+N*U[Q+2]*L|0,Z=Z+N*U[Q+1]*L|0,$=$+N*U[Q]*L|0,Q=Q+4|0;j=j/255|0,Z=Z/255|0,$=$/255|0,A[X+3]=S(B>>7),A[X+2]=S(j>>7),A[X+1]=S(Z>>7),A[X]=S($>>7),X=X+D*4|0}X=(q+1)*4|0,M=(q+1)*J*4|0}}function A8(U,A,J,D,K,G){let $,Z,j,B,L,b,V,R,Q,q,y,N=0,M=0;for(Q=0;Q<D;Q++){L=0;for(q=0;q<K;q++){b=G[L++],V=G[L++],R=N+b*4|0,$=Z=j=B=0;for(;V>0;V--)y=G[L++],B=B+y*U[R+3]|0,j=j+y*U[R+2]|0,Z=Z+y*U[R+1]|0,$=$+y*U[R]|0,R=R+4|0;if($>>=7,Z>>=7,j>>=7,B>>=7,B=F(B+8192>>14),B>0)$=$*255/B|0,Z=Z*255/B|0,j=j*255/B|0;A[M+3]=B,A[M+2]=F(j+8192>>14),A[M+1]=F(Z+8192>>14),A[M]=F($+8192>>14),M=M+D*4|0}M=(Q+1)*4|0,N=(Q+1)*J*4|0}}function w8(U,A,J){let D=3,K=A*J*4|0;while(D<K){if(U[D]!==255)return!0;D=D+4|0}return!1}function u8(U,A,J){let D=3,K=A*J*4|0;while(D<K)U[D]=255,D=D+4|0}function D8(U,A,J,D,K,G,$,Z,j,B){let L=p(A,J,K,$,j),b=p(A,D,G,Z,B),V=new Uint8Array(K*G*4),R=new Uint16Array(K*D*4);if(w8(U,J,D))U8(U,R,J,D,K,L),A8(R,V,D,K,G,b);else t(U,R,J,D,K,L),e(R,V,D,K,G,b),u8(V,K,G);return V}var B8=z8(Z8(),1);function p8(U,A,J){let D=A*J,K=new Uint16Array(D),G,$,Z,j;for(let B=0;B<D;B++)G=U[4*B],$=U[4*B+1],Z=U[4*B+2],j=G>=$&&G>=Z?G:$>=Z&&$>=G?$:Z,K[B]=j<<8;return K}function j8(U,A,J,D,K,G){let $,Z,j,B,L;if(D===0||K<0.5)return;if(K>2)K=2;let b=p8(U,A,J),V=new Uint16Array(b);B8.default(V,A,J,K);let R=D/100*4096+0.5|0,Q=G<<8,q=A*J;for(let y=0;y<q;y++)if($=b[y],B=$-V[y],Math.abs(B)>=Q)Z=$+(R*B+2048>>12),Z=Z>65280?65280:Z,Z=Z<0?0:Z,$=$!==0?$:1,j=(Z<<12)/$|0,L=y*4,U[L]=U[L]*j+2048>>12,U[L+1]=U[L+1]*j+2048>>12,U[L+2]=U[L+2]*j+2048>>12}function R8(U){let A=D8(new Uint8ClampedArray(U.tile),U.filter,U.width,U.height,U.toWidth,U.toHeight,U.scaleX,U.scaleY,U.offsetX,U.offsetY);if(U.unsharpAmount)j8(A,U.toWidth,U.toHeight,U.unsharpAmount,U.unsharpRadius,U.unsharpThreshold);return A}async function L8(U){let{taskId:A,squishId:J,taskType:D,data:K}=U,{image:G,dimensionLimits:$,tileOptions:Z}=K;try{let j=await r({image:G,dimensionLimits:$,tileOptions:Z});return{taskId:A,squishId:J,taskType:D,output:j}}catch(j){return{taskId:A,squishId:J,taskType:D,output:j}}}function M8(U){let{taskId:A,squishId:J,workspaceIndex:D,taskType:K,data:G}=U,{tileTransform:$}=G;try{return $.tile=R8($).buffer,{taskId:A,squishId:J,workspaceIndex:D,taskType:K,output:$}}catch(Z){return{taskId:A,squishId:J,workspaceIndex:D,taskType:K,output:Z}}}var h=(()=>{let U=0;return()=>++U})();class Q8{raw;width;height;constructor(U,A,J){this.raw=U,this.width=A,this.height=J}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let U=document.createElement("canvas");U.width=this.width,U.height=this.height;let A=U.getContext("2d");if(!A)throw new Error("Picsquish error: canvas 2D context not supported");return A.putImageData(this.toImageData(),0,0),U}toBlob(U="image/png"){let A=new OffscreenCanvas(this.width,this.height),J=A.getContext("2d");if(!J)throw new Error("Picsquish error: canvas 2D context not supported");return J.putImageData(this.toImageData(),0,0),A.convertToBlob({type:U})}}class b8{#U;#D;#A;constructor(){this.#U=new Map,this.#D=[],this.#A=[]}#J(U,A){let J=h(),D={taskId:J,squishId:U.squishId,taskType:0,data:U.data};if(!A)return L8(D).then((G)=>this.#$(G));let K=U.data.image instanceof ImageBitmap?[U.data.image]:[];W.assignTask(A,J,D,K)}#K(U,A){let J=h(),D={taskId:J,squishId:U.squishId,workspaceIndex:U.workspaceIndex,taskType:1,data:U.data};if(!A)return this.#$(M8(D));W.assignTask(A,J,D,[U.data.tileTransform.tile])}#G(U){let A=this.#D.shift();if(A)return this.#J(A,U);let J=this.#A.shift();if(J)return this.#K(J,U)}#Z(U){if(this.#D.length===0&&this.#A.length===0)return W.setTimeout();if(U)return this.#G();let J=W.getAvailableWorkers();for(let D of J)this.#G(D)}#B(U,A){let{squishId:J,output:D}=A;if(D instanceof Error)return U.workspaceHandlers.forEach((K)=>K.reject(D));for(let[K,G]of D.entries()){let $=G.stages[0].toWidth,Z=G.stages[0].toHeight;U.workspaces.set(K,{to:new Uint8ClampedArray($*Z*E),toWidth:$,toHeight:Z,stages:G.stages,remainingTileCount:G.tileTransforms.length});for(let j of G.tileTransforms)this.#A.push({squishId:J,workspaceIndex:K,data:{tileTransform:j}})}}#j(U,A){let{squishId:J,workspaceIndex:D,output:K}=A;if(!U.workspaces.has(D))return;let G=U.workspaces.get(D);if(!G)throw new Error("Picsquish error: workspace not found");let $=U.workspaceHandlers.get(D);if(!$)throw new Error("Picsquish error: workspaceHandler not found");if(K instanceof Error)return U.workspaces.delete(D),this.#A=this.#A.filter((j)=>!(j.squishId===J&&j.workspaceIndex===D)),$.reject(K);if(c(G.to,G.toWidth,K),--G.remainingTileCount,G.remainingTileCount)return;if(G.stages.shift(),!G.stages[0])return U.workspaces.delete(D),$.resolve(new Q8(G.to,G.toWidth,G.toHeight));this.#D.push({squishId:J,data:{image:{from:G.to,fromWidth:G.toWidth,fromHeight:G.toHeight,stages:G.stages},dimensionLimits:[],tileOptions:U.tileOptions}})}#$(U){let A=this.#U.get(U.squishId);if(!A)throw new Error("Picsquish error: squishContext not found");switch(U.taskType){case 0:this.#B(A,U);break;case 1:this.#j(A,U);break}if(!A.workspaces.size)this.#U.delete(U.squishId);W.removeTask(U.taskId),this.#Z(A.useMainThread)}add(U,A,J,D){if(!D)W.prepare((Z)=>this.#$(Z.data),A,J);let K=[],G=new Map;for(let Z=0;Z<U.dimensionLimits.length;Z++)K.push(new Promise((j,B)=>{G.set(Z,{resolve:j,reject:B})}));let $=h();return this.#U.set($,{tileOptions:U.tileOptions,workspaces:new Map,workspaceHandlers:G,useMainThread:D}),this.#D.push({squishId:$,data:U}),queueMicrotask(()=>this.#Z(D)),K}}var y8=new b8;function w1(U,A,J={}){let D=J.tileSize||1024,K=J.filter||"mks2013",G=J.unsharpAmount||0,$=J.unsharpRadius||0,Z=J.unsharpThreshold||0,j=!!J.useMainThread,B=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,L=J.maxWorkerPoolSize||Math.min(B,4),b=J.maxWorkerIdleTime||2000,V=3,R=Math.ceil(Math.max(3,2.5*$|0)),Q={initialSize:D,filterPadding:R,filter:K,unsharpAmount:G,unsharpRadius:$,unsharpThreshold:Z};return y8.add({image:U,dimensionLimits:A,tileOptions:Q},L,b,j)}export{w1 as squish};
