var Jk=2;function x(k,q,M,Q,K,W){let $=M/k,J=Q/q,G=(2*W+Jk+1)/K;if(G>0.5)return[{toWidth:M,toHeight:Q}];let P=Math.ceil(Math.log(Math.min($,J))/Math.log(G));if(P<=1)return[{toWidth:M,toHeight:Q}];let V=[];for(let j=0;j<P;j++){let A=Math.round(Math.pow(Math.pow(k,P-j-1)*Math.pow(M,j+1),1/P)),Y=Math.round(Math.pow(Math.pow(q,P-j-1)*Math.pow(Q,j+1),1/P));V.push({toWidth:A,toHeight:Y})}return V}var s=0.00001;function H(k){let q=Math.round(k);if(Math.abs(k-q)<s)return q;return Math.floor(k)}function l(k){let q=Math.round(k);if(Math.abs(k-q)<s)return q;return Math.ceil(k)}function f(k,q,M,Q,K,W,$,J,G,P){let V=M/k,j=Q/q,A=H(K*V)-2*W,Y=H(K*j)-2*W;if(A<1||Y<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let w,y,T,z,L,_,N=[];for(z=0;z<Q;z+=Y)for(T=0;T<M;T+=A){if(w=T-W,w<0)w=0;if(L=T+A+W-w,w+L>=M)L=M-w;if(y=z-W,y<0)y=0;if(_=z+Y+W-y,y+_>=Q)_=Q-y;N.push({toX:w,toY:y,toWidth:L,toHeight:_,toInnerX:T,toInnerY:z,toInnerWidth:A,toInnerHeight:Y,offsetX:w/V-H(w/V),offsetY:y/j-H(y/j),scaleX:V,scaleY:j,x:H(w/V),y:H(y/j),width:l(L/V),height:l(_/j),initialSize:K,filterPadding:W,filter:$,unsharpAmount:J,unsharpRadius:G,unsharpThreshold:P})}return N}var Zk=new TextDecoder,Z=(k,q=0,M=k.length)=>Zk.decode(k.slice(q,M)),F=(k,q=0,M=k.length)=>k.slice(q,M).reduce((Q,K)=>Q+`0${K.toString(16)}`.slice(-2),""),b=(k,q)=>new DataView(k.buffer,k.byteOffset+q),r=(k,q=0)=>b(k,q).getInt16(0,!0),m=(k,q=0)=>b(k,q).getUint16(0,!1),v=(k,q=0)=>b(k,q).getUint16(0,!0),g=(k,q=0)=>{let M=b(k,q);return M.getUint16(0,!0)+(M.getUint8(2)<<16)},jk=(k,q=0)=>b(k,q).getInt32(0,!0),D=(k,q=0)=>b(k,q).getUint32(0,!1),h=(k,q=0)=>b(k,q).getUint32(0,!0),E=(k,q,M)=>b(k,q).getBigUint64(0,!M),Gk={readUInt16BE:m,readUInt16LE:v,readUInt32BE:D,readUInt32LE:h};function X(k,q,M=0,Q=!1){let W=`readUInt${q}${Q?"BE":"LE"}`;return Gk[W](k,M)}function Vk(k,q){if(k.length-q<4)return;let M=D(k,q);if(k.length-q<M)return;return{name:Z(k,4+q,8+q),offset:q,size:M}}function C(k,q,M){while(M<k.length){let Q=Vk(k,M);if(!Q)break;if(Q.name===q)return Q;M+=Q.size>0?Q.size:8}}var Dk={validate:(k)=>Z(k,0,2)==="BM",calculate:(k)=>({height:Math.abs(jk(k,22)),width:h(k,18)})},Pk=1,Ak=6,Xk=16;function d(k,q){let M=k[q];return M===0?256:M}function o(k,q){let M=Ak+q*Xk;return{height:d(k,M+1),width:d(k,M)}}var n={validate(k){let q=v(k,0),M=v(k,4);if(q!==0||M===0)return!1;return v(k,2)===Pk},calculate(k){let q=v(k,4),M=o(k,0);if(q===1)return M;let Q=[];for(let K=0;K<q;K+=1)Q.push(o(k,K));return{width:M.width,height:M.height,images:Q}}},vk=2,Rk={validate(k){let q=v(k,0),M=v(k,4);if(q!==0||M===0)return!1;return v(k,2)===vk},calculate:(k)=>n.calculate(k)},Yk={validate:(k)=>h(k,0)===542327876,calculate:(k)=>({height:h(k,12),width:h(k,16)})},wk=/^GIF8[79]a/,Ck={validate:(k)=>wk.test(Z(k,0,6)),calculate:(k)=>({height:v(k,8),width:v(k,6)})},yk={avif:"avif",mif1:"heif",msf1:"heif",heic:"heic",heix:"heic",hevc:"heic",hevx:"heic"},Tk={validate(k){if(Z(k,4,8)!=="ftyp")return!1;let M=C(k,"ftyp",0);if(!M)return!1;return Z(k,M.offset+8,M.offset+12)in yk},calculate(k){let q=C(k,"meta",0),M=q&&C(k,"iprp",q.offset+12),Q=M&&C(k,"ipco",M.offset+8);if(!Q)throw new TypeError("Invalid HEIF, no ipco box found");let K=Z(k,8,12),W=[],$=Q.offset+8;while($<Q.offset+Q.size){let J=C(k,"ispe",$);if(!J)break;let G=D(k,J.offset+12),P=D(k,J.offset+16),V=C(k,"clap",$),j=G,A=P;if(V&&V.offset<Q.offset+Q.size){let Y=D(k,V.offset+12);j=G-Y}W.push({height:A,width:j}),$=J.offset+J.size}if(W.length===0)throw new TypeError("Invalid HEIF, no sizes found");return{width:W[0].width,height:W[0].height,type:K,...W.length>1?{images:W}:{}}}},zk=8,Lk=4,bk=4,hk={ICON:32,"ICN#":32,"icm#":16,icm4:16,icm8:16,"ics#":16,ics4:16,ics8:16,is32:16,s8mk:16,icp4:16,icl4:32,icl8:32,il32:32,l8mk:32,icp5:32,ic11:32,ich4:48,ich8:48,ih32:48,h8mk:48,icp6:64,ic12:32,it32:128,t8mk:128,ic07:128,ic08:256,ic13:256,ic09:512,ic14:512,ic10:1024};function _k(k,q){let M=q+bk;return[Z(k,q,M),D(k,M)]}function Hk(k){let q=hk[k];return{width:q,height:q,type:k}}var Fk={validate:(k)=>Z(k,0,4)==="icns",calculate(k){let q=k.length,M=D(k,Lk),Q=zk,K=[];while(Q<M&&Q<q){let W=_k(k,Q),$=Hk(W[0]);K.push($),Q+=W[1]}if(K.length===0)throw new TypeError("Invalid ICNS, no sizes found");return{width:K[0].width,height:K[0].height,...K.length>1?{images:K}:{}}}},Nk={validate:(k)=>D(k,0)===4283432785,calculate:(k)=>({height:D(k,12),width:D(k,8)})},Ok={validate(k){if(Z(k,4,8)!=="jP  ")return!1;let M=C(k,"ftyp",0);if(!M)return!1;return Z(k,M.offset+8,M.offset+12)==="jp2 "},calculate(k){let q=C(k,"jp2h",0),M=q&&C(k,"ihdr",q.offset+8);if(M)return{height:D(k,M.offset+8),width:D(k,M.offset+12)};throw new TypeError("Unsupported JPEG 2000 format")}},mk="45786966",Uk=2,S=6,ck=2,Ik="4d4d",Sk="4949",a=12,Ek=2;function Bk(k){return F(k,2,6)===mk}function xk(k,q){return{height:m(k,q),width:m(k,q+2)}}function lk(k,q){let Q=S+8,K=X(k,16,Q,q);for(let W=0;W<K;W++){let $=Q+Ek+W*a,J=$+a;if($>k.length)return;let G=k.slice($,J);if(X(G,16,0,q)===274){if(X(G,16,2,q)!==3)return;if(X(G,32,4,q)!==1)return;return X(G,16,8,q)}}}function sk(k,q){let M=k.slice(Uk,q),Q=F(M,S,S+ck),K=Q===Ik;if(K||Q===Sk)return lk(M,K)}function fk(k,q){if(q>k.length)throw new TypeError("Corrupt JPG, exceeded buffer limits")}var rk={validate:(k)=>F(k,0,2)==="ffd8",calculate(k){let q=k.slice(4),M,Q;while(q.length){let K=m(q,0);if(fk(q,K),q[K]!==255){q=q.slice(1);continue}if(Bk(q))M=sk(q,K);if(Q=q[K+1],Q===192||Q===193||Q===194){let W=xk(q,K+5);if(!M)return W;return{height:W.height,orientation:M,width:W.width}}q=q.slice(K+2)}throw new TypeError("Invalid JPG, no size found")}},gk=class{constructor(k,q){this.input=k,this.endianness=q,this.byteOffset=2,this.bitOffset=0}getBits(k=1){let q=0,M=0;while(M<k){if(this.byteOffset>=this.input.length)throw new Error("Reached end of input");let Q=this.input[this.byteOffset],K=8-this.bitOffset,W=Math.min(k-M,K);if(this.endianness==="little-endian"){let $=(1<<W)-1,J=Q>>this.bitOffset&$;q|=J<<M}else{let $=(1<<W)-1<<8-this.bitOffset-W,J=(Q&$)>>8-this.bitOffset-W;q=q<<W|J}if(M+=W,this.bitOffset+=W,this.bitOffset===8)this.byteOffset++,this.bitOffset=0}return q}};function t(k,q){if(q)return 8*(1+k.getBits(5));let M=k.getBits(2),Q=[9,13,18,30][M];return 1+k.getBits(Q)}function dk(k,q,M,Q){if(q&&M===0)return 8*(1+k.getBits(5));if(M===0)return t(k,!1);return Math.floor(Q*[1,1.2,1.3333333333333333,1.5,1.7777777777777777,1.25,2][M-1])}var i={validate:(k)=>{return F(k,0,2)==="ff0a"},calculate(k){let q=new gk(k,"little-endian"),M=q.getBits(1)===1,Q=t(q,M),K=q.getBits(3);return{width:dk(q,M,K,Q),height:Q}}};function ok(k){let q=C(k,"jxlc",0);if(q)return k.slice(q.offset+8,q.offset+q.size);let M=ak(k);if(M.length>0)return uk(M);return}function ak(k){let q=[],M=0;while(M<k.length){let Q=C(k,"jxlp",M);if(!Q)break;q.push(k.slice(Q.offset+12,Q.offset+Q.size)),M=Q.offset+Q.size}return q}function uk(k){let q=k.reduce((K,W)=>K+W.length,0),M=new Uint8Array(q),Q=0;for(let K of k)M.set(K,Q),Q+=K.length;return M}var pk={validate:(k)=>{if(Z(k,4,8)!=="JXL ")return!1;let M=C(k,"ftyp",0);if(!M)return!1;return Z(k,M.offset+8,M.offset+12)==="jxl "},calculate(k){let q=ok(k);if(q)return i.calculate(q);throw new Error("No codestream found in JXL container")}},ek={validate:(k)=>{let q=Z(k,1,7);return["KTX 11","KTX 20"].includes(q)},calculate:(k)=>{let q=k[5]===49?"ktx":"ktx2",M=q==="ktx"?36:20;return{height:h(k,M+4),width:h(k,M),type:q}}},nk=`PNG\r
\x1A
`,tk="IHDR",u="CgBI",ik={validate(k){if(nk===Z(k,1,8)){let q=Z(k,12,16);if(q===u)q=Z(k,28,32);if(q!==tk)throw new TypeError("Invalid PNG");return!0}return!1},calculate(k){if(Z(k,12,16)===u)return{height:D(k,36),width:D(k,32)};return{height:D(k,20),width:D(k,16)}}},p={P1:"pbm/ascii",P2:"pgm/ascii",P3:"ppm/ascii",P4:"pbm",P5:"pgm",P6:"ppm",P7:"pam",PF:"pfm"},e={default:(k)=>{let q=[];while(k.length>0){let M=k.shift();if(M[0]==="#")continue;q=M.split(" ");break}if(q.length===2)return{height:Number.parseInt(q[1],10),width:Number.parseInt(q[0],10)};throw new TypeError("Invalid PNM")},pam:(k)=>{let q={};while(k.length>0){let M=k.shift();if(M.length>16||M.charCodeAt(0)>128)continue;let[Q,K]=M.split(" ");if(Q&&K)q[Q.toLowerCase()]=Number.parseInt(K,10);if(q.height&&q.width)break}if(q.height&&q.width)return{height:q.height,width:q.width};throw new TypeError("Invalid PAM")}},k1={validate:(k)=>(Z(k,0,2)in p),calculate(k){let q=Z(k,0,2),M=p[q],Q=Z(k,3).split(/[\r\n]+/);return(e[M]||e.default)(Q)}},q1={validate:(k)=>Z(k,0,4)==="8BPS",calculate:(k)=>({height:D(k,14),width:D(k,18)})},kk=/<svg\s([^>"']|"[^"]*"|'[^']*')*>/,O={height:/\sheight=(['"])([^%]+?)\1/,root:kk,viewbox:/\sviewBox=(['"])(.+?)\1/i,width:/\swidth=(['"])([^%]+?)\1/},I=2.54,qk={in:96,cm:96/I,em:16,ex:8,m:96/I*100,mm:96/I/10,pc:0.1111111111111111,pt:1.3333333333333333,px:1},M1=new RegExp(`^([0-9.]+(?:e\\d+)?)(${Object.keys(qk).join("|")})?$`);function U(k){let q=M1.exec(k);if(!q)return;return Math.round(Number(q[1])*(qk[q[2]]||1))}function Q1(k){let q=k.split(" ");return{height:U(q[3]),width:U(q[2])}}function K1(k){let q=k.match(O.width),M=k.match(O.height),Q=k.match(O.viewbox);return{height:M&&U(M[2]),viewbox:Q&&Q1(Q[2]),width:q&&U(q[2])}}function W1(k){return{height:k.height,width:k.width}}function $1(k,q){let M=q.width/q.height;if(k.width)return{height:Math.floor(k.width/M),width:k.width};if(k.height)return{height:k.height,width:Math.floor(k.height*M)};return{height:q.height,width:q.width}}var J1={validate:(k)=>kk.test(Z(k,0,1000)),calculate(k){let q=Z(k).match(O.root);if(q){let M=K1(q[0]);if(M.width&&M.height)return W1(M);if(M.viewbox)return $1(M,M.viewbox)}throw new TypeError("Invalid SVG")}},Z1={validate(k){return v(k,0)===0&&v(k,4)===0},calculate(k){return{height:v(k,14),width:v(k,12)}}},R={TAG:{WIDTH:256,HEIGHT:257,COMPRESSION:259},TYPE:{SHORT:3,LONG:4,LONG8:16},ENTRY_SIZE:{STANDARD:12,BIG:20},COUNT_SIZE:{STANDARD:2,BIG:8}};function j1(k,{isBigEndian:q,isBigTiff:M}){let Q=M?Number(E(k,8,q)):X(k,32,4,q),K=M?R.COUNT_SIZE.BIG:R.COUNT_SIZE.STANDARD;return k.slice(Q+K)}function G1(k,q,M,Q){switch(q){case R.TYPE.SHORT:return X(k,16,M,Q);case R.TYPE.LONG:return X(k,32,M,Q);case R.TYPE.LONG8:{let K=Number(E(k,M,Q));if(K>Number.MAX_SAFE_INTEGER)throw new TypeError("Value too large");return K}default:return 0}}function V1(k,q){let M=q?R.ENTRY_SIZE.BIG:R.ENTRY_SIZE.STANDARD;if(k.length>M)return k.slice(M)}function D1(k,{isBigEndian:q,isBigTiff:M}){let Q={},K=k;while(K?.length){let W=X(K,16,0,q),$=X(K,16,2,q),J=M?Number(E(K,4,q)):X(K,32,4,q);if(W===0)break;if(J===1&&($===R.TYPE.SHORT||$===R.TYPE.LONG||M&&$===R.TYPE.LONG8)){let G=M?12:8;Q[W]=G1(K,$,G,q)}K=V1(K,M)}return Q}function P1(k){let q=Z(k,0,2),M=X(k,16,2,q==="MM");return{isBigEndian:q==="MM",isBigTiff:M===43}}function A1(k,q){let M=X(k,16,4,q),Q=X(k,16,6,q);if(M!==8||Q!==0)throw new TypeError("Invalid BigTIFF header")}var X1=new Set(["49492a00","4d4d002a","49492b00","4d4d002b"]),v1={validate:(k)=>{let q=F(k,0,4);return X1.has(q)},calculate(k){let q=P1(k);if(q.isBigTiff)A1(k,q.isBigEndian);let M=j1(k,q),Q=D1(M,q),K={height:Q[R.TAG.HEIGHT],width:Q[R.TAG.WIDTH],type:q.isBigTiff?"bigtiff":"tiff"};if(Q[R.TAG.COMPRESSION])K.compression=Q[R.TAG.COMPRESSION];if(!K.width||!K.height)throw new TypeError("Invalid Tiff. Missing tags");return K}};function R1(k){return{height:1+g(k,7),width:1+g(k,4)}}function Y1(k){return{height:1+((k[4]&15)<<10|k[3]<<2|(k[2]&192)>>6),width:1+((k[2]&63)<<8|k[1])}}function w1(k){return{height:r(k,8)&16383,width:r(k,6)&16383}}var C1={validate(k){let q=Z(k,0,4)==="RIFF",M=Z(k,8,12)==="WEBP",Q=Z(k,12,15)==="VP8";return q&&M&&Q},calculate(k){let q=Z(k,12,16),M=k.slice(20,30);if(q==="VP8X"){let K=M[0],W=(K&192)===0,$=(K&1)===0;if(W&&$)return R1(M);throw new TypeError("Invalid WebP")}if(q==="VP8 "&&M[0]!==47)return w1(M);let Q=F(M,3,6);if(q==="VP8L"&&Q!=="9d012a")return Y1(M);throw new TypeError("Invalid WebP")}},c=new Map([["bmp",Dk],["cur",Rk],["dds",Yk],["gif",Ck],["heif",Tk],["icns",Fk],["ico",n],["j2c",Nk],["jp2",Ok],["jpg",rk],["jxl",pk],["jxl-stream",i],["ktx",ek],["png",ik],["pnm",k1],["psd",q1],["svg",J1],["tga",Z1],["tiff",v1],["webp",C1]]),y1=Array.from(c.keys()),T1=new Map([[0,"heif"],[56,"psd"],[66,"bmp"],[68,"dds"],[71,"gif"],[73,"tiff"],[77,"tiff"],[82,"webp"],[105,"icns"],[137,"png"],[255,"jpg"]]);function z1(k){let q=k[0],M=T1.get(q);if(M&&c.get(M).validate(k))return M;return y1.find((Q)=>c.get(Q).validate(k))}var L1={disabledTypes:[]};function Mk(k){let q=z1(k);if(typeof q!=="undefined"){if(L1.disabledTypes.indexOf(q)>-1)throw new TypeError(`disabled file type: ${q}`);let M=c.get(q).calculate(k);if(M!==void 0){if(M.type=M.type??q,M.images&&M.images.length>1){let Q=M.images.reduce((K,W)=>{return W.width*W.height>K.width*K.height?W:K},M.images[0]);M.width=Q.width,M.height=Q.height}return M}}throw new TypeError(`unsupported file type: ${q}`)}async function Qk(k,q,M){let Q=await k.arrayBuffer(),K=Mk(new Uint8Array(Q));console.log(K);let W=await createImageBitmap(k),$=W.width,J=W.height,G=q/$,P=q/J,V=Math.min(G,P,1),j=Math.floor($*V),A=Math.floor(J*V),Y=x($,J,j,A,M.initialSize,M.filterPadding),w=f($,J,j,A,M.initialSize,M.filterPadding,M.filter,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold),T=new OffscreenCanvas($,J).getContext("2d");if(!T)throw new Error("PicSquish: Canvas context is not supported");T.drawImage(W,0,0);let z=T.getImageData(0,0,$,J),L=new SharedArrayBuffer(z.data.byteLength);new Uint8ClampedArray(L).set(z.data);let N=j*A*4,$k=new SharedArrayBuffer(N);return{from:L,fromWidth:$,fromHeight:J,to:$k,tileTransforms:w,stages:Y}}var b1=`
var sk=Object.create;var{getPrototypeOf:pk,defineProperty:Dk,getOwnPropertyNames:nk}=Object;var rk=Object.prototype.hasOwnProperty;var ek=(k,q,Q)=>{Q=k!=null?sk(pk(k)):{};let M=q||!k||!k.__esModule?Dk(Q,"default",{value:k,enumerable:!0}):Q;for(let K of nk(k))if(!rk.call(M,K))Dk(M,K,{get:()=>k[K],enumerable:!0});return M};var ik=(k,q)=>()=>(q||k((q={exports:{}}).exports,q),q.exports);var uk=ik((l0,ck)=>{var $k,Jk,Zk,jk,i,t,xk,gk;function N0(k){if(k<0.5)k=0.5;var q=Math.exp(0.527076)/k,Q=Math.exp(-q),M=Math.exp(-2*q),K=(1-Q)*(1-Q)/(1+2*q*Q-M);return $k=K,Jk=K*(q-1)*Q,Zk=K*(q+1)*Q,jk=-K*M,i=2*Q,t=-M,xk=($k+Jk)/(1-i-t),gk=(Zk+jk)/(1-i-t),new Float32Array([$k,Jk,Zk,jk,i,t,xk,gk])}function dk(k,q,Q,M,K,J){var $,Z,j,D,G,C,W,A,R,X,y,Y,V,w,z,O,P,H,E,S,h,U,B,I,s,l,v,x,g,d;for(s=0;s<J;s++){U=s*K,B=s,I=0,$=k[U],Z="<WORKER_CODE>"255,j=$>>8&255,D=$>>16&255,G=$>>24&255,H=Z*M[6],E=j*M[6],S=D*M[6],h=G*M[6],w=H,z=E,O=S,P=h,v=M[0],x=M[1],g=M[4],d=M[5];for(l=0;l<K;l++)$=k[U],C="<WORKER_CODE>"255,W=$>>8&255,A=$>>16&255,R=$>>24&255,X=C*v+Z*x+w*g+H*d,y=W*v+j*x+z*g+E*d,Y=A*v+D*x+O*g+S*d,V=R*v+G*x+P*g+h*d,H=w,E=z,S=O,h=P,w=X,z=y,O=Y,P=V,Z=C,j=W,D=A,G=R,Q[I]=w,Q[I+1]=z,Q[I+2]=O,Q[I+3]=P,I+=4,U++;U--,I-=4,B+=J*(K-1),$=k[U],Z="<WORKER_CODE>"255,j=$>>8&255,D=$>>16&255,G=$>>24&255,H=Z*M[7],E=j*M[7],S=D*M[7],h=G*M[7],w=H,z=E,O=S,P=h,C=Z,W=j,A=D,R=G,v=M[2],x=M[3];for(l=K-1;l>=0;l--)X=C*v+Z*x+w*g+H*d,y=W*v+j*x+z*g+E*d,Y=A*v+D*x+O*g+S*d,V=R*v+G*x+P*g+h*d,H=w,E=z,S=O,h=P,w=X,z=y,O=Y,P=V,Z=C,j=W,D=A,G=R,$=k[U],C="<WORKER_CODE>"255,W=$>>8&255,A=$>>16&255,R=$>>24&255,$=(Q[I]+w<<0)+(Q[I+1]+z<<8)+(Q[I+2]+O<<16)+(Q[I+3]+P<<24),q[B]=$,U--,I-=4,B-=J}}function O0(k,q,Q,M){if(!M)return;var K=new Uint32Array(k.buffer),J=new Uint32Array(K.length),$=new Float32Array(Math.max(q,Q)*4),Z=N0(M);dk(K,J,$,Z,q,Q,M),dk(J,K,$,Z,Q,q,M)}ck.exports=O0});var tk=2;function Gk(k,q,Q,M,K,J){let $=Q/k,Z=M/q,j=(2*J+tk+1)/K;if(j>0.5)return[{toWidth:Q,toHeight:M}];let D=Math.ceil(Math.log(Math.min($,Z))/Math.log(j));if(D<=1)return[{toWidth:Q,toHeight:M}];let G=[];for(let C=0;C<D;C++){let W=Math.round(Math.pow(Math.pow(k,D-C-1)*Math.pow(Q,C+1),1/D)),A=Math.round(Math.pow(Math.pow(q,D-C-1)*Math.pow(M,C+1),1/D));G.push({toWidth:W,toHeight:A})}return G}var Ck=0.00001;function a(k){let q=Math.round(k);if(Math.abs(k-q)<Ck)return q;return Math.floor(k)}function Ak(k){let q=Math.round(k);if(Math.abs(k-q)<Ck)return q;return Math.ceil(k)}function Rk(k,q,Q,M,K,J,$,Z,j,D){let G=Q/k,C=M/q,W=a(K*G)-2*J,A=a(K*C)-2*J;if(W<1||A<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let R,X,y,Y,V,w,z=[];for(Y=0;Y<M;Y+=A)for(y=0;y<Q;y+=W){if(R=y-J,R<0)R=0;if(V=y+W+J-R,R+V>=Q)V=Q-R;if(X=Y-J,X<0)X=0;if(w=Y+A+J-X,X+w>=M)w=M-X;z.push({toX:R,toY:X,toWidth:V,toHeight:w,toInnerX:y,toInnerY:Y,toInnerWidth:W,toInnerHeight:A,offsetX:R/G-a(R/G),offsetY:X/C-a(X/C),scaleX:G,scaleY:C,x:a(R/G),y:a(X/C),width:Ak(V/G),height:Ak(w/C),initialSize:K,filterPadding:J,filter:$,unsharpAmount:Z,unsharpRadius:j,unsharpThreshold:D})}return z}var kq=new TextDecoder,L=(k,q=0,Q=k.length)=>kq.decode(k.slice(q,Q)),f=(k,q=0,Q=k.length)=>k.slice(q,Q).reduce((M,K)=>M+\`0\${K.toString(16)}\`.slice(-2),""),c=(k,q)=>new DataView(k.buffer,k.byteOffset+q),Vk=(k,q=0)=>c(k,q).getInt16(0,!0),n=(k,q=0)=>c(k,q).getUint16(0,!1),T=(k,q=0)=>c(k,q).getUint16(0,!0),Wk=(k,q=0)=>{let Q=c(k,q);return Q.getUint16(0,!0)+(Q.getUint8(2)<<16)},qq=(k,q=0)=>c(k,q).getInt32(0,!0),N=(k,q=0)=>c(k,q).getUint32(0,!1),o=(k,q=0)=>c(k,q).getUint32(0,!0),Qk=(k,q,Q)=>c(k,q).getBigUint64(0,!Q),Qq={readUInt16BE:n,readUInt16LE:T,readUInt32BE:N,readUInt32LE:o};function F(k,q,Q=0,M=!1){let J=\`readUInt\${q}\${M?"BE":"LE"}\`;return Qq[J](k,Q)}function Mq(k,q){if(k.length-q<4)return;let Q=N(k,q);if(k.length-q<Q)return;return{name:L(k,4+q,8+q),offset:q,size:Q}}function m(k,q,Q){while(Q<k.length){let M=Mq(k,Q);if(!M)break;if(M.name===q)return M;Q+=M.size>0?M.size:8}}var Kq={validate:(k)=>L(k,0,2)==="BM",calculate:(k)=>({height:Math.abs(qq(k,22)),width:o(k,18)})},$q=1,Jq=6,Zq=16;function Xk(k,q){let Q=k[q];return Q===0?256:Q}function yk(k,q){let Q=Jq+q*Zq;return{height:Xk(k,Q+1),width:Xk(k,Q)}}var zk={validate(k){let q=T(k,0),Q=T(k,4);if(q!==0||Q===0)return!1;return T(k,2)===$q},calculate(k){let q=T(k,4),Q=yk(k,0);if(q===1)return Q;let M=[];for(let K=0;K<q;K+=1)M.push(yk(k,K));return{width:Q.width,height:Q.height,images:M}}},jq=2,Dq={validate(k){let q=T(k,0),Q=T(k,4);if(q!==0||Q===0)return!1;return T(k,2)===jq},calculate:(k)=>zk.calculate(k)},Gq={validate:(k)=>o(k,0)===542327876,calculate:(k)=>({height:o(k,12),width:o(k,16)})},Aq=/^GIF8[79]a/,Cq={validate:(k)=>Aq.test(L(k,0,6)),calculate:(k)=>({height:T(k,8),width:T(k,6)})},Rq={avif:"avif",mif1:"heif",msf1:"heif",heic:"heic",heix:"heic",hevc:"heic",hevx:"heic"},Vq={validate(k){if(L(k,4,8)!=="ftyp")return!1;let Q=m(k,"ftyp",0);if(!Q)return!1;return L(k,Q.offset+8,Q.offset+12)in Rq},calculate(k){let q=m(k,"meta",0),Q=q&&m(k,"iprp",q.offset+12),M=Q&&m(k,"ipco",Q.offset+8);if(!M)throw new TypeError("Invalid HEIF, no ipco box found");let K=L(k,8,12),J=[],$=M.offset+8;while($<M.offset+M.size){let Z=m(k,"ispe",$);if(!Z)break;let j=N(k,Z.offset+12),D=N(k,Z.offset+16),G=m(k,"clap",$),C=j,W=D;if(G&&G.offset<M.offset+M.size){let A=N(k,G.offset+12);C=j-A}J.push({height:W,width:C}),$=Z.offset+Z.size}if(J.length===0)throw new TypeError("Invalid HEIF, no sizes found");return{width:J[0].width,height:J[0].height,type:K,...J.length>1?{images:J}:{}}}},Wq=8,Xq=4,yq=4,Yq={ICON:32,"ICN#":32,"icm#":16,icm4:16,icm8:16,"ics#":16,ics4:16,ics8:16,is32:16,s8mk:16,icp4:16,icl4:32,icl8:32,il32:32,l8mk:32,icp5:32,ic11:32,ich4:48,ich8:48,ih32:48,h8mk:48,icp6:64,ic12:32,it32:128,t8mk:128,ic07:128,ic08:256,ic13:256,ic09:512,ic14:512,ic10:1024};function wq(k,q){let Q=q+yq;return[L(k,q,Q),N(k,Q)]}function Lq(k){let q=Yq[k];return{width:q,height:q,type:k}}var Pq={validate:(k)=>L(k,0,4)==="icns",calculate(k){let q=k.length,Q=N(k,Xq),M=Wq,K=[];while(M<Q&&M<q){let J=wq(k,M),$=Lq(J[0]);K.push($),M+=J[1]}if(K.length===0)throw new TypeError("Invalid ICNS, no sizes found");return{width:K[0].width,height:K[0].height,...K.length>1?{images:K}:{}}}},zq={validate:(k)=>N(k,0)===4283432785,calculate:(k)=>({height:N(k,12),width:N(k,8)})},Uq={validate(k){if(L(k,4,8)!=="jP  ")return!1;let Q=m(k,"ftyp",0);if(!Q)return!1;return L(k,Q.offset+8,Q.offset+12)==="jp2 "},calculate(k){let q=m(k,"jp2h",0),Q=q&&m(k,"ihdr",q.offset+8);if(Q)return{height:N(k,Q.offset+8),width:N(k,Q.offset+12)};throw new TypeError("Unsupported JPEG 2000 format")}},Nq="45786966",Oq=2,qk=6,Hq=2,Iq="4d4d",Fq="4949",Yk=12,Tq=2;function bq(k){return f(k,2,6)===Nq}function Sq(k,q){return{height:n(k,q),width:n(k,q+2)}}function Bq(k,q){let M=qk+8,K=F(k,16,M,q);for(let J=0;J<K;J++){let $=M+Tq+J*Yk,Z=$+Yk;if($>k.length)return;let j=k.slice($,Z);if(F(j,16,0,q)===274){if(F(j,16,2,q)!==3)return;if(F(j,32,4,q)!==1)return;return F(j,16,8,q)}}}function mq(k,q){let Q=k.slice(Oq,q),M=f(Q,qk,qk+Hq),K=M===Iq;if(K||M===Fq)return Bq(Q,K)}function Eq(k,q){if(q>k.length)throw new TypeError("Corrupt JPG, exceeded buffer limits")}var hq={validate:(k)=>f(k,0,2)==="ffd8",calculate(k){let q=k.slice(4),Q,M;while(q.length){let K=n(q,0);if(Eq(q,K),q[K]!==255){q=q.slice(1);continue}if(bq(q))Q=mq(q,K);if(M=q[K+1],M===192||M===193||M===194){let J=Sq(q,K+5);if(!Q)return J;return{height:J.height,orientation:Q,width:J.width}}q=q.slice(K+2)}throw new TypeError("Invalid JPG, no size found")}},vq=class{constructor(k,q){this.input=k,this.endianness=q,this.byteOffset=2,this.bitOffset=0}getBits(k=1){let q=0,Q=0;while(Q<k){if(this.byteOffset>=this.input.length)throw new Error("Reached end of input");let M=this.input[this.byteOffset],K=8-this.bitOffset,J=Math.min(k-Q,K);if(this.endianness==="little-endian"){let $=(1<<J)-1,Z=M>>this.bitOffset&$;q|=Z<<Q}else{let $=(1<<J)-1<<8-this.bitOffset-J,Z=(M&$)>>8-this.bitOffset-J;q=q<<J|Z}if(Q+=J,this.bitOffset+=J,this.bitOffset===8)this.byteOffset++,this.bitOffset=0}return q}};function Uk(k,q){if(q)return 8*(1+k.getBits(5));let Q=k.getBits(2),M=[9,13,18,30][Q];return 1+k.getBits(M)}function xq(k,q,Q,M){if(q&&Q===0)return 8*(1+k.getBits(5));if(Q===0)return Uk(k,!1);return Math.floor(M*[1,1.2,1.3333333333333333,1.5,1.7777777777777777,1.25,2][Q-1])}var Nk={validate:(k)=>{return f(k,0,2)==="ff0a"},calculate(k){let q=new vq(k,"little-endian"),Q=q.getBits(1)===1,M=Uk(q,Q),K=q.getBits(3);return{width:xq(q,Q,K,M),height:M}}};function gq(k){let q=m(k,"jxlc",0);if(q)return k.slice(q.offset+8,q.offset+q.size);let Q=dq(k);if(Q.length>0)return cq(Q);return}function dq(k){let q=[],Q=0;while(Q<k.length){let M=m(k,"jxlp",Q);if(!M)break;q.push(k.slice(M.offset+12,M.offset+M.size)),Q=M.offset+M.size}return q}function cq(k){let q=k.reduce((K,J)=>K+J.length,0),Q=new Uint8Array(q),M=0;for(let K of k)Q.set(K,M),M+=K.length;return Q}var uq={validate:(k)=>{if(L(k,4,8)!=="JXL ")return!1;let Q=m(k,"ftyp",0);if(!Q)return!1;return L(k,Q.offset+8,Q.offset+12)==="jxl "},calculate(k){let q=gq(k);if(q)return Nk.calculate(q);throw new Error("No codestream found in JXL container")}},_q={validate:(k)=>{let q=L(k,1,7);return["KTX 11","KTX 20"].includes(q)},calculate:(k)=>{let q=k[5]===49?"ktx":"ktx2",Q=q==="ktx"?36:20;return{height:o(k,Q+4),width:o(k,Q),type:q}}},oq=\`PNG\\r
\\x1A
\`,lq="IHDR",wk="CgBI",aq={validate(k){if(oq===L(k,1,8)){let q=L(k,12,16);if(q===wk)q=L(k,28,32);if(q!==lq)throw new TypeError("Invalid PNG");return!0}return!1},calculate(k){if(L(k,12,16)===wk)return{height:N(k,36),width:N(k,32)};return{height:N(k,20),width:N(k,16)}}},Lk={P1:"pbm/ascii",P2:"pgm/ascii",P3:"ppm/ascii",P4:"pbm",P5:"pgm",P6:"ppm",P7:"pam",PF:"pfm"},Pk={default:(k)=>{let q=[];while(k.length>0){let Q=k.shift();if(Q[0]==="#")continue;q=Q.split(" ");break}if(q.length===2)return{height:Number.parseInt(q[1],10),width:Number.parseInt(q[0],10)};throw new TypeError("Invalid PNM")},pam:(k)=>{let q={};while(k.length>0){let Q=k.shift();if(Q.length>16||Q.charCodeAt(0)>128)continue;let[M,K]=Q.split(" ");if(M&&K)q[M.toLowerCase()]=Number.parseInt(K,10);if(q.height&&q.width)break}if(q.height&&q.width)return{height:q.height,width:q.width};throw new TypeError("Invalid PAM")}},fq={validate:(k)=>(L(k,0,2)in Lk),calculate(k){let q=L(k,0,2),Q=Lk[q],M=L(k,3).split(/[\\r\\n]+/);return(Pk[Q]||Pk.default)(M)}},sq={validate:(k)=>L(k,0,4)==="8BPS",calculate:(k)=>({height:N(k,14),width:N(k,18)})},Ok=/<svg\\s([^>"']|"[^"]*"|'[^']*')*>/,p={height:/\\sheight=(['"])([^%]+?)\\1/,root:Ok,viewbox:/\\sviewBox=(['"])(.+?)\\1/i,width:/\\swidth=(['"])([^%]+?)\\1/},kk=2.54,Hk={in:96,cm:96/kk,em:16,ex:8,m:96/kk*100,mm:96/kk/10,pc:0.1111111111111111,pt:1.3333333333333333,px:1},pq=new RegExp(\`^([0-9.]+(?:e\\\\d+)?)(\${Object.keys(Hk).join("|")})?$\`);function r(k){let q=pq.exec(k);if(!q)return;return Math.round(Number(q[1])*(Hk[q[2]]||1))}function nq(k){let q=k.split(" ");return{height:r(q[3]),width:r(q[2])}}function rq(k){let q=k.match(p.width),Q=k.match(p.height),M=k.match(p.viewbox);return{height:Q&&r(Q[2]),viewbox:M&&nq(M[2]),width:q&&r(q[2])}}function eq(k){return{height:k.height,width:k.width}}function iq(k,q){let Q=q.width/q.height;if(k.width)return{height:Math.floor(k.width/Q),width:k.width};if(k.height)return{height:k.height,width:Math.floor(k.height*Q)};return{height:q.height,width:q.width}}var tq={validate:(k)=>Ok.test(L(k,0,1000)),calculate(k){let q=L(k).match(p.root);if(q){let Q=rq(q[0]);if(Q.width&&Q.height)return eq(Q);if(Q.viewbox)return iq(Q,Q.viewbox)}throw new TypeError("Invalid SVG")}},k0={validate(k){return T(k,0)===0&&T(k,4)===0},calculate(k){return{height:T(k,14),width:T(k,12)}}},b={TAG:{WIDTH:256,HEIGHT:257,COMPRESSION:259},TYPE:{SHORT:3,LONG:4,LONG8:16},ENTRY_SIZE:{STANDARD:12,BIG:20},COUNT_SIZE:{STANDARD:2,BIG:8}};function q0(k,{isBigEndian:q,isBigTiff:Q}){let M=Q?Number(Qk(k,8,q)):F(k,32,4,q),K=Q?b.COUNT_SIZE.BIG:b.COUNT_SIZE.STANDARD;return k.slice(M+K)}function Q0(k,q,Q,M){switch(q){case b.TYPE.SHORT:return F(k,16,Q,M);case b.TYPE.LONG:return F(k,32,Q,M);case b.TYPE.LONG8:{let K=Number(Qk(k,Q,M));if(K>Number.MAX_SAFE_INTEGER)throw new TypeError("Value too large");return K}default:return 0}}function M0(k,q){let Q=q?b.ENTRY_SIZE.BIG:b.ENTRY_SIZE.STANDARD;if(k.length>Q)return k.slice(Q)}function K0(k,{isBigEndian:q,isBigTiff:Q}){let M={},K=k;while(K?.length){let J=F(K,16,0,q),$=F(K,16,2,q),Z=Q?Number(Qk(K,4,q)):F(K,32,4,q);if(J===0)break;if(Z===1&&($===b.TYPE.SHORT||$===b.TYPE.LONG||Q&&$===b.TYPE.LONG8)){let j=Q?12:8;M[J]=Q0(K,$,j,q)}K=M0(K,Q)}return M}function $0(k){let q=L(k,0,2),Q=F(k,16,2,q==="MM");return{isBigEndian:q==="MM",isBigTiff:Q===43}}function J0(k,q){let Q=F(k,16,4,q),M=F(k,16,6,q);if(Q!==8||M!==0)throw new TypeError("Invalid BigTIFF header")}var Z0=new Set(["49492a00","4d4d002a","49492b00","4d4d002b"]),j0={validate:(k)=>{let q=f(k,0,4);return Z0.has(q)},calculate(k){let q=$0(k);if(q.isBigTiff)J0(k,q.isBigEndian);let Q=q0(k,q),M=K0(Q,q),K={height:M[b.TAG.HEIGHT],width:M[b.TAG.WIDTH],type:q.isBigTiff?"bigtiff":"tiff"};if(M[b.TAG.COMPRESSION])K.compression=M[b.TAG.COMPRESSION];if(!K.width||!K.height)throw new TypeError("Invalid Tiff. Missing tags");return K}};function D0(k){return{height:1+Wk(k,7),width:1+Wk(k,4)}}function G0(k){return{height:1+((k[4]&15)<<10|k[3]<<2|(k[2]&192)>>6),width:1+((k[2]&63)<<8|k[1])}}function A0(k){return{height:Vk(k,8)&16383,width:Vk(k,6)&16383}}var C0={validate(k){let q=L(k,0,4)==="RIFF",Q=L(k,8,12)==="WEBP",M=L(k,12,15)==="VP8";return q&&Q&&M},calculate(k){let q=L(k,12,16),Q=k.slice(20,30);if(q==="VP8X"){let K=Q[0],J=(K&192)===0,$=(K&1)===0;if(J&&$)return D0(Q);throw new TypeError("Invalid WebP")}if(q==="VP8 "&&Q[0]!==47)return A0(Q);let M=f(Q,3,6);if(q==="VP8L"&&M!=="9d012a")return G0(Q);throw new TypeError("Invalid WebP")}},e=new Map([["bmp",Kq],["cur",Dq],["dds",Gq],["gif",Cq],["heif",Vq],["icns",Pq],["ico",zk],["j2c",zq],["jp2",Uq],["jpg",hq],["jxl",uq],["jxl-stream",Nk],["ktx",_q],["png",aq],["pnm",fq],["psd",sq],["svg",tq],["tga",k0],["tiff",j0],["webp",C0]]),R0=Array.from(e.keys()),V0=new Map([[0,"heif"],[56,"psd"],[66,"bmp"],[68,"dds"],[71,"gif"],[73,"tiff"],[77,"tiff"],[82,"webp"],[105,"icns"],[137,"png"],[255,"jpg"]]);function W0(k){let q=k[0],Q=V0.get(q);if(Q&&e.get(Q).validate(k))return Q;return R0.find((M)=>e.get(M).validate(k))}var X0={disabledTypes:[]};function Ik(k){let q=W0(k);if(typeof q!=="undefined"){if(X0.disabledTypes.indexOf(q)>-1)throw new TypeError(\`disabled file type: \${q}\`);let Q=e.get(q).calculate(k);if(Q!==void 0){if(Q.type=Q.type??q,Q.images&&Q.images.length>1){let M=Q.images.reduce((K,J)=>{return J.width*J.height>K.width*K.height?J:K},Q.images[0]);Q.width=M.width,Q.height=M.height}return Q}}throw new TypeError(\`unsupported file type: \${q}\`)}async function Fk(k,q,Q){let M=await k.arrayBuffer(),K=Ik(new Uint8Array(M));console.log(K);let J=await createImageBitmap(k),$=J.width,Z=J.height,j=q/$,D=q/Z,G=Math.min(j,D,1),C=Math.floor($*G),W=Math.floor(Z*G),A=Gk($,Z,C,W,Q.initialSize,Q.filterPadding),R=Rk($,Z,C,W,Q.initialSize,Q.filterPadding,Q.filter,Q.unsharpAmount,Q.unsharpRadius,Q.unsharpThreshold),y=new OffscreenCanvas($,Z).getContext("2d");if(!y)throw new Error("PicSquish: Canvas context is not supported");y.drawImage(J,0,0);let Y=y.getImageData(0,0,$,Z),V=new SharedArrayBuffer(Y.data.byteLength);new Uint8ClampedArray(V).set(Y.data);let z=C*W*4,O=new SharedArrayBuffer(z);return{from:V,fromWidth:$,fromHeight:Z,to:O,tileTransforms:R,stages:A}}var y0="<WORKER_CODE>",Y0=new Blob([y0],{type:"application/javascript"});var Tk=(()=>{let k=0;return()=>++k})();class bk{#q;#K;#Q;#M;constructor(){this.#q=new Map,this.#K=new Map,this.#Q=new Map,this.#M=new Map}get count(){return this.#q.size}#$(k){clearTimeout(this.#K.get(k))}#k(k,q,Q,M){this.#q.set(k,q.id),this.#Q.set(q.id,k),this.#M.set(q.id,q),k.postMessage(Q,M),this.#$(k)}assignPriority1Task(k,q){let Q={taskId:q.id,squishId:q.squishId,taskType:0,blob:q.data.blob,maxDimension:q.data.maxDimension,tileOptions:q.data.tileOptions};console.log("TASK 1"),this.#k(k,q,Q,[])}assignPriority2Task(k,q){let Q={taskId:q.id,squishId:q.squishId,taskType:1,tileTransform:q.data.tileTransform,from:q.data.from,fromWidth:q.data.fromWidth,to:q.data.to,toWidth:q.data.toWidth};this.#k(k,q,Q,[])}setWorkerTimeout(k,q){let Q=setTimeout(()=>{let M=this.#q.get(k);if(M)this.#Q.delete(M);if(M)this.#M.delete(M);this.#K.delete(k),this.#q.delete(k),k.terminate()},q);this.#K.set(k,Q)}addWorker(k){this.#q.set(k,null)}getWorker(k){return this.#Q.get(k)}getTask(k){return this.#M.get(k)}getAvailableWorker(){for(let[k,q]of this.#q.entries())if(q===null)return k;return null}removeTask(k){let q=this.#Q.get(k);if(q)this.#q.set(q,null);this.#Q.delete(k),this.#M.delete(k)}}class w0{#q;#K;#Q;#M;#$;#k;constructor(k,q){this.#K=k,this.#q=q,this.#Q=new Map,this.#M=[],this.#$=[],this.#k=new bk}#Z(){let k=new Worker(URL.createObjectURL(Y0));k.onmessage=(q)=>{let Q=this.#Q.get(q.data.squishId);if(!Q)throw new Error("SquishContext not found");if(q.data.taskType===0){let{squishId:K,error:J,output:$}=q.data;if(J)Q.reject(J);else{Q.from=$.from,Q.fromWidth=$.fromWidth,Q.fromHeight=$.fromHeight,Q.to=$.to,Q.toWidth=$.stages[0].toWidth,Q.toHeight=$.stages[0].toHeight,Q.stages=$.stages,Q.remainingTileCount=$.tileTransforms.length;for(let Z of $.tileTransforms)this.#$.push({id:Tk(),squishId:K,data:{tileTransform:Z,from:Q.from,fromWidth:Q.fromWidth,to:Q.to,toWidth:Q.toWidth}})}}if(q.data.taskType===1){let{error:K}=q.data;if(K)Q.reject(K);else if(Q.remainingTileCount--,!Q.remainingTileCount){if(!Q.to)throw new Error("SquishContext to not found");L0(Q.to,Q.toWidth,Q.toHeight).then((J)=>{Q.resolve(J)})}}let M=this.#k.getWorker(q.data.taskId);if(M)this.#k.setWorkerTimeout(M,this.#q);this.#k.removeTask(q.data.taskId),this.#J()},k.onerror=(q)=>{console.log(q.message),console.log(q)},this.#k.addWorker(k)}#J(){let k=this.#k.getAvailableWorker();if(k){let q=this.#M.shift();if(q)return this.#k.assignPriority1Task(k,q);let Q=this.#$.shift();if(Q)return this.#k.assignPriority2Task(k,Q)}else if(this.#k.count<this.#K)this.#Z(),this.#J()}add(k){return new Promise((q,Q)=>{let M=Tk();this.#Q.set(M,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:q,reject:Q}),this.#M.push({id:M,squishId:M,data:k}),this.#J()})}}async function L0(k,q,Q){let M=new Uint8ClampedArray(k),K=new Uint8ClampedArray(M),J=new ImageData(K,q,Q);return await createImageBitmap(J)}var Mk={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let q=k*Math.PI;return Math.sin(q)/q*(0.54+0.46*Math.cos(q/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let q=k*Math.PI;return Math.sin(q)/q*Math.sin(q/2)/(q/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let q=k*Math.PI;return Math.sin(q)/q*Math.sin(q/3)/(q/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var P0=14;function Sk(k){return Math.round(k*((1<<P0)-1))}function Kk(k,q,Q,M,K){let J=Mk[k].fn,$=1/M,Z=Math.min(1,M),j=Mk[k].win/Z,D,G,C,W,A,R,X,y,Y,V,w,z,O,P,H,E,S,h=Math.floor((j+1)*2),U=new Int16Array((h+2)*Q),B=0,I=!U.subarray||!U.set;for(D=0;D<Q;D++){G=(D+0.5)*$+K,C=Math.max(0,Math.floor(G-j)),W=Math.min(q-1,Math.ceil(G+j)),A=W-C+1,R=new Float32Array(A),X=new Int16Array(A),y=0;for(Y=C,V=0;Y<=W;Y++,V++)w=J((Y+0.5-G)*Z),y+=w,R[V]=w;z=0;for(V=0;V<R.length;V++)O=R[V]/y,z+=O,X[V]=Sk(O);X[Q>>1]+=Sk(1-z),P=0;while(P<X.length&&X[P]===0)P++;if(P<X.length){H=X.length-1;while(H>0&&X[H]===0)H--;if(E=C+P,S=H-P+1,U[B++]=E,U[B++]=S,!I)U.set(X.subarray(P,H+1),B),B+=S;else for(V=P;V<=H;V++)U[B++]=X[V]}else U[B++]=0,U[B++]=0}return U}function u(k){return k<0?0:k>255?255:k}function _(k){return k>=0?k:0}function Bk(k,q,Q,M,K,J){let $,Z,j,D,G,C,W,A,R,X,y,Y=0,V=0;for(R=0;R<M;R++){G=0;for(X=0;X<K;X++){C=J[G++],W=J[G++],A=Y+C*4|0,$=Z=j=D=0;for(;W>0;W--)y=J[G++],D=D+y*k[A+3]|0,j=j+y*k[A+2]|0,Z=Z+y*k[A+1]|0,$=$+y*k[A]|0,A=A+4|0;q[V+3]=_(D>>7),q[V+2]=_(j>>7),q[V+1]=_(Z>>7),q[V]=_($>>7),V=V+M*4|0}V=(R+1)*4|0,Y=(R+1)*Q*4|0}}function mk(k,q,Q,M,K,J){let $,Z,j,D,G,C,W,A,R,X,y,Y=0,V=0;for(R=0;R<M;R++){G=0;for(X=0;X<K;X++){C=J[G++],W=J[G++],A=Y+C*4|0,$=Z=j=D=0;for(;W>0;W--)y=J[G++],D=D+y*k[A+3]|0,j=j+y*k[A+2]|0,Z=Z+y*k[A+1]|0,$=$+y*k[A]|0,A=A+4|0;$>>=7,Z>>=7,j>>=7,D>>=7,q[V+3]=u(D+8192>>14),q[V+2]=u(j+8192>>14),q[V+1]=u(Z+8192>>14),q[V]=u($+8192>>14),V=V+M*4|0}V=(R+1)*4|0,Y=(R+1)*Q*4|0}}function Ek(k,q,Q,M,K,J){let $,Z,j,D,G,C,W,A,R,X,y,Y,V=0,w=0;for(X=0;X<M;X++){C=0;for(y=0;y<K;y++){W=J[C++],A=J[C++],R=V+W*4|0,$=Z=j=D=0;for(;A>0;A--)Y=J[C++],G=k[R+3],D=D+Y*G|0,j=j+Y*k[R+2]*G|0,Z=Z+Y*k[R+1]*G|0,$=$+Y*k[R]*G|0,R=R+4|0;j=j/255|0,Z=Z/255|0,$=$/255|0,q[w+3]=_(D>>7),q[w+2]=_(j>>7),q[w+1]=_(Z>>7),q[w]=_($>>7),w=w+M*4|0}w=(X+1)*4|0,V=(X+1)*Q*4|0}}function hk(k,q,Q,M,K,J){let $,Z,j,D,G,C,W,A,R,X,y,Y=0,V=0;for(R=0;R<M;R++){G=0;for(X=0;X<K;X++){C=J[G++],W=J[G++],A=Y+C*4|0,$=Z=j=D=0;for(;W>0;W--)y=J[G++],D=D+y*k[A+3]|0,j=j+y*k[A+2]|0,Z=Z+y*k[A+1]|0,$=$+y*k[A]|0,A=A+4|0;if($>>=7,Z>>=7,j>>=7,D>>=7,D=u(D+8192>>14),D>0)$=$*255/D|0,Z=Z*255/D|0,j=j*255/D|0;q[V+3]=D,q[V+2]=u(j+8192>>14),q[V+1]=u(Z+8192>>14),q[V]=u($+8192>>14),V=V+M*4|0}V=(R+1)*4|0,Y=(R+1)*Q*4|0}}function z0(k,q,Q){let M=3,K=q*Q*4|0;while(M<K){if(k[M]!==255)return!0;M=M+4|0}return!1}function U0(k,q,Q){let M=3,K=q*Q*4|0;while(M<K)k[M]=255,M=M+4|0}function vk(k,q,Q,M,K,J,$,Z,j,D){let G=Kk(q,Q,K,$,j),C=Kk(q,M,J,Z,D),W=new Uint8Array(K*J*4),A=new Uint16Array(K*M*4);if(z0(k,Q,M))Ek(k,A,Q,M,K,G),hk(A,W,M,K,J,C);else Bk(k,A,Q,M,K,G),mk(A,W,M,K,J,C),U0(W,K,J);return W}var _k=ek(uk(),1);function H0(k,q,Q){let M=q*Q,K=new Uint16Array(M),J,$,Z,j;for(let D=0;D<M;D++)J=k[4*D],$=k[4*D+1],Z=k[4*D+2],j=J>="<WORKER_CODE>"&J>=Z?J:$>=Z&&$>=J?$:Z,K[D]=j<<8;return K}function ok(k,q,Q,M,K,J){let $,Z,j,D,G;if(M===0||K<0.5)return;if(K>2)K=2;let C=H0(k,q,Q),W=new Uint16Array(C);_k.default(W,q,Q,K);let A=M/100*4096+0.5|0,R=J<<8,X=q*Q;for(let y=0;y<X;y++)if($=C[y],D=$-W[y],Math.abs(D)>=R)Z=$+(A*D+2048>>12),Z=Z>65280?65280:Z,Z=Z<0?0:Z,$=$!==0?$:1,j=(Z<<12)/$|0,G=y*4,k[G]=k[G]*j+2048>>12,k[G+1]=k[G+1]*j+2048>>12,k[G+2]=k[G+2]*j+2048>>12}function lk(k,q){let Q=vk(k,q.filter,q.width,q.height,q.toWidth,q.toHeight,q.scaleX,q.scaleY,q.offsetX,q.offsetY);if(q.unsharpAmount)ok(Q,q.toWidth,q.toHeight,q.unsharpAmount,q.unsharpRadius,q.unsharpThreshold);return Q}function ak(k,q,Q,M){let J=new Uint8ClampedArray(k);for(let $=0;$<Q.toHeight;$++){let Z=$*Q.toWidth*4,j=((Q.toY+$)*q+Q.toX)*4;J.set(M.subarray(Z,Z+Q.toWidth*4),j)}}function fk(k,q,Q){let K=new Uint8ClampedArray(k),J=new Uint8ClampedArray(Q.width*Q.height*4);for(let $=0;$<Q.height;$++){let Z=((Q.y+$)*q+Q.x)*4,j=$*Q.width*4;J.set(K.subarray(Z,Z+Q.width*4),j)}return J}self.onmessage=async(k)=>{let{taskId:q,squishId:Q,taskType:M}=k.data;try{if(M===0){let{blob:K,maxDimension:J,tileOptions:$}=k.data,Z=await Fk(K,J,$),j={taskId:q,squishId:Q,taskType:M,output:{from:Z.from,fromWidth:Z.fromWidth,fromHeight:Z.fromHeight,to:Z.to,tileTransforms:Z.tileTransforms,stages:Z.stages}};self.postMessage(j)}if(M===1){let{tileTransform:K,from:J,fromWidth:$,to:Z,toWidth:j}=k.data,D=fk(J,$,K),G=lk(D,K);ak(Z,j,K,G);let C={taskId:q,squishId:Q,taskType:M};self.postMessage(C)}}catch(K){self.postMessage({taskId:q,error:K})}};
`,h1=new Blob([b1],{type:"application/javascript"});var Kk=(()=>{let k=0;return()=>++k})();class Wk{#k;#M;#Q;#K;constructor(){this.#k=new Map,this.#M=new Map,this.#Q=new Map,this.#K=new Map}get count(){return this.#k.size}#W(k){clearTimeout(this.#M.get(k))}#q(k,q,M,Q){this.#k.set(k,q.id),this.#Q.set(q.id,k),this.#K.set(q.id,q),k.postMessage(M,Q),this.#W(k)}assignPriority1Task(k,q){let M={taskId:q.id,squishId:q.squishId,taskType:0,blob:q.data.blob,maxDimension:q.data.maxDimension,tileOptions:q.data.tileOptions};console.log("TASK 1"),this.#q(k,q,M,[])}assignPriority2Task(k,q){let M={taskId:q.id,squishId:q.squishId,taskType:1,tileTransform:q.data.tileTransform,from:q.data.from,fromWidth:q.data.fromWidth,to:q.data.to,toWidth:q.data.toWidth};this.#q(k,q,M,[])}setWorkerTimeout(k,q){let M=setTimeout(()=>{let Q=this.#k.get(k);if(Q)this.#Q.delete(Q);if(Q)this.#K.delete(Q);this.#M.delete(k),this.#k.delete(k),k.terminate()},q);this.#M.set(k,M)}addWorker(k){this.#k.set(k,null)}getWorker(k){return this.#Q.get(k)}getTask(k){return this.#K.get(k)}getAvailableWorker(){for(let[k,q]of this.#k.entries())if(q===null)return k;return null}removeTask(k){let q=this.#Q.get(k);if(q)this.#k.set(q,null);this.#Q.delete(k),this.#K.delete(k)}}class B{#k;#M;#Q;#K;#W;#q;constructor(k,q){this.#M=k,this.#k=q,this.#Q=new Map,this.#K=[],this.#W=[],this.#q=new Wk}#J(){let k=new Worker(URL.createObjectURL(h1));k.onmessage=(q)=>{let M=this.#Q.get(q.data.squishId);if(!M)throw new Error("SquishContext not found");if(q.data.taskType===0){let{squishId:K,error:W,output:$}=q.data;if(W)M.reject(W);else{M.from=$.from,M.fromWidth=$.fromWidth,M.fromHeight=$.fromHeight,M.to=$.to,M.toWidth=$.stages[0].toWidth,M.toHeight=$.stages[0].toHeight,M.stages=$.stages,M.remainingTileCount=$.tileTransforms.length;for(let J of $.tileTransforms)this.#W.push({id:Kk(),squishId:K,data:{tileTransform:J,from:M.from,fromWidth:M.fromWidth,to:M.to,toWidth:M.toWidth}})}}if(q.data.taskType===1){let{error:K}=q.data;if(K)M.reject(K);else if(M.remainingTileCount--,!M.remainingTileCount){if(!M.to)throw new Error("SquishContext to not found");_1(M.to,M.toWidth,M.toHeight).then((W)=>{M.resolve(W)})}}let Q=this.#q.getWorker(q.data.taskId);if(Q)this.#q.setWorkerTimeout(Q,this.#k);this.#q.removeTask(q.data.taskId),this.#$()},k.onerror=(q)=>{console.log(q.message),console.log(q)},this.#q.addWorker(k)}#$(){let k=this.#q.getAvailableWorker();if(k){let q=this.#K.shift();if(q)return this.#q.assignPriority1Task(k,q);let M=this.#W.shift();if(M)return this.#q.assignPriority2Task(k,M)}else if(this.#q.count<this.#M)this.#J(),this.#$()}add(k){return new Promise((q,M)=>{let Q=Kk();this.#Q.set(Q,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:q,reject:M}),this.#K.push({id:Q,squishId:Q,data:k}),this.#$()})}}async function _1(k,q,M){let Q=new Uint8ClampedArray(k),K=new Uint8ClampedArray(Q),W=new ImageData(K,q,M);return await createImageBitmap(W)}function H1(){return typeof SharedArrayBuffer==="function"&&self.crossOriginIsolated===!0}class F1{#k;#M;constructor(k){let q=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,M=k.maxWorkerPoolSize||Math.min(q,4),Q=k.maxWorkerIdleTime||1e4;this.#k=new B(M,Q),this.#M=k}async squish(k,q){console.log("SAB",H1());let M=q?{...this.#M,...q}:this.#M,Q=M.maxDimension,K=M.tileSize||1024,W=M.filter||"mks2013",$=M.unsharpAmount||0,J=M.unsharpRadius||0,G=M.unsharpThreshold||0,P=M.useMainThread,j=Math.ceil(Math.max(3,2.5*J|0)),A={initialSize:K,filterPadding:j,filter:W,unsharpAmount:$,unsharpRadius:J,unsharpThreshold:G};if(P){let Y=await Qk(k,Q,A);return console.log("here"),console.log(Y),Y}return this.#k.add({blob:k,maxDimension:Q,tileOptions:A})}}export{F1 as PicSquish};
