var Cn=Object.create;var{getPrototypeOf:qn,defineProperty:_,getOwnPropertyNames:Qn}=Object;var Kn=Object.prototype.hasOwnProperty;var Jn=(n,a,u)=>{u=n!=null?Cn(qn(n)):{};let k=a||!n||!n.__esModule?_(u,"default",{value:n,enumerable:!0}):u;for(let I of Qn(n))if(!Kn.call(k,I))_(k,I,{get:()=>n[I],enumerable:!0});return k};var $n=(n,a)=>()=>(a||n((a={exports:{}}).exports,a),a.exports);var Tn=$n((tn,mn)=>{var W,P,v,H,V,N,kn,In;function on(n){if(n<0.5)n=0.5;var a=Math.exp(0.527076)/n,u=Math.exp(-a),k=Math.exp(-2*a),I=(1-u)*(1-u)/(1+2*a*u-k);return W=I,P=I*(a-1)*u,v=I*(a+1)*u,H=-I*k,V=2*u,N=-k,kn=(W+P)/(1-V-N),In=(v+H)/(1-V-N),new Float32Array([W,P,v,H,V,N,kn,In])}function Rn(n,a,u,k,I,T){var R,b,y,m,D,M,q,B,C,U,A,Q,w,K;for(C=0;C<T;C++){M=C*I,q=C,B=0,R=n[M],D=R*k[6],m=D,A=k[0],Q=k[1],w=k[4],K=k[5];for(U=0;U<I;U++)b=n[M],y=b*A+R*Q+m*w+D*K,D=m,m=y,R=b,u[B]=m,B++,M++;M--,B--,q+=T*(I-1),R=n[M],D=R*k[7],m=D,b=R,A=k[2],Q=k[3];for(U=I-1;U>=0;U--)y=b*A+R*Q+m*w+D*K,D=m,m=y,R=b,b=n[M],a[q]=u[B]+m,M--,B--,q-=T}}function zn(n,a,u,k){if(!k)return;var I=new Uint16Array(n.length),T=new Float32Array(Math.max(a,u)),R=on(k);Rn(n,I,T,R,a,u,k),Rn(I,n,T,R,u,a,k)}mn.exports=zn});var J=4;class X{raw;width;height;constructor(n,a,u){this.raw=n,this.width=a,this.height=u}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let n=document.createElement("canvas");n.width=this.width,n.height=this.height;let a=n.getContext("2d");if(!a)throw new Error("Picsquish error: canvas 2D context not supported");return a.putImageData(this.toImageData(),0,0),n}toBlob(n="image/png"){let a=new OffscreenCanvas(this.width,this.height),u=a.getContext("2d");if(!u)throw new Error("Picsquish error: canvas 2D context not supported");return u.putImageData(this.toImageData(),0,0),a.convertToBlob({type:n})}}var Gn=2;function x(n,a,u,k,I,T){let R=u/n,b=k/a,y=(2*T+Gn+1)/I;if(y>0.5)return[{toWidth:u,toHeight:k}];let m=Math.ceil(Math.log(Math.min(R,b))/Math.log(y));if(m<=1)return[{toWidth:u,toHeight:k}];let D=[];for(let M=0;M<m;M++){let q=Math.round(Math.pow(Math.pow(n,m-M-1)*Math.pow(u,M+1),1/m)),B=Math.round(Math.pow(Math.pow(a,m-M-1)*Math.pow(k,M+1),1/m));D.push({toWidth:q,toHeight:B})}return D}function Zn(n,a){let k=new OffscreenCanvas(a.width,a.height).getContext("2d");if(!k)throw new Error("Picsquish error: canvas 2D context not supported");return k.globalCompositeOperation="copy",k.drawImage(n,a.x,a.y,a.width,a.height,0,0,a.width,a.height),k.getImageData(0,0,a.width,a.height).data.buffer}function jn(n,a,u){let k=new Uint8ClampedArray(u.width*u.height*J);for(let I=0;I<u.height;I++){let T=((u.y+I)*a+u.x)*J,R=I*u.width*J;k.set(n.subarray(T,T+u.width*J),R)}return k.buffer}function d(n,a,u){if(n instanceof ImageBitmap)return Zn(n,u);else return jn(n,a,u)}var e=0.00001;function p(n){let a=Math.round(n);if(Math.abs(n-a)<e)return a;return Math.floor(n)}function c(n){let a=Math.round(n);if(Math.abs(n-a)<e)return a;return Math.ceil(n)}function f(n,a,u,k,I,T,R,b,y,m,D){let M=k/a,q=I/u,B=p(T*M)-2*R,C=p(T*q)-2*R;if(B<1||C<1)throw new Error("Picsquish error: target tile width/height is too small");let U,A,Q,w,K,G,z=[];for(w=0;w<I;w+=C)for(Q=0;Q<k;Q+=B){if(U=Q-R,U<0)U=0;if(K=Q+B+R-U,U+K>=k)K=k-U;if(A=w-R,A<0)A=0;if(G=w+C+R-A,A+G>=I)G=I-A;let $={toX:U,toY:A,toWidth:K,toHeight:G,toInnerX:Q,toInnerY:w,toInnerWidth:B,toInnerHeight:C,offsetX:U/M-p(U/M),offsetY:A/q-p(A/q),scaleX:M,scaleY:q,x:p(U/M),y:p(A/q),width:c(K/M),height:c(G/q),initialSize:T,filterPadding:R,filter:b,unsharpAmount:y,unsharpRadius:m,unsharpThreshold:D},Z=d(n,a,$);z.push({tile:Z,...$})}return z}async function r(n){let a,u,k,I,T,R;if(n.image instanceof Blob||n.image instanceof ImageBitmap){let y=n.image instanceof ImageBitmap?n.image:await createImageBitmap(n.image);a=y,u=y.width,k=y.height;let m=n.maxDimension/u,D=n.maxDimension/k,M=Math.min(m,D,1),q=Math.floor(u*M),B=Math.floor(k*M);I=x(u,k,q,B,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else a=n.image.from,u=n.image.fromWidth,k=n.image.fromHeight,I=n.image.stages;T=I[0].toWidth,R=I[0].toHeight;let b=f(a,u,k,T,R,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);if(a instanceof ImageBitmap)a.close();return{tileTransforms:b,stages:I}}var g={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let a=n*Math.PI;return Math.sin(a)/a*(0.54+0.46*Math.cos(a/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let a=n*Math.PI;return Math.sin(a)/a*Math.sin(a/2)/(a/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let a=n*Math.PI;return Math.sin(a)/a*Math.sin(a/3)/(a/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Ln=14;function l(n){return Math.round(n*((1<<Ln)-1))}function F(n,a,u,k,I){let T=g[n].fn,R=1/k,b=Math.min(1,k),y=g[n].win/b,m,D,M,q,B,C,U,A,Q,w,K,G,z,$,Z,h,S,Un=Math.floor((y+1)*2),j=new Int16Array((Un+2)*u),O=0,An=!j.subarray||!j.set;for(m=0;m<u;m++){D=(m+0.5)*R+I,M=Math.max(0,Math.floor(D-y)),q=Math.min(a-1,Math.ceil(D+y)),B=q-M+1,C=new Float32Array(B),U=new Int16Array(B),A=0;for(Q=M,w=0;Q<=q;Q++,w++)K=T((Q+0.5-D)*b),A+=K,C[w]=K;G=0;for(w=0;w<C.length;w++)z=C[w]/A,G+=z,U[w]=l(z);U[u>>1]+=l(1-G),$=0;while($<U.length&&U[$]===0)$++;if($<U.length){Z=U.length-1;while(Z>0&&U[Z]===0)Z--;if(h=M+$,S=Z-$+1,j[O++]=h,j[O++]=S,!An)j.set(U.subarray($,Z+1),O),O+=S;else for(w=$;w<=Z;w++)j[O++]=U[w]}else j[O++]=0,j[O++]=0}return j}function L(n){return n<0?0:n>255?255:n}function E(n){return n>=0?n:0}function t(n,a,u,k,I,T){let R,b,y,m,D,M,q,B,C,U,A,Q=0,w=0;for(C=0;C<k;C++){D=0;for(U=0;U<I;U++){M=T[D++],q=T[D++],B=Q+M*4|0,R=b=y=m=0;for(;q>0;q--)A=T[D++],m=m+A*n[B+3]|0,y=y+A*n[B+2]|0,b=b+A*n[B+1]|0,R=R+A*n[B]|0,B=B+4|0;a[w+3]=E(m>>7),a[w+2]=E(y>>7),a[w+1]=E(b>>7),a[w]=E(R>>7),w=w+k*4|0}w=(C+1)*4|0,Q=(C+1)*u*4|0}}function i(n,a,u,k,I,T){let R,b,y,m,D,M,q,B,C,U,A,Q=0,w=0;for(C=0;C<k;C++){D=0;for(U=0;U<I;U++){M=T[D++],q=T[D++],B=Q+M*4|0,R=b=y=m=0;for(;q>0;q--)A=T[D++],m=m+A*n[B+3]|0,y=y+A*n[B+2]|0,b=b+A*n[B+1]|0,R=R+A*n[B]|0,B=B+4|0;R>>=7,b>>=7,y>>=7,m>>=7,a[w+3]=L(m+8192>>14),a[w+2]=L(y+8192>>14),a[w+1]=L(b+8192>>14),a[w]=L(R+8192>>14),w=w+k*4|0}w=(C+1)*4|0,Q=(C+1)*u*4|0}}function nn(n,a,u,k,I,T){let R,b,y,m,D,M,q,B,C,U,A,Q,w=0,K=0;for(U=0;U<k;U++){M=0;for(A=0;A<I;A++){q=T[M++],B=T[M++],C=w+q*4|0,R=b=y=m=0;for(;B>0;B--)Q=T[M++],D=n[C+3],m=m+Q*D|0,y=y+Q*n[C+2]*D|0,b=b+Q*n[C+1]*D|0,R=R+Q*n[C]*D|0,C=C+4|0;y=y/255|0,b=b/255|0,R=R/255|0,a[K+3]=E(m>>7),a[K+2]=E(y>>7),a[K+1]=E(b>>7),a[K]=E(R>>7),K=K+k*4|0}K=(U+1)*4|0,w=(U+1)*u*4|0}}function an(n,a,u,k,I,T){let R,b,y,m,D,M,q,B,C,U,A,Q=0,w=0;for(C=0;C<k;C++){D=0;for(U=0;U<I;U++){M=T[D++],q=T[D++],B=Q+M*4|0,R=b=y=m=0;for(;q>0;q--)A=T[D++],m=m+A*n[B+3]|0,y=y+A*n[B+2]|0,b=b+A*n[B+1]|0,R=R+A*n[B]|0,B=B+4|0;if(R>>=7,b>>=7,y>>=7,m>>=7,m=L(m+8192>>14),m>0)R=R*255/m|0,b=b*255/m|0,y=y*255/m|0;a[w+3]=m,a[w+2]=L(y+8192>>14),a[w+1]=L(b+8192>>14),a[w]=L(R+8192>>14),w=w+k*4|0}w=(C+1)*4|0,Q=(C+1)*u*4|0}}function En(n,a,u){let k=3,I=a*u*4|0;while(k<I){if(n[k]!==255)return!0;k=k+4|0}return!1}function On(n,a,u){let k=3,I=a*u*4|0;while(k<I)n[k]=255,k=k+4|0}function un(n,a,u,k,I,T,R,b,y,m){let D=F(a,u,I,R,y),M=F(a,k,T,b,m),q=new Uint8Array(I*T*4),B=new Uint16Array(I*k*4);if(En(n,u,k))nn(n,B,u,k,I,D),an(B,q,k,I,T,M);else t(n,B,u,k,I,D),i(B,q,k,I,T,M),On(q,I,T);return q}var bn=Jn(Tn(),1);function pn(n,a,u){let k=a*u,I=new Uint16Array(k),T,R,b,y;for(let m=0;m<k;m++)T=n[4*m],R=n[4*m+1],b=n[4*m+2],y=T>=R&&T>=b?T:R>=b&&R>=T?R:b,I[m]=y<<8;return I}function yn(n,a,u,k,I,T){let R,b,y,m,D;if(k===0||I<0.5)return;if(I>2)I=2;let M=pn(n,a,u),q=new Uint16Array(M);bn.default(q,a,u,I);let B=k/100*4096+0.5|0,C=T<<8,U=a*u;for(let A=0;A<U;A++)if(R=M[A],m=R-q[A],Math.abs(m)>=C)b=R+(B*m+2048>>12),b=b>65280?65280:b,b=b<0?0:b,R=R!==0?R:1,y=(b<<12)/R|0,D=A*4,n[D]=n[D]*y+2048>>12,n[D+1]=n[D+1]*y+2048>>12,n[D+2]=n[D+2]*y+2048>>12}function Bn(n){let a=un(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)yn(a,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return a}function Y(n,a,u){let k=new Uint8ClampedArray(u.tile);for(let I=0;I<u.toHeight;I++){let T=I*u.toWidth*J,R=((u.toY+I)*a+u.toX)*J;n.set(k.subarray(T,T+u.toWidth*J),R)}}var Xn=`
var yI=Object.create;var{getPrototypeOf:qI,defineProperty:g,getOwnPropertyNames:AI}=Object;var UI=Object.prototype.hasOwnProperty;var mI=(I,n,R)=>{R=I!=null?yI(qI(I)):{};let k=n||!I||!I.__esModule?g(R,"default",{value:I,enumerable:!0}):R;for(let M of AI(I))if(!UI.call(k,M))g(k,M,{get:()=>I[M],enumerable:!0});return k};var CI=(I,n)=>()=>(n||I((n={exports:{}}).exports,n),n.exports);var RI=CI((hI,kI)=>{var F,H,P,W,N,X,i,II;function ZI(I){if(I<0.5)I=0.5;var n=Math.exp(0.527076)/I,R=Math.exp(-n),k=Math.exp(-2*n),M=(1-R)*(1-R)/(1+2*n*R-k);return F=M,H=M*(n-1)*R,P=M*(n+1)*R,W=-M*k,N=2*R,X=-k,i=(F+H)/(1-N-X),II=(P+W)/(1-N-X),new Float32Array([F,H,P,W,N,X,i,II])}function nI(I,n,R,k,M,y){var u,D,B,a,q,U,K,A,J,C,b,$,m,G;for(J=0;J<y;J++){U=J*M,K=J,A=0,u=I[U],q=u*k[6],a=q,b=k[0],$=k[1],m=k[4],G=k[5];for(C=0;C<M;C++)D=I[U],B=D*b+u*$+a*m+q*G,q=a,a=B,u=D,R[A]=a,A++,U++;U--,A--,K+=y*(M-1),u=I[U],q=u*k[7],a=q,D=u,b=k[2],$=k[3];for(C=M-1;C>=0;C--)B=D*b+u*$+a*m+q*G,q=a,a=B,u=D,D=I[U],n[K]=R[A]+a,U--,A--,K-=y}}function wI(I,n,R,k){if(!k)return;var M=new Uint16Array(I.length),y=new Float32Array(Math.max(n,R)),u=ZI(k);nI(I,M,y,u,n,R,k),nI(M,I,y,u,R,n,k)}kI.exports=wI});var V=4;var bI=2;function _(I,n,R,k,M,y){let u=R/I,D=k/n,B=(2*y+bI+1)/M;if(B>0.5)return[{toWidth:R,toHeight:k}];let a=Math.ceil(Math.log(Math.min(u,D))/Math.log(B));if(a<=1)return[{toWidth:R,toHeight:k}];let q=[];for(let U=0;U<a;U++){let K=Math.round(Math.pow(Math.pow(I,a-U-1)*Math.pow(R,U+1),1/a)),A=Math.round(Math.pow(Math.pow(n,a-U-1)*Math.pow(k,U+1),1/a));q.push({toWidth:K,toHeight:A})}return q}function JI(I,n){let k=new OffscreenCanvas(n.width,n.height).getContext("2d");if(!k)throw new Error("Picsquish error: canvas 2D context not supported");return k.globalCompositeOperation="copy",k.drawImage(I,n.x,n.y,n.width,n.height,0,0,n.width,n.height),k.getImageData(0,0,n.width,n.height).data.buffer}function KI(I,n,R){let k=new Uint8ClampedArray(R.width*R.height*V);for(let M=0;M<R.height;M++){let y=((R.y+M)*n+R.x)*V,u=M*R.width*V;k.set(I.subarray(y,y+R.width*V),u)}return k.buffer}function o(I,n,R){if(I instanceof ImageBitmap)return JI(I,R);else return KI(I,n,R)}var h=0.00001;function O(I){let n=Math.round(I);if(Math.abs(I-n)<h)return n;return Math.floor(I)}function x(I){let n=Math.round(I);if(Math.abs(I-n)<h)return n;return Math.ceil(I)}function s(I,n,R,k,M,y,u,D,B,a,q){let U=k/n,K=M/R,A=O(y*U)-2*u,J=O(y*K)-2*u;if(A<1||J<1)throw new Error("Picsquish error: target tile width/height is too small");let C,b,$,m,G,Z,E=[];for(m=0;m<M;m+=J)for($=0;$<k;$+=A){if(C=$-u,C<0)C=0;if(G=$+A+u-C,C+G>=k)G=k-C;if(b=m-u,b<0)b=0;if(Z=m+J+u-b,b+Z>=M)Z=M-b;let Q={toX:C,toY:b,toWidth:G,toHeight:Z,toInnerX:$,toInnerY:m,toInnerWidth:A,toInnerHeight:J,offsetX:C/U-O(C/U),offsetY:b/K-O(b/K),scaleX:U,scaleY:K,x:O(C/U),y:O(b/K),width:x(G/U),height:x(Z/K),initialSize:y,filterPadding:u,filter:D,unsharpAmount:B,unsharpRadius:a,unsharpThreshold:q},w=o(I,n,Q);E.push({tile:w,...Q})}return E}async function d(I){let n,R,k,M,y,u;if(I.image instanceof Blob||I.image instanceof ImageBitmap){let B=I.image instanceof ImageBitmap?I.image:await createImageBitmap(I.image);n=B,R=B.width,k=B.height;let a=I.maxDimension/R,q=I.maxDimension/k,U=Math.min(a,q,1),K=Math.floor(R*U),A=Math.floor(k*U);M=_(R,k,K,A,I.tileOptions.initialSize,I.tileOptions.filterPadding)}else n=I.image.from,R=I.image.fromWidth,k=I.image.fromHeight,M=I.image.stages;y=M[0].toWidth,u=M[0].toHeight;let D=s(n,R,k,y,u,I.tileOptions.initialSize,I.tileOptions.filterPadding,I.tileOptions.filter,I.tileOptions.unsharpAmount,I.tileOptions.unsharpRadius,I.tileOptions.unsharpThreshold);if(n instanceof ImageBitmap)n.close();return{tileTransforms:D,stages:M}}var p={box:{win:0.5,fn:(I)=>{if(I<0)I=-I;return I<0.5?1:0}},hamming:{win:1,fn:(I)=>{if(I<0)I=-I;if(I>=1)return 0;if(I<0.00000011920929)return 1;let n=I*Math.PI;return Math.sin(n)/n*(0.54+0.46*Math.cos(n/1))}},lanczos2:{win:2,fn:(I)=>{if(I<0)I=-I;if(I>=2)return 0;if(I<0.00000011920929)return 1;let n=I*Math.PI;return Math.sin(n)/n*Math.sin(n/2)/(n/2)}},lanczos3:{win:3,fn:(I)=>{if(I<0)I=-I;if(I>=3)return 0;if(I<0.00000011920929)return 1;let n=I*Math.PI;return Math.sin(n)/n*Math.sin(n/3)/(n/3)}},mks2013:{win:2.5,fn:(I)=>{if(I<0)I=-I;if(I>=2.5)return 0;if(I>=1.5)return-0.125*(I-2.5)*(I-2.5);if(I>=0.5)return 0.25*(4*I*I-11*I+7);return 1.0625-1.75*I*I}}};var $I=14;function c(I){return Math.round(I*((1<<$I)-1))}function S(I,n,R,k,M){let y=p[I].fn,u=1/k,D=Math.min(1,k),B=p[I].win/D,a,q,U,K,A,J,C,b,$,m,G,Z,E,Q,w,v,Y,DI=Math.floor((B+1)*2),j=new Int16Array((DI+2)*R),z=0,BI=!j.subarray||!j.set;for(a=0;a<R;a++){q=(a+0.5)*u+M,U=Math.max(0,Math.floor(q-B)),K=Math.min(n-1,Math.ceil(q+B)),A=K-U+1,J=new Float32Array(A),C=new Int16Array(A),b=0;for($=U,m=0;$<=K;$++,m++)G=y(($+0.5-q)*D),b+=G,J[m]=G;Z=0;for(m=0;m<J.length;m++)E=J[m]/b,Z+=E,C[m]=c(E);C[R>>1]+=c(1-Z),Q=0;while(Q<C.length&&C[Q]===0)Q++;if(Q<C.length){w=C.length-1;while(w>0&&C[w]===0)w--;if(v=U+Q,Y=w-Q+1,j[z++]=v,j[z++]=Y,!BI)j.set(C.subarray(Q,w+1),z),z+=Y;else for(m=Q;m<=w;m++)j[z++]=C[m]}else j[z++]=0,j[z++]=0}return j}function L(I){return I<0?0:I>255?255:I}function T(I){return I>=0?I:0}function f(I,n,R,k,M,y){let u,D,B,a,q,U,K,A,J,C,b,$=0,m=0;for(J=0;J<k;J++){q=0;for(C=0;C<M;C++){U=y[q++],K=y[q++],A=$+U*4|0,u=D=B=a=0;for(;K>0;K--)b=y[q++],a=a+b*I[A+3]|0,B=B+b*I[A+2]|0,D=D+b*I[A+1]|0,u=u+b*I[A]|0,A=A+4|0;n[m+3]=T(a>>7),n[m+2]=T(B>>7),n[m+1]=T(D>>7),n[m]=T(u>>7),m=m+k*4|0}m=(J+1)*4|0,$=(J+1)*R*4|0}}function l(I,n,R,k,M,y){let u,D,B,a,q,U,K,A,J,C,b,$=0,m=0;for(J=0;J<k;J++){q=0;for(C=0;C<M;C++){U=y[q++],K=y[q++],A=$+U*4|0,u=D=B=a=0;for(;K>0;K--)b=y[q++],a=a+b*I[A+3]|0,B=B+b*I[A+2]|0,D=D+b*I[A+1]|0,u=u+b*I[A]|0,A=A+4|0;u>>=7,D>>=7,B>>=7,a>>=7,n[m+3]=L(a+8192>>14),n[m+2]=L(B+8192>>14),n[m+1]=L(D+8192>>14),n[m]=L(u+8192>>14),m=m+k*4|0}m=(J+1)*4|0,$=(J+1)*R*4|0}}function e(I,n,R,k,M,y){let u,D,B,a,q,U,K,A,J,C,b,$,m=0,G=0;for(C=0;C<k;C++){U=0;for(b=0;b<M;b++){K=y[U++],A=y[U++],J=m+K*4|0,u=D=B=a=0;for(;A>0;A--)$=y[U++],q=I[J+3],a=a+$*q|0,B=B+$*I[J+2]*q|0,D=D+$*I[J+1]*q|0,u=u+$*I[J]*q|0,J=J+4|0;B=B/255|0,D=D/255|0,u=u/255|0,n[G+3]=T(a>>7),n[G+2]=T(B>>7),n[G+1]=T(D>>7),n[G]=T(u>>7),G=G+k*4|0}G=(C+1)*4|0,m=(C+1)*R*4|0}}function r(I,n,R,k,M,y){let u,D,B,a,q,U,K,A,J,C,b,$=0,m=0;for(J=0;J<k;J++){q=0;for(C=0;C<M;C++){U=y[q++],K=y[q++],A=$+U*4|0,u=D=B=a=0;for(;K>0;K--)b=y[q++],a=a+b*I[A+3]|0,B=B+b*I[A+2]|0,D=D+b*I[A+1]|0,u=u+b*I[A]|0,A=A+4|0;if(u>>=7,D>>=7,B>>=7,a>>=7,a=L(a+8192>>14),a>0)u=u*255/a|0,D=D*255/a|0,B=B*255/a|0;n[m+3]=a,n[m+2]=L(B+8192>>14),n[m+1]=L(D+8192>>14),n[m]=L(u+8192>>14),m=m+k*4|0}m=(J+1)*4|0,$=(J+1)*R*4|0}}function GI(I,n,R){let k=3,M=n*R*4|0;while(k<M){if(I[k]!==255)return!0;k=k+4|0}return!1}function QI(I,n,R){let k=3,M=n*R*4|0;while(k<M)I[k]=255,k=k+4|0}function t(I,n,R,k,M,y,u,D,B,a){let q=S(n,R,M,u,B),U=S(n,k,y,D,a),K=new Uint8Array(M*y*4),A=new Uint16Array(M*k*4);if(GI(I,R,k))e(I,A,R,k,M,q),r(A,K,k,M,y,U);else f(I,A,R,k,M,q),l(A,K,k,M,y,U),QI(K,M,y);return K}var uI=mI(RI(),1);function jI(I,n,R){let k=n*R,M=new Uint16Array(k),y,u,D,B;for(let a=0;a<k;a++)y=I[4*a],u=I[4*a+1],D=I[4*a+2],B=y>=u&&y>=D?y:u>=D&&u>=y?u:D,M[a]=B<<8;return M}function MI(I,n,R,k,M,y){let u,D,B,a,q;if(k===0||M<0.5)return;if(M>2)M=2;let U=jI(I,n,R),K=new Uint16Array(U);uI.default(K,n,R,M);let A=k/100*4096+0.5|0,J=y<<8,C=n*R;for(let b=0;b<C;b++)if(u=U[b],a=u-K[b],Math.abs(a)>=J)D=u+(A*a+2048>>12),D=D>65280?65280:D,D=D<0?0:D,u=u!==0?u:1,B=(D<<12)/u|0,q=b*4,I[q]=I[q]*B+2048>>12,I[q+1]=I[q+1]*B+2048>>12,I[q+2]=I[q+2]*B+2048>>12}function aI(I){let n=t(new Uint8ClampedArray(I.tile),I.filter,I.width,I.height,I.toWidth,I.toHeight,I.scaleX,I.scaleY,I.offsetX,I.offsetY);if(I.unsharpAmount)MI(n,I.toWidth,I.toHeight,I.unsharpAmount,I.unsharpRadius,I.unsharpThreshold);return n}var LI=async(I)=>{let{taskId:n,squishId:R,taskType:k,image:M,maxDimension:y,tileOptions:u}=I,{tileTransforms:D,stages:B}=await d({image:M,maxDimension:y,tileOptions:u}),a={taskId:n,squishId:R,taskType:k,output:{tileTransforms:D,stages:B}},q=D.map((U)=>U.tile);self.postMessage(a,q)};function TI(I){let{taskId:n,squishId:R,taskType:k,tileTransform:M}=I;M.tile=aI(M).buffer;let y={taskId:n,squishId:R,taskType:k,output:{tileTransform:M}};self.postMessage(y,[M.tile])}self.onmessage=async(I)=>{try{switch(I.data.taskType){case 0:return LI(I.data);case 1:return TI(I.data)}}catch(n){self.postMessage({taskId:I.data.taskId,squishId:I.data.squishId,taskType:I.data.taskType,error:n})}};
`,Vn=new Blob([Xn],{type:"application/javascript"});class Dn{#n;#a;#u;#k;constructor(){this.#n=new Map,this.#a=new Map,this.#u=null,this.#k=null}#I(){if(this.#u===null)return;clearTimeout(this.#u),this.#u=null}prepare(n,a,u){if(this.#n.size)return;this.#k=u;let k=URL.createObjectURL(Vn);while(this.#n.size<a){let I=new Worker(k);I.onmessage=n,this.#n.set(I,null)}URL.revokeObjectURL(k)}assignTask(n,a,u,k){this.#n.set(n,a.id),this.#a.set(a.id,n),this.#I(),n.postMessage(u,k)}setTimeout(){if(this.#u!==null)return;this.#u=setTimeout(()=>{for(let n of this.#n.keys())n.terminate();this.#n.clear(),this.#a.clear()},this.#k||0)}getAvailableWorkers(){let n=[];for(let[a,u]of this.#n.entries())if(u===null)n.push(a);return n}removeTask(n){let a=this.#a.get(n);if(a)this.#n.set(a,null);this.#a.delete(n)}}var o=new Dn;var s=(()=>{let n=0;return()=>++n})();class Mn{#n;#a;#u;constructor(){this.#n=new Map,this.#a=[],this.#u=[]}#k(n,a){let u={taskId:a.id,squishId:a.squishId,taskType:0,image:a.data.image,maxDimension:a.data.maxDimension,tileOptions:a.data.tileOptions},k=a.data.image instanceof ImageBitmap?[a.data.image]:[];o.assignTask(n,a,u,k)}#I(n,a){let u={taskId:a.id,squishId:a.squishId,taskType:1,tileTransform:a.data.tileTransform};o.assignTask(n,a,u,[u.tileTransform.tile])}#m(n){let a=this.#a.shift();if(a)return this.#k(n,a);let u=this.#u.shift();if(u)return this.#I(n,u)}#R(){if(this.#a.length===0&&this.#u.length===0)return o.setTimeout();let a=o.getAvailableWorkers();for(let u of a)this.#m(u)}#T(n,a){let{squishId:u,output:k}=a,I=k.stages[0].toWidth,T=k.stages[0].toHeight;n.to=new Uint8ClampedArray(I*T*J),n.toWidth=I,n.toHeight=T,n.stages=k.stages,n.remainingTileCount=k.tileTransforms.length;for(let R of k.tileTransforms)this.#u.push({id:s(),squishId:u,data:{tileTransform:R}})}#b(n,a){let{squishId:u,output:k}=a;if(!n.to)throw new Error("Picsquish error: squishContext.to not found");if(Y(n.to,n.toWidth,k.tileTransform),n.remainingTileCount--,n.remainingTileCount)return;if(n.stages.shift(),!n.stages[0])return n.resolve(new X(n.to,n.toWidth,n.toHeight));this.#a.push({id:s(),squishId:u,data:{image:{from:n.to,fromWidth:n.toWidth,fromHeight:n.toHeight,stages:n.stages},maxDimension:n.maxDimension,tileOptions:n.tileOptions}})}#y(n){let a=this.#n.get(n.data.squishId);if(!a)throw new Error("Picsquish error: squishContext not found");if(n.data.error)a.reject(n.data.error);switch(n.data.taskType){case 0:this.#T(a,n.data);break;case 1:this.#b(a,n.data);break}o.removeTask(n.data.taskId),this.#R()}add(n,a,u){return o.prepare((k)=>this.#y(k),a,u),new Promise((k,I)=>{let T=s();this.#n.set(T,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:k,reject:I}),this.#a.push({id:T,squishId:T,data:n}),this.#R()})}}var wn=new Mn;async function Nn(n,a,u){let k=null,I,T,R;for(;;){let b=await r({image:k||n,maxDimension:a,tileOptions:u});T=b.stages[0].toWidth,R=b.stages[0].toHeight,I=new Uint8ClampedArray(T*R*J);for(let y of b.tileTransforms)y.tile=Bn(y).buffer,Y(I,T,y);if(b.stages.shift(),k={from:I,fromWidth:T,fromHeight:R,stages:b.stages},!b.stages[0])break}return new X(I,T,R)}async function Xa(n,a,u={}){let k=u.tileSize||1024,I=u.filter||"mks2013",T=u.unsharpAmount||0,R=u.unsharpRadius||0,b=u.unsharpThreshold||0,y=u.useMainThread,m=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,D=u.maxWorkerPoolSize||Math.min(m,4),M=u.maxWorkerIdleTime||2000,q=3,B=Math.ceil(Math.max(3,2.5*R|0)),C={initialSize:k,filterPadding:B,filter:I,unsharpAmount:T,unsharpRadius:R,unsharpThreshold:b};if(y)return await Nn(n,a,C);return wn.add({image:n,maxDimension:a,tileOptions:C},D,M)}export{Xa as squish};
