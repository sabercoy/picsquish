var f=2;function q(G,J,K,V,U,$){let Z=K/G,E=V/J,M=(2*$+f+1)/U;if(M>0.5)return[{toWidth:K,toHeight:V}];let L=Math.ceil(Math.log(Math.min(Z,E))/Math.log(M));if(L<=1)return[{toWidth:K,toHeight:V}];let R=[];for(let j=0;j<L;j++){let N=Math.round(Math.pow(Math.pow(G,L-j-1)*Math.pow(K,j+1),1/L)),F=Math.round(Math.pow(Math.pow(J,L-j-1)*Math.pow(V,j+1),1/L));R.push({toWidth:N,toHeight:F})}return R}var y=0.00001;function z(G){let J=Math.round(G);if(Math.abs(G-J)<y)return J;return Math.floor(G)}function B(G){let J=Math.round(G);if(Math.abs(G-J)<y)return J;return Math.ceil(G)}function b(G,J,K,V,U,$,Z,E,M,L,R){let j=V/G,N=U/J,F=z(K*j)-2*$,D=z(K*N)-2*$;if(F<1||D<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let _,A,Y,Q,X,v,S=[];for(Q=0;Q<U;Q+=D)for(Y=0;Y<V;Y+=F){if(_=Y-$,_<0)_=0;if(X=Y+F+$-_,_+X>=V)X=V-_;if(A=Q-$,A<0)A=0;if(v=Q+D+$-A,A+v>=U)v=U-A;S.push({toX:_,toY:A,toWidth:X,toHeight:v,toInnerX:Y,toInnerY:Q,toInnerWidth:F,toInnerHeight:D,offsetX:_/j-z(_/j),offsetY:A/N-z(A/N),scaleX:j,scaleY:N,x:z(_/j),y:z(A/N),width:B(X/j),height:B(v/N),originalTileSize:Z,filter:E,unsharpAmount:M,unsharpRadius:L,unsharpThreshold:R,destTileBorder:$})}return S}async function C(G,J,K){let V=await createImageBitmap(G),U=V.width,$=V.height,Z=J/U,E=J/$,M=Math.min(Z,E,1),L=Math.floor(U*M),R=Math.floor($*M),j=q(U,$,L,R,K.srcTileSize,K.destTileBorder),N=b(U,$,K.srcTileSize,L,R,K.destTileBorder,K.srcTileSize,K.filter,K.unsharpAmount,K.unsharpRadius,K.unsharpThreshold),D=new OffscreenCanvas(U,$).getContext("2d");if(!D)throw new Error("PicSquish: Canvas context is not supported");D.drawImage(V,0,0);let _=D.getImageData(0,0,U,$),A=new SharedArrayBuffer(_.data.byteLength);new Uint8ClampedArray(A).set(_.data);let Q=L*R*4,X=new SharedArrayBuffer(Q);return{from:A,fromWidth:U,fromHeight:$,to:X,tileTransforms:N,stages:j}}var I=`
var E8=Object.create;var{getPrototypeOf:X8,defineProperty:a,getOwnPropertyNames:C8}=Object;var Y8=Object.prototype.hasOwnProperty;var y8=(U,J,K)=>{K=U!=null?E8(X8(U)):{};let $=J||!U||!U.__esModule?a(K,"default",{value:U,enumerable:!0}):K;for(let A of C8(U))if(!Y8.call($,A))a($,A,{get:()=>U[A],enumerable:!0});return $};var z8=(U,J)=>()=>(J||U((J={exports:{}}).exports,J),J.exports);var D8=z8((o8,Q8)=>{var _,c,f,l,g,h,M8,j8;function b8(U){if(U<0.5)U=0.5;var J=Math.exp(0.527076)/U,K=Math.exp(-J),$=Math.exp(-2*J),A=(1-K)*(1-K)/(1+2*J*K-$);return _=A,c=A*(J-1)*K,f=A*(J+1)*K,l=-A*$,g=2*K,h=-$,M8=(_+c)/(1-g-h),j8=(f+l)/(1-g-h),new Float32Array([_,c,f,l,g,h,M8,j8])}function L8(U,J,K,$,A,M){var Z,G,L,j,Q,q,E,D,N,B,V,X,R,C,Y,F,y,S,H,P,w,z,I,O,u,v,W,b,m,T;for(u=0;u<M;u++){z=u*A,I=u,O=0,Z=U[z],G=Z&255,L=Z>>8&255,j=Z>>16&255,Q=Z>>24&255,S=G*$[6],H=L*$[6],P=j*$[6],w=Q*$[6],C=S,Y=H,F=P,y=w,W=$[0],b=$[1],m=$[4],T=$[5];for(v=0;v<A;v++)Z=U[z],q=Z&255,E=Z>>8&255,D=Z>>16&255,N=Z>>24&255,B=q*W+G*b+C*m+S*T,V=E*W+L*b+Y*m+H*T,X=D*W+j*b+F*m+P*T,R=N*W+Q*b+y*m+w*T,S=C,H=Y,P=F,w=y,C=B,Y=V,F=X,y=R,G=q,L=E,j=D,Q=N,K[O]=C,K[O+1]=Y,K[O+2]=F,K[O+3]=y,O+=4,z++;z--,O-=4,I+=M*(A-1),Z=U[z],G=Z&255,L=Z>>8&255,j=Z>>16&255,Q=Z>>24&255,S=G*$[7],H=L*$[7],P=j*$[7],w=Q*$[7],C=S,Y=H,F=P,y=w,q=G,E=L,D=j,N=Q,W=$[2],b=$[3];for(v=A-1;v>=0;v--)B=q*W+G*b+C*m+S*T,V=E*W+L*b+Y*m+H*T,X=D*W+j*b+F*m+P*T,R=N*W+Q*b+y*m+w*T,S=C,H=Y,P=F,w=y,C=B,Y=V,F=X,y=R,G=q,L=E,j=D,Q=N,Z=U[z],q=Z&255,E=Z>>8&255,D=Z>>16&255,N=Z>>24&255,Z=(K[O]+C<<0)+(K[O+1]+Y<<8)+(K[O+2]+F<<16)+(K[O+3]+y<<24),J[I]=Z,z--,O-=4,I-=M}}function m8(U,J,K,$){if(!$)return;var A=new Uint32Array(U.buffer),M=new Uint32Array(A.length),Z=new Float32Array(Math.max(J,K)*4),G=b8($);L8(A,M,Z,G,J,K,$),L8(M,A,Z,G,K,J,$)}Q8.exports=m8});var F8=2;function o(U,J,K,$,A,M){let Z=K/U,G=$/J,L=(2*M+F8+1)/A;if(L>0.5)return[{toWidth:K,toHeight:$}];let j=Math.ceil(Math.log(Math.min(Z,G))/Math.log(L));if(j<=1)return[{toWidth:K,toHeight:$}];let Q=[];for(let q=0;q<j;q++){let E=Math.round(Math.pow(Math.pow(U,j-q-1)*Math.pow(K,q+1),1/j)),D=Math.round(Math.pow(Math.pow(J,j-q-1)*Math.pow($,q+1),1/j));Q.push({toWidth:E,toHeight:D})}return Q}var i=0.00001;function n(U){let J=Math.round(U);if(Math.abs(U-J)<i)return J;return Math.floor(U)}function s(U){let J=Math.round(U);if(Math.abs(U-J)<i)return J;return Math.ceil(U)}function r(U,J,K,$,A,M,Z,G,L,j,Q){let q=$/U,E=A/J,D=n(K*q)-2*M,N=n(K*E)-2*M;if(D<1||N<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let B,V,X,R,C,Y,F=[];for(R=0;R<A;R+=N)for(X=0;X<$;X+=D){if(B=X-M,B<0)B=0;if(C=X+D+M-B,B+C>=$)C=$-B;if(V=R-M,V<0)V=0;if(Y=R+N+M-V,V+Y>=A)Y=A-V;F.push({toX:B,toY:V,toWidth:C,toHeight:Y,toInnerX:X,toInnerY:R,toInnerWidth:D,toInnerHeight:N,offsetX:B/q-n(B/q),offsetY:V/E-n(V/E),scaleX:q,scaleY:E,x:n(B/q),y:n(V/E),width:s(C/q),height:s(Y/E),originalTileSize:Z,filter:G,unsharpAmount:L,unsharpRadius:j,unsharpThreshold:Q,destTileBorder:M})}return F}async function t(U,J,K){let $=await createImageBitmap(U),A=$.width,M=$.height,Z=J/A,G=J/M,L=Math.min(Z,G,1),j=Math.floor(A*L),Q=Math.floor(M*L),q=o(A,M,j,Q,K.srcTileSize,K.destTileBorder),E=r(A,M,K.srcTileSize,j,Q,K.destTileBorder,K.srcTileSize,K.filter,K.unsharpAmount,K.unsharpRadius,K.unsharpThreshold),N=new OffscreenCanvas(A,M).getContext("2d");if(!N)throw new Error("PicSquish: Canvas context is not supported");N.drawImage($,0,0);let B=N.getImageData(0,0,A,M),V=new SharedArrayBuffer(B.data.byteLength);new Uint8ClampedArray(V).set(B.data);let R=j*Q*4,C=new SharedArrayBuffer(R);return{from:V,fromWidth:A,fromHeight:M,to:C,tileTransforms:E,stages:q}}var S8="<WORKER_CODE>",O8=new Blob([S8],{type:"application/javascript"});var e=(()=>{let U=0;return()=>++U})();class U8{#J;#Z;#K;#$;constructor(){this.#J=new Map,this.#Z=new Map,this.#K=new Map,this.#$=new Map}get count(){return this.#J.size}#A(U){clearTimeout(this.#Z.get(U))}#U(U,J,K,$){this.#J.set(U,J.id),this.#K.set(J.id,U),this.#$.set(J.id,J),U.postMessage(K,$),this.#A(U)}assignPriority1Task(U,J){let K={taskId:J.id,squishId:J.squishId,taskType:0,blob:J.data.blob,maxDimension:J.data.maxDimension,tileOptions:J.data.tileOptions};console.log("TASK 1"),this.#U(U,J,K,[])}assignPriority2Task(U,J){let K={taskId:J.id,squishId:J.squishId,taskType:1,tileTransform:J.data.tileTransform,from:J.data.from,fromWidth:J.data.fromWidth,to:J.data.to,toWidth:J.data.toWidth};this.#U(U,J,K,[])}setWorkerTimeout(U,J){let K=setTimeout(()=>{let $=this.#J.get(U);if($)this.#K.delete($);if($)this.#$.delete($);this.#Z.delete(U),this.#J.delete(U),U.terminate()},J);this.#Z.set(U,K)}addWorker(U){this.#J.set(U,null)}getWorker(U){return this.#K.get(U)}getTask(U){return this.#$.get(U)}getAvailableWorker(){for(let[U,J]of this.#J.entries())if(J===null)return U;return null}removeTask(U){let J=this.#K.get(U);if(J)this.#J.set(J,null);this.#K.delete(U),this.#$.delete(U)}}class P8{#J;#Z;#K;#$;#A;#U;constructor(U,J){this.#Z=U,this.#J=J,this.#K=new Map,this.#$=[],this.#A=[],this.#U=new U8}#M(){let U=new Worker(URL.createObjectURL(O8));U.onmessage=(J)=>{let K=this.#K.get(J.data.squishId);if(!K)throw new Error("SquishContext not found");if(J.data.taskType===0){let{squishId:A,error:M,output:Z}=J.data;if(M)K.reject(M);else{K.from=Z.from,K.fromWidth=Z.fromWidth,K.fromHeight=Z.fromHeight,K.to=Z.to,K.toWidth=Z.stages[0].toWidth,K.toHeight=Z.stages[0].toHeight,K.stages=Z.stages,K.remainingTileCount=Z.tileTransforms.length,console.log(Z.tileTransforms);for(let G of Z.tileTransforms)this.#A.push({id:e(),squishId:A,data:{tileTransform:G,from:K.from,fromWidth:K.fromWidth,to:K.to,toWidth:K.toWidth}})}}if(J.data.taskType===1){let{error:A}=J.data;if(A)K.reject(A);else if(K.remainingTileCount--,!K.remainingTileCount){if(!K.to)throw new Error("SquishContext to not found");I8(K.to,K.toWidth,K.toHeight).then((M)=>{K.resolve(M)})}}let $=this.#U.getWorker(J.data.taskId);if($)this.#U.setWorkerTimeout($,this.#J);this.#U.removeTask(J.data.taskId),this.#G()},U.onerror=(J)=>{console.log(J.message),console.log(J)},this.#U.addWorker(U)}#G(){let U=this.#U.getAvailableWorker();if(U){let J=this.#$.shift();if(J)return this.#U.assignPriority1Task(U,J);let K=this.#A.shift();if(K)return this.#U.assignPriority2Task(U,K)}else if(this.#U.count<this.#Z)this.#M(),this.#G()}add(U){return new Promise((J,K)=>{let $=e();this.#K.set($,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:J,reject:K}),this.#$.push({id:$,squishId:$,data:U}),this.#G()})}}async function I8(U,J,K){let $=new Uint8ClampedArray(U),A=new Uint8ClampedArray($),M=new ImageData(A,J,K);return await createImageBitmap(M)}var p={box:{win:0.5,fn:(U)=>{if(U<0)U=-U;return U<0.5?1:0}},hamming:{win:1,fn:(U)=>{if(U<0)U=-U;if(U>=1)return 0;if(U<0.00000011920929)return 1;let J=U*Math.PI;return Math.sin(J)/J*(0.54+0.46*Math.cos(J/1))}},lanczos2:{win:2,fn:(U)=>{if(U<0)U=-U;if(U>=2)return 0;if(U<0.00000011920929)return 1;let J=U*Math.PI;return Math.sin(J)/J*Math.sin(J/2)/(J/2)}},lanczos3:{win:3,fn:(U)=>{if(U<0)U=-U;if(U>=3)return 0;if(U<0.00000011920929)return 1;let J=U*Math.PI;return Math.sin(J)/J*Math.sin(J/3)/(J/3)}},mks2013:{win:2.5,fn:(U)=>{if(U<0)U=-U;if(U>=2.5)return 0;if(U>=1.5)return-0.125*(U-2.5)*(U-2.5);if(U>=0.5)return 0.25*(4*U*U-11*U+7);return 1.0625-1.75*U*U}}};var H8=14;function J8(U){return Math.round(U*((1<<H8)-1))}function d(U,J,K,$,A){let M=p[U].fn,Z=1/$,G=Math.min(1,$),L=p[U].win/G,j,Q,q,E,D,N,B,V,X,R,C,Y,F,y,S,H,P,w=Math.floor((L+1)*2),z=new Int16Array((w+2)*K),I=0,O=!z.subarray||!z.set;for(j=0;j<K;j++){Q=(j+0.5)*Z+A,q=Math.max(0,Math.floor(Q-L)),E=Math.min(J-1,Math.ceil(Q+L)),D=E-q+1,N=new Float32Array(D),B=new Int16Array(D),V=0;for(X=q,R=0;X<=E;X++,R++)C=M((X+0.5-Q)*G),V+=C,N[R]=C;Y=0;for(R=0;R<N.length;R++)F=N[R]/V,Y+=F,B[R]=J8(F);B[K>>1]+=J8(1-Y),y=0;while(y<B.length&&B[y]===0)y++;if(y<B.length){S=B.length-1;while(S>0&&B[S]===0)S--;if(H=q+y,P=S-y+1,z[I++]=H,z[I++]=P,!O)z.set(B.subarray(y,S+1),I),I+=P;else for(R=y;R<=S;R++)z[I++]=B[R]}else z[I++]=0,z[I++]=0}return z}function x(U){return U<0?0:U>255?255:U}function k(U){return U>=0?U:0}function K8(U,J,K,$,A,M){let Z,G,L,j,Q,q,E,D,N,B,V,X=0,R=0;for(N=0;N<$;N++){Q=0;for(B=0;B<A;B++){q=M[Q++],E=M[Q++],D=X+q*4|0,Z=G=L=j=0;for(;E>0;E--)V=M[Q++],j=j+V*U[D+3]|0,L=L+V*U[D+2]|0,G=G+V*U[D+1]|0,Z=Z+V*U[D]|0,D=D+4|0;J[R+3]=k(j>>7),J[R+2]=k(L>>7),J[R+1]=k(G>>7),J[R]=k(Z>>7),R=R+$*4|0}R=(N+1)*4|0,X=(N+1)*K*4|0}}function $8(U,J,K,$,A,M){let Z,G,L,j,Q,q,E,D,N,B,V,X=0,R=0;for(N=0;N<$;N++){Q=0;for(B=0;B<A;B++){q=M[Q++],E=M[Q++],D=X+q*4|0,Z=G=L=j=0;for(;E>0;E--)V=M[Q++],j=j+V*U[D+3]|0,L=L+V*U[D+2]|0,G=G+V*U[D+1]|0,Z=Z+V*U[D]|0,D=D+4|0;Z>>=7,G>>=7,L>>=7,j>>=7,J[R+3]=x(j+8192>>14),J[R+2]=x(L+8192>>14),J[R+1]=x(G+8192>>14),J[R]=x(Z+8192>>14),R=R+$*4|0}R=(N+1)*4|0,X=(N+1)*K*4|0}}function Z8(U,J,K,$,A,M){let Z,G,L,j,Q,q,E,D,N,B,V,X,R=0,C=0;for(B=0;B<$;B++){q=0;for(V=0;V<A;V++){E=M[q++],D=M[q++],N=R+E*4|0,Z=G=L=j=0;for(;D>0;D--)X=M[q++],Q=U[N+3],j=j+X*Q|0,L=L+X*U[N+2]*Q|0,G=G+X*U[N+1]*Q|0,Z=Z+X*U[N]*Q|0,N=N+4|0;L=L/255|0,G=G/255|0,Z=Z/255|0,J[C+3]=k(j>>7),J[C+2]=k(L>>7),J[C+1]=k(G>>7),J[C]=k(Z>>7),C=C+$*4|0}C=(B+1)*4|0,R=(B+1)*K*4|0}}function A8(U,J,K,$,A,M){let Z,G,L,j,Q,q,E,D,N,B,V,X=0,R=0;for(N=0;N<$;N++){Q=0;for(B=0;B<A;B++){q=M[Q++],E=M[Q++],D=X+q*4|0,Z=G=L=j=0;for(;E>0;E--)V=M[Q++],j=j+V*U[D+3]|0,L=L+V*U[D+2]|0,G=G+V*U[D+1]|0,Z=Z+V*U[D]|0,D=D+4|0;if(Z>>=7,G>>=7,L>>=7,j>>=7,j=x(j+8192>>14),j>0)Z=Z*255/j|0,G=G*255/j|0,L=L*255/j|0;J[R+3]=j,J[R+2]=x(L+8192>>14),J[R+1]=x(G+8192>>14),J[R]=x(Z+8192>>14),R=R+$*4|0}R=(N+1)*4|0,X=(N+1)*K*4|0}}function w8(U,J,K){let $=3,A=J*K*4|0;while($<A){if(U[$]!==255)return!0;$=$+4|0}return!1}function W8(U,J,K){let $=3,A=J*K*4|0;while($<A)U[$]=255,$=$+4|0}function G8(U,J,K,$,A,M,Z,G,L,j){let Q=d(J,K,A,Z,L),q=d(J,$,M,G,j),E=new Uint8Array(A*M*4),D=new Uint16Array(A*$*4);if(w8(U,K,$))Z8(U,D,K,$,A,Q),A8(D,E,$,A,M,q);else K8(U,D,K,$,A,Q),$8(D,E,$,A,M,q),W8(E,A,M);return E}var R8=y8(D8(),1);function T8(U,J,K){let $=J*K,A=new Uint16Array($),M,Z,G,L;for(let j=0;j<$;j++)M=U[4*j],Z=U[4*j+1],G=U[4*j+2],L=M>=Z&&M>=G?M:Z>=G&&Z>=M?Z:G,A[j]=L<<8;return A}function q8(U,J,K,$,A,M){let Z,G,L,j,Q;if($===0||A<0.5)return;if(A>2)A=2;let q=T8(U,J,K),E=new Uint16Array(q);R8.default(E,J,K,A);let D=$/100*4096+0.5|0,N=M<<8,B=J*K;for(let V=0;V<B;V++)if(Z=q[V],j=Z-E[V],Math.abs(j)>=N)G=Z+(D*j+2048>>12),G=G>65280?65280:G,G=G<0?0:G,Z=Z!==0?Z:1,L=(G<<12)/Z|0,Q=V*4,U[Q]=U[Q]*L+2048>>12,U[Q+1]=U[Q+1]*L+2048>>12,U[Q+2]=U[Q+2]*L+2048>>12}function V8(U,J){let K=G8(U,J.filter,J.width,J.height,J.toWidth,J.toHeight,J.scaleX,J.scaleY,J.offsetX,J.offsetY);if(J.unsharpAmount)q8(K,J.toWidth,J.toHeight,J.unsharpAmount,J.unsharpRadius,J.unsharpThreshold);return K}function N8(U,J,K,$){let M=new Uint8ClampedArray(U);for(let Z=0;Z<K.toHeight;Z++){let G=Z*K.toWidth*4,L=((K.toY+Z)*J+K.toX)*4;M.set($.subarray(G,G+K.toWidth*4),L)}}function B8(U,J,K){let A=new Uint8ClampedArray(U),M=new Uint8ClampedArray(K.width*K.height*4);for(let Z=0;Z<K.height;Z++){let G=((K.y+Z)*J+K.x)*4,L=Z*K.width*4;M.set(A.subarray(G,G+K.width*4),L)}return M}self.onmessage=async(U)=>{let{taskId:J,squishId:K,taskType:$}=U.data;try{if($===0){let{blob:A,maxDimension:M,tileOptions:Z}=U.data,G=await t(A,M,Z),L={taskId:J,squishId:K,taskType:$,output:{from:G.from,fromWidth:G.fromWidth,fromHeight:G.fromHeight,to:G.to,tileTransforms:G.tileTransforms,stages:G.stages}};self.postMessage(L)}if($===1){let{tileTransform:A,from:M,fromWidth:Z,to:G,toWidth:L}=U.data,j=B8(M,Z,A),Q=V8(j,A);N8(G,L,A,Q);let q={taskId:J,squishId:K,taskType:$};self.postMessage(q)}}catch(A){self.postMessage({taskId:J,error:A})}};
`,W=new Blob([I],{type:"application/javascript"});var O=(()=>{let G=0;return()=>++G})();class H{#G;#K;#V;#$;constructor(){this.#G=new Map,this.#K=new Map,this.#V=new Map,this.#$=new Map}get count(){return this.#G.size}#U(G){clearTimeout(this.#K.get(G))}#J(G,J,K,V){this.#G.set(G,J.id),this.#V.set(J.id,G),this.#$.set(J.id,J),G.postMessage(K,V),this.#U(G)}assignPriority1Task(G,J){let K={taskId:J.id,squishId:J.squishId,taskType:0,blob:J.data.blob,maxDimension:J.data.maxDimension,tileOptions:J.data.tileOptions};console.log("TASK 1"),this.#J(G,J,K,[])}assignPriority2Task(G,J){let K={taskId:J.id,squishId:J.squishId,taskType:1,tileTransform:J.data.tileTransform,from:J.data.from,fromWidth:J.data.fromWidth,to:J.data.to,toWidth:J.data.toWidth};this.#J(G,J,K,[])}setWorkerTimeout(G,J){let K=setTimeout(()=>{let V=this.#G.get(G);if(V)this.#V.delete(V);if(V)this.#$.delete(V);this.#K.delete(G),this.#G.delete(G),G.terminate()},J);this.#K.set(G,K)}addWorker(G){this.#G.set(G,null)}getWorker(G){return this.#V.get(G)}getTask(G){return this.#$.get(G)}getAvailableWorker(){for(let[G,J]of this.#G.entries())if(J===null)return G;return null}removeTask(G){let J=this.#V.get(G);if(J)this.#G.set(J,null);this.#V.delete(G),this.#$.delete(G)}}class P{#G;#K;#V;#$;#U;#J;constructor(G,J){this.#K=G,this.#G=J,this.#V=new Map,this.#$=[],this.#U=[],this.#J=new H}#j(){let G=new Worker(URL.createObjectURL(W));G.onmessage=(J)=>{let K=this.#V.get(J.data.squishId);if(!K)throw new Error("SquishContext not found");if(J.data.taskType===0){let{squishId:U,error:$,output:Z}=J.data;if($)K.reject($);else{K.from=Z.from,K.fromWidth=Z.fromWidth,K.fromHeight=Z.fromHeight,K.to=Z.to,K.toWidth=Z.stages[0].toWidth,K.toHeight=Z.stages[0].toHeight,K.stages=Z.stages,K.remainingTileCount=Z.tileTransforms.length,console.log(Z.tileTransforms);for(let E of Z.tileTransforms)this.#U.push({id:O(),squishId:U,data:{tileTransform:E,from:K.from,fromWidth:K.fromWidth,to:K.to,toWidth:K.toWidth}})}}if(J.data.taskType===1){let{error:U}=J.data;if(U)K.reject(U);else if(K.remainingTileCount--,!K.remainingTileCount){if(!K.to)throw new Error("SquishContext to not found");c(K.to,K.toWidth,K.toHeight).then(($)=>{K.resolve($)})}}let V=this.#J.getWorker(J.data.taskId);if(V)this.#J.setWorkerTimeout(V,this.#G);this.#J.removeTask(J.data.taskId),this.#Z()},G.onerror=(J)=>{console.log(J.message),console.log(J)},this.#J.addWorker(G)}#Z(){let G=this.#J.getAvailableWorker();if(G){let J=this.#$.shift();if(J)return this.#J.assignPriority1Task(G,J);let K=this.#U.shift();if(K)return this.#J.assignPriority2Task(G,K)}else if(this.#J.count<this.#K)this.#j(),this.#Z()}add(G){return new Promise((J,K)=>{let V=O();this.#V.set(V,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:J,reject:K}),this.#$.push({id:V,squishId:V,data:G}),this.#Z()})}}async function c(G,J,K){let V=new Uint8ClampedArray(G),U=new Uint8ClampedArray(V),$=new ImageData(U,J,K);return await createImageBitmap($)}function w(){return typeof SharedArrayBuffer==="function"&&self.crossOriginIsolated===!0}class x{#G;#K;constructor(G){let J=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,K=G.maxWorkerPoolSize||Math.min(J,4),V=G.maxWorkerIdleTime||1e4;this.#G=new P(K,V),this.#K=G}async squish(G,J){console.log("SAB",w());let K=J?{...this.#K,...J}:this.#K,V=K.maxDimension,U=K.srcTileSize||1024,$=K.filter||"mks2013",Z=K.unsharpAmount||0,E=K.unsharpRadius||0,M=K.unsharpThreshold||0,L=K.useMainThread,j=Math.ceil(Math.max(3,2.5*E|0)),N={srcTileSize:U,filter:$,unsharpAmount:Z,unsharpRadius:E,unsharpThreshold:M,destTileBorder:j};if(L){let F=await C(G,V,N);return console.log("here"),console.log(F),F}return this.#G.add({blob:G,maxDimension:V,tileOptions:N})}}export{x as PicSquish};
