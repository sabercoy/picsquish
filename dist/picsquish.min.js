var wk=Object.create;var{getPrototypeOf:Ok,defineProperty:l,getOwnPropertyNames:Ek}=Object;var Vk=Object.prototype.hasOwnProperty;var Nk=(k,M,U)=>{U=k!=null?wk(Ok(k)):{};let Q=M||!k||!k.__esModule?l(U,"default",{value:k,enumerable:!0}):U;for(let $ of Ek(k))if(!Vk.call(Q,$))l(Q,$,{get:()=>k[$],enumerable:!0});return Q};var mk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Zk=mk((lk,Rk)=>{var d,a,s,f,h,p,Ik,Jk;function Dk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,U=Math.exp(-M),Q=Math.exp(-2*M),$=(1-U)*(1-U)/(1+2*M*U-Q);return d=$,a=$*(M-1)*U,s=$*(M+1)*U,f=-$*Q,h=2*U,p=-Q,Ik=(d+a)/(1-h-p),Jk=(s+f)/(1-h-p),new Float32Array([d,a,s,f,h,p,Ik,Jk])}function $k(k,M,U,Q,$,Z){var C,K,J,q,I,j,A,R,G,B,n,y,L,w,N,m,O,V,Y,T,D,E,X,z,v,u,W,F,S,P;for(v=0;v<Z;v++){E=v*$,X=v,z=0,C=k[E],K=C&255,J=C>>8&255,q=C>>16&255,I=C>>24&255,V=K*Q[6],Y=J*Q[6],T=q*Q[6],D=I*Q[6],w=V,N=Y,m=T,O=D,W=Q[0],F=Q[1],S=Q[4],P=Q[5];for(u=0;u<$;u++)C=k[E],j=C&255,A=C>>8&255,R=C>>16&255,G=C>>24&255,B=j*W+K*F+w*S+V*P,n=A*W+J*F+N*S+Y*P,y=R*W+q*F+m*S+T*P,L=G*W+I*F+O*S+D*P,V=w,Y=N,T=m,D=O,w=B,N=n,m=y,O=L,K=j,J=A,q=R,I=G,U[z]=w,U[z+1]=N,U[z+2]=m,U[z+3]=O,z+=4,E++;E--,z-=4,X+=Z*($-1),C=k[E],K=C&255,J=C>>8&255,q=C>>16&255,I=C>>24&255,V=K*Q[7],Y=J*Q[7],T=q*Q[7],D=I*Q[7],w=V,N=Y,m=T,O=D,j=K,A=J,R=q,G=I,W=Q[2],F=Q[3];for(u=$-1;u>=0;u--)B=j*W+K*F+w*S+V*P,n=A*W+J*F+N*S+Y*P,y=R*W+q*F+m*S+T*P,L=G*W+I*F+O*S+D*P,V=w,Y=N,T=m,D=O,w=B,N=n,m=y,O=L,K=j,J=A,q=R,I=G,C=k[E],j=C&255,A=C>>8&255,R=C>>16&255,G=C>>24&255,C=(U[z]+w<<0)+(U[z+1]+N<<8)+(U[z+2]+m<<16)+(U[z+3]+O<<24),M[X]=C,E--,z-=4,X-=Z}}function Wk(k,M,U,Q){if(!Q)return;var $=new Uint32Array(k.buffer),Z=new Uint32Array($.length),C=new Float32Array(Math.max(M,U)*4),K=Dk(Q);$k($,Z,C,K,M,U,Q),$k(Z,$,C,K,U,M,Q)}Rk.exports=Wk});var zk=2;function _(k,M,U,Q,$,Z){let C=U/k,K=Q/M,J=(2*Z+zk+1)/$;if(J>0.5)return[{toWidth:U,toHeight:Q}];let q=Math.ceil(Math.log(Math.min(C,K))/Math.log(J));if(q<=1)return[{toWidth:U,toHeight:Q}];let I=[];for(let j=0;j<q;j++){let A=Math.round(Math.pow(Math.pow(k,q-j-1)*Math.pow(U,j+1),1/q)),R=Math.round(Math.pow(Math.pow(M,q-j-1)*Math.pow(Q,j+1),1/q));I.push({toWidth:A,toHeight:R})}return I}var r=0.00001;function x(k){let M=Math.round(k);if(Math.abs(k-M)<r)return M;return Math.floor(k)}function i(k){let M=Math.round(k);if(Math.abs(k-M)<r)return M;return Math.ceil(k)}function t(k,M,U,Q,$,Z){let C=Q/k,K=$/M,J=x(U*C)-2*Z,q=x(U*K)-2*Z;if(J<1||q<1)throw new Error("Internal error in pica: target tile width/height is too small.");let I,j,A,R,G,B,n=[];for(R=0;R<$;R+=q)for(A=0;A<Q;A+=J){if(I=A-Z,I<0)I=0;if(G=A+J+Z-I,I+G>=Q)G=Q-I;if(j=R-Z,j<0)j=0;if(B=R+q+Z-j,j+B>=$)B=$-j;n.push({toX:I,toY:j,toWidth:G,toHeight:B,toInnerX:A,toInnerY:R,toInnerWidth:J,toInnerHeight:q,offsetX:I/C-x(I/C),offsetY:j/K-x(j/K),scaleX:C,scaleY:K,x:x(I/C),y:x(j/K),width:i(G/C),height:i(B/K)})}return n}function e(k,M){let Q=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!Q)throw new Error("Pica: Canvas context is not supported");return Q.globalCompositeOperation="copy",Q.drawImage(M,k.x,k.y,k.width,k.height,0,0,k.width,k.height),Q.getImageData(0,0,k.width,k.height).data}function kk(k,M,U){let Q=new ImageData(new Uint8ClampedArray(M),k.toWidth,k.toHeight),$=!1;U.putImageData(Q,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth,k.toInnerHeight)}var g={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Tk=14;function Mk(k){return Math.round(k*((1<<Tk)-1))}function o(k,M,U,Q,$){let Z=g[k].fn,C=1/Q,K=Math.min(1,Q),J=g[k].win/K,q,I,j,A,R,G,B,n,y,L,w,N,m,O,V,Y,T,D=Math.floor((J+1)*2),E=new Int16Array((D+2)*U),X=0,z=!E.subarray||!E.set;for(q=0;q<U;q++){I=(q+0.5)*C+$,j=Math.max(0,Math.floor(I-J)),A=Math.min(M-1,Math.ceil(I+J)),R=A-j+1,G=new Float32Array(R),B=new Int16Array(R),n=0;for(y=j,L=0;y<=A;y++,L++)w=Z((y+0.5-I)*K),n+=w,G[L]=w;N=0;for(L=0;L<G.length;L++)m=G[L]/n,N+=m,B[L]=Mk(m);B[U>>1]+=Mk(1-N),O=0;while(O<B.length&&B[O]===0)O++;if(O<B.length){V=B.length-1;while(V>0&&B[V]===0)V--;if(Y=j+O,T=V-O+1,E[X++]=Y,E[X++]=T,!z)E.set(B.subarray(O,V+1),X),X+=T;else for(L=O;L<=V;L++)E[X++]=B[L]}else E[X++]=0,E[X++]=0}return E}function H(k){return k<0?0:k>255?255:k}function b(k){return k>=0?k:0}function Qk(k,M,U,Q,$,Z){let C,K,J,q,I,j,A,R,G,B,n,y=0,L=0;for(G=0;G<Q;G++){I=0;for(B=0;B<$;B++){j=Z[I++],A=Z[I++],R=y+j*4|0,C=K=J=q=0;for(;A>0;A--)n=Z[I++],q=q+n*k[R+3]|0,J=J+n*k[R+2]|0,K=K+n*k[R+1]|0,C=C+n*k[R]|0,R=R+4|0;M[L+3]=b(q>>7),M[L+2]=b(J>>7),M[L+1]=b(K>>7),M[L]=b(C>>7),L=L+Q*4|0}L=(G+1)*4|0,y=(G+1)*U*4|0}}function Ck(k,M,U,Q,$,Z){let C,K,J,q,I,j,A,R,G,B,n,y=0,L=0;for(G=0;G<Q;G++){I=0;for(B=0;B<$;B++){j=Z[I++],A=Z[I++],R=y+j*4|0,C=K=J=q=0;for(;A>0;A--)n=Z[I++],q=q+n*k[R+3]|0,J=J+n*k[R+2]|0,K=K+n*k[R+1]|0,C=C+n*k[R]|0,R=R+4|0;C>>=7,K>>=7,J>>=7,q>>=7,M[L+3]=H(q+8192>>14),M[L+2]=H(J+8192>>14),M[L+1]=H(K+8192>>14),M[L]=H(C+8192>>14),L=L+Q*4|0}L=(G+1)*4|0,y=(G+1)*U*4|0}}function Uk(k,M,U,Q,$,Z){let C,K,J,q,I,j,A,R,G,B,n,y,L=0,w=0;for(B=0;B<Q;B++){j=0;for(n=0;n<$;n++){A=Z[j++],R=Z[j++],G=L+A*4|0,C=K=J=q=0;for(;R>0;R--)y=Z[j++],I=k[G+3],q=q+y*I|0,J=J+y*k[G+2]*I|0,K=K+y*k[G+1]*I|0,C=C+y*k[G]*I|0,G=G+4|0;J=J/255|0,K=K/255|0,C=C/255|0,M[w+3]=b(q>>7),M[w+2]=b(J>>7),M[w+1]=b(K>>7),M[w]=b(C>>7),w=w+Q*4|0}w=(B+1)*4|0,L=(B+1)*U*4|0}}function qk(k,M,U,Q,$,Z){let C,K,J,q,I,j,A,R,G,B,n,y=0,L=0;for(G=0;G<Q;G++){I=0;for(B=0;B<$;B++){j=Z[I++],A=Z[I++],R=y+j*4|0,C=K=J=q=0;for(;A>0;A--)n=Z[I++],q=q+n*k[R+3]|0,J=J+n*k[R+2]|0,K=K+n*k[R+1]|0,C=C+n*k[R]|0,R=R+4|0;if(C>>=7,K>>=7,J>>=7,q>>=7,q=H(q+8192>>14),q>0)C=C*255/q|0,K=K*255/q|0,J=J*255/q|0;M[L+3]=q,M[L+2]=H(J+8192>>14),M[L+1]=H(K+8192>>14),M[L]=H(C+8192>>14),L=L+Q*4|0}L=(G+1)*4|0,y=(G+1)*U*4|0}}function Xk(k,M,U){let Q=3,$=M*U*4|0;while(Q<$){if(k[Q]!==255)return!0;Q=Q+4|0}return!1}function Yk(k,M,U){let Q=3,$=M*U*4|0;while(Q<$)k[Q]=255,Q=Q+4|0}function Kk(k,M,U,Q,$,Z,C,K,J,q){let I=o(k,U,$,C,J),j=o(k,Q,Z,K,q),A=new Uint8Array($*Z*4),R=new Uint16Array($*Q*4);if(Xk(M,U,Q))Uk(M,R,U,Q,$,I),qk(R,A,Q,$,Z,j);else Qk(M,R,U,Q,$,I),Ck(R,A,Q,$,Z,j),Yk(A,$,Z);return A}var jk=Nk(Zk(),1);function Fk(k,M,U){let Q=M*U,$=new Uint16Array(Q),Z,C,K,J;for(let q=0;q<Q;q++)Z=k[4*q],C=k[4*q+1],K=k[4*q+2],J=Z>=C&&Z>=K?Z:C>=K&&C>=Z?C:K,$[q]=J<<8;return $}function Gk(k,M,U,Q,$,Z){let C,K,J,q,I;if(Q===0||$<0.5)return;if($>2)$=2;let j=Fk(k,M,U),A=new Uint16Array(j);jk.default(A,M,U,$);let R=Q/100*4096+0.5|0,G=Z<<8,B=M*U;for(let n=0;n<B;n++)if(C=j[n],q=C-A[n],Math.abs(q)>=G)K=C+(R*q+2048>>12),K=K>65280?65280:K,K=K<0?0:K,C=C!==0?C:1,J=(K<<12)/C|0,I=n*4,k[I]=k[I]*J+2048>>12,k[I+1]=k[I+1]*J+2048>>12,k[I+2]=k[I+2]*J+2048>>12}function Ak(k,M,U,Q,$,Z,C,K,J,q,I,j,A){let R=Kk(k,M,U,Q,$,Z,C,K,J,q);if(I)Gk(R,$,Z,I,j,A);return R}var Lk=(k,M,U,Q,$,Z,C)=>{let K=e(k,M),J=Ak(U,K,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY,Q,$,Z);kk(k,J,C)};async function Bk(k,M,U,Q,$,Z,C,K){let J=M,q=new OffscreenCanvas(k[0].toWidth,k[0].toHeight);for(let I=0;I<k.length;I++){let j=q.getContext("2d");if(!j)throw new Error("Pica: Canvas context is not supported");let A=t(J.width,J.height,U,q.width,q.height,Q);for(let G of A)Lk(G,J,$,Z,C,K,j);let R=k[I+1];if(!R)break;J=q,q=new OffscreenCanvas(R.toWidth,R.toHeight)}return q}async function nk(k,M){let U=M.maxDimension,Q=M.tileSize||1024,$=M.filter||"mks2013",Z=M.unsharpAmount||0,C=M.unsharpRadius||0,K=M.unsharpThreshold||0,J=await createImageBitmap(k),q=J.width,I=J.height,j=U/q,A=U/I,R=Math.min(j,A,1),G=Math.floor(q*R),B=Math.floor(I*R),n=3,y=Math.ceil(Math.max(3,2.5*C|0)),L=_(q,I,G,B,Q,y);return(await Bk(L,J,Q,y,$,Z,C,K)).transferToImageBitmap()}var Sk=`
var y0=Object.create;var{getPrototypeOf:E0,defineProperty:_,getOwnPropertyNames:V0}=Object;var N0=Object.prototype.hasOwnProperty;var w0=(M,U,Q)=>{Q=M!=null?y0(E0(M)):{};let C=U||!M||!M.__esModule?_(Q,"default",{value:M,enumerable:!0}):Q;for(let Z of V0(M))if(!N0.call(C,Z))_(C,Z,{get:()=>M[Z],enumerable:!0});return C};var O0=(M,U)=>()=>(U||M((U={exports:{}}).exports,U),U.exports);var j0=O0((d0,G0)=>{var f,o,a,c,h,g,Q0,$0;function F0(M){if(M<0.5)M=0.5;var U=Math.exp(0.527076)/M,Q=Math.exp(-U),C=Math.exp(-2*U),Z=(1-Q)*(1-Q)/(1+2*U*Q-C);return f=Z,o=Z*(U-1)*Q,a=Z*(U+1)*Q,c=-Z*C,h=2*Q,g=-C,Q0=(f+o)/(1-h-g),$0=(a+c)/(1-h-g),new Float32Array([f,o,a,c,h,g,Q0,$0])}function Z0(M,U,Q,C,Z,L){var q,K,G,J,$,A,I,j,R,B,y,E,k,V,X,z,N,O,S,D,P,w,F,Y,v,x,m,H,W,T;for(v=0;v<L;v++){w=v*Z,F=v,Y=0,q=M[w],K=q&255,G=q>>8&255,J=q>>16&255,$=q>>24&255,O=K*C[6],S=G*C[6],D=J*C[6],P=$*C[6],V=O,X=S,z=D,N=P,m=C[0],H=C[1],W=C[4],T=C[5];for(x=0;x<Z;x++)q=M[w],A=q&255,I=q>>8&255,j=q>>16&255,R=q>>24&255,B=A*m+K*H+V*W+O*T,y=I*m+G*H+X*W+S*T,E=j*m+J*H+z*W+D*T,k=R*m+$*H+N*W+P*T,O=V,S=X,D=z,P=N,V=B,X=y,z=E,N=k,K=A,G=I,J=j,$=R,Q[Y]=V,Q[Y+1]=X,Q[Y+2]=z,Q[Y+3]=N,Y+=4,w++;w--,Y-=4,F+=L*(Z-1),q=M[w],K=q&255,G=q>>8&255,J=q>>16&255,$=q>>24&255,O=K*C[7],S=G*C[7],D=J*C[7],P=$*C[7],V=O,X=S,z=D,N=P,A=K,I=G,j=J,R=$,m=C[2],H=C[3];for(x=Z-1;x>=0;x--)B=A*m+K*H+V*W+O*T,y=I*m+G*H+X*W+S*T,E=j*m+J*H+z*W+D*T,k=R*m+$*H+N*W+P*T,O=V,S=X,D=z,P=N,V=B,X=y,z=E,N=k,K=A,G=I,J=j,$=R,q=M[w],A=q&255,I=q>>8&255,j=q>>16&255,R=q>>24&255,q=(Q[Y]+V<<0)+(Q[Y+1]+X<<8)+(Q[Y+2]+z<<16)+(Q[Y+3]+N<<24),U[F]=q,w--,Y-=4,F-=L}}function S0(M,U,Q,C){if(!C)return;var Z=new Uint32Array(M.buffer),L=new Uint32Array(Z.length),q=new Float32Array(Math.max(U,Q)*4),K=F0(C);Z0(Z,L,q,K,U,Q,C),Z0(L,Z,q,K,Q,U,C)}G0.exports=S0});var X0=2;function l(M,U,Q,C,Z,L){let q=Q/M,K=C/U,G=(2*L+X0+1)/Z;if(G>0.5)return[{toWidth:Q,toHeight:C}];let J=Math.ceil(Math.log(Math.min(q,K))/Math.log(G));if(J<=1)return[{toWidth:Q,toHeight:C}];let $=[];for(let A=0;A<J;A++){let I=Math.round(Math.pow(Math.pow(M,J-A-1)*Math.pow(Q,A+1),1/J)),j=Math.round(Math.pow(Math.pow(U,J-A-1)*Math.pow(C,A+1),1/J));$.push({toWidth:I,toHeight:j})}return $}var i=0.00001;function u(M){let U=Math.round(M);if(Math.abs(M-U)<i)return U;return Math.floor(M)}function s(M){let U=Math.round(M);if(Math.abs(M-U)<i)return U;return Math.ceil(M)}function r(M,U,Q,C,Z,L){let q=C/M,K=Z/U,G=u(Q*q)-2*L,J=u(Q*K)-2*L;if(G<1||J<1)throw new Error("Internal error in pica: target tile width/height is too small.");let $,A,I,j,R,B,y=[];for(j=0;j<Z;j+=J)for(I=0;I<C;I+=G){if($=I-L,$<0)$=0;if(R=I+G+L-$,$+R>=C)R=C-$;if(A=j-L,A<0)A=0;if(B=j+J+L-A,A+B>=Z)B=Z-A;y.push({toX:$,toY:A,toWidth:R,toHeight:B,toInnerX:I,toInnerY:j,toInnerWidth:G,toInnerHeight:J,offsetX:$/q-u($/q),offsetY:A/K-u(A/K),scaleX:q,scaleY:K,x:u($/q),y:u(A/K),width:s(R/q),height:s(B/K)})}return y}function t(M,U){let C=new OffscreenCanvas(M.width,M.height).getContext("2d");if(!C)throw new Error("Pica: Canvas context is not supported");return C.globalCompositeOperation="copy",C.drawImage(U,M.x,M.y,M.width,M.height,0,0,M.width,M.height),C.getImageData(0,0,M.width,M.height).data}function e(M,U,Q){let C=new ImageData(new Uint8ClampedArray(U),M.toWidth,M.toHeight),Z=!1;Q.putImageData(C,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth,M.toInnerHeight)}var p={box:{win:0.5,fn:(M)=>{if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:(M)=>{if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*(0.54+0.46*Math.cos(U/1))}},lanczos2:{win:2,fn:(M)=>{if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/2)/(U/2)}},lanczos3:{win:3,fn:(M)=>{if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/3)/(U/3)}},mks2013:{win:2.5,fn:(M)=>{if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var z0=14;function M0(M){return Math.round(M*((1<<z0)-1))}function d(M,U,Q,C,Z){let L=p[M].fn,q=1/C,K=Math.min(1,C),G=p[M].win/K,J,$,A,I,j,R,B,y,E,k,V,X,z,N,O,S,D,P=Math.floor((G+1)*2),w=new Int16Array((P+2)*Q),F=0,Y=!w.subarray||!w.set;for(J=0;J<Q;J++){$=(J+0.5)*q+Z,A=Math.max(0,Math.floor($-G)),I=Math.min(U-1,Math.ceil($+G)),j=I-A+1,R=new Float32Array(j),B=new Int16Array(j),y=0;for(E=A,k=0;E<=I;E++,k++)V=L((E+0.5-$)*K),y+=V,R[k]=V;X=0;for(k=0;k<R.length;k++)z=R[k]/y,X+=z,B[k]=M0(z);B[Q>>1]+=M0(1-X),N=0;while(N<B.length&&B[N]===0)N++;if(N<B.length){O=B.length-1;while(O>0&&B[O]===0)O--;if(S=A+N,D=O-N+1,w[F++]=S,w[F++]=D,!Y)w.set(B.subarray(N,O+1),F),F+=D;else for(k=N;k<=O;k++)w[F++]=B[k]}else w[F++]=0,w[F++]=0}return w}function b(M){return M<0?0:M>255?255:M}function n(M){return M>=0?M:0}function U0(M,U,Q,C,Z,L){let q,K,G,J,$,A,I,j,R,B,y,E=0,k=0;for(R=0;R<C;R++){$=0;for(B=0;B<Z;B++){A=L[$++],I=L[$++],j=E+A*4|0,q=K=G=J=0;for(;I>0;I--)y=L[$++],J=J+y*M[j+3]|0,G=G+y*M[j+2]|0,K=K+y*M[j+1]|0,q=q+y*M[j]|0,j=j+4|0;U[k+3]=n(J>>7),U[k+2]=n(G>>7),U[k+1]=n(K>>7),U[k]=n(q>>7),k=k+C*4|0}k=(R+1)*4|0,E=(R+1)*Q*4|0}}function C0(M,U,Q,C,Z,L){let q,K,G,J,$,A,I,j,R,B,y,E=0,k=0;for(R=0;R<C;R++){$=0;for(B=0;B<Z;B++){A=L[$++],I=L[$++],j=E+A*4|0,q=K=G=J=0;for(;I>0;I--)y=L[$++],J=J+y*M[j+3]|0,G=G+y*M[j+2]|0,K=K+y*M[j+1]|0,q=q+y*M[j]|0,j=j+4|0;q>>=7,K>>=7,G>>=7,J>>=7,U[k+3]=b(J+8192>>14),U[k+2]=b(G+8192>>14),U[k+1]=b(K+8192>>14),U[k]=b(q+8192>>14),k=k+C*4|0}k=(R+1)*4|0,E=(R+1)*Q*4|0}}function q0(M,U,Q,C,Z,L){let q,K,G,J,$,A,I,j,R,B,y,E,k=0,V=0;for(B=0;B<C;B++){A=0;for(y=0;y<Z;y++){I=L[A++],j=L[A++],R=k+I*4|0,q=K=G=J=0;for(;j>0;j--)E=L[A++],$=M[R+3],J=J+E*$|0,G=G+E*M[R+2]*$|0,K=K+E*M[R+1]*$|0,q=q+E*M[R]*$|0,R=R+4|0;G=G/255|0,K=K/255|0,q=q/255|0,U[V+3]=n(J>>7),U[V+2]=n(G>>7),U[V+1]=n(K>>7),U[V]=n(q>>7),V=V+C*4|0}V=(B+1)*4|0,k=(B+1)*Q*4|0}}function J0(M,U,Q,C,Z,L){let q,K,G,J,$,A,I,j,R,B,y,E=0,k=0;for(R=0;R<C;R++){$=0;for(B=0;B<Z;B++){A=L[$++],I=L[$++],j=E+A*4|0,q=K=G=J=0;for(;I>0;I--)y=L[$++],J=J+y*M[j+3]|0,G=G+y*M[j+2]|0,K=K+y*M[j+1]|0,q=q+y*M[j]|0,j=j+4|0;if(q>>=7,K>>=7,G>>=7,J>>=7,J=b(J+8192>>14),J>0)q=q*255/J|0,K=K*255/J|0,G=G*255/J|0;U[k+3]=J,U[k+2]=b(G+8192>>14),U[k+1]=b(K+8192>>14),U[k]=b(q+8192>>14),k=k+C*4|0}k=(R+1)*4|0,E=(R+1)*Q*4|0}}function Y0(M,U,Q){let C=3,Z=U*Q*4|0;while(C<Z){if(M[C]!==255)return!0;C=C+4|0}return!1}function D0(M,U,Q){let C=3,Z=U*Q*4|0;while(C<Z)M[C]=255,C=C+4|0}function K0(M,U,Q,C,Z,L,q,K,G,J){let $=d(M,Q,Z,q,G),A=d(M,C,L,K,J),I=new Uint8Array(Z*L*4),j=new Uint16Array(Z*C*4);if(Y0(U,Q,C))q0(U,j,Q,C,Z,$),J0(j,I,C,Z,L,A);else U0(U,j,Q,C,Z,$),C0(j,I,C,Z,L,A),D0(I,Z,L);return I}var A0=w0(j0(),1);function P0(M,U,Q){let C=U*Q,Z=new Uint16Array(C),L,q,K,G;for(let J=0;J<C;J++)L=M[4*J],q=M[4*J+1],K=M[4*J+2],G=L>=q&&L>=K?L:q>=K&&q>=L?q:K,Z[J]=G<<8;return Z}function L0(M,U,Q,C,Z,L){let q,K,G,J,$;if(C===0||Z<0.5)return;if(Z>2)Z=2;let A=P0(M,U,Q),I=new Uint16Array(A);A0.default(I,U,Q,Z);let j=C/100*4096+0.5|0,R=L<<8,B=U*Q;for(let y=0;y<B;y++)if(q=A[y],J=q-I[y],Math.abs(J)>=R)K=q+(j*J+2048>>12),K=K>65280?65280:K,K=K<0?0:K,q=q!==0?q:1,G=(K<<12)/q|0,$=y*4,M[$]=M[$]*G+2048>>12,M[$+1]=M[$+1]*G+2048>>12,M[$+2]=M[$+2]*G+2048>>12}function R0(M,U,Q,C,Z,L,q,K,G,J,$,A,I){let j=K0(M,U,Q,C,Z,L,q,K,G,J);if($)L0(j,Z,L,$,A,I);return j}var I0=(M,U,Q,C,Z,L,q)=>{let K=t(M,U),G=R0(Q,K,M.width,M.height,M.toWidth,M.toHeight,M.scaleX,M.scaleY,M.offsetX,M.offsetY,C,Z,L);e(M,G,q)};async function k0(M,U,Q,C,Z,L,q,K){let G=U,J=new OffscreenCanvas(M[0].toWidth,M[0].toHeight);for(let $=0;$<M.length;$++){let A=J.getContext("2d");if(!A)throw new Error("Pica: Canvas context is not supported");let I=r(G.width,G.height,Q,J.width,J.height,C);for(let R of I)I0(R,G,Z,L,q,K,A);let j=M[$+1];if(!j)break;G=J,J=new OffscreenCanvas(j.toWidth,j.toHeight)}return J}async function B0(M,U){let Q=U.maxDimension,C=U.tileSize||1024,Z=U.filter||"mks2013",L=U.unsharpAmount||0,q=U.unsharpRadius||0,K=U.unsharpThreshold||0,G=await createImageBitmap(M),J=G.width,$=G.height,A=Q/J,I=Q/$,j=Math.min(A,I,1),R=Math.floor(J*j),B=Math.floor($*j),y=3,E=Math.ceil(Math.max(3,2.5*q|0)),k=l(J,$,R,B,C,E);return(await k0(k,G,C,E,Z,L,q,K)).transferToImageBitmap()}self.onmessage=async(M)=>{let{taskId:U,blob:Q,options:C}=M.data;try{let Z=await B0(Q,C);self.postMessage({taskId:U,output:Z},[Z])}catch(Z){self.postMessage({taskId:U,error:Z})}};
`,Pk=new Blob([Sk],{type:"application/javascript"}),Hk=(()=>{let k=0;return()=>++k})();class yk{#M;#Q;#C;#k;constructor(){this.#M=new Map,this.#Q=new Map,this.#C=new Map,this.#k=new Map}get count(){return this.#M.size}setWorkerTimeout(k,M){let U=setTimeout(()=>{let Q=this.#M.get(k);if(Q)this.#C.delete(Q);if(Q)this.#k.delete(Q);this.#Q.delete(k),this.#M.delete(k),k.terminate()},M);this.#Q.set(k,U)}clearWorkerTimeout(k){clearTimeout(this.#Q.get(k))}addWorker(k){this.#M.set(k,null)}getWorker(k){return this.#C.get(k)}getTask(k){return this.#k.get(k)}getAvailableWorker(){for(let[k,M]of this.#M.entries())if(M===null)return k;return null}assignTask(k,M){this.#M.set(k,M.id),this.#C.set(M.id,k),this.#k.set(M.id,M);let U={taskId:M.id,blob:M.data.blob,options:M.data.options};k.postMessage(U)}removeTask(k){let M=this.#C.get(k);if(M)this.#M.set(M,null);this.#C.delete(k),this.#k.delete(k)}}class c{#M;#Q;#C;#k;constructor(k,M){this.#Q=k,this.#M=M,this.#C=[],this.#k=new yk}#q(){let k=new Worker(URL.createObjectURL(Pk));k.onmessage=(M)=>{let{taskId:U,output:Q,error:$}=M.data,Z=this.#k.getWorker(U),C=this.#k.getTask(U);if($){if(C)C.reject($)}else if(C)C.resolve(Q);if(this.#k.removeTask(U),Z)this.#k.setWorkerTimeout(Z,this.#M);this.#U()},k.onerror=(M)=>{console.log(M.message),console.log(M)},this.#k.addWorker(k)}#U(){let k=this.#k.getAvailableWorker();if(k){let M=this.#C.shift();if(M)this.#k.assignTask(k,M),this.#k.clearWorkerTimeout(k)}else if(this.#k.count<this.#Q)this.#q(),this.#U()}addTask(k){return new Promise((M,U)=>{this.#C.push({id:Hk(),data:k,resolve:M,reject:U}),this.#U()})}}class bk{#M;#Q;constructor(k){let M=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,U=k.maxWorkerPoolSize||Math.min(M,4),Q=k.maxWorkerIdleTime||2000;this.#M=new c(U,Q),this.#Q=k}squish(k,M){let U=M?{...this.#Q,...M}:this.#Q;if(U.useMainThread)return nk(k,U);return this.#M.addTask({blob:k,options:U})}}export{bk as PicSquish};
