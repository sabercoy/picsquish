var K=2;function w(s,r,a,e,u,k){let T=a/s,M=e/r,q=(2*k+K+1)/u;if(q>0.5)return[{toWidth:a,toHeight:e}];let m=Math.ceil(Math.log(Math.min(T,M))/Math.log(q));if(m<=1)return[{toWidth:a,toHeight:e}];let I=[];for(let t=0;t<m;t++){let f=Math.round(Math.pow(Math.pow(s,m-t-1)*Math.pow(a,t+1),1/m)),d=Math.round(Math.pow(Math.pow(r,m-t-1)*Math.pow(e,t+1),1/m));I.push({toWidth:f,toHeight:d})}return I}var D=0.00001;function B(s){let r=Math.round(s);if(Math.abs(s-r)<D)return r;return Math.floor(s)}function j(s){let r=Math.round(s);if(Math.abs(s-r)<D)return r;return Math.ceil(s)}function v(s,r,a,e,u,k,T,M,q,m){let I=a/s,t=e/r,f=B(u*I)-2*k,d=B(u*t)-2*k;if(f<1||d<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let y,o,b,A,n,R,c=[];for(A=0;A<e;A+=d)for(b=0;b<a;b+=f){if(y=b-k,y<0)y=0;if(n=b+f+k-y,y+n>=a)n=a-y;if(o=A-k,o<0)o=0;if(R=A+d+k-o,o+R>=e)R=e-o;c.push({toX:y,toY:o,toWidth:n,toHeight:R,toInnerX:b,toInnerY:A,toInnerWidth:f,toInnerHeight:d,offsetX:y/I-B(y/I),offsetY:o/t-B(o/t),scaleX:I,scaleY:t,x:B(y/I),y:B(o/t),width:j(n/I),height:j(R/t),initialSize:u,filterPadding:k,filter:T,unsharpAmount:M,unsharpRadius:q,unsharpThreshold:m})}return c}async function W(s,r,a){let e=await createImageBitmap(s),u=e.width,k=e.height,T=r/u,M=r/k,q=Math.min(T,M,1),m=Math.floor(u*q),I=Math.floor(k*q),t=w(u,k,m,I,a.initialSize,a.filterPadding),f=v(u,k,m,I,a.initialSize,a.filterPadding,a.filter,a.unsharpAmount,a.unsharpRadius,a.unsharpThreshold),y=new OffscreenCanvas(u,k).getContext("2d");if(!y)throw new Error("PicSquish: Canvas context is not supported");y.drawImage(e,0,0);let o=y.getImageData(0,0,u,k),b=new SharedArrayBuffer(o.data.byteLength);new Uint8ClampedArray(b).set(o.data);let n=m*I*4,R=new SharedArrayBuffer(n);return{from:b,fromWidth:u,fromHeight:k,to:R,tileTransforms:f,stages:t}}var Q=`
var jk=Object.create;var{getPrototypeOf:Gk,defineProperty:c,getOwnPropertyNames:Lk}=Object;var wk=Object.prototype.hasOwnProperty;var Ek=(k,y,M)=>{M=k!=null?jk(Gk(k)):{};let I=y||!k||!k.__esModule?c(M,"default",{value:k,enumerable:!0}):M;for(let A of Lk(k))if(!wk.call(I,A))c(I,A,{get:()=>k[A],enumerable:!0});return I};var Vk=(k,y)=>()=>(y||k((y={exports:{}}).exports,y),y.exports);var Kk=Vk((lk,Qk)=>{var o,p,s,f,x,v,Ck,Bk;function nk(k){if(k<0.5)k=0.5;var y=Math.exp(0.527076)/k,M=Math.exp(-y),I=Math.exp(-2*y),A=(1-M)*(1-M)/(1+2*y*M-I);return o=A,p=A*(y-1)*M,s=A*(y+1)*M,f=-A*I,x=2*M,v=-I,Ck=(o+p)/(1-x-v),Bk=(s+f)/(1-x-v),new Float32Array([o,p,s,f,x,v,Ck,Bk])}function Dk(k,y,M,I,A,C){var q,U,D,B,Q,J,j,R,K,$,Z,G,T,L,V,X,w,N,S,Y,m,E,W,z,h,u,P,n,O,F;for(h=0;h<C;h++){E=h*A,W=h,z=0,q=k[E],U=q&255,D=q>>8&255,B=q>>16&255,Q=q>>24&255,N=U*I[6],S=D*I[6],Y=B*I[6],m=Q*I[6],L=N,V=S,X=Y,w=m,P=I[0],n=I[1],O=I[4],F=I[5];for(u=0;u<A;u++)q=k[E],J=q&255,j=q>>8&255,R=q>>16&255,K=q>>24&255,$=J*P+U*n+L*O+N*F,Z=j*P+D*n+V*O+S*F,G=R*P+B*n+X*O+Y*F,T=K*P+Q*n+w*O+m*F,N=L,S=V,Y=X,m=w,L=$,V=Z,X=G,w=T,U=J,D=j,B=R,Q=K,M[z]=L,M[z+1]=V,M[z+2]=X,M[z+3]=w,z+=4,E++;E--,z-=4,W+=C*(A-1),q=k[E],U=q&255,D=q>>8&255,B=q>>16&255,Q=q>>24&255,N=U*I[7],S=D*I[7],Y=B*I[7],m=Q*I[7],L=N,V=S,X=Y,w=m,J=U,j=D,R=B,K=Q,P=I[2],n=I[3];for(u=A-1;u>=0;u--)$=J*P+U*n+L*O+N*F,Z=j*P+D*n+V*O+S*F,G=R*P+B*n+X*O+Y*F,T=K*P+Q*n+w*O+m*F,N=L,S=V,Y=X,m=w,L=$,V=Z,X=G,w=T,U=J,D=j,B=R,Q=K,q=k[E],J=q&255,j=q>>8&255,R=q>>16&255,K=q>>24&255,q=(M[z]+L<<0)+(M[z+1]+V<<8)+(M[z+2]+X<<16)+(M[z+3]+w<<24),y[W]=q,E--,z-=4,W-=C}}function Ok(k,y,M,I){if(!I)return;var A=new Uint32Array(k.buffer),C=new Uint32Array(A.length),q=new Float32Array(Math.max(y,M)*4),U=nk(I);Dk(A,C,q,U,y,M,I),Dk(C,A,q,U,M,y,I)}Qk.exports=Ok});var Nk=2;function l(k,y,M,I,A,C){let q=M/k,U=I/y,D=(2*C+Nk+1)/A;if(D>0.5)return[{toWidth:M,toHeight:I}];let B=Math.ceil(Math.log(Math.min(q,U))/Math.log(D));if(B<=1)return[{toWidth:M,toHeight:I}];let Q=[];for(let J=0;J<B;J++){let j=Math.round(Math.pow(Math.pow(k,B-J-1)*Math.pow(M,J+1),1/B)),R=Math.round(Math.pow(Math.pow(y,B-J-1)*Math.pow(I,J+1),1/B));Q.push({toWidth:j,toHeight:R})}return Q}var i=0.00001;function a(k){let y=Math.round(k);if(Math.abs(k-y)<i)return y;return Math.floor(k)}function _(k){let y=Math.round(k);if(Math.abs(k-y)<i)return y;return Math.ceil(k)}function r(k,y,M,I,A,C,q,U,D,B){let Q=M/k,J=I/y,j=a(A*Q)-2*C,R=a(A*J)-2*C;if(j<1||R<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let K,$,Z,G,T,L,V=[];for(G=0;G<I;G+=R)for(Z=0;Z<M;Z+=j){if(K=Z-C,K<0)K=0;if(T=Z+j+C-K,K+T>=M)T=M-K;if($=G-C,$<0)$=0;if(L=G+R+C-$,$+L>=I)L=I-$;V.push({toX:K,toY:$,toWidth:T,toHeight:L,toInnerX:Z,toInnerY:G,toInnerWidth:j,toInnerHeight:R,offsetX:K/Q-a(K/Q),offsetY:$/J-a($/J),scaleX:Q,scaleY:J,x:a(K/Q),y:a($/J),width:_(T/Q),height:_(L/J),initialSize:A,filterPadding:C,filter:q,unsharpAmount:U,unsharpRadius:D,unsharpThreshold:B})}return V}async function t(k,y,M){let I=await createImageBitmap(k),A=I.width,C=I.height,q=y/A,U=y/C,D=Math.min(q,U,1),B=Math.floor(A*D),Q=Math.floor(C*D),J=l(A,C,B,Q,M.initialSize,M.filterPadding),j=r(A,C,B,Q,M.initialSize,M.filterPadding,M.filter,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold),K=new OffscreenCanvas(A,C).getContext("2d");if(!K)throw new Error("PicSquish: Canvas context is not supported");K.drawImage(I,0,0);let $=K.getImageData(0,0,A,C),Z=new SharedArrayBuffer($.data.byteLength);new Uint8ClampedArray(Z).set($.data);let T=B*Q*4,L=new SharedArrayBuffer(T);return{from:Z,fromWidth:A,fromHeight:C,to:L,tileTransforms:j,stages:J}}var Xk="<WORKER_CODE>",zk=new Blob([Xk],{type:"application/javascript"});var e=(()=>{let k=0;return()=>++k})();class kk{#y;#q;#M;#I;constructor(){this.#y=new Map,this.#q=new Map,this.#M=new Map,this.#I=new Map}get count(){return this.#y.size}#A(k){clearTimeout(this.#q.get(k))}#k(k,y,M,I){this.#y.set(k,y.id),this.#M.set(y.id,k),this.#I.set(y.id,y),k.postMessage(M,I),this.#A(k)}assignPriority1Task(k,y){let M={taskId:y.id,squishId:y.squishId,taskType:0,blob:y.data.blob,maxDimension:y.data.maxDimension,tileOptions:y.data.tileOptions};console.log("TASK 1"),this.#k(k,y,M,[])}assignPriority2Task(k,y){let M={taskId:y.id,squishId:y.squishId,taskType:1,tileTransform:y.data.tileTransform,from:y.data.from,fromWidth:y.data.fromWidth,to:y.data.to,toWidth:y.data.toWidth};this.#k(k,y,M,[])}setWorkerTimeout(k,y){let M=setTimeout(()=>{let I=this.#y.get(k);if(I)this.#M.delete(I);if(I)this.#I.delete(I);this.#q.delete(k),this.#y.delete(k),k.terminate()},y);this.#q.set(k,M)}addWorker(k){this.#y.set(k,null)}getWorker(k){return this.#M.get(k)}getTask(k){return this.#I.get(k)}getAvailableWorker(){for(let[k,y]of this.#y.entries())if(y===null)return k;return null}removeTask(k){let y=this.#M.get(k);if(y)this.#y.set(y,null);this.#M.delete(k),this.#I.delete(k)}}class Yk{#y;#q;#M;#I;#A;#k;constructor(k,y){this.#q=k,this.#y=y,this.#M=new Map,this.#I=[],this.#A=[],this.#k=new kk}#C(){let k=new Worker(URL.createObjectURL(zk));k.onmessage=(y)=>{let M=this.#M.get(y.data.squishId);if(!M)throw new Error("SquishContext not found");if(y.data.taskType===0){let{squishId:A,error:C,output:q}=y.data;if(C)M.reject(C);else{M.from=q.from,M.fromWidth=q.fromWidth,M.fromHeight=q.fromHeight,M.to=q.to,M.toWidth=q.stages[0].toWidth,M.toHeight=q.stages[0].toHeight,M.stages=q.stages,M.remainingTileCount=q.tileTransforms.length;for(let U of q.tileTransforms)this.#A.push({id:e(),squishId:A,data:{tileTransform:U,from:M.from,fromWidth:M.fromWidth,to:M.to,toWidth:M.toWidth}})}}if(y.data.taskType===1){let{error:A}=y.data;if(A)M.reject(A);else if(M.remainingTileCount--,!M.remainingTileCount){if(!M.to)throw new Error("SquishContext to not found");Wk(M.to,M.toWidth,M.toHeight).then((C)=>{M.resolve(C)})}}let I=this.#k.getWorker(y.data.taskId);if(I)this.#k.setWorkerTimeout(I,this.#y);this.#k.removeTask(y.data.taskId),this.#U()},k.onerror=(y)=>{console.log(y.message),console.log(y)},this.#k.addWorker(k)}#U(){let k=this.#k.getAvailableWorker();if(k){let y=this.#I.shift();if(y)return this.#k.assignPriority1Task(k,y);let M=this.#A.shift();if(M)return this.#k.assignPriority2Task(k,M)}else if(this.#k.count<this.#q)this.#C(),this.#U()}add(k){return new Promise((y,M)=>{let I=e();this.#M.set(I,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:y,reject:M}),this.#I.push({id:I,squishId:I,data:k}),this.#U()})}}async function Wk(k,y,M){let I=new Uint8ClampedArray(k),A=new Uint8ClampedArray(I),C=new ImageData(A,y,M);return await createImageBitmap(C)}var g={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let y=k*Math.PI;return Math.sin(y)/y*(0.54+0.46*Math.cos(y/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let y=k*Math.PI;return Math.sin(y)/y*Math.sin(y/2)/(y/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let y=k*Math.PI;return Math.sin(y)/y*Math.sin(y/3)/(y/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Sk=14;function yk(k){return Math.round(k*((1<<Sk)-1))}function d(k,y,M,I,A){let C=g[k].fn,q=1/I,U=Math.min(1,I),D=g[k].win/U,B,Q,J,j,R,K,$,Z,G,T,L,V,X,w,N,S,Y,m=Math.floor((D+1)*2),E=new Int16Array((m+2)*M),W=0,z=!E.subarray||!E.set;for(B=0;B<M;B++){Q=(B+0.5)*q+A,J=Math.max(0,Math.floor(Q-D)),j=Math.min(y-1,Math.ceil(Q+D)),R=j-J+1,K=new Float32Array(R),$=new Int16Array(R),Z=0;for(G=J,T=0;G<=j;G++,T++)L=C((G+0.5-Q)*U),Z+=L,K[T]=L;V=0;for(T=0;T<K.length;T++)X=K[T]/Z,V+=X,$[T]=yk(X);$[M>>1]+=yk(1-V),w=0;while(w<$.length&&$[w]===0)w++;if(w<$.length){N=$.length-1;while(N>0&&$[N]===0)N--;if(S=J+w,Y=N-w+1,E[W++]=S,E[W++]=Y,!z)E.set($.subarray(w,N+1),W),W+=Y;else for(T=w;T<=N;T++)E[W++]=$[T]}else E[W++]=0,E[W++]=0}return E}function H(k){return k<0?0:k>255?255:k}function b(k){return k>=0?k:0}function Mk(k,y,M,I,A,C){let q,U,D,B,Q,J,j,R,K,$,Z,G=0,T=0;for(K=0;K<I;K++){Q=0;for($=0;$<A;$++){J=C[Q++],j=C[Q++],R=G+J*4|0,q=U=D=B=0;for(;j>0;j--)Z=C[Q++],B=B+Z*k[R+3]|0,D=D+Z*k[R+2]|0,U=U+Z*k[R+1]|0,q=q+Z*k[R]|0,R=R+4|0;y[T+3]=b(B>>7),y[T+2]=b(D>>7),y[T+1]=b(U>>7),y[T]=b(q>>7),T=T+I*4|0}T=(K+1)*4|0,G=(K+1)*M*4|0}}function Ik(k,y,M,I,A,C){let q,U,D,B,Q,J,j,R,K,$,Z,G=0,T=0;for(K=0;K<I;K++){Q=0;for($=0;$<A;$++){J=C[Q++],j=C[Q++],R=G+J*4|0,q=U=D=B=0;for(;j>0;j--)Z=C[Q++],B=B+Z*k[R+3]|0,D=D+Z*k[R+2]|0,U=U+Z*k[R+1]|0,q=q+Z*k[R]|0,R=R+4|0;q>>=7,U>>=7,D>>=7,B>>=7,y[T+3]=H(B+8192>>14),y[T+2]=H(D+8192>>14),y[T+1]=H(U+8192>>14),y[T]=H(q+8192>>14),T=T+I*4|0}T=(K+1)*4|0,G=(K+1)*M*4|0}}function qk(k,y,M,I,A,C){let q,U,D,B,Q,J,j,R,K,$,Z,G,T=0,L=0;for($=0;$<I;$++){J=0;for(Z=0;Z<A;Z++){j=C[J++],R=C[J++],K=T+j*4|0,q=U=D=B=0;for(;R>0;R--)G=C[J++],Q=k[K+3],B=B+G*Q|0,D=D+G*k[K+2]*Q|0,U=U+G*k[K+1]*Q|0,q=q+G*k[K]*Q|0,K=K+4|0;D=D/255|0,U=U/255|0,q=q/255|0,y[L+3]=b(B>>7),y[L+2]=b(D>>7),y[L+1]=b(U>>7),y[L]=b(q>>7),L=L+I*4|0}L=($+1)*4|0,T=($+1)*M*4|0}}function Ak(k,y,M,I,A,C){let q,U,D,B,Q,J,j,R,K,$,Z,G=0,T=0;for(K=0;K<I;K++){Q=0;for($=0;$<A;$++){J=C[Q++],j=C[Q++],R=G+J*4|0,q=U=D=B=0;for(;j>0;j--)Z=C[Q++],B=B+Z*k[R+3]|0,D=D+Z*k[R+2]|0,U=U+Z*k[R+1]|0,q=q+Z*k[R]|0,R=R+4|0;if(q>>=7,U>>=7,D>>=7,B>>=7,B=H(B+8192>>14),B>0)q=q*255/B|0,U=U*255/B|0,D=D*255/B|0;y[T+3]=B,y[T+2]=H(D+8192>>14),y[T+1]=H(U+8192>>14),y[T]=H(q+8192>>14),T=T+I*4|0}T=(K+1)*4|0,G=(K+1)*M*4|0}}function mk(k,y,M){let I=3,A=y*M*4|0;while(I<A){if(k[I]!==255)return!0;I=I+4|0}return!1}function Pk(k,y,M){let I=3,A=y*M*4|0;while(I<A)k[I]=255,I=I+4|0}function Uk(k,y,M,I,A,C,q,U,D,B){let Q=d(y,M,A,q,D),J=d(y,I,C,U,B),j=new Uint8Array(A*C*4),R=new Uint16Array(A*I*4);if(mk(k,M,I))qk(k,R,M,I,A,Q),Ak(R,j,I,A,C,J);else Mk(k,R,M,I,A,Q),Ik(R,j,I,A,C,J),Pk(j,A,C);return j}var Rk=Ek(Kk(),1);function Fk(k,y,M){let I=y*M,A=new Uint16Array(I),C,q,U,D;for(let B=0;B<I;B++)C=k[4*B],q=k[4*B+1],U=k[4*B+2],D=C>=q&&C>=U?C:q>=U&&q>=C?q:U,A[B]=D<<8;return A}function Tk(k,y,M,I,A,C){let q,U,D,B,Q;if(I===0||A<0.5)return;if(A>2)A=2;let J=Fk(k,y,M),j=new Uint16Array(J);Rk.default(j,y,M,A);let R=I/100*4096+0.5|0,K=C<<8,$=y*M;for(let Z=0;Z<$;Z++)if(q=J[Z],B=q-j[Z],Math.abs(B)>=K)U=q+(R*B+2048>>12),U=U>65280?65280:U,U=U<0?0:U,q=q!==0?q:1,D=(U<<12)/q|0,Q=Z*4,k[Q]=k[Q]*D+2048>>12,k[Q+1]=k[Q+1]*D+2048>>12,k[Q+2]=k[Q+2]*D+2048>>12}function Jk(k,y){let M=Uk(k,y.filter,y.width,y.height,y.toWidth,y.toHeight,y.scaleX,y.scaleY,y.offsetX,y.offsetY);if(y.unsharpAmount)Tk(M,y.toWidth,y.toHeight,y.unsharpAmount,y.unsharpRadius,y.unsharpThreshold);return M}function $k(k,y,M,I){let C=new Uint8ClampedArray(k);for(let q=0;q<M.toHeight;q++){let U=q*M.toWidth*4,D=((M.toY+q)*y+M.toX)*4;C.set(I.subarray(U,U+M.toWidth*4),D)}}function Zk(k,y,M){let A=new Uint8ClampedArray(k),C=new Uint8ClampedArray(M.width*M.height*4);for(let q=0;q<M.height;q++){let U=((M.y+q)*y+M.x)*4,D=q*M.width*4;C.set(A.subarray(U,U+M.width*4),D)}return C}self.onmessage=async(k)=>{let{taskId:y,squishId:M,taskType:I}=k.data;try{if(I===0){let{blob:A,maxDimension:C,tileOptions:q}=k.data,U=await t(A,C,q),D={taskId:y,squishId:M,taskType:I,output:{from:U.from,fromWidth:U.fromWidth,fromHeight:U.fromHeight,to:U.to,tileTransforms:U.tileTransforms,stages:U.stages}};self.postMessage(D)}if(I===1){let{tileTransform:A,from:C,fromWidth:q,to:U,toWidth:D}=k.data,B=Zk(C,q,A),Q=Jk(B,A);$k(U,D,A,Q);let J={taskId:y,squishId:M,taskType:I};self.postMessage(J)}}catch(A){self.postMessage({taskId:y,error:A})}};
`,p=new Blob([Q],{type:"application/javascript"});var h=(()=>{let s=0;return()=>++s})();class U{#s;#a;#e;#k;constructor(){this.#s=new Map,this.#a=new Map,this.#e=new Map,this.#k=new Map}get count(){return this.#s.size}#u(s){clearTimeout(this.#a.get(s))}#r(s,r,a,e){this.#s.set(s,r.id),this.#e.set(r.id,s),this.#k.set(r.id,r),s.postMessage(a,e),this.#u(s)}assignPriority1Task(s,r){let a={taskId:r.id,squishId:r.squishId,taskType:0,blob:r.data.blob,maxDimension:r.data.maxDimension,tileOptions:r.data.tileOptions};console.log("TASK 1"),this.#r(s,r,a,[])}assignPriority2Task(s,r){let a={taskId:r.id,squishId:r.squishId,taskType:1,tileTransform:r.data.tileTransform,from:r.data.from,fromWidth:r.data.fromWidth,to:r.data.to,toWidth:r.data.toWidth};this.#r(s,r,a,[])}setWorkerTimeout(s,r){let a=setTimeout(()=>{let e=this.#s.get(s);if(e)this.#e.delete(e);if(e)this.#k.delete(e);this.#a.delete(s),this.#s.delete(s),s.terminate()},r);this.#a.set(s,a)}addWorker(s){this.#s.set(s,null)}getWorker(s){return this.#e.get(s)}getTask(s){return this.#k.get(s)}getAvailableWorker(){for(let[s,r]of this.#s.entries())if(r===null)return s;return null}removeTask(s){let r=this.#e.get(s);if(r)this.#s.set(r,null);this.#e.delete(s),this.#k.delete(s)}}class C{#s;#a;#e;#k;#u;#r;constructor(s,r){this.#a=s,this.#s=r,this.#e=new Map,this.#k=[],this.#u=[],this.#r=new U}#t(){let s=new Worker(URL.createObjectURL(p));s.onmessage=(r)=>{let a=this.#e.get(r.data.squishId);if(!a)throw new Error("SquishContext not found");if(r.data.taskType===0){let{squishId:u,error:k,output:T}=r.data;if(k)a.reject(k);else{a.from=T.from,a.fromWidth=T.fromWidth,a.fromHeight=T.fromHeight,a.to=T.to,a.toWidth=T.stages[0].toWidth,a.toHeight=T.stages[0].toHeight,a.stages=T.stages,a.remainingTileCount=T.tileTransforms.length;for(let M of T.tileTransforms)this.#u.push({id:h(),squishId:u,data:{tileTransform:M,from:a.from,fromWidth:a.fromWidth,to:a.to,toWidth:a.toWidth}})}}if(r.data.taskType===1){let{error:u}=r.data;if(u)a.reject(u);else if(a.remainingTileCount--,!a.remainingTileCount){if(!a.to)throw new Error("SquishContext to not found");E(a.to,a.toWidth,a.toHeight).then((k)=>{a.resolve(k)})}}let e=this.#r.getWorker(r.data.taskId);if(e)this.#r.setWorkerTimeout(e,this.#s);this.#r.removeTask(r.data.taskId),this.#T()},s.onerror=(r)=>{console.log(r.message),console.log(r)},this.#r.addWorker(s)}#T(){let s=this.#r.getAvailableWorker();if(s){let r=this.#k.shift();if(r)return this.#r.assignPriority1Task(s,r);let a=this.#u.shift();if(a)return this.#r.assignPriority2Task(s,a)}else if(this.#r.count<this.#a)this.#t(),this.#T()}add(s){return new Promise((r,a)=>{let e=h();this.#e.set(e,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:r,reject:a}),this.#k.push({id:e,squishId:e,data:s}),this.#T()})}}async function E(s,r,a){let e=new Uint8ClampedArray(s),u=new Uint8ClampedArray(e),k=new ImageData(u,r,a);return await createImageBitmap(k)}function G(){return typeof SharedArrayBuffer==="function"&&self.crossOriginIsolated===!0}class J{#s;#a;constructor(s){let r=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,a=s.maxWorkerPoolSize||Math.min(r,4),e=s.maxWorkerIdleTime||1e4;this.#s=new C(a,e),this.#a=s}async squish(s,r){console.log("SAB",G());let a=r?{...this.#a,...r}:this.#a,e=a.maxDimension,u=a.tileSize||1024,k=a.filter||"mks2013",T=a.unsharpAmount||0,M=a.unsharpRadius||0,q=a.unsharpThreshold||0,m=a.useMainThread,t=Math.ceil(Math.max(3,2.5*M|0)),f={initialSize:u,filterPadding:t,filter:k,unsharpAmount:T,unsharpRadius:M,unsharpThreshold:q};if(m){let d=await W(s,e,f);return console.log("here"),console.log(d),d}return this.#s.add({blob:s,maxDimension:e,tileOptions:f})}}export{J as PicSquish};
