var Ln=Object.create;var{getPrototypeOf:Gn,defineProperty:t,getOwnPropertyNames:En}=Object;var On=Object.prototype.hasOwnProperty;var zn=(n,k,R)=>{R=n!=null?Ln(Gn(n)):{};let I=k||!n||!n.__esModule?t(R,"default",{value:n,enumerable:!0}):R;for(let M of En(n))if(!On.call(I,M))t(I,M,{get:()=>n[M],enumerable:!0});return I};var an=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Qn=an((Tk,Cn)=>{var l,c,f,i,p,x,Un,An;function Wn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,R=Math.exp(-k),I=Math.exp(-2*k),M=(1-R)*(1-R)/(1+2*k*R-I);return l=M,c=M*(k-1)*R,f=M*(k+1)*R,i=-M*I,p=2*R,x=-I,Un=(l+c)/(1-p-x),An=(f+i)/(1-p-x),new Float32Array([l,c,f,i,p,x,Un,An])}function wn(n,k,R,I,M,y){var T,B,D,m,A,w,q,U,Q,J,K,$,C,Z,L,O,j,G,N,X,Y,E,V,z,o,h,u,S,W,F;for(o=0;o<y;o++){E=o*M,V=o,z=0,T=n[E],B=T&255,D=T>>8&255,m=T>>16&255,A=T>>24&255,G=B*I[6],N=D*I[6],X=m*I[6],Y=A*I[6],Z=G,L=N,O=X,j=Y,u=I[0],S=I[1],W=I[4],F=I[5];for(h=0;h<M;h++)T=n[E],w=T&255,q=T>>8&255,U=T>>16&255,Q=T>>24&255,J=w*u+B*S+Z*W+G*F,K=q*u+D*S+L*W+N*F,$=U*u+m*S+O*W+X*F,C=Q*u+A*S+j*W+Y*F,G=Z,N=L,X=O,Y=j,Z=J,L=K,O=$,j=C,B=w,D=q,m=U,A=Q,R[z]=Z,R[z+1]=L,R[z+2]=O,R[z+3]=j,z+=4,E++;E--,z-=4,V+=y*(M-1),T=n[E],B=T&255,D=T>>8&255,m=T>>16&255,A=T>>24&255,G=B*I[7],N=D*I[7],X=m*I[7],Y=A*I[7],Z=G,L=N,O=X,j=Y,w=B,q=D,U=m,Q=A,u=I[2],S=I[3];for(h=M-1;h>=0;h--)J=w*u+B*S+Z*W+G*F,K=q*u+D*S+L*W+N*F,$=U*u+m*S+O*W+X*F,C=Q*u+A*S+j*W+Y*F,G=Z,N=L,X=O,Y=j,Z=J,L=K,O=$,j=C,B=w,D=q,m=U,A=Q,T=n[E],w=T&255,q=T>>8&255,U=T>>16&255,Q=T>>24&255,T=(R[z]+Z<<0)+(R[z+1]+L<<8)+(R[z+2]+O<<16)+(R[z+3]+j<<24),k[V]=T,E--,z-=4,V-=y}}function Fn(n,k,R,I){if(!I)return;var M=new Uint32Array(n.buffer),y=new Uint32Array(M.length),T=new Float32Array(Math.max(k,R)*4),B=Wn(I);wn(M,y,T,B,k,R,I),wn(y,M,T,B,R,k,I)}Cn.exports=Fn});var a=4;var Xn=2;function e(n,k,R,I,M,y){let T=R/n,B=I/k,D=(2*y+Xn+1)/M;if(D>0.5)return[{toWidth:R,toHeight:I}];let m=Math.ceil(Math.log(Math.min(T,B))/Math.log(D));if(m<=1)return[{toWidth:R,toHeight:I}];let A=[];for(let w=0;w<m;w++){let q=Math.round(Math.pow(Math.pow(n,m-w-1)*Math.pow(R,w+1),1/m)),U=Math.round(Math.pow(Math.pow(k,m-w-1)*Math.pow(I,w+1),1/m));A.push({toWidth:q,toHeight:U})}return A}function Vn(n,k){let I=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");return I.globalCompositeOperation="copy",I.drawImage(n,k.x,k.y,k.width,k.height,0,0,k.width,k.height),I.getImageData(0,0,k.width,k.height).data.buffer}function Nn(n,k,R){let I=new Uint8ClampedArray(R.width*R.height*a);for(let M=0;M<R.height;M++){let y=((R.y+M)*k+R.x)*a,T=M*R.width*a;I.set(n.subarray(y,y+R.width*a),T)}return I.buffer}function r(n,k,R){if(n instanceof ImageBitmap)return Vn(n,R);else return Nn(n,k,R)}var kn=0.00001;function g(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.floor(n)}function nn(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.ceil(n)}function In(n,k,R,I,M,y,T,B,D,m,A){let w=I/k,q=M/R,U=g(y*w)-2*T,Q=g(y*q)-2*T;if(U<1||Q<1)throw new Error("Picsquish error: target tile width/height is too small");let J,K,$,C,Z,L,O=[];for(C=0;C<M;C+=Q)for($=0;$<I;$+=U){if(J=$-T,J<0)J=0;if(Z=$+U+T-J,J+Z>=I)Z=I-J;if(K=C-T,K<0)K=0;if(L=C+Q+T-K,K+L>=M)L=M-K;let j={toX:J,toY:K,toWidth:Z,toHeight:L,toInnerX:$,toInnerY:C,toInnerWidth:U,toInnerHeight:Q,offsetX:J/w-g(J/w),offsetY:K/q-g(K/q),scaleX:w,scaleY:q,x:g(J/w),y:g(K/q),width:nn(Z/w),height:nn(L/q),initialSize:y,filterPadding:T,filter:B,unsharpAmount:D,unsharpRadius:m,unsharpThreshold:A},G=r(n,k,j);O.push({tile:G,...j})}return O}async function Rn(n){let k,R,I,M,y,T;if(n.image instanceof Blob||n.image instanceof ImageBitmap){let D=n.image instanceof ImageBitmap?n.image:await createImageBitmap(n.image);k=D,R=D.width,I=D.height;let m=n.maxDimension/R,A=n.maxDimension/I,w=Math.min(m,A,1),q=Math.floor(R*w),U=Math.floor(I*w);M=e(R,I,q,U,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,R=n.image.fromWidth,I=n.image.fromHeight,M=n.image.stages;y=M[0].toWidth,T=M[0].toHeight;let B=In(k,R,I,y,T,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);if(k instanceof ImageBitmap)k.close();return{tileTransforms:B,stages:M}}var v={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Yn=14;function Tn(n){return Math.round(n*((1<<Yn)-1))}function d(n,k,R,I,M){let y=v[n].fn,T=1/I,B=Math.min(1,I),D=v[n].win/B,m,A,w,q,U,Q,J,K,$,C,Z,L,O,j,G,N,X,Y=Math.floor((D+1)*2),E=new Int16Array((Y+2)*R),V=0,z=!E.subarray||!E.set;for(m=0;m<R;m++){A=(m+0.5)*T+M,w=Math.max(0,Math.floor(A-D)),q=Math.min(k-1,Math.ceil(A+D)),U=q-w+1,Q=new Float32Array(U),J=new Int16Array(U),K=0;for($=w,C=0;$<=q;$++,C++)Z=y(($+0.5-A)*B),K+=Z,Q[C]=Z;L=0;for(C=0;C<Q.length;C++)O=Q[C]/K,L+=O,J[C]=Tn(O);J[R>>1]+=Tn(1-L),j=0;while(j<J.length&&J[j]===0)j++;if(j<J.length){G=J.length-1;while(G>0&&J[G]===0)G--;if(N=w+j,X=G-j+1,E[V++]=N,E[V++]=X,!z)E.set(J.subarray(j,G+1),V),V+=X;else for(C=j;C<=G;C++)E[V++]=J[C]}else E[V++]=0,E[V++]=0}return E}function b(n){return n<0?0:n>255?255:n}function P(n){return n>=0?n:0}function Mn(n,k,R,I,M,y){let T,B,D,m,A,w,q,U,Q,J,K,$=0,C=0;for(Q=0;Q<I;Q++){A=0;for(J=0;J<M;J++){w=y[A++],q=y[A++],U=$+w*4|0,T=B=D=m=0;for(;q>0;q--)K=y[A++],m=m+K*n[U+3]|0,D=D+K*n[U+2]|0,B=B+K*n[U+1]|0,T=T+K*n[U]|0,U=U+4|0;k[C+3]=P(m>>7),k[C+2]=P(D>>7),k[C+1]=P(B>>7),k[C]=P(T>>7),C=C+I*4|0}C=(Q+1)*4|0,$=(Q+1)*R*4|0}}function mn(n,k,R,I,M,y){let T,B,D,m,A,w,q,U,Q,J,K,$=0,C=0;for(Q=0;Q<I;Q++){A=0;for(J=0;J<M;J++){w=y[A++],q=y[A++],U=$+w*4|0,T=B=D=m=0;for(;q>0;q--)K=y[A++],m=m+K*n[U+3]|0,D=D+K*n[U+2]|0,B=B+K*n[U+1]|0,T=T+K*n[U]|0,U=U+4|0;T>>=7,B>>=7,D>>=7,m>>=7,k[C+3]=b(m+8192>>14),k[C+2]=b(D+8192>>14),k[C+1]=b(B+8192>>14),k[C]=b(T+8192>>14),C=C+I*4|0}C=(Q+1)*4|0,$=(Q+1)*R*4|0}}function yn(n,k,R,I,M,y){let T,B,D,m,A,w,q,U,Q,J,K,$,C=0,Z=0;for(J=0;J<I;J++){w=0;for(K=0;K<M;K++){q=y[w++],U=y[w++],Q=C+q*4|0,T=B=D=m=0;for(;U>0;U--)$=y[w++],A=n[Q+3],m=m+$*A|0,D=D+$*n[Q+2]*A|0,B=B+$*n[Q+1]*A|0,T=T+$*n[Q]*A|0,Q=Q+4|0;D=D/255|0,B=B/255|0,T=T/255|0,k[Z+3]=P(m>>7),k[Z+2]=P(D>>7),k[Z+1]=P(B>>7),k[Z]=P(T>>7),Z=Z+I*4|0}Z=(J+1)*4|0,C=(J+1)*R*4|0}}function Bn(n,k,R,I,M,y){let T,B,D,m,A,w,q,U,Q,J,K,$=0,C=0;for(Q=0;Q<I;Q++){A=0;for(J=0;J<M;J++){w=y[A++],q=y[A++],U=$+w*4|0,T=B=D=m=0;for(;q>0;q--)K=y[A++],m=m+K*n[U+3]|0,D=D+K*n[U+2]|0,B=B+K*n[U+1]|0,T=T+K*n[U]|0,U=U+4|0;if(T>>=7,B>>=7,D>>=7,m>>=7,m=b(m+8192>>14),m>0)T=T*255/m|0,B=B*255/m|0,D=D*255/m|0;k[C+3]=m,k[C+2]=b(D+8192>>14),k[C+1]=b(B+8192>>14),k[C]=b(T+8192>>14),C=C+I*4|0}C=(Q+1)*4|0,$=(Q+1)*R*4|0}}function un(n,k,R){let I=3,M=k*R*4|0;while(I<M){if(n[I]!==255)return!0;I=I+4|0}return!1}function Sn(n,k,R){let I=3,M=k*R*4|0;while(I<M)n[I]=255,I=I+4|0}function Dn(n,k,R,I,M,y,T,B,D,m){let A=d(k,R,M,T,D),w=d(k,I,y,B,m),q=new Uint8Array(M*y*4),U=new Uint16Array(M*I*4);if(un(n,R,I))yn(n,U,R,I,M,A),Bn(U,q,I,M,y,w);else Mn(n,U,R,I,M,A),mn(U,q,I,M,y,w),Sn(q,M,y);return q}var Kn=zn(Qn(),1);function bn(n,k,R){let I=k*R,M=new Uint16Array(I),y,T,B,D;for(let m=0;m<I;m++)y=n[4*m],T=n[4*m+1],B=n[4*m+2],D=y>=T&&y>=B?y:T>=B&&T>=y?T:B,M[m]=D<<8;return M}function qn(n,k,R,I,M,y){let T,B,D,m,A;if(I===0||M<0.5)return;if(M>2)M=2;let w=bn(n,k,R),q=new Uint16Array(w);Kn.default(q,k,R,M);let U=I/100*4096+0.5|0,Q=y<<8,J=k*R;for(let K=0;K<J;K++)if(T=w[K],m=T-q[K],Math.abs(m)>=Q)B=T+(U*m+2048>>12),B=B>65280?65280:B,B=B<0?0:B,T=T!==0?T:1,D=(B<<12)/T|0,A=K*4,n[A]=n[A]*D+2048>>12,n[A+1]=n[A+1]*D+2048>>12,n[A+2]=n[A+2]*D+2048>>12}function Jn(n){let k=Dn(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)qn(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}function s(n,k,R){let I=new Uint8ClampedArray(R.tile);for(let M=0;M<R.toHeight;M++){let y=M*R.toWidth*a,T=((R.toY+M)*k+R.toX)*a;n.set(I.subarray(y,y+R.toWidth*a),T)}}var Pn=`
var Zk=Object.create;var{getPrototypeOf:Gk,defineProperty:l,getOwnPropertyNames:jk}=Object;var Lk=Object.prototype.hasOwnProperty;var Tk=(k,I,y)=>{y=k!=null?Zk(Gk(k)):{};let M=I||!k||!k.__esModule?l(y,"default",{value:k,enumerable:!0}):y;for(let D of jk(k))if(!Lk.call(M,D))l(M,D,{get:()=>k[D],enumerable:!0});return M};var mk=(k,I)=>()=>(I||k((I={exports:{}}).exports,I),I.exports);var Jk=mk((ik,Ck)=>{var o,s,c,f,p,h,qk,Uk;function Nk(k){if(k<0.5)k=0.5;var I=Math.exp(0.527076)/k,y=Math.exp(-I),M=Math.exp(-2*I),D=(1-y)*(1-y)/(1+2*I*y-M);return o=D,s=D*(I-1)*y,c=D*(I+1)*y,f=-D*M,p=2*y,h=-M,qk=(o+s)/(1-p-h),Uk=(c+f)/(1-p-h),new Float32Array([o,s,c,f,p,h,qk,Uk])}function Ak(k,I,y,M,D,J){var R,q,U,B,A,K,G,C,j,Z,$,L,Q,T,w,O,m,z,X,V,Y,n,N,E,x,u,S,F,H,W;for(x=0;x<J;x++){n=x*D,N=x,E=0,R=k[n],q=R&255,U=R>>8&255,B=R>>16&255,A=R>>24&255,z=q*M[6],X=U*M[6],V=B*M[6],Y=A*M[6],T=z,w=X,O=V,m=Y,S=M[0],F=M[1],H=M[4],W=M[5];for(u=0;u<D;u++)R=k[n],K=R&255,G=R>>8&255,C=R>>16&255,j=R>>24&255,Z=K*S+q*F+T*H+z*W,$=G*S+U*F+w*H+X*W,L=C*S+B*F+O*H+V*W,Q=j*S+A*F+m*H+Y*W,z=T,X=w,V=O,Y=m,T=Z,w=$,O=L,m=Q,q=K,U=G,B=C,A=j,y[E]=T,y[E+1]=w,y[E+2]=O,y[E+3]=m,E+=4,n++;n--,E-=4,N+=J*(D-1),R=k[n],q=R&255,U=R>>8&255,B=R>>16&255,A=R>>24&255,z=q*M[7],X=U*M[7],V=B*M[7],Y=A*M[7],T=z,w=X,O=V,m=Y,K=q,G=U,C=B,j=A,S=M[2],F=M[3];for(u=D-1;u>=0;u--)Z=K*S+q*F+T*H+z*W,$=G*S+U*F+w*H+X*W,L=C*S+B*F+O*H+V*W,Q=j*S+A*F+m*H+Y*W,z=T,X=w,V=O,Y=m,T=Z,w=$,O=L,m=Q,q=K,U=G,B=C,A=j,R=k[n],K=R&255,G=R>>8&255,C=R>>16&255,j=R>>24&255,R=(y[E]+T<<0)+(y[E+1]+w<<8)+(y[E+2]+O<<16)+(y[E+3]+m<<24),I[N]=R,n--,E-=4,N-=J}}function Xk(k,I,y,M){if(!M)return;var D=new Uint32Array(k.buffer),J=new Uint32Array(D.length),R=new Float32Array(Math.max(I,y)*4),q=Nk(M);Ak(D,J,R,q,I,y,M),Ak(J,D,R,q,y,I,M)}Ck.exports=Xk});var g=4;var wk=2;function _(k,I,y,M,D,J){let R=y/k,q=M/I,U=(2*J+wk+1)/D;if(U>0.5)return[{toWidth:y,toHeight:M}];let B=Math.ceil(Math.log(Math.min(R,q))/Math.log(U));if(B<=1)return[{toWidth:y,toHeight:M}];let A=[];for(let K=0;K<B;K++){let G=Math.round(Math.pow(Math.pow(k,B-K-1)*Math.pow(y,K+1),1/B)),C=Math.round(Math.pow(Math.pow(I,B-K-1)*Math.pow(M,K+1),1/B));A.push({toWidth:G,toHeight:C})}return A}function zk(k,I){let M=new OffscreenCanvas(I.width,I.height).getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");return M.globalCompositeOperation="copy",M.drawImage(k,I.x,I.y,I.width,I.height,0,0,I.width,I.height),M.getImageData(0,0,I.width,I.height).data.buffer}function nk(k,I,y){let M=new Uint8ClampedArray(y.width*y.height*g);for(let D=0;D<y.height;D++){let J=((y.y+D)*I+y.x)*g,R=D*y.width*g;M.set(k.subarray(J,J+y.width*g),R)}return M.buffer}function i(k,I,y){if(k instanceof ImageBitmap)return zk(k,y);else return nk(k,I,y)}var e=0.00001;function a(k){let I=Math.round(k);if(Math.abs(k-I)<e)return I;return Math.floor(k)}function t(k){let I=Math.round(k);if(Math.abs(k-I)<e)return I;return Math.ceil(k)}function r(k,I,y,M,D,J,R,q,U,B,A){let K=M/I,G=D/y,C=a(J*K)-2*R,j=a(J*G)-2*R;if(C<1||j<1)throw new Error("Picsquish error: target tile width/height is too small");let Z,$,L,Q,T,w,O=[];for(Q=0;Q<D;Q+=j)for(L=0;L<M;L+=C){if(Z=L-R,Z<0)Z=0;if(T=L+C+R-Z,Z+T>=M)T=M-Z;if($=Q-R,$<0)$=0;if(w=Q+j+R-$,$+w>=D)w=D-$;let m={toX:Z,toY:$,toWidth:T,toHeight:w,toInnerX:L,toInnerY:Q,toInnerWidth:C,toInnerHeight:j,offsetX:Z/K-a(Z/K),offsetY:$/G-a($/G),scaleX:K,scaleY:G,x:a(Z/K),y:a($/G),width:t(T/K),height:t(w/G),initialSize:J,filterPadding:R,filter:q,unsharpAmount:U,unsharpRadius:B,unsharpThreshold:A},z=i(k,I,m);O.push({tile:z,...m})}return O}async function kk(k){let I,y,M,D,J,R;if(k.image instanceof Blob||k.image instanceof ImageBitmap){let U=k.image instanceof ImageBitmap?k.image:await createImageBitmap(k.image);I=U,y=U.width,M=U.height;let B=k.maxDimension/y,A=k.maxDimension/M,K=Math.min(B,A,1),G=Math.floor(y*K),C=Math.floor(M*K);D=_(y,M,G,C,k.tileOptions.initialSize,k.tileOptions.filterPadding)}else I=k.image.from,y=k.image.fromWidth,M=k.image.fromHeight,D=k.image.stages;J=D[0].toWidth,R=D[0].toHeight;let q=r(I,y,M,J,R,k.tileOptions.initialSize,k.tileOptions.filterPadding,k.tileOptions.filter,k.tileOptions.unsharpAmount,k.tileOptions.unsharpRadius,k.tileOptions.unsharpThreshold);if(I instanceof ImageBitmap)I.close();return{tileTransforms:q,stages:D}}var v={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*(0.54+0.46*Math.cos(I/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/2)/(I/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/3)/(I/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Ok=14;function Ik(k){return Math.round(k*((1<<Ok)-1))}function d(k,I,y,M,D){let J=v[k].fn,R=1/M,q=Math.min(1,M),U=v[k].win/q,B,A,K,G,C,j,Z,$,L,Q,T,w,O,m,z,X,V,Y=Math.floor((U+1)*2),n=new Int16Array((Y+2)*y),N=0,E=!n.subarray||!n.set;for(B=0;B<y;B++){A=(B+0.5)*R+D,K=Math.max(0,Math.floor(A-U)),G=Math.min(I-1,Math.ceil(A+U)),C=G-K+1,j=new Float32Array(C),Z=new Int16Array(C),$=0;for(L=K,Q=0;L<=G;L++,Q++)T=J((L+0.5-A)*q),$+=T,j[Q]=T;w=0;for(Q=0;Q<j.length;Q++)O=j[Q]/$,w+=O,Z[Q]=Ik(O);Z[y>>1]+=Ik(1-w),m=0;while(m<Z.length&&Z[m]===0)m++;if(m<Z.length){z=Z.length-1;while(z>0&&Z[z]===0)z--;if(X=K+m,V=z-m+1,n[N++]=X,n[N++]=V,!E)n.set(Z.subarray(m,z+1),N),N+=V;else for(Q=m;Q<=z;Q++)n[N++]=Z[Q]}else n[N++]=0,n[N++]=0}return n}function P(k){return k<0?0:k>255?255:k}function b(k){return k>=0?k:0}function Mk(k,I,y,M,D,J){let R,q,U,B,A,K,G,C,j,Z,$,L=0,Q=0;for(j=0;j<M;j++){A=0;for(Z=0;Z<D;Z++){K=J[A++],G=J[A++],C=L+K*4|0,R=q=U=B=0;for(;G>0;G--)$=J[A++],B=B+$*k[C+3]|0,U=U+$*k[C+2]|0,q=q+$*k[C+1]|0,R=R+$*k[C]|0,C=C+4|0;I[Q+3]=b(B>>7),I[Q+2]=b(U>>7),I[Q+1]=b(q>>7),I[Q]=b(R>>7),Q=Q+M*4|0}Q=(j+1)*4|0,L=(j+1)*y*4|0}}function Rk(k,I,y,M,D,J){let R,q,U,B,A,K,G,C,j,Z,$,L=0,Q=0;for(j=0;j<M;j++){A=0;for(Z=0;Z<D;Z++){K=J[A++],G=J[A++],C=L+K*4|0,R=q=U=B=0;for(;G>0;G--)$=J[A++],B=B+$*k[C+3]|0,U=U+$*k[C+2]|0,q=q+$*k[C+1]|0,R=R+$*k[C]|0,C=C+4|0;R>>=7,q>>=7,U>>=7,B>>=7,I[Q+3]=P(B+8192>>14),I[Q+2]=P(U+8192>>14),I[Q+1]=P(q+8192>>14),I[Q]=P(R+8192>>14),Q=Q+M*4|0}Q=(j+1)*4|0,L=(j+1)*y*4|0}}function yk(k,I,y,M,D,J){let R,q,U,B,A,K,G,C,j,Z,$,L,Q=0,T=0;for(Z=0;Z<M;Z++){K=0;for($=0;$<D;$++){G=J[K++],C=J[K++],j=Q+G*4|0,R=q=U=B=0;for(;C>0;C--)L=J[K++],A=k[j+3],B=B+L*A|0,U=U+L*k[j+2]*A|0,q=q+L*k[j+1]*A|0,R=R+L*k[j]*A|0,j=j+4|0;U=U/255|0,q=q/255|0,R=R/255|0,I[T+3]=b(B>>7),I[T+2]=b(U>>7),I[T+1]=b(q>>7),I[T]=b(R>>7),T=T+M*4|0}T=(Z+1)*4|0,Q=(Z+1)*y*4|0}}function Dk(k,I,y,M,D,J){let R,q,U,B,A,K,G,C,j,Z,$,L=0,Q=0;for(j=0;j<M;j++){A=0;for(Z=0;Z<D;Z++){K=J[A++],G=J[A++],C=L+K*4|0,R=q=U=B=0;for(;G>0;G--)$=J[A++],B=B+$*k[C+3]|0,U=U+$*k[C+2]|0,q=q+$*k[C+1]|0,R=R+$*k[C]|0,C=C+4|0;if(R>>=7,q>>=7,U>>=7,B>>=7,B=P(B+8192>>14),B>0)R=R*255/B|0,q=q*255/B|0,U=U*255/B|0;I[Q+3]=B,I[Q+2]=P(U+8192>>14),I[Q+1]=P(q+8192>>14),I[Q]=P(R+8192>>14),Q=Q+M*4|0}Q=(j+1)*4|0,L=(j+1)*y*4|0}}function Ek(k,I,y){let M=3,D=I*y*4|0;while(M<D){if(k[M]!==255)return!0;M=M+4|0}return!1}function Vk(k,I,y){let M=3,D=I*y*4|0;while(M<D)k[M]=255,M=M+4|0}function Bk(k,I,y,M,D,J,R,q,U,B){let A=d(I,y,D,R,U),K=d(I,M,J,q,B),G=new Uint8Array(D*J*4),C=new Uint16Array(D*M*4);if(Ek(k,y,M))yk(k,C,y,M,D,A),Dk(C,G,M,D,J,K);else Mk(k,C,y,M,D,A),Rk(C,G,M,D,J,K),Vk(G,D,J);return G}var Kk=Tk(Jk(),1);function Yk(k,I,y){let M=I*y,D=new Uint16Array(M),J,R,q,U;for(let B=0;B<M;B++)J=k[4*B],R=k[4*B+1],q=k[4*B+2],U=J>=R&&J>=q?J:R>=q&&R>=J?R:q,D[B]=U<<8;return D}function Qk(k,I,y,M,D,J){let R,q,U,B,A;if(M===0||D<0.5)return;if(D>2)D=2;let K=Yk(k,I,y),G=new Uint16Array(K);Kk.default(G,I,y,D);let C=M/100*4096+0.5|0,j=J<<8,Z=I*y;for(let $=0;$<Z;$++)if(R=K[$],B=R-G[$],Math.abs(B)>=j)q=R+(C*B+2048>>12),q=q>65280?65280:q,q=q<0?0:q,R=R!==0?R:1,U=(q<<12)/R|0,A=$*4,k[A]=k[A]*U+2048>>12,k[A+1]=k[A+1]*U+2048>>12,k[A+2]=k[A+2]*U+2048>>12}function $k(k){let I=Bk(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Qk(I,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return I}var Sk=async(k)=>{let{taskId:I,squishId:y,taskType:M,image:D,maxDimension:J,tileOptions:R}=k,{tileTransforms:q,stages:U}=await kk({image:D,maxDimension:J,tileOptions:R}),B={taskId:I,squishId:y,taskType:M,output:{tileTransforms:q,stages:U}},A=q.map((K)=>K.tile);self.postMessage(B,A)};function Fk(k){let{taskId:I,squishId:y,taskType:M,tileTransform:D}=k;D.tile=$k(D).buffer;let J={taskId:I,squishId:y,taskType:M,output:{tileTransform:D}};self.postMessage(J,[D.tile])}self.onmessage=async(k)=>{try{switch(k.data.taskType){case 0:return Sk(k.data);case 1:return Fk(k.data)}}catch(I){self.postMessage({taskId:k.data.taskId,squishId:k.data.squishId,taskType:k.data.taskType,error:I})}};
`,Hn=new Blob([Pn],{type:"application/javascript"});class $n{#n;#k;#I;#R;constructor(){this.#n=new Map,this.#k=new Map,this.#I=null,this.#R=null}#T(){if(this.#I===null)return;clearTimeout(this.#I),this.#I=null}prepare(n,k,R){if(this.#n.size)return;this.#R=R;let I=URL.createObjectURL(Hn);while(this.#n.size<k){let M=new Worker(I);M.onmessage=n,this.#n.set(M,null)}URL.revokeObjectURL(I)}assignTask(n,k,R,I){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#T(),n.postMessage(R,I)}setTimeout(){if(this.#I!==null)return;this.#I=setTimeout(()=>{for(let n of this.#n.keys())n.terminate();this.#n.clear(),this.#k.clear()},this.#R||0)}getAvailableWorkers(){let n=[];for(let[k,R]of this.#n.entries())if(R===null)n.push(k);return n}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n)}}var H=new $n;var _=(()=>{let n=0;return()=>++n})();class Zn{#n;#k;#I;constructor(){this.#n=new Map,this.#k=[],this.#I=[]}#R(n,k){let R={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions},I=k.data.image instanceof ImageBitmap?[k.data.image]:[];H.assignTask(n,k,R,I)}#T(n,k){let R={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};H.assignTask(n,k,R,[R.tileTransform.tile])}#m(n){let k=this.#k.shift();if(k)return this.#R(n,k);let R=this.#I.shift();if(R)return this.#T(n,R)}#M(){if(this.#k.length===0&&this.#I.length===0)return H.setTimeout();let k=H.getAvailableWorkers();for(let R of k)this.#m(R)}#y(n,k){let{squishId:R,output:I}=k,M=I.stages[0].toWidth,y=I.stages[0].toHeight;n.to=new Uint8ClampedArray(M*y*a),n.toWidth=M,n.toHeight=y,n.stages=I.stages,n.remainingTileCount=I.tileTransforms.length;for(let T of I.tileTransforms)this.#I.push({id:_(),squishId:R,data:{tileTransform:T}})}#B(n,k){let{squishId:R,output:I}=k;if(!n.to)throw new Error("Picsquish error: squishContext.to not found");if(s(n.to,n.toWidth,I.tileTransform),n.remainingTileCount--,n.remainingTileCount)return;if(n.stages.shift(),n.stages[0])this.#k.push({id:_(),squishId:R,data:{image:{from:n.to,fromWidth:n.toWidth,fromHeight:n.toHeight,stages:n.stages},maxDimension:n.maxDimension,tileOptions:n.tileOptions}});else{let M=new ImageData(n.to,n.toWidth,n.toHeight);createImageBitmap(M).then((y)=>{this.#n.delete(R),n.resolve(y)})}}#D(n){let k=this.#n.get(n.data.squishId);if(!k)throw new Error("Picsquish error: squishContext not found");if(n.data.error)k.reject(n.data.error);switch(n.data.taskType){case 0:this.#y(k,n.data);break;case 1:this.#B(k,n.data);break}H.removeTask(n.data.taskId),this.#M()}add(n,k,R){return H.prepare((I)=>this.#D(I),k,R),new Promise((I,M)=>{let y=_();this.#n.set(y,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:I,reject:M}),this.#k.push({id:y,squishId:y,data:n}),this.#M()})}}var jn=new Zn;async function hn(n,k,R){let I=null,M,y,T;for(;;){let D=await Rn({image:I||n,maxDimension:k,tileOptions:R});y=D.stages[0].toWidth,T=D.stages[0].toHeight,M=new Uint8ClampedArray(y*T*a);for(let m of D.tileTransforms)m.tile=Jn(m).buffer,s(M,y,m);if(D.stages.shift(),I={from:M,fromWidth:y,fromHeight:T,stages:D.stages},!D.stages[0])break}let B=new ImageData(I.from,I.fromWidth,I.fromHeight);return await createImageBitmap(B)}async function Pk(n,k,R={}){let I=R.tileSize||1024,M=R.filter||"mks2013",y=R.unsharpAmount||0,T=R.unsharpRadius||0,B=R.unsharpThreshold||0,D=R.useMainThread,m=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,A=R.maxWorkerPoolSize||Math.min(m,4),w=R.maxWorkerIdleTime||2000,q=3,U=Math.ceil(Math.max(3,2.5*T|0)),Q={initialSize:I,filterPadding:U,filter:M,unsharpAmount:y,unsharpRadius:T,unsharpThreshold:B};if(D)return await hn(n,k,Q);return jn.add({image:n,maxDimension:k,tileOptions:Q},A,w)}export{Pk as squish};
