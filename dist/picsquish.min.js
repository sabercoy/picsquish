var Ln=Object.create;var{getPrototypeOf:jn,defineProperty:_,getOwnPropertyNames:Gn}=Object;var wn=Object.prototype.hasOwnProperty;var En=(n,k,I)=>{I=n!=null?Ln(jn(n)):{};let T=k||!n||!n.__esModule?_(I,"default",{value:n,enumerable:!0}):I;for(let m of Gn(n))if(!wn.call(T,m))_(T,m,{get:()=>n[m],enumerable:!0});return T};var zn=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Bn=zn((kk,Un)=>{var v,f,c,l,s,g,yn,An;function Yn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,I=Math.exp(-k),T=Math.exp(-2*k),m=(1-I)*(1-I)/(1+2*k*I-T);return v=m,f=m*(k-1)*I,c=m*(k+1)*I,l=-m*T,s=2*I,g=-T,yn=(v+f)/(1-s-g),An=(c+l)/(1-s-g),new Float32Array([v,f,c,l,s,g,yn,An])}function Cn(n,k,I,T,m,y){var M,R,D,q,C,A,B,U,J,$,Q,Z,K,L,G,z,j,w,Y,X,W,E,V,u,o,a,S,O,F,H;for(o=0;o<y;o++){E=o*m,V=o,u=0,M=n[E],R=M&255,D=M>>8&255,q=M>>16&255,C=M>>24&255,w=R*T[6],Y=D*T[6],X=q*T[6],W=C*T[6],L=w,G=Y,z=X,j=W,S=T[0],O=T[1],F=T[4],H=T[5];for(a=0;a<m;a++)M=n[E],A=M&255,B=M>>8&255,U=M>>16&255,J=M>>24&255,$=A*S+R*O+L*F+w*H,Q=B*S+D*O+G*F+Y*H,Z=U*S+q*O+z*F+X*H,K=J*S+C*O+j*F+W*H,w=L,Y=G,X=z,W=j,L=$,G=Q,z=Z,j=K,R=A,D=B,q=U,C=J,I[u]=L,I[u+1]=G,I[u+2]=z,I[u+3]=j,u+=4,E++;E--,u-=4,V+=y*(m-1),M=n[E],R=M&255,D=M>>8&255,q=M>>16&255,C=M>>24&255,w=R*T[7],Y=D*T[7],X=q*T[7],W=C*T[7],L=w,G=Y,z=X,j=W,A=R,B=D,U=q,J=C,S=T[2],O=T[3];for(a=m-1;a>=0;a--)$=A*S+R*O+L*F+w*H,Q=B*S+D*O+G*F+Y*H,Z=U*S+q*O+z*F+X*H,K=J*S+C*O+j*F+W*H,w=L,Y=G,X=z,W=j,L=$,G=Q,z=Z,j=K,R=A,D=B,q=U,C=J,M=n[E],A=M&255,B=M>>8&255,U=M>>16&255,J=M>>24&255,M=(I[u]+L<<0)+(I[u+1]+G<<8)+(I[u+2]+z<<16)+(I[u+3]+j<<24),k[V]=M,E--,u-=4,V-=y}}function Wn(n,k,I,T){if(!T)return;var m=new Uint32Array(n.buffer),y=new Uint32Array(m.length),M=new Float32Array(Math.max(k,I)*4),R=Yn(T);Cn(m,y,M,R,k,I,T),Cn(y,m,M,R,I,k,T)}Un.exports=Wn});var N=4;var un=2;function t(n,k,I,T,m,y){let M=I/n,R=T/k,D=(2*y+un+1)/m;if(D>0.5)return[{toWidth:I,toHeight:T}];let q=Math.ceil(Math.log(Math.min(M,R))/Math.log(D));if(q<=1)return[{toWidth:I,toHeight:T}];let C=[];for(let A=0;A<q;A++){let B=Math.round(Math.pow(Math.pow(n,q-A-1)*Math.pow(I,A+1),1/q)),U=Math.round(Math.pow(Math.pow(k,q-A-1)*Math.pow(T,A+1),1/q));C.push({toWidth:B,toHeight:U})}return C}function e(n,k,I){let T=new Uint8ClampedArray(I.width*I.height*N);for(let m=0;m<I.height;m++){let y=((I.y+m)*k+I.x)*N,M=m*I.width*N;T.set(n.subarray(y,y+I.width*N),M)}return T}var nn=0.00001;function b(n){let k=Math.round(n);if(Math.abs(n-k)<nn)return k;return Math.floor(n)}function r(n){let k=Math.round(n);if(Math.abs(n-k)<nn)return k;return Math.ceil(n)}function kn(n,k,I,T,m,y,M,R,D,q,C){let A=T/k,B=m/I,U=b(y*A)-2*M,J=b(y*B)-2*M;if(U<1||J<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let $,Q,Z,K,L,G,z=[];for(K=0;K<m;K+=J)for(Z=0;Z<T;Z+=U){if($=Z-M,$<0)$=0;if(L=Z+U+M-$,$+L>=T)L=T-$;if(Q=K-M,Q<0)Q=0;if(G=K+J+M-Q,Q+G>=m)G=m-Q;let j={toX:$,toY:Q,toWidth:L,toHeight:G,toInnerX:Z,toInnerY:K,toInnerWidth:U,toInnerHeight:J,offsetX:$/A-b($/A),offsetY:Q/B-b(Q/B),scaleX:A,scaleY:B,x:b($/A),y:b(Q/B),width:r(L/A),height:r(G/B),initialSize:y,filterPadding:M,filter:R,unsharpAmount:D,unsharpRadius:q,unsharpThreshold:C},w=e(n,k,j);z.push({tile:w.buffer,...j})}return z}async function In(n){let k,I,T,m,y,M;if(n.image instanceof Blob){let D=await createImageBitmap(n.image),C=new OffscreenCanvas(D.width,D.height).getContext("2d");if(!C)throw new Error("Canvas 2D context not supported");C.drawImage(D,0,0),k=C.getImageData(0,0,D.width,D.height).data,I=D.width,T=D.height,D.close();let B=n.maxDimension/I,U=n.maxDimension/T,J=Math.min(B,U,1),$=Math.floor(I*J),Q=Math.floor(T*J);M=t(I,T,$,Q,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,I=n.image.fromWidth,T=n.image.fromHeight,M=n.image.stages;m=M[0].toWidth,y=M[0].toHeight;let R=kn(k,I,T,m,y,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);return{from:k.buffer,fromWidth:I,fromHeight:T,tileTransforms:R,stages:M}}function x(n,k,I){let T=new Uint8ClampedArray(I.tile);for(let m=0;m<I.toHeight;m++){let y=m*I.toWidth*N,M=((I.toY+m)*k+I.toX)*N;n.set(T.subarray(y,y+I.toWidth*N),M)}}var p={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Nn=14;function Tn(n){return Math.round(n*((1<<Nn)-1))}function d(n,k,I,T,m){let y=p[n].fn,M=1/T,R=Math.min(1,T),D=p[n].win/R,q,C,A,B,U,J,$,Q,Z,K,L,G,z,j,w,Y,X,W=Math.floor((D+1)*2),E=new Int16Array((W+2)*I),V=0,u=!E.subarray||!E.set;for(q=0;q<I;q++){C=(q+0.5)*M+m,A=Math.max(0,Math.floor(C-D)),B=Math.min(k-1,Math.ceil(C+D)),U=B-A+1,J=new Float32Array(U),$=new Int16Array(U),Q=0;for(Z=A,K=0;Z<=B;Z++,K++)L=y((Z+0.5-C)*R),Q+=L,J[K]=L;G=0;for(K=0;K<J.length;K++)z=J[K]/Q,G+=z,$[K]=Tn(z);$[I>>1]+=Tn(1-G),j=0;while(j<$.length&&$[j]===0)j++;if(j<$.length){w=$.length-1;while(w>0&&$[w]===0)w--;if(Y=A+j,X=w-j+1,E[V++]=Y,E[V++]=X,!u)E.set($.subarray(j,w+1),V),V+=X;else for(K=j;K<=w;K++)E[V++]=$[K]}else E[V++]=0,E[V++]=0}return E}function P(n){return n<0?0:n>255?255:n}function h(n){return n>=0?n:0}function Mn(n,k,I,T,m,y){let M,R,D,q,C,A,B,U,J,$,Q,Z=0,K=0;for(J=0;J<T;J++){C=0;for($=0;$<m;$++){A=y[C++],B=y[C++],U=Z+A*4|0,M=R=D=q=0;for(;B>0;B--)Q=y[C++],q=q+Q*n[U+3]|0,D=D+Q*n[U+2]|0,R=R+Q*n[U+1]|0,M=M+Q*n[U]|0,U=U+4|0;k[K+3]=h(q>>7),k[K+2]=h(D>>7),k[K+1]=h(R>>7),k[K]=h(M>>7),K=K+T*4|0}K=(J+1)*4|0,Z=(J+1)*I*4|0}}function mn(n,k,I,T,m,y){let M,R,D,q,C,A,B,U,J,$,Q,Z=0,K=0;for(J=0;J<T;J++){C=0;for($=0;$<m;$++){A=y[C++],B=y[C++],U=Z+A*4|0,M=R=D=q=0;for(;B>0;B--)Q=y[C++],q=q+Q*n[U+3]|0,D=D+Q*n[U+2]|0,R=R+Q*n[U+1]|0,M=M+Q*n[U]|0,U=U+4|0;M>>=7,R>>=7,D>>=7,q>>=7,k[K+3]=P(q+8192>>14),k[K+2]=P(D+8192>>14),k[K+1]=P(R+8192>>14),k[K]=P(M+8192>>14),K=K+T*4|0}K=(J+1)*4|0,Z=(J+1)*I*4|0}}function Rn(n,k,I,T,m,y){let M,R,D,q,C,A,B,U,J,$,Q,Z,K=0,L=0;for($=0;$<T;$++){A=0;for(Q=0;Q<m;Q++){B=y[A++],U=y[A++],J=K+B*4|0,M=R=D=q=0;for(;U>0;U--)Z=y[A++],C=n[J+3],q=q+Z*C|0,D=D+Z*n[J+2]*C|0,R=R+Z*n[J+1]*C|0,M=M+Z*n[J]*C|0,J=J+4|0;D=D/255|0,R=R/255|0,M=M/255|0,k[L+3]=h(q>>7),k[L+2]=h(D>>7),k[L+1]=h(R>>7),k[L]=h(M>>7),L=L+T*4|0}L=($+1)*4|0,K=($+1)*I*4|0}}function Dn(n,k,I,T,m,y){let M,R,D,q,C,A,B,U,J,$,Q,Z=0,K=0;for(J=0;J<T;J++){C=0;for($=0;$<m;$++){A=y[C++],B=y[C++],U=Z+A*4|0,M=R=D=q=0;for(;B>0;B--)Q=y[C++],q=q+Q*n[U+3]|0,D=D+Q*n[U+2]|0,R=R+Q*n[U+1]|0,M=M+Q*n[U]|0,U=U+4|0;if(M>>=7,R>>=7,D>>=7,q>>=7,q=P(q+8192>>14),q>0)M=M*255/q|0,R=R*255/q|0,D=D*255/q|0;k[K+3]=q,k[K+2]=P(D+8192>>14),k[K+1]=P(R+8192>>14),k[K]=P(M+8192>>14),K=K+T*4|0}K=(J+1)*4|0,Z=(J+1)*I*4|0}}function Xn(n,k,I){let T=3,m=k*I*4|0;while(T<m){if(n[T]!==255)return!0;T=T+4|0}return!1}function Vn(n,k,I){let T=3,m=k*I*4|0;while(T<m)n[T]=255,T=T+4|0}function qn(n,k,I,T,m,y,M,R,D,q){let C=d(k,I,m,M,D),A=d(k,T,y,R,q),B=new Uint8Array(m*y*4),U=new Uint16Array(m*T*4);if(Xn(n,I,T))Rn(n,U,I,T,m,C),Dn(U,B,T,m,y,A);else Mn(n,U,I,T,m,C),mn(U,B,T,m,y,A),Vn(B,m,y);return B}var Kn=En(Bn(),1);function Sn(n,k,I){let T=k*I,m=new Uint16Array(T),y,M,R,D;for(let q=0;q<T;q++)y=n[4*q],M=n[4*q+1],R=n[4*q+2],D=y>=M&&y>=R?y:M>=R&&M>=y?M:R,m[q]=D<<8;return m}function Qn(n,k,I,T,m,y){let M,R,D,q,C;if(T===0||m<0.5)return;if(m>2)m=2;let A=Sn(n,k,I),B=new Uint16Array(A);Kn.default(B,k,I,m);let U=T/100*4096+0.5|0,J=y<<8,$=k*I;for(let Q=0;Q<$;Q++)if(M=A[Q],q=M-B[Q],Math.abs(q)>=J)R=M+(U*q+2048>>12),R=R>65280?65280:R,R=R<0?0:R,M=M!==0?M:1,D=(R<<12)/M|0,C=Q*4,n[C]=n[C]*D+2048>>12,n[C+1]=n[C+1]*D+2048>>12,n[C+2]=n[C+2]*D+2048>>12}function Jn(n){let k=qn(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)Qn(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}var $n=(()=>{let n=0;return()=>++n})();class Zn{#n;#T;#k;#M;constructor(){this.#n=new Map,this.#T=new Map,this.#k=new Map,this.#M=new Map}get count(){return this.#n.size}#m(n){clearTimeout(this.#T.get(n))}#I(n,k,I,T){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#M.set(k.id,k),n.postMessage(I,T),this.#m(n)}assignPriority1Task(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions};this.#I(n,k,I,[])}assignPriority2Task(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};this.#I(n,k,I,[I.tileTransform.tile])}setWorkerTimeout(n,k){let I=setTimeout(()=>{let T=this.#n.get(n);if(T)this.#k.delete(T);if(T)this.#M.delete(T);this.#T.delete(n),this.#n.delete(n),n.terminate()},k);this.#T.set(n,I)}addWorker(n){this.#n.set(n,null)}getWorker(n){return this.#k.get(n)}getTask(n){return this.#M.get(n)}getAvailableWorker(){for(let[n,k]of this.#n.entries())if(k===null)return n;return null}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n),this.#M.delete(n)}}class i{#n;#T;#k;#M;#m;#I;constructor(n,k){this.#T=n,this.#n=k,this.#k=new Map,this.#M=[],this.#m=[],this.#I=new Zn}#D(){let n=new Worker(new URL("./picsquish-worker.js",import.meta.url));n.onmessage=(k)=>{let I=this.#k.get(k.data.squishId);if(!I)throw new Error("SquishContext not found");if(k.data.error)I.reject(k.data.error);if(k.data.taskType===0){let{squishId:m,output:y}=k.data,M=y.stages[0].toWidth,R=y.stages[0].toHeight;I.from=new Uint8ClampedArray(y.from),I.fromWidth=y.fromWidth,I.fromHeight=y.fromHeight,I.to=new Uint8ClampedArray(M*R*N),I.toWidth=M,I.toHeight=R,I.stages=y.stages,I.remainingTileCount=y.tileTransforms.length;for(let D of y.tileTransforms)this.#m.push({id:$n(),squishId:m,data:{tileTransform:D}}),this.#R()}if(k.data.taskType===1){let{taskId:m,squishId:y,output:M}=k.data;if(!I.to)throw new Error("SquishContext to not found");if(x(I.to,I.toWidth,M.tileTransform),I.remainingTileCount--,!I.remainingTileCount)if(I.stages.shift(),I.stages[0])this.#M.push({id:m,squishId:y,data:{image:{from:I.to,fromWidth:I.toWidth,fromHeight:I.toHeight,stages:I.stages},maxDimension:I.maxDimension,tileOptions:I.tileOptions}});else{let R=new ImageData(I.to,I.toWidth,I.toHeight);createImageBitmap(R).then((D)=>{this.#k.delete(k.data.squishId),I.resolve(D)})}}let T=this.#I.getWorker(k.data.taskId);if(T)this.#I.setWorkerTimeout(T,this.#n);this.#I.removeTask(k.data.taskId),this.#R()},this.#I.addWorker(n)}#R(){let n=this.#I.getAvailableWorker();if(n){let k=this.#M.shift();if(k)return this.#I.assignPriority1Task(n,k);let I=this.#m.shift();if(I)return this.#I.assignPriority2Task(n,I)}else if(this.#I.count<this.#T)this.#D(),this.#R()}add(n){return new Promise((k,I)=>{let T=$n();this.#k.set(T,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:k,reject:I}),this.#M.push({id:T,squishId:T,data:n}),this.#R()})}}class On{#n;#T;constructor(n){let k=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,I=n.maxWorkerPoolSize||Math.min(k,4),T=n.maxWorkerIdleTime||2000;this.#n=new i(I,T),this.#T=n}async#k(n,k,I){let T=null,m,y,M,R,D,q;for(;;){let A=await In({image:T||n,maxDimension:k,tileOptions:I});m=new Uint8ClampedArray(A.from),y=A.fromWidth,M=A.fromHeight,D=A.stages[0].toWidth,q=A.stages[0].toHeight,R=new Uint8ClampedArray(D*q*N);for(let B of A.tileTransforms)B.tile=Jn(B).buffer,x(R,D,B);if(A.stages.shift(),T={from:R,fromWidth:D,fromHeight:q,stages:A.stages},!A.stages[0])break}let C=new ImageData(T.from,T.fromWidth,T.fromHeight);return await createImageBitmap(C)}async squish(n,k){let I=k?{...this.#T,...k}:this.#T,T=I.maxDimension,m=I.tileSize||1024,y=I.filter||"mks2013",M=I.unsharpAmount||0,R=I.unsharpRadius||0,D=I.unsharpThreshold||0,q=I.useMainThread,C=3,A=Math.ceil(Math.max(3,2.5*R|0)),B={initialSize:m,filterPadding:A,filter:y,unsharpAmount:M,unsharpRadius:R,unsharpThreshold:D};if(q)return await this.#k(n,T,B);return this.#n.add({image:n,maxDimension:T,tileOptions:B})}}export{On as PicSquish};
