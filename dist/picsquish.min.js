var jn=Object.create;var{getPrototypeOf:Gn,defineProperty:_,getOwnPropertyNames:wn}=Object;var En=Object.prototype.hasOwnProperty;var zn=(n,k,I)=>{I=n!=null?jn(Gn(n)):{};let T=k||!n||!n.__esModule?_(I,"default",{value:n,enumerable:!0}):I;for(let R of wn(n))if(!En.call(T,R))_(T,R,{get:()=>n[R],enumerable:!0});return T};var un=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Kn=un((Ik,Bn)=>{var v,f,l,c,s,g,An,Cn;function Wn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,I=Math.exp(-k),T=Math.exp(-2*k),R=(1-I)*(1-I)/(1+2*k*I-T);return v=R,f=R*(k-1)*I,l=R*(k+1)*I,c=-R*T,s=2*I,g=-T,An=(v+f)/(1-s-g),Cn=(l+c)/(1-s-g),new Float32Array([v,f,l,c,s,g,An,Cn])}function Un(n,k,I,T,R,y){var M,m,D,q,C,A,B,U,$,J,Q,L,K,Z,G,z,j,w,Y,X,W,E,V,u,o,a,S,O,F,H;for(o=0;o<y;o++){E=o*R,V=o,u=0,M=n[E],m=M&255,D=M>>8&255,q=M>>16&255,C=M>>24&255,w=m*T[6],Y=D*T[6],X=q*T[6],W=C*T[6],Z=w,G=Y,z=X,j=W,S=T[0],O=T[1],F=T[4],H=T[5];for(a=0;a<R;a++)M=n[E],A=M&255,B=M>>8&255,U=M>>16&255,$=M>>24&255,J=A*S+m*O+Z*F+w*H,Q=B*S+D*O+G*F+Y*H,L=U*S+q*O+z*F+X*H,K=$*S+C*O+j*F+W*H,w=Z,Y=G,X=z,W=j,Z=J,G=Q,z=L,j=K,m=A,D=B,q=U,C=$,I[u]=Z,I[u+1]=G,I[u+2]=z,I[u+3]=j,u+=4,E++;E--,u-=4,V+=y*(R-1),M=n[E],m=M&255,D=M>>8&255,q=M>>16&255,C=M>>24&255,w=m*T[7],Y=D*T[7],X=q*T[7],W=C*T[7],Z=w,G=Y,z=X,j=W,A=m,B=D,U=q,$=C,S=T[2],O=T[3];for(a=R-1;a>=0;a--)J=A*S+m*O+Z*F+w*H,Q=B*S+D*O+G*F+Y*H,L=U*S+q*O+z*F+X*H,K=$*S+C*O+j*F+W*H,w=Z,Y=G,X=z,W=j,Z=J,G=Q,z=L,j=K,m=A,D=B,q=U,C=$,M=n[E],A=M&255,B=M>>8&255,U=M>>16&255,$=M>>24&255,M=(I[u]+Z<<0)+(I[u+1]+G<<8)+(I[u+2]+z<<16)+(I[u+3]+j<<24),k[V]=M,E--,u-=4,V-=y}}function Sn(n,k,I,T){if(!T)return;var R=new Uint32Array(n.buffer),y=new Uint32Array(R.length),M=new Float32Array(Math.max(k,I)*4),m=Wn(T);Un(R,y,M,m,k,I,T),Un(y,R,M,m,I,k,T)}Bn.exports=Sn});var t="picsquish-worker";var N=4;var Nn=2;function e(n,k,I,T,R,y){let M=I/n,m=T/k,D=(2*y+Nn+1)/R;if(D>0.5)return[{toWidth:I,toHeight:T}];let q=Math.ceil(Math.log(Math.min(M,m))/Math.log(D));if(q<=1)return[{toWidth:I,toHeight:T}];let C=[];for(let A=0;A<q;A++){let B=Math.round(Math.pow(Math.pow(n,q-A-1)*Math.pow(I,A+1),1/q)),U=Math.round(Math.pow(Math.pow(k,q-A-1)*Math.pow(T,A+1),1/q));C.push({toWidth:B,toHeight:U})}return C}function r(n,k,I){let T=new Uint8ClampedArray(I.width*I.height*N);for(let R=0;R<I.height;R++){let y=((I.y+R)*k+I.x)*N,M=R*I.width*N;T.set(n.subarray(y,y+I.width*N),M)}return T}var kn=0.00001;function b(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.floor(n)}function nn(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.ceil(n)}function In(n,k,I,T,R,y,M,m,D,q,C){let A=T/k,B=R/I,U=b(y*A)-2*M,$=b(y*B)-2*M;if(U<1||$<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let J,Q,L,K,Z,G,z=[];for(K=0;K<R;K+=$)for(L=0;L<T;L+=U){if(J=L-M,J<0)J=0;if(Z=L+U+M-J,J+Z>=T)Z=T-J;if(Q=K-M,Q<0)Q=0;if(G=K+$+M-Q,Q+G>=R)G=R-Q;let j={toX:J,toY:Q,toWidth:Z,toHeight:G,toInnerX:L,toInnerY:K,toInnerWidth:U,toInnerHeight:$,offsetX:J/A-b(J/A),offsetY:Q/B-b(Q/B),scaleX:A,scaleY:B,x:b(J/A),y:b(Q/B),width:nn(Z/A),height:nn(G/B),initialSize:y,filterPadding:M,filter:m,unsharpAmount:D,unsharpRadius:q,unsharpThreshold:C},w=r(n,k,j);z.push({tile:w.buffer,...j})}return z}async function Tn(n){let k,I,T,R,y,M;if(n.image instanceof Blob){let D=await createImageBitmap(n.image),C=new OffscreenCanvas(D.width,D.height).getContext("2d");if(!C)throw new Error("Canvas 2D context not supported");C.drawImage(D,0,0),k=C.getImageData(0,0,D.width,D.height).data,I=D.width,T=D.height,D.close();let B=n.maxDimension/I,U=n.maxDimension/T,$=Math.min(B,U,1),J=Math.floor(I*$),Q=Math.floor(T*$);M=e(I,T,J,Q,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,I=n.image.fromWidth,T=n.image.fromHeight,M=n.image.stages;R=M[0].toWidth,y=M[0].toHeight;let m=In(k,I,T,R,y,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);return{from:k.buffer,fromWidth:I,fromHeight:T,tileTransforms:m,stages:M}}function x(n,k,I){let T=new Uint8ClampedArray(I.tile);for(let R=0;R<I.toHeight;R++){let y=R*I.toWidth*N,M=((I.toY+R)*k+I.toX)*N;n.set(T.subarray(y,y+I.toWidth*N),M)}}var p={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Xn=14;function Mn(n){return Math.round(n*((1<<Xn)-1))}function d(n,k,I,T,R){let y=p[n].fn,M=1/T,m=Math.min(1,T),D=p[n].win/m,q,C,A,B,U,$,J,Q,L,K,Z,G,z,j,w,Y,X,W=Math.floor((D+1)*2),E=new Int16Array((W+2)*I),V=0,u=!E.subarray||!E.set;for(q=0;q<I;q++){C=(q+0.5)*M+R,A=Math.max(0,Math.floor(C-D)),B=Math.min(k-1,Math.ceil(C+D)),U=B-A+1,$=new Float32Array(U),J=new Int16Array(U),Q=0;for(L=A,K=0;L<=B;L++,K++)Z=y((L+0.5-C)*m),Q+=Z,$[K]=Z;G=0;for(K=0;K<$.length;K++)z=$[K]/Q,G+=z,J[K]=Mn(z);J[I>>1]+=Mn(1-G),j=0;while(j<J.length&&J[j]===0)j++;if(j<J.length){w=J.length-1;while(w>0&&J[w]===0)w--;if(Y=A+j,X=w-j+1,E[V++]=Y,E[V++]=X,!u)E.set(J.subarray(j,w+1),V),V+=X;else for(K=j;K<=w;K++)E[V++]=J[K]}else E[V++]=0,E[V++]=0}return E}function P(n){return n<0?0:n>255?255:n}function h(n){return n>=0?n:0}function Rn(n,k,I,T,R,y){let M,m,D,q,C,A,B,U,$,J,Q,L=0,K=0;for($=0;$<T;$++){C=0;for(J=0;J<R;J++){A=y[C++],B=y[C++],U=L+A*4|0,M=m=D=q=0;for(;B>0;B--)Q=y[C++],q=q+Q*n[U+3]|0,D=D+Q*n[U+2]|0,m=m+Q*n[U+1]|0,M=M+Q*n[U]|0,U=U+4|0;k[K+3]=h(q>>7),k[K+2]=h(D>>7),k[K+1]=h(m>>7),k[K]=h(M>>7),K=K+T*4|0}K=($+1)*4|0,L=($+1)*I*4|0}}function mn(n,k,I,T,R,y){let M,m,D,q,C,A,B,U,$,J,Q,L=0,K=0;for($=0;$<T;$++){C=0;for(J=0;J<R;J++){A=y[C++],B=y[C++],U=L+A*4|0,M=m=D=q=0;for(;B>0;B--)Q=y[C++],q=q+Q*n[U+3]|0,D=D+Q*n[U+2]|0,m=m+Q*n[U+1]|0,M=M+Q*n[U]|0,U=U+4|0;M>>=7,m>>=7,D>>=7,q>>=7,k[K+3]=P(q+8192>>14),k[K+2]=P(D+8192>>14),k[K+1]=P(m+8192>>14),k[K]=P(M+8192>>14),K=K+T*4|0}K=($+1)*4|0,L=($+1)*I*4|0}}function Dn(n,k,I,T,R,y){let M,m,D,q,C,A,B,U,$,J,Q,L,K=0,Z=0;for(J=0;J<T;J++){A=0;for(Q=0;Q<R;Q++){B=y[A++],U=y[A++],$=K+B*4|0,M=m=D=q=0;for(;U>0;U--)L=y[A++],C=n[$+3],q=q+L*C|0,D=D+L*n[$+2]*C|0,m=m+L*n[$+1]*C|0,M=M+L*n[$]*C|0,$=$+4|0;D=D/255|0,m=m/255|0,M=M/255|0,k[Z+3]=h(q>>7),k[Z+2]=h(D>>7),k[Z+1]=h(m>>7),k[Z]=h(M>>7),Z=Z+T*4|0}Z=(J+1)*4|0,K=(J+1)*I*4|0}}function qn(n,k,I,T,R,y){let M,m,D,q,C,A,B,U,$,J,Q,L=0,K=0;for($=0;$<T;$++){C=0;for(J=0;J<R;J++){A=y[C++],B=y[C++],U=L+A*4|0,M=m=D=q=0;for(;B>0;B--)Q=y[C++],q=q+Q*n[U+3]|0,D=D+Q*n[U+2]|0,m=m+Q*n[U+1]|0,M=M+Q*n[U]|0,U=U+4|0;if(M>>=7,m>>=7,D>>=7,q>>=7,q=P(q+8192>>14),q>0)M=M*255/q|0,m=m*255/q|0,D=D*255/q|0;k[K+3]=q,k[K+2]=P(D+8192>>14),k[K+1]=P(m+8192>>14),k[K]=P(M+8192>>14),K=K+T*4|0}K=($+1)*4|0,L=($+1)*I*4|0}}function Vn(n,k,I){let T=3,R=k*I*4|0;while(T<R){if(n[T]!==255)return!0;T=T+4|0}return!1}function Yn(n,k,I){let T=3,R=k*I*4|0;while(T<R)n[T]=255,T=T+4|0}function yn(n,k,I,T,R,y,M,m,D,q){let C=d(k,I,R,M,D),A=d(k,T,y,m,q),B=new Uint8Array(R*y*4),U=new Uint16Array(R*T*4);if(Vn(n,I,T))Dn(n,U,I,T,R,C),qn(U,B,T,R,y,A);else Rn(n,U,I,T,R,C),mn(U,B,T,R,y,A),Yn(B,R,y);return B}var Qn=zn(Kn(),1);function On(n,k,I){let T=k*I,R=new Uint16Array(T),y,M,m,D;for(let q=0;q<T;q++)y=n[4*q],M=n[4*q+1],m=n[4*q+2],D=y>=M&&y>=m?y:M>=m&&M>=y?M:m,R[q]=D<<8;return R}function $n(n,k,I,T,R,y){let M,m,D,q,C;if(T===0||R<0.5)return;if(R>2)R=2;let A=On(n,k,I),B=new Uint16Array(A);Qn.default(B,k,I,R);let U=T/100*4096+0.5|0,$=y<<8,J=k*I;for(let Q=0;Q<J;Q++)if(M=A[Q],q=M-B[Q],Math.abs(q)>=$)m=M+(U*q+2048>>12),m=m>65280?65280:m,m=m<0?0:m,M=M!==0?M:1,D=(m<<12)/M|0,C=Q*4,n[C]=n[C]*D+2048>>12,n[C+1]=n[C+1]*D+2048>>12,n[C+2]=n[C+2]*D+2048>>12}function Jn(n){let k=yn(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)$n(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}var Ln=(()=>{let n=0;return()=>++n})();class Zn{#n;#T;#k;#M;constructor(){this.#n=new Map,this.#T=new Map,this.#k=new Map,this.#M=new Map}get count(){return this.#n.size}#R(n){clearTimeout(this.#T.get(n))}#I(n,k,I,T){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#M.set(k.id,k),n.postMessage(I,T),this.#R(n)}assignPriority1Task(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions};this.#I(n,k,I,[])}assignPriority2Task(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};this.#I(n,k,I,[I.tileTransform.tile])}setWorkerTimeout(n,k){let I=setTimeout(()=>{let T=this.#n.get(n);if(T)this.#k.delete(T);if(T)this.#M.delete(T);this.#T.delete(n),this.#n.delete(n),n.terminate()},k);this.#T.set(n,I)}addWorker(n){this.#n.set(n,null)}getWorker(n){return this.#k.get(n)}getTask(n){return this.#M.get(n)}getAvailableWorker(){for(let[n,k]of this.#n.entries())if(k===null)return n;return null}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n),this.#M.delete(n)}}class i{#n;#T;#k;#M;#R;#I;constructor(n,k){this.#T=n,this.#n=k,this.#k=new Map,this.#M=[],this.#R=[],this.#I=new Zn}#D(){let n=new Worker(new URL(`./${t}.js`,import.meta.url));n.onmessage=(k)=>{let I=this.#k.get(k.data.squishId);if(!I)throw new Error("SquishContext not found");if(k.data.error)I.reject(k.data.error);if(k.data.taskType===0){let{squishId:R,output:y}=k.data,M=y.stages[0].toWidth,m=y.stages[0].toHeight;I.from=new Uint8ClampedArray(y.from),I.fromWidth=y.fromWidth,I.fromHeight=y.fromHeight,I.to=new Uint8ClampedArray(M*m*N),I.toWidth=M,I.toHeight=m,I.stages=y.stages,I.remainingTileCount=y.tileTransforms.length;for(let D of y.tileTransforms)this.#R.push({id:Ln(),squishId:R,data:{tileTransform:D}}),this.#m()}if(k.data.taskType===1){let{taskId:R,squishId:y,output:M}=k.data;if(!I.to)throw new Error("SquishContext to not found");if(x(I.to,I.toWidth,M.tileTransform),I.remainingTileCount--,!I.remainingTileCount)if(I.stages.shift(),I.stages[0])this.#M.push({id:R,squishId:y,data:{image:{from:I.to,fromWidth:I.toWidth,fromHeight:I.toHeight,stages:I.stages},maxDimension:I.maxDimension,tileOptions:I.tileOptions}});else{let m=new ImageData(I.to,I.toWidth,I.toHeight);createImageBitmap(m).then((D)=>{this.#k.delete(k.data.squishId),I.resolve(D)})}}let T=this.#I.getWorker(k.data.taskId);if(T)this.#I.setWorkerTimeout(T,this.#n);this.#I.removeTask(k.data.taskId),this.#m()},this.#I.addWorker(n)}#m(){let n=this.#I.getAvailableWorker();if(n){let k=this.#M.shift();if(k)return this.#I.assignPriority1Task(n,k);let I=this.#R.shift();if(I)return this.#I.assignPriority2Task(n,I)}else if(this.#I.count<this.#T)this.#D(),this.#m()}add(n){return new Promise((k,I)=>{let T=Ln();this.#k.set(T,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:k,reject:I}),this.#M.push({id:T,squishId:T,data:n}),this.#m()})}}class Fn{#n;#T;constructor(n){let k=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,I=n.maxWorkerPoolSize||Math.min(k,4),T=n.maxWorkerIdleTime||2000;this.#n=new i(I,T),this.#T=n}async#k(n,k,I){let T=null,R,y,M,m,D,q;for(;;){let A=await Tn({image:T||n,maxDimension:k,tileOptions:I});R=new Uint8ClampedArray(A.from),y=A.fromWidth,M=A.fromHeight,D=A.stages[0].toWidth,q=A.stages[0].toHeight,m=new Uint8ClampedArray(D*q*N);for(let B of A.tileTransforms)B.tile=Jn(B).buffer,x(m,D,B);if(A.stages.shift(),T={from:m,fromWidth:D,fromHeight:q,stages:A.stages},!A.stages[0])break}let C=new ImageData(T.from,T.fromWidth,T.fromHeight);return await createImageBitmap(C)}async squish(n,k){let I=k?{...this.#T,...k}:this.#T,T=I.maxDimension,R=I.tileSize||1024,y=I.filter||"mks2013",M=I.unsharpAmount||0,m=I.unsharpRadius||0,D=I.unsharpThreshold||0,q=I.useMainThread,C=3,A=Math.ceil(Math.max(3,2.5*m|0)),B={initialSize:R,filterPadding:A,filter:y,unsharpAmount:M,unsharpRadius:m,unsharpThreshold:D};if(q)return await this.#k(n,T,B);return this.#n.add({image:n,maxDimension:T,tileOptions:B})}}export{Fn as PicSquish};
