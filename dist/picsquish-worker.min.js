var LM=Object.create;var{getPrototypeOf:jM,defineProperty:l,getOwnPropertyNames:kM}=Object;var yM=Object.prototype.hasOwnProperty;var zM=(M,R,U)=>{U=M!=null?LM(jM(M)):{};let D=R||!M||!M.__esModule?l(U,"default",{value:M,enumerable:!0}):U;for(let q of kM(M))if(!yM.call(D,q))l(D,q,{get:()=>M[q],enumerable:!0});return D};var EM=(M,R)=>()=>(R||M((R={exports:{}}).exports,R),R.exports);var $M=EM((fM,QM)=>{var d,s,f,c,a,g,BM,KM;function VM(M){if(M<0.5)M=0.5;var R=Math.exp(0.527076)/M,U=Math.exp(-R),D=Math.exp(-2*R),q=(1-U)*(1-U)/(1+2*R*U-D);return d=q,s=q*(R-1)*U,f=q*(R+1)*U,c=-q*D,a=2*U,g=-D,BM=(d+s)/(1-a-g),KM=(f+c)/(1-a-g),new Float32Array([d,s,f,c,a,g,BM,KM])}function JM(M,R,U,D,q,$){var A,I,K,B,J,j,k,Q,G,L,C,y,Z,z,w,N,E,O,n,X,S,m,Y,V,h,u,F,T,H,W;for(h=0;h<$;h++){m=h*q,Y=h,V=0,A=M[m],I=A&255,K=A>>8&255,B=A>>16&255,J=A>>24&255,O=I*D[6],n=K*D[6],X=B*D[6],S=J*D[6],z=O,w=n,N=X,E=S,F=D[0],T=D[1],H=D[4],W=D[5];for(u=0;u<q;u++)A=M[m],j=A&255,k=A>>8&255,Q=A>>16&255,G=A>>24&255,L=j*F+I*T+z*H+O*W,C=k*F+K*T+w*H+n*W,y=Q*F+B*T+N*H+X*W,Z=G*F+J*T+E*H+S*W,O=z,n=w,X=N,S=E,z=L,w=C,N=y,E=Z,I=j,K=k,B=Q,J=G,U[V]=z,U[V+1]=w,U[V+2]=N,U[V+3]=E,V+=4,m++;m--,V-=4,Y+=$*(q-1),A=M[m],I=A&255,K=A>>8&255,B=A>>16&255,J=A>>24&255,O=I*D[7],n=K*D[7],X=B*D[7],S=J*D[7],z=O,w=n,N=X,E=S,j=I,k=K,Q=B,G=J,F=D[2],T=D[3];for(u=q-1;u>=0;u--)L=j*F+I*T+z*H+O*W,C=k*F+K*T+w*H+n*W,y=Q*F+B*T+N*H+X*W,Z=G*F+J*T+E*H+S*W,O=z,n=w,X=N,S=E,z=L,w=C,N=y,E=Z,I=j,K=k,B=Q,J=G,A=M[m],j=A&255,k=A>>8&255,Q=A>>16&255,G=A>>24&255,A=(U[V]+z<<0)+(U[V+1]+w<<8)+(U[V+2]+N<<16)+(U[V+3]+E<<24),R[Y]=A,m--,V-=4,Y-=$}}function XM(M,R,U,D){if(!D)return;var q=new Uint32Array(M.buffer),$=new Uint32Array(q.length),A=new Float32Array(Math.max(R,U)*4),I=VM(D);JM(q,$,A,I,R,U,D),JM($,q,A,I,U,R,D)}QM.exports=XM});var v=4;var wM=2;function _(M,R,U,D,q,$){let A=U/M,I=D/R,K=(2*$+wM+1)/q;if(K>0.5)return[{toWidth:U,toHeight:D}];let B=Math.ceil(Math.log(Math.min(A,I))/Math.log(K));if(B<=1)return[{toWidth:U,toHeight:D}];let J=[];for(let j=0;j<B;j++){let k=Math.round(Math.pow(Math.pow(M,B-j-1)*Math.pow(U,j+1),1/B)),Q=Math.round(Math.pow(Math.pow(R,B-j-1)*Math.pow(D,j+1),1/B));J.push({toWidth:k,toHeight:Q})}return J}function i(M,R,U){let D=new Uint8ClampedArray(U.width*U.height*v);for(let q=0;q<U.height;q++){let $=((U.y+q)*R+U.x)*v,A=q*U.width*v;D.set(M.subarray($,$+U.width*v),A)}return D}var e=0.00001;function x(M){let R=Math.round(M);if(Math.abs(M-R)<e)return R;return Math.floor(M)}function t(M){let R=Math.round(M);if(Math.abs(M-R)<e)return R;return Math.ceil(M)}function r(M,R,U,D,q,$,A,I,K,B,J){let j=D/R,k=q/U,Q=x($*j)-2*A,G=x($*k)-2*A;if(Q<1||G<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let L,C,y,Z,z,w,N=[];for(Z=0;Z<q;Z+=G)for(y=0;y<D;y+=Q){if(L=y-A,L<0)L=0;if(z=y+Q+A-L,L+z>=D)z=D-L;if(C=Z-A,C<0)C=0;if(w=Z+G+A-C,C+w>=q)w=q-C;let E={toX:L,toY:C,toWidth:z,toHeight:w,toInnerX:y,toInnerY:Z,toInnerWidth:Q,toInnerHeight:G,offsetX:L/j-x(L/j),offsetY:C/k-x(C/k),scaleX:j,scaleY:k,x:x(L/j),y:x(C/k),width:t(z/j),height:t(w/k),initialSize:$,filterPadding:A,filter:I,unsharpAmount:K,unsharpRadius:B,unsharpThreshold:J},O=i(M,R,E);N.push({tile:O.buffer,...E})}return N}async function MM(M){let R,U,D,q,$,A;if(M.image instanceof Blob){let K=await createImageBitmap(M.image),J=new OffscreenCanvas(K.width,K.height).getContext("2d");if(!J)throw new Error("Canvas 2D context not supported");J.drawImage(K,0,0),R=J.getImageData(0,0,K.width,K.height).data,U=K.width,D=K.height,K.close();let k=M.maxDimension/U,Q=M.maxDimension/D,G=Math.min(k,Q,1),L=Math.floor(U*G),C=Math.floor(D*G);A=_(U,D,L,C,M.tileOptions.initialSize,M.tileOptions.filterPadding)}else R=M.image.from,U=M.image.fromWidth,D=M.image.fromHeight,A=M.image.stages;q=A[0].toWidth,$=A[0].toHeight;let I=r(R,U,D,q,$,M.tileOptions.initialSize,M.tileOptions.filterPadding,M.tileOptions.filter,M.tileOptions.unsharpAmount,M.tileOptions.unsharpRadius,M.tileOptions.unsharpThreshold);return{from:R.buffer,fromWidth:U,fromHeight:D,tileTransforms:I,stages:A}}var p={box:{win:0.5,fn:(M)=>{if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:(M)=>{if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;let R=M*Math.PI;return Math.sin(R)/R*(0.54+0.46*Math.cos(R/1))}},lanczos2:{win:2,fn:(M)=>{if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;let R=M*Math.PI;return Math.sin(R)/R*Math.sin(R/2)/(R/2)}},lanczos3:{win:3,fn:(M)=>{if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;let R=M*Math.PI;return Math.sin(R)/R*Math.sin(R/3)/(R/3)}},mks2013:{win:2.5,fn:(M)=>{if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var OM=14;function RM(M){return Math.round(M*((1<<OM)-1))}function o(M,R,U,D,q){let $=p[M].fn,A=1/D,I=Math.min(1,D),K=p[M].win/I,B,J,j,k,Q,G,L,C,y,Z,z,w,N,E,O,n,X,S=Math.floor((K+1)*2),m=new Int16Array((S+2)*U),Y=0,V=!m.subarray||!m.set;for(B=0;B<U;B++){J=(B+0.5)*A+q,j=Math.max(0,Math.floor(J-K)),k=Math.min(R-1,Math.ceil(J+K)),Q=k-j+1,G=new Float32Array(Q),L=new Int16Array(Q),C=0;for(y=j,Z=0;y<=k;y++,Z++)z=$((y+0.5-J)*I),C+=z,G[Z]=z;w=0;for(Z=0;Z<G.length;Z++)N=G[Z]/C,w+=N,L[Z]=RM(N);L[U>>1]+=RM(1-w),E=0;while(E<L.length&&L[E]===0)E++;if(E<L.length){O=L.length-1;while(O>0&&L[O]===0)O--;if(n=j+E,X=O-E+1,m[Y++]=n,m[Y++]=X,!V)m.set(L.subarray(E,O+1),Y),Y+=X;else for(Z=E;Z<=O;Z++)m[Y++]=L[Z]}else m[Y++]=0,m[Y++]=0}return m}function P(M){return M<0?0:M>255?255:M}function b(M){return M>=0?M:0}function DM(M,R,U,D,q,$){let A,I,K,B,J,j,k,Q,G,L,C,y=0,Z=0;for(G=0;G<D;G++){J=0;for(L=0;L<q;L++){j=$[J++],k=$[J++],Q=y+j*4|0,A=I=K=B=0;for(;k>0;k--)C=$[J++],B=B+C*M[Q+3]|0,K=K+C*M[Q+2]|0,I=I+C*M[Q+1]|0,A=A+C*M[Q]|0,Q=Q+4|0;R[Z+3]=b(B>>7),R[Z+2]=b(K>>7),R[Z+1]=b(I>>7),R[Z]=b(A>>7),Z=Z+D*4|0}Z=(G+1)*4|0,y=(G+1)*U*4|0}}function AM(M,R,U,D,q,$){let A,I,K,B,J,j,k,Q,G,L,C,y=0,Z=0;for(G=0;G<D;G++){J=0;for(L=0;L<q;L++){j=$[J++],k=$[J++],Q=y+j*4|0,A=I=K=B=0;for(;k>0;k--)C=$[J++],B=B+C*M[Q+3]|0,K=K+C*M[Q+2]|0,I=I+C*M[Q+1]|0,A=A+C*M[Q]|0,Q=Q+4|0;A>>=7,I>>=7,K>>=7,B>>=7,R[Z+3]=P(B+8192>>14),R[Z+2]=P(K+8192>>14),R[Z+1]=P(I+8192>>14),R[Z]=P(A+8192>>14),Z=Z+D*4|0}Z=(G+1)*4|0,y=(G+1)*U*4|0}}function UM(M,R,U,D,q,$){let A,I,K,B,J,j,k,Q,G,L,C,y,Z=0,z=0;for(L=0;L<D;L++){j=0;for(C=0;C<q;C++){k=$[j++],Q=$[j++],G=Z+k*4|0,A=I=K=B=0;for(;Q>0;Q--)y=$[j++],J=M[G+3],B=B+y*J|0,K=K+y*M[G+2]*J|0,I=I+y*M[G+1]*J|0,A=A+y*M[G]*J|0,G=G+4|0;K=K/255|0,I=I/255|0,A=A/255|0,R[z+3]=b(B>>7),R[z+2]=b(K>>7),R[z+1]=b(I>>7),R[z]=b(A>>7),z=z+D*4|0}z=(L+1)*4|0,Z=(L+1)*U*4|0}}function qM(M,R,U,D,q,$){let A,I,K,B,J,j,k,Q,G,L,C,y=0,Z=0;for(G=0;G<D;G++){J=0;for(L=0;L<q;L++){j=$[J++],k=$[J++],Q=y+j*4|0,A=I=K=B=0;for(;k>0;k--)C=$[J++],B=B+C*M[Q+3]|0,K=K+C*M[Q+2]|0,I=I+C*M[Q+1]|0,A=A+C*M[Q]|0,Q=Q+4|0;if(A>>=7,I>>=7,K>>=7,B>>=7,B=P(B+8192>>14),B>0)A=A*255/B|0,I=I*255/B|0,K=K*255/B|0;R[Z+3]=B,R[Z+2]=P(K+8192>>14),R[Z+1]=P(I+8192>>14),R[Z]=P(A+8192>>14),Z=Z+D*4|0}Z=(G+1)*4|0,y=(G+1)*U*4|0}}function mM(M,R,U){let D=3,q=R*U*4|0;while(D<q){if(M[D]!==255)return!0;D=D+4|0}return!1}function NM(M,R,U){let D=3,q=R*U*4|0;while(D<q)M[D]=255,D=D+4|0}function IM(M,R,U,D,q,$,A,I,K,B){let J=o(R,U,q,A,K),j=o(R,D,$,I,B),k=new Uint8Array(q*$*4),Q=new Uint16Array(q*D*4);if(mM(M,U,D))UM(M,Q,U,D,q,J),qM(Q,k,D,q,$,j);else DM(M,Q,U,D,q,J),AM(Q,k,D,q,$,j),NM(k,q,$);return k}var ZM=zM($M(),1);function YM(M,R,U){let D=R*U,q=new Uint16Array(D),$,A,I,K;for(let B=0;B<D;B++)$=M[4*B],A=M[4*B+1],I=M[4*B+2],K=$>=A&&$>=I?$:A>=I&&A>=$?A:I,q[B]=K<<8;return q}function CM(M,R,U,D,q,$){let A,I,K,B,J;if(D===0||q<0.5)return;if(q>2)q=2;let j=YM(M,R,U),k=new Uint16Array(j);ZM.default(k,R,U,q);let Q=D/100*4096+0.5|0,G=$<<8,L=R*U;for(let C=0;C<L;C++)if(A=j[C],B=A-k[C],Math.abs(B)>=G)I=A+(Q*B+2048>>12),I=I>65280?65280:I,I=I<0?0:I,A=A!==0?A:1,K=(I<<12)/A|0,J=C*4,M[J]=M[J]*K+2048>>12,M[J+1]=M[J+1]*K+2048>>12,M[J+2]=M[J+2]*K+2048>>12}function GM(M){let R=IM(new Uint8ClampedArray(M.tile),M.filter,M.width,M.height,M.toWidth,M.toHeight,M.scaleX,M.scaleY,M.offsetX,M.offsetY);if(M.unsharpAmount)CM(R,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return R}self.onmessage=async(M)=>{let{taskId:R,squishId:U,taskType:D}=M.data;try{if(D===0){let{image:q,maxDimension:$,tileOptions:A}=M.data,I=await MM({image:q,maxDimension:$,tileOptions:A}),K={taskId:R,squishId:U,taskType:D,output:{from:I.from,fromWidth:I.fromWidth,fromHeight:I.fromHeight,tileTransforms:I.tileTransforms,stages:I.stages}},B=I.tileTransforms.map((J)=>J.tile);self.postMessage(K,[I.from,...B])}if(D===1){let{tileTransform:q}=M.data;q.tile=GM(q).buffer;let $={taskId:R,squishId:U,taskType:D,output:{tileTransform:q}};self.postMessage($,[q.tile])}}catch(q){self.postMessage({taskId:R,squishId:U,taskType:D,error:q})}};
