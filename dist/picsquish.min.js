var Jk=Object.create;var{getPrototypeOf:$k,defineProperty:s,getOwnPropertyNames:Gk}=Object;var Zk=Object.prototype.hasOwnProperty;var jk=(k,u,n)=>{n=k!=null?Jk($k(k)):{};let I=u||!k||!k.__esModule?s(n,"default",{value:k,enumerable:!0}):n;for(let R of Gk(k))if(!Zk.call(I,R))s(I,R,{get:()=>k[R],enumerable:!0});return I};var Tk=(k,u)=>()=>(u||k((u={exports:{}}).exports,u),u.exports);var bk=Tk((tk,Dk)=>{var g,P,v,_,S,m,Ik,Rk;function Nk(k){if(k<0.5)k=0.5;var u=Math.exp(0.527076)/k,n=Math.exp(-u),I=Math.exp(-2*u),R=(1-n)*(1-n)/(1+2*u*n-I);return g=R,P=R*(u-1)*n,v=R*(u+1)*n,_=-R*I,S=2*n,m=-I,Ik=(g+P)/(1-S-m),Rk=(v+_)/(1-S-m),new Float32Array([g,P,v,_,S,m,Ik,Rk])}function Mk(k,u,n,I,R,b){var M,y,B,D,A,q,$,U,J,K,w,G,Q,Z;for(J=0;J<b;J++){q=J*R,$=J,U=0,M=k[q],A=M*I[6],D=A,w=I[0],G=I[1],Q=I[4],Z=I[5];for(K=0;K<R;K++)y=k[q],B=y*w+M*G+D*Q+A*Z,A=D,D=B,M=y,n[U]=D,U++,q++;q--,U--,$+=b*(R-1),M=k[q],A=M*I[7],D=A,y=M,w=I[2],G=I[3];for(K=R-1;K>=0;K--)B=y*w+M*G+D*Q+A*Z,A=D,D=B,M=y,y=k[q],u[$]=n[U]+D,q--,U--,$-=b}}function Xk(k,u,n,I){if(!I)return;var R=new Uint16Array(k.length),b=new Float32Array(Math.max(u,n)),M=Nk(I);Mk(k,R,b,M,u,n,I),Mk(R,k,b,M,n,u,I)}Dk.exports=Xk});var j=4;class Y{raw;width;height;constructor(k,u,n){this.raw=k,this.width=u,this.height=n}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let k=document.createElement("canvas");k.width=this.width,k.height=this.height;let u=k.getContext("2d");if(!u)throw new Error("Picsquish error: canvas 2D context not supported");return u.putImageData(this.toImageData(),0,0),k}toBlob(k="image/png"){let u=new OffscreenCanvas(this.width,this.height),n=u.getContext("2d");if(!n)throw new Error("Picsquish error: canvas 2D context not supported");return n.putImageData(this.toImageData(),0,0),u.convertToBlob({type:k})}}var Ck=2;function x(k,u,n,I,R,b){let M=n/k,y=I/u,B=(2*b+Ck+1)/R;if(B>0.5)return[{toWidth:n,toHeight:I}];let D=Math.ceil(Math.log(Math.min(M,y))/Math.log(B));if(D<=1)return[{toWidth:n,toHeight:I}];let A=[];for(let q=0;q<D;q++){let $=Math.round(Math.pow(Math.pow(k,D-q-1)*Math.pow(n,q+1),1/D)),U=Math.round(Math.pow(Math.pow(u,D-q-1)*Math.pow(I,q+1),1/D));A.push({toWidth:$,toHeight:U})}return A}function Lk(k,u){if(k)k.width=k.height=0;k=u=null}function ak(k,u){let n=new OffscreenCanvas(u.width,u.height),I=n.getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");I.globalCompositeOperation="copy",I.drawImage(k,u.x,u.y,u.width,u.height,0,0,u.width,u.height);let R=I.getImageData(0,0,u.width,u.height).data.buffer;return Lk(n,I),R}function Ok(k,u,n){let I=new Uint8ClampedArray(n.width*n.height*j);for(let R=0;R<n.height;R++){let b=((n.y+R)*u+n.x)*j,M=R*n.width*j;I.set(k.subarray(b,b+n.width*j),M)}return I.buffer}function d(k,u,n){if(k instanceof ImageBitmap)return ak(k,n);else return Ok(k,u,n)}var f=0.00001;function X(k){let u=Math.round(k);if(Math.abs(k-u)<f)return u;return Math.floor(k)}function c(k){let u=Math.round(k);if(Math.abs(k-u)<f)return u;return Math.ceil(k)}function l(k,u,n,I,R,b,M,y,B,D,A){let q=I/u,$=R/n,U=X(b*q)-2*M,J=X(b*$)-2*M;if(U<1||J<1)throw new Error("Picsquish error: target tile width/height is too small");let K,w,G,Q,Z,C,N=[];for(Q=0;Q<R;Q+=J)for(G=0;G<I;G+=U){if(K=G-M,K<0)K=0;if(Z=G+U+M-K,K+Z>=I)Z=I-K;if(w=Q-M,w<0)w=0;if(C=Q+J+M-w,w+C>=R)C=R-w;let T={toX:K,toY:w,toWidth:Z,toHeight:C,toInnerX:G,toInnerY:Q,toInnerWidth:U,toInnerHeight:J,offsetX:K/q-X(K/q),offsetY:w/$-X(w/$),scaleX:q,scaleY:$,x:X(K/q),y:X(w/$),width:c(Z/q),height:c(C/$),initialSize:b,filterPadding:M,filter:y,unsharpAmount:B,unsharpRadius:D,unsharpThreshold:A},L=d(k,u,T);N.push({tile:L,...T})}return N}async function e(k){let u,n,I,R,b,M;if(k.image instanceof Blob||k.image instanceof ImageBitmap){let B=k.image instanceof ImageBitmap?k.image:await createImageBitmap(k.image);u=B,n=B.width,I=B.height;let D=k.maxDimension/n,A=k.maxDimension/I,q=Math.min(D,A,1),$=Math.floor(n*q),U=Math.floor(I*q);R=x(n,I,$,U,k.tileOptions.initialSize,k.tileOptions.filterPadding)}else u=k.image.from,n=k.image.fromWidth,I=k.image.fromHeight,R=k.image.stages;b=R[0].toWidth,M=R[0].toHeight;let y=l(u,n,I,b,M,k.tileOptions.initialSize,k.tileOptions.filterPadding,k.tileOptions.filter,k.tileOptions.unsharpAmount,k.tileOptions.unsharpRadius,k.tileOptions.unsharpThreshold);if(u instanceof ImageBitmap)u.close();return{tileTransforms:y,stages:R}}var W={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*(0.54+0.46*Math.cos(u/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/2)/(u/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/3)/(u/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var zk=14;function r(k){return Math.round(k*((1<<zk)-1))}function H(k,u,n,I,R){let b=W[k].fn,M=1/I,y=Math.min(1,I),B=W[k].win/y,D,A,q,$,U,J,K,w,G,Q,Z,C,N,T,L,h,F,Kk=Math.floor((B+1)*2),a=new Int16Array((Kk+2)*n),E=0,wk=!a.subarray||!a.set;for(D=0;D<n;D++){A=(D+0.5)*M+R,q=Math.max(0,Math.floor(A-B)),$=Math.min(u-1,Math.ceil(A+B)),U=$-q+1,J=new Float32Array(U),K=new Int16Array(U),w=0;for(G=q,Q=0;G<=$;G++,Q++)Z=b((G+0.5-A)*y),w+=Z,J[Q]=Z;C=0;for(Q=0;Q<J.length;Q++)N=J[Q]/w,C+=N,K[Q]=r(N);K[n>>1]+=r(1-C),T=0;while(T<K.length&&K[T]===0)T++;if(T<K.length){L=K.length-1;while(L>0&&K[L]===0)L--;if(h=q+T,F=L-T+1,a[E++]=h,a[E++]=F,!wk)a.set(K.subarray(T,L+1),E),E+=F;else for(Q=T;Q<=L;Q++)a[E++]=K[Q]}else a[E++]=0,a[E++]=0}return a}function O(k){return k<0?0:k>255?255:k}function z(k){return k>=0?k:0}function i(k,u,n,I,R,b){let M,y,B,D,A,q,$,U,J,K,w,G=0,Q=0;for(J=0;J<I;J++){A=0;for(K=0;K<R;K++){q=b[A++],$=b[A++],U=G+q*4|0,M=y=B=D=0;for(;$>0;$--)w=b[A++],D=D+w*k[U+3]|0,B=B+w*k[U+2]|0,y=y+w*k[U+1]|0,M=M+w*k[U]|0,U=U+4|0;u[Q+3]=z(D>>7),u[Q+2]=z(B>>7),u[Q+1]=z(y>>7),u[Q]=z(M>>7),Q=Q+I*4|0}Q=(J+1)*4|0,G=(J+1)*n*4|0}}function t(k,u,n,I,R,b){let M,y,B,D,A,q,$,U,J,K,w,G=0,Q=0;for(J=0;J<I;J++){A=0;for(K=0;K<R;K++){q=b[A++],$=b[A++],U=G+q*4|0,M=y=B=D=0;for(;$>0;$--)w=b[A++],D=D+w*k[U+3]|0,B=B+w*k[U+2]|0,y=y+w*k[U+1]|0,M=M+w*k[U]|0,U=U+4|0;M>>=7,y>>=7,B>>=7,D>>=7,u[Q+3]=O(D+8192>>14),u[Q+2]=O(B+8192>>14),u[Q+1]=O(y+8192>>14),u[Q]=O(M+8192>>14),Q=Q+I*4|0}Q=(J+1)*4|0,G=(J+1)*n*4|0}}function kk(k,u,n,I,R,b){let M,y,B,D,A,q,$,U,J,K,w,G,Q=0,Z=0;for(K=0;K<I;K++){q=0;for(w=0;w<R;w++){$=b[q++],U=b[q++],J=Q+$*4|0,M=y=B=D=0;for(;U>0;U--)G=b[q++],A=k[J+3],D=D+G*A|0,B=B+G*k[J+2]*A|0,y=y+G*k[J+1]*A|0,M=M+G*k[J]*A|0,J=J+4|0;B=B/255|0,y=y/255|0,M=M/255|0,u[Z+3]=z(D>>7),u[Z+2]=z(B>>7),u[Z+1]=z(y>>7),u[Z]=z(M>>7),Z=Z+I*4|0}Z=(K+1)*4|0,Q=(K+1)*n*4|0}}function uk(k,u,n,I,R,b){let M,y,B,D,A,q,$,U,J,K,w,G=0,Q=0;for(J=0;J<I;J++){A=0;for(K=0;K<R;K++){q=b[A++],$=b[A++],U=G+q*4|0,M=y=B=D=0;for(;$>0;$--)w=b[A++],D=D+w*k[U+3]|0,B=B+w*k[U+2]|0,y=y+w*k[U+1]|0,M=M+w*k[U]|0,U=U+4|0;if(M>>=7,y>>=7,B>>=7,D>>=7,D=O(D+8192>>14),D>0)M=M*255/D|0,y=y*255/D|0,B=B*255/D|0;u[Q+3]=D,u[Q+2]=O(B+8192>>14),u[Q+1]=O(y+8192>>14),u[Q]=O(M+8192>>14),Q=Q+I*4|0}Q=(J+1)*4|0,G=(J+1)*n*4|0}}function Ek(k,u,n){let I=3,R=u*n*4|0;while(I<R){if(k[I]!==255)return!0;I=I+4|0}return!1}function Vk(k,u,n){let I=3,R=u*n*4|0;while(I<R)k[I]=255,I=I+4|0}function nk(k,u,n,I,R,b,M,y,B,D){let A=H(u,n,R,M,B),q=H(u,I,b,y,D),$=new Uint8Array(R*b*4),U=new Uint16Array(R*I*4);if(Ek(k,n,I))kk(k,U,n,I,R,A),uk(U,$,I,R,b,q);else i(k,U,n,I,R,A),t(U,$,I,R,b,q),Vk($,R,b);return $}var yk=jk(bk(),1);function Yk(k,u,n){let I=u*n,R=new Uint16Array(I),b,M,y,B;for(let D=0;D<I;D++)b=k[4*D],M=k[4*D+1],y=k[4*D+2],B=b>=M&&b>=y?b:M>=y&&M>=b?M:y,R[D]=B<<8;return R}function Bk(k,u,n,I,R,b){let M,y,B,D,A;if(I===0||R<0.5)return;if(R>2)R=2;let q=Yk(k,u,n),$=new Uint16Array(q);yk.default($,u,n,R);let U=I/100*4096+0.5|0,J=b<<8,K=u*n;for(let w=0;w<K;w++)if(M=q[w],D=M-$[w],Math.abs(D)>=J)y=M+(U*D+2048>>12),y=y>65280?65280:y,y=y<0?0:y,M=M!==0?M:1,B=(y<<12)/M|0,A=w*4,k[A]=k[A]*B+2048>>12,k[A+1]=k[A+1]*B+2048>>12,k[A+2]=k[A+2]*B+2048>>12}function Uk(k){let u=nk(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Bk(u,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return u}function p(k,u,n){let I=new Uint8ClampedArray(n.tile);for(let R=0;R<n.toHeight;R++){let b=R*n.toWidth*j,M=((n.toY+R)*u+n.toX)*j;k.set(I.subarray(b,b+n.toWidth*j),M)}}var Sk=`
var Uk=Object.create;var{getPrototypeOf:Ak,defineProperty:_,getOwnPropertyNames:Jk}=Object;var Kk=Object.prototype.hasOwnProperty;var $k=(k,I,R)=>{R=k!=null?Uk(Ak(k)):{};let M=I||!k||!k.__esModule?_(R,"default",{value:k,enumerable:!0}):R;for(let D of Jk(k))if(!Kk.call(M,D))_(M,D,{get:()=>k[D],enumerable:!0});return M};var Gk=(k,I)=>()=>(I||k((I={exports:{}}).exports,I),I.exports);var Rk=Gk((dk,Mk)=>{var W,m,P,a,T,F,t,kk;function zk(k){if(k<0.5)k=0.5;var I=Math.exp(0.527076)/k,R=Math.exp(-I),M=Math.exp(-2*I),D=(1-R)*(1-R)/(1+2*I*R-M);return W=D,m=D*(I-1)*R,P=D*(I+1)*R,a=-D*M,T=2*R,F=-M,t=(W+m)/(1-T-F),kk=(P+a)/(1-T-F),new Float32Array([W,m,P,a,T,F,t,kk])}function Ik(k,I,R,M,D,U){var q,u,y,B,A,K,b,J,Z,G,Q,j,$,C;for(Z=0;Z<U;Z++){K=Z*D,b=Z,J=0,q=k[K],A=q*M[6],B=A,Q=M[0],j=M[1],$=M[4],C=M[5];for(G=0;G<D;G++)u=k[K],y=u*Q+q*j+B*$+A*C,A=B,B=y,q=u,R[J]=B,J++,K++;K--,J--,b+=U*(D-1),q=k[K],A=q*M[7],B=A,u=q,Q=M[2],j=M[3];for(G=D-1;G>=0;G--)y=u*Q+q*j+B*$+A*C,A=B,B=y,q=u,u=k[K],I[b]=R[J]+B,K--,J--,b-=U}}function Ok(k,I,R,M){if(!M)return;var D=new Uint16Array(k.length),U=new Float32Array(Math.max(I,R)),q=zk(M);Ik(k,D,U,q,I,R,M),Ik(D,k,U,q,R,I,M)}Mk.exports=Ok});var n=4;var Qk=2;function g(k,I,R,M,D,U){let q=R/k,u=M/I,y=(2*U+Qk+1)/D;if(y>0.5)return[{toWidth:R,toHeight:M}];let B=Math.ceil(Math.log(Math.min(q,u))/Math.log(y));if(B<=1)return[{toWidth:R,toHeight:M}];let A=[];for(let K=0;K<B;K++){let b=Math.round(Math.pow(Math.pow(k,B-K-1)*Math.pow(R,K+1),1/B)),J=Math.round(Math.pow(Math.pow(I,B-K-1)*Math.pow(M,K+1),1/B));A.push({toWidth:b,toHeight:J})}return A}function Zk(k,I){if(k)k.width=k.height=0;k=I=null}function bk(k,I){let R=new OffscreenCanvas(I.width,I.height),M=R.getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");M.globalCompositeOperation="copy",M.drawImage(k,I.x,I.y,I.width,I.height,0,0,I.width,I.height);let D=M.getImageData(0,0,I.width,I.height).data.buffer;return Zk(R,M),D}function jk(k,I,R){let M=new Uint8ClampedArray(R.width*R.height*n);for(let D=0;D<R.height;D++){let U=((R.y+D)*I+R.x)*n,q=D*R.width*n;M.set(k.subarray(U,U+R.width*n),q)}return M.buffer}function x(k,I,R){if(k instanceof ImageBitmap)return bk(k,R);else return jk(k,I,R)}var o=0.00001;function Y(k){let I=Math.round(k);if(Math.abs(k-I)<o)return I;return Math.floor(k)}function h(k){let I=Math.round(k);if(Math.abs(k-I)<o)return I;return Math.ceil(k)}function d(k,I,R,M,D,U,q,u,y,B,A){let K=M/I,b=D/R,J=Y(U*K)-2*q,Z=Y(U*b)-2*q;if(J<1||Z<1)throw new Error("Picsquish error: target tile width/height is too small");let G,Q,j,$,C,w,E=[];for($=0;$<D;$+=Z)for(j=0;j<M;j+=J){if(G=j-q,G<0)G=0;if(C=j+J+q-G,G+C>=M)C=M-G;if(Q=$-q,Q<0)Q=0;if(w=$+Z+q-Q,Q+w>=D)w=D-Q;let L={toX:G,toY:Q,toWidth:C,toHeight:w,toInnerX:j,toInnerY:$,toInnerWidth:J,toInnerHeight:Z,offsetX:G/K-Y(G/K),offsetY:Q/b-Y(Q/b),scaleX:K,scaleY:b,x:Y(G/K),y:Y(Q/b),width:h(C/K),height:h(w/b),initialSize:U,filterPadding:q,filter:u,unsharpAmount:y,unsharpRadius:B,unsharpThreshold:A},z=x(k,I,L);E.push({tile:z,...L})}return E}async function s(k){let I,R,M,D,U,q;if(k.image instanceof Blob||k.image instanceof ImageBitmap){let y=k.image instanceof ImageBitmap?k.image:await createImageBitmap(k.image);I=y,R=y.width,M=y.height;let B=k.maxDimension/R,A=k.maxDimension/M,K=Math.min(B,A,1),b=Math.floor(R*K),J=Math.floor(M*K);D=g(R,M,b,J,k.tileOptions.initialSize,k.tileOptions.filterPadding)}else I=k.image.from,R=k.image.fromWidth,M=k.image.fromHeight,D=k.image.stages;U=D[0].toWidth,q=D[0].toHeight;let u=d(I,R,M,U,q,k.tileOptions.initialSize,k.tileOptions.filterPadding,k.tileOptions.filter,k.tileOptions.unsharpAmount,k.tileOptions.unsharpRadius,k.tileOptions.unsharpThreshold);if(I instanceof ImageBitmap)I.close();return{tileTransforms:u,stages:D}}var H={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*(0.54+0.46*Math.cos(I/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/2)/(I/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/3)/(I/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Ck=14;function c(k){return Math.round(k*((1<<Ck)-1))}function p(k,I,R,M,D){let U=H[k].fn,q=1/M,u=Math.min(1,M),y=H[k].win/u,B,A,K,b,J,Z,G,Q,j,$,C,w,E,L,z,v,S,uk=Math.floor((y+1)*2),O=new Int16Array((uk+2)*R),X=0,yk=!O.subarray||!O.set;for(B=0;B<R;B++){A=(B+0.5)*q+D,K=Math.max(0,Math.floor(A-y)),b=Math.min(I-1,Math.ceil(A+y)),J=b-K+1,Z=new Float32Array(J),G=new Int16Array(J),Q=0;for(j=K,$=0;j<=b;j++,$++)C=U((j+0.5-A)*u),Q+=C,Z[$]=C;w=0;for($=0;$<Z.length;$++)E=Z[$]/Q,w+=E,G[$]=c(E);G[R>>1]+=c(1-w),L=0;while(L<G.length&&G[L]===0)L++;if(L<G.length){z=G.length-1;while(z>0&&G[z]===0)z--;if(v=K+L,S=z-L+1,O[X++]=v,O[X++]=S,!yk)O.set(G.subarray(L,z+1),X),X+=S;else for($=L;$<=z;$++)O[X++]=G[$]}else O[X++]=0,O[X++]=0}return O}function V(k){return k<0?0:k>255?255:k}function N(k){return k>=0?k:0}function f(k,I,R,M,D,U){let q,u,y,B,A,K,b,J,Z,G,Q,j=0,$=0;for(Z=0;Z<M;Z++){A=0;for(G=0;G<D;G++){K=U[A++],b=U[A++],J=j+K*4|0,q=u=y=B=0;for(;b>0;b--)Q=U[A++],B=B+Q*k[J+3]|0,y=y+Q*k[J+2]|0,u=u+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;I[$+3]=N(B>>7),I[$+2]=N(y>>7),I[$+1]=N(u>>7),I[$]=N(q>>7),$=$+M*4|0}$=(Z+1)*4|0,j=(Z+1)*R*4|0}}function l(k,I,R,M,D,U){let q,u,y,B,A,K,b,J,Z,G,Q,j=0,$=0;for(Z=0;Z<M;Z++){A=0;for(G=0;G<D;G++){K=U[A++],b=U[A++],J=j+K*4|0,q=u=y=B=0;for(;b>0;b--)Q=U[A++],B=B+Q*k[J+3]|0,y=y+Q*k[J+2]|0,u=u+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;q>>=7,u>>=7,y>>=7,B>>=7,I[$+3]=V(B+8192>>14),I[$+2]=V(y+8192>>14),I[$+1]=V(u+8192>>14),I[$]=V(q+8192>>14),$=$+M*4|0}$=(Z+1)*4|0,j=(Z+1)*R*4|0}}function e(k,I,R,M,D,U){let q,u,y,B,A,K,b,J,Z,G,Q,j,$=0,C=0;for(G=0;G<M;G++){K=0;for(Q=0;Q<D;Q++){b=U[K++],J=U[K++],Z=$+b*4|0,q=u=y=B=0;for(;J>0;J--)j=U[K++],A=k[Z+3],B=B+j*A|0,y=y+j*k[Z+2]*A|0,u=u+j*k[Z+1]*A|0,q=q+j*k[Z]*A|0,Z=Z+4|0;y=y/255|0,u=u/255|0,q=q/255|0,I[C+3]=N(B>>7),I[C+2]=N(y>>7),I[C+1]=N(u>>7),I[C]=N(q>>7),C=C+M*4|0}C=(G+1)*4|0,$=(G+1)*R*4|0}}function r(k,I,R,M,D,U){let q,u,y,B,A,K,b,J,Z,G,Q,j=0,$=0;for(Z=0;Z<M;Z++){A=0;for(G=0;G<D;G++){K=U[A++],b=U[A++],J=j+K*4|0,q=u=y=B=0;for(;b>0;b--)Q=U[A++],B=B+Q*k[J+3]|0,y=y+Q*k[J+2]|0,u=u+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;if(q>>=7,u>>=7,y>>=7,B>>=7,B=V(B+8192>>14),B>0)q=q*255/B|0,u=u*255/B|0,y=y*255/B|0;I[$+3]=B,I[$+2]=V(y+8192>>14),I[$+1]=V(u+8192>>14),I[$]=V(q+8192>>14),$=$+M*4|0}$=(Z+1)*4|0,j=(Z+1)*R*4|0}}function Lk(k,I,R){let M=3,D=I*R*4|0;while(M<D){if(k[M]!==255)return!0;M=M+4|0}return!1}function wk(k,I,R){let M=3,D=I*R*4|0;while(M<D)k[M]=255,M=M+4|0}function i(k,I,R,M,D,U,q,u,y,B){let A=p(I,R,D,q,y),K=p(I,M,U,u,B),b=new Uint8Array(D*U*4),J=new Uint16Array(D*M*4);if(Lk(k,R,M))e(k,J,R,M,D,A),r(J,b,M,D,U,K);else f(k,J,R,M,D,A),l(J,b,M,D,U,K),wk(b,D,U);return b}var Dk=$k(Rk(),1);function Vk(k,I,R){let M=I*R,D=new Uint16Array(M),U,q,u,y;for(let B=0;B<M;B++)U=k[4*B],q=k[4*B+1],u=k[4*B+2],y=U>=q&&U>=u?U:q>=u&&q>=U?q:u,D[B]=y<<8;return D}function qk(k,I,R,M,D,U){let q,u,y,B,A;if(M===0||D<0.5)return;if(D>2)D=2;let K=Vk(k,I,R),b=new Uint16Array(K);Dk.default(b,I,R,D);let J=M/100*4096+0.5|0,Z=U<<8,G=I*R;for(let Q=0;Q<G;Q++)if(q=K[Q],B=q-b[Q],Math.abs(B)>=Z)u=q+(J*B+2048>>12),u=u>65280?65280:u,u=u<0?0:u,q=q!==0?q:1,y=(u<<12)/q|0,A=Q*4,k[A]=k[A]*y+2048>>12,k[A+1]=k[A+1]*y+2048>>12,k[A+2]=k[A+2]*y+2048>>12}function Bk(k){let I=i(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)qk(I,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return I}var Nk=async(k)=>{let{taskId:I,squishId:R,taskType:M,image:D,maxDimension:U,tileOptions:q}=k,{tileTransforms:u,stages:y}=await s({image:D,maxDimension:U,tileOptions:q}),B={taskId:I,squishId:R,taskType:M,output:{tileTransforms:u,stages:y}},A=u.map((K)=>K.tile);self.postMessage(B,A)};function Xk(k){let{taskId:I,squishId:R,taskType:M,tileTransform:D}=k;D.tile=Bk(D).buffer;let U={taskId:I,squishId:R,taskType:M,output:{tileTransform:D}};self.postMessage(U,[D.tile])}self.onmessage=async(k)=>{try{switch(k.data.taskType){case 0:return Nk(k.data);case 1:return Xk(k.data)}}catch(I){self.postMessage({taskId:k.data.taskId,squishId:k.data.squishId,taskType:k.data.taskType,error:I})}};
`,mk=new Blob([Sk],{type:"application/javascript"});class Ak{#k;#u;#n;#I;constructor(){this.#k=new Map,this.#u=new Map,this.#n=null,this.#I=null}#R(){if(this.#n===null)return;clearTimeout(this.#n),this.#n=null}prepare(k,u,n){if(this.#k.size)return;this.#I=n;let I=URL.createObjectURL(mk);while(this.#k.size<u){let R=new Worker(I);R.onmessage=k,this.#k.set(R,null)}URL.revokeObjectURL(I)}assignTask(k,u,n,I){this.#k.set(k,u.id),this.#u.set(u.id,k),this.#R(),k.postMessage(n,I)}setTimeout(){if(this.#n!==null)return;this.#n=setTimeout(()=>{for(let k of this.#k.keys())k.terminate();this.#k.clear(),this.#u.clear()},this.#I||0)}getAvailableWorkers(){let k=[];for(let[u,n]of this.#k.entries())if(n===null)k.push(u);return k}removeTask(k){let u=this.#u.get(k);if(u)this.#k.set(u,null);this.#u.delete(k)}}var V=new Ak;var o=(()=>{let k=0;return()=>++k})();class qk{#k;#u;#n;constructor(){this.#k=new Map,this.#u=[],this.#n=[]}#I(k,u){let n={taskId:u.id,squishId:u.squishId,taskType:0,image:u.data.image,maxDimension:u.data.maxDimension,tileOptions:u.data.tileOptions},I=u.data.image instanceof ImageBitmap?[u.data.image]:[];V.assignTask(k,u,n,I)}#R(k,u){let n={taskId:u.id,squishId:u.squishId,taskType:1,tileTransform:u.data.tileTransform};V.assignTask(k,u,n,[n.tileTransform.tile])}#D(k){let u=this.#u.shift();if(u)return this.#I(k,u);let n=this.#n.shift();if(n)return this.#R(k,n)}#M(){if(this.#u.length===0&&this.#n.length===0)return V.setTimeout();let u=V.getAvailableWorkers();for(let n of u)this.#D(n)}#b(k,u){let{squishId:n,output:I}=u,R=I.stages[0].toWidth,b=I.stages[0].toHeight;k.to=new Uint8ClampedArray(R*b*j),k.toWidth=R,k.toHeight=b,k.stages=I.stages,k.remainingTileCount=I.tileTransforms.length;for(let M of I.tileTransforms)this.#n.push({id:o(),squishId:n,data:{tileTransform:M}})}#y(k,u){let{squishId:n,output:I}=u;if(!k.to)throw new Error("Picsquish error: squishContext.to not found");if(p(k.to,k.toWidth,I.tileTransform),k.remainingTileCount--,k.remainingTileCount)return;if(k.stages.shift(),!k.stages[0])return k.resolve(new Y(k.to,k.toWidth,k.toHeight));this.#u.push({id:o(),squishId:n,data:{image:{from:k.to,fromWidth:k.toWidth,fromHeight:k.toHeight,stages:k.stages},maxDimension:k.maxDimension,tileOptions:k.tileOptions}})}#B(k){let u=this.#k.get(k.data.squishId);if(!u)throw new Error("Picsquish error: squishContext not found");if(k.data.error)u.reject(k.data.error);switch(k.data.taskType){case 0:this.#b(u,k.data);break;case 1:this.#y(u,k.data);break}V.removeTask(k.data.taskId),this.#M()}add(k,u,n){return V.prepare((I)=>this.#B(I),u,n),new Promise((I,R)=>{let b=o();this.#k.set(b,{maxDimension:k.maxDimension,tileOptions:k.tileOptions,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:I,reject:R}),this.#u.push({id:b,squishId:b,data:k}),this.#M()})}}var Qk=new qk;async function pk(k,u,n){let I=null,R,b,M;for(;;){let y=await e({image:I||k,maxDimension:u,tileOptions:n});b=y.stages[0].toWidth,M=y.stages[0].toHeight,R=new Uint8ClampedArray(b*M*j);for(let B of y.tileTransforms)B.tile=Uk(B).buffer,p(R,b,B);if(y.stages.shift(),I={from:R,fromWidth:b,fromHeight:M,stages:y.stages},!y.stages[0])break}return new Y(R,b,M)}async function Yu(k,u,n={}){let I=n.tileSize||1024,R=n.filter||"mks2013",b=n.unsharpAmount||0,M=n.unsharpRadius||0,y=n.unsharpThreshold||0,B=n.useMainThread,D=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,A=n.maxWorkerPoolSize||Math.min(D,4),q=n.maxWorkerIdleTime||2000,$=3,U=Math.ceil(Math.max(3,2.5*M|0)),J={initialSize:I,filterPadding:U,filter:R,unsharpAmount:b,unsharpRadius:M,unsharpThreshold:y};if(B)return await pk(k,u,J);return Qk.add({image:k,maxDimension:u,tileOptions:J},A,q)}export{Yu as squish};
