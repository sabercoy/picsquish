var qn=Object.create;var{getPrototypeOf:Gn,defineProperty:t,getOwnPropertyNames:En}=Object;var zn=Object.prototype.hasOwnProperty;var Nn=(n,k,R)=>{R=n!=null?qn(Gn(n)):{};let T=k||!n||!n.__esModule?t(R,"default",{value:n,enumerable:!0}):R;for(let M of En(n))if(!zn.call(T,M))t(T,M,{get:()=>n[M],enumerable:!0});return T};var Xn=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Kn=Xn((Mk,wn)=>{var l,f,c,_,g,x,Un,Bn;function Sn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,R=Math.exp(-k),T=Math.exp(-2*k),M=(1-R)*(1-R)/(1+2*k*R-T);return l=M,f=M*(k-1)*R,c=M*(k+1)*R,_=-M*T,g=2*R,x=-T,Un=(l+f)/(1-g-x),Bn=(c+_)/(1-g-x),new Float32Array([l,f,c,_,g,x,Un,Bn])}function Qn(n,k,R,T,M,A){var I,D,y,m,U,B,w,Q,J,K,$,C,L,Z,q,z,j,G,u,V,O,E,Y,N,p,h,S,W,a,F;for(p=0;p<A;p++){E=p*M,Y=p,N=0,I=n[E],D=I&255,y=I>>8&255,m=I>>16&255,U=I>>24&255,G=D*T[6],u=y*T[6],V=m*T[6],O=U*T[6],Z=G,q=u,z=V,j=O,S=T[0],W=T[1],a=T[4],F=T[5];for(h=0;h<M;h++)I=n[E],B=I&255,w=I>>8&255,Q=I>>16&255,J=I>>24&255,K=B*S+D*W+Z*a+G*F,$=w*S+y*W+q*a+u*F,C=Q*S+m*W+z*a+V*F,L=J*S+U*W+j*a+O*F,G=Z,u=q,V=z,O=j,Z=K,q=$,z=C,j=L,D=B,y=w,m=Q,U=J,R[N]=Z,R[N+1]=q,R[N+2]=z,R[N+3]=j,N+=4,E++;E--,N-=4,Y+=A*(M-1),I=n[E],D=I&255,y=I>>8&255,m=I>>16&255,U=I>>24&255,G=D*T[7],u=y*T[7],V=m*T[7],O=U*T[7],Z=G,q=u,z=V,j=O,B=D,w=y,Q=m,J=U,S=T[2],W=T[3];for(h=M-1;h>=0;h--)K=B*S+D*W+Z*a+G*F,$=w*S+y*W+q*a+u*F,C=Q*S+m*W+z*a+V*F,L=J*S+U*W+j*a+O*F,G=Z,u=q,V=z,O=j,Z=K,q=$,z=C,j=L,D=B,y=w,m=Q,U=J,I=n[E],B=I&255,w=I>>8&255,Q=I>>16&255,J=I>>24&255,I=(R[N]+Z<<0)+(R[N+1]+q<<8)+(R[N+2]+z<<16)+(R[N+3]+j<<24),k[Y]=I,E--,N-=4,Y-=A}}function Wn(n,k,R,T){if(!T)return;var M=new Uint32Array(n.buffer),A=new Uint32Array(M.length),I=new Float32Array(Math.max(k,R)*4),D=Sn(T);Qn(M,A,I,D,k,R,T),Qn(A,M,I,D,R,k,T)}wn.exports=Wn});var X=4;var Vn=2;function e(n,k,R,T,M,A){let I=R/n,D=T/k,y=(2*A+Vn+1)/M;if(y>0.5)return[{toWidth:R,toHeight:T}];let m=Math.ceil(Math.log(Math.min(I,D))/Math.log(y));if(m<=1)return[{toWidth:R,toHeight:T}];let U=[];for(let B=0;B<m;B++){let w=Math.round(Math.pow(Math.pow(n,m-B-1)*Math.pow(R,B+1),1/m)),Q=Math.round(Math.pow(Math.pow(k,m-B-1)*Math.pow(T,B+1),1/m));U.push({toWidth:w,toHeight:Q})}return U}function r(n,k,R){let T=new Uint8ClampedArray(R.width*R.height*X);for(let M=0;M<R.height;M++){let A=((R.y+M)*k+R.x)*X,I=M*R.width*X;T.set(n.subarray(A,A+R.width*X),I)}return T}var kn=0.00001;function o(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.floor(n)}function nn(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.ceil(n)}function Tn(n,k,R,T,M,A,I,D,y,m,U){let B=T/k,w=M/R,Q=o(A*B)-2*I,J=o(A*w)-2*I;if(Q<1||J<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let K,$,C,L,Z,q,z=[];for(L=0;L<M;L+=J)for(C=0;C<T;C+=Q){if(K=C-I,K<0)K=0;if(Z=C+Q+I-K,K+Z>=T)Z=T-K;if($=L-I,$<0)$=0;if(q=L+J+I-$,$+q>=M)q=M-$;let j={toX:K,toY:$,toWidth:Z,toHeight:q,toInnerX:C,toInnerY:L,toInnerWidth:Q,toInnerHeight:J,offsetX:K/B-o(K/B),offsetY:$/w-o($/w),scaleX:B,scaleY:w,x:o(K/B),y:o($/w),width:nn(Z/B),height:nn(q/w),initialSize:A,filterPadding:I,filter:D,unsharpAmount:y,unsharpRadius:m,unsharpThreshold:U},G=r(n,k,j);z.push({tile:G.buffer,...j})}return z}async function Rn(n){let k,R,T,M,A,I;if(n.image instanceof Blob){let y=await createImageBitmap(n.image),U=new OffscreenCanvas(y.width,y.height).getContext("2d");if(!U)throw new Error("Canvas 2D context not supported");U.drawImage(y,0,0),k=U.getImageData(0,0,y.width,y.height).data,R=y.width,T=y.height,y.close();let w=n.maxDimension/R,Q=n.maxDimension/T,J=Math.min(w,Q,1),K=Math.floor(R*J),$=Math.floor(T*J);I=e(R,T,K,$,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,R=n.image.fromWidth,T=n.image.fromHeight,I=n.image.stages;M=I[0].toWidth,A=I[0].toHeight;let D=Tn(k,R,T,M,A,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);return{from:k.buffer,fromWidth:R,fromHeight:T,tileTransforms:D,stages:I}}function s(n,k,R){let T=new Uint8ClampedArray(R.tile);for(let M=0;M<R.toHeight;M++){let A=M*R.toWidth*X,I=((R.toY+M)*k+R.toX)*X;n.set(T.subarray(A,A+R.toWidth*X),I)}}var v={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Yn=14;function In(n){return Math.round(n*((1<<Yn)-1))}function d(n,k,R,T,M){let A=v[n].fn,I=1/T,D=Math.min(1,T),y=v[n].win/D,m,U,B,w,Q,J,K,$,C,L,Z,q,z,j,G,u,V,O=Math.floor((y+1)*2),E=new Int16Array((O+2)*R),Y=0,N=!E.subarray||!E.set;for(m=0;m<R;m++){U=(m+0.5)*I+M,B=Math.max(0,Math.floor(U-y)),w=Math.min(k-1,Math.ceil(U+y)),Q=w-B+1,J=new Float32Array(Q),K=new Int16Array(Q),$=0;for(C=B,L=0;C<=w;C++,L++)Z=A((C+0.5-U)*D),$+=Z,J[L]=Z;q=0;for(L=0;L<J.length;L++)z=J[L]/$,q+=z,K[L]=In(z);K[R>>1]+=In(1-q),j=0;while(j<K.length&&K[j]===0)j++;if(j<K.length){G=K.length-1;while(G>0&&K[G]===0)G--;if(u=B+j,V=G-j+1,E[Y++]=u,E[Y++]=V,!N)E.set(K.subarray(j,G+1),Y),Y+=V;else for(L=j;L<=G;L++)E[Y++]=K[L]}else E[Y++]=0,E[Y++]=0}return E}function H(n){return n<0?0:n>255?255:n}function P(n){return n>=0?n:0}function Mn(n,k,R,T,M,A){let I,D,y,m,U,B,w,Q,J,K,$,C=0,L=0;for(J=0;J<T;J++){U=0;for(K=0;K<M;K++){B=A[U++],w=A[U++],Q=C+B*4|0,I=D=y=m=0;for(;w>0;w--)$=A[U++],m=m+$*n[Q+3]|0,y=y+$*n[Q+2]|0,D=D+$*n[Q+1]|0,I=I+$*n[Q]|0,Q=Q+4|0;k[L+3]=P(m>>7),k[L+2]=P(y>>7),k[L+1]=P(D>>7),k[L]=P(I>>7),L=L+T*4|0}L=(J+1)*4|0,C=(J+1)*R*4|0}}function mn(n,k,R,T,M,A){let I,D,y,m,U,B,w,Q,J,K,$,C=0,L=0;for(J=0;J<T;J++){U=0;for(K=0;K<M;K++){B=A[U++],w=A[U++],Q=C+B*4|0,I=D=y=m=0;for(;w>0;w--)$=A[U++],m=m+$*n[Q+3]|0,y=y+$*n[Q+2]|0,D=D+$*n[Q+1]|0,I=I+$*n[Q]|0,Q=Q+4|0;I>>=7,D>>=7,y>>=7,m>>=7,k[L+3]=H(m+8192>>14),k[L+2]=H(y+8192>>14),k[L+1]=H(D+8192>>14),k[L]=H(I+8192>>14),L=L+T*4|0}L=(J+1)*4|0,C=(J+1)*R*4|0}}function Dn(n,k,R,T,M,A){let I,D,y,m,U,B,w,Q,J,K,$,C,L=0,Z=0;for(K=0;K<T;K++){B=0;for($=0;$<M;$++){w=A[B++],Q=A[B++],J=L+w*4|0,I=D=y=m=0;for(;Q>0;Q--)C=A[B++],U=n[J+3],m=m+C*U|0,y=y+C*n[J+2]*U|0,D=D+C*n[J+1]*U|0,I=I+C*n[J]*U|0,J=J+4|0;y=y/255|0,D=D/255|0,I=I/255|0,k[Z+3]=P(m>>7),k[Z+2]=P(y>>7),k[Z+1]=P(D>>7),k[Z]=P(I>>7),Z=Z+T*4|0}Z=(K+1)*4|0,L=(K+1)*R*4|0}}function yn(n,k,R,T,M,A){let I,D,y,m,U,B,w,Q,J,K,$,C=0,L=0;for(J=0;J<T;J++){U=0;for(K=0;K<M;K++){B=A[U++],w=A[U++],Q=C+B*4|0,I=D=y=m=0;for(;w>0;w--)$=A[U++],m=m+$*n[Q+3]|0,y=y+$*n[Q+2]|0,D=D+$*n[Q+1]|0,I=I+$*n[Q]|0,Q=Q+4|0;if(I>>=7,D>>=7,y>>=7,m>>=7,m=H(m+8192>>14),m>0)I=I*255/m|0,D=D*255/m|0,y=y*255/m|0;k[L+3]=m,k[L+2]=H(y+8192>>14),k[L+1]=H(D+8192>>14),k[L]=H(I+8192>>14),L=L+T*4|0}L=(J+1)*4|0,C=(J+1)*R*4|0}}function un(n,k,R){let T=3,M=k*R*4|0;while(T<M){if(n[T]!==255)return!0;T=T+4|0}return!1}function On(n,k,R){let T=3,M=k*R*4|0;while(T<M)n[T]=255,T=T+4|0}function An(n,k,R,T,M,A,I,D,y,m){let U=d(k,R,M,I,y),B=d(k,T,A,D,m),w=new Uint8Array(M*A*4),Q=new Uint16Array(M*T*4);if(un(n,R,T))Dn(n,Q,R,T,M,U),yn(Q,w,T,M,A,B);else Mn(n,Q,R,T,M,U),mn(Q,w,T,M,A,B),On(w,M,A);return w}var Ln=Nn(Kn(),1);function an(n,k,R){let T=k*R,M=new Uint16Array(T),A,I,D,y;for(let m=0;m<T;m++)A=n[4*m],I=n[4*m+1],D=n[4*m+2],y=A>=I&&A>=D?A:I>=D&&I>=A?I:D,M[m]=y<<8;return M}function Jn(n,k,R,T,M,A){let I,D,y,m,U;if(T===0||M<0.5)return;if(M>2)M=2;let B=an(n,k,R),w=new Uint16Array(B);Ln.default(w,k,R,M);let Q=T/100*4096+0.5|0,J=A<<8,K=k*R;for(let $=0;$<K;$++)if(I=B[$],m=I-w[$],Math.abs(m)>=J)D=I+(Q*m+2048>>12),D=D>65280?65280:D,D=D<0?0:D,I=I!==0?I:1,y=(D<<12)/I|0,U=$*4,n[U]=n[U]*y+2048>>12,n[U+1]=n[U+1]*y+2048>>12,n[U+2]=n[U+2]*y+2048>>12}function $n(n){let k=An(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)Jn(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}var Fn=`
var Zk=Object.create;var{getPrototypeOf:Ck,defineProperty:l,getOwnPropertyNames:Gk}=Object;var Lk=Object.prototype.hasOwnProperty;var jk=(k,M,D)=>{D=k!=null?Zk(Ck(k)):{};let R=M||!k||!k.__esModule?l(D,"default",{value:k,enumerable:!0}):D;for(let A of Gk(k))if(!Lk.call(R,A))l(R,A,{get:()=>k[A],enumerable:!0});return R};var nk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Kk=nk((lk,Bk)=>{var d,s,f,c,p,g,yk,Tk;function wk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,D=Math.exp(-M),R=Math.exp(-2*M),A=(1-D)*(1-D)/(1+2*M*D-R);return d=A,s=A*(M-1)*D,f=A*(M+1)*D,c=-A*R,p=2*D,g=-R,yk=(d+s)/(1-p-g),Tk=(f+c)/(1-p-g),new Float32Array([d,s,f,c,p,g,yk,Tk])}function Uk(k,M,D,R,A,K){var I,q,T,y,U,C,G,B,$,Z,Q,L,J,j,m,O,n,z,X,N,Y,E,V,w,x,u,S,F,H,W;for(x=0;x<K;x++){E=x*A,V=x,w=0,I=k[E],q=I&255,T=I>>8&255,y=I>>16&255,U=I>>24&255,z=q*R[6],X=T*R[6],N=y*R[6],Y=U*R[6],j=z,m=X,O=N,n=Y,S=R[0],F=R[1],H=R[4],W=R[5];for(u=0;u<A;u++)I=k[E],C=I&255,G=I>>8&255,B=I>>16&255,$=I>>24&255,Z=C*S+q*F+j*H+z*W,Q=G*S+T*F+m*H+X*W,L=B*S+y*F+O*H+N*W,J=$*S+U*F+n*H+Y*W,z=j,X=m,N=O,Y=n,j=Z,m=Q,O=L,n=J,q=C,T=G,y=B,U=$,D[w]=j,D[w+1]=m,D[w+2]=O,D[w+3]=n,w+=4,E++;E--,w-=4,V+=K*(A-1),I=k[E],q=I&255,T=I>>8&255,y=I>>16&255,U=I>>24&255,z=q*R[7],X=T*R[7],N=y*R[7],Y=U*R[7],j=z,m=X,O=N,n=Y,C=q,G=T,B=y,$=U,S=R[2],F=R[3];for(u=A-1;u>=0;u--)Z=C*S+q*F+j*H+z*W,Q=G*S+T*F+m*H+X*W,L=B*S+y*F+O*H+N*W,J=$*S+U*F+n*H+Y*W,z=j,X=m,N=O,Y=n,j=Z,m=Q,O=L,n=J,q=C,T=G,y=B,U=$,I=k[E],C=I&255,G=I>>8&255,B=I>>16&255,$=I>>24&255,I=(D[w]+j<<0)+(D[w+1]+m<<8)+(D[w+2]+O<<16)+(D[w+3]+n<<24),M[V]=I,E--,w-=4,V-=K}}function Nk(k,M,D,R){if(!R)return;var A=new Uint32Array(k.buffer),K=new Uint32Array(A.length),I=new Float32Array(Math.max(M,D)*4),q=wk(R);Uk(A,K,I,q,M,D,R),Uk(K,A,I,q,D,M,R)}Bk.exports=Nk});var h=4;var mk=2;function _(k,M,D,R,A,K){let I=D/k,q=R/M,T=(2*K+mk+1)/A;if(T>0.5)return[{toWidth:D,toHeight:R}];let y=Math.ceil(Math.log(Math.min(I,q))/Math.log(T));if(y<=1)return[{toWidth:D,toHeight:R}];let U=[];for(let C=0;C<y;C++){let G=Math.round(Math.pow(Math.pow(k,y-C-1)*Math.pow(D,C+1),1/y)),B=Math.round(Math.pow(Math.pow(M,y-C-1)*Math.pow(R,C+1),1/y));U.push({toWidth:G,toHeight:B})}return U}function i(k,M,D){let R=new Uint8ClampedArray(D.width*D.height*h);for(let A=0;A<D.height;A++){let K=((D.y+A)*M+D.x)*h,I=A*D.width*h;R.set(k.subarray(K,K+D.width*h),I)}return R}var e=0.00001;function a(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.floor(k)}function t(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.ceil(k)}function r(k,M,D,R,A,K,I,q,T,y,U){let C=R/M,G=A/D,B=a(K*C)-2*I,$=a(K*G)-2*I;if(B<1||$<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let Z,Q,L,J,j,m,O=[];for(J=0;J<A;J+=$)for(L=0;L<R;L+=B){if(Z=L-I,Z<0)Z=0;if(j=L+B+I-Z,Z+j>=R)j=R-Z;if(Q=J-I,Q<0)Q=0;if(m=J+$+I-Q,Q+m>=A)m=A-Q;let n={toX:Z,toY:Q,toWidth:j,toHeight:m,toInnerX:L,toInnerY:J,toInnerWidth:B,toInnerHeight:$,offsetX:Z/C-a(Z/C),offsetY:Q/G-a(Q/G),scaleX:C,scaleY:G,x:a(Z/C),y:a(Q/G),width:t(j/C),height:t(m/G),initialSize:K,filterPadding:I,filter:q,unsharpAmount:T,unsharpRadius:y,unsharpThreshold:U},z=i(k,M,n);O.push({tile:z.buffer,...n})}return O}async function kk(k){let M,D,R,A,K,I;if(k.image instanceof Blob){let T=await createImageBitmap(k.image),U=new OffscreenCanvas(T.width,T.height).getContext("2d");if(!U)throw new Error("Canvas 2D context not supported");U.drawImage(T,0,0),M=U.getImageData(0,0,T.width,T.height).data,D=T.width,R=T.height,T.close();let G=k.maxDimension/D,B=k.maxDimension/R,$=Math.min(G,B,1),Z=Math.floor(D*$),Q=Math.floor(R*$);I=_(D,R,Z,Q,k.tileOptions.initialSize,k.tileOptions.filterPadding)}else M=k.image.from,D=k.image.fromWidth,R=k.image.fromHeight,I=k.image.stages;A=I[0].toWidth,K=I[0].toHeight;let q=r(M,D,R,A,K,k.tileOptions.initialSize,k.tileOptions.filterPadding,k.tileOptions.filter,k.tileOptions.unsharpAmount,k.tileOptions.unsharpRadius,k.tileOptions.unsharpThreshold);return{from:M.buffer,fromWidth:D,fromHeight:R,tileTransforms:q,stages:I}}var v={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var zk=14;function Mk(k){return Math.round(k*((1<<zk)-1))}function o(k,M,D,R,A){let K=v[k].fn,I=1/R,q=Math.min(1,R),T=v[k].win/q,y,U,C,G,B,$,Z,Q,L,J,j,m,O,n,z,X,N,Y=Math.floor((T+1)*2),E=new Int16Array((Y+2)*D),V=0,w=!E.subarray||!E.set;for(y=0;y<D;y++){U=(y+0.5)*I+A,C=Math.max(0,Math.floor(U-T)),G=Math.min(M-1,Math.ceil(U+T)),B=G-C+1,$=new Float32Array(B),Z=new Int16Array(B),Q=0;for(L=C,J=0;L<=G;L++,J++)j=K((L+0.5-U)*q),Q+=j,$[J]=j;m=0;for(J=0;J<$.length;J++)O=$[J]/Q,m+=O,Z[J]=Mk(O);Z[D>>1]+=Mk(1-m),n=0;while(n<Z.length&&Z[n]===0)n++;if(n<Z.length){z=Z.length-1;while(z>0&&Z[z]===0)z--;if(X=C+n,N=z-n+1,E[V++]=X,E[V++]=N,!w)E.set(Z.subarray(n,z+1),V),V+=N;else for(J=n;J<=z;J++)E[V++]=Z[J]}else E[V++]=0,E[V++]=0}return E}function P(k){return k<0?0:k>255?255:k}function b(k){return k>=0?k:0}function Rk(k,M,D,R,A,K){let I,q,T,y,U,C,G,B,$,Z,Q,L=0,J=0;for($=0;$<R;$++){U=0;for(Z=0;Z<A;Z++){C=K[U++],G=K[U++],B=L+C*4|0,I=q=T=y=0;for(;G>0;G--)Q=K[U++],y=y+Q*k[B+3]|0,T=T+Q*k[B+2]|0,q=q+Q*k[B+1]|0,I=I+Q*k[B]|0,B=B+4|0;M[J+3]=b(y>>7),M[J+2]=b(T>>7),M[J+1]=b(q>>7),M[J]=b(I>>7),J=J+R*4|0}J=($+1)*4|0,L=($+1)*D*4|0}}function Ik(k,M,D,R,A,K){let I,q,T,y,U,C,G,B,$,Z,Q,L=0,J=0;for($=0;$<R;$++){U=0;for(Z=0;Z<A;Z++){C=K[U++],G=K[U++],B=L+C*4|0,I=q=T=y=0;for(;G>0;G--)Q=K[U++],y=y+Q*k[B+3]|0,T=T+Q*k[B+2]|0,q=q+Q*k[B+1]|0,I=I+Q*k[B]|0,B=B+4|0;I>>=7,q>>=7,T>>=7,y>>=7,M[J+3]=P(y+8192>>14),M[J+2]=P(T+8192>>14),M[J+1]=P(q+8192>>14),M[J]=P(I+8192>>14),J=J+R*4|0}J=($+1)*4|0,L=($+1)*D*4|0}}function Dk(k,M,D,R,A,K){let I,q,T,y,U,C,G,B,$,Z,Q,L,J=0,j=0;for(Z=0;Z<R;Z++){C=0;for(Q=0;Q<A;Q++){G=K[C++],B=K[C++],$=J+G*4|0,I=q=T=y=0;for(;B>0;B--)L=K[C++],U=k[$+3],y=y+L*U|0,T=T+L*k[$+2]*U|0,q=q+L*k[$+1]*U|0,I=I+L*k[$]*U|0,$=$+4|0;T=T/255|0,q=q/255|0,I=I/255|0,M[j+3]=b(y>>7),M[j+2]=b(T>>7),M[j+1]=b(q>>7),M[j]=b(I>>7),j=j+R*4|0}j=(Z+1)*4|0,J=(Z+1)*D*4|0}}function qk(k,M,D,R,A,K){let I,q,T,y,U,C,G,B,$,Z,Q,L=0,J=0;for($=0;$<R;$++){U=0;for(Z=0;Z<A;Z++){C=K[U++],G=K[U++],B=L+C*4|0,I=q=T=y=0;for(;G>0;G--)Q=K[U++],y=y+Q*k[B+3]|0,T=T+Q*k[B+2]|0,q=q+Q*k[B+1]|0,I=I+Q*k[B]|0,B=B+4|0;if(I>>=7,q>>=7,T>>=7,y>>=7,y=P(y+8192>>14),y>0)I=I*255/y|0,q=q*255/y|0,T=T*255/y|0;M[J+3]=y,M[J+2]=P(T+8192>>14),M[J+1]=P(q+8192>>14),M[J]=P(I+8192>>14),J=J+R*4|0}J=($+1)*4|0,L=($+1)*D*4|0}}function Ek(k,M,D){let R=3,A=M*D*4|0;while(R<A){if(k[R]!==255)return!0;R=R+4|0}return!1}function Ok(k,M,D){let R=3,A=M*D*4|0;while(R<A)k[R]=255,R=R+4|0}function Ak(k,M,D,R,A,K,I,q,T,y){let U=o(M,D,A,I,T),C=o(M,R,K,q,y),G=new Uint8Array(A*K*4),B=new Uint16Array(A*R*4);if(Ek(k,D,R))Dk(k,B,D,R,A,U),qk(B,G,R,A,K,C);else Rk(k,B,D,R,A,U),Ik(B,G,R,A,K,C),Ok(G,A,K);return G}var Jk=jk(Kk(),1);function Vk(k,M,D){let R=M*D,A=new Uint16Array(R),K,I,q,T;for(let y=0;y<R;y++)K=k[4*y],I=k[4*y+1],q=k[4*y+2],T=K>=I&&K>=q?K:I>=q&&I>=K?I:q,A[y]=T<<8;return A}function Qk(k,M,D,R,A,K){let I,q,T,y,U;if(R===0||A<0.5)return;if(A>2)A=2;let C=Vk(k,M,D),G=new Uint16Array(C);Jk.default(G,M,D,A);let B=R/100*4096+0.5|0,$=K<<8,Z=M*D;for(let Q=0;Q<Z;Q++)if(I=C[Q],y=I-G[Q],Math.abs(y)>=$)q=I+(B*y+2048>>12),q=q>65280?65280:q,q=q<0?0:q,I=I!==0?I:1,T=(q<<12)/I|0,U=Q*4,k[U]=k[U]*T+2048>>12,k[U+1]=k[U+1]*T+2048>>12,k[U+2]=k[U+2]*T+2048>>12}function $k(k){let M=Ak(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Qk(M,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return M}var Xk=async(k)=>{let{taskId:M,squishId:D,taskType:R,image:A,maxDimension:K,tileOptions:I}=k,q=await kk({image:A,maxDimension:K,tileOptions:I}),T={taskId:M,squishId:D,taskType:R,output:{from:q.from,fromWidth:q.fromWidth,fromHeight:q.fromHeight,tileTransforms:q.tileTransforms,stages:q.stages}},y=q.tileTransforms.map((U)=>U.tile);self.postMessage(T,[q.from,...y])};function Yk(k){let{taskId:M,squishId:D,taskType:R,tileTransform:A}=k;A.tile=$k(A).buffer;let K={taskId:M,squishId:D,taskType:R,output:{tileTransform:A}};self.postMessage(K,[A.tile])}self.onmessage=async(k)=>{try{switch(k.data.taskType){case 0:return Xk(k.data);case 1:return Yk(k.data)}}catch(M){self.postMessage({taskId:k.data.taskId,squishId:k.data.squishId,taskType:k.data.taskType,error:M})}};
`,Hn=new Blob([Fn],{type:"application/javascript"});class Cn{#n;#k;#T;#R;constructor(){this.#n=new Map,this.#k=new Map,this.#T=null,this.#R=null}#I(){if(this.#T===null)return;clearTimeout(this.#T),this.#T=null}prepare(n,k,R){if(this.#n.size)return;this.#R=R;let T=URL.createObjectURL(Hn);while(this.#n.size<k){let M=new Worker(T);M.onmessage=n,this.#n.set(M,null)}URL.revokeObjectURL(T)}assignTask(n,k,R,T){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#I(),n.postMessage(R,T)}setTimeout(){if(this.#T!==null)return;this.#T=setTimeout(()=>{for(let n of this.#n.keys())n.terminate();this.#n.clear(),this.#k.clear()},this.#R||0)}getAvailableWorkers(){let n=[];for(let[k,R]of this.#n.entries())if(R===null)n.push(k);return n}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n)}}var b=new Cn;var i=(()=>{let n=0;return()=>++n})();class Zn{#n;#k;#T;constructor(){this.#n=new Map,this.#k=[],this.#T=[]}#R(n,k){let R={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions};b.assignTask(n,k,R,[])}#I(n,k){let R={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};b.assignTask(n,k,R,[R.tileTransform.tile])}#m(n){let k=this.#k.shift();if(k)return this.#R(n,k);let R=this.#T.shift();if(R)return this.#I(n,R)}#M(){if(this.#k.length===0&&this.#T.length===0)return b.setTimeout();let k=b.getAvailableWorkers();for(let R of k)this.#m(R)}#D(n,k){let{squishId:R,output:T}=k,M=T.stages[0].toWidth,A=T.stages[0].toHeight;n.from=new Uint8ClampedArray(T.from),n.fromWidth=T.fromWidth,n.fromHeight=T.fromHeight,n.to=new Uint8ClampedArray(M*A*X),n.toWidth=M,n.toHeight=A,n.stages=T.stages,n.remainingTileCount=T.tileTransforms.length;for(let I of T.tileTransforms)this.#T.push({id:i(),squishId:R,data:{tileTransform:I}})}#y(n,k){let{squishId:R,output:T}=k;if(!n.to)throw new Error("SquishContext to not found");if(s(n.to,n.toWidth,T.tileTransform),n.remainingTileCount--,!n.remainingTileCount)if(n.stages.shift(),n.stages[0])this.#k.push({id:i(),squishId:R,data:{image:{from:n.to,fromWidth:n.toWidth,fromHeight:n.toHeight,stages:n.stages},maxDimension:n.maxDimension,tileOptions:n.tileOptions}});else{let M=new ImageData(n.to,n.toWidth,n.toHeight);createImageBitmap(M).then((A)=>{this.#n.delete(R),n.resolve(A)})}}#A(n){let k=this.#n.get(n.data.squishId);if(!k)throw new Error("SquishContext not found");if(n.data.error)k.reject(n.data.error);switch(n.data.taskType){case 0:this.#D(k,n.data);break;case 1:this.#y(k,n.data);break}b.removeTask(n.data.taskId),this.#M()}add(n,k,R){return b.prepare((T)=>this.#A(T),k,R),new Promise((T,M)=>{let A=i();this.#n.set(A,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:T,reject:M}),this.#k.push({id:A,squishId:A,data:n}),this.#M()})}}var jn=new Zn;class Pn{#n;constructor(n){this.#n=n}async#k(n,k,R){let T=null,M,A,I,D,y,m;for(;;){let B=await Rn({image:T||n,maxDimension:k,tileOptions:R});M=new Uint8ClampedArray(B.from),A=B.fromWidth,I=B.fromHeight,y=B.stages[0].toWidth,m=B.stages[0].toHeight,D=new Uint8ClampedArray(y*m*X);for(let w of B.tileTransforms)w.tile=$n(w).buffer,s(D,y,w);if(B.stages.shift(),T={from:D,fromWidth:y,fromHeight:m,stages:B.stages},!B.stages[0])break}let U=new ImageData(T.from,T.fromWidth,T.fromHeight);return await createImageBitmap(U)}async squish(n,k){let R=k?{...this.#n,...k}:this.#n,T=R.maxDimension,M=R.tileSize||1024,A=R.filter||"mks2013",I=R.unsharpAmount||0,D=R.unsharpRadius||0,y=R.unsharpThreshold||0,m=R.useMainThread,U=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,B=R.maxWorkerPoolSize||Math.min(U,4),w=R.maxWorkerIdleTime||2000,Q=3,J=Math.ceil(Math.max(3,2.5*D|0)),K={initialSize:M,filterPadding:J,filter:A,unsharpAmount:I,unsharpRadius:D,unsharpThreshold:y};if(m)return await this.#k(n,T,K);return jn.add({image:n,maxDimension:T,tileOptions:K},B,w)}}export{Pn as PicSquish};
