var ND=Object.create;var{getPrototypeOf:XD,defineProperty:f,getOwnPropertyNames:ED}=Object;var YD=Object.prototype.hasOwnProperty;var zD=(D,A,J)=>{J=D!=null?ND(XD(D)):{};let U=A||!D||!D.__esModule?f(J,"default",{value:D,enumerable:!0}):J;for(let K of ED(D))if(!YD.call(U,K))f(U,K,{get:()=>D[K],enumerable:!0});return U};var CD=(D,A)=>()=>(A||D((A={exports:{}}).exports,A),A.exports);var bD=CD((G8,BD)=>{var x,n,m,h,w,_,$D,GD;function TD(D){if(D<0.5)D=0.5;var A=Math.exp(0.527076)/D,J=Math.exp(-A),U=Math.exp(-2*A),K=(1-J)*(1-J)/(1+2*A*J-U);return x=K,n=K*(A-1)*J,m=K*(A+1)*J,h=-K*U,w=2*J,_=-U,$D=(x+n)/(1-w-_),GD=(m+h)/(1-w-_),new Float32Array([x,n,m,h,w,_,$D,GD])}function ZD(D,A,J,U,K,G){var $,Z,b,B,y,Q,V,j,R,q,L,N,M,X;for(R=0;R<G;R++){Q=R*K,V=R,j=0,$=D[Q],y=$*U[6],B=y,L=U[0],N=U[1],M=U[4],X=U[5];for(q=0;q<K;q++)Z=D[Q],b=Z*L+$*N+B*M+y*X,y=B,B=b,$=Z,J[j]=B,j++,Q++;Q--,j--,V+=G*(K-1),$=D[Q],y=$*U[7],B=y,Z=$,L=U[2],N=U[3];for(q=K-1;q>=0;q--)b=Z*L+$*N+B*M+y*X,y=B,B=b,$=Z,Z=D[Q],A[V]=J[j]+B,Q--,j--,V-=G}}function pD(D,A,J,U){if(!U)return;var K=new Uint16Array(D.length),G=new Float32Array(Math.max(A,J)),$=TD(U);ZD(D,K,G,$,A,J,U),ZD(K,D,G,$,J,A,U)}BD.exports=pD});class T{raw;width;height;constructor(D,A,J){this.raw=D,this.width=A,this.height=J}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let D=document.createElement("canvas");D.width=this.width,D.height=this.height;let A=D.getContext("2d");if(!A)throw new Error("Picsquish error: canvas 2D context not supported");return A.putImageData(this.toImageData(),0,0),D}toBlob(D){let A=new OffscreenCanvas(this.width,this.height),J=A.getContext("2d");if(!J)throw new Error("Picsquish error: canvas 2D context not supported");return J.putImageData(this.toImageData(),0,0),A.convertToBlob(D)}}var Y=4;function a(D,A,J){let U=new Uint8ClampedArray(J.tile);for(let K=0;K<J.toHeight;K++){let G=K*J.toWidth*Y,$=((J.toY+K)*A+J.toX)*Y;D.set(U.subarray(G,G+J.toWidth*Y),$)}}var ID=`
var Kk=Object.create;var{getPrototypeOf:$k,defineProperty:m,getOwnPropertyNames:Bk}=Object;var Gk=Object.prototype.hasOwnProperty;var Qk=(k,u,I)=>{I=k!=null?Kk($k(k)):{};let M=u||!k||!k.__esModule?m(I,"default",{value:k,enumerable:!0}):I;for(let D of Bk(k))if(!Gk.call(M,D))m(M,D,{get:()=>k[D],enumerable:!0});return M};var Zk=(k,u)=>()=>(u||k((u={exports:{}}).exports,u),u.exports);var Ik=Zk((sk,Mk)=>{var v,_,x,g,T,p,i,kk;function Xk(k){if(k<0.5)k=0.5;var u=Math.exp(0.527076)/k,I=Math.exp(-u),M=Math.exp(-2*u),D=(1-I)*(1-I)/(1+2*u*I-M);return v=D,_=D*(u-1)*I,x=D*(u+1)*I,g=-D*M,T=2*I,p=-M,i=(v+_)/(1-T-p),kk=(x+g)/(1-T-p),new Float32Array([v,_,x,g,T,p,i,kk])}function uk(k,u,I,M,D,J){var q,y,U,R,K,Q,b,A,B,Z,G,j,$,C;for(B=0;B<J;B++){Q=B*D,b=B,A=0,q=k[Q],K=q*M[6],R=K,G=M[0],j=M[1],$=M[4],C=M[5];for(Z=0;Z<D;Z++)y=k[Q],U=y*G+q*j+R*$+K*C,K=R,R=U,q=y,I[A]=R,A++,Q++;Q--,A--,b+=J*(D-1),q=k[Q],K=q*M[7],R=K,y=q,G=M[2],j=M[3];for(Z=D-1;Z>=0;Z--)U=y*G+q*j+R*$+K*C,K=R,R=U,q=y,y=k[Q],u[b]=I[A]+R,Q--,A--,b-=J}}function Yk(k,u,I,M){if(!M)return;var D=new Uint16Array(k.length),J=new Float32Array(Math.max(u,I)),q=Xk(M);uk(k,D,J,q,u,I,M),uk(D,k,J,q,I,u,M)}Mk.exports=Yk});var S=4;var bk=2;function a(k,u,I,M,D,J){let q=I/k,y=M/u,U=(2*J+bk+1)/D;if(U>0.5)return[{toWidth:I,toHeight:M}];let R=Math.ceil(Math.log(Math.min(q,y))/Math.log(U));if(R<=1)return[{toWidth:I,toHeight:M}];let K=[];for(let Q=0;Q<R;Q++){let b=Math.round(Math.pow(Math.pow(k,R-Q-1)*Math.pow(I,Q+1),1/R)),A=Math.round(Math.pow(Math.pow(u,R-Q-1)*Math.pow(M,Q+1),1/R));K.push({toWidth:b,toHeight:A})}return K}function jk(k,u){if(k)k.width=k.height=0;k=u=null}function Ck(k,u){let I=new OffscreenCanvas(u.width,u.height),M=I.getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");M.globalCompositeOperation="copy",M.drawImage(k,u.x,u.y,u.width,u.height,0,0,u.width,u.height);let D=M.getImageData(0,0,u.width,u.height).data.buffer;return jk(I,M),D}function Lk(k,u,I){let M=new Uint8ClampedArray(I.width*I.height*S);for(let D=0;D<I.height;D++){let J=((I.y+D)*u+I.x)*S,q=D*I.width*S;M.set(k.subarray(J,J+I.width*S),q)}return M.buffer}function h(k,u,I){if(k instanceof ImageBitmap)return Ck(k,I);else return Lk(k,u,I)}var o=0.00001;function O(k){let u=Math.round(k);if(Math.abs(k-u)<o)return u;return Math.floor(k)}function d(k){let u=Math.round(k);if(Math.abs(k-u)<o)return u;return Math.ceil(k)}function P(k,u,I,M,D,J){let{initialSize:q,filterPadding:y,filter:U,unsharpAmount:R,unsharpRadius:K,unsharpThreshold:Q}=J,b=M/u,A=D/I,B=O(q*b)-2*y,Z=O(q*A)-2*y;if(B<1||Z<1)throw new Error("Picsquish error: target tile width/height is too small");let G,j,$,C,V,z,L=[];for(C=0;C<D;C+=Z)for($=0;$<M;$+=B){if(G=$-y,G<0)G=0;if(V=$+B+y-G,G+V>=M)V=M-G;if(j=C-y,j<0)j=0;if(z=C+Z+y-j,j+z>=D)z=D-j;let w={toX:G,toY:j,toWidth:V,toHeight:z,toInnerX:$,toInnerY:C,toInnerWidth:B,toInnerHeight:Z,offsetX:G/b-O(G/b),offsetY:j/A-O(j/A),scaleX:b,scaleY:A,x:O(G/b),y:O(j/A),width:d(V/b),height:d(z/A),initialSize:q,filterPadding:y,filter:U,unsharpAmount:R,unsharpRadius:K,unsharpThreshold:Q},F=h(k,u,w);L.push({tile:F,...w})}return L}async function wk(k,u,I){let M=await createImageBitmap(k),D=[];for(let J of I){let q=M,y=M.width,U=M.height,R=J/y,K=J/U,Q=Math.min(R,K,1),b=Math.floor(y*Q),A=Math.floor(U*Q),B=a(y,U,b,A,u.initialSize,u.filterPadding),Z=P(q,y,U,B[0].toWidth,B[0].toHeight,u);D.push({stages:B,tileTransforms:Z})}return M.close(),D}function Vk(k,u){let I=P(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,u);return[{stages:k.stages,tileTransforms:I}]}async function c(k){if(k.image instanceof Blob)return wk(k.image,k.tileOptions,k.dimensionLimits);else return Vk(k.image,k.tileOptions)}var W={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*(0.54+0.46*Math.cos(u/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/2)/(u/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/3)/(u/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var zk=14;function s(k){return Math.round(k*((1<<zk)-1))}function n(k,u,I,M,D){let J=W[k].fn,q=1/M,y=Math.min(1,M),U=W[k].win/y,R,K,Q,b,A,B,Z,G,j,$,C,V,z,L,w,F,H,Ak=Math.floor((U+1)*2),N=new Int16Array((Ak+2)*I),Y=0,Jk=!N.subarray||!N.set;for(R=0;R<I;R++){K=(R+0.5)*q+D,Q=Math.max(0,Math.floor(K-U)),b=Math.min(u-1,Math.ceil(K+U)),A=b-Q+1,B=new Float32Array(A),Z=new Int16Array(A),G=0;for(j=Q,$=0;j<=b;j++,$++)C=J((j+0.5-K)*y),G+=C,B[$]=C;V=0;for($=0;$<B.length;$++)z=B[$]/G,V+=z,Z[$]=s(z);Z[I>>1]+=s(1-V),L=0;while(L<Z.length&&Z[L]===0)L++;if(L<Z.length){w=Z.length-1;while(w>0&&Z[w]===0)w--;if(F=Q+L,H=w-L+1,N[Y++]=F,N[Y++]=H,!Jk)N.set(Z.subarray(L,w+1),Y),Y+=H;else for($=L;$<=w;$++)N[Y++]=Z[$]}else N[Y++]=0,N[Y++]=0}return N}function E(k){return k<0?0:k>255?255:k}function X(k){return k>=0?k:0}function f(k,u,I,M,D,J){let q,y,U,R,K,Q,b,A,B,Z,G,j=0,$=0;for(B=0;B<M;B++){K=0;for(Z=0;Z<D;Z++){Q=J[K++],b=J[K++],A=j+Q*4|0,q=y=U=R=0;for(;b>0;b--)G=J[K++],R=R+G*k[A+3]|0,U=U+G*k[A+2]|0,y=y+G*k[A+1]|0,q=q+G*k[A]|0,A=A+4|0;u[$+3]=X(R>>7),u[$+2]=X(U>>7),u[$+1]=X(y>>7),u[$]=X(q>>7),$=$+M*4|0}$=(B+1)*4|0,j=(B+1)*I*4|0}}function l(k,u,I,M,D,J){let q,y,U,R,K,Q,b,A,B,Z,G,j=0,$=0;for(B=0;B<M;B++){K=0;for(Z=0;Z<D;Z++){Q=J[K++],b=J[K++],A=j+Q*4|0,q=y=U=R=0;for(;b>0;b--)G=J[K++],R=R+G*k[A+3]|0,U=U+G*k[A+2]|0,y=y+G*k[A+1]|0,q=q+G*k[A]|0,A=A+4|0;q>>=7,y>>=7,U>>=7,R>>=7,u[$+3]=E(R+8192>>14),u[$+2]=E(U+8192>>14),u[$+1]=E(y+8192>>14),u[$]=E(q+8192>>14),$=$+M*4|0}$=(B+1)*4|0,j=(B+1)*I*4|0}}function r(k,u,I,M,D,J){let q,y,U,R,K,Q,b,A,B,Z,G,j,$=0,C=0;for(Z=0;Z<M;Z++){Q=0;for(G=0;G<D;G++){b=J[Q++],A=J[Q++],B=$+b*4|0,q=y=U=R=0;for(;A>0;A--)j=J[Q++],K=k[B+3],R=R+j*K|0,U=U+j*k[B+2]*K|0,y=y+j*k[B+1]*K|0,q=q+j*k[B]*K|0,B=B+4|0;U=U/255|0,y=y/255|0,q=q/255|0,u[C+3]=X(R>>7),u[C+2]=X(U>>7),u[C+1]=X(y>>7),u[C]=X(q>>7),C=C+M*4|0}C=(Z+1)*4|0,$=(Z+1)*I*4|0}}function e(k,u,I,M,D,J){let q,y,U,R,K,Q,b,A,B,Z,G,j=0,$=0;for(B=0;B<M;B++){K=0;for(Z=0;Z<D;Z++){Q=J[K++],b=J[K++],A=j+Q*4|0,q=y=U=R=0;for(;b>0;b--)G=J[K++],R=R+G*k[A+3]|0,U=U+G*k[A+2]|0,y=y+G*k[A+1]|0,q=q+G*k[A]|0,A=A+4|0;if(q>>=7,y>>=7,U>>=7,R>>=7,R=E(R+8192>>14),R>0)q=q*255/R|0,y=y*255/R|0,U=U*255/R|0;u[$+3]=R,u[$+2]=E(U+8192>>14),u[$+1]=E(y+8192>>14),u[$]=E(q+8192>>14),$=$+M*4|0}$=(B+1)*4|0,j=(B+1)*I*4|0}}function Nk(k,u,I){let M=3,D=u*I*4|0;while(M<D){if(k[M]!==255)return!0;M=M+4|0}return!1}function Ek(k,u,I){let M=3,D=u*I*4|0;while(M<D)k[M]=255,M=M+4|0}function t(k,u,I,M,D,J,q,y,U,R){let K=n(u,I,D,q,U),Q=n(u,M,J,y,R),b=new Uint8Array(D*J*4),A=new Uint16Array(D*M*4);if(Nk(k,I,M))r(k,A,I,M,D,K),e(A,b,M,D,J,Q);else f(k,A,I,M,D,K),l(A,b,M,D,J,Q),Ek(b,D,J);return b}var qk=Qk(Ik(),1);function Ok(k,u,I){let M=u*I,D=new Uint16Array(M),J,q,y,U;for(let R=0;R<M;R++)J=k[4*R],q=k[4*R+1],y=k[4*R+2],U=J>=q&&J>=y?J:q>=y&&q>=J?q:y,D[R]=U<<8;return D}function Dk(k,u,I,M,D,J){let q,y,U,R,K;if(M===0||D<0.5)return;if(D>2)D=2;let Q=Ok(k,u,I),b=new Uint16Array(Q);qk.default(b,u,I,D);let A=M/100*4096+0.5|0,B=J<<8,Z=u*I;for(let G=0;G<Z;G++)if(q=Q[G],R=q-b[G],Math.abs(R)>=B)y=q+(A*R+2048>>12),y=y>65280?65280:y,y=y<0?0:y,q=q!==0?q:1,U=(y<<12)/q|0,K=G*4,k[K]=k[K]*U+2048>>12,k[K+1]=k[K+1]*U+2048>>12,k[K+2]=k[K+2]*U+2048>>12}function yk(k){let u=t(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Dk(u,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return u}async function Rk(k){let{taskId:u,squishId:I,taskType:M,data:D}=k,{image:J,dimensionLimits:q,tileOptions:y}=D;try{let U=await c({image:J,dimensionLimits:q,tileOptions:y});return{taskId:u,squishId:I,taskType:M,output:U}}catch(U){return{taskId:u,squishId:I,taskType:M,output:U}}}function Uk(k){let{taskId:u,squishId:I,workspaceIndex:M,taskType:D,data:J}=k,{tileTransform:q}=J;try{return q.tile=yk(q).buffer,{taskId:u,squishId:I,workspaceIndex:M,taskType:D,output:q}}catch(y){return{taskId:u,squishId:I,workspaceIndex:M,taskType:D,output:y}}}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let u=k.data,I=await Rk(u),M=I.output instanceof Error?[]:I.output.flatMap((D)=>D.tileTransforms.map((J)=>J.tile));return self.postMessage(I,M)}case 1:{let u=k.data,I=Uk(u),M=I.output instanceof Error?[]:[I.output.tile];return self.postMessage(I,M)}}};
`,OD=new Blob([ID],{type:"application/javascript"});class l{#D;#U;#A;#J;constructor(){this.#D=new Map,this.#U=new Map,this.#A=null,this.#J=null}#K(){if(this.#A===null)return;clearTimeout(this.#A),this.#A=null}prepare(D,A,J){if(this.#D.size)return;this.#J=J;let U=URL.createObjectURL(OD);while(this.#D.size<A){let K=new Worker(U);K.onmessage=D,this.#D.set(K,null)}URL.revokeObjectURL(U)}assignTask(D,A,J,U){this.#D.set(D,A),this.#U.set(A,D),this.#K(),D.postMessage(J,U)}setTimeout(){if(this.#A!==null)return;if(this.#D.size===0)return;this.#A=setTimeout(()=>{for(let D of this.#D.keys())D.terminate();this.#D.clear(),this.#U.clear()},this.#J||0)}getAvailableWorkers(){let D=[];for(let[A,J]of this.#D.entries())if(J===null)D.push(A);return D}removeTask(D){let A=this.#U.get(D);if(A)this.#D.set(A,null);this.#U.delete(D)}}var v=new l;var FD=2;function o(D,A,J,U,K,G){let $=J/D,Z=U/A,b=(2*G+FD+1)/K;if(b>0.5)return[{toWidth:J,toHeight:U}];let B=Math.ceil(Math.log(Math.min($,Z))/Math.log(b));if(B<=1)return[{toWidth:J,toHeight:U}];let y=[];for(let Q=0;Q<B;Q++){let V=Math.round(Math.pow(Math.pow(D,B-Q-1)*Math.pow(J,Q+1),1/B)),j=Math.round(Math.pow(Math.pow(A,B-Q-1)*Math.pow(U,Q+1),1/B));y.push({toWidth:V,toHeight:j})}return y}function SD(D,A){if(D)D.width=D.height=0;D=A=null}function HD(D,A){let J=new OffscreenCanvas(A.width,A.height),U=J.getContext("2d");if(!U)throw new Error("Picsquish error: canvas 2D context not supported");U.globalCompositeOperation="copy",U.drawImage(D,A.x,A.y,A.width,A.height,0,0,A.width,A.height);let K=U.getImageData(0,0,A.width,A.height).data.buffer;return SD(J,U),K}function vD(D,A,J){let U=new Uint8ClampedArray(J.width*J.height*Y);for(let K=0;K<J.height;K++){let G=((J.y+K)*A+J.x)*Y,$=K*J.width*Y;U.set(D.subarray(G,G+J.width*Y),$)}return U.buffer}function s(D,A,J){if(D instanceof ImageBitmap)return HD(D,J);else return vD(D,A,J)}var i=0.00001;function W(D){let A=Math.round(D);if(Math.abs(D-A)<i)return A;return Math.floor(D)}function r(D){let A=Math.round(D);if(Math.abs(D-A)<i)return A;return Math.ceil(D)}function p(D,A,J,U,K,G){let{initialSize:$,filterPadding:Z,filter:b,unsharpAmount:B,unsharpRadius:y,unsharpThreshold:Q}=G,V=U/A,j=K/J,R=W($*V)-2*Z,q=W($*j)-2*Z;if(R<1||q<1)throw new Error("Picsquish error: target tile width/height is too small");let L,N,M,X,C,I,E=[];for(X=0;X<K;X+=q)for(M=0;M<U;M+=R){if(L=M-Z,L<0)L=0;if(C=M+R+Z-L,L+C>=U)C=U-L;if(N=X-Z,N<0)N=0;if(I=X+q+Z-N,N+I>=K)I=K-N;let z={toX:L,toY:N,toWidth:C,toHeight:I,toInnerX:M,toInnerY:X,toInnerWidth:R,toInnerHeight:q,offsetX:L/V-W(L/V),offsetY:N/j-W(N/j),scaleX:V,scaleY:j,x:W(L/V),y:W(N/j),width:r(C/V),height:r(I/j),initialSize:$,filterPadding:Z,filter:b,unsharpAmount:B,unsharpRadius:y,unsharpThreshold:Q},P=s(D,A,z);E.push({tile:P,...z})}return E}async function WD(D,A,J){let U=await createImageBitmap(D),K=[];for(let G of J){let $=U,Z=U.width,b=U.height,B=G/Z,y=G/b,Q=Math.min(B,y,1),V=Math.floor(Z*Q),j=Math.floor(b*Q),R=o(Z,b,V,j,A.initialSize,A.filterPadding),q=p($,Z,b,R[0].toWidth,R[0].toHeight,A);K.push({stages:R,tileTransforms:q})}return U.close(),K}function PD(D,A){let J=p(D.from,D.fromWidth,D.fromHeight,D.stages[0].toWidth,D.stages[0].toHeight,A);return[{stages:D.stages,tileTransforms:J}]}async function t(D){if(D.image instanceof Blob)return WD(D.image,D.tileOptions,D.dimensionLimits);else return PD(D.image,D.tileOptions)}var k={box:{win:0.5,fn:(D)=>{if(D<0)D=-D;return D<0.5?1:0}},hamming:{win:1,fn:(D)=>{if(D<0)D=-D;if(D>=1)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*(0.54+0.46*Math.cos(A/1))}},lanczos2:{win:2,fn:(D)=>{if(D<0)D=-D;if(D>=2)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*Math.sin(A/2)/(A/2)}},lanczos3:{win:3,fn:(D)=>{if(D<0)D=-D;if(D>=3)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*Math.sin(A/3)/(A/3)}},mks2013:{win:2.5,fn:(D)=>{if(D<0)D=-D;if(D>=2.5)return 0;if(D>=1.5)return-0.125*(D-2.5)*(D-2.5);if(D>=0.5)return 0.25*(4*D*D-11*D+7);return 1.0625-1.75*D*D}}};var wD=14;function e(D){return Math.round(D*((1<<wD)-1))}function g(D,A,J,U,K){let G=k[D].fn,$=1/U,Z=Math.min(1,U),b=k[D].win/Z,B,y,Q,V,j,R,q,L,N,M,X,C,I,E,z,P,u,qD=Math.floor((b+1)*2),O=new Int16Array((qD+2)*J),H=0,VD=!O.subarray||!O.set;for(B=0;B<J;B++){y=(B+0.5)*$+K,Q=Math.max(0,Math.floor(y-b)),V=Math.min(A-1,Math.ceil(y+b)),j=V-Q+1,R=new Float32Array(j),q=new Int16Array(j),L=0;for(N=Q,M=0;N<=V;N++,M++)X=G((N+0.5-y)*Z),L+=X,R[M]=X;C=0;for(M=0;M<R.length;M++)I=R[M]/L,C+=I,q[M]=e(I);q[J>>1]+=e(1-C),E=0;while(E<q.length&&q[E]===0)E++;if(E<q.length){z=q.length-1;while(z>0&&q[z]===0)z--;if(P=Q+E,u=z-E+1,O[H++]=P,O[H++]=u,!VD)O.set(q.subarray(E,z+1),H),H+=u;else for(M=E;M<=z;M++)O[H++]=q[M]}else O[H++]=0,O[H++]=0}return O}function F(D){return D<0?0:D>255?255:D}function S(D){return D>=0?D:0}function DD(D,A,J,U,K,G){let $,Z,b,B,y,Q,V,j,R,q,L,N=0,M=0;for(R=0;R<U;R++){y=0;for(q=0;q<K;q++){Q=G[y++],V=G[y++],j=N+Q*4|0,$=Z=b=B=0;for(;V>0;V--)L=G[y++],B=B+L*D[j+3]|0,b=b+L*D[j+2]|0,Z=Z+L*D[j+1]|0,$=$+L*D[j]|0,j=j+4|0;A[M+3]=S(B>>7),A[M+2]=S(b>>7),A[M+1]=S(Z>>7),A[M]=S($>>7),M=M+U*4|0}M=(R+1)*4|0,N=(R+1)*J*4|0}}function AD(D,A,J,U,K,G){let $,Z,b,B,y,Q,V,j,R,q,L,N=0,M=0;for(R=0;R<U;R++){y=0;for(q=0;q<K;q++){Q=G[y++],V=G[y++],j=N+Q*4|0,$=Z=b=B=0;for(;V>0;V--)L=G[y++],B=B+L*D[j+3]|0,b=b+L*D[j+2]|0,Z=Z+L*D[j+1]|0,$=$+L*D[j]|0,j=j+4|0;$>>=7,Z>>=7,b>>=7,B>>=7,A[M+3]=F(B+8192>>14),A[M+2]=F(b+8192>>14),A[M+1]=F(Z+8192>>14),A[M]=F($+8192>>14),M=M+U*4|0}M=(R+1)*4|0,N=(R+1)*J*4|0}}function UD(D,A,J,U,K,G){let $,Z,b,B,y,Q,V,j,R,q,L,N,M=0,X=0;for(q=0;q<U;q++){Q=0;for(L=0;L<K;L++){V=G[Q++],j=G[Q++],R=M+V*4|0,$=Z=b=B=0;for(;j>0;j--)N=G[Q++],y=D[R+3],B=B+N*y|0,b=b+N*D[R+2]*y|0,Z=Z+N*D[R+1]*y|0,$=$+N*D[R]*y|0,R=R+4|0;b=b/255|0,Z=Z/255|0,$=$/255|0,A[X+3]=S(B>>7),A[X+2]=S(b>>7),A[X+1]=S(Z>>7),A[X]=S($>>7),X=X+U*4|0}X=(q+1)*4|0,M=(q+1)*J*4|0}}function JD(D,A,J,U,K,G){let $,Z,b,B,y,Q,V,j,R,q,L,N=0,M=0;for(R=0;R<U;R++){y=0;for(q=0;q<K;q++){Q=G[y++],V=G[y++],j=N+Q*4|0,$=Z=b=B=0;for(;V>0;V--)L=G[y++],B=B+L*D[j+3]|0,b=b+L*D[j+2]|0,Z=Z+L*D[j+1]|0,$=$+L*D[j]|0,j=j+4|0;if($>>=7,Z>>=7,b>>=7,B>>=7,B=F(B+8192>>14),B>0)$=$*255/B|0,Z=Z*255/B|0,b=b*255/B|0;A[M+3]=B,A[M+2]=F(b+8192>>14),A[M+1]=F(Z+8192>>14),A[M]=F($+8192>>14),M=M+U*4|0}M=(R+1)*4|0,N=(R+1)*J*4|0}}function _D(D,A,J){let U=3,K=A*J*4|0;while(U<K){if(D[U]!==255)return!0;U=U+4|0}return!1}function uD(D,A,J){let U=3,K=A*J*4|0;while(U<K)D[U]=255,U=U+4|0}function KD(D,A,J,U,K,G,$,Z,b,B){let y=g(A,J,K,$,b),Q=g(A,U,G,Z,B),V=new Uint8Array(K*G*4),j=new Uint16Array(K*U*4);if(_D(D,J,U))UD(D,j,J,U,K,y),JD(j,V,U,K,G,Q);else DD(D,j,J,U,K,y),AD(j,V,U,K,G,Q),uD(V,K,G);return V}var jD=zD(bD(),1);function kD(D,A,J){let U=A*J,K=new Uint16Array(U),G,$,Z,b;for(let B=0;B<U;B++)G=D[4*B],$=D[4*B+1],Z=D[4*B+2],b=G>=$&&G>=Z?G:$>=Z&&$>=G?$:Z,K[B]=b<<8;return K}function yD(D,A,J,U,K,G){let $,Z,b,B,y;if(U===0||K<0.5)return;if(K>2)K=2;let Q=kD(D,A,J),V=new Uint16Array(Q);jD.default(V,A,J,K);let j=U/100*4096+0.5|0,R=G<<8,q=A*J;for(let L=0;L<q;L++)if($=Q[L],B=$-V[L],Math.abs(B)>=R)Z=$+(j*B+2048>>12),Z=Z>65280?65280:Z,Z=Z<0?0:Z,$=$!==0?$:1,b=(Z<<12)/$|0,y=L*4,D[y]=D[y]*b+2048>>12,D[y+1]=D[y+1]*b+2048>>12,D[y+2]=D[y+2]*b+2048>>12}function RD(D){let A=KD(new Uint8ClampedArray(D.tile),D.filter,D.width,D.height,D.toWidth,D.toHeight,D.scaleX,D.scaleY,D.offsetX,D.offsetY);if(D.unsharpAmount)yD(A,D.toWidth,D.toHeight,D.unsharpAmount,D.unsharpRadius,D.unsharpThreshold);return A}async function MD(D){let{taskId:A,squishId:J,taskType:U,data:K}=D,{image:G,dimensionLimits:$,tileOptions:Z}=K;try{let b=await t({image:G,dimensionLimits:$,tileOptions:Z});return{taskId:A,squishId:J,taskType:U,output:b}}catch(b){return{taskId:A,squishId:J,taskType:U,output:b}}}function QD(D){let{taskId:A,squishId:J,workspaceIndex:U,taskType:K,data:G}=D,{tileTransform:$}=G;try{return $.tile=RD($).buffer,{taskId:A,squishId:J,workspaceIndex:U,taskType:K,output:$}}catch(Z){return{taskId:A,squishId:J,workspaceIndex:U,taskType:K,output:Z}}}var c=(()=>{let D=0;return()=>++D})();class LD{#D;#U;#A;constructor(){this.#D=new Map,this.#U=[],this.#A=[]}#J(D,A){let J=c(),U={taskId:J,squishId:D.squishId,taskType:0,data:D.data};if(!A)return MD(U).then((G)=>this.#$(G));let K=D.data.image instanceof ImageBitmap?[D.data.image]:[];v.assignTask(A,J,U,K)}#K(D,A){let J=c(),U={taskId:J,squishId:D.squishId,workspaceIndex:D.workspaceIndex,taskType:1,data:D.data};if(!A)return this.#$(QD(U));v.assignTask(A,J,U,[D.data.tileTransform.tile])}#G(D){let A=this.#U.shift();if(A)return this.#J(A,D);let J=this.#A.shift();if(J)return this.#K(J,D)}#Z(D){if(this.#U.length===0&&this.#A.length===0)return v.setTimeout();if(D)return this.#G();let J=v.getAvailableWorkers();for(let U of J)this.#G(U)}#B(D,A){let{squishId:J,output:U}=A;if(U instanceof Error)return D.workspaceHandlers.forEach((K)=>K.reject(U));for(let[K,G]of U.entries()){let $=G.stages[0].toWidth,Z=G.stages[0].toHeight;D.workspaces.set(K,{to:new Uint8ClampedArray($*Z*Y),toWidth:$,toHeight:Z,stages:G.stages,remainingTileCount:G.tileTransforms.length});for(let b of G.tileTransforms)this.#A.push({squishId:J,workspaceIndex:K,data:{tileTransform:b}})}}#b(D,A){let{squishId:J,workspaceIndex:U,output:K}=A;if(!D.workspaces.has(U))return;let G=D.workspaces.get(U);if(!G)throw new Error("Picsquish error: workspace not found");let $=D.workspaceHandlers.get(U);if(!$)throw new Error("Picsquish error: workspaceHandler not found");if(K instanceof Error)return D.workspaces.delete(U),this.#A=this.#A.filter((b)=>!(b.squishId===J&&b.workspaceIndex===U)),$.reject(K);if(a(G.to,G.toWidth,K),--G.remainingTileCount,G.remainingTileCount)return;if(G.stages.shift(),!G.stages[0])return D.workspaces.delete(U),$.resolve(new T(G.to,G.toWidth,G.toHeight));this.#U.push({squishId:J,data:{image:{from:G.to,fromWidth:G.toWidth,fromHeight:G.toHeight,stages:G.stages},dimensionLimits:[],tileOptions:D.tileOptions}})}#$(D){let A=this.#D.get(D.squishId);if(!A)throw new Error("Picsquish error: squishContext not found");switch(D.taskType){case 0:this.#B(A,D);break;case 1:this.#b(A,D);break}if(!A.workspaces.size)this.#D.delete(D.squishId);v.removeTask(D.taskId),this.#Z(A.useMainThread)}add(D,A,J,U){if(!U)v.prepare((Z)=>this.#$(Z.data),A,J);let K=[],G=new Map;for(let Z=0;Z<D.dimensionLimits.length;Z++)K.push(new Promise((b,B)=>{G.set(Z,{resolve:b,reject:B})}));let $=c();return this.#D.set($,{tileOptions:D.tileOptions,workspaces:new Map,workspaceHandlers:G,useMainThread:U}),this.#U.push({squishId:$,data:D}),queueMicrotask(()=>this.#Z(U)),K}}var d=new LD;function _8(D,A,J={}){let U=J.tileSize||1024,K=J.filter||"mks2013",G=J.unsharpAmount||0,$=J.unsharpRadius||0,Z=J.unsharpThreshold||0,b=!!J.useMainThread,B=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,y=J.maxWorkerPoolSize||Math.min(B,4),Q=J.maxWorkerIdleTime||2000,V=3,j=Math.ceil(Math.max(3,2.5*$|0)),R={initialSize:U,filterPadding:j,filter:K,unsharpAmount:G,unsharpRadius:$,unsharpThreshold:Z};if(A instanceof Array)return d.add({image:D,dimensionLimits:A,tileOptions:R},y,Q,b);return d.add({image:D,dimensionLimits:[A],tileOptions:R},y,Q,b)[0]}export{_8 as squish};
