var u=4;function I(m,b,n){let f=new Uint8ClampedArray(n.tile);for(let e=0;e<n.toHeight;e++){let g=e*n.toWidth*u,l=((n.toY+e)*b+n.toX)*u;m.set(f.subarray(g,g+n.toWidth*u),l)}}var L=`
var Kk=Object.create;var{getPrototypeOf:$k,defineProperty:m,getOwnPropertyNames:Ak}=Object;var Gk=Object.prototype.hasOwnProperty;var Qk=(k,I,q)=>{q=k!=null?Kk($k(k)):{};let M=I||!k||!k.__esModule?m(q,"default",{value:k,enumerable:!0}):q;for(let U of Ak(k))if(!Gk.call(M,U))m(M,U,{get:()=>k[U],enumerable:!0});return M};var Zk=(k,I)=>()=>(I||k((I={exports:{}}).exports,I),I.exports);var qk=Zk((sk,Mk)=>{var _,n,x,g,T,H,t,kk;function wk(k){if(k<0.5)k=0.5;var I=Math.exp(0.527076)/k,q=Math.exp(-I),M=Math.exp(-2*I),U=(1-q)*(1-q)/(1+2*I*q-M);return _=U,n=U*(I-1)*q,x=U*(I+1)*q,g=-U*M,T=2*q,H=-M,t=(_+n)/(1-T-H),kk=(x+g)/(1-T-H),new Float32Array([_,n,x,g,T,H,t,kk])}function Ik(k,I,q,M,U,A){var R,y,J,D,$,Q,B,K,Z,u,j,L,G,b;for(Z=0;Z<A;Z++){Q=Z*U,B=Z,K=0,R=k[Q],$=R*M[6],D=$,j=M[0],L=M[1],G=M[4],b=M[5];for(u=0;u<U;u++)y=k[Q],J=y*j+R*L+D*G+$*b,$=D,D=J,R=y,q[K]=D,K++,Q++;Q--,K--,B+=A*(U-1),R=k[Q],$=R*M[7],D=$,y=R,j=M[2],L=M[3];for(u=U-1;u>=0;u--)J=y*j+R*L+D*G+$*b,$=D,D=J,R=y,y=k[Q],I[B]=q[K]+D,Q--,K--,B-=A}}function Xk(k,I,q,M){if(!M)return;var U=new Uint16Array(k.length),A=new Float32Array(Math.max(I,q)),R=wk(M);Ik(k,U,A,R,I,q,M),Ik(U,k,A,R,q,I,M)}Mk.exports=Xk});var S=4;var jk=2;function h(k,I,q,M,U,A){let R=q/k,y=M/I,J=(2*A+jk+1)/U;if(J>0.5)return[{toWidth:q,toHeight:M}];let D=Math.ceil(Math.log(Math.min(R,y))/Math.log(J));if(D<=1)return[{toWidth:q,toHeight:M}];let $=[];for(let Q=0;Q<D;Q++){let B=Math.round(Math.pow(Math.pow(k,D-Q-1)*Math.pow(q,Q+1),1/D)),K=Math.round(Math.pow(Math.pow(I,D-Q-1)*Math.pow(M,Q+1),1/D));$.push({toWidth:B,toHeight:K})}return $}function Bk(k,I){if(k)k.width=k.height=0;k=I=null}function uk(k,I){let q=new OffscreenCanvas(I.width,I.height),M=q.getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");M.globalCompositeOperation="copy",M.drawImage(k,I.x,I.y,I.width,I.height,0,0,I.width,I.height);let U=M.getImageData(0,0,I.width,I.height).data.buffer;return Bk(q,M),U}function Lk(k,I,q){let M=new Uint8ClampedArray(q.width*q.height*S);for(let U=0;U<q.height;U++){let A=((q.y+U)*I+q.x)*S,R=U*q.width*S;M.set(k.subarray(A,A+q.width*S),R)}return M.buffer}function a(k,I,q){if(k instanceof ImageBitmap)return uk(k,q);else return Lk(k,I,q)}var c=0.00001;function O(k){let I=Math.round(k);if(Math.abs(k-I)<c)return I;return Math.floor(k)}function d(k){let I=Math.round(k);if(Math.abs(k-I)<c)return I;return Math.ceil(k)}function P(k,I,q,M,U,A){let{initialSize:R,filterPadding:y,filter:J,unsharpAmount:D,unsharpRadius:$,unsharpThreshold:Q}=A,B=M/I,K=U/q,Z=O(R*B)-2*y,u=O(R*K)-2*y;if(Z<1||u<1)throw new Error("Picsquish error: target tile width/height is too small");let j,L,G,b,z,N,C=[];for(b=0;b<U;b+=u)for(G=0;G<M;G+=Z){if(j=G-y,j<0)j=0;if(z=G+Z+y-j,j+z>=M)z=M-j;if(L=b-y,L<0)L=0;if(N=b+u+y-L,L+N>=U)N=U-L;let V={toX:j,toY:L,toWidth:z,toHeight:N,toInnerX:G,toInnerY:b,toInnerWidth:Z,toInnerHeight:u,offsetX:j/B-O(j/B),offsetY:L/K-O(L/K),scaleX:B,scaleY:K,x:O(j/B),y:O(L/K),width:d(z/B),height:d(N/K),initialSize:R,filterPadding:y,filter:J,unsharpAmount:D,unsharpRadius:$,unsharpThreshold:Q},F=a(k,I,V);C.push({tile:F,...V})}return C}async function bk(k,I,q){let M=k instanceof ImageBitmap?k:await createImageBitmap(k),U=[];for(let A of q){let R=M,y=M.width,J=M.height,D=A/y,$=A/J,Q=Math.min(D,$,1),B=Math.floor(y*Q),K=Math.floor(J*Q),Z=h(y,J,B,K,I.initialSize,I.filterPadding),u=P(R,y,J,Z[0].toWidth,Z[0].toHeight,I);U.push({stages:Z,tileTransforms:u})}return M.close(),U}function Ck(k,I){let q=P(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,I);return[{stages:k.stages,tileTransforms:q}]}async function o(k){if(k.image instanceof Blob||k.image instanceof ImageBitmap)return bk(k.image,k.tileOptions,k.dimensionLimits);else return Ck(k.image,k.tileOptions)}var p={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*(0.54+0.46*Math.cos(I/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/2)/(I/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/3)/(I/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Vk=14;function s(k){return Math.round(k*((1<<Vk)-1))}function v(k,I,q,M,U){let A=p[k].fn,R=1/M,y=Math.min(1,M),J=p[k].win/y,D,$,Q,B,K,Z,u,j,L,G,b,z,N,C,V,F,W,Uk=Math.floor((J+1)*2),w=new Int16Array((Uk+2)*q),E=0,Jk=!w.subarray||!w.set;for(D=0;D<q;D++){$=(D+0.5)*R+U,Q=Math.max(0,Math.floor($-J)),B=Math.min(I-1,Math.ceil($+J)),K=B-Q+1,Z=new Float32Array(K),u=new Int16Array(K),j=0;for(L=Q,G=0;L<=B;L++,G++)b=A((L+0.5-$)*y),j+=b,Z[G]=b;z=0;for(G=0;G<Z.length;G++)N=Z[G]/j,z+=N,u[G]=s(N);u[q>>1]+=s(1-z),C=0;while(C<u.length&&u[C]===0)C++;if(C<u.length){V=u.length-1;while(V>0&&u[V]===0)V--;if(F=Q+C,W=V-C+1,w[E++]=F,w[E++]=W,!Jk)w.set(u.subarray(C,V+1),E),E+=W;else for(G=C;G<=V;G++)w[E++]=u[G]}else w[E++]=0,w[E++]=0}return w}function X(k){return k<0?0:k>255?255:k}function Y(k){return k>=0?k:0}function f(k,I,q,M,U,A){let R,y,J,D,$,Q,B,K,Z,u,j,L=0,G=0;for(Z=0;Z<M;Z++){$=0;for(u=0;u<U;u++){Q=A[$++],B=A[$++],K=L+Q*4|0,R=y=J=D=0;for(;B>0;B--)j=A[$++],D=D+j*k[K+3]|0,J=J+j*k[K+2]|0,y=y+j*k[K+1]|0,R=R+j*k[K]|0,K=K+4|0;I[G+3]=Y(D>>7),I[G+2]=Y(J>>7),I[G+1]=Y(y>>7),I[G]=Y(R>>7),G=G+M*4|0}G=(Z+1)*4|0,L=(Z+1)*q*4|0}}function l(k,I,q,M,U,A){let R,y,J,D,$,Q,B,K,Z,u,j,L=0,G=0;for(Z=0;Z<M;Z++){$=0;for(u=0;u<U;u++){Q=A[$++],B=A[$++],K=L+Q*4|0,R=y=J=D=0;for(;B>0;B--)j=A[$++],D=D+j*k[K+3]|0,J=J+j*k[K+2]|0,y=y+j*k[K+1]|0,R=R+j*k[K]|0,K=K+4|0;R>>=7,y>>=7,J>>=7,D>>=7,I[G+3]=X(D+8192>>14),I[G+2]=X(J+8192>>14),I[G+1]=X(y+8192>>14),I[G]=X(R+8192>>14),G=G+M*4|0}G=(Z+1)*4|0,L=(Z+1)*q*4|0}}function r(k,I,q,M,U,A){let R,y,J,D,$,Q,B,K,Z,u,j,L,G=0,b=0;for(u=0;u<M;u++){Q=0;for(j=0;j<U;j++){B=A[Q++],K=A[Q++],Z=G+B*4|0,R=y=J=D=0;for(;K>0;K--)L=A[Q++],$=k[Z+3],D=D+L*$|0,J=J+L*k[Z+2]*$|0,y=y+L*k[Z+1]*$|0,R=R+L*k[Z]*$|0,Z=Z+4|0;J=J/255|0,y=y/255|0,R=R/255|0,I[b+3]=Y(D>>7),I[b+2]=Y(J>>7),I[b+1]=Y(y>>7),I[b]=Y(R>>7),b=b+M*4|0}b=(u+1)*4|0,G=(u+1)*q*4|0}}function e(k,I,q,M,U,A){let R,y,J,D,$,Q,B,K,Z,u,j,L=0,G=0;for(Z=0;Z<M;Z++){$=0;for(u=0;u<U;u++){Q=A[$++],B=A[$++],K=L+Q*4|0,R=y=J=D=0;for(;B>0;B--)j=A[$++],D=D+j*k[K+3]|0,J=J+j*k[K+2]|0,y=y+j*k[K+1]|0,R=R+j*k[K]|0,K=K+4|0;if(R>>=7,y>>=7,J>>=7,D>>=7,D=X(D+8192>>14),D>0)R=R*255/D|0,y=y*255/D|0,J=J*255/D|0;I[G+3]=D,I[G+2]=X(J+8192>>14),I[G+1]=X(y+8192>>14),I[G]=X(R+8192>>14),G=G+M*4|0}G=(Z+1)*4|0,L=(Z+1)*q*4|0}}function zk(k,I,q){let M=3,U=I*q*4|0;while(M<U){if(k[M]!==255)return!0;M=M+4|0}return!1}function Nk(k,I,q){let M=3,U=I*q*4|0;while(M<U)k[M]=255,M=M+4|0}function i(k,I,q,M,U,A,R,y,J,D){let $=v(I,q,U,R,J),Q=v(I,M,A,y,D),B=new Uint8Array(U*A*4),K=new Uint16Array(U*M*4);if(zk(k,q,M))r(k,K,q,M,U,$),e(K,B,M,U,A,Q);else f(k,K,q,M,U,$),l(K,B,M,U,A,Q),Nk(B,U,A);return B}var Rk=Qk(qk(),1);function Yk(k,I,q){let M=I*q,U=new Uint16Array(M),A,R,y,J;for(let D=0;D<M;D++)A=k[4*D],R=k[4*D+1],y=k[4*D+2],J=A>=R&&A>=y?A:R>=y&&R>=A?R:y,U[D]=J<<8;return U}function yk(k,I,q,M,U,A){let R,y,J,D,$;if(M===0||U<0.5)return;if(U>2)U=2;let Q=Yk(k,I,q),B=new Uint16Array(Q);Rk.default(B,I,q,U);let K=M/100*4096+0.5|0,Z=A<<8,u=I*q;for(let j=0;j<u;j++)if(R=Q[j],D=R-B[j],Math.abs(D)>=Z)y=R+(K*D+2048>>12),y=y>65280?65280:y,y=y<0?0:y,R=R!==0?R:1,J=(y<<12)/R|0,$=j*4,k[$]=k[$]*J+2048>>12,k[$+1]=k[$+1]*J+2048>>12,k[$+2]=k[$+2]*J+2048>>12}function Dk(k){let I=i(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)yk(I,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return I}async function Ek(k){let{taskId:I,squishId:q,taskType:M,data:U}=k,{image:A,dimensionLimits:R,tileOptions:y}=U,J=await o({image:A,dimensionLimits:R,tileOptions:y}),D={taskId:I,squishId:q,taskType:M,output:J},$=J.flatMap((Q)=>Q.tileTransforms.map((B)=>B.tile));self.postMessage(D,$)}function Ok(k){let{taskId:I,squishId:q,workspaceIndex:M,taskType:U,data:A}=k,{tileTransform:R}=A;R.tile=Dk(R).buffer;let y={taskId:I,squishId:q,workspaceIndex:M,taskType:U,output:{tileTransform:R}};self.postMessage(y,[R.tile])}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let I=k.data;try{return await Ek(I)}catch(q){return self.postMessage({taskId:I.taskId,squishId:I.squishId,taskType:I.taskType,error:q})}}case 1:{let I=k.data;try{return Ok(I)}catch(q){return self.postMessage({taskId:I.taskId,squishId:I.squishId,workspaceIndex:I.workspaceIndex,taskType:I.taskType,error:q})}}}};
`,O=new Blob([L],{type:"application/javascript"});class W{#m;#n;#b;#l;constructor(){this.#m=new Map,this.#n=new Map,this.#b=null,this.#l=null}#f(){if(this.#b===null)return;clearTimeout(this.#b),this.#b=null}prepare(m,b,n){if(this.#m.size)return;this.#l=n;let f=URL.createObjectURL(O);while(this.#m.size<b){let e=new Worker(f);e.onmessage=m,this.#m.set(e,null)}URL.revokeObjectURL(f)}assignTask(m,b,n,f){this.#m.set(m,b),this.#n.set(b,m),this.#f(),m.postMessage(n,f)}setTimeout(){if(this.#b!==null)return;this.#b=setTimeout(()=>{for(let m of this.#m.keys())m.terminate();this.#m.clear(),this.#n.clear()},this.#l||0)}getAvailableWorkers(){let m=[];for(let[b,n]of this.#m.entries())if(n===null)m.push(b);return m}removeTask(m){let b=this.#n.get(m);if(b)this.#m.set(b,null);this.#n.delete(m)}}var R=new W;var t=(()=>{let m=0;return()=>++m})();class M{raw;width;height;constructor(m,b,n){this.raw=m,this.width=b,this.height=n}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let m=document.createElement("canvas");m.width=this.width,m.height=this.height;let b=m.getContext("2d");if(!b)throw new Error("Picsquish error: canvas 2D context not supported");return b.putImageData(this.toImageData(),0,0),m}toBlob(m="image/png"){let b=new OffscreenCanvas(this.width,this.height),n=b.getContext("2d");if(!n)throw new Error("Picsquish error: canvas 2D context not supported");return n.putImageData(this.toImageData(),0,0),b.convertToBlob({type:m})}}class U{#m;#n;#b;constructor(){this.#m=new Map,this.#n=[],this.#b=[]}#l(m,b){let n=t(),f={taskId:n,squishId:b.squishId,taskType:0,data:b.data},e=b.data.image instanceof ImageBitmap?[b.data.image]:[];R.assignTask(m,n,f,e)}#f(m,b){let n=t(),f={taskId:n,squishId:b.squishId,workspaceIndex:b.workspaceIndex,taskType:1,data:b.data};R.assignTask(m,n,f,[b.data.tileTransform.tile])}#g(m){let b=this.#n.shift();if(b)return this.#l(m,b);let n=this.#b.shift();if(n)return this.#f(m,n)}#e(){if(this.#n.length===0&&this.#b.length===0)return R.setTimeout();let b=R.getAvailableWorkers();for(let n of b)this.#g(n)}#r(m,b){let{squishId:n,output:f,error:e}=b;if(e)return m.workspaceHandlers.forEach((g)=>g.reject(e));for(let[g,l]of f.entries()){let r=l.stages[0].toWidth,T=l.stages[0].toHeight;m.workspaces.set(g,{to:new Uint8ClampedArray(r*T*u),toWidth:r,toHeight:T,stages:l.stages,remainingTileCount:l.tileTransforms.length});for(let d of l.tileTransforms)this.#b.push({squishId:n,workspaceIndex:g,data:{tileTransform:d}})}}#T(m,b){let{squishId:n,workspaceIndex:f,output:e,error:g}=b;if(!m.workspaces.has(f))return;let l=m.workspaces.get(f);if(!l)throw new Error("Picsquish error: workspace not found");let r=m.workspaceHandlers.get(f);if(!r)throw new Error("Picsquish error: workspaceHandler not found");if(g)return m.workspaces.delete(f),this.#b=this.#b.filter((d)=>!(d.squishId===n&&d.workspaceIndex===f)),r.reject(g);if(I(l.to,l.toWidth,e.tileTransform),--l.remainingTileCount,l.remainingTileCount)return;if(l.stages.shift(),!l.stages[0])return m.workspaces.delete(f),r.resolve(new M(l.to,l.toWidth,l.toHeight));this.#n.push({squishId:n,data:{image:{from:l.to,fromWidth:l.toWidth,fromHeight:l.toHeight,stages:l.stages},dimensionLimits:[],tileOptions:m.tileOptions}})}#R(m){let b=this.#m.get(m.data.squishId);if(!b)throw new Error("Picsquish error: squishContext not found");switch(m.data.taskType){case 0:this.#r(b,m.data);break;case 1:this.#T(b,m.data);break}if(!b.workspaces.size)this.#m.delete(m.data.squishId);R.removeTask(m.data.taskId),this.#e()}add(m,b,n){R.prepare((l)=>this.#R(l),b,n);let f=[],e=new Map;for(let l=0;l<m.dimensionLimits.length;l++)f.push(new Promise((r,T)=>{e.set(l,{resolve:r,reject:T})}));let g=t();return this.#m.set(g,{tileOptions:m.tileOptions,workspaces:new Map,workspaceHandlers:e}),this.#n.push({squishId:g,data:m}),queueMicrotask(()=>this.#e()),f}}var E=new U;function a(m,b,n={}){let f=n.tileSize||1024,e=n.filter||"mks2013",g=n.unsharpAmount||0,l=n.unsharpRadius||0,r=n.unsharpThreshold||0,T=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,d=n.maxWorkerPoolSize||Math.min(T,4),i=n.maxWorkerIdleTime||2000,S=3,y=Math.ceil(Math.max(3,2.5*l|0)),B={initialSize:f,filterPadding:y,filter:e,unsharpAmount:g,unsharpRadius:l,unsharpThreshold:r};return E.add({image:m,dimensionLimits:b,tileOptions:B},d,i)}export{a as squish};
