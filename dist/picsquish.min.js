var Vk=Object.create;var{getPrototypeOf:Ok,defineProperty:s,getOwnPropertyNames:Xk}=Object;var zk=Object.prototype.hasOwnProperty;var wk=(k,M,Q)=>{Q=k!=null?Vk(Ok(k)):{};let I=M||!k||!k.__esModule?s(Q,"default",{value:k,enumerable:!0}):Q;for(let Z of Xk(k))if(!zk.call(I,Z))s(I,Z,{get:()=>k[Z],enumerable:!0});return I};var Wk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Tk=Wk((ok,$k)=>{var p,f,c,_,v,d,Kk,Jk;function Pk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,Q=Math.exp(-M),I=Math.exp(-2*M),Z=(1-Q)*(1-Q)/(1+2*M*Q-I);return p=Z,f=Z*(M-1)*Q,c=Z*(M+1)*Q,_=-Z*I,v=2*Q,d=-I,Kk=(p+f)/(1-v-d),Jk=(c+_)/(1-v-d),new Float32Array([p,f,c,_,v,d,Kk,Jk])}function Zk(k,M,Q,I,Z,K){var U,q,J,$,T,R,G,j,A,D,L,C,B,y,X,z,N,O,E,W,S,V,Y,w,x,h,F,P,H,m;for(x=0;x<K;x++){V=x*Z,Y=x,w=0,U=k[V],q=U&255,J=U>>8&255,$=U>>16&255,T=U>>24&255,O=q*I[6],E=J*I[6],W=$*I[6],S=T*I[6],y=O,X=E,z=W,N=S,F=I[0],P=I[1],H=I[4],m=I[5];for(h=0;h<Z;h++)U=k[V],R=U&255,G=U>>8&255,j=U>>16&255,A=U>>24&255,D=R*F+q*P+y*H+O*m,L=G*F+J*P+X*H+E*m,C=j*F+$*P+z*H+W*m,B=A*F+T*P+N*H+S*m,O=y,E=X,W=z,S=N,y=D,X=L,z=C,N=B,q=R,J=G,$=j,T=A,Q[w]=y,Q[w+1]=X,Q[w+2]=z,Q[w+3]=N,w+=4,V++;V--,w-=4,Y+=K*(Z-1),U=k[V],q=U&255,J=U>>8&255,$=U>>16&255,T=U>>24&255,O=q*I[7],E=J*I[7],W=$*I[7],S=T*I[7],y=O,X=E,z=W,N=S,R=q,G=J,j=$,A=T,F=I[2],P=I[3];for(h=Z-1;h>=0;h--)D=R*F+q*P+y*H+O*m,L=G*F+J*P+X*H+E*m,C=j*F+$*P+z*H+W*m,B=A*F+T*P+N*H+S*m,O=y,E=X,W=z,S=N,y=D,X=L,z=C,N=B,q=R,J=G,$=j,T=A,U=k[V],R=U&255,G=U>>8&255,j=U>>16&255,A=U>>24&255,U=(Q[w]+y<<0)+(Q[w+1]+X<<8)+(Q[w+2]+z<<16)+(Q[w+3]+N<<24),M[Y]=U,V--,w-=4,Y-=K}}function Hk(k,M,Q,I){if(!I)return;var Z=new Uint32Array(k.buffer),K=new Uint32Array(Z.length),U=new Float32Array(Math.max(M,Q)*4),q=Pk(I);Zk(Z,K,U,q,M,Q,I),Zk(K,Z,U,q,Q,M,I)}$k.exports=Hk});function i(k,M,Q,I,Z,K){let U=Q/k,q=I/M,J=(2*K+2+1)/Z;if(J>0.5)return[[Q,I]];let $=Math.ceil(Math.log(Math.min(U,q))/Math.log(J));if($<=1)return[[Q,I]];let T=[];for(let R=0;R<$;R++){let G=Math.round(Math.pow(Math.pow(k,$-R-1)*Math.pow(Q,R+1),1/$)),j=Math.round(Math.pow(Math.pow(M,$-R-1)*Math.pow(I,R+1),1/$));T.push([G,j])}return T}function r(k,M,Q,I,Z){let K=new OffscreenCanvas(k.width,k.height),U=K.getContext("2d");return U.globalCompositeOperation="copy",U.drawImage(I.srcImageBitmap||M,k.x,k.y,k.width,k.height,0,0,k.width,k.height),Z.src=U.getImageData(0,0,k.width,k.height).data,K.width=K.height=0,Z}function n(k){var M=Math.round(k);if(Math.abs(k-M)<0.00001)return M;return Math.floor(k)}function e(k){var M=Math.round(k);if(Math.abs(k-M)<0.00001)return M;return Math.ceil(k)}function t(k){var M=k.toWidth/k.width,Q=k.toHeight/k.height,I=n(k.srcTileSize*M)-2*k.destTileBorder,Z=n(k.srcTileSize*Q)-2*k.destTileBorder;if(I<1||Z<1)throw new Error("Internal error in pica: target tile width/height is too small.");var K,U,q,J,$,T,R=[],G;for(J=0;J<k.toHeight;J+=Z)for(q=0;q<k.toWidth;q+=I){if(K=q-k.destTileBorder,K<0)K=0;if($=q+I+k.destTileBorder-K,K+$>=k.toWidth)$=k.toWidth-K;if(U=J-k.destTileBorder,U<0)U=0;if(T=J+Z+k.destTileBorder-U,U+T>=k.toHeight)T=k.toHeight-U;G={toX:K,toY:U,toWidth:$,toHeight:T,toInnerX:q,toInnerY:J,toInnerWidth:I,toInnerHeight:Z,offsetX:K/M-n(K/M),offsetY:U/Q-n(U/Q),scaleX:M,scaleY:Q,x:n(K/M),y:n(U/Q),width:e($/M),height:e(T/Q)},R.push(G)}return R}var g={box:{win:0.5,fn:function(k){if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:function(k){if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;var M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:function(k){if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;var M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:function(k){if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;var M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:function(k){if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Ek=14;function kk(k){return Math.round(k*((1<<Ek)-1))}function a(k,M,Q,I,Z){var K=g[k].fn,U=1/I,q=Math.min(1,I),J=g[k].win/q,$,T,R,G,j,A,D,L,C,B,y,X,z,N,O,E,W,S=Math.floor((J+1)*2),V=new Int16Array((S+2)*Q),Y=0,w=!V.subarray||!V.set;for($=0;$<Q;$++){T=($+0.5)*U+Z,R=Math.max(0,Math.floor(T-J)),G=Math.min(M-1,Math.ceil(T+J)),j=G-R+1,A=new Float32Array(j),D=new Int16Array(j),L=0;for(C=R,B=0;C<=G;C++,B++)y=K((C+0.5-T)*q),L+=y,A[B]=y;X=0;for(B=0;B<A.length;B++)z=A[B]/L,X+=z,D[B]=kk(z);D[Q>>1]+=kk(1-X),N=0;while(N<D.length&&D[N]===0)N++;if(N<D.length){O=D.length-1;while(O>0&&D[O]===0)O--;if(E=R+N,W=O-N+1,V[Y++]=E,V[Y++]=W,!w)V.set(D.subarray(N,O+1),Y),Y+=W;else for(B=N;B<=O;B++)V[Y++]=D[B]}else V[Y++]=0,V[Y++]=0}return V}function b(k){return k<0?0:k>255?255:k}function u(k){return k>=0?k:0}function Mk(k,M,Q,I,Z,K){var U,q,J,$,T,R,G,j,A,D,L,C=0,B=0;for(A=0;A<I;A++){T=0;for(D=0;D<Z;D++){R=K[T++],G=K[T++],j=C+R*4|0,U=q=J=$=0;for(;G>0;G--)L=K[T++],$=$+L*k[j+3]|0,J=J+L*k[j+2]|0,q=q+L*k[j+1]|0,U=U+L*k[j]|0,j=j+4|0;M[B+3]=u($>>7),M[B+2]=u(J>>7),M[B+1]=u(q>>7),M[B]=u(U>>7),B=B+I*4|0}B=(A+1)*4|0,C=(A+1)*Q*4|0}}function Ik(k,M,Q,I,Z,K){var U,q,J,$,T,R,G,j,A,D,L,C=0,B=0;for(A=0;A<I;A++){T=0;for(D=0;D<Z;D++){R=K[T++],G=K[T++],j=C+R*4|0,U=q=J=$=0;for(;G>0;G--)L=K[T++],$=$+L*k[j+3]|0,J=J+L*k[j+2]|0,q=q+L*k[j+1]|0,U=U+L*k[j]|0,j=j+4|0;U>>=7,q>>=7,J>>=7,$>>=7,M[B+3]=b($+8192>>14),M[B+2]=b(J+8192>>14),M[B+1]=b(q+8192>>14),M[B]=b(U+8192>>14),B=B+I*4|0}B=(A+1)*4|0,C=(A+1)*Q*4|0}}function Qk(k,M,Q,I,Z,K){var U,q,J,$,T,R,G,j,A,D,L,C,B=0,y=0;for(D=0;D<I;D++){R=0;for(L=0;L<Z;L++){G=K[R++],j=K[R++],A=B+G*4|0,U=q=J=$=0;for(;j>0;j--)C=K[R++],T=k[A+3],$=$+C*T|0,J=J+C*k[A+2]*T|0,q=q+C*k[A+1]*T|0,U=U+C*k[A]*T|0,A=A+4|0;J=J/255|0,q=q/255|0,U=U/255|0,M[y+3]=u($>>7),M[y+2]=u(J>>7),M[y+1]=u(q>>7),M[y]=u(U>>7),y=y+I*4|0}y=(D+1)*4|0,B=(D+1)*Q*4|0}}function Uk(k,M,Q,I,Z,K){var U,q,J,$,T,R,G,j,A,D,L,C=0,B=0;for(A=0;A<I;A++){T=0;for(D=0;D<Z;D++){R=K[T++],G=K[T++],j=C+R*4|0,U=q=J=$=0;for(;G>0;G--)L=K[T++],$=$+L*k[j+3]|0,J=J+L*k[j+2]|0,q=q+L*k[j+1]|0,U=U+L*k[j]|0,j=j+4|0;if(U>>=7,q>>=7,J>>=7,$>>=7,$=b($+8192>>14),$>0)U=U*255/$|0,q=q*255/$|0,J=J*255/$|0;M[B+3]=$,M[B+2]=b(J+8192>>14),M[B+1]=b(q+8192>>14),M[B]=b(U+8192>>14),B=B+I*4|0}B=(A+1)*4|0,C=(A+1)*Q*4|0}}function Sk(k,M,Q){let I=3,Z=M*Q*4|0;while(I<Z){if(k[I]!==255)return!0;I=I+4|0}return!1}function Fk(k,M,Q){let I=3,Z=M*Q*4|0;while(I<Z)k[I]=255,I=I+4|0}function qk(k){let{src:M,width:Q,height:I,toWidth:Z,toHeight:K}=k,U=k.scaleX||k.toWidth/k.width,q=k.scaleY||k.toHeight/k.height,J=k.offsetX||0,$=k.offsetY||0,T=k.dest||new Uint8Array(Z*K*4),R=typeof k.filter==="undefined"?"mks2013":k.filter,G=a(R,Q,Z,U,J),j=a(R,I,K,q,$),A=new Uint16Array(Z*I*4);if(Sk(M,Q,I))Qk(M,A,Q,I,Z,G),Uk(A,T,I,Z,K,j);else Mk(M,A,Q,I,Z,G),Ik(A,T,I,Z,K,j),Fk(T,Z,K);return T}var Rk=wk(Tk(),1);function mk(k,M,Q){var I=M*Q,Z=new Uint16Array(I),K,U,q,J;for(var $=0;$<I;$++)K=k[4*$],U=k[4*$+1],q=k[4*$+2],J=K>=U&&K>=q?K:U>=q&&U>=K?U:q,Z[$]=J<<8;return Z}function jk(k,M,Q,I,Z,K){var U,q,J,$,T;if(I===0||Z<0.5)return;if(Z>2)Z=2;var R=mk(k,M,Q),G=new Uint16Array(R);Rk.default(G,M,Q,Z);var j=I/100*4096+0.5|0,A=K<<8,D=M*Q;for(var L=0;L<D;L++)if(U=R[L],$=U-G[L],Math.abs($)>=A)q=U+(j*$+2048>>12),q=q>65280?65280:q,q=q<0?0:q,U=U!==0?U:1,J=(q<<12)/U|0,T=L*4,k[T]=k[T]*J+2048>>12,k[T+1]=k[T+1]*J+2048>>12,k[T+2]=k[T+2]*J+2048>>12}function Ak(k,M){let Q=qk(k,M);if(k.unsharpAmount)jk(Q,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return Q}function Bk(k,M){return Promise.resolve().then(()=>{return{data:Ak(k,M.__mathCache)}})}function Gk(k,M,Q){let I;if(M.bitmap)return Q.toCtx.drawImage(M.bitmap,k.toX,k.toY),null;if(I=new ImageData(new Uint8ClampedArray(M.data),k.toWidth,k.toHeight),!1)Q.toCtx.putImageData(I,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth+0.00001,k.toInnerHeight+0.00001);else Q.toCtx.putImageData(I,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth,k.toInnerHeight);return null}function Lk(k){return k instanceof OffscreenCanvas}function Dk(k){return k instanceof ImageBitmap}function Ck(k,M,Q){let I={srcCtx:null,srcImageBitmap:null,isImageBitmapReused:!1,toCtx:null},Z=(K)=>{let U={width:K.width,height:K.height,toWidth:K.toWidth,toHeight:K.toHeight,scaleX:K.scaleX,scaleY:K.scaleY,offsetX:K.offsetX,offsetY:K.offsetY,filter:Q.filter,unsharpAmount:Q.unsharpAmount,unsharpRadius:Q.unsharpRadius,unsharpThreshold:Q.unsharpThreshold};return Promise.resolve(U).then((q)=>r(K,k,Q,I,q)).then((q)=>{return Bk(q,Q)}).then((q)=>{return I.srcImageData=null,Gk(K,q,I)})};return Promise.resolve().then(()=>{if(I.toCtx=M.getContext("2d"),Lk(k))return null;if(Dk(k))return I.srcImageBitmap=k,I.isImageBitmapReused=!0,null;throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap')}).then(()=>{if(Q.canceled)return Q.cancelToken;let U=t({width:Q.width,height:Q.height,srcTileSize:1024,toWidth:Q.toWidth,toHeight:Q.toHeight,destTileBorder:Q.__destTileBorder}).map((J)=>Z(J));function q(J){if(J.srcImageBitmap){if(!J.isImageBitmapReused)J.srcImageBitmap.close();J.srcImageBitmap=null}}return Promise.all(U).then(()=>{return q(I),M},(J)=>{throw q(I),J})})}function l(k,M,Q,I){if(I.canceled)return I.cancelToken;let[Z,K]=k.shift(),U=k.length===0;I.toWidth=Z,I.toHeight=K;let q;if(!U)q=new OffscreenCanvas(Z,K);return Ck(M,U?Q:q,I).then(()=>{if(U)return Q;return I.width=Z,I.height=K,l(k,q,Q,I)}).then((J)=>{if(q)q.width=q.height=0;return J})}async function yk(k,M){let Q=await createImageBitmap(k),I=Q.width,Z=Q.height,K=M/I,U=M/Z,q=Math.min(K,U,1),J=Math.floor(I*q),$=Math.floor(Z*q),T=new OffscreenCanvas(J,$),R={filter:"mks2013",unsharpAmount:0,unsharpRadius:0,unsharpThreshold:0,width:I,height:Z,toWidth:J,toHeight:$,canceled:!1,__destTileBorder:3},G=i(R.width,R.height,R.toWidth,R.toHeight,1024,R.__destTileBorder);return(await l(G,Q,T,R)).transferToImageBitmap()}var uk=`
var VM=Object.create;var{getPrototypeOf:yM,defineProperty:o,getOwnPropertyNames:XM}=Object;var zM=Object.prototype.hasOwnProperty;var YM=(M,q,K)=>{K=M!=null?VM(yM(M)):{};let U=q||!M||!M.__esModule?o(K,"default",{value:M,enumerable:!0}):K;for(let Z of XM(M))if(!zM.call(U,Z))o(U,Z,{get:()=>M[Z],enumerable:!0});return U};var OM=(M,q)=>()=>(q||M((q={exports:{}}).exports,q),q.exports);var IM=OM((fM,GM)=>{var p,a,_,c,g,n,QM,ZM;function FM(M){if(M<0.5)M=0.5;var q=Math.exp(0.527076)/M,K=Math.exp(-q),U=Math.exp(-2*q),Z=(1-K)*(1-K)/(1+2*q*K-U);return p=Z,a=Z*(q-1)*K,_=Z*(q+1)*K,c=-Z*U,g=2*K,n=-U,QM=(p+a)/(1-g-n),ZM=(_+c)/(1-g-n),new Float32Array([p,a,_,c,g,n,QM,ZM])}function $M(M,q,K,U,Z,$){var J,Q,G,I,A,L,R,j,B,N,k,C,D,V,Y,O,y,z,S,w,F,X,T,E,v,h,H,W,P,b;for(v=0;v<$;v++){X=v*Z,T=v,E=0,J=M[X],Q=J&255,G=J>>8&255,I=J>>16&255,A=J>>24&255,z=Q*U[6],S=G*U[6],w=I*U[6],F=A*U[6],V=z,Y=S,O=w,y=F,H=U[0],W=U[1],P=U[4],b=U[5];for(h=0;h<Z;h++)J=M[X],L=J&255,R=J>>8&255,j=J>>16&255,B=J>>24&255,N=L*H+Q*W+V*P+z*b,k=R*H+G*W+Y*P+S*b,C=j*H+I*W+O*P+w*b,D=B*H+A*W+y*P+F*b,z=V,S=Y,w=O,F=y,V=N,Y=k,O=C,y=D,Q=L,G=R,I=j,A=B,K[E]=V,K[E+1]=Y,K[E+2]=O,K[E+3]=y,E+=4,X++;X--,E-=4,T+=$*(Z-1),J=M[X],Q=J&255,G=J>>8&255,I=J>>16&255,A=J>>24&255,z=Q*U[7],S=G*U[7],w=I*U[7],F=A*U[7],V=z,Y=S,O=w,y=F,L=Q,R=G,j=I,B=A,H=U[2],W=U[3];for(h=Z-1;h>=0;h--)N=L*H+Q*W+V*P+z*b,k=R*H+G*W+Y*P+S*b,C=j*H+I*W+O*P+w*b,D=B*H+A*W+y*P+F*b,z=V,S=Y,w=O,F=y,V=N,Y=k,O=C,y=D,Q=L,G=R,I=j,A=B,J=M[X],L=J&255,R=J>>8&255,j=J>>16&255,B=J>>24&255,J=(K[E]+V<<0)+(K[E+1]+Y<<8)+(K[E+2]+O<<16)+(K[E+3]+y<<24),q[T]=J,X--,E-=4,T-=$}}function HM(M,q,K,U){if(!U)return;var Z=new Uint32Array(M.buffer),$=new Uint32Array(Z.length),J=new Float32Array(Math.max(q,K)*4),Q=FM(U);$M(Z,$,J,Q,q,K,U),$M($,Z,J,Q,K,q,U)}GM.exports=HM});function s(M,q,K,U,Z,$){let J=K/M,Q=U/q,G=(2*$+2+1)/Z;if(G>0.5)return[[K,U]];let I=Math.ceil(Math.log(Math.min(J,Q))/Math.log(G));if(I<=1)return[[K,U]];let A=[];for(let L=0;L<I;L++){let R=Math.round(Math.pow(Math.pow(M,I-L-1)*Math.pow(K,L+1),1/I)),j=Math.round(Math.pow(Math.pow(q,I-L-1)*Math.pow(U,L+1),1/I));A.push([R,j])}return A}function i(M,q,K,U,Z){let $=new OffscreenCanvas(M.width,M.height),J=$.getContext("2d");return J.globalCompositeOperation="copy",J.drawImage(U.srcImageBitmap||q,M.x,M.y,M.width,M.height,0,0,M.width,M.height),Z.src=J.getImageData(0,0,M.width,M.height).data,$.width=$.height=0,Z}function u(M){var q=Math.round(M);if(Math.abs(M-q)<0.00001)return q;return Math.floor(M)}function r(M){var q=Math.round(M);if(Math.abs(M-q)<0.00001)return q;return Math.ceil(M)}function e(M){var q=M.toWidth/M.width,K=M.toHeight/M.height,U=u(M.srcTileSize*q)-2*M.destTileBorder,Z=u(M.srcTileSize*K)-2*M.destTileBorder;if(U<1||Z<1)throw new Error("Internal error in pica: target tile width/height is too small.");var $,J,Q,G,I,A,L=[],R;for(G=0;G<M.toHeight;G+=Z)for(Q=0;Q<M.toWidth;Q+=U){if($=Q-M.destTileBorder,$<0)$=0;if(I=Q+U+M.destTileBorder-$,$+I>=M.toWidth)I=M.toWidth-$;if(J=G-M.destTileBorder,J<0)J=0;if(A=G+Z+M.destTileBorder-J,J+A>=M.toHeight)A=M.toHeight-J;R={toX:$,toY:J,toWidth:I,toHeight:A,toInnerX:Q,toInnerY:G,toInnerWidth:U,toInnerHeight:Z,offsetX:$/q-u($/q),offsetY:J/K-u(J/K),scaleX:q,scaleY:K,x:u($/q),y:u(J/K),width:r(I/q),height:r(A/K)},L.push(R)}return L}var d={box:{win:0.5,fn:function(M){if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:function(M){if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;var q=M*Math.PI;return Math.sin(q)/q*(0.54+0.46*Math.cos(q/1))}},lanczos2:{win:2,fn:function(M){if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;var q=M*Math.PI;return Math.sin(q)/q*Math.sin(q/2)/(q/2)}},lanczos3:{win:3,fn:function(M){if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;var q=M*Math.PI;return Math.sin(q)/q*Math.sin(q/3)/(q/3)}},mks2013:{win:2.5,fn:function(M){if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var wM=14;function t(M){return Math.round(M*((1<<wM)-1))}function f(M,q,K,U,Z){var $=d[M].fn,J=1/U,Q=Math.min(1,U),G=d[M].win/Q,I,A,L,R,j,B,N,k,C,D,V,Y,O,y,z,S,w,F=Math.floor((G+1)*2),X=new Int16Array((F+2)*K),T=0,E=!X.subarray||!X.set;for(I=0;I<K;I++){A=(I+0.5)*J+Z,L=Math.max(0,Math.floor(A-G)),R=Math.min(q-1,Math.ceil(A+G)),j=R-L+1,B=new Float32Array(j),N=new Int16Array(j),k=0;for(C=L,D=0;C<=R;C++,D++)V=$((C+0.5-A)*Q),k+=V,B[D]=V;Y=0;for(D=0;D<B.length;D++)O=B[D]/k,Y+=O,N[D]=t(O);N[K>>1]+=t(1-Y),y=0;while(y<N.length&&N[y]===0)y++;if(y<N.length){z=N.length-1;while(z>0&&N[z]===0)z--;if(S=L+y,w=z-y+1,X[T++]=S,X[T++]=w,!E)X.set(N.subarray(y,z+1),T),T+=w;else for(D=y;D<=z;D++)X[T++]=N[D]}else X[T++]=0,X[T++]=0}return X}function m(M){return M<0?0:M>255?255:M}function x(M){return M>=0?M:0}function MM(M,q,K,U,Z,$){var J,Q,G,I,A,L,R,j,B,N,k,C=0,D=0;for(B=0;B<U;B++){A=0;for(N=0;N<Z;N++){L=$[A++],R=$[A++],j=C+L*4|0,J=Q=G=I=0;for(;R>0;R--)k=$[A++],I=I+k*M[j+3]|0,G=G+k*M[j+2]|0,Q=Q+k*M[j+1]|0,J=J+k*M[j]|0,j=j+4|0;q[D+3]=x(I>>7),q[D+2]=x(G>>7),q[D+1]=x(Q>>7),q[D]=x(J>>7),D=D+U*4|0}D=(B+1)*4|0,C=(B+1)*K*4|0}}function UM(M,q,K,U,Z,$){var J,Q,G,I,A,L,R,j,B,N,k,C=0,D=0;for(B=0;B<U;B++){A=0;for(N=0;N<Z;N++){L=$[A++],R=$[A++],j=C+L*4|0,J=Q=G=I=0;for(;R>0;R--)k=$[A++],I=I+k*M[j+3]|0,G=G+k*M[j+2]|0,Q=Q+k*M[j+1]|0,J=J+k*M[j]|0,j=j+4|0;J>>=7,Q>>=7,G>>=7,I>>=7,q[D+3]=m(I+8192>>14),q[D+2]=m(G+8192>>14),q[D+1]=m(Q+8192>>14),q[D]=m(J+8192>>14),D=D+U*4|0}D=(B+1)*4|0,C=(B+1)*K*4|0}}function qM(M,q,K,U,Z,$){var J,Q,G,I,A,L,R,j,B,N,k,C,D=0,V=0;for(N=0;N<U;N++){L=0;for(k=0;k<Z;k++){R=$[L++],j=$[L++],B=D+R*4|0,J=Q=G=I=0;for(;j>0;j--)C=$[L++],A=M[B+3],I=I+C*A|0,G=G+C*M[B+2]*A|0,Q=Q+C*M[B+1]*A|0,J=J+C*M[B]*A|0,B=B+4|0;G=G/255|0,Q=Q/255|0,J=J/255|0,q[V+3]=x(I>>7),q[V+2]=x(G>>7),q[V+1]=x(Q>>7),q[V]=x(J>>7),V=V+U*4|0}V=(N+1)*4|0,D=(N+1)*K*4|0}}function JM(M,q,K,U,Z,$){var J,Q,G,I,A,L,R,j,B,N,k,C=0,D=0;for(B=0;B<U;B++){A=0;for(N=0;N<Z;N++){L=$[A++],R=$[A++],j=C+L*4|0,J=Q=G=I=0;for(;R>0;R--)k=$[A++],I=I+k*M[j+3]|0,G=G+k*M[j+2]|0,Q=Q+k*M[j+1]|0,J=J+k*M[j]|0,j=j+4|0;if(J>>=7,Q>>=7,G>>=7,I>>=7,I=m(I+8192>>14),I>0)J=J*255/I|0,Q=Q*255/I|0,G=G*255/I|0;q[D+3]=I,q[D+2]=m(G+8192>>14),q[D+1]=m(Q+8192>>14),q[D]=m(J+8192>>14),D=D+U*4|0}D=(B+1)*4|0,C=(B+1)*K*4|0}}function TM(M,q,K){let U=3,Z=q*K*4|0;while(U<Z){if(M[U]!==255)return!0;U=U+4|0}return!1}function SM(M,q,K){let U=3,Z=q*K*4|0;while(U<Z)M[U]=255,U=U+4|0}function KM(M){let{src:q,width:K,height:U,toWidth:Z,toHeight:$}=M,J=M.scaleX||M.toWidth/M.width,Q=M.scaleY||M.toHeight/M.height,G=M.offsetX||0,I=M.offsetY||0,A=M.dest||new Uint8Array(Z*$*4),L=typeof M.filter==="undefined"?"mks2013":M.filter,R=f(L,K,Z,J,G),j=f(L,U,$,Q,I),B=new Uint16Array(Z*U*4);if(TM(q,K,U))qM(q,B,K,U,Z,R),JM(B,A,U,Z,$,j);else MM(q,B,K,U,Z,R),UM(B,A,U,Z,$,j),SM(A,Z,$);return A}var AM=YM(IM(),1);function WM(M,q,K){var U=q*K,Z=new Uint16Array(U),$,J,Q,G;for(var I=0;I<U;I++)$=M[4*I],J=M[4*I+1],Q=M[4*I+2],G=$>=J&&$>=Q?$:J>=Q&&J>=$?J:Q,Z[I]=G<<8;return Z}function LM(M,q,K,U,Z,$){var J,Q,G,I,A;if(U===0||Z<0.5)return;if(Z>2)Z=2;var L=WM(M,q,K),R=new Uint16Array(L);AM.default(R,q,K,Z);var j=U/100*4096+0.5|0,B=$<<8,N=q*K;for(var k=0;k<N;k++)if(J=L[k],I=J-R[k],Math.abs(I)>=B)Q=J+(j*I+2048>>12),Q=Q>65280?65280:Q,Q=Q<0?0:Q,J=J!==0?J:1,G=(Q<<12)/J|0,A=k*4,M[A]=M[A]*G+2048>>12,M[A+1]=M[A+1]*G+2048>>12,M[A+2]=M[A+2]*G+2048>>12}function jM(M,q){let K=KM(M,q);if(M.unsharpAmount)LM(K,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return K}function BM(M,q){return Promise.resolve().then(()=>{return{data:jM(M,q.__mathCache)}})}function DM(M,q,K){let U;if(q.bitmap)return K.toCtx.drawImage(q.bitmap,M.toX,M.toY),null;if(U=new ImageData(new Uint8ClampedArray(q.data),M.toWidth,M.toHeight),!1)K.toCtx.putImageData(U,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth+0.00001,M.toInnerHeight+0.00001);else K.toCtx.putImageData(U,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth,M.toInnerHeight);return null}function RM(M){return M instanceof OffscreenCanvas}function kM(M){return M instanceof ImageBitmap}function NM(M,q,K){let U={srcCtx:null,srcImageBitmap:null,isImageBitmapReused:!1,toCtx:null},Z=($)=>{let J={width:$.width,height:$.height,toWidth:$.toWidth,toHeight:$.toHeight,scaleX:$.scaleX,scaleY:$.scaleY,offsetX:$.offsetX,offsetY:$.offsetY,filter:K.filter,unsharpAmount:K.unsharpAmount,unsharpRadius:K.unsharpRadius,unsharpThreshold:K.unsharpThreshold};return Promise.resolve(J).then((Q)=>i($,M,K,U,Q)).then((Q)=>{return BM(Q,K)}).then((Q)=>{return U.srcImageData=null,DM($,Q,U)})};return Promise.resolve().then(()=>{if(U.toCtx=q.getContext("2d"),RM(M))return null;if(kM(M))return U.srcImageBitmap=M,U.isImageBitmapReused=!0,null;throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap')}).then(()=>{if(K.canceled)return K.cancelToken;let J=e({width:K.width,height:K.height,srcTileSize:1024,toWidth:K.toWidth,toHeight:K.toHeight,destTileBorder:K.__destTileBorder}).map((G)=>Z(G));function Q(G){if(G.srcImageBitmap){if(!G.isImageBitmapReused)G.srcImageBitmap.close();G.srcImageBitmap=null}}return Promise.all(J).then(()=>{return Q(U),q},(G)=>{throw Q(U),G})})}function l(M,q,K,U){if(U.canceled)return U.cancelToken;let[Z,$]=M.shift(),J=M.length===0;U.toWidth=Z,U.toHeight=$;let Q;if(!J)Q=new OffscreenCanvas(Z,$);return NM(q,J?K:Q,U).then(()=>{if(J)return K;return U.width=Z,U.height=$,l(M,Q,K,U)}).then((G)=>{if(Q)Q.width=Q.height=0;return G})}async function CM(M,q){let K=await createImageBitmap(M),U=K.width,Z=K.height,$=q/U,J=q/Z,Q=Math.min($,J,1),G=Math.floor(U*Q),I=Math.floor(Z*Q),A=new OffscreenCanvas(G,I),L={filter:"mks2013",unsharpAmount:0,unsharpRadius:0,unsharpThreshold:0,width:U,height:Z,toWidth:G,toHeight:I,canceled:!1,__destTileBorder:3},R=s(L.width,L.height,L.toWidth,L.toHeight,1024,L.__destTileBorder);return(await l(R,K,A,L)).transferToImageBitmap()}self.onmessage=async(M)=>{let{taskId:q,blob:K,options:U}=M.data;try{let Z=await CM(K,U.maxDimension);self.postMessage({taskId:q,output:Z},[Z])}catch(Z){self.postMessage({taskId:q,error:Z})}};
`,hk=new Blob([uk],{type:"application/javascript"}),nk=(()=>{let k=0;return()=>++k})();class Nk{#M;#I;#Q;#k;constructor(){this.#M=new Map,this.#I=new Map,this.#Q=new Map,this.#k=new Map}get count(){return this.#M.size}setWorkerTimeout(k,M){let Q=setTimeout(()=>{let I=this.#M.get(k);if(I)this.#Q.delete(I);if(I)this.#k.delete(I);this.#I.delete(k),this.#M.delete(k),k.terminate()},M);this.#I.set(k,Q)}clearWorkerTimeout(k){clearTimeout(this.#I.get(k))}addWorker(k){this.#M.set(k,null)}getWorker(k){return this.#Q.get(k)}getTask(k){return this.#k.get(k)}getAvailableWorker(){for(let[k,M]of this.#M.entries())if(M===null)return k;return null}assignTask(k,M){this.#M.set(k,M.id),this.#Q.set(M.id,k),this.#k.set(M.id,M);let Q={taskId:M.id,blob:M.data.blob,options:M.data.options};k.postMessage(Q)}removeTask(k){let M=this.#Q.get(k);if(M)this.#M.set(M,null);this.#Q.delete(k),this.#k.delete(k)}}class o{#M;#I;#Q;#k;constructor(){let k=typeof navigator==="undefined"?1:navigator.hardwareConcurrency;this.#M=2000,this.#I=Math.min(k,4),this.#Q=[],this.#k=new Nk}#q(){let k=new Worker(URL.createObjectURL(hk));k.onmessage=(M)=>{let{taskId:Q,output:I,error:Z}=M.data,K=this.#k.getWorker(Q),U=this.#k.getTask(Q);if(Z){if(U)U.reject(Z)}else if(U)U.resolve(I);if(this.#k.removeTask(Q),K)this.#k.setWorkerTimeout(K,this.#M);this.#U()},k.onerror=(M)=>{console.log(M.message),console.log(M)},this.#k.addWorker(k)}#U(){let k=this.#k.getAvailableWorker();if(k){let M=this.#Q.shift();if(M)this.#k.assignTask(k,M),this.#k.clearWorkerTimeout(k)}else if(this.#k.count<this.#I)this.#q(),this.#U()}addTask(k){return new Promise((M,Q)=>{this.#Q.push({id:nk(),data:{blob:k.blob,options:k.options},resolve:M,reject:Q}),this.#U()})}}class xk{#M;#I;constructor(k){this.#M=new o,this.#I=k}squish(k,M){let Q=M?.maxDimension||this.#I.maxDimension;if(M?.useMainThread||this.#I.useMainThread)return yk(k,Q);return this.#M.addTask({blob:k,options:M||this.#I})}}export{xk as PicSquish};
