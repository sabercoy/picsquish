var jn=Object.create;var{getPrototypeOf:Gn,defineProperty:t,getOwnPropertyNames:En}=Object;var On=Object.prototype.hasOwnProperty;var an=(n,k,T)=>{T=n!=null?jn(Gn(n)):{};let I=k||!n||!n.__esModule?t(T,"default",{value:n,enumerable:!0}):T;for(let m of En(n))if(!On.call(I,m))t(I,m,{get:()=>n[m],enumerable:!0});return I};var zn=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Qn=zn((yk,Cn)=>{var l,c,f,i,s,x,An,Un;function Wn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,T=Math.exp(-k),I=Math.exp(-2*k),m=(1-T)*(1-T)/(1+2*k*T-I);return l=m,c=m*(k-1)*T,f=m*(k+1)*T,i=-m*I,s=2*T,x=-I,An=(l+c)/(1-s-x),Un=(f+i)/(1-s-x),new Float32Array([l,c,f,i,s,x,An,Un])}function wn(n,k,T,I,m,y){var R,B,D,M,U,w,K,A,Q,J,q,L,C,$,j,O,Z,G,X,u,V,E,N,a,g,h,Y,S,W,F;for(g=0;g<y;g++){E=g*m,N=g,a=0,R=n[E],B=R&255,D=R>>8&255,M=R>>16&255,U=R>>24&255,G=B*I[6],X=D*I[6],u=M*I[6],V=U*I[6],$=G,j=X,O=u,Z=V,Y=I[0],S=I[1],W=I[4],F=I[5];for(h=0;h<m;h++)R=n[E],w=R&255,K=R>>8&255,A=R>>16&255,Q=R>>24&255,J=w*Y+B*S+$*W+G*F,q=K*Y+D*S+j*W+X*F,L=A*Y+M*S+O*W+u*F,C=Q*Y+U*S+Z*W+V*F,G=$,X=j,u=O,V=Z,$=J,j=q,O=L,Z=C,B=w,D=K,M=A,U=Q,T[a]=$,T[a+1]=j,T[a+2]=O,T[a+3]=Z,a+=4,E++;E--,a-=4,N+=y*(m-1),R=n[E],B=R&255,D=R>>8&255,M=R>>16&255,U=R>>24&255,G=B*I[7],X=D*I[7],u=M*I[7],V=U*I[7],$=G,j=X,O=u,Z=V,w=B,K=D,A=M,Q=U,Y=I[2],S=I[3];for(h=m-1;h>=0;h--)J=w*Y+B*S+$*W+G*F,q=K*Y+D*S+j*W+X*F,L=A*Y+M*S+O*W+u*F,C=Q*Y+U*S+Z*W+V*F,G=$,X=j,u=O,V=Z,$=J,j=q,O=L,Z=C,B=w,D=K,M=A,U=Q,R=n[E],w=R&255,K=R>>8&255,A=R>>16&255,Q=R>>24&255,R=(T[a]+$<<0)+(T[a+1]+j<<8)+(T[a+2]+O<<16)+(T[a+3]+Z<<24),k[N]=R,E--,a-=4,N-=y}}function Fn(n,k,T,I){if(!I)return;var m=new Uint32Array(n.buffer),y=new Uint32Array(m.length),R=new Float32Array(Math.max(k,T)*4),B=Wn(I);wn(m,y,R,B,k,T,I),wn(y,m,R,B,T,k,I)}Cn.exports=Fn});var z=4;var un=2;function e(n,k,T,I,m,y){let R=T/n,B=I/k,D=(2*y+un+1)/m;if(D>0.5)return[{toWidth:T,toHeight:I}];let M=Math.ceil(Math.log(Math.min(R,B))/Math.log(D));if(M<=1)return[{toWidth:T,toHeight:I}];let U=[];for(let w=0;w<M;w++){let K=Math.round(Math.pow(Math.pow(n,M-w-1)*Math.pow(T,w+1),1/M)),A=Math.round(Math.pow(Math.pow(k,M-w-1)*Math.pow(I,w+1),1/M));U.push({toWidth:K,toHeight:A})}return U}function Nn(n,k){let I=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");return I.globalCompositeOperation="copy",I.drawImage(n,k.x,k.y,k.width,k.height,0,0,k.width,k.height),I.getImageData(0,0,k.width,k.height).data.buffer}function Xn(n,k,T){let I=new Uint8ClampedArray(T.width*T.height*z);for(let m=0;m<T.height;m++){let y=((T.y+m)*k+T.x)*z,R=m*T.width*z;I.set(n.subarray(y,y+T.width*z),R)}return I.buffer}function r(n,k,T){if(n instanceof ImageBitmap)return Nn(n,T);else return Xn(n,k,T)}var kn=0.00001;function o(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.floor(n)}function nn(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.ceil(n)}function In(n,k,T,I,m,y,R,B,D,M,U){let w=I/k,K=m/T,A=o(y*w)-2*R,Q=o(y*K)-2*R;if(A<1||Q<1)throw new Error("Picsquish error: target tile width/height is too small");let J,q,L,C,$,j,O=[];for(C=0;C<m;C+=Q)for(L=0;L<I;L+=A){if(J=L-R,J<0)J=0;if($=L+A+R-J,J+$>=I)$=I-J;if(q=C-R,q<0)q=0;if(j=C+Q+R-q,q+j>=m)j=m-q;let Z={toX:J,toY:q,toWidth:$,toHeight:j,toInnerX:L,toInnerY:C,toInnerWidth:A,toInnerHeight:Q,offsetX:J/w-o(J/w),offsetY:q/K-o(q/K),scaleX:w,scaleY:K,x:o(J/w),y:o(q/K),width:nn($/w),height:nn(j/K),initialSize:y,filterPadding:R,filter:B,unsharpAmount:D,unsharpRadius:M,unsharpThreshold:U},G=r(n,k,Z);O.push({tile:G,...Z})}return O}async function Tn(n){let k,T,I,m,y,R;if(n.image instanceof Blob||n.image instanceof ImageBitmap){let D=n.image instanceof ImageBitmap?n.image:await createImageBitmap(n.image);k=D,T=D.width,I=D.height;let M=n.maxDimension/T,U=n.maxDimension/I,w=Math.min(M,U,1),K=Math.floor(T*w),A=Math.floor(I*w);m=e(T,I,K,A,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,T=n.image.fromWidth,I=n.image.fromHeight,m=n.image.stages;y=m[0].toWidth,R=m[0].toHeight;let B=In(k,T,I,y,R,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);if(k instanceof ImageBitmap)k.close();return{tileTransforms:B,stages:m}}function p(n,k,T){let I=new Uint8ClampedArray(T.tile);for(let m=0;m<T.toHeight;m++){let y=m*T.toWidth*z,R=((T.toY+m)*k+T.toX)*z;n.set(I.subarray(y,y+T.toWidth*z),R)}}var d={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Vn=14;function Rn(n){return Math.round(n*((1<<Vn)-1))}function v(n,k,T,I,m){let y=d[n].fn,R=1/I,B=Math.min(1,I),D=d[n].win/B,M,U,w,K,A,Q,J,q,L,C,$,j,O,Z,G,X,u,V=Math.floor((D+1)*2),E=new Int16Array((V+2)*T),N=0,a=!E.subarray||!E.set;for(M=0;M<T;M++){U=(M+0.5)*R+m,w=Math.max(0,Math.floor(U-D)),K=Math.min(k-1,Math.ceil(U+D)),A=K-w+1,Q=new Float32Array(A),J=new Int16Array(A),q=0;for(L=w,C=0;L<=K;L++,C++)$=y((L+0.5-U)*B),q+=$,Q[C]=$;j=0;for(C=0;C<Q.length;C++)O=Q[C]/q,j+=O,J[C]=Rn(O);J[T>>1]+=Rn(1-j),Z=0;while(Z<J.length&&J[Z]===0)Z++;if(Z<J.length){G=J.length-1;while(G>0&&J[G]===0)G--;if(X=w+Z,u=G-Z+1,E[N++]=X,E[N++]=u,!a)E.set(J.subarray(Z,G+1),N),N+=u;else for(C=Z;C<=G;C++)E[N++]=J[C]}else E[N++]=0,E[N++]=0}return E}function b(n){return n<0?0:n>255?255:n}function P(n){return n>=0?n:0}function mn(n,k,T,I,m,y){let R,B,D,M,U,w,K,A,Q,J,q,L=0,C=0;for(Q=0;Q<I;Q++){U=0;for(J=0;J<m;J++){w=y[U++],K=y[U++],A=L+w*4|0,R=B=D=M=0;for(;K>0;K--)q=y[U++],M=M+q*n[A+3]|0,D=D+q*n[A+2]|0,B=B+q*n[A+1]|0,R=R+q*n[A]|0,A=A+4|0;k[C+3]=P(M>>7),k[C+2]=P(D>>7),k[C+1]=P(B>>7),k[C]=P(R>>7),C=C+I*4|0}C=(Q+1)*4|0,L=(Q+1)*T*4|0}}function Mn(n,k,T,I,m,y){let R,B,D,M,U,w,K,A,Q,J,q,L=0,C=0;for(Q=0;Q<I;Q++){U=0;for(J=0;J<m;J++){w=y[U++],K=y[U++],A=L+w*4|0,R=B=D=M=0;for(;K>0;K--)q=y[U++],M=M+q*n[A+3]|0,D=D+q*n[A+2]|0,B=B+q*n[A+1]|0,R=R+q*n[A]|0,A=A+4|0;R>>=7,B>>=7,D>>=7,M>>=7,k[C+3]=b(M+8192>>14),k[C+2]=b(D+8192>>14),k[C+1]=b(B+8192>>14),k[C]=b(R+8192>>14),C=C+I*4|0}C=(Q+1)*4|0,L=(Q+1)*T*4|0}}function yn(n,k,T,I,m,y){let R,B,D,M,U,w,K,A,Q,J,q,L,C=0,$=0;for(J=0;J<I;J++){w=0;for(q=0;q<m;q++){K=y[w++],A=y[w++],Q=C+K*4|0,R=B=D=M=0;for(;A>0;A--)L=y[w++],U=n[Q+3],M=M+L*U|0,D=D+L*n[Q+2]*U|0,B=B+L*n[Q+1]*U|0,R=R+L*n[Q]*U|0,Q=Q+4|0;D=D/255|0,B=B/255|0,R=R/255|0,k[$+3]=P(M>>7),k[$+2]=P(D>>7),k[$+1]=P(B>>7),k[$]=P(R>>7),$=$+I*4|0}$=(J+1)*4|0,C=(J+1)*T*4|0}}function Bn(n,k,T,I,m,y){let R,B,D,M,U,w,K,A,Q,J,q,L=0,C=0;for(Q=0;Q<I;Q++){U=0;for(J=0;J<m;J++){w=y[U++],K=y[U++],A=L+w*4|0,R=B=D=M=0;for(;K>0;K--)q=y[U++],M=M+q*n[A+3]|0,D=D+q*n[A+2]|0,B=B+q*n[A+1]|0,R=R+q*n[A]|0,A=A+4|0;if(R>>=7,B>>=7,D>>=7,M>>=7,M=b(M+8192>>14),M>0)R=R*255/M|0,B=B*255/M|0,D=D*255/M|0;k[C+3]=M,k[C+2]=b(D+8192>>14),k[C+1]=b(B+8192>>14),k[C]=b(R+8192>>14),C=C+I*4|0}C=(Q+1)*4|0,L=(Q+1)*T*4|0}}function Yn(n,k,T){let I=3,m=k*T*4|0;while(I<m){if(n[I]!==255)return!0;I=I+4|0}return!1}function Sn(n,k,T){let I=3,m=k*T*4|0;while(I<m)n[I]=255,I=I+4|0}function Dn(n,k,T,I,m,y,R,B,D,M){let U=v(k,T,m,R,D),w=v(k,I,y,B,M),K=new Uint8Array(m*y*4),A=new Uint16Array(m*I*4);if(Yn(n,T,I))yn(n,A,T,I,m,U),Bn(A,K,I,m,y,w);else mn(n,A,T,I,m,U),Mn(A,K,I,m,y,w),Sn(K,m,y);return K}var qn=an(Qn(),1);function bn(n,k,T){let I=k*T,m=new Uint16Array(I),y,R,B,D;for(let M=0;M<I;M++)y=n[4*M],R=n[4*M+1],B=n[4*M+2],D=y>=R&&y>=B?y:R>=B&&R>=y?R:B,m[M]=D<<8;return m}function Kn(n,k,T,I,m,y){let R,B,D,M,U;if(I===0||m<0.5)return;if(m>2)m=2;let w=bn(n,k,T),K=new Uint16Array(w);qn.default(K,k,T,m);let A=I/100*4096+0.5|0,Q=y<<8,J=k*T;for(let q=0;q<J;q++)if(R=w[q],M=R-K[q],Math.abs(M)>=Q)B=R+(A*M+2048>>12),B=B>65280?65280:B,B=B<0?0:B,R=R!==0?R:1,D=(B<<12)/R|0,U=q*4,n[U]=n[U]*D+2048>>12,n[U+1]=n[U+1]*D+2048>>12,n[U+2]=n[U+2]*D+2048>>12}function Jn(n){let k=Dn(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)Kn(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}var Pn=`
var QI=Object.create;var{getPrototypeOf:$I,defineProperty:f,getOwnPropertyNames:ZI}=Object;var mI=Object.prototype.hasOwnProperty;var GI=(I,k,y)=>{y=I!=null?QI($I(I)):{};let M=k||!I||!I.__esModule?f(y,"default",{value:I,enumerable:!0}):y;for(let D of ZI(I))if(!mI.call(M,D))f(M,D,{get:()=>I[D],enumerable:!0});return M};var LI=(I,k)=>()=>(k||I((k={exports:{}}).exports,k),k.exports);var CI=LI((iI,nI)=>{var d,s,c,l,h,g,BI,AI;function VI(I){if(I<0.5)I=0.5;var k=Math.exp(0.527076)/I,y=Math.exp(-k),M=Math.exp(-2*k),D=(1-y)*(1-y)/(1+2*k*y-M);return d=D,s=D*(k-1)*y,c=D*(k+1)*y,l=-D*M,h=2*y,g=-M,BI=(d+s)/(1-h-g),AI=(c+l)/(1-h-g),new Float32Array([d,s,c,l,h,g,BI,AI])}function UI(I,k,y,M,D,C){var R,B,A,q,U,K,$,n,Z,Q,J,m,T,G,j,w,L,O,X,N,Y,z,V,E,x,u,S,F,H,W;for(x=0;x<C;x++){z=x*D,V=x,E=0,R=I[z],B=R&255,A=R>>8&255,q=R>>16&255,U=R>>24&255,O=B*M[6],X=A*M[6],N=q*M[6],Y=U*M[6],G=O,j=X,w=N,L=Y,S=M[0],F=M[1],H=M[4],W=M[5];for(u=0;u<D;u++)R=I[z],K=R&255,$=R>>8&255,n=R>>16&255,Z=R>>24&255,Q=K*S+B*F+G*H+O*W,J=$*S+A*F+j*H+X*W,m=n*S+q*F+w*H+N*W,T=Z*S+U*F+L*H+Y*W,O=G,X=j,N=w,Y=L,G=Q,j=J,w=m,L=T,B=K,A=$,q=n,U=Z,y[E]=G,y[E+1]=j,y[E+2]=w,y[E+3]=L,E+=4,z++;z--,E-=4,V+=C*(D-1),R=I[z],B=R&255,A=R>>8&255,q=R>>16&255,U=R>>24&255,O=B*M[7],X=A*M[7],N=q*M[7],Y=U*M[7],G=O,j=X,w=N,L=Y,K=B,$=A,n=q,Z=U,S=M[2],F=M[3];for(u=D-1;u>=0;u--)Q=K*S+B*F+G*H+O*W,J=$*S+A*F+j*H+X*W,m=n*S+q*F+w*H+N*W,T=Z*S+U*F+L*H+Y*W,O=G,X=j,N=w,Y=L,G=Q,j=J,w=m,L=T,B=K,A=$,q=n,U=Z,R=I[z],K=R&255,$=R>>8&255,n=R>>16&255,Z=R>>24&255,R=(y[E]+G<<0)+(y[E+1]+j<<8)+(y[E+2]+w<<16)+(y[E+3]+L<<24),k[V]=R,z--,E-=4,V-=C}}function XI(I,k,y,M){if(!M)return;var D=new Uint32Array(I.buffer),C=new Uint32Array(D.length),R=new Float32Array(Math.max(k,y)*4),B=VI(M);UI(D,C,R,B,k,y,M),UI(C,D,R,B,y,k,M)}nI.exports=XI});var p=4;var jI=2;function _(I,k,y,M,D,C){let R=y/I,B=M/k,A=(2*C+jI+1)/D;if(A>0.5)return[{toWidth:y,toHeight:M}];let q=Math.ceil(Math.log(Math.min(R,B))/Math.log(A));if(q<=1)return[{toWidth:y,toHeight:M}];let U=[];for(let K=0;K<q;K++){let $=Math.round(Math.pow(Math.pow(I,q-K-1)*Math.pow(y,K+1),1/q)),n=Math.round(Math.pow(Math.pow(k,q-K-1)*Math.pow(M,K+1),1/q));U.push({toWidth:$,toHeight:n})}return U}function OI(I,k){let M=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");return M.globalCompositeOperation="copy",M.drawImage(I,k.x,k.y,k.width,k.height,0,0,k.width,k.height),M.getImageData(0,0,k.width,k.height).data.buffer}function zI(I,k,y){let M=new Uint8ClampedArray(y.width*y.height*p);for(let D=0;D<y.height;D++){let C=((y.y+D)*k+y.x)*p,R=D*y.width*p;M.set(I.subarray(C,C+y.width*p),R)}return M.buffer}function i(I,k,y){if(I instanceof ImageBitmap)return OI(I,y);else return zI(I,k,y)}var e=0.00001;function a(I){let k=Math.round(I);if(Math.abs(I-k)<e)return k;return Math.floor(I)}function t(I){let k=Math.round(I);if(Math.abs(I-k)<e)return k;return Math.ceil(I)}function r(I,k,y,M,D,C,R,B,A,q,U){let K=M/k,$=D/y,n=a(C*K)-2*R,Z=a(C*$)-2*R;if(n<1||Z<1)throw new Error("Picsquish error: target tile width/height is too small");let Q,J,m,T,G,j,w=[];for(T=0;T<D;T+=Z)for(m=0;m<M;m+=n){if(Q=m-R,Q<0)Q=0;if(G=m+n+R-Q,Q+G>=M)G=M-Q;if(J=T-R,J<0)J=0;if(j=T+Z+R-J,J+j>=D)j=D-J;let L={toX:Q,toY:J,toWidth:G,toHeight:j,toInnerX:m,toInnerY:T,toInnerWidth:n,toInnerHeight:Z,offsetX:Q/K-a(Q/K),offsetY:J/$-a(J/$),scaleX:K,scaleY:$,x:a(Q/K),y:a(J/$),width:t(G/K),height:t(j/$),initialSize:C,filterPadding:R,filter:B,unsharpAmount:A,unsharpRadius:q,unsharpThreshold:U},O=i(I,k,L);w.push({tile:O,...L})}return w}async function II(I){let k,y,M,D,C,R;if(I.image instanceof Blob||I.image instanceof ImageBitmap){let A=I.image instanceof ImageBitmap?I.image:await createImageBitmap(I.image);k=A,y=A.width,M=A.height;let q=I.maxDimension/y,U=I.maxDimension/M,K=Math.min(q,U,1),$=Math.floor(y*K),n=Math.floor(M*K);D=_(y,M,$,n,I.tileOptions.initialSize,I.tileOptions.filterPadding)}else k=I.image.from,y=I.image.fromWidth,M=I.image.fromHeight,D=I.image.stages;C=D[0].toWidth,R=D[0].toHeight;let B=r(k,y,M,C,R,I.tileOptions.initialSize,I.tileOptions.filterPadding,I.tileOptions.filter,I.tileOptions.unsharpAmount,I.tileOptions.unsharpRadius,I.tileOptions.unsharpThreshold);if(k instanceof ImageBitmap)k.close();return{tileTransforms:B,stages:D}}var v={box:{win:0.5,fn:(I)=>{if(I<0)I=-I;return I<0.5?1:0}},hamming:{win:1,fn:(I)=>{if(I<0)I=-I;if(I>=1)return 0;if(I<0.00000011920929)return 1;let k=I*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(I)=>{if(I<0)I=-I;if(I>=2)return 0;if(I<0.00000011920929)return 1;let k=I*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(I)=>{if(I<0)I=-I;if(I>=3)return 0;if(I<0.00000011920929)return 1;let k=I*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(I)=>{if(I<0)I=-I;if(I>=2.5)return 0;if(I>=1.5)return-0.125*(I-2.5)*(I-2.5);if(I>=0.5)return 0.25*(4*I*I-11*I+7);return 1.0625-1.75*I*I}}};var wI=14;function kI(I){return Math.round(I*((1<<wI)-1))}function o(I,k,y,M,D){let C=v[I].fn,R=1/M,B=Math.min(1,M),A=v[I].win/B,q,U,K,$,n,Z,Q,J,m,T,G,j,w,L,O,X,N,Y=Math.floor((A+1)*2),z=new Int16Array((Y+2)*y),V=0,E=!z.subarray||!z.set;for(q=0;q<y;q++){U=(q+0.5)*R+D,K=Math.max(0,Math.floor(U-A)),$=Math.min(k-1,Math.ceil(U+A)),n=$-K+1,Z=new Float32Array(n),Q=new Int16Array(n),J=0;for(m=K,T=0;m<=$;m++,T++)G=C((m+0.5-U)*B),J+=G,Z[T]=G;j=0;for(T=0;T<Z.length;T++)w=Z[T]/J,j+=w,Q[T]=kI(w);Q[y>>1]+=kI(1-j),L=0;while(L<Q.length&&Q[L]===0)L++;if(L<Q.length){O=Q.length-1;while(O>0&&Q[O]===0)O--;if(X=K+L,N=O-L+1,z[V++]=X,z[V++]=N,!E)z.set(Q.subarray(L,O+1),V),V+=N;else for(T=L;T<=O;T++)z[V++]=Q[T]}else z[V++]=0,z[V++]=0}return z}function P(I){return I<0?0:I>255?255:I}function b(I){return I>=0?I:0}function MI(I,k,y,M,D,C){let R,B,A,q,U,K,$,n,Z,Q,J,m=0,T=0;for(Z=0;Z<M;Z++){U=0;for(Q=0;Q<D;Q++){K=C[U++],$=C[U++],n=m+K*4|0,R=B=A=q=0;for(;$>0;$--)J=C[U++],q=q+J*I[n+3]|0,A=A+J*I[n+2]|0,B=B+J*I[n+1]|0,R=R+J*I[n]|0,n=n+4|0;k[T+3]=b(q>>7),k[T+2]=b(A>>7),k[T+1]=b(B>>7),k[T]=b(R>>7),T=T+M*4|0}T=(Z+1)*4|0,m=(Z+1)*y*4|0}}function RI(I,k,y,M,D,C){let R,B,A,q,U,K,$,n,Z,Q,J,m=0,T=0;for(Z=0;Z<M;Z++){U=0;for(Q=0;Q<D;Q++){K=C[U++],$=C[U++],n=m+K*4|0,R=B=A=q=0;for(;$>0;$--)J=C[U++],q=q+J*I[n+3]|0,A=A+J*I[n+2]|0,B=B+J*I[n+1]|0,R=R+J*I[n]|0,n=n+4|0;R>>=7,B>>=7,A>>=7,q>>=7,k[T+3]=P(q+8192>>14),k[T+2]=P(A+8192>>14),k[T+1]=P(B+8192>>14),k[T]=P(R+8192>>14),T=T+M*4|0}T=(Z+1)*4|0,m=(Z+1)*y*4|0}}function yI(I,k,y,M,D,C){let R,B,A,q,U,K,$,n,Z,Q,J,m,T=0,G=0;for(Q=0;Q<M;Q++){K=0;for(J=0;J<D;J++){$=C[K++],n=C[K++],Z=T+$*4|0,R=B=A=q=0;for(;n>0;n--)m=C[K++],U=I[Z+3],q=q+m*U|0,A=A+m*I[Z+2]*U|0,B=B+m*I[Z+1]*U|0,R=R+m*I[Z]*U|0,Z=Z+4|0;A=A/255|0,B=B/255|0,R=R/255|0,k[G+3]=b(q>>7),k[G+2]=b(A>>7),k[G+1]=b(B>>7),k[G]=b(R>>7),G=G+M*4|0}G=(Q+1)*4|0,T=(Q+1)*y*4|0}}function DI(I,k,y,M,D,C){let R,B,A,q,U,K,$,n,Z,Q,J,m=0,T=0;for(Z=0;Z<M;Z++){U=0;for(Q=0;Q<D;Q++){K=C[U++],$=C[U++],n=m+K*4|0,R=B=A=q=0;for(;$>0;$--)J=C[U++],q=q+J*I[n+3]|0,A=A+J*I[n+2]|0,B=B+J*I[n+1]|0,R=R+J*I[n]|0,n=n+4|0;if(R>>=7,B>>=7,A>>=7,q>>=7,q=P(q+8192>>14),q>0)R=R*255/q|0,B=B*255/q|0,A=A*255/q|0;k[T+3]=q,k[T+2]=P(A+8192>>14),k[T+1]=P(B+8192>>14),k[T]=P(R+8192>>14),T=T+M*4|0}T=(Z+1)*4|0,m=(Z+1)*y*4|0}}function EI(I,k,y){let M=3,D=k*y*4|0;while(M<D){if(I[M]!==255)return!0;M=M+4|0}return!1}function NI(I,k,y){let M=3,D=k*y*4|0;while(M<D)I[M]=255,M=M+4|0}function qI(I,k,y,M,D,C,R,B,A,q){let U=o(k,y,D,R,A),K=o(k,M,C,B,q),$=new Uint8Array(D*C*4),n=new Uint16Array(D*M*4);if(EI(I,y,M))yI(I,n,y,M,D,U),DI(n,$,M,D,C,K);else MI(I,n,y,M,D,U),RI(n,$,M,D,C,K),NI($,D,C);return $}var KI=GI(CI(),1);function YI(I,k,y){let M=k*y,D=new Uint16Array(M),C,R,B,A;for(let q=0;q<M;q++)C=I[4*q],R=I[4*q+1],B=I[4*q+2],A=C>=R&&C>=B?C:R>=B&&R>=C?R:B,D[q]=A<<8;return D}function TI(I,k,y,M,D,C){let R,B,A,q,U;if(M===0||D<0.5)return;if(D>2)D=2;let K=YI(I,k,y),$=new Uint16Array(K);KI.default($,k,y,D);let n=M/100*4096+0.5|0,Z=C<<8,Q=k*y;for(let J=0;J<Q;J++)if(R=K[J],q=R-$[J],Math.abs(q)>=Z)B=R+(n*q+2048>>12),B=B>65280?65280:B,B=B<0?0:B,R=R!==0?R:1,A=(B<<12)/R|0,U=J*4,I[U]=I[U]*A+2048>>12,I[U+1]=I[U+1]*A+2048>>12,I[U+2]=I[U+2]*A+2048>>12}function JI(I){let k=qI(new Uint8ClampedArray(I.tile),I.filter,I.width,I.height,I.toWidth,I.toHeight,I.scaleX,I.scaleY,I.offsetX,I.offsetY);if(I.unsharpAmount)TI(k,I.toWidth,I.toHeight,I.unsharpAmount,I.unsharpRadius,I.unsharpThreshold);return k}var SI=async(I)=>{let{taskId:k,squishId:y,taskType:M,image:D,maxDimension:C,tileOptions:R}=I,{tileTransforms:B,stages:A}=await II({image:D,maxDimension:C,tileOptions:R}),q={taskId:k,squishId:y,taskType:M,output:{tileTransforms:B,stages:A}},U=B.map((K)=>K.tile);self.postMessage(q,U)};function FI(I){let{taskId:k,squishId:y,taskType:M,tileTransform:D}=I;D.tile=JI(D).buffer;let C={taskId:k,squishId:y,taskType:M,output:{tileTransform:D}};self.postMessage(C,[D.tile])}self.onmessage=async(I)=>{try{switch(I.data.taskType){case 0:return SI(I.data);case 1:return FI(I.data)}}catch(k){self.postMessage({taskId:I.data.taskId,squishId:I.data.squishId,taskType:I.data.taskType,error:k})}};
`,Hn=new Blob([Pn],{type:"application/javascript"});class Ln{#n;#k;#I;#T;constructor(){this.#n=new Map,this.#k=new Map,this.#I=null,this.#T=null}#R(){if(this.#I===null)return;clearTimeout(this.#I),this.#I=null}prepare(n,k,T){if(this.#n.size)return;this.#T=T;let I=URL.createObjectURL(Hn);while(this.#n.size<k){let m=new Worker(I);m.onmessage=n,this.#n.set(m,null)}URL.revokeObjectURL(I)}assignTask(n,k,T,I){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#R(),n.postMessage(T,I)}setTimeout(){if(this.#I!==null)return;this.#I=setTimeout(()=>{for(let n of this.#n.keys())n.terminate();this.#n.clear(),this.#k.clear()},this.#T||0)}getAvailableWorkers(){let n=[];for(let[k,T]of this.#n.entries())if(T===null)n.push(k);return n}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n)}}var H=new Ln;var _=(()=>{let n=0;return()=>++n})();class $n{#n;#k;#I;constructor(){this.#n=new Map,this.#k=[],this.#I=[]}#T(n,k){let T={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions},I=k.data.image instanceof ImageBitmap?[k.data.image]:[];H.assignTask(n,k,T,I)}#R(n,k){let T={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};H.assignTask(n,k,T,[T.tileTransform.tile])}#M(n){let k=this.#k.shift();if(k)return this.#T(n,k);let T=this.#I.shift();if(T)return this.#R(n,T)}#m(){if(this.#k.length===0&&this.#I.length===0)return H.setTimeout();let k=H.getAvailableWorkers();for(let T of k)this.#M(T)}#y(n,k){let{squishId:T,output:I}=k,m=I.stages[0].toWidth,y=I.stages[0].toHeight;n.to=new Uint8ClampedArray(m*y*z),n.toWidth=m,n.toHeight=y,n.stages=I.stages,n.remainingTileCount=I.tileTransforms.length;for(let R of I.tileTransforms)this.#I.push({id:_(),squishId:T,data:{tileTransform:R}})}#B(n,k){let{squishId:T,output:I}=k;if(!n.to)throw new Error("Picsquish error: squishContext.to not found");if(p(n.to,n.toWidth,I.tileTransform),n.remainingTileCount--,n.remainingTileCount)return;if(n.stages.shift(),n.stages[0])this.#k.push({id:_(),squishId:T,data:{image:{from:n.to,fromWidth:n.toWidth,fromHeight:n.toHeight,stages:n.stages},maxDimension:n.maxDimension,tileOptions:n.tileOptions}});else{let m=new ImageData(n.to,n.toWidth,n.toHeight);createImageBitmap(m).then((y)=>{this.#n.delete(T),n.resolve(y)})}}#D(n){let k=this.#n.get(n.data.squishId);if(!k)throw new Error("Picsquish error: squishContext not found");if(n.data.error)k.reject(n.data.error);switch(n.data.taskType){case 0:this.#y(k,n.data);break;case 1:this.#B(k,n.data);break}H.removeTask(n.data.taskId),this.#m()}add(n,k,T){return H.prepare((I)=>this.#D(I),k,T),new Promise((I,m)=>{let y=_();this.#n.set(y,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:I,reject:m}),this.#k.push({id:y,squishId:y,data:n}),this.#m()})}}var Zn=new $n;async function hn(n,k,T){let I=null,m,y,R;for(;;){let D=await Tn({image:I||n,maxDimension:k,tileOptions:T});y=D.stages[0].toWidth,R=D.stages[0].toHeight,m=new Uint8ClampedArray(y*R*z);for(let M of D.tileTransforms)M.tile=Jn(M).buffer,p(m,y,M);if(D.stages.shift(),I={from:m,fromWidth:y,fromHeight:R,stages:D.stages},!D.stages[0])break}let B=new ImageData(I.from,I.fromWidth,I.fromHeight);return await createImageBitmap(B)}async function Hk(n,k,T={}){let I=T.tileSize||1024,m=T.filter||"mks2013",y=T.unsharpAmount||0,R=T.unsharpRadius||0,B=T.unsharpThreshold||0,D=T.useMainThread,M=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,U=T.maxWorkerPoolSize||Math.min(M,4),w=T.maxWorkerIdleTime||2000,K=3,A=Math.ceil(Math.max(3,2.5*R|0)),Q={initialSize:I,filterPadding:A,filter:m,unsharpAmount:y,unsharpRadius:R,unsharpThreshold:B};if(D)return await hn(n,k,Q);return Zn.add({image:n,maxDimension:k,tileOptions:Q},U,w)}export{Hk as squish};
