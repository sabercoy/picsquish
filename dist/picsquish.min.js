var jn=Object.create;var{getPrototypeOf:Ln,defineProperty:_,getOwnPropertyNames:Gn}=Object;var wn=Object.prototype.hasOwnProperty;var En=(n,m,T)=>{T=n!=null?jn(Ln(n)):{};let k=m||!n||!n.__esModule?_(T,"default",{value:n,enumerable:!0}):T;for(let R of Gn(n))if(!wn.call(k,R))_(k,R,{get:()=>n[R],enumerable:!0});return k};var zn=(n,m)=>()=>(m||n((m={exports:{}}).exports,m),m.exports);var Bn=zn((Tk,An)=>{var v,f,l,c,g,s,Cn,qn;function Nn(n){if(n<0.5)n=0.5;var m=Math.exp(0.527076)/n,T=Math.exp(-m),k=Math.exp(-2*m),R=(1-T)*(1-T)/(1+2*m*T-k);return v=R,f=R*(m-1)*T,l=R*(m+1)*T,c=-R*k,g=2*T,s=-k,Cn=(v+f)/(1-g-s),qn=(l+c)/(1-g-s),new Float32Array([v,f,l,c,g,s,Cn,qn])}function Un(n,m,T,k,R,C){var I,M,y,D,U,q,B,A,J,$,Q,Z,K,j,G,z,L,w,N,X,Y,E,V,u,o,b,W,S,F,H;for(o=0;o<C;o++){E=o*R,V=o,u=0,I=n[E],M=I&255,y=I>>8&255,D=I>>16&255,U=I>>24&255,w=M*k[6],N=y*k[6],X=D*k[6],Y=U*k[6],j=w,G=N,z=X,L=Y,W=k[0],S=k[1],F=k[4],H=k[5];for(b=0;b<R;b++)I=n[E],q=I&255,B=I>>8&255,A=I>>16&255,J=I>>24&255,$=q*W+M*S+j*F+w*H,Q=B*W+y*S+G*F+N*H,Z=A*W+D*S+z*F+X*H,K=J*W+U*S+L*F+Y*H,w=j,N=G,X=z,Y=L,j=$,G=Q,z=Z,L=K,M=q,y=B,D=A,U=J,T[u]=j,T[u+1]=G,T[u+2]=z,T[u+3]=L,u+=4,E++;E--,u-=4,V+=C*(R-1),I=n[E],M=I&255,y=I>>8&255,D=I>>16&255,U=I>>24&255,w=M*k[7],N=y*k[7],X=D*k[7],Y=U*k[7],j=w,G=N,z=X,L=Y,q=M,B=y,A=D,J=U,W=k[2],S=k[3];for(b=R-1;b>=0;b--)$=q*W+M*S+j*F+w*H,Q=B*W+y*S+G*F+N*H,Z=A*W+D*S+z*F+X*H,K=J*W+U*S+L*F+Y*H,w=j,N=G,X=z,Y=L,j=$,G=Q,z=Z,L=K,M=q,y=B,D=A,U=J,I=n[E],q=I&255,B=I>>8&255,A=I>>16&255,J=I>>24&255,I=(T[u]+j<<0)+(T[u+1]+G<<8)+(T[u+2]+z<<16)+(T[u+3]+L<<24),m[V]=I,E--,u-=4,V-=C}}function Yn(n,m,T,k){if(!k)return;var R=new Uint32Array(n.buffer),C=new Uint32Array(R.length),I=new Float32Array(Math.max(m,T)*4),M=Nn(k);Un(R,C,I,M,m,T,k),Un(C,R,I,M,T,m,k)}An.exports=Yn});var O=4;var un=2;function t(n,m,T,k,R,C){let I=T/n,M=k/m,y=(2*C+un+1)/R;if(y>0.5)return[{toWidth:T,toHeight:k}];let D=Math.ceil(Math.log(Math.min(I,M))/Math.log(y));if(D<=1)return[{toWidth:T,toHeight:k}];let U=[];for(let q=0;q<D;q++){let B=Math.round(Math.pow(Math.pow(n,D-q-1)*Math.pow(T,q+1),1/D)),A=Math.round(Math.pow(Math.pow(m,D-q-1)*Math.pow(k,q+1),1/D));U.push({toWidth:B,toHeight:A})}return U}function e(n,m,T){let k=new Uint8ClampedArray(T.width*T.height*O);for(let R=0;R<T.height;R++){let C=((T.y+R)*m+T.x)*O,I=R*T.width*O;k.set(n.subarray(C,C+T.width*O),I)}return k}var nn=0.00001;function h(n){let m=Math.round(n);if(Math.abs(n-m)<nn)return m;return Math.floor(n)}function r(n){let m=Math.round(n);if(Math.abs(n-m)<nn)return m;return Math.ceil(n)}function kn(n,m,T,k,R,C,I,M,y,D,U){let q=k/m,B=R/T,A=h(C*q)-2*I,J=h(C*B)-2*I;if(A<1||J<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let $,Q,Z,K,j,G,z=[];for(K=0;K<R;K+=J)for(Z=0;Z<k;Z+=A){if($=Z-I,$<0)$=0;if(j=Z+A+I-$,$+j>=k)j=k-$;if(Q=K-I,Q<0)Q=0;if(G=K+J+I-Q,Q+G>=R)G=R-Q;let L={toX:$,toY:Q,toWidth:j,toHeight:G,toInnerX:Z,toInnerY:K,toInnerWidth:A,toInnerHeight:J,offsetX:$/q-h($/q),offsetY:Q/B-h(Q/B),scaleX:q,scaleY:B,x:h($/q),y:h(Q/B),width:r(j/q),height:r(G/B),initialSize:C,filterPadding:I,filter:M,unsharpAmount:y,unsharpRadius:D,unsharpThreshold:U},w=e(n,m,L);z.push({tile:w.buffer,...L})}return z}async function mn(n){let m,T,k,R,C,I;if(n.image instanceof Blob){let y=await createImageBitmap(n.image),U=new OffscreenCanvas(y.width,y.height).getContext("2d");if(!U)throw new Error("Canvas 2D context not supported");U.drawImage(y,0,0),m=U.getImageData(0,0,y.width,y.height).data,T=y.width,k=y.height,y.close();let B=n.maxDimension/T,A=n.maxDimension/k,J=Math.min(B,A,1),$=Math.floor(T*J),Q=Math.floor(k*J);I=t(T,k,$,Q,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else m=n.image.from,T=n.image.fromWidth,k=n.image.fromHeight,I=n.image.stages;R=I[0].toWidth,C=I[0].toHeight;let M=kn(m,T,k,R,C,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);return{from:m.buffer,fromWidth:T,fromHeight:k,tileTransforms:M,stages:I}}function x(n,m,T){let k=new Uint8ClampedArray(T.tile);for(let R=0;R<T.toHeight;R++){let C=R*T.toWidth*O,I=((T.toY+R)*m+T.toX)*O;n.set(k.subarray(C,C+T.toWidth*O),I)}}var p={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let m=n*Math.PI;return Math.sin(m)/m*(0.54+0.46*Math.cos(m/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let m=n*Math.PI;return Math.sin(m)/m*Math.sin(m/2)/(m/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let m=n*Math.PI;return Math.sin(m)/m*Math.sin(m/3)/(m/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var On=14;function Tn(n){return Math.round(n*((1<<On)-1))}function d(n,m,T,k,R){let C=p[n].fn,I=1/k,M=Math.min(1,k),y=p[n].win/M,D,U,q,B,A,J,$,Q,Z,K,j,G,z,L,w,N,X,Y=Math.floor((y+1)*2),E=new Int16Array((Y+2)*T),V=0,u=!E.subarray||!E.set;for(D=0;D<T;D++){U=(D+0.5)*I+R,q=Math.max(0,Math.floor(U-y)),B=Math.min(m-1,Math.ceil(U+y)),A=B-q+1,J=new Float32Array(A),$=new Int16Array(A),Q=0;for(Z=q,K=0;Z<=B;Z++,K++)j=C((Z+0.5-U)*M),Q+=j,J[K]=j;G=0;for(K=0;K<J.length;K++)z=J[K]/Q,G+=z,$[K]=Tn(z);$[T>>1]+=Tn(1-G),L=0;while(L<$.length&&$[L]===0)L++;if(L<$.length){w=$.length-1;while(w>0&&$[w]===0)w--;if(N=q+L,X=w-L+1,E[V++]=N,E[V++]=X,!u)E.set($.subarray(L,w+1),V),V+=X;else for(K=L;K<=w;K++)E[V++]=$[K]}else E[V++]=0,E[V++]=0}return E}function P(n){return n<0?0:n>255?255:n}function a(n){return n>=0?n:0}function In(n,m,T,k,R,C){let I,M,y,D,U,q,B,A,J,$,Q,Z=0,K=0;for(J=0;J<k;J++){U=0;for($=0;$<R;$++){q=C[U++],B=C[U++],A=Z+q*4|0,I=M=y=D=0;for(;B>0;B--)Q=C[U++],D=D+Q*n[A+3]|0,y=y+Q*n[A+2]|0,M=M+Q*n[A+1]|0,I=I+Q*n[A]|0,A=A+4|0;m[K+3]=a(D>>7),m[K+2]=a(y>>7),m[K+1]=a(M>>7),m[K]=a(I>>7),K=K+k*4|0}K=(J+1)*4|0,Z=(J+1)*T*4|0}}function Rn(n,m,T,k,R,C){let I,M,y,D,U,q,B,A,J,$,Q,Z=0,K=0;for(J=0;J<k;J++){U=0;for($=0;$<R;$++){q=C[U++],B=C[U++],A=Z+q*4|0,I=M=y=D=0;for(;B>0;B--)Q=C[U++],D=D+Q*n[A+3]|0,y=y+Q*n[A+2]|0,M=M+Q*n[A+1]|0,I=I+Q*n[A]|0,A=A+4|0;I>>=7,M>>=7,y>>=7,D>>=7,m[K+3]=P(D+8192>>14),m[K+2]=P(y+8192>>14),m[K+1]=P(M+8192>>14),m[K]=P(I+8192>>14),K=K+k*4|0}K=(J+1)*4|0,Z=(J+1)*T*4|0}}function Mn(n,m,T,k,R,C){let I,M,y,D,U,q,B,A,J,$,Q,Z,K=0,j=0;for($=0;$<k;$++){q=0;for(Q=0;Q<R;Q++){B=C[q++],A=C[q++],J=K+B*4|0,I=M=y=D=0;for(;A>0;A--)Z=C[q++],U=n[J+3],D=D+Z*U|0,y=y+Z*n[J+2]*U|0,M=M+Z*n[J+1]*U|0,I=I+Z*n[J]*U|0,J=J+4|0;y=y/255|0,M=M/255|0,I=I/255|0,m[j+3]=a(D>>7),m[j+2]=a(y>>7),m[j+1]=a(M>>7),m[j]=a(I>>7),j=j+k*4|0}j=($+1)*4|0,K=($+1)*T*4|0}}function yn(n,m,T,k,R,C){let I,M,y,D,U,q,B,A,J,$,Q,Z=0,K=0;for(J=0;J<k;J++){U=0;for($=0;$<R;$++){q=C[U++],B=C[U++],A=Z+q*4|0,I=M=y=D=0;for(;B>0;B--)Q=C[U++],D=D+Q*n[A+3]|0,y=y+Q*n[A+2]|0,M=M+Q*n[A+1]|0,I=I+Q*n[A]|0,A=A+4|0;if(I>>=7,M>>=7,y>>=7,D>>=7,D=P(D+8192>>14),D>0)I=I*255/D|0,M=M*255/D|0,y=y*255/D|0;m[K+3]=D,m[K+2]=P(y+8192>>14),m[K+1]=P(M+8192>>14),m[K]=P(I+8192>>14),K=K+k*4|0}K=(J+1)*4|0,Z=(J+1)*T*4|0}}function Xn(n,m,T){let k=3,R=m*T*4|0;while(k<R){if(n[k]!==255)return!0;k=k+4|0}return!1}function Vn(n,m,T){let k=3,R=m*T*4|0;while(k<R)n[k]=255,k=k+4|0}function Dn(n,m,T,k,R,C,I,M,y,D){let U=d(m,T,R,I,y),q=d(m,k,C,M,D),B=new Uint8Array(R*C*4),A=new Uint16Array(R*k*4);if(Xn(n,T,k))Mn(n,A,T,k,R,U),yn(A,B,k,R,C,q);else In(n,A,T,k,R,U),Rn(A,B,k,R,C,q),Vn(B,R,C);return B}var Kn=En(Bn(),1);function Wn(n,m,T){let k=m*T,R=new Uint16Array(k),C,I,M,y;for(let D=0;D<k;D++)C=n[4*D],I=n[4*D+1],M=n[4*D+2],y=C>=I&&C>=M?C:I>=M&&I>=C?I:M,R[D]=y<<8;return R}function Qn(n,m,T,k,R,C){let I,M,y,D,U;if(k===0||R<0.5)return;if(R>2)R=2;let q=Wn(n,m,T),B=new Uint16Array(q);Kn.default(B,m,T,R);let A=k/100*4096+0.5|0,J=C<<8,$=m*T;for(let Q=0;Q<$;Q++)if(I=q[Q],D=I-B[Q],Math.abs(D)>=J)M=I+(A*D+2048>>12),M=M>65280?65280:M,M=M<0?0:M,I=I!==0?I:1,y=(M<<12)/I|0,U=Q*4,n[U]=n[U]*y+2048>>12,n[U+1]=n[U+1]*y+2048>>12,n[U+2]=n[U+2]*y+2048>>12}function Jn(n){let m=Dn(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)Qn(m,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return m}var Sn=`
var Kn=Object.create;var{getPrototypeOf:Jn,defineProperty:i,getOwnPropertyNames:$n}=Object;var sn=Object.prototype.hasOwnProperty;var wn=(n,k,a)=>{a=n!=null?Kn(Jn(n)):{};let m=k||!n||!n.__esModule?i(a,"default",{value:n,enumerable:!0}):a;for(let I of $n(n))if(!sn.call(m,I))i(m,I,{get:()=>n[I],enumerable:!0});return m};var Ln=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Bn=Ln((Dm,An)=>{var d,v,l,t,h,g,qn,Cn;function Xn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,a=Math.exp(-k),m=Math.exp(-2*k),I=(1-a)*(1-a)/(1+2*k*a-m);return d=I,v=I*(k-1)*a,l=I*(k+1)*a,t=-I*m,h=2*a,g=-m,qn=(d+v)/(1-h-g),Cn=(l+t)/(1-h-g),new Float32Array([d,v,l,t,h,g,qn,Cn])}function Un(n,k,a,m,I,D){var T,M,y,R,q,u,Q,C,B,o,A,K,U,J,s,Z,$,w,z,G,W,L,O,j,P,H,X,V,Y,N;for(P=0;P<D;P++){L=P*I,O=P,j=0,T=n[L],M=T&255,y=T>>8&255,R=T>>16&255,q=T>>24&255,w=M*m[6],z=y*m[6],G=R*m[6],W=q*m[6],J=w,s=z,Z=G,$=W,X=m[0],V=m[1],Y=m[4],N=m[5];for(H=0;H<I;H++)T=n[L],u=T&255,Q=T>>8&255,C=T>>16&255,B=T>>24&255,o=u*X+M*V+J*Y+w*N,A=Q*X+y*V+s*Y+z*N,K=C*X+R*V+Z*Y+G*N,U=B*X+q*V+$*Y+W*N,w=J,z=s,G=Z,W=$,J=o,s=A,Z=K,$=U,M=u,y=Q,R=C,q=B,a[j]=J,a[j+1]=s,a[j+2]=Z,a[j+3]=$,j+=4,L++;L--,j-=4,O+=D*(I-1),T=n[L],M=T&255,y=T>>8&255,R=T>>16&255,q=T>>24&255,w=M*m[7],z=y*m[7],G=R*m[7],W=q*m[7],J=w,s=z,Z=G,$=W,u=M,Q=y,C=R,B=q,X=m[2],V=m[3];for(H=I-1;H>=0;H--)o=u*X+M*V+J*Y+w*N,A=Q*X+y*V+s*Y+z*N,K=C*X+R*V+Z*Y+G*N,U=B*X+q*V+$*Y+W*N,w=J,z=s,G=Z,W=$,J=o,s=A,Z=K,$=U,M=u,y=Q,R=C,q=B,T=n[L],u=T&255,Q=T>>8&255,C=T>>16&255,B=T>>24&255,T=(a[j]+J<<0)+(a[j+1]+s<<8)+(a[j+2]+Z<<16)+(a[j+3]+$<<24),k[O]=T,L--,j-=4,O-=D}}function Vn(n,k,a,m){if(!m)return;var I=new Uint32Array(n.buffer),D=new Uint32Array(I.length),T=new Float32Array(Math.max(k,a)*4),M=Xn(m);Un(I,D,T,M,k,a,m),Un(D,I,T,M,a,k,m)}An.exports=Vn});var Zn=2;function f(n,k,a,m,I,D){let T=a/n,M=m/k,y=(2*D+Zn+1)/I;if(y>0.5)return[{toWidth:a,toHeight:m}];let R=Math.ceil(Math.log(Math.min(T,M))/Math.log(y));if(R<=1)return[{toWidth:a,toHeight:m}];let q=[];for(let u=0;u<R;u++){let Q=Math.round(Math.pow(Math.pow(n,R-u-1)*Math.pow(a,u+1),1/R)),C=Math.round(Math.pow(Math.pow(k,R-u-1)*Math.pow(m,u+1),1/R));q.push({toWidth:Q,toHeight:C})}return q}var E=4;function c(n,k,a){let m=new Uint8ClampedArray(a.width*a.height*E);for(let I=0;I<a.height;I++){let D=((a.y+I)*k+a.x)*E,T=I*a.width*E;m.set(n.subarray(D,D+a.width*E),T)}return m}var _=0.00001;function F(n){let k=Math.round(n);if(Math.abs(n-k)<_)return k;return Math.floor(n)}function e(n){let k=Math.round(n);if(Math.abs(n-k)<_)return k;return Math.ceil(n)}function r(n,k,a,m,I,D,T,M,y,R,q){let u=m/k,Q=I/a,C=F(D*u)-2*T,B=F(D*Q)-2*T;if(C<1||B<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let o,A,K,U,J,s,Z=[];for(U=0;U<I;U+=B)for(K=0;K<m;K+=C){if(o=K-T,o<0)o=0;if(J=K+C+T-o,o+J>=m)J=m-o;if(A=U-T,A<0)A=0;if(s=U+B+T-A,A+s>=I)s=I-A;let $={toX:o,toY:A,toWidth:J,toHeight:s,toInnerX:K,toInnerY:U,toInnerWidth:C,toInnerHeight:B,offsetX:o/u-F(o/u),offsetY:A/Q-F(A/Q),scaleX:u,scaleY:Q,x:F(o/u),y:F(A/Q),width:e(J/u),height:e(s/Q),initialSize:D,filterPadding:T,filter:M,unsharpAmount:y,unsharpRadius:R,unsharpThreshold:q},w=c(n,k,$);Z.push({tile:w.buffer,...$})}return Z}async function nn(n){let k,a,m,I,D,T;if(n.image instanceof Blob){let y=await createImageBitmap(n.image),q=new OffscreenCanvas(y.width,y.height).getContext("2d");if(!q)throw new Error("Canvas 2D context not supported");q.drawImage(y,0,0),k=q.getImageData(0,0,y.width,y.height).data,a=y.width,m=y.height,y.close();let Q=n.maxDimension/a,C=n.maxDimension/m,B=Math.min(Q,C,1),o=Math.floor(a*B),A=Math.floor(m*B);T=f(a,m,o,A,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,a=n.image.fromWidth,m=n.image.fromHeight,T=n.image.stages;I=T[0].toWidth,D=T[0].toHeight;let M=r(k,a,m,I,D,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);return{from:k.buffer,fromWidth:a,fromHeight:m,tileTransforms:M,stages:T}}function mn(n,k,a){let m=new Uint8ClampedArray(a.tile);for(let I=0;I<a.toHeight;I++){let D=I*a.toWidth*E,T=((a.toY+I)*k+a.toX)*E;n.set(m.subarray(D,D+a.toWidth*E),T)}}var jn="<WORKER_CODE>",Gn=new Blob([jn],{type:"application/javascript"});var kn=(()=>{let n=0;return()=>++n})();class an{#m;#T;#k;#a;constructor(){this.#m=new Map,this.#T=new Map,this.#k=new Map,this.#a=new Map}get count(){return this.#m.size}#I(n){clearTimeout(this.#T.get(n))}#n(n,k,a,m){this.#m.set(n,k.id),this.#k.set(k.id,n),this.#a.set(k.id,k),n.postMessage(a,m),this.#I(n)}assignPriority1Task(n,k){let a={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions};this.#n(n,k,a,[])}assignPriority2Task(n,k){let a={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};this.#n(n,k,a,[a.tileTransform.tile])}setWorkerTimeout(n,k){let a=setTimeout(()=>{let m=this.#m.get(n);if(m)this.#k.delete(m);if(m)this.#a.delete(m);this.#T.delete(n),this.#m.delete(n),n.terminate()},k);this.#T.set(n,a)}addWorker(n){this.#m.set(n,null)}getWorker(n){return this.#k.get(n)}getTask(n){return this.#a.get(n)}getAvailableWorker(){for(let[n,k]of this.#m.entries())if(k===null)return n;return null}removeTask(n){let k=this.#k.get(n);if(k)this.#m.set(k,null);this.#k.delete(n),this.#a.delete(n)}}class On{#m;#T;#k;#a;#I;#n;constructor(n,k){this.#T=n,this.#m=k,this.#k=new Map,this.#a=[],this.#I=[],this.#n=new an}#R(){let n=URL.createObjectURL(Gn),k=new Worker(n);URL.revokeObjectURL(n),k.onmessage=(a)=>{let m=this.#k.get(a.data.squishId);if(!m)throw new Error("SquishContext not found");if(a.data.error)m.reject(a.data.error);if(a.data.taskType===0){let{squishId:D,output:T}=a.data,M=T.stages[0].toWidth,y=T.stages[0].toHeight;m.from=new Uint8ClampedArray(T.from),m.fromWidth=T.fromWidth,m.fromHeight=T.fromHeight,m.to=new Uint8ClampedArray(M*y*E),m.toWidth=M,m.toHeight=y,m.stages=T.stages,m.remainingTileCount=T.tileTransforms.length;for(let R of T.tileTransforms)this.#I.push({id:kn(),squishId:D,data:{tileTransform:R}}),this.#M()}if(a.data.taskType===1){let{taskId:D,squishId:T,output:M}=a.data;if(!m.to)throw new Error("SquishContext to not found");if(mn(m.to,m.toWidth,M.tileTransform),m.remainingTileCount--,!m.remainingTileCount)if(m.stages.shift(),m.stages[0])this.#a.push({id:D,squishId:T,data:{image:{from:m.to,fromWidth:m.toWidth,fromHeight:m.toHeight,stages:m.stages},maxDimension:m.maxDimension,tileOptions:m.tileOptions}});else{let y=new ImageData(m.to,m.toWidth,m.toHeight);createImageBitmap(y).then((R)=>{this.#k.delete(a.data.squishId),m.resolve(R)})}}let I=this.#n.getWorker(a.data.taskId);if(I)this.#n.setWorkerTimeout(I,this.#m);this.#n.removeTask(a.data.taskId),this.#M()},this.#n.addWorker(k)}#M(){let n=this.#n.getAvailableWorker();if(n){let k=this.#a.shift();if(k)return this.#n.assignPriority1Task(n,k);let a=this.#I.shift();if(a)return this.#n.assignPriority2Task(n,a)}else if(this.#n.count<this.#T)this.#R(),this.#M()}add(n){return new Promise((k,a)=>{let m=kn();this.#k.set(m,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:k,reject:a}),this.#a.push({id:m,squishId:m,data:n}),this.#M()})}}var p={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var zn=14;function Tn(n){return Math.round(n*((1<<zn)-1))}function x(n,k,a,m,I){let D=p[n].fn,T=1/m,M=Math.min(1,m),y=p[n].win/M,R,q,u,Q,C,B,o,A,K,U,J,s,Z,$,w,z,G,W=Math.floor((y+1)*2),L=new Int16Array((W+2)*a),O=0,j=!L.subarray||!L.set;for(R=0;R<a;R++){q=(R+0.5)*T+I,u=Math.max(0,Math.floor(q-y)),Q=Math.min(k-1,Math.ceil(q+y)),C=Q-u+1,B=new Float32Array(C),o=new Int16Array(C),A=0;for(K=u,U=0;K<=Q;K++,U++)J=D((K+0.5-q)*M),A+=J,B[U]=J;s=0;for(U=0;U<B.length;U++)Z=B[U]/A,s+=Z,o[U]=Tn(Z);o[a>>1]+=Tn(1-s),$=0;while($<o.length&&o[$]===0)$++;if($<o.length){w=o.length-1;while(w>0&&o[w]===0)w--;if(z=u+$,G=w-$+1,L[O++]=z,L[O++]=G,!j)L.set(o.subarray($,w+1),O),O+=G;else for(U=$;U<=w;U++)L[O++]=o[U]}else L[O++]=0,L[O++]=0}return L}function S(n){return n<0?0:n>255?255:n}function b(n){return n>=0?n:0}function In(n,k,a,m,I,D){let T,M,y,R,q,u,Q,C,B,o,A,K=0,U=0;for(B=0;B<m;B++){q=0;for(o=0;o<I;o++){u=D[q++],Q=D[q++],C=K+u*4|0,T=M=y=R=0;for(;Q>0;Q--)A=D[q++],R=R+A*n[C+3]|0,y=y+A*n[C+2]|0,M=M+A*n[C+1]|0,T=T+A*n[C]|0,C=C+4|0;k[U+3]=b(R>>7),k[U+2]=b(y>>7),k[U+1]=b(M>>7),k[U]=b(T>>7),U=U+m*4|0}U=(B+1)*4|0,K=(B+1)*a*4|0}}function Mn(n,k,a,m,I,D){let T,M,y,R,q,u,Q,C,B,o,A,K=0,U=0;for(B=0;B<m;B++){q=0;for(o=0;o<I;o++){u=D[q++],Q=D[q++],C=K+u*4|0,T=M=y=R=0;for(;Q>0;Q--)A=D[q++],R=R+A*n[C+3]|0,y=y+A*n[C+2]|0,M=M+A*n[C+1]|0,T=T+A*n[C]|0,C=C+4|0;T>>=7,M>>=7,y>>=7,R>>=7,k[U+3]=S(R+8192>>14),k[U+2]=S(y+8192>>14),k[U+1]=S(M+8192>>14),k[U]=S(T+8192>>14),U=U+m*4|0}U=(B+1)*4|0,K=(B+1)*a*4|0}}function Rn(n,k,a,m,I,D){let T,M,y,R,q,u,Q,C,B,o,A,K,U=0,J=0;for(o=0;o<m;o++){u=0;for(A=0;A<I;A++){Q=D[u++],C=D[u++],B=U+Q*4|0,T=M=y=R=0;for(;C>0;C--)K=D[u++],q=n[B+3],R=R+K*q|0,y=y+K*n[B+2]*q|0,M=M+K*n[B+1]*q|0,T=T+K*n[B]*q|0,B=B+4|0;y=y/255|0,M=M/255|0,T=T/255|0,k[J+3]=b(R>>7),k[J+2]=b(y>>7),k[J+1]=b(M>>7),k[J]=b(T>>7),J=J+m*4|0}J=(o+1)*4|0,U=(o+1)*a*4|0}}function yn(n,k,a,m,I,D){let T,M,y,R,q,u,Q,C,B,o,A,K=0,U=0;for(B=0;B<m;B++){q=0;for(o=0;o<I;o++){u=D[q++],Q=D[q++],C=K+u*4|0,T=M=y=R=0;for(;Q>0;Q--)A=D[q++],R=R+A*n[C+3]|0,y=y+A*n[C+2]|0,M=M+A*n[C+1]|0,T=T+A*n[C]|0,C=C+4|0;if(T>>=7,M>>=7,y>>=7,R>>=7,R=S(R+8192>>14),R>0)T=T*255/R|0,M=M*255/R|0,y=y*255/R|0;k[U+3]=R,k[U+2]=S(y+8192>>14),k[U+1]=S(M+8192>>14),k[U]=S(T+8192>>14),U=U+m*4|0}U=(B+1)*4|0,K=(B+1)*a*4|0}}function En(n,k,a){let m=3,I=k*a*4|0;while(m<I){if(n[m]!==255)return!0;m=m+4|0}return!1}function Wn(n,k,a){let m=3,I=k*a*4|0;while(m<I)n[m]=255,m=m+4|0}function Dn(n,k,a,m,I,D,T,M,y,R){let q=x(k,a,I,T,y),u=x(k,m,D,M,R),Q=new Uint8Array(I*D*4),C=new Uint16Array(I*m*4);if(En(n,a,m))Rn(n,C,a,m,I,q),yn(C,Q,m,I,D,u);else In(n,C,a,m,I,q),Mn(C,Q,m,I,D,u),Wn(Q,I,D);return Q}var on=wn(Bn(),1);function Yn(n,k,a){let m=k*a,I=new Uint16Array(m),D,T,M,y;for(let R=0;R<m;R++)D=n[4*R],T=n[4*R+1],M=n[4*R+2],y=D>=T&&D>=M?D:T>=M&&T>=D?T:M,I[R]=y<<8;return I}function un(n,k,a,m,I,D){let T,M,y,R,q;if(m===0||I<0.5)return;if(I>2)I=2;let u=Yn(n,k,a),Q=new Uint16Array(u);on.default(Q,k,a,I);let C=m/100*4096+0.5|0,B=D<<8,o=k*a;for(let A=0;A<o;A++)if(T=u[A],R=T-Q[A],Math.abs(R)>=B)M=T+(C*R+2048>>12),M=M>65280?65280:M,M=M<0?0:M,T=T!==0?T:1,y=(M<<12)/T|0,q=A*4,n[q]=n[q]*y+2048>>12,n[q+1]=n[q+1]*y+2048>>12,n[q+2]=n[q+2]*y+2048>>12}function Qn(n){let k=Dn(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)un(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}self.onmessage=async(n)=>{let{taskId:k,squishId:a,taskType:m}=n.data;try{if(m===0){let{image:I,maxDimension:D,tileOptions:T}=n.data,M=await nn({image:I,maxDimension:D,tileOptions:T}),y={taskId:k,squishId:a,taskType:m,output:{from:M.from,fromWidth:M.fromWidth,fromHeight:M.fromHeight,tileTransforms:M.tileTransforms,stages:M.stages}},R=M.tileTransforms.map((q)=>q.tile);self.postMessage(y,[M.from,...R])}if(m===1){let{tileTransform:I}=n.data;I.tile=Qn(I).buffer;let D={taskId:k,squishId:a,taskType:m,output:{tileTransform:I}};self.postMessage(D,[I.tile])}}catch(I){self.postMessage({taskId:k,squishId:a,taskType:m,error:I})}};
`,Fn=new Blob([Sn],{type:"application/javascript"});var $n=(()=>{let n=0;return()=>++n})();class Zn{#n;#T;#k;#I;constructor(){this.#n=new Map,this.#T=new Map,this.#k=new Map,this.#I=new Map}get count(){return this.#n.size}#R(n){clearTimeout(this.#T.get(n))}#m(n,m,T,k){this.#n.set(n,m.id),this.#k.set(m.id,n),this.#I.set(m.id,m),n.postMessage(T,k),this.#R(n)}assignPriority1Task(n,m){let T={taskId:m.id,squishId:m.squishId,taskType:0,image:m.data.image,maxDimension:m.data.maxDimension,tileOptions:m.data.tileOptions};this.#m(n,m,T,[])}assignPriority2Task(n,m){let T={taskId:m.id,squishId:m.squishId,taskType:1,tileTransform:m.data.tileTransform};this.#m(n,m,T,[T.tileTransform.tile])}setWorkerTimeout(n,m){let T=setTimeout(()=>{let k=this.#n.get(n);if(k)this.#k.delete(k);if(k)this.#I.delete(k);this.#T.delete(n),this.#n.delete(n),n.terminate()},m);this.#T.set(n,T)}addWorker(n){this.#n.set(n,null)}getWorker(n){return this.#k.get(n)}getTask(n){return this.#I.get(n)}getAvailableWorker(){for(let[n,m]of this.#n.entries())if(m===null)return n;return null}removeTask(n){let m=this.#k.get(n);if(m)this.#n.set(m,null);this.#k.delete(n),this.#I.delete(n)}}class i{#n;#T;#k;#I;#R;#m;constructor(n,m){this.#T=n,this.#n=m,this.#k=new Map,this.#I=[],this.#R=[],this.#m=new Zn}#y(){let n=URL.createObjectURL(Fn),m=new Worker(n);URL.revokeObjectURL(n),m.onmessage=(T)=>{let k=this.#k.get(T.data.squishId);if(!k)throw new Error("SquishContext not found");if(T.data.error)k.reject(T.data.error);if(T.data.taskType===0){let{squishId:C,output:I}=T.data,M=I.stages[0].toWidth,y=I.stages[0].toHeight;k.from=new Uint8ClampedArray(I.from),k.fromWidth=I.fromWidth,k.fromHeight=I.fromHeight,k.to=new Uint8ClampedArray(M*y*O),k.toWidth=M,k.toHeight=y,k.stages=I.stages,k.remainingTileCount=I.tileTransforms.length;for(let D of I.tileTransforms)this.#R.push({id:$n(),squishId:C,data:{tileTransform:D}}),this.#M()}if(T.data.taskType===1){let{taskId:C,squishId:I,output:M}=T.data;if(!k.to)throw new Error("SquishContext to not found");if(x(k.to,k.toWidth,M.tileTransform),k.remainingTileCount--,!k.remainingTileCount)if(k.stages.shift(),k.stages[0])this.#I.push({id:C,squishId:I,data:{image:{from:k.to,fromWidth:k.toWidth,fromHeight:k.toHeight,stages:k.stages},maxDimension:k.maxDimension,tileOptions:k.tileOptions}});else{let y=new ImageData(k.to,k.toWidth,k.toHeight);createImageBitmap(y).then((D)=>{this.#k.delete(T.data.squishId),k.resolve(D)})}}let R=this.#m.getWorker(T.data.taskId);if(R)this.#m.setWorkerTimeout(R,this.#n);this.#m.removeTask(T.data.taskId),this.#M()},this.#m.addWorker(m)}#M(){let n=this.#m.getAvailableWorker();if(n){let m=this.#I.shift();if(m)return this.#m.assignPriority1Task(n,m);let T=this.#R.shift();if(T)return this.#m.assignPriority2Task(n,T)}else if(this.#m.count<this.#T)this.#y(),this.#M()}add(n){return new Promise((m,T)=>{let k=$n();this.#k.set(k,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:m,reject:T}),this.#I.push({id:k,squishId:k,data:n}),this.#M()})}}class Hn{#n;#T;constructor(n){let m=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,T=n.maxWorkerPoolSize||Math.min(m,4),k=n.maxWorkerIdleTime||2000;this.#n=new i(T,k),this.#T=n}async#k(n,m,T){let k=null,R,C,I,M,y,D;for(;;){let q=await mn({image:k||n,maxDimension:m,tileOptions:T});R=new Uint8ClampedArray(q.from),C=q.fromWidth,I=q.fromHeight,y=q.stages[0].toWidth,D=q.stages[0].toHeight,M=new Uint8ClampedArray(y*D*O);for(let B of q.tileTransforms)B.tile=Jn(B).buffer,x(M,y,B);if(q.stages.shift(),k={from:M,fromWidth:y,fromHeight:D,stages:q.stages},!q.stages[0])break}let U=new ImageData(k.from,k.fromWidth,k.fromHeight);return await createImageBitmap(U)}async squish(n,m){let T=m?{...this.#T,...m}:this.#T,k=T.maxDimension,R=T.tileSize||1024,C=T.filter||"mks2013",I=T.unsharpAmount||0,M=T.unsharpRadius||0,y=T.unsharpThreshold||0,D=T.useMainThread,U=3,q=Math.ceil(Math.max(3,2.5*M|0)),B={initialSize:R,filterPadding:q,filter:C,unsharpAmount:I,unsharpRadius:M,unsharpThreshold:y};if(D)return await this.#k(n,k,B);return this.#n.add({image:n,maxDimension:k,tileOptions:B})}}export{Hn as PicSquish};
