var N8=Object.create;var{getPrototypeOf:X8,defineProperty:d,getOwnPropertyNames:Y8}=Object;var E8=Object.prototype.hasOwnProperty;var z8=(U,A,D)=>{D=U!=null?N8(X8(U)):{};let J=A||!U||!U.__esModule?d(D,"default",{value:U,enumerable:!0}):D;for(let $ of Y8(U))if(!E8.call(J,$))d(J,$,{get:()=>U[$],enumerable:!0});return J};var I8=(U,A)=>()=>(A||U((A={exports:{}}).exports,A),A.exports);var Z8=I8((G1,G8)=>{var x,g,m,n,v,w,J8,K8;function T8(U){if(U<0.5)U=0.5;var A=Math.exp(0.527076)/U,D=Math.exp(-A),J=Math.exp(-2*A),$=(1-D)*(1-D)/(1+2*A*D-J);return x=$,g=$*(A-1)*D,m=$*(A+1)*D,n=-$*J,v=2*D,w=-J,J8=(x+g)/(1-v-w),K8=(m+n)/(1-v-w),new Float32Array([x,g,m,n,v,w,J8,K8])}function $8(U,A,D,J,$,B){var K,G,R,Z,L,b,V,j,Q,q,y,N,M,X;for(Q=0;Q<B;Q++){b=Q*$,V=Q,j=0,K=U[b],L=K*J[6],Z=L,y=J[0],N=J[1],M=J[4],X=J[5];for(q=0;q<$;q++)G=U[b],R=G*y+K*N+Z*M+L*X,L=Z,Z=R,K=G,D[j]=Z,j++,b++;b--,j--,V+=B*($-1),K=U[b],L=K*J[7],Z=L,G=K,y=J[2],N=J[3];for(q=$-1;q>=0;q--)R=G*y+K*N+Z*M+L*X,L=Z,Z=R,K=G,G=U[b],A[V]=D[j]+Z,b--,j--,V-=B}}function k8(U,A,D,J){if(!J)return;var $=new Uint16Array(U.length),B=new Float32Array(Math.max(A,D)),K=T8(J);$8(U,$,B,K,A,D,J),$8($,U,B,K,D,A,J)}G8.exports=k8});var E=4;function c(U,A,D){let J=new Uint8ClampedArray(D.tile);for(let $=0;$<D.toHeight;$++){let B=$*D.toWidth*E,K=((D.toY+$)*A+D.toX)*E;U.set(J.subarray(B,B+D.toWidth*E),K)}}var O8=`
var $k=Object.create;var{getPrototypeOf:Ak,defineProperty:m,getOwnPropertyNames:Gk}=Object;var Qk=Object.prototype.hasOwnProperty;var Zk=(k,M,R)=>{R=k!=null?$k(Ak(k)):{};let I=M||!k||!k.__esModule?m(R,"default",{value:k,enumerable:!0}):R;for(let y of Gk(k))if(!Qk.call(I,y))m(I,y,{get:()=>k[y],enumerable:!0});return I};var jk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Rk=jk((sk,Ik)=>{var _,n,x,g,T,H,t,kk;function Yk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,R=Math.exp(-M),I=Math.exp(-2*M),y=(1-R)*(1-R)/(1+2*M*R-I);return _=y,n=y*(M-1)*R,x=y*(M+1)*R,g=-y*I,T=2*R,H=-I,t=(_+n)/(1-T-H),kk=(x+g)/(1-T-H),new Float32Array([_,n,x,g,T,H,t,kk])}function Mk(k,M,R,I,y,K){var q,D,u,U,$,Z,B,J,G,j,Q,L,A,b;for(G=0;G<K;G++){Z=G*y,B=G,J=0,q=k[Z],$=q*I[6],U=$,Q=I[0],L=I[1],A=I[4],b=I[5];for(j=0;j<y;j++)D=k[Z],u=D*Q+q*L+U*A+$*b,$=U,U=u,q=D,R[J]=U,J++,Z++;Z--,J--,B+=K*(y-1),q=k[Z],$=q*I[7],U=$,D=q,Q=I[2],L=I[3];for(j=y-1;j>=0;j--)u=D*Q+q*L+U*A+$*b,$=U,U=u,q=D,D=k[Z],M[B]=R[J]+U,Z--,J--,B-=K}}function Ek(k,M,R,I){if(!I)return;var y=new Uint16Array(k.length),K=new Float32Array(Math.max(M,R)),q=Yk(I);Mk(k,y,K,q,M,R,I),Mk(y,k,K,q,R,M,I)}Ik.exports=Ek});var S=4;var Bk=2;function a(k,M,R,I,y,K){let q=R/k,D=I/M,u=(2*K+Bk+1)/y;if(u>0.5)return[{toWidth:R,toHeight:I}];let U=Math.ceil(Math.log(Math.min(q,D))/Math.log(u));if(U<=1)return[{toWidth:R,toHeight:I}];let $=[];for(let Z=0;Z<U;Z++){let B=Math.round(Math.pow(Math.pow(k,U-Z-1)*Math.pow(R,Z+1),1/U)),J=Math.round(Math.pow(Math.pow(M,U-Z-1)*Math.pow(I,Z+1),1/U));$.push({toWidth:B,toHeight:J})}return $}function Lk(k,M){if(k)k.width=k.height=0;k=M=null}function bk(k,M){let R=new OffscreenCanvas(M.width,M.height),I=R.getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");I.globalCompositeOperation="copy",I.drawImage(k,M.x,M.y,M.width,M.height,0,0,M.width,M.height);let y=I.getImageData(0,0,M.width,M.height).data.buffer;return Lk(R,I),y}function Ck(k,M,R){let I=new Uint8ClampedArray(R.width*R.height*S);for(let y=0;y<R.height;y++){let K=((R.y+y)*M+R.x)*S,q=y*R.width*S;I.set(k.subarray(K,K+R.width*S),q)}return I.buffer}function h(k,M,R){if(k instanceof ImageBitmap)return bk(k,R);else return Ck(k,M,R)}var o=0.00001;function O(k){let M=Math.round(k);if(Math.abs(k-M)<o)return M;return Math.floor(k)}function d(k){let M=Math.round(k);if(Math.abs(k-M)<o)return M;return Math.ceil(k)}function P(k,M,R,I,y,K){let{initialSize:q,filterPadding:D,filter:u,unsharpAmount:U,unsharpRadius:$,unsharpThreshold:Z}=K,B=I/M,J=y/R,G=O(q*B)-2*D,j=O(q*J)-2*D;if(G<1||j<1)throw new Error("Picsquish error: target tile width/height is too small");let Q,L,A,b,z,N,C=[];for(b=0;b<y;b+=j)for(A=0;A<I;A+=G){if(Q=A-D,Q<0)Q=0;if(z=A+G+D-Q,Q+z>=I)z=I-Q;if(L=b-D,L<0)L=0;if(N=b+j+D-L,L+N>=y)N=y-L;let V={toX:Q,toY:L,toWidth:z,toHeight:N,toInnerX:A,toInnerY:b,toInnerWidth:G,toInnerHeight:j,offsetX:Q/B-O(Q/B),offsetY:L/J-O(L/J),scaleX:B,scaleY:J,x:O(Q/B),y:O(L/J),width:d(z/B),height:d(N/J),initialSize:q,filterPadding:D,filter:u,unsharpAmount:U,unsharpRadius:$,unsharpThreshold:Z},F=h(k,M,V);C.push({tile:F,...V})}return C}async function Vk(k,M,R){let I=k instanceof ImageBitmap?k:await createImageBitmap(k),y=[];for(let K of R){let q=I,D=I.width,u=I.height,U=K/D,$=K/u,Z=Math.min(U,$,1),B=Math.floor(D*Z),J=Math.floor(u*Z),G=a(D,u,B,J,M.initialSize,M.filterPadding),j=P(q,D,u,G[0].toWidth,G[0].toHeight,M);y.push({stages:G,tileTransforms:j})}return I.close(),y}function zk(k,M){let R=P(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,M);return[{stages:k.stages,tileTransforms:R}]}async function c(k){if(k.image instanceof Blob||k.image instanceof ImageBitmap)return Vk(k.image,k.tileOptions,k.dimensionLimits);else return zk(k.image,k.tileOptions)}var p={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Nk=14;function s(k){return Math.round(k*((1<<Nk)-1))}function v(k,M,R,I,y){let K=p[k].fn,q=1/I,D=Math.min(1,I),u=p[k].win/D,U,$,Z,B,J,G,j,Q,L,A,b,z,N,C,V,F,W,Jk=Math.floor((u+1)*2),w=new Int16Array((Jk+2)*R),E=0,Kk=!w.subarray||!w.set;for(U=0;U<R;U++){$=(U+0.5)*q+y,Z=Math.max(0,Math.floor($-u)),B=Math.min(M-1,Math.ceil($+u)),J=B-Z+1,G=new Float32Array(J),j=new Int16Array(J),Q=0;for(L=Z,A=0;L<=B;L++,A++)b=K((L+0.5-$)*D),Q+=b,G[A]=b;z=0;for(A=0;A<G.length;A++)N=G[A]/Q,z+=N,j[A]=s(N);j[R>>1]+=s(1-z),C=0;while(C<j.length&&j[C]===0)C++;if(C<j.length){V=j.length-1;while(V>0&&j[V]===0)V--;if(F=Z+C,W=V-C+1,w[E++]=F,w[E++]=W,!Kk)w.set(j.subarray(C,V+1),E),E+=W;else for(A=C;A<=V;A++)w[E++]=j[A]}else w[E++]=0,w[E++]=0}return w}function X(k){return k<0?0:k>255?255:k}function Y(k){return k>=0?k:0}function f(k,M,R,I,y,K){let q,D,u,U,$,Z,B,J,G,j,Q,L=0,A=0;for(G=0;G<I;G++){$=0;for(j=0;j<y;j++){Z=K[$++],B=K[$++],J=L+Z*4|0,q=D=u=U=0;for(;B>0;B--)Q=K[$++],U=U+Q*k[J+3]|0,u=u+Q*k[J+2]|0,D=D+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;M[A+3]=Y(U>>7),M[A+2]=Y(u>>7),M[A+1]=Y(D>>7),M[A]=Y(q>>7),A=A+I*4|0}A=(G+1)*4|0,L=(G+1)*R*4|0}}function l(k,M,R,I,y,K){let q,D,u,U,$,Z,B,J,G,j,Q,L=0,A=0;for(G=0;G<I;G++){$=0;for(j=0;j<y;j++){Z=K[$++],B=K[$++],J=L+Z*4|0,q=D=u=U=0;for(;B>0;B--)Q=K[$++],U=U+Q*k[J+3]|0,u=u+Q*k[J+2]|0,D=D+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;q>>=7,D>>=7,u>>=7,U>>=7,M[A+3]=X(U+8192>>14),M[A+2]=X(u+8192>>14),M[A+1]=X(D+8192>>14),M[A]=X(q+8192>>14),A=A+I*4|0}A=(G+1)*4|0,L=(G+1)*R*4|0}}function r(k,M,R,I,y,K){let q,D,u,U,$,Z,B,J,G,j,Q,L,A=0,b=0;for(j=0;j<I;j++){Z=0;for(Q=0;Q<y;Q++){B=K[Z++],J=K[Z++],G=A+B*4|0,q=D=u=U=0;for(;J>0;J--)L=K[Z++],$=k[G+3],U=U+L*$|0,u=u+L*k[G+2]*$|0,D=D+L*k[G+1]*$|0,q=q+L*k[G]*$|0,G=G+4|0;u=u/255|0,D=D/255|0,q=q/255|0,M[b+3]=Y(U>>7),M[b+2]=Y(u>>7),M[b+1]=Y(D>>7),M[b]=Y(q>>7),b=b+I*4|0}b=(j+1)*4|0,A=(j+1)*R*4|0}}function e(k,M,R,I,y,K){let q,D,u,U,$,Z,B,J,G,j,Q,L=0,A=0;for(G=0;G<I;G++){$=0;for(j=0;j<y;j++){Z=K[$++],B=K[$++],J=L+Z*4|0,q=D=u=U=0;for(;B>0;B--)Q=K[$++],U=U+Q*k[J+3]|0,u=u+Q*k[J+2]|0,D=D+Q*k[J+1]|0,q=q+Q*k[J]|0,J=J+4|0;if(q>>=7,D>>=7,u>>=7,U>>=7,U=X(U+8192>>14),U>0)q=q*255/U|0,D=D*255/U|0,u=u*255/U|0;M[A+3]=U,M[A+2]=X(u+8192>>14),M[A+1]=X(D+8192>>14),M[A]=X(q+8192>>14),A=A+I*4|0}A=(G+1)*4|0,L=(G+1)*R*4|0}}function wk(k,M,R){let I=3,y=M*R*4|0;while(I<y){if(k[I]!==255)return!0;I=I+4|0}return!1}function Xk(k,M,R){let I=3,y=M*R*4|0;while(I<y)k[I]=255,I=I+4|0}function i(k,M,R,I,y,K,q,D,u,U){let $=v(M,R,y,q,u),Z=v(M,I,K,D,U),B=new Uint8Array(y*K*4),J=new Uint16Array(y*I*4);if(wk(k,R,I))r(k,J,R,I,y,$),e(J,B,I,y,K,Z);else f(k,J,R,I,y,$),l(J,B,I,y,K,Z),Xk(B,y,K);return B}var qk=Zk(Rk(),1);function Ok(k,M,R){let I=M*R,y=new Uint16Array(I),K,q,D,u;for(let U=0;U<I;U++)K=k[4*U],q=k[4*U+1],D=k[4*U+2],u=K>=q&&K>=D?K:q>=D&&q>=K?q:D,y[U]=u<<8;return y}function yk(k,M,R,I,y,K){let q,D,u,U,$;if(I===0||y<0.5)return;if(y>2)y=2;let Z=Ok(k,M,R),B=new Uint16Array(Z);qk.default(B,M,R,y);let J=I/100*4096+0.5|0,G=K<<8,j=M*R;for(let Q=0;Q<j;Q++)if(q=Z[Q],U=q-B[Q],Math.abs(U)>=G)D=q+(J*U+2048>>12),D=D>65280?65280:D,D=D<0?0:D,q=q!==0?q:1,u=(D<<12)/q|0,$=Q*4,k[$]=k[$]*u+2048>>12,k[$+1]=k[$+1]*u+2048>>12,k[$+2]=k[$+2]*u+2048>>12}function Dk(k){let M=i(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)yk(M,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return M}async function Uk(k){let{taskId:M,squishId:R,taskType:I,data:y}=k,{image:K,dimensionLimits:q,tileOptions:D}=y,u=await c({image:K,dimensionLimits:q,tileOptions:D});return{taskId:M,squishId:R,taskType:I,output:u}}function uk(k){let{taskId:M,squishId:R,workspaceIndex:I,taskType:y,data:K}=k,{tileTransform:q}=K;return q.tile=Dk(q).buffer,{taskId:M,squishId:R,workspaceIndex:I,taskType:y,output:{tileTransform:q}}}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let M=k.data;try{let R=await Uk(M),I=R.output.flatMap((y)=>y.tileTransforms.map((K)=>K.tile));return self.postMessage(R,I)}catch(R){return self.postMessage({taskId:M.taskId,squishId:M.squishId,taskType:M.taskType,error:R})}}case 1:{let M=k.data;try{let R=uk(M),I=R.output.tileTransform.tile;return self.postMessage(R,[I])}catch(R){return self.postMessage({taskId:M.taskId,squishId:M.squishId,workspaceIndex:M.workspaceIndex,taskType:M.taskType,error:R})}}}};
`,C8=new Blob([O8],{type:"application/javascript"});class f{#U;#D;#A;#J;constructor(){this.#U=new Map,this.#D=new Map,this.#A=null,this.#J=null}#K(){if(this.#A===null)return;clearTimeout(this.#A),this.#A=null}prepare(U,A,D){if(this.#U.size)return;this.#J=D;let J=URL.createObjectURL(C8);while(this.#U.size<A){let $=new Worker(J);$.onmessage=U,this.#U.set($,null)}URL.revokeObjectURL(J)}assignTask(U,A,D,J){this.#U.set(U,A),this.#D.set(A,U),this.#K(),U.postMessage(D,J)}setTimeout(){if(this.#A!==null)return;if(this.#U.size===0)return;this.#A=setTimeout(()=>{for(let U of this.#U.keys())U.terminate();this.#U.clear(),this.#D.clear()},this.#J||0)}getAvailableWorkers(){let U=[];for(let[A,D]of this.#U.entries())if(D===null)U.push(A);return U}removeTask(U){let A=this.#D.get(U);if(A)this.#U.set(A,null);this.#D.delete(U)}}var W=new f;var F8=2;function l(U,A,D,J,$,B){let K=D/U,G=J/A,R=(2*B+F8+1)/$;if(R>0.5)return[{toWidth:D,toHeight:J}];let Z=Math.ceil(Math.log(Math.min(K,G))/Math.log(R));if(Z<=1)return[{toWidth:D,toHeight:J}];let L=[];for(let b=0;b<Z;b++){let V=Math.round(Math.pow(Math.pow(U,Z-b-1)*Math.pow(D,b+1),1/Z)),j=Math.round(Math.pow(Math.pow(A,Z-b-1)*Math.pow(J,b+1),1/Z));L.push({toWidth:V,toHeight:j})}return L}function S8(U,A){if(U)U.width=U.height=0;U=A=null}function H8(U,A){let D=new OffscreenCanvas(A.width,A.height),J=D.getContext("2d");if(!J)throw new Error("Picsquish error: canvas 2D context not supported");J.globalCompositeOperation="copy",J.drawImage(U,A.x,A.y,A.width,A.height,0,0,A.width,A.height);let $=J.getImageData(0,0,A.width,A.height).data.buffer;return S8(D,J),$}function W8(U,A,D){let J=new Uint8ClampedArray(D.width*D.height*E);for(let $=0;$<D.height;$++){let B=((D.y+$)*A+D.x)*E,K=$*D.width*E;J.set(U.subarray(B,B+D.width*E),K)}return J.buffer}function a(U,A,D){if(U instanceof ImageBitmap)return H8(U,D);else return W8(U,A,D)}var s=0.00001;function P(U){let A=Math.round(U);if(Math.abs(U-A)<s)return A;return Math.floor(U)}function o(U){let A=Math.round(U);if(Math.abs(U-A)<s)return A;return Math.ceil(U)}function T(U,A,D,J,$,B){let{initialSize:K,filterPadding:G,filter:R,unsharpAmount:Z,unsharpRadius:L,unsharpThreshold:b}=B,V=J/A,j=$/D,Q=P(K*V)-2*G,q=P(K*j)-2*G;if(Q<1||q<1)throw new Error("Picsquish error: target tile width/height is too small");let y,N,M,X,I,O,Y=[];for(X=0;X<$;X+=q)for(M=0;M<J;M+=Q){if(y=M-G,y<0)y=0;if(I=M+Q+G-y,y+I>=J)I=J-y;if(N=X-G,N<0)N=0;if(O=X+q+G-N,N+O>=$)O=$-N;let z={toX:y,toY:N,toWidth:I,toHeight:O,toInnerX:M,toInnerY:X,toInnerWidth:Q,toInnerHeight:q,offsetX:y/V-P(y/V),offsetY:N/j-P(N/j),scaleX:V,scaleY:j,x:P(y/V),y:P(N/j),width:o(I/V),height:o(O/j),initialSize:K,filterPadding:G,filter:R,unsharpAmount:Z,unsharpRadius:L,unsharpThreshold:b},_=a(U,A,z);Y.push({tile:_,...z})}return Y}async function P8(U,A,D){let J=U instanceof ImageBitmap?U:await createImageBitmap(U),$=[];for(let B of D){let K=J,G=J.width,R=J.height,Z=B/G,L=B/R,b=Math.min(Z,L,1),V=Math.floor(G*b),j=Math.floor(R*b),Q=l(G,R,V,j,A.initialSize,A.filterPadding),q=T(K,G,R,Q[0].toWidth,Q[0].toHeight,A);$.push({stages:Q,tileTransforms:q})}return J.close(),$}function _8(U,A){let D=T(U.from,U.fromWidth,U.fromHeight,U.stages[0].toWidth,U.stages[0].toHeight,A);return[{stages:U.stages,tileTransforms:D}]}async function r(U){if(U.image instanceof Blob||U.image instanceof ImageBitmap)return P8(U.image,U.tileOptions,U.dimensionLimits);else return _8(U.image,U.tileOptions)}var k={box:{win:0.5,fn:(U)=>{if(U<0)U=-U;return U<0.5?1:0}},hamming:{win:1,fn:(U)=>{if(U<0)U=-U;if(U>=1)return 0;if(U<0.00000011920929)return 1;let A=U*Math.PI;return Math.sin(A)/A*(0.54+0.46*Math.cos(A/1))}},lanczos2:{win:2,fn:(U)=>{if(U<0)U=-U;if(U>=2)return 0;if(U<0.00000011920929)return 1;let A=U*Math.PI;return Math.sin(A)/A*Math.sin(A/2)/(A/2)}},lanczos3:{win:3,fn:(U)=>{if(U<0)U=-U;if(U>=3)return 0;if(U<0.00000011920929)return 1;let A=U*Math.PI;return Math.sin(A)/A*Math.sin(A/3)/(A/3)}},mks2013:{win:2.5,fn:(U)=>{if(U<0)U=-U;if(U>=2.5)return 0;if(U>=1.5)return-0.125*(U-2.5)*(U-2.5);if(U>=0.5)return 0.25*(4*U*U-11*U+7);return 1.0625-1.75*U*U}}};var v8=14;function i(U){return Math.round(U*((1<<v8)-1))}function p(U,A,D,J,$){let B=k[U].fn,K=1/J,G=Math.min(1,J),R=k[U].win/G,Z,L,b,V,j,Q,q,y,N,M,X,I,O,Y,z,_,u,q8=Math.floor((R+1)*2),C=new Int16Array((q8+2)*D),H=0,V8=!C.subarray||!C.set;for(Z=0;Z<D;Z++){L=(Z+0.5)*K+$,b=Math.max(0,Math.floor(L-R)),V=Math.min(A-1,Math.ceil(L+R)),j=V-b+1,Q=new Float32Array(j),q=new Int16Array(j),y=0;for(N=b,M=0;N<=V;N++,M++)X=B((N+0.5-L)*G),y+=X,Q[M]=X;I=0;for(M=0;M<Q.length;M++)O=Q[M]/y,I+=O,q[M]=i(O);q[D>>1]+=i(1-I),Y=0;while(Y<q.length&&q[Y]===0)Y++;if(Y<q.length){z=q.length-1;while(z>0&&q[z]===0)z--;if(_=b+Y,u=z-Y+1,C[H++]=_,C[H++]=u,!V8)C.set(q.subarray(Y,z+1),H),H+=u;else for(M=Y;M<=z;M++)C[H++]=q[M]}else C[H++]=0,C[H++]=0}return C}function F(U){return U<0?0:U>255?255:U}function S(U){return U>=0?U:0}function t(U,A,D,J,$,B){let K,G,R,Z,L,b,V,j,Q,q,y,N=0,M=0;for(Q=0;Q<J;Q++){L=0;for(q=0;q<$;q++){b=B[L++],V=B[L++],j=N+b*4|0,K=G=R=Z=0;for(;V>0;V--)y=B[L++],Z=Z+y*U[j+3]|0,R=R+y*U[j+2]|0,G=G+y*U[j+1]|0,K=K+y*U[j]|0,j=j+4|0;A[M+3]=S(Z>>7),A[M+2]=S(R>>7),A[M+1]=S(G>>7),A[M]=S(K>>7),M=M+J*4|0}M=(Q+1)*4|0,N=(Q+1)*D*4|0}}function e(U,A,D,J,$,B){let K,G,R,Z,L,b,V,j,Q,q,y,N=0,M=0;for(Q=0;Q<J;Q++){L=0;for(q=0;q<$;q++){b=B[L++],V=B[L++],j=N+b*4|0,K=G=R=Z=0;for(;V>0;V--)y=B[L++],Z=Z+y*U[j+3]|0,R=R+y*U[j+2]|0,G=G+y*U[j+1]|0,K=K+y*U[j]|0,j=j+4|0;K>>=7,G>>=7,R>>=7,Z>>=7,A[M+3]=F(Z+8192>>14),A[M+2]=F(R+8192>>14),A[M+1]=F(G+8192>>14),A[M]=F(K+8192>>14),M=M+J*4|0}M=(Q+1)*4|0,N=(Q+1)*D*4|0}}function U8(U,A,D,J,$,B){let K,G,R,Z,L,b,V,j,Q,q,y,N,M=0,X=0;for(q=0;q<J;q++){b=0;for(y=0;y<$;y++){V=B[b++],j=B[b++],Q=M+V*4|0,K=G=R=Z=0;for(;j>0;j--)N=B[b++],L=U[Q+3],Z=Z+N*L|0,R=R+N*U[Q+2]*L|0,G=G+N*U[Q+1]*L|0,K=K+N*U[Q]*L|0,Q=Q+4|0;R=R/255|0,G=G/255|0,K=K/255|0,A[X+3]=S(Z>>7),A[X+2]=S(R>>7),A[X+1]=S(G>>7),A[X]=S(K>>7),X=X+J*4|0}X=(q+1)*4|0,M=(q+1)*D*4|0}}function A8(U,A,D,J,$,B){let K,G,R,Z,L,b,V,j,Q,q,y,N=0,M=0;for(Q=0;Q<J;Q++){L=0;for(q=0;q<$;q++){b=B[L++],V=B[L++],j=N+b*4|0,K=G=R=Z=0;for(;V>0;V--)y=B[L++],Z=Z+y*U[j+3]|0,R=R+y*U[j+2]|0,G=G+y*U[j+1]|0,K=K+y*U[j]|0,j=j+4|0;if(K>>=7,G>>=7,R>>=7,Z>>=7,Z=F(Z+8192>>14),Z>0)K=K*255/Z|0,G=G*255/Z|0,R=R*255/Z|0;A[M+3]=Z,A[M+2]=F(R+8192>>14),A[M+1]=F(G+8192>>14),A[M]=F(K+8192>>14),M=M+J*4|0}M=(Q+1)*4|0,N=(Q+1)*D*4|0}}function w8(U,A,D){let J=3,$=A*D*4|0;while(J<$){if(U[J]!==255)return!0;J=J+4|0}return!1}function u8(U,A,D){let J=3,$=A*D*4|0;while(J<$)U[J]=255,J=J+4|0}function D8(U,A,D,J,$,B,K,G,R,Z){let L=p(A,D,$,K,R),b=p(A,J,B,G,Z),V=new Uint8Array($*B*4),j=new Uint16Array($*J*4);if(w8(U,D,J))U8(U,j,D,J,$,L),A8(j,V,J,$,B,b);else t(U,j,D,J,$,L),e(j,V,J,$,B,b),u8(V,$,B);return V}var B8=z8(Z8(),1);function p8(U,A,D){let J=A*D,$=new Uint16Array(J),B,K,G,R;for(let Z=0;Z<J;Z++)B=U[4*Z],K=U[4*Z+1],G=U[4*Z+2],R=B>=K&&B>=G?B:K>=G&&K>=B?K:G,$[Z]=R<<8;return $}function R8(U,A,D,J,$,B){let K,G,R,Z,L;if(J===0||$<0.5)return;if($>2)$=2;let b=p8(U,A,D),V=new Uint16Array(b);B8.default(V,A,D,$);let j=J/100*4096+0.5|0,Q=B<<8,q=A*D;for(let y=0;y<q;y++)if(K=b[y],Z=K-V[y],Math.abs(Z)>=Q)G=K+(j*Z+2048>>12),G=G>65280?65280:G,G=G<0?0:G,K=K!==0?K:1,R=(G<<12)/K|0,L=y*4,U[L]=U[L]*R+2048>>12,U[L+1]=U[L+1]*R+2048>>12,U[L+2]=U[L+2]*R+2048>>12}function j8(U){let A=D8(new Uint8ClampedArray(U.tile),U.filter,U.width,U.height,U.toWidth,U.toHeight,U.scaleX,U.scaleY,U.offsetX,U.offsetY);if(U.unsharpAmount)R8(A,U.toWidth,U.toHeight,U.unsharpAmount,U.unsharpRadius,U.unsharpThreshold);return A}async function L8(U){let{taskId:A,squishId:D,taskType:J,data:$}=U,{image:B,dimensionLimits:K,tileOptions:G}=$,R=await r({image:B,dimensionLimits:K,tileOptions:G});return{taskId:A,squishId:D,taskType:J,output:R}}function M8(U){let{taskId:A,squishId:D,workspaceIndex:J,taskType:$,data:B}=U,{tileTransform:K}=B;return K.tile=j8(K).buffer,{taskId:A,squishId:D,workspaceIndex:J,taskType:$,output:{tileTransform:K}}}var h=(()=>{let U=0;return()=>++U})();class Q8{raw;width;height;constructor(U,A,D){this.raw=U,this.width=A,this.height=D}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let U=document.createElement("canvas");U.width=this.width,U.height=this.height;let A=U.getContext("2d");if(!A)throw new Error("Picsquish error: canvas 2D context not supported");return A.putImageData(this.toImageData(),0,0),U}toBlob(U="image/png"){let A=new OffscreenCanvas(this.width,this.height),D=A.getContext("2d");if(!D)throw new Error("Picsquish error: canvas 2D context not supported");return D.putImageData(this.toImageData(),0,0),A.convertToBlob({type:U})}}class b8{#U;#D;#A;constructor(){this.#U=new Map,this.#D=[],this.#A=[]}#J(U,A){let D=h(),J={taskId:D,squishId:U.squishId,taskType:0,data:U.data};if(!A)return L8(J).then((B)=>this.#$(B));let $=U.data.image instanceof ImageBitmap?[U.data.image]:[];W.assignTask(A,D,J,$)}#K(U,A){let D=h(),J={taskId:D,squishId:U.squishId,workspaceIndex:U.workspaceIndex,taskType:1,data:U.data};if(!A)return this.#$(M8(J));W.assignTask(A,D,J,[U.data.tileTransform.tile])}#G(U){let A=this.#D.shift();if(A)return this.#J(A,U);let D=this.#A.shift();if(D)return this.#K(D,U)}#Z(U){if(this.#D.length===0&&this.#A.length===0)return W.setTimeout();if(U)return this.#G();let D=W.getAvailableWorkers();for(let J of D)this.#G(J)}#B(U,A){let{squishId:D,output:J,error:$}=A;if($)return U.workspaceHandlers.forEach((B)=>B.reject($));for(let[B,K]of J.entries()){let G=K.stages[0].toWidth,R=K.stages[0].toHeight;U.workspaces.set(B,{to:new Uint8ClampedArray(G*R*E),toWidth:G,toHeight:R,stages:K.stages,remainingTileCount:K.tileTransforms.length});for(let Z of K.tileTransforms)this.#A.push({squishId:D,workspaceIndex:B,data:{tileTransform:Z}})}}#R(U,A){let{squishId:D,workspaceIndex:J,output:$,error:B}=A;if(!U.workspaces.has(J))return;let K=U.workspaces.get(J);if(!K)throw new Error("Picsquish error: workspace not found");let G=U.workspaceHandlers.get(J);if(!G)throw new Error("Picsquish error: workspaceHandler not found");if(B)return U.workspaces.delete(J),this.#A=this.#A.filter((Z)=>!(Z.squishId===D&&Z.workspaceIndex===J)),G.reject(B);if(c(K.to,K.toWidth,$.tileTransform),--K.remainingTileCount,K.remainingTileCount)return;if(K.stages.shift(),!K.stages[0])return U.workspaces.delete(J),G.resolve(new Q8(K.to,K.toWidth,K.toHeight));this.#D.push({squishId:D,data:{image:{from:K.to,fromWidth:K.toWidth,fromHeight:K.toHeight,stages:K.stages},dimensionLimits:[],tileOptions:U.tileOptions}})}#$(U){let A=this.#U.get(U.squishId);if(!A)throw new Error("Picsquish error: squishContext not found");switch(U.taskType){case 0:this.#B(A,U);break;case 1:this.#R(A,U);break}if(!A.workspaces.size)this.#U.delete(U.squishId);W.removeTask(U.taskId),this.#Z(A.useMainThread)}add(U,A,D,J){if(!J)W.prepare((G)=>this.#$(G.data),A,D);let $=[],B=new Map;for(let G=0;G<U.dimensionLimits.length;G++)$.push(new Promise((R,Z)=>{B.set(G,{resolve:R,reject:Z})}));let K=h();return this.#U.set(K,{tileOptions:U.tileOptions,workspaces:new Map,workspaceHandlers:B,useMainThread:J}),this.#D.push({squishId:K,data:U}),queueMicrotask(()=>this.#Z(J)),$}}var y8=new b8;function w1(U,A,D={}){let J=D.tileSize||1024,$=D.filter||"mks2013",B=D.unsharpAmount||0,K=D.unsharpRadius||0,G=D.unsharpThreshold||0,R=!!D.useMainThread,Z=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,L=D.maxWorkerPoolSize||Math.min(Z,4),b=D.maxWorkerIdleTime||2000,V=3,j=Math.ceil(Math.max(3,2.5*K|0)),Q={initialSize:J,filterPadding:j,filter:$,unsharpAmount:B,unsharpRadius:K,unsharpThreshold:G};return y8.add({image:U,dimensionLimits:A,tileOptions:Q},L,b,R)}export{w1 as squish};
