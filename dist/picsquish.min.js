var x=2;function b(A,G,U,J,V,K){let $=U/A,L=J/G,_=(2*K+x+1)/V;if(_>0.5)return[{toWidth:U,toHeight:J}];let j=Math.ceil(Math.log(Math.min($,L))/Math.log(_));if(j<=1)return[{toWidth:U,toHeight:J}];let D=[];for(let Z=0;Z<j;Z++){let E=Math.round(Math.pow(Math.pow(A,j-Z-1)*Math.pow(U,Z+1),1/j)),B=Math.round(Math.pow(Math.pow(G,j-Z-1)*Math.pow(J,Z+1),1/j));D.push({toWidth:E,toHeight:B})}return D}function C(A,G,U){let J=new Uint8ClampedArray(U.width*U.height*R);for(let V=0;V<U.height;V++){let K=((U.y+V)*G+U.x)*R,$=V*U.width*R;J.set(A.subarray(K,K+U.width*R),$)}return J}var P=0.00001;function X(A){let G=Math.round(A);if(Math.abs(A-G)<P)return G;return Math.floor(A)}function O(A){let G=Math.round(A);if(Math.abs(A-G)<P)return G;return Math.ceil(A)}function H(A,G,U,J,V,K,$,L,_,j,D){let Z=J/G,E=V/U,B=X(K*Z)-2*$,M=X(K*E)-2*$;if(B<1||M<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let N,F,Y,Q,S,z,q=[];for(Q=0;Q<V;Q+=M)for(Y=0;Y<J;Y+=B){if(N=Y-$,N<0)N=0;if(S=Y+B+$-N,N+S>=J)S=J-N;if(F=Q-$,F<0)F=0;if(z=Q+M+$-F,F+z>=V)z=V-F;let v={toX:N,toY:F,toWidth:S,toHeight:z,toInnerX:Y,toInnerY:Q,toInnerWidth:B,toInnerHeight:M,offsetX:N/Z-X(N/Z),offsetY:F/E-X(F/E),scaleX:Z,scaleY:E,x:X(N/Z),y:X(F/E),width:O(S/Z),height:O(z/E),initialSize:K,filterPadding:$,filter:L,unsharpAmount:_,unsharpRadius:j,unsharpThreshold:D},f=C(A,G,v);q.push({tile:f.buffer,...v})}return q}var R=4;async function c(A,G,U){let J=await createImageBitmap(A),K=new OffscreenCanvas(J.width,J.height).getContext("2d");if(!K)throw new Error("Canvas 2D context not supported");K.drawImage(J,0,0);let L=K.getImageData(0,0,J.width,J.height).data,_=J.width,j=J.height,D=G/_,Z=G/j,E=Math.min(D,Z,1),B=Math.floor(_*E),M=Math.floor(j*E),N=b(_,j,B,M,U.initialSize,U.filterPadding),F=H(L,_,j,B,M,U.initialSize,U.filterPadding,U.filter,U.unsharpAmount,U.unsharpRadius,U.unsharpThreshold);return{from:L.buffer,fromWidth:_,fromHeight:j,tileTransforms:F,stages:N}}function I(A,G,U){let J=new Uint8ClampedArray(U.tile);for(let V=0;V<U.toHeight;V++){let K=V*U.toWidth*R,$=((U.toY+V)*G+U.toX)*R;A.set(J.subarray(K,K+U.toWidth*R),$)}}var p=`
var C8=Object.create;var{getPrototypeOf:X8,defineProperty:o,getOwnPropertyNames:Y8}=Object;var y8=Object.prototype.hasOwnProperty;var z8=(M,U,J)=>{J=M!=null?C8(X8(M)):{};let K=U||!M||!M.__esModule?o(J,"default",{value:M,enumerable:!0}):J;for(let Z of Y8(M))if(!y8.call(K,Z))o(K,Z,{get:()=>M[Z],enumerable:!0});return K};var F8=(M,U)=>()=>(U||M((U={exports:{}}).exports,U),U.exports);var q8=F8((GM,B8)=>{var _,f,a,l,h,p,j8,L8;function b8(M){if(M<0.5)M=0.5;var U=Math.exp(0.527076)/M,J=Math.exp(-U),K=Math.exp(-2*U),Z=(1-J)*(1-J)/(1+2*U*J-K);return _=Z,f=Z*(U-1)*J,a=Z*(U+1)*J,l=-Z*K,h=2*J,p=-K,j8=(_+f)/(1-h-p),L8=(a+l)/(1-h-p),new Float32Array([_,f,a,l,h,p,j8,L8])}function Q8(M,U,J,K,Z,A){var $,G,D,R,L,q,N,j,E,V,B,C,Q,X,y,O,Y,z,w,I,W,F,H,S,g,u,b,T,m,k;for(g=0;g<A;g++){F=g*Z,H=g,S=0,$=M[F],G="<WORKER_CODE>"255,D=$>>8&255,R=$>>16&255,L=$>>24&255,z=G*K[6],w=D*K[6],I=R*K[6],W=L*K[6],X=z,y=w,O=I,Y=W,b=K[0],T=K[1],m=K[4],k=K[5];for(u=0;u<Z;u++)$=M[F],q="<WORKER_CODE>"255,N=$>>8&255,j=$>>16&255,E=$>>24&255,V=q*b+G*T+X*m+z*k,B=N*b+D*T+y*m+w*k,C=j*b+R*T+O*m+I*k,Q=E*b+L*T+Y*m+W*k,z=X,w=y,I=O,W=Y,X=V,y=B,O=C,Y=Q,G=q,D=N,R=j,L=E,J[S]=X,J[S+1]=y,J[S+2]=O,J[S+3]=Y,S+=4,F++;F--,S-=4,H+=A*(Z-1),$=M[F],G="<WORKER_CODE>"255,D=$>>8&255,R=$>>16&255,L=$>>24&255,z=G*K[7],w=D*K[7],I=R*K[7],W=L*K[7],X=z,y=w,O=I,Y=W,q=G,N=D,j=R,E=L,b=K[2],T=K[3];for(u=Z-1;u>=0;u--)V=q*b+G*T+X*m+z*k,B=N*b+D*T+y*m+w*k,C=j*b+R*T+O*m+I*k,Q=E*b+L*T+Y*m+W*k,z=X,w=y,I=O,W=Y,X=V,y=B,O=C,Y=Q,G=q,D=N,R=j,L=E,$=M[F],q="<WORKER_CODE>"255,N=$>>8&255,j=$>>16&255,E=$>>24&255,$=(J[S]+X<<0)+(J[S+1]+y<<8)+(J[S+2]+O<<16)+(J[S+3]+Y<<24),U[H]=$,F--,S-=4,H-=A}}function T8(M,U,J,K){if(!K)return;var Z=new Uint32Array(M.buffer),A=new Uint32Array(Z.length),$=new Float32Array(Math.max(U,J)*4),G=b8(K);Q8(Z,A,$,G,U,J,K),Q8(A,Z,$,G,J,U,K)}B8.exports=T8});var O8=2;function s(M,U,J,K,Z,A){let $=J/M,G=K/U,D=(2*A+O8+1)/Z;if(D>0.5)return[{toWidth:J,toHeight:K}];let R=Math.ceil(Math.log(Math.min($,G))/Math.log(D));if(R<=1)return[{toWidth:J,toHeight:K}];let L=[];for(let q=0;q<R;q++){let N=Math.round(Math.pow(Math.pow(M,R-q-1)*Math.pow(J,q+1),1/R)),j=Math.round(Math.pow(Math.pow(U,R-q-1)*Math.pow(K,q+1),1/R));L.push({toWidth:N,toHeight:j})}return L}function i(M,U,J){let K=new Uint8ClampedArray(J.width*J.height*P);for(let Z=0;Z<J.height;Z++){let A=((J.y+Z)*U+J.x)*P,$=Z*J.width*P;K.set(M.subarray(A,A+J.width*P),$)}return K}var t=0.00001;function n(M){let U=Math.round(M);if(Math.abs(M-U)<t)return U;return Math.floor(M)}function r(M){let U=Math.round(M);if(Math.abs(M-U)<t)return U;return Math.ceil(M)}function e(M,U,J,K,Z,A,$,G,D,R,L){let q=K/U,N=Z/J,j=n(A*q)-2*$,E=n(A*N)-2*$;if(j<1||E<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let V,B,C,Q,X,y,O=[];for(Q=0;Q<Z;Q+=E)for(C=0;C<K;C+=j){if(V=C-$,V<0)V=0;if(X=C+j+$-V,V+X>=K)X=K-V;if(B=Q-$,B<0)B=0;if(y=Q+E+$-B,B+y>=Z)y=Z-B;let Y={toX:V,toY:B,toWidth:X,toHeight:y,toInnerX:C,toInnerY:Q,toInnerWidth:j,toInnerHeight:E,offsetX:V/q-n(V/q),offsetY:B/N-n(B/N),scaleX:q,scaleY:N,x:n(V/q),y:n(B/N),width:r(X/q),height:r(y/N),initialSize:A,filterPadding:$,filter:G,unsharpAmount:D,unsharpRadius:R,unsharpThreshold:L},z=i(M,U,Y);O.push({tile:z.buffer,...Y})}return O}var P=4;async function M8(M,U,J){let K=await createImageBitmap(M),A=new OffscreenCanvas(K.width,K.height).getContext("2d");if(!A)throw new Error("Canvas 2D context not supported");A.drawImage(K,0,0);let G=A.getImageData(0,0,K.width,K.height).data,D=K.width,R=K.height,L=U/D,q=U/R,N=Math.min(L,q,1),j=Math.floor(D*N),E=Math.floor(R*N),V=s(D,R,j,E,J.initialSize,J.filterPadding),B=e(G,D,R,j,E,J.initialSize,J.filterPadding,J.filter,J.unsharpAmount,J.unsharpRadius,J.unsharpThreshold);return{from:G.buffer,fromWidth:D,fromHeight:R,tileTransforms:B,stages:V}}function U8(M,U,J){let K=new Uint8ClampedArray(J.tile);for(let Z=0;Z<J.toHeight;Z++){let A=Z*J.toWidth*P,$=((J.toY+Z)*U+J.toX)*P;M.set(K.subarray(A,A+J.toWidth*P),$)}}var S8="<WORKER_CODE>",I8=new Blob([S8],{type:"application/javascript"});var J8=(()=>{let M=0;return()=>++M})();class K8{#U;#$;#J;#K;constructor(){this.#U=new Map,this.#$=new Map,this.#J=new Map,this.#K=new Map}get count(){return this.#U.size}#Z(M){clearTimeout(this.#$.get(M))}#M(M,U,J,K){this.#U.set(M,U.id),this.#J.set(U.id,M),this.#K.set(U.id,U),M.postMessage(J,K),this.#Z(M)}assignPriority1Task(M,U){let J={taskId:U.id,squishId:U.squishId,taskType:0,blob:U.data.blob,maxDimension:U.data.maxDimension,tileOptions:U.data.tileOptions};this.#M(M,U,J,[])}assignPriority2Task(M,U){let J={taskId:U.id,squishId:U.squishId,taskType:1,tileTransform:U.data.tileTransform};this.#M(M,U,J,[J.tileTransform.tile])}setWorkerTimeout(M,U){let J=setTimeout(()=>{let K=this.#U.get(M);if(K)this.#J.delete(K);if(K)this.#K.delete(K);this.#$.delete(M),this.#U.delete(M),M.terminate()},U);this.#$.set(M,J)}addWorker(M){this.#U.set(M,null)}getWorker(M){return this.#J.get(M)}getTask(M){return this.#K.get(M)}getAvailableWorker(){for(let[M,U]of this.#U.entries())if(U===null)return M;return null}removeTask(M){let U=this.#J.get(M);if(U)this.#U.set(U,null);this.#J.delete(M),this.#K.delete(M)}}class H8{#U;#$;#J;#K;#Z;#M;constructor(M,U){this.#$=M,this.#U=U,this.#J=new Map,this.#K=[],this.#Z=[],this.#M=new K8}#R(){let M=new Worker(URL.createObjectURL(I8));M.onmessage=(U)=>{let J=this.#J.get(U.data.squishId);if(!J)throw new Error("SquishContext not found");if(U.data.error)J.reject(U.data.error);if(U.data.taskType===0){let{squishId:Z,output:A}=U.data,$=A.stages[0].toWidth,G=A.stages[0].toHeight;J.from=new Uint8ClampedArray(A.from),J.fromWidth=A.fromWidth,J.fromHeight=A.fromHeight,J.to=new Uint8ClampedArray($*G*P),J.toWidth=$,J.toHeight=G,J.stages=A.stages,J.remainingTileCount=A.tileTransforms.length;for(let D of A.tileTransforms)this.#Z.push({id:J8(),squishId:Z,data:{tileTransform:D}})}if(U.data.taskType===1){let{output:Z}=U.data;if(!J.to)throw new Error("SquishContext to not found");if(U8(J.to,J.toWidth,Z.tileTransform),J.remainingTileCount--,!J.remainingTileCount){let A=new ImageData(J.to,J.toWidth,J.toHeight);createImageBitmap(A).then(($)=>{J.resolve($)})}}let K=this.#M.getWorker(U.data.taskId);if(K)this.#M.setWorkerTimeout(K,this.#U);this.#M.removeTask(U.data.taskId),this.#G()},this.#M.addWorker(M)}#G(){let M=this.#M.getAvailableWorker();if(M){let U=this.#K.shift();if(U)return this.#M.assignPriority1Task(M,U);let J=this.#Z.shift();if(J)return this.#M.assignPriority2Task(M,J)}else if(this.#M.count<this.#$)this.#R(),this.#G()}add(M){return new Promise((U,J)=>{let K=J8();this.#J.set(K,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:U,reject:J}),this.#K.push({id:K,squishId:K,data:M}),this.#G()})}}var d={box:{win:0.5,fn:(M)=>{if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:(M)=>{if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*(0.54+0.46*Math.cos(U/1))}},lanczos2:{win:2,fn:(M)=>{if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/2)/(U/2)}},lanczos3:{win:3,fn:(M)=>{if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/3)/(U/3)}},mks2013:{win:2.5,fn:(M)=>{if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var w8=14;function $8(M){return Math.round(M*((1<<w8)-1))}function c(M,U,J,K,Z){let A=d[M].fn,$=1/K,G=Math.min(1,K),D=d[M].win/G,R,L,q,N,j,E,V,B,C,Q,X,y,O,Y,z,w,I,W=Math.floor((D+1)*2),F=new Int16Array((W+2)*J),H=0,S=!F.subarray||!F.set;for(R=0;R<J;R++){L=(R+0.5)*$+Z,q=Math.max(0,Math.floor(L-D)),N=Math.min(U-1,Math.ceil(L+D)),j=N-q+1,E=new Float32Array(j),V=new Int16Array(j),B=0;for(C=q,Q=0;C<=N;C++,Q++)X=A((C+0.5-L)*G),B+=X,E[Q]=X;y=0;for(Q=0;Q<E.length;Q++)O=E[Q]/B,y+=O,V[Q]=$8(O);V[J>>1]+=$8(1-y),Y=0;while(Y<V.length&&V[Y]===0)Y++;if(Y<V.length){z=V.length-1;while(z>0&&V[z]===0)z--;if(w=q+Y,I=z-Y+1,F[H++]=w,F[H++]=I,!S)F.set(V.subarray(Y,z+1),H),H+=I;else for(Q=Y;Q<=z;Q++)F[H++]=V[Q]}else F[H++]=0,F[H++]=0}return F}function x(M){return M<0?0:M>255?255:M}function v(M){return M>=0?M:0}function Z8(M,U,J,K,Z,A){let $,G,D,R,L,q,N,j,E,V,B,C=0,Q=0;for(E=0;E<K;E++){L=0;for(V=0;V<Z;V++){q=A[L++],N=A[L++],j=C+q*4|0,$=G=D=R=0;for(;N>0;N--)B=A[L++],R=R+B*M[j+3]|0,D=D+B*M[j+2]|0,G=G+B*M[j+1]|0,$=$+B*M[j]|0,j=j+4|0;U[Q+3]=v(R>>7),U[Q+2]=v(D>>7),U[Q+1]=v(G>>7),U[Q]=v($>>7),Q=Q+K*4|0}Q=(E+1)*4|0,C=(E+1)*J*4|0}}function G8(M,U,J,K,Z,A){let $,G,D,R,L,q,N,j,E,V,B,C=0,Q=0;for(E=0;E<K;E++){L=0;for(V=0;V<Z;V++){q=A[L++],N=A[L++],j=C+q*4|0,$=G=D=R=0;for(;N>0;N--)B=A[L++],R=R+B*M[j+3]|0,D=D+B*M[j+2]|0,G=G+B*M[j+1]|0,$=$+B*M[j]|0,j=j+4|0;$>>=7,G>>=7,D>>=7,R>>=7,U[Q+3]=x(R+8192>>14),U[Q+2]=x(D+8192>>14),U[Q+1]=x(G+8192>>14),U[Q]=x($+8192>>14),Q=Q+K*4|0}Q=(E+1)*4|0,C=(E+1)*J*4|0}}function R8(M,U,J,K,Z,A){let $,G,D,R,L,q,N,j,E,V,B,C,Q=0,X=0;for(V=0;V<K;V++){q=0;for(B=0;B<Z;B++){N=A[q++],j=A[q++],E=Q+N*4|0,$=G=D=R=0;for(;j>0;j--)C=A[q++],L=M[E+3],R=R+C*L|0,D=D+C*M[E+2]*L|0,G=G+C*M[E+1]*L|0,$=$+C*M[E]*L|0,E=E+4|0;D=D/255|0,G=G/255|0,$=$/255|0,U[X+3]=v(R>>7),U[X+2]=v(D>>7),U[X+1]=v(G>>7),U[X]=v($>>7),X=X+K*4|0}X=(V+1)*4|0,Q=(V+1)*J*4|0}}function A8(M,U,J,K,Z,A){let $,G,D,R,L,q,N,j,E,V,B,C=0,Q=0;for(E=0;E<K;E++){L=0;for(V=0;V<Z;V++){q=A[L++],N=A[L++],j=C+q*4|0,$=G=D=R=0;for(;N>0;N--)B=A[L++],R=R+B*M[j+3]|0,D=D+B*M[j+2]|0,G=G+B*M[j+1]|0,$=$+B*M[j]|0,j=j+4|0;if($>>=7,G>>=7,D>>=7,R>>=7,R=x(R+8192>>14),R>0)$=$*255/R|0,G=G*255/R|0,D=D*255/R|0;U[Q+3]=R,U[Q+2]=x(D+8192>>14),U[Q+1]=x(G+8192>>14),U[Q]=x($+8192>>14),Q=Q+K*4|0}Q=(E+1)*4|0,C=(E+1)*J*4|0}}function P8(M,U,J){let K=3,Z=U*J*4|0;while(K<Z){if(M[K]!==255)return!0;K=K+4|0}return!1}function W8(M,U,J){let K=3,Z=U*J*4|0;while(K<Z)M[K]=255,K=K+4|0}function D8(M,U,J,K,Z,A,$,G,D,R){let L=c(U,J,Z,$,D),q=c(U,K,A,G,R),N=new Uint8Array(Z*A*4),j=new Uint16Array(Z*K*4);if(P8(M,J,K))R8(M,j,J,K,Z,L),A8(j,N,K,Z,A,q);else Z8(M,j,J,K,Z,L),G8(j,N,K,Z,A,q),W8(N,Z,A);return N}var E8=z8(q8(),1);function m8(M,U,J){let K=U*J,Z=new Uint16Array(K),A,$,G,D;for(let R=0;R<K;R++)A=M[4*R],$=M[4*R+1],G=M[4*R+2],D=A>="<WORKER_CODE>"&A>=G?A:$>=G&&$>=A?$:G,Z[R]=D<<8;return Z}function V8(M,U,J,K,Z,A){let $,G,D,R,L;if(K===0||Z<0.5)return;if(Z>2)Z=2;let q=m8(M,U,J),N=new Uint16Array(q);E8.default(N,U,J,Z);let j=K/100*4096+0.5|0,E=A<<8,V=U*J;for(let B=0;B<V;B++)if($=q[B],R=$-N[B],Math.abs(R)>=E)G=$+(j*R+2048>>12),G=G>65280?65280:G,G=G<0?0:G,$=$!==0?$:1,D=(G<<12)/$|0,L=B*4,M[L]=M[L]*D+2048>>12,M[L+1]=M[L+1]*D+2048>>12,M[L+2]=M[L+2]*D+2048>>12}function N8(M){let U=D8(new Uint8ClampedArray(M.tile),M.filter,M.width,M.height,M.toWidth,M.toHeight,M.scaleX,M.scaleY,M.offsetX,M.offsetY);if(M.unsharpAmount)V8(U,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return U}self.onmessage=async(M)=>{let{taskId:U,squishId:J,taskType:K}=M.data;try{if(K===0){let{blob:Z,maxDimension:A,tileOptions:$}=M.data,G=await M8(Z,A,$),D={taskId:U,squishId:J,taskType:K,output:{from:G.from,fromWidth:G.fromWidth,fromHeight:G.fromHeight,tileTransforms:G.tileTransforms,stages:G.stages}},R=G.tileTransforms.map((L)=>L.tile);self.postMessage(D,[G.from,...R])}if(K===1){let{tileTransform:Z}=M.data;Z.tile=N8(Z).buffer;let A={taskId:U,squishId:J,taskType:K,output:{tileTransform:Z}};self.postMessage(A,[Z.tile])}}catch(Z){self.postMessage({taskId:U,squishId:J,taskType:K,error:Z})}};
`,g=new Blob([p],{type:"application/javascript"});var w=(()=>{let A=0;return()=>++A})();class W{#U;#G;#J;#K;constructor(){this.#U=new Map,this.#G=new Map,this.#J=new Map,this.#K=new Map}get count(){return this.#U.size}#V(A){clearTimeout(this.#G.get(A))}#A(A,G,U,J){this.#U.set(A,G.id),this.#J.set(G.id,A),this.#K.set(G.id,G),A.postMessage(U,J),this.#V(A)}assignPriority1Task(A,G){let U={taskId:G.id,squishId:G.squishId,taskType:0,blob:G.data.blob,maxDimension:G.data.maxDimension,tileOptions:G.data.tileOptions};this.#A(A,G,U,[])}assignPriority2Task(A,G){let U={taskId:G.id,squishId:G.squishId,taskType:1,tileTransform:G.data.tileTransform};this.#A(A,G,U,[U.tileTransform.tile])}setWorkerTimeout(A,G){let U=setTimeout(()=>{let J=this.#U.get(A);if(J)this.#J.delete(J);if(J)this.#K.delete(J);this.#G.delete(A),this.#U.delete(A),A.terminate()},G);this.#G.set(A,U)}addWorker(A){this.#U.set(A,null)}getWorker(A){return this.#J.get(A)}getTask(A){return this.#K.get(A)}getAvailableWorker(){for(let[A,G]of this.#U.entries())if(G===null)return A;return null}removeTask(A){let G=this.#J.get(A);if(G)this.#U.set(G,null);this.#J.delete(A),this.#K.delete(A)}}class y{#U;#G;#J;#K;#V;#A;constructor(A,G){this.#G=A,this.#U=G,this.#J=new Map,this.#K=[],this.#V=[],this.#A=new W}#Z(){let A=new Worker(URL.createObjectURL(g));A.onmessage=(G)=>{let U=this.#J.get(G.data.squishId);if(!U)throw new Error("SquishContext not found");if(G.data.error)U.reject(G.data.error);if(G.data.taskType===0){let{squishId:V,output:K}=G.data,$=K.stages[0].toWidth,L=K.stages[0].toHeight;U.from=new Uint8ClampedArray(K.from),U.fromWidth=K.fromWidth,U.fromHeight=K.fromHeight,U.to=new Uint8ClampedArray($*L*R),U.toWidth=$,U.toHeight=L,U.stages=K.stages,U.remainingTileCount=K.tileTransforms.length;for(let _ of K.tileTransforms)this.#V.push({id:w(),squishId:V,data:{tileTransform:_}})}if(G.data.taskType===1){let{output:V}=G.data;if(!U.to)throw new Error("SquishContext to not found");if(I(U.to,U.toWidth,V.tileTransform),U.remainingTileCount--,!U.remainingTileCount){let K=new ImageData(U.to,U.toWidth,U.toHeight);createImageBitmap(K).then(($)=>{U.resolve($)})}}let J=this.#A.getWorker(G.data.taskId);if(J)this.#A.setWorkerTimeout(J,this.#U);this.#A.removeTask(G.data.taskId),this.#$()},this.#A.addWorker(A)}#$(){let A=this.#A.getAvailableWorker();if(A){let G=this.#K.shift();if(G)return this.#A.assignPriority1Task(A,G);let U=this.#V.shift();if(U)return this.#A.assignPriority2Task(A,U)}else if(this.#A.count<this.#G)this.#Z(),this.#$()}add(A){return new Promise((G,U)=>{let J=w();this.#J.set(J,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:G,reject:U}),this.#K.push({id:J,squishId:J,data:A}),this.#$()})}}class u{#U;#G;constructor(A){let G=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,U=A.maxWorkerPoolSize||Math.min(G,4),J=A.maxWorkerIdleTime||1e4;this.#U=new y(U,J),this.#G=A}async squish(A,G){let U=G?{...this.#G,...G}:this.#G,J=U.maxDimension,V=U.tileSize||1024,K=U.filter||"mks2013",$=U.unsharpAmount||0,L=U.unsharpRadius||0,_=U.unsharpThreshold||0,j=U.useMainThread,D=3,Z=Math.ceil(Math.max(3,2.5*L|0)),E={initialSize:V,filterPadding:Z,filter:K,unsharpAmount:$,unsharpRadius:L,unsharpThreshold:_};if(j)return await c(A,J,E);return this.#U.add({blob:A,maxDimension:J,tileOptions:E})}}export{u as PicSquish};
