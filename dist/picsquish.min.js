var wk=Object.create;var{getPrototypeOf:Ek,defineProperty:l,getOwnPropertyNames:mk}=Object;var Ok=Object.prototype.hasOwnProperty;var Vk=(k,M,U)=>{U=k!=null?wk(Ek(k)):{};let C=M||!k||!k.__esModule?l(U,"default",{value:k,enumerable:!0}):U;for(let J of mk(k))if(!Ok.call(C,J))l(C,J,{get:()=>k[J],enumerable:!0});return C};var Nk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Zk=Nk((_k,$k)=>{var d,a,s,f,h,p,Kk,Rk;function Dk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,U=Math.exp(-M),C=Math.exp(-2*M),J=(1-U)*(1-U)/(1+2*M*U-C);return d=J,a=J*(M-1)*U,s=J*(M+1)*U,f=-J*C,h=2*U,p=-C,Kk=(d+a)/(1-h-p),Rk=(s+f)/(1-h-p),new Float32Array([d,a,s,f,h,p,Kk,Rk])}function Jk(k,M,U,C,J,$){var Q,I,K,q,R,j,n,Z,G,L,B,y,A,w,V,N,E,O,Y,T,D,m,X,z,v,u,F,W,S,P;for(v=0;v<$;v++){m=v*J,X=v,z=0,Q=k[m],I=Q&255,K=Q>>8&255,q=Q>>16&255,R=Q>>24&255,O=I*C[6],Y=K*C[6],T=q*C[6],D=R*C[6],w=O,V=Y,N=T,E=D,F=C[0],W=C[1],S=C[4],P=C[5];for(u=0;u<J;u++)Q=k[m],j=Q&255,n=Q>>8&255,Z=Q>>16&255,G=Q>>24&255,L=j*F+I*W+w*S+O*P,B=n*F+K*W+V*S+Y*P,y=Z*F+q*W+N*S+T*P,A=G*F+R*W+E*S+D*P,O=w,Y=V,T=N,D=E,w=L,V=B,N=y,E=A,I=j,K=n,q=Z,R=G,U[z]=w,U[z+1]=V,U[z+2]=N,U[z+3]=E,z+=4,m++;m--,z-=4,X+=$*(J-1),Q=k[m],I=Q&255,K=Q>>8&255,q=Q>>16&255,R=Q>>24&255,O=I*C[7],Y=K*C[7],T=q*C[7],D=R*C[7],w=O,V=Y,N=T,E=D,j=I,n=K,Z=q,G=R,F=C[2],W=C[3];for(u=J-1;u>=0;u--)L=j*F+I*W+w*S+O*P,B=n*F+K*W+V*S+Y*P,y=Z*F+q*W+N*S+T*P,A=G*F+R*W+E*S+D*P,O=w,Y=V,T=N,D=E,w=L,V=B,N=y,E=A,I=j,K=n,q=Z,R=G,Q=k[m],j=Q&255,n=Q>>8&255,Z=Q>>16&255,G=Q>>24&255,Q=(U[z]+w<<0)+(U[z+1]+V<<8)+(U[z+2]+N<<16)+(U[z+3]+E<<24),M[X]=Q,m--,z-=4,X-=$}}function Fk(k,M,U,C){if(!C)return;var J=new Uint32Array(k.buffer),$=new Uint32Array(J.length),Q=new Float32Array(Math.max(M,U)*4),I=Dk(C);Jk(J,$,Q,I,M,U,C),Jk($,J,Q,I,U,M,C)}$k.exports=Fk});var zk=2;function _(k,M,U,C,J,$){let Q=U/k,I=C/M,K=(2*$+zk+1)/J;if(K>0.5)return[{toWidth:U,toHeight:C}];let q=Math.ceil(Math.log(Math.min(Q,I))/Math.log(K));if(q<=1)return[{toWidth:U,toHeight:C}];let R=[];for(let j=0;j<q;j++){let n=Math.round(Math.pow(Math.pow(k,q-j-1)*Math.pow(U,j+1),1/q)),Z=Math.round(Math.pow(Math.pow(M,q-j-1)*Math.pow(C,j+1),1/q));R.push({toWidth:n,toHeight:Z})}return R}function i(k,M){let C=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!C)throw new Error("Pica: Canvas context is not supported");return C.globalCompositeOperation="copy",C.drawImage(M,k.x,k.y,k.width,k.height,0,0,k.width,k.height),C.getImageData(0,0,k.width,k.height).data}var e=0.00001;function x(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.floor(k)}function r(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.ceil(k)}function t(k,M,U,C,J,$){let Q=C/k,I=J/M,K=x(U*Q)-2*$,q=x(U*I)-2*$;if(K<1||q<1)throw new Error("Internal error in pica: target tile width/height is too small.");let R,j,n,Z,G,L,B=[];for(Z=0;Z<J;Z+=q)for(n=0;n<C;n+=K){if(R=n-$,R<0)R=0;if(G=n+K+$-R,R+G>=C)G=C-R;if(j=Z-$,j<0)j=0;if(L=Z+q+$-j,j+L>=J)L=J-j;B.push({toX:R,toY:j,toWidth:G,toHeight:L,toInnerX:n,toInnerY:Z,toInnerWidth:K,toInnerHeight:q,offsetX:R/Q-x(R/Q),offsetY:j/I-x(j/I),scaleX:Q,scaleY:I,x:x(R/Q),y:x(j/I),width:r(G/Q),height:r(L/I)})}return B}function kk(k,M,U){let C=new ImageData(new Uint8ClampedArray(M),k.toWidth,k.toHeight),J=!1;U.putImageData(C,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth,k.toInnerHeight)}var g={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Tk=14;function Mk(k){return Math.round(k*((1<<Tk)-1))}function o(k,M,U,C,J){let $=g[k].fn,Q=1/C,I=Math.min(1,C),K=g[k].win/I,q,R,j,n,Z,G,L,B,y,A,w,V,N,E,O,Y,T,D=Math.floor((K+1)*2),m=new Int16Array((D+2)*U),X=0,z=!m.subarray||!m.set;for(q=0;q<U;q++){R=(q+0.5)*Q+J,j=Math.max(0,Math.floor(R-K)),n=Math.min(M-1,Math.ceil(R+K)),Z=n-j+1,G=new Float32Array(Z),L=new Int16Array(Z),B=0;for(y=j,A=0;y<=n;y++,A++)w=$((y+0.5-R)*I),B+=w,G[A]=w;V=0;for(A=0;A<G.length;A++)N=G[A]/B,V+=N,L[A]=Mk(N);L[U>>1]+=Mk(1-V),E=0;while(E<L.length&&L[E]===0)E++;if(E<L.length){O=L.length-1;while(O>0&&L[O]===0)O--;if(Y=j+E,T=O-E+1,m[X++]=Y,m[X++]=T,!z)m.set(L.subarray(E,O+1),X),X+=T;else for(A=E;A<=O;A++)m[X++]=L[A]}else m[X++]=0,m[X++]=0}return m}function b(k){return k<0?0:k>255?255:k}function H(k){return k>=0?k:0}function Ck(k,M,U,C,J,$){let Q,I,K,q,R,j,n,Z,G,L,B,y=0,A=0;for(G=0;G<C;G++){R=0;for(L=0;L<J;L++){j=$[R++],n=$[R++],Z=y+j*4|0,Q=I=K=q=0;for(;n>0;n--)B=$[R++],q=q+B*k[Z+3]|0,K=K+B*k[Z+2]|0,I=I+B*k[Z+1]|0,Q=Q+B*k[Z]|0,Z=Z+4|0;M[A+3]=H(q>>7),M[A+2]=H(K>>7),M[A+1]=H(I>>7),M[A]=H(Q>>7),A=A+C*4|0}A=(G+1)*4|0,y=(G+1)*U*4|0}}function Qk(k,M,U,C,J,$){let Q,I,K,q,R,j,n,Z,G,L,B,y=0,A=0;for(G=0;G<C;G++){R=0;for(L=0;L<J;L++){j=$[R++],n=$[R++],Z=y+j*4|0,Q=I=K=q=0;for(;n>0;n--)B=$[R++],q=q+B*k[Z+3]|0,K=K+B*k[Z+2]|0,I=I+B*k[Z+1]|0,Q=Q+B*k[Z]|0,Z=Z+4|0;Q>>=7,I>>=7,K>>=7,q>>=7,M[A+3]=b(q+8192>>14),M[A+2]=b(K+8192>>14),M[A+1]=b(I+8192>>14),M[A]=b(Q+8192>>14),A=A+C*4|0}A=(G+1)*4|0,y=(G+1)*U*4|0}}function Uk(k,M,U,C,J,$){let Q,I,K,q,R,j,n,Z,G,L,B,y,A=0,w=0;for(L=0;L<C;L++){j=0;for(B=0;B<J;B++){n=$[j++],Z=$[j++],G=A+n*4|0,Q=I=K=q=0;for(;Z>0;Z--)y=$[j++],R=k[G+3],q=q+y*R|0,K=K+y*k[G+2]*R|0,I=I+y*k[G+1]*R|0,Q=Q+y*k[G]*R|0,G=G+4|0;K=K/255|0,I=I/255|0,Q=Q/255|0,M[w+3]=H(q>>7),M[w+2]=H(K>>7),M[w+1]=H(I>>7),M[w]=H(Q>>7),w=w+C*4|0}w=(L+1)*4|0,A=(L+1)*U*4|0}}function qk(k,M,U,C,J,$){let Q,I,K,q,R,j,n,Z,G,L,B,y=0,A=0;for(G=0;G<C;G++){R=0;for(L=0;L<J;L++){j=$[R++],n=$[R++],Z=y+j*4|0,Q=I=K=q=0;for(;n>0;n--)B=$[R++],q=q+B*k[Z+3]|0,K=K+B*k[Z+2]|0,I=I+B*k[Z+1]|0,Q=Q+B*k[Z]|0,Z=Z+4|0;if(Q>>=7,I>>=7,K>>=7,q>>=7,q=b(q+8192>>14),q>0)Q=Q*255/q|0,I=I*255/q|0,K=K*255/q|0;M[A+3]=q,M[A+2]=b(K+8192>>14),M[A+1]=b(I+8192>>14),M[A]=b(Q+8192>>14),A=A+C*4|0}A=(G+1)*4|0,y=(G+1)*U*4|0}}function Xk(k,M,U){let C=3,J=M*U*4|0;while(C<J){if(k[C]!==255)return!0;C=C+4|0}return!1}function Yk(k,M,U){let C=3,J=M*U*4|0;while(C<J)k[C]=255,C=C+4|0}function Ik(k,M,U,C,J,$,Q,I,K,q){let R=o(k,U,J,Q,K),j=o(k,C,$,I,q),n=new Uint8Array(J*$*4),Z=new Uint16Array(J*C*4);if(Xk(M,U,C))Uk(M,Z,U,C,J,R),qk(Z,n,C,J,$,j);else Ck(M,Z,U,C,J,R),Qk(Z,n,C,J,$,j),Yk(n,J,$);return n}var jk=Vk(Zk(),1);function Wk(k,M,U){let C=M*U,J=new Uint16Array(C),$,Q,I,K;for(let q=0;q<C;q++)$=k[4*q],Q=k[4*q+1],I=k[4*q+2],K=$>=Q&&$>=I?$:Q>=I&&Q>=$?Q:I,J[q]=K<<8;return J}function Ak(k,M,U,C,J,$){let Q,I,K,q,R;if(C===0||J<0.5)return;if(J>2)J=2;let j=Wk(k,M,U),n=new Uint16Array(j);jk.default(n,M,U,J);let Z=C/100*4096+0.5|0,G=$<<8,L=M*U;for(let B=0;B<L;B++)if(Q=j[B],q=Q-n[B],Math.abs(q)>=G)I=Q+(Z*q+2048>>12),I=I>65280?65280:I,I=I<0?0:I,Q=Q!==0?Q:1,K=(I<<12)/Q|0,R=B*4,k[R]=k[R]*K+2048>>12,k[R+1]=k[R+1]*K+2048>>12,k[R+2]=k[R+2]*K+2048>>12}function Gk(k,M,U,C,J,$,Q,I,K,q,R,j,n){let Z=Ik(k,M,U,C,J,$,Q,I,K,q);if(R)Ak(Z,J,$,R,j,n);return Z}var Sk=(k,M,U,C,J,$,Q)=>{let I=i(k,M),K=Gk(U,I,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY,C,J,$);kk(k,K,Q)};async function nk(k,M,U,C,J,$,Q,I){let K=M.getContext("2d");if(!K)throw new Error("Pica: Canvas context is not supported");let q=t(k.width,k.height,U,M.width,M.height,C);for(let R of q)Sk(R,k,J,$,Q,I,K)}async function Lk(k,M,U,C,J,$,Q,I){let K=M,q=new OffscreenCanvas(k[0].toWidth,k[0].toHeight);for(let R=0;R<k.length;R++){await nk(K,q,U,C,J,$,Q,I);let j=k[R+1];if(!j)break;K=q,q=new OffscreenCanvas(j.toWidth,j.toHeight)}return q}async function Bk(k,M){let U=M.maxDimension,C=M.tileSize??1024,J=M.unsharpAmount??0,$=M.unsharpRadius??0,Q=M.unsharpThreshold??0,I=await createImageBitmap(k),K=I.width,q=I.height,R=U/K,j=U/q,n=Math.min(R,j,1),Z=Math.floor(K*n),G=Math.floor(q*n),L=3,B=Math.ceil(Math.max(3,2.5*$|0)),y=_(K,q,Z,G,C,B),A={filter:"mks2013",unsharpAmount:J,unsharpRadius:$,unsharpThreshold:Q,width:K,height:q,toWidth:Z,toHeight:G,destTileBorder:B};return(await Lk(y,I,1024,A.destTileBorder,A.filter,A.unsharpAmount,A.unsharpRadius,A.unsharpThreshold)).transferToImageBitmap()}var Pk=`
var y0=Object.create;var{getPrototypeOf:E0,defineProperty:_,getOwnPropertyNames:V0}=Object;var N0=Object.prototype.hasOwnProperty;var w0=(C,M,Q)=>{Q=C!=null?y0(E0(C)):{};let U=M||!C||!C.__esModule?_(Q,"default",{value:C,enumerable:!0}):Q;for(let $ of V0(C))if(!N0.call(U,$))_(U,$,{get:()=>C[$],enumerable:!0});return U};var z0=(C,M)=>()=>(M||C((M={exports:{}}).exports,M),M.exports);var A0=z0((f0,G0)=>{var f,o,a,c,h,g,Q0,$0;function F0(C){if(C<0.5)C=0.5;var M=Math.exp(0.527076)/C,Q=Math.exp(-M),U=Math.exp(-2*M),$=(1-Q)*(1-Q)/(1+2*M*Q-U);return f=$,o=$*(M-1)*Q,a=$*(M+1)*Q,c=-$*U,h=2*Q,g=-U,Q0=(f+o)/(1-h-g),$0=(a+c)/(1-h-g),new Float32Array([f,o,a,c,h,g,Q0,$0])}function Z0(C,M,Q,U,$,j){var q,K,Z,J,G,R,k,A,I,B,y,E,L,V,X,O,N,z,S,D,m,w,F,Y,v,u,P,H,W,T;for(v=0;v<j;v++){w=v*$,F=v,Y=0,q=C[w],K=q&255,Z=q>>8&255,J=q>>16&255,G=q>>24&255,z=K*U[6],S=Z*U[6],D=J*U[6],m=G*U[6],V=z,X=S,O=D,N=m,P=U[0],H=U[1],W=U[4],T=U[5];for(u=0;u<$;u++)q=C[w],R=q&255,k=q>>8&255,A=q>>16&255,I=q>>24&255,B=R*P+K*H+V*W+z*T,y=k*P+Z*H+X*W+S*T,E=A*P+J*H+O*W+D*T,L=I*P+G*H+N*W+m*T,z=V,S=X,D=O,m=N,V=B,X=y,O=E,N=L,K=R,Z=k,J=A,G=I,Q[Y]=V,Q[Y+1]=X,Q[Y+2]=O,Q[Y+3]=N,Y+=4,w++;w--,Y-=4,F+=j*($-1),q=C[w],K=q&255,Z=q>>8&255,J=q>>16&255,G=q>>24&255,z=K*U[7],S=Z*U[7],D=J*U[7],m=G*U[7],V=z,X=S,O=D,N=m,R=K,k=Z,A=J,I=G,P=U[2],H=U[3];for(u=$-1;u>=0;u--)B=R*P+K*H+V*W+z*T,y=k*P+Z*H+X*W+S*T,E=A*P+J*H+O*W+D*T,L=I*P+G*H+N*W+m*T,z=V,S=X,D=O,m=N,V=B,X=y,O=E,N=L,K=R,Z=k,J=A,G=I,q=C[w],R=q&255,k=q>>8&255,A=q>>16&255,I=q>>24&255,q=(Q[Y]+V<<0)+(Q[Y+1]+X<<8)+(Q[Y+2]+O<<16)+(Q[Y+3]+N<<24),M[F]=q,w--,Y-=4,F-=j}}function S0(C,M,Q,U){if(!U)return;var $=new Uint32Array(C.buffer),j=new Uint32Array($.length),q=new Float32Array(Math.max(M,Q)*4),K=F0(U);Z0($,j,q,K,M,Q,U),Z0(j,$,q,K,Q,M,U)}G0.exports=S0});var X0=2;function l(C,M,Q,U,$,j){let q=Q/C,K=U/M,Z=(2*j+X0+1)/$;if(Z>0.5)return[{toWidth:Q,toHeight:U}];let J=Math.ceil(Math.log(Math.min(q,K))/Math.log(Z));if(J<=1)return[{toWidth:Q,toHeight:U}];let G=[];for(let R=0;R<J;R++){let k=Math.round(Math.pow(Math.pow(C,J-R-1)*Math.pow(Q,R+1),1/J)),A=Math.round(Math.pow(Math.pow(M,J-R-1)*Math.pow(U,R+1),1/J));G.push({toWidth:k,toHeight:A})}return G}function s(C,M){let U=new OffscreenCanvas(C.width,C.height).getContext("2d");if(!U)throw new Error("Pica: Canvas context is not supported");return U.globalCompositeOperation="copy",U.drawImage(M,C.x,C.y,C.width,C.height,0,0,C.width,C.height),U.getImageData(0,0,C.width,C.height).data}var r=0.00001;function x(C){let M=Math.round(C);if(Math.abs(C-M)<r)return M;return Math.floor(C)}function i(C){let M=Math.round(C);if(Math.abs(C-M)<r)return M;return Math.ceil(C)}function t(C,M,Q,U,$,j){let q=U/C,K=$/M,Z=x(Q*q)-2*j,J=x(Q*K)-2*j;if(Z<1||J<1)throw new Error("Internal error in pica: target tile width/height is too small.");let G,R,k,A,I,B,y=[];for(A=0;A<$;A+=J)for(k=0;k<U;k+=Z){if(G=k-j,G<0)G=0;if(I=k+Z+j-G,G+I>=U)I=U-G;if(R=A-j,R<0)R=0;if(B=A+J+j-R,R+B>=$)B=$-R;y.push({toX:G,toY:R,toWidth:I,toHeight:B,toInnerX:k,toInnerY:A,toInnerWidth:Z,toInnerHeight:J,offsetX:G/q-x(G/q),offsetY:R/K-x(R/K),scaleX:q,scaleY:K,x:x(G/q),y:x(R/K),width:i(I/q),height:i(B/K)})}return y}function e(C,M,Q){let U=new ImageData(new Uint8ClampedArray(M),C.toWidth,C.toHeight),$=!1;Q.putImageData(U,C.toX,C.toY,C.toInnerX-C.toX,C.toInnerY-C.toY,C.toInnerWidth,C.toInnerHeight)}var p={box:{win:0.5,fn:(C)=>{if(C<0)C=-C;return C<0.5?1:0}},hamming:{win:1,fn:(C)=>{if(C<0)C=-C;if(C>=1)return 0;if(C<0.00000011920929)return 1;let M=C*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(C)=>{if(C<0)C=-C;if(C>=2)return 0;if(C<0.00000011920929)return 1;let M=C*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(C)=>{if(C<0)C=-C;if(C>=3)return 0;if(C<0.00000011920929)return 1;let M=C*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(C)=>{if(C<0)C=-C;if(C>=2.5)return 0;if(C>=1.5)return-0.125*(C-2.5)*(C-2.5);if(C>=0.5)return 0.25*(4*C*C-11*C+7);return 1.0625-1.75*C*C}}};var O0=14;function C0(C){return Math.round(C*((1<<O0)-1))}function d(C,M,Q,U,$){let j=p[C].fn,q=1/U,K=Math.min(1,U),Z=p[C].win/K,J,G,R,k,A,I,B,y,E,L,V,X,O,N,z,S,D,m=Math.floor((Z+1)*2),w=new Int16Array((m+2)*Q),F=0,Y=!w.subarray||!w.set;for(J=0;J<Q;J++){G=(J+0.5)*q+$,R=Math.max(0,Math.floor(G-Z)),k=Math.min(M-1,Math.ceil(G+Z)),A=k-R+1,I=new Float32Array(A),B=new Int16Array(A),y=0;for(E=R,L=0;E<=k;E++,L++)V=j((E+0.5-G)*K),y+=V,I[L]=V;X=0;for(L=0;L<I.length;L++)O=I[L]/y,X+=O,B[L]=C0(O);B[Q>>1]+=C0(1-X),N=0;while(N<B.length&&B[N]===0)N++;if(N<B.length){z=B.length-1;while(z>0&&B[z]===0)z--;if(S=R+N,D=z-N+1,w[F++]=S,w[F++]=D,!Y)w.set(B.subarray(N,z+1),F),F+=D;else for(L=N;L<=z;L++)w[F++]=B[L]}else w[F++]=0,w[F++]=0}return w}function b(C){return C<0?0:C>255?255:C}function n(C){return C>=0?C:0}function M0(C,M,Q,U,$,j){let q,K,Z,J,G,R,k,A,I,B,y,E=0,L=0;for(I=0;I<U;I++){G=0;for(B=0;B<$;B++){R=j[G++],k=j[G++],A=E+R*4|0,q=K=Z=J=0;for(;k>0;k--)y=j[G++],J=J+y*C[A+3]|0,Z=Z+y*C[A+2]|0,K=K+y*C[A+1]|0,q=q+y*C[A]|0,A=A+4|0;M[L+3]=n(J>>7),M[L+2]=n(Z>>7),M[L+1]=n(K>>7),M[L]=n(q>>7),L=L+U*4|0}L=(I+1)*4|0,E=(I+1)*Q*4|0}}function U0(C,M,Q,U,$,j){let q,K,Z,J,G,R,k,A,I,B,y,E=0,L=0;for(I=0;I<U;I++){G=0;for(B=0;B<$;B++){R=j[G++],k=j[G++],A=E+R*4|0,q=K=Z=J=0;for(;k>0;k--)y=j[G++],J=J+y*C[A+3]|0,Z=Z+y*C[A+2]|0,K=K+y*C[A+1]|0,q=q+y*C[A]|0,A=A+4|0;q>>=7,K>>=7,Z>>=7,J>>=7,M[L+3]=b(J+8192>>14),M[L+2]=b(Z+8192>>14),M[L+1]=b(K+8192>>14),M[L]=b(q+8192>>14),L=L+U*4|0}L=(I+1)*4|0,E=(I+1)*Q*4|0}}function q0(C,M,Q,U,$,j){let q,K,Z,J,G,R,k,A,I,B,y,E,L=0,V=0;for(B=0;B<U;B++){R=0;for(y=0;y<$;y++){k=j[R++],A=j[R++],I=L+k*4|0,q=K=Z=J=0;for(;A>0;A--)E=j[R++],G=C[I+3],J=J+E*G|0,Z=Z+E*C[I+2]*G|0,K=K+E*C[I+1]*G|0,q=q+E*C[I]*G|0,I=I+4|0;Z=Z/255|0,K=K/255|0,q=q/255|0,M[V+3]=n(J>>7),M[V+2]=n(Z>>7),M[V+1]=n(K>>7),M[V]=n(q>>7),V=V+U*4|0}V=(B+1)*4|0,L=(B+1)*Q*4|0}}function J0(C,M,Q,U,$,j){let q,K,Z,J,G,R,k,A,I,B,y,E=0,L=0;for(I=0;I<U;I++){G=0;for(B=0;B<$;B++){R=j[G++],k=j[G++],A=E+R*4|0,q=K=Z=J=0;for(;k>0;k--)y=j[G++],J=J+y*C[A+3]|0,Z=Z+y*C[A+2]|0,K=K+y*C[A+1]|0,q=q+y*C[A]|0,A=A+4|0;if(q>>=7,K>>=7,Z>>=7,J>>=7,J=b(J+8192>>14),J>0)q=q*255/J|0,K=K*255/J|0,Z=Z*255/J|0;M[L+3]=J,M[L+2]=b(Z+8192>>14),M[L+1]=b(K+8192>>14),M[L]=b(q+8192>>14),L=L+U*4|0}L=(I+1)*4|0,E=(I+1)*Q*4|0}}function Y0(C,M,Q){let U=3,$=M*Q*4|0;while(U<$){if(C[U]!==255)return!0;U=U+4|0}return!1}function D0(C,M,Q){let U=3,$=M*Q*4|0;while(U<$)C[U]=255,U=U+4|0}function K0(C,M,Q,U,$,j,q,K,Z,J){let G=d(C,Q,$,q,Z),R=d(C,U,j,K,J),k=new Uint8Array($*j*4),A=new Uint16Array($*U*4);if(Y0(M,Q,U))q0(M,A,Q,U,$,G),J0(A,k,U,$,j,R);else M0(M,A,Q,U,$,G),U0(A,k,U,$,j,R),D0(k,$,j);return k}var j0=w0(A0(),1);function m0(C,M,Q){let U=M*Q,$=new Uint16Array(U),j,q,K,Z;for(let J=0;J<U;J++)j=C[4*J],q=C[4*J+1],K=C[4*J+2],Z=j>=q&&j>=K?j:q>=K&&q>=j?q:K,$[J]=Z<<8;return $}function R0(C,M,Q,U,$,j){let q,K,Z,J,G;if(U===0||$<0.5)return;if($>2)$=2;let R=m0(C,M,Q),k=new Uint16Array(R);j0.default(k,M,Q,$);let A=U/100*4096+0.5|0,I=j<<8,B=M*Q;for(let y=0;y<B;y++)if(q=R[y],J=q-k[y],Math.abs(J)>=I)K=q+(A*J+2048>>12),K=K>65280?65280:K,K=K<0?0:K,q=q!==0?q:1,Z=(K<<12)/q|0,G=y*4,C[G]=C[G]*Z+2048>>12,C[G+1]=C[G+1]*Z+2048>>12,C[G+2]=C[G+2]*Z+2048>>12}function L0(C,M,Q,U,$,j,q,K,Z,J,G,R,k){let A=K0(C,M,Q,U,$,j,q,K,Z,J);if(G)R0(A,$,j,G,R,k);return A}var P0=(C,M,Q,U,$,j,q)=>{let K=s(C,M),Z=L0(Q,K,C.width,C.height,C.toWidth,C.toHeight,C.scaleX,C.scaleY,C.offsetX,C.offsetY,U,$,j);e(C,Z,q)};async function I0(C,M,Q,U,$,j,q,K){let Z=M.getContext("2d");if(!Z)throw new Error("Pica: Canvas context is not supported");let J=t(C.width,C.height,Q,M.width,M.height,U);for(let G of J)P0(G,C,$,j,q,K,Z)}async function k0(C,M,Q,U,$,j,q,K){let Z=M,J=new OffscreenCanvas(C[0].toWidth,C[0].toHeight);for(let G=0;G<C.length;G++){await I0(Z,J,Q,U,$,j,q,K);let R=C[G+1];if(!R)break;Z=J,J=new OffscreenCanvas(R.toWidth,R.toHeight)}return J}async function B0(C,M){let Q=M.maxDimension,U=M.tileSize??1024,$=M.unsharpAmount??0,j=M.unsharpRadius??0,q=M.unsharpThreshold??0,K=await createImageBitmap(C),Z=K.width,J=K.height,G=Q/Z,R=Q/J,k=Math.min(G,R,1),A=Math.floor(Z*k),I=Math.floor(J*k),B=3,y=Math.ceil(Math.max(3,2.5*j|0)),E=l(Z,J,A,I,U,y),L={filter:"mks2013",unsharpAmount:$,unsharpRadius:j,unsharpThreshold:q,width:Z,height:J,toWidth:A,toHeight:I,destTileBorder:y};return(await k0(E,K,1024,L.destTileBorder,L.filter,L.unsharpAmount,L.unsharpRadius,L.unsharpThreshold)).transferToImageBitmap()}self.onmessage=async(C)=>{let{taskId:M,blob:Q,options:U}=C.data;try{let $=await B0(Q,U);self.postMessage({taskId:M,output:$},[$])}catch($){self.postMessage({taskId:M,error:$})}};
`,bk=new Blob([Pk],{type:"application/javascript"}),Hk=(()=>{let k=0;return()=>++k})();class yk{#M;#C;#Q;#k;constructor(){this.#M=new Map,this.#C=new Map,this.#Q=new Map,this.#k=new Map}get count(){return this.#M.size}setWorkerTimeout(k,M){let U=setTimeout(()=>{let C=this.#M.get(k);if(C)this.#Q.delete(C);if(C)this.#k.delete(C);this.#C.delete(k),this.#M.delete(k),k.terminate()},M);this.#C.set(k,U)}clearWorkerTimeout(k){clearTimeout(this.#C.get(k))}addWorker(k){this.#M.set(k,null)}getWorker(k){return this.#Q.get(k)}getTask(k){return this.#k.get(k)}getAvailableWorker(){for(let[k,M]of this.#M.entries())if(M===null)return k;return null}assignTask(k,M){this.#M.set(k,M.id),this.#Q.set(M.id,k),this.#k.set(M.id,M);let U={taskId:M.id,blob:M.data.blob,options:M.data.options};k.postMessage(U)}removeTask(k){let M=this.#Q.get(k);if(M)this.#M.set(M,null);this.#Q.delete(k),this.#k.delete(k)}}class c{#M;#C;#Q;#k;constructor(k,M){this.#C=k,this.#M=M,this.#Q=[],this.#k=new yk}#q(){let k=new Worker(URL.createObjectURL(bk));k.onmessage=(M)=>{let{taskId:U,output:C,error:J}=M.data,$=this.#k.getWorker(U),Q=this.#k.getTask(U);if(J){if(Q)Q.reject(J)}else if(Q)Q.resolve(C);if(this.#k.removeTask(U),$)this.#k.setWorkerTimeout($,this.#M);this.#U()},k.onerror=(M)=>{console.log(M.message),console.log(M)},this.#k.addWorker(k)}#U(){let k=this.#k.getAvailableWorker();if(k){let M=this.#Q.shift();if(M)this.#k.assignTask(k,M),this.#k.clearWorkerTimeout(k)}else if(this.#k.count<this.#C)this.#q(),this.#U()}addTask(k){return new Promise((M,U)=>{this.#Q.push({id:Hk(),data:{blob:k.blob,options:k.options},resolve:M,reject:U}),this.#U()})}}class uk{#M;#C;constructor(k){let M=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,U=k.maxWorkerPoolSize||Math.min(M,4),C=k.maxWorkerIdleTime||2000;this.#M=new c(U,C),this.#C=k}squish(k,M){let U=M?{...this.#C,...M}:this.#C;if(U.useMainThread)return Bk(k,U);return this.#M.addTask({blob:k,options:U})}}export{uk as PicSquish};
