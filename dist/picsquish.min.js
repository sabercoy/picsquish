var wk=Object.create;var{getPrototypeOf:Ek,defineProperty:l,getOwnPropertyNames:Ok}=Object;var Vk=Object.prototype.hasOwnProperty;var zk=(k,M,U)=>{U=k!=null?wk(Ek(k)):{};let Q=M||!k||!k.__esModule?l(U,"default",{value:k,enumerable:!0}):U;for(let J of Ok(k))if(!Vk.call(Q,J))l(Q,J,{get:()=>k[J],enumerable:!0});return Q};var Nk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Rk=Nk((lk,Zk)=>{var d,a,s,f,h,p,Ik,Jk;function Yk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,U=Math.exp(-M),Q=Math.exp(-2*M),J=(1-U)*(1-U)/(1+2*M*U-Q);return d=J,a=J*(M-1)*U,s=J*(M+1)*U,f=-J*Q,h=2*U,p=-Q,Ik=(d+a)/(1-h-p),Jk=(s+f)/(1-h-p),new Float32Array([d,a,s,f,h,p,Ik,Jk])}function $k(k,M,U,Q,J,R){var q,K,$,C,I,j,A,Z,G,B,y,n,L,w,z,N,E,V,X,m,Y,O,D,T,v,u,W,F,S,P;for(v=0;v<R;v++){O=v*J,D=v,T=0,q=k[O],K=q&255,$=q>>8&255,C=q>>16&255,I=q>>24&255,V=K*Q[6],X=$*Q[6],m=C*Q[6],Y=I*Q[6],w=V,z=X,N=m,E=Y,W=Q[0],F=Q[1],S=Q[4],P=Q[5];for(u=0;u<J;u++)q=k[O],j=q&255,A=q>>8&255,Z=q>>16&255,G=q>>24&255,B=j*W+K*F+w*S+V*P,y=A*W+$*F+z*S+X*P,n=Z*W+C*F+N*S+m*P,L=G*W+I*F+E*S+Y*P,V=w,X=z,m=N,Y=E,w=B,z=y,N=n,E=L,K=j,$=A,C=Z,I=G,U[T]=w,U[T+1]=z,U[T+2]=N,U[T+3]=E,T+=4,O++;O--,T-=4,D+=R*(J-1),q=k[O],K=q&255,$=q>>8&255,C=q>>16&255,I=q>>24&255,V=K*Q[7],X=$*Q[7],m=C*Q[7],Y=I*Q[7],w=V,z=X,N=m,E=Y,j=K,A=$,Z=C,G=I,W=Q[2],F=Q[3];for(u=J-1;u>=0;u--)B=j*W+K*F+w*S+V*P,y=A*W+$*F+z*S+X*P,n=Z*W+C*F+N*S+m*P,L=G*W+I*F+E*S+Y*P,V=w,X=z,m=N,Y=E,w=B,z=y,N=n,E=L,K=j,$=A,C=Z,I=G,q=k[O],j=q&255,A=q>>8&255,Z=q>>16&255,G=q>>24&255,q=(U[T]+w<<0)+(U[T+1]+z<<8)+(U[T+2]+N<<16)+(U[T+3]+E<<24),M[D]=q,O--,T-=4,D-=R}}function Wk(k,M,U,Q){if(!Q)return;var J=new Uint32Array(k.buffer),R=new Uint32Array(J.length),q=new Float32Array(Math.max(M,U)*4),K=Yk(Q);$k(J,R,q,K,M,U,Q),$k(R,J,q,K,U,M,Q)}Zk.exports=Wk});var Tk=2;function _(k,M,U,Q,J,R){let q=U/k,K=Q/M,$=(2*R+Tk+1)/J;if($>0.5)return[{toWidth:U,toHeight:Q}];let C=Math.ceil(Math.log(Math.min(q,K))/Math.log($));if(C<=1)return[{toWidth:U,toHeight:Q}];let I=[];for(let j=0;j<C;j++){let A=Math.round(Math.pow(Math.pow(k,C-j-1)*Math.pow(U,j+1),1/C)),Z=Math.round(Math.pow(Math.pow(M,C-j-1)*Math.pow(Q,j+1),1/C));I.push({toWidth:A,toHeight:Z})}return I}var r=0.00001;function x(k){let M=Math.round(k);if(Math.abs(k-M)<r)return M;return Math.floor(k)}function i(k){let M=Math.round(k);if(Math.abs(k-M)<r)return M;return Math.ceil(k)}function t(k,M,U,Q,J,R){let q=Q/k,K=J/M,$=x(U*q)-2*R,C=x(U*K)-2*R;if($<1||C<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let I,j,A,Z,G,B,y=[];for(Z=0;Z<J;Z+=C)for(A=0;A<Q;A+=$){if(I=A-R,I<0)I=0;if(G=A+$+R-I,I+G>=Q)G=Q-I;if(j=Z-R,j<0)j=0;if(B=Z+C+R-j,j+B>=J)B=J-j;y.push({toX:I,toY:j,toWidth:G,toHeight:B,toInnerX:A,toInnerY:Z,toInnerWidth:$,toInnerHeight:C,offsetX:I/q-x(I/q),offsetY:j/K-x(j/K),scaleX:q,scaleY:K,x:x(I/q),y:x(j/K),width:i(G/q),height:i(B/K)})}return y}function e(k,M,U){let Q=new ImageData(new Uint8ClampedArray(M),k.toWidth,k.toHeight),J=!1;U.putImageData(Q,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth,k.toInnerHeight)}function kk(k,M){let Q=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!Q)throw new Error("PicSquish: Canvas context is not supported");return Q.globalCompositeOperation="copy",Q.drawImage(M,k.x,k.y,k.width,k.height,0,0,k.width,k.height),Q.getImageData(0,0,k.width,k.height).data}var g={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var mk=14;function Mk(k){return Math.round(k*((1<<mk)-1))}function o(k,M,U,Q,J){let R=g[k].fn,q=1/Q,K=Math.min(1,Q),$=g[k].win/K,C,I,j,A,Z,G,B,y,n,L,w,z,N,E,V,X,m,Y=Math.floor(($+1)*2),O=new Int16Array((Y+2)*U),D=0,T=!O.subarray||!O.set;for(C=0;C<U;C++){I=(C+0.5)*q+J,j=Math.max(0,Math.floor(I-$)),A=Math.min(M-1,Math.ceil(I+$)),Z=A-j+1,G=new Float32Array(Z),B=new Int16Array(Z),y=0;for(n=j,L=0;n<=A;n++,L++)w=R((n+0.5-I)*K),y+=w,G[L]=w;z=0;for(L=0;L<G.length;L++)N=G[L]/y,z+=N,B[L]=Mk(N);B[U>>1]+=Mk(1-z),E=0;while(E<B.length&&B[E]===0)E++;if(E<B.length){V=B.length-1;while(V>0&&B[V]===0)V--;if(X=j+E,m=V-E+1,O[D++]=X,O[D++]=m,!T)O.set(B.subarray(E,V+1),D),D+=m;else for(L=E;L<=V;L++)O[D++]=B[L]}else O[D++]=0,O[D++]=0}return O}function H(k){return k<0?0:k>255?255:k}function b(k){return k>=0?k:0}function Qk(k,M,U,Q,J,R){let q,K,$,C,I,j,A,Z,G,B,y,n=0,L=0;for(G=0;G<Q;G++){I=0;for(B=0;B<J;B++){j=R[I++],A=R[I++],Z=n+j*4|0,q=K=$=C=0;for(;A>0;A--)y=R[I++],C=C+y*k[Z+3]|0,$=$+y*k[Z+2]|0,K=K+y*k[Z+1]|0,q=q+y*k[Z]|0,Z=Z+4|0;M[L+3]=b(C>>7),M[L+2]=b($>>7),M[L+1]=b(K>>7),M[L]=b(q>>7),L=L+Q*4|0}L=(G+1)*4|0,n=(G+1)*U*4|0}}function qk(k,M,U,Q,J,R){let q,K,$,C,I,j,A,Z,G,B,y,n=0,L=0;for(G=0;G<Q;G++){I=0;for(B=0;B<J;B++){j=R[I++],A=R[I++],Z=n+j*4|0,q=K=$=C=0;for(;A>0;A--)y=R[I++],C=C+y*k[Z+3]|0,$=$+y*k[Z+2]|0,K=K+y*k[Z+1]|0,q=q+y*k[Z]|0,Z=Z+4|0;q>>=7,K>>=7,$>>=7,C>>=7,M[L+3]=H(C+8192>>14),M[L+2]=H($+8192>>14),M[L+1]=H(K+8192>>14),M[L]=H(q+8192>>14),L=L+Q*4|0}L=(G+1)*4|0,n=(G+1)*U*4|0}}function Uk(k,M,U,Q,J,R){let q,K,$,C,I,j,A,Z,G,B,y,n,L=0,w=0;for(B=0;B<Q;B++){j=0;for(y=0;y<J;y++){A=R[j++],Z=R[j++],G=L+A*4|0,q=K=$=C=0;for(;Z>0;Z--)n=R[j++],I=k[G+3],C=C+n*I|0,$=$+n*k[G+2]*I|0,K=K+n*k[G+1]*I|0,q=q+n*k[G]*I|0,G=G+4|0;$=$/255|0,K=K/255|0,q=q/255|0,M[w+3]=b(C>>7),M[w+2]=b($>>7),M[w+1]=b(K>>7),M[w]=b(q>>7),w=w+Q*4|0}w=(B+1)*4|0,L=(B+1)*U*4|0}}function Ck(k,M,U,Q,J,R){let q,K,$,C,I,j,A,Z,G,B,y,n=0,L=0;for(G=0;G<Q;G++){I=0;for(B=0;B<J;B++){j=R[I++],A=R[I++],Z=n+j*4|0,q=K=$=C=0;for(;A>0;A--)y=R[I++],C=C+y*k[Z+3]|0,$=$+y*k[Z+2]|0,K=K+y*k[Z+1]|0,q=q+y*k[Z]|0,Z=Z+4|0;if(q>>=7,K>>=7,$>>=7,C>>=7,C=H(C+8192>>14),C>0)q=q*255/C|0,K=K*255/C|0,$=$*255/C|0;M[L+3]=C,M[L+2]=H($+8192>>14),M[L+1]=H(K+8192>>14),M[L]=H(q+8192>>14),L=L+Q*4|0}L=(G+1)*4|0,n=(G+1)*U*4|0}}function Dk(k,M,U){let Q=3,J=M*U*4|0;while(Q<J){if(k[Q]!==255)return!0;Q=Q+4|0}return!1}function Xk(k,M,U){let Q=3,J=M*U*4|0;while(Q<J)k[Q]=255,Q=Q+4|0}function Kk(k,M,U,Q,J,R,q,K,$,C){let I=o(k,U,J,q,$),j=o(k,Q,R,K,C),A=new Uint8Array(J*R*4),Z=new Uint16Array(J*Q*4);if(Dk(M,U,Q))Uk(M,Z,U,Q,J,I),Ck(Z,A,Q,J,R,j);else Qk(M,Z,U,Q,J,I),qk(Z,A,Q,J,R,j),Xk(A,J,R);return A}var jk=zk(Rk(),1);function Fk(k,M,U){let Q=M*U,J=new Uint16Array(Q),R,q,K,$;for(let C=0;C<Q;C++)R=k[4*C],q=k[4*C+1],K=k[4*C+2],$=R>=q&&R>=K?R:q>=K&&q>=R?q:K,J[C]=$<<8;return J}function Gk(k,M,U,Q,J,R){let q,K,$,C,I;if(Q===0||J<0.5)return;if(J>2)J=2;let j=Fk(k,M,U),A=new Uint16Array(j);jk.default(A,M,U,J);let Z=Q/100*4096+0.5|0,G=R<<8,B=M*U;for(let y=0;y<B;y++)if(q=j[y],C=q-A[y],Math.abs(C)>=G)K=q+(Z*C+2048>>12),K=K>65280?65280:K,K=K<0?0:K,q=q!==0?q:1,$=(K<<12)/q|0,I=y*4,k[I]=k[I]*$+2048>>12,k[I+1]=k[I+1]*$+2048>>12,k[I+2]=k[I+2]*$+2048>>12}function Ak(k,M,U,Q,J,R,q,K,$,C,I,j,A){let Z=Kk(k,M,U,Q,J,R,q,K,$,C);if(I)Gk(Z,J,R,I,j,A);return Z}var Lk=(k,M,U,Q,J,R)=>{let q=kk(k,M);return Ak(U,q,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY,Q,J,R)};async function Bk(k,M,U,Q,J,R,q,K){let $=M,C=new OffscreenCanvas(k[0].toWidth,k[0].toHeight);for(let I=0;I<k.length;I++){let j=C.getContext("2d");if(!j)throw new Error("PicSquish: Canvas context is not supported");let A=t($.width,$.height,U,C.width,C.height,Q);for(let G of A){let B=Lk(G,$,J,R,q,K);e(G,B,j)}let Z=k[I+1];if(!Z)break;$=C,C=new OffscreenCanvas(Z.toWidth,Z.toHeight)}return C}async function yk(k,M){let U=M.maxDimension,Q=M.tileSize||1024,J=M.filter||"mks2013",R=M.unsharpAmount||0,q=M.unsharpRadius||0,K=M.unsharpThreshold||0,$=await createImageBitmap(k),C=$.width,I=$.height,j=U/C,A=U/I,Z=Math.min(j,A,1),G=Math.floor(C*Z),B=Math.floor(I*Z),y=3,n=Math.ceil(Math.max(3,2.5*q|0)),L=_(C,I,G,B,Q,n);return(await Bk(L,$,Q,n,J,R,q,K)).transferToImageBitmap()}var Sk=`
var y0=Object.create;var{getPrototypeOf:E0,defineProperty:_,getOwnPropertyNames:V0}=Object;var N0=Object.prototype.hasOwnProperty;var w0=(q,M,$)=>{$=q!=null?y0(E0(q)):{};let U=M||!q||!q.__esModule?_($,"default",{value:q,enumerable:!0}):$;for(let Z of V0(q))if(!N0.call(U,Z))_(U,Z,{get:()=>q[Z],enumerable:!0});return U};var z0=(q,M)=>()=>(M||q((M={exports:{}}).exports,M),M.exports);var j0=z0((d0,G0)=>{var f,o,a,c,h,g,$0,C0;function F0(q){if(q<0.5)q=0.5;var M=Math.exp(0.527076)/q,$=Math.exp(-M),U=Math.exp(-2*M),Z=(1-$)*(1-$)/(1+2*M*$-U);return f=Z,o=Z*(M-1)*$,a=Z*(M+1)*$,c=-Z*U,h=2*$,g=-U,$0=(f+o)/(1-h-g),C0=(a+c)/(1-h-g),new Float32Array([f,o,a,c,h,g,$0,C0])}function Z0(q,M,$,U,Z,L){var J,Q,G,K,C,A,I,j,R,B,y,E,k,V,O,X,N,z,S,D,P,w,F,Y,v,x,m,H,W,T;for(v=0;v<L;v++){w=v*Z,F=v,Y=0,J=q[w],Q=J&255,G=J>>8&255,K=J>>16&255,C=J>>24&255,z=Q*U[6],S=G*U[6],D=K*U[6],P=C*U[6],V=z,O=S,X=D,N=P,m=U[0],H=U[1],W=U[4],T=U[5];for(x=0;x<Z;x++)J=q[w],A=J&255,I=J>>8&255,j=J>>16&255,R=J>>24&255,B=A*m+Q*H+V*W+z*T,y=I*m+G*H+O*W+S*T,E=j*m+K*H+X*W+D*T,k=R*m+C*H+N*W+P*T,z=V,S=O,D=X,P=N,V=B,O=y,X=E,N=k,Q=A,G=I,K=j,C=R,$[Y]=V,$[Y+1]=O,$[Y+2]=X,$[Y+3]=N,Y+=4,w++;w--,Y-=4,F+=L*(Z-1),J=q[w],Q=J&255,G=J>>8&255,K=J>>16&255,C=J>>24&255,z=Q*U[7],S=G*U[7],D=K*U[7],P=C*U[7],V=z,O=S,X=D,N=P,A=Q,I=G,j=K,R=C,m=U[2],H=U[3];for(x=Z-1;x>=0;x--)B=A*m+Q*H+V*W+z*T,y=I*m+G*H+O*W+S*T,E=j*m+K*H+X*W+D*T,k=R*m+C*H+N*W+P*T,z=V,S=O,D=X,P=N,V=B,O=y,X=E,N=k,Q=A,G=I,K=j,C=R,J=q[w],A=J&255,I=J>>8&255,j=J>>16&255,R=J>>24&255,J=($[Y]+V<<0)+($[Y+1]+O<<8)+($[Y+2]+X<<16)+($[Y+3]+N<<24),M[F]=J,w--,Y-=4,F-=L}}function S0(q,M,$,U){if(!U)return;var Z=new Uint32Array(q.buffer),L=new Uint32Array(Z.length),J=new Float32Array(Math.max(M,$)*4),Q=F0(U);Z0(Z,L,J,Q,M,$,U),Z0(L,Z,J,Q,$,M,U)}G0.exports=S0});var O0=2;function l(q,M,$,U,Z,L){let J=$/q,Q=U/M,G=(2*L+O0+1)/Z;if(G>0.5)return[{toWidth:$,toHeight:U}];let K=Math.ceil(Math.log(Math.min(J,Q))/Math.log(G));if(K<=1)return[{toWidth:$,toHeight:U}];let C=[];for(let A=0;A<K;A++){let I=Math.round(Math.pow(Math.pow(q,K-A-1)*Math.pow($,A+1),1/K)),j=Math.round(Math.pow(Math.pow(M,K-A-1)*Math.pow(U,A+1),1/K));C.push({toWidth:I,toHeight:j})}return C}var i=0.00001;function u(q){let M=Math.round(q);if(Math.abs(q-M)<i)return M;return Math.floor(q)}function s(q){let M=Math.round(q);if(Math.abs(q-M)<i)return M;return Math.ceil(q)}function r(q,M,$,U,Z,L){let J=U/q,Q=Z/M,G=u($*J)-2*L,K=u($*Q)-2*L;if(G<1||K<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let C,A,I,j,R,B,y=[];for(j=0;j<Z;j+=K)for(I=0;I<U;I+=G){if(C=I-L,C<0)C=0;if(R=I+G+L-C,C+R>=U)R=U-C;if(A=j-L,A<0)A=0;if(B=j+K+L-A,A+B>=Z)B=Z-A;y.push({toX:C,toY:A,toWidth:R,toHeight:B,toInnerX:I,toInnerY:j,toInnerWidth:G,toInnerHeight:K,offsetX:C/J-u(C/J),offsetY:A/Q-u(A/Q),scaleX:J,scaleY:Q,x:u(C/J),y:u(A/Q),width:s(R/J),height:s(B/Q)})}return y}function t(q,M,$){let U=new ImageData(new Uint8ClampedArray(M),q.toWidth,q.toHeight),Z=!1;$.putImageData(U,q.toX,q.toY,q.toInnerX-q.toX,q.toInnerY-q.toY,q.toInnerWidth,q.toInnerHeight)}function e(q,M){let U=new OffscreenCanvas(q.width,q.height).getContext("2d");if(!U)throw new Error("PicSquish: Canvas context is not supported");return U.globalCompositeOperation="copy",U.drawImage(M,q.x,q.y,q.width,q.height,0,0,q.width,q.height),U.getImageData(0,0,q.width,q.height).data}var p={box:{win:0.5,fn:(q)=>{if(q<0)q=-q;return q<0.5?1:0}},hamming:{win:1,fn:(q)=>{if(q<0)q=-q;if(q>=1)return 0;if(q<0.00000011920929)return 1;let M=q*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(q)=>{if(q<0)q=-q;if(q>=2)return 0;if(q<0.00000011920929)return 1;let M=q*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(q)=>{if(q<0)q=-q;if(q>=3)return 0;if(q<0.00000011920929)return 1;let M=q*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(q)=>{if(q<0)q=-q;if(q>=2.5)return 0;if(q>=1.5)return-0.125*(q-2.5)*(q-2.5);if(q>=0.5)return 0.25*(4*q*q-11*q+7);return 1.0625-1.75*q*q}}};var X0=14;function q0(q){return Math.round(q*((1<<X0)-1))}function d(q,M,$,U,Z){let L=p[q].fn,J=1/U,Q=Math.min(1,U),G=p[q].win/Q,K,C,A,I,j,R,B,y,E,k,V,O,X,N,z,S,D,P=Math.floor((G+1)*2),w=new Int16Array((P+2)*$),F=0,Y=!w.subarray||!w.set;for(K=0;K<$;K++){C=(K+0.5)*J+Z,A=Math.max(0,Math.floor(C-G)),I=Math.min(M-1,Math.ceil(C+G)),j=I-A+1,R=new Float32Array(j),B=new Int16Array(j),y=0;for(E=A,k=0;E<=I;E++,k++)V=L((E+0.5-C)*Q),y+=V,R[k]=V;O=0;for(k=0;k<R.length;k++)X=R[k]/y,O+=X,B[k]=q0(X);B[$>>1]+=q0(1-O),N=0;while(N<B.length&&B[N]===0)N++;if(N<B.length){z=B.length-1;while(z>0&&B[z]===0)z--;if(S=A+N,D=z-N+1,w[F++]=S,w[F++]=D,!Y)w.set(B.subarray(N,z+1),F),F+=D;else for(k=N;k<=z;k++)w[F++]=B[k]}else w[F++]=0,w[F++]=0}return w}function b(q){return q<0?0:q>255?255:q}function n(q){return q>=0?q:0}function M0(q,M,$,U,Z,L){let J,Q,G,K,C,A,I,j,R,B,y,E=0,k=0;for(R=0;R<U;R++){C=0;for(B=0;B<Z;B++){A=L[C++],I=L[C++],j=E+A*4|0,J=Q=G=K=0;for(;I>0;I--)y=L[C++],K=K+y*q[j+3]|0,G=G+y*q[j+2]|0,Q=Q+y*q[j+1]|0,J=J+y*q[j]|0,j=j+4|0;M[k+3]=n(K>>7),M[k+2]=n(G>>7),M[k+1]=n(Q>>7),M[k]=n(J>>7),k=k+U*4|0}k=(R+1)*4|0,E=(R+1)*$*4|0}}function U0(q,M,$,U,Z,L){let J,Q,G,K,C,A,I,j,R,B,y,E=0,k=0;for(R=0;R<U;R++){C=0;for(B=0;B<Z;B++){A=L[C++],I=L[C++],j=E+A*4|0,J=Q=G=K=0;for(;I>0;I--)y=L[C++],K=K+y*q[j+3]|0,G=G+y*q[j+2]|0,Q=Q+y*q[j+1]|0,J=J+y*q[j]|0,j=j+4|0;J>>=7,Q>>=7,G>>=7,K>>=7,M[k+3]=b(K+8192>>14),M[k+2]=b(G+8192>>14),M[k+1]=b(Q+8192>>14),M[k]=b(J+8192>>14),k=k+U*4|0}k=(R+1)*4|0,E=(R+1)*$*4|0}}function J0(q,M,$,U,Z,L){let J,Q,G,K,C,A,I,j,R,B,y,E,k=0,V=0;for(B=0;B<U;B++){A=0;for(y=0;y<Z;y++){I=L[A++],j=L[A++],R=k+I*4|0,J=Q=G=K=0;for(;j>0;j--)E=L[A++],C=q[R+3],K=K+E*C|0,G=G+E*q[R+2]*C|0,Q=Q+E*q[R+1]*C|0,J=J+E*q[R]*C|0,R=R+4|0;G=G/255|0,Q=Q/255|0,J=J/255|0,M[V+3]=n(K>>7),M[V+2]=n(G>>7),M[V+1]=n(Q>>7),M[V]=n(J>>7),V=V+U*4|0}V=(B+1)*4|0,k=(B+1)*$*4|0}}function K0(q,M,$,U,Z,L){let J,Q,G,K,C,A,I,j,R,B,y,E=0,k=0;for(R=0;R<U;R++){C=0;for(B=0;B<Z;B++){A=L[C++],I=L[C++],j=E+A*4|0,J=Q=G=K=0;for(;I>0;I--)y=L[C++],K=K+y*q[j+3]|0,G=G+y*q[j+2]|0,Q=Q+y*q[j+1]|0,J=J+y*q[j]|0,j=j+4|0;if(J>>=7,Q>>=7,G>>=7,K>>=7,K=b(K+8192>>14),K>0)J=J*255/K|0,Q=Q*255/K|0,G=G*255/K|0;M[k+3]=K,M[k+2]=b(G+8192>>14),M[k+1]=b(Q+8192>>14),M[k]=b(J+8192>>14),k=k+U*4|0}k=(R+1)*4|0,E=(R+1)*$*4|0}}function Y0(q,M,$){let U=3,Z=M*$*4|0;while(U<Z){if(q[U]!==255)return!0;U=U+4|0}return!1}function D0(q,M,$){let U=3,Z=M*$*4|0;while(U<Z)q[U]=255,U=U+4|0}function Q0(q,M,$,U,Z,L,J,Q,G,K){let C=d(q,$,Z,J,G),A=d(q,U,L,Q,K),I=new Uint8Array(Z*L*4),j=new Uint16Array(Z*U*4);if(Y0(M,$,U))J0(M,j,$,U,Z,C),K0(j,I,U,Z,L,A);else M0(M,j,$,U,Z,C),U0(j,I,U,Z,L,A),D0(I,Z,L);return I}var A0=w0(j0(),1);function P0(q,M,$){let U=M*$,Z=new Uint16Array(U),L,J,Q,G;for(let K=0;K<U;K++)L=q[4*K],J=q[4*K+1],Q=q[4*K+2],G=L>=J&&L>=Q?L:J>=Q&&J>=L?J:Q,Z[K]=G<<8;return Z}function L0(q,M,$,U,Z,L){let J,Q,G,K,C;if(U===0||Z<0.5)return;if(Z>2)Z=2;let A=P0(q,M,$),I=new Uint16Array(A);A0.default(I,M,$,Z);let j=U/100*4096+0.5|0,R=L<<8,B=M*$;for(let y=0;y<B;y++)if(J=A[y],K=J-I[y],Math.abs(K)>=R)Q=J+(j*K+2048>>12),Q=Q>65280?65280:Q,Q=Q<0?0:Q,J=J!==0?J:1,G=(Q<<12)/J|0,C=y*4,q[C]=q[C]*G+2048>>12,q[C+1]=q[C+1]*G+2048>>12,q[C+2]=q[C+2]*G+2048>>12}function R0(q,M,$,U,Z,L,J,Q,G,K,C,A,I){let j=Q0(q,M,$,U,Z,L,J,Q,G,K);if(C)L0(j,Z,L,C,A,I);return j}var I0=(q,M,$,U,Z,L)=>{let J=e(q,M);return R0($,J,q.width,q.height,q.toWidth,q.toHeight,q.scaleX,q.scaleY,q.offsetX,q.offsetY,U,Z,L)};async function k0(q,M,$,U,Z,L,J,Q){let G=M,K=new OffscreenCanvas(q[0].toWidth,q[0].toHeight);for(let C=0;C<q.length;C++){let A=K.getContext("2d");if(!A)throw new Error("PicSquish: Canvas context is not supported");let I=r(G.width,G.height,$,K.width,K.height,U);for(let R of I){let B=I0(R,G,Z,L,J,Q);t(R,B,A)}let j=q[C+1];if(!j)break;G=K,K=new OffscreenCanvas(j.toWidth,j.toHeight)}return K}async function B0(q,M){let $=M.maxDimension,U=M.tileSize||1024,Z=M.filter||"mks2013",L=M.unsharpAmount||0,J=M.unsharpRadius||0,Q=M.unsharpThreshold||0,G=await createImageBitmap(q),K=G.width,C=G.height,A=$/K,I=$/C,j=Math.min(A,I,1),R=Math.floor(K*j),B=Math.floor(C*j),y=3,E=Math.ceil(Math.max(3,2.5*J|0)),k=l(K,C,R,B,U,E);return(await k0(k,G,U,E,Z,L,J,Q)).transferToImageBitmap()}self.onmessage=async(q)=>{let{taskId:M,blob:$,options:U}=q.data;try{let Z=await B0($,U);self.postMessage({taskId:M,output:Z},[Z])}catch(Z){self.postMessage({taskId:M,error:Z})}};
`,Pk=new Blob([Sk],{type:"application/javascript"}),Hk=(()=>{let k=0;return()=>++k})();class nk{#M;#Q;#q;#k;constructor(){this.#M=new Map,this.#Q=new Map,this.#q=new Map,this.#k=new Map}get count(){return this.#M.size}setWorkerTimeout(k,M){let U=setTimeout(()=>{let Q=this.#M.get(k);if(Q)this.#q.delete(Q);if(Q)this.#k.delete(Q);this.#Q.delete(k),this.#M.delete(k),k.terminate()},M);this.#Q.set(k,U)}clearWorkerTimeout(k){clearTimeout(this.#Q.get(k))}addWorker(k){this.#M.set(k,null)}getWorker(k){return this.#q.get(k)}getTask(k){return this.#k.get(k)}getAvailableWorker(){for(let[k,M]of this.#M.entries())if(M===null)return k;return null}assignTask(k,M){this.#M.set(k,M.id),this.#q.set(M.id,k),this.#k.set(M.id,M);let U={taskId:M.id,blob:M.data.blob,options:M.data.options};k.postMessage(U)}removeTask(k){let M=this.#q.get(k);if(M)this.#M.set(M,null);this.#q.delete(k),this.#k.delete(k)}}class c{#M;#Q;#q;#k;constructor(k,M){this.#Q=k,this.#M=M,this.#q=[],this.#k=new nk}#C(){let k=new Worker(URL.createObjectURL(Pk));k.onmessage=(M)=>{let{taskId:U,output:Q,error:J}=M.data,R=this.#k.getWorker(U),q=this.#k.getTask(U);if(J){if(q)q.reject(J)}else if(q)q.resolve(Q);if(this.#k.removeTask(U),R)this.#k.setWorkerTimeout(R,this.#M);this.#U()},k.onerror=(M)=>{console.log(M.message),console.log(M)},this.#k.addWorker(k)}#U(){let k=this.#k.getAvailableWorker();if(k){let M=this.#q.shift();if(M)this.#k.assignTask(k,M),this.#k.clearWorkerTimeout(k)}else if(this.#k.count<this.#Q)this.#C(),this.#U()}addTask(k){return new Promise((M,U)=>{this.#q.push({id:Hk(),data:k,resolve:M,reject:U}),this.#U()})}}class bk{#M;#Q;constructor(k){let M=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,U=k.maxWorkerPoolSize||Math.min(M,4),Q=k.maxWorkerIdleTime||2000;this.#M=new c(U,Q),this.#Q=k}squish(k,M){let U=M?{...this.#Q,...M}:this.#Q;if(U.useMainThread)return yk(k,U);return this.#M.addTask({blob:k,options:U})}}export{bk as PicSquish};
