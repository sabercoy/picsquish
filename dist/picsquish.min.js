var X8=Object.create;var{getPrototypeOf:Y8,defineProperty:i,getOwnPropertyNames:y8}=Object;var z8=Object.prototype.hasOwnProperty;var F8=(U,J,K)=>{K=U!=null?X8(Y8(U)):{};let $=J||!U||!U.__esModule?i(K,"default",{value:U,enumerable:!0}):K;for(let G of y8(U))if(!z8.call($,G))i($,G,{get:()=>U[G],enumerable:!0});return $};var S8=(U,J)=>()=>(J||U((J={exports:{}}).exports,J),J.exports);var R8=S8((JU,B8)=>{var f,l,a,o,n,d,M8,Q8;function P8(U){if(U<0.5)U=0.5;var J=Math.exp(0.527076)/U,K=Math.exp(-J),$=Math.exp(-2*J),G=(1-K)*(1-K)/(1+2*J*K-$);return f=G,l=G*(J-1)*K,a=G*(J+1)*K,o=-G*$,n=2*K,d=-$,M8=(f+l)/(1-n-d),Q8=(a+o)/(1-n-d),new Float32Array([f,l,a,o,n,d,M8,Q8])}function D8(U,J,K,$,G,A){var Z,j,M,L,Q,D,R,B,N,E,V,C,q,X,y,S,Y,z,P,w,W,F,H,I,g,u,b,T,k,v;for(g=0;g<A;g++){F=g*G,H=g,I=0,Z=U[F],j=Z&255,M=Z>>8&255,L=Z>>16&255,Q=Z>>24&255,z=j*$[6],P=M*$[6],w=L*$[6],W=Q*$[6],X=z,y=P,S=w,Y=W,b=$[0],T=$[1],k=$[4],v=$[5];for(u=0;u<G;u++)Z=U[F],D=Z&255,R=Z>>8&255,B=Z>>16&255,N=Z>>24&255,E=D*b+j*T+X*k+z*v,V=R*b+M*T+y*k+P*v,C=B*b+L*T+S*k+w*v,q=N*b+Q*T+Y*k+W*v,z=X,P=y,w=S,W=Y,X=E,y=V,S=C,Y=q,j=D,M=R,L=B,Q=N,K[I]=X,K[I+1]=y,K[I+2]=S,K[I+3]=Y,I+=4,F++;F--,I-=4,H+=A*(G-1),Z=U[F],j=Z&255,M=Z>>8&255,L=Z>>16&255,Q=Z>>24&255,z=j*$[7],P=M*$[7],w=L*$[7],W=Q*$[7],X=z,y=P,S=w,Y=W,D=j,R=M,B=L,N=Q,b=$[2],T=$[3];for(u=G-1;u>=0;u--)E=D*b+j*T+X*k+z*v,V=R*b+M*T+y*k+P*v,C=B*b+L*T+S*k+w*v,q=N*b+Q*T+Y*k+W*v,z=X,P=y,w=S,W=Y,X=E,y=V,S=C,Y=q,j=D,M=R,L=B,Q=N,Z=U[F],D=Z&255,R=Z>>8&255,B=Z>>16&255,N=Z>>24&255,Z=(K[I]+X<<0)+(K[I+1]+y<<8)+(K[I+2]+S<<16)+(K[I+3]+Y<<24),J[H]=Z,F--,I-=4,H-=A}}function W8(U,J,K,$){if(!$)return;var G=new Uint32Array(U.buffer),A=new Uint32Array(G.length),Z=new Float32Array(Math.max(J,K)*4),j=P8($);D8(G,A,Z,j,J,K,$),D8(A,G,Z,j,K,J,$)}B8.exports=W8});var I8=2;function r(U,J,K,$,G,A){let Z=K/U,j=$/J,M=(2*A+I8+1)/G;if(M>0.5)return[{toWidth:K,toHeight:$}];let L=Math.ceil(Math.log(Math.min(Z,j))/Math.log(M));if(L<=1)return[{toWidth:K,toHeight:$}];let Q=[];for(let D=0;D<L;D++){let R=Math.round(Math.pow(Math.pow(U,L-D-1)*Math.pow(K,D+1),1/L)),B=Math.round(Math.pow(Math.pow(J,L-D-1)*Math.pow($,D+1),1/L));Q.push({toWidth:R,toHeight:B})}return Q}function t(U,J,K){let $=new Uint8ClampedArray(K.width*K.height*O);for(let G=0;G<K.height;G++){let A=((K.y+G)*J+K.x)*O,Z=G*K.width*O;$.set(U.subarray(A,A+K.width*O),Z)}return $}var U8=0.00001;function h(U){let J=Math.round(U);if(Math.abs(U-J)<U8)return J;return Math.floor(U)}function e(U){let J=Math.round(U);if(Math.abs(U-J)<U8)return J;return Math.ceil(U)}function J8(U,J,K,$,G,A,Z,j,M,L,Q){let D=$/J,R=G/K,B=h(A*D)-2*Z,N=h(A*R)-2*Z;if(console.log(U,J,K,$,G,A,Z),console.log(B,N),B<1||N<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let E,V,C,q,X,y,S=[];for(q=0;q<G;q+=N)for(C=0;C<$;C+=B){if(E=C-Z,E<0)E=0;if(X=C+B+Z-E,E+X>=$)X=$-E;if(V=q-Z,V<0)V=0;if(y=q+N+Z-V,V+y>=G)y=G-V;let Y={toX:E,toY:V,toWidth:X,toHeight:y,toInnerX:C,toInnerY:q,toInnerWidth:B,toInnerHeight:N,offsetX:E/D-h(E/D),offsetY:V/R-h(V/R),scaleX:D,scaleY:R,x:h(E/D),y:h(V/R),width:e(X/D),height:e(y/R),initialSize:A,filterPadding:Z,filter:j,unsharpAmount:M,unsharpRadius:L,unsharpThreshold:Q},z=t(U,J,Y);S.push({tile:z.buffer,...Y})}return S}var O=4;async function K8(U,J,K){let $,G,A,Z,j,M;if(U instanceof Blob){let Q=await createImageBitmap(U),R=new OffscreenCanvas(Q.width,Q.height).getContext("2d");if(!R)throw new Error("Canvas 2D context not supported");R.drawImage(Q,0,0),$=R.getImageData(0,0,Q.width,Q.height).data,G=Q.width,A=Q.height;let N=J/G,E=J/A,V=Math.min(N,E,1),C=Math.floor(G*V),q=Math.floor(A*V);M=r(G,A,C,q,K.initialSize,K.filterPadding)}else $=U.from,G=U.fromWidth,A=U.fromHeight,M=U.stages;Z=M[0].toWidth,j=M[0].toHeight;let L=J8($,G,A,Z,j,K.initialSize,K.filterPadding,K.filter,K.unsharpAmount,K.unsharpRadius,K.unsharpThreshold);return{from:$.buffer,fromWidth:G,fromHeight:A,tileTransforms:L,stages:M}}function p(U,J,K){let $=new Uint8ClampedArray(K.tile);for(let G=0;G<K.toHeight;G++){let A=G*K.toWidth*O,Z=((K.toY+G)*J+K.toX)*O;U.set($.subarray(A,A+K.toWidth*O),Z)}}var _={box:{win:0.5,fn:(U)=>{if(U<0)U=-U;return U<0.5?1:0}},hamming:{win:1,fn:(U)=>{if(U<0)U=-U;if(U>=1)return 0;if(U<0.00000011920929)return 1;let J=U*Math.PI;return Math.sin(J)/J*(0.54+0.46*Math.cos(J/1))}},lanczos2:{win:2,fn:(U)=>{if(U<0)U=-U;if(U>=2)return 0;if(U<0.00000011920929)return 1;let J=U*Math.PI;return Math.sin(J)/J*Math.sin(J/2)/(J/2)}},lanczos3:{win:3,fn:(U)=>{if(U<0)U=-U;if(U>=3)return 0;if(U<0.00000011920929)return 1;let J=U*Math.PI;return Math.sin(J)/J*Math.sin(J/3)/(J/3)}},mks2013:{win:2.5,fn:(U)=>{if(U<0)U=-U;if(U>=2.5)return 0;if(U>=1.5)return-0.125*(U-2.5)*(U-2.5);if(U>=0.5)return 0.25*(4*U*U-11*U+7);return 1.0625-1.75*U*U}}};var O8=14;function $8(U){return Math.round(U*((1<<O8)-1))}function c(U,J,K,$,G){let A=_[U].fn,Z=1/$,j=Math.min(1,$),M=_[U].win/j,L,Q,D,R,B,N,E,V,C,q,X,y,S,Y,z,P,w,W=Math.floor((M+1)*2),F=new Int16Array((W+2)*K),H=0,I=!F.subarray||!F.set;for(L=0;L<K;L++){Q=(L+0.5)*Z+G,D=Math.max(0,Math.floor(Q-M)),R=Math.min(J-1,Math.ceil(Q+M)),B=R-D+1,N=new Float32Array(B),E=new Int16Array(B),V=0;for(C=D,q=0;C<=R;C++,q++)X=A((C+0.5-Q)*j),V+=X,N[q]=X;y=0;for(q=0;q<N.length;q++)S=N[q]/V,y+=S,E[q]=$8(S);E[K>>1]+=$8(1-y),Y=0;while(Y<E.length&&E[Y]===0)Y++;if(Y<E.length){z=E.length-1;while(z>0&&E[z]===0)z--;if(P=D+Y,w=z-Y+1,F[H++]=P,F[H++]=w,!I)F.set(E.subarray(Y,z+1),H),H+=w;else for(q=Y;q<=z;q++)F[H++]=E[q]}else F[H++]=0,F[H++]=0}return F}function x(U){return U<0?0:U>255?255:U}function m(U){return U>=0?U:0}function Z8(U,J,K,$,G,A){let Z,j,M,L,Q,D,R,B,N,E,V,C=0,q=0;for(N=0;N<$;N++){Q=0;for(E=0;E<G;E++){D=A[Q++],R=A[Q++],B=C+D*4|0,Z=j=M=L=0;for(;R>0;R--)V=A[Q++],L=L+V*U[B+3]|0,M=M+V*U[B+2]|0,j=j+V*U[B+1]|0,Z=Z+V*U[B]|0,B=B+4|0;J[q+3]=m(L>>7),J[q+2]=m(M>>7),J[q+1]=m(j>>7),J[q]=m(Z>>7),q=q+$*4|0}q=(N+1)*4|0,C=(N+1)*K*4|0}}function G8(U,J,K,$,G,A){let Z,j,M,L,Q,D,R,B,N,E,V,C=0,q=0;for(N=0;N<$;N++){Q=0;for(E=0;E<G;E++){D=A[Q++],R=A[Q++],B=C+D*4|0,Z=j=M=L=0;for(;R>0;R--)V=A[Q++],L=L+V*U[B+3]|0,M=M+V*U[B+2]|0,j=j+V*U[B+1]|0,Z=Z+V*U[B]|0,B=B+4|0;Z>>=7,j>>=7,M>>=7,L>>=7,J[q+3]=x(L+8192>>14),J[q+2]=x(M+8192>>14),J[q+1]=x(j+8192>>14),J[q]=x(Z+8192>>14),q=q+$*4|0}q=(N+1)*4|0,C=(N+1)*K*4|0}}function A8(U,J,K,$,G,A){let Z,j,M,L,Q,D,R,B,N,E,V,C,q=0,X=0;for(E=0;E<$;E++){D=0;for(V=0;V<G;V++){R=A[D++],B=A[D++],N=q+R*4|0,Z=j=M=L=0;for(;B>0;B--)C=A[D++],Q=U[N+3],L=L+C*Q|0,M=M+C*U[N+2]*Q|0,j=j+C*U[N+1]*Q|0,Z=Z+C*U[N]*Q|0,N=N+4|0;M=M/255|0,j=j/255|0,Z=Z/255|0,J[X+3]=m(L>>7),J[X+2]=m(M>>7),J[X+1]=m(j>>7),J[X]=m(Z>>7),X=X+$*4|0}X=(E+1)*4|0,q=(E+1)*K*4|0}}function j8(U,J,K,$,G,A){let Z,j,M,L,Q,D,R,B,N,E,V,C=0,q=0;for(N=0;N<$;N++){Q=0;for(E=0;E<G;E++){D=A[Q++],R=A[Q++],B=C+D*4|0,Z=j=M=L=0;for(;R>0;R--)V=A[Q++],L=L+V*U[B+3]|0,M=M+V*U[B+2]|0,j=j+V*U[B+1]|0,Z=Z+V*U[B]|0,B=B+4|0;if(Z>>=7,j>>=7,M>>=7,L>>=7,L=x(L+8192>>14),L>0)Z=Z*255/L|0,j=j*255/L|0,M=M*255/L|0;J[q+3]=L,J[q+2]=x(M+8192>>14),J[q+1]=x(j+8192>>14),J[q]=x(Z+8192>>14),q=q+$*4|0}q=(N+1)*4|0,C=(N+1)*K*4|0}}function w8(U,J,K){let $=3,G=J*K*4|0;while($<G){if(U[$]!==255)return!0;$=$+4|0}return!1}function H8(U,J,K){let $=3,G=J*K*4|0;while($<G)U[$]=255,$=$+4|0}function L8(U,J,K,$,G,A,Z,j,M,L){let Q=c(J,K,G,Z,M),D=c(J,$,A,j,L),R=new Uint8Array(G*A*4),B=new Uint16Array(G*$*4);if(w8(U,K,$))A8(U,B,K,$,G,Q),j8(B,R,$,G,A,D);else Z8(U,B,K,$,G,Q),G8(B,R,$,G,A,D),H8(R,G,A);return R}var q8=F8(R8(),1);function b8(U,J,K){let $=J*K,G=new Uint16Array($),A,Z,j,M;for(let L=0;L<$;L++)A=U[4*L],Z=U[4*L+1],j=U[4*L+2],M=A>=Z&&A>=j?A:Z>=j&&Z>=A?Z:j,G[L]=M<<8;return G}function V8(U,J,K,$,G,A){let Z,j,M,L,Q;if($===0||G<0.5)return;if(G>2)G=2;let D=b8(U,J,K),R=new Uint16Array(D);q8.default(R,J,K,G);let B=$/100*4096+0.5|0,N=A<<8,E=J*K;for(let V=0;V<E;V++)if(Z=D[V],L=Z-R[V],Math.abs(L)>=N)j=Z+(B*L+2048>>12),j=j>65280?65280:j,j=j<0?0:j,Z=Z!==0?Z:1,M=(j<<12)/Z|0,Q=V*4,U[Q]=U[Q]*M+2048>>12,U[Q+1]=U[Q+1]*M+2048>>12,U[Q+2]=U[Q+2]*M+2048>>12}function N8(U){let J=L8(new Uint8ClampedArray(U.tile),U.filter,U.width,U.height,U.toWidth,U.toHeight,U.scaleX,U.scaleY,U.offsetX,U.offsetY);if(U.unsharpAmount)V8(J,U.toWidth,U.toHeight,U.unsharpAmount,U.unsharpRadius,U.unsharpThreshold);return J}var T8=`
var C8=Object.create;var{getPrototypeOf:X8,defineProperty:o,getOwnPropertyNames:Y8}=Object;var y8=Object.prototype.hasOwnProperty;var z8=(M,U,J)=>{J=M!=null?C8(X8(M)):{};let K=U||!M||!M.__esModule?o(J,"default",{value:M,enumerable:!0}):J;for(let Z of Y8(M))if(!y8.call(K,Z))o(K,Z,{get:()=>M[Z],enumerable:!0});return K};var F8=(M,U)=>()=>(U||M((U={exports:{}}).exports,U),U.exports);var q8=F8((GM,B8)=>{var _,f,a,l,p,g,j8,L8;function b8(M){if(M<0.5)M=0.5;var U=Math.exp(0.527076)/M,J=Math.exp(-U),K=Math.exp(-2*U),Z=(1-J)*(1-J)/(1+2*U*J-K);return _=Z,f=Z*(U-1)*J,a=Z*(U+1)*J,l=-Z*K,p=2*J,g=-K,j8=(_+f)/(1-p-g),L8=(a+l)/(1-p-g),new Float32Array([_,f,a,l,p,g,j8,L8])}function Q8(M,U,J,K,Z,R){var $,G,D,A,j,V,N,L,q,E,B,C,Q,X,y,O,Y,z,w,I,W,F,H,S,h,u,b,T,k,m;for(h=0;h<R;h++){F=h*Z,H=h,S=0,$=M[F],G="<WORKER_CODE>"255,D=$>>8&255,A=$>>16&255,j=$>>24&255,z=G*K[6],w=D*K[6],I=A*K[6],W=j*K[6],X=z,y=w,O=I,Y=W,b=K[0],T=K[1],k=K[4],m=K[5];for(u=0;u<Z;u++)$=M[F],V="<WORKER_CODE>"255,N=$>>8&255,L=$>>16&255,q=$>>24&255,E=V*b+G*T+X*k+z*m,B=N*b+D*T+y*k+w*m,C=L*b+A*T+O*k+I*m,Q=q*b+j*T+Y*k+W*m,z=X,w=y,I=O,W=Y,X=E,y=B,O=C,Y=Q,G=V,D=N,A=L,j=q,J[S]=X,J[S+1]=y,J[S+2]=O,J[S+3]=Y,S+=4,F++;F--,S-=4,H+=R*(Z-1),$=M[F],G="<WORKER_CODE>"255,D=$>>8&255,A=$>>16&255,j=$>>24&255,z=G*K[7],w=D*K[7],I=A*K[7],W=j*K[7],X=z,y=w,O=I,Y=W,V=G,N=D,L=A,q=j,b=K[2],T=K[3];for(u=Z-1;u>=0;u--)E=V*b+G*T+X*k+z*m,B=N*b+D*T+y*k+w*m,C=L*b+A*T+O*k+I*m,Q=q*b+j*T+Y*k+W*m,z=X,w=y,I=O,W=Y,X=E,y=B,O=C,Y=Q,G=V,D=N,A=L,j=q,$=M[F],V="<WORKER_CODE>"255,N=$>>8&255,L=$>>16&255,q=$>>24&255,$=(J[S]+X<<0)+(J[S+1]+y<<8)+(J[S+2]+O<<16)+(J[S+3]+Y<<24),U[H]=$,F--,S-=4,H-=R}}function T8(M,U,J,K){if(!K)return;var Z=new Uint32Array(M.buffer),R=new Uint32Array(Z.length),$=new Float32Array(Math.max(U,J)*4),G=b8(K);Q8(Z,R,$,G,U,J,K),Q8(R,Z,$,G,J,U,K)}B8.exports=T8});var O8=2;function s(M,U,J,K,Z,R){let $=J/M,G=K/U,D=(2*R+O8+1)/Z;if(D>0.5)return[{toWidth:J,toHeight:K}];let A=Math.ceil(Math.log(Math.min($,G))/Math.log(D));if(A<=1)return[{toWidth:J,toHeight:K}];let j=[];for(let V=0;V<A;V++){let N=Math.round(Math.pow(Math.pow(M,A-V-1)*Math.pow(J,V+1),1/A)),L=Math.round(Math.pow(Math.pow(U,A-V-1)*Math.pow(K,V+1),1/A));j.push({toWidth:N,toHeight:L})}return j}function i(M,U,J){let K=new Uint8ClampedArray(J.width*J.height*P);for(let Z=0;Z<J.height;Z++){let R=((J.y+Z)*U+J.x)*P,$=Z*J.width*P;K.set(M.subarray(R,R+J.width*P),$)}return K}var t=0.00001;function n(M){let U=Math.round(M);if(Math.abs(M-U)<t)return U;return Math.floor(M)}function r(M){let U=Math.round(M);if(Math.abs(M-U)<t)return U;return Math.ceil(M)}function e(M,U,J,K,Z,R,$,G,D,A,j){let V=K/U,N=Z/J,L=n(R*V)-2*$,q=n(R*N)-2*$;if(console.log(M,U,J,K,Z,R,$),console.log(L,q),L<1||q<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let E,B,C,Q,X,y,O=[];for(Q=0;Q<Z;Q+=q)for(C=0;C<K;C+=L){if(E=C-$,E<0)E=0;if(X=C+L+$-E,E+X>=K)X=K-E;if(B=Q-$,B<0)B=0;if(y=Q+q+$-B,B+y>=Z)y=Z-B;let Y={toX:E,toY:B,toWidth:X,toHeight:y,toInnerX:C,toInnerY:Q,toInnerWidth:L,toInnerHeight:q,offsetX:E/V-n(E/V),offsetY:B/N-n(B/N),scaleX:V,scaleY:N,x:n(E/V),y:n(B/N),width:r(X/V),height:r(y/N),initialSize:R,filterPadding:$,filter:G,unsharpAmount:D,unsharpRadius:A,unsharpThreshold:j},z=i(M,U,Y);O.push({tile:z.buffer,...Y})}return O}var P=4;async function M8(M,U,J){let K,Z,R,$,G,D;if(M instanceof Blob){let j=await createImageBitmap(M),N=new OffscreenCanvas(j.width,j.height).getContext("2d");if(!N)throw new Error("Canvas 2D context not supported");N.drawImage(j,0,0),K=N.getImageData(0,0,j.width,j.height).data,Z=j.width,R=j.height;let q=U/Z,E=U/R,B=Math.min(q,E,1),C=Math.floor(Z*B),Q=Math.floor(R*B);D=s(Z,R,C,Q,J.initialSize,J.filterPadding)}else K=M.from,Z=M.fromWidth,R=M.fromHeight,D=M.stages;$=D[0].toWidth,G=D[0].toHeight;let A=e(K,Z,R,$,G,J.initialSize,J.filterPadding,J.filter,J.unsharpAmount,J.unsharpRadius,J.unsharpThreshold);return{from:K.buffer,fromWidth:Z,fromHeight:R,tileTransforms:A,stages:D}}function U8(M,U,J){let K=new Uint8ClampedArray(J.tile);for(let Z=0;Z<J.toHeight;Z++){let R=Z*J.toWidth*P,$=((J.toY+Z)*U+J.toX)*P;M.set(K.subarray(R,R+J.toWidth*P),$)}}var S8="<WORKER_CODE>",I8=new Blob([S8],{type:"application/javascript"});var J8=(()=>{let M=0;return()=>++M})();class K8{#U;#$;#J;#K;constructor(){this.#U=new Map,this.#$=new Map,this.#J=new Map,this.#K=new Map}get count(){return this.#U.size}#Z(M){clearTimeout(this.#$.get(M))}#M(M,U,J,K){this.#U.set(M,U.id),this.#J.set(U.id,M),this.#K.set(U.id,U),M.postMessage(J,K),this.#Z(M)}assignPriority1Task(M,U){let J={taskId:U.id,squishId:U.squishId,taskType:0,blob:U.data.blob,maxDimension:U.data.maxDimension,tileOptions:U.data.tileOptions};this.#M(M,U,J,[])}assignPriority2Task(M,U){let J={taskId:U.id,squishId:U.squishId,taskType:1,tileTransform:U.data.tileTransform};this.#M(M,U,J,[J.tileTransform.tile])}setWorkerTimeout(M,U){let J=setTimeout(()=>{let K=this.#U.get(M);if(K)this.#J.delete(K);if(K)this.#K.delete(K);this.#$.delete(M),this.#U.delete(M),M.terminate()},U);this.#$.set(M,J)}addWorker(M){this.#U.set(M,null)}getWorker(M){return this.#J.get(M)}getTask(M){return this.#K.get(M)}getAvailableWorker(){for(let[M,U]of this.#U.entries())if(U===null)return M;return null}removeTask(M){let U=this.#J.get(M);if(U)this.#U.set(U,null);this.#J.delete(M),this.#K.delete(M)}}class H8{#U;#$;#J;#K;#Z;#M;constructor(M,U){this.#$=M,this.#U=U,this.#J=new Map,this.#K=[],this.#Z=[],this.#M=new K8}#R(){let M=new Worker(URL.createObjectURL(I8));M.onmessage=(U)=>{let J=this.#J.get(U.data.squishId);if(!J)throw new Error("SquishContext not found");if(U.data.error)J.reject(U.data.error);if(U.data.taskType===0){let{squishId:Z,output:R}=U.data,$=R.stages[0].toWidth,G=R.stages[0].toHeight;J.from=new Uint8ClampedArray(R.from),J.fromWidth=R.fromWidth,J.fromHeight=R.fromHeight,J.to=new Uint8ClampedArray($*G*P),J.toWidth=$,J.toHeight=G,J.stages=R.stages,J.remainingTileCount=R.tileTransforms.length;for(let D of R.tileTransforms)this.#Z.push({id:J8(),squishId:Z,data:{tileTransform:D}})}if(U.data.taskType===1){let{output:Z}=U.data;if(!J.to)throw new Error("SquishContext to not found");if(U8(J.to,J.toWidth,Z.tileTransform),J.remainingTileCount--,!J.remainingTileCount){let R=new ImageData(J.to,J.toWidth,J.toHeight);createImageBitmap(R).then(($)=>{J.resolve($)})}}let K=this.#M.getWorker(U.data.taskId);if(K)this.#M.setWorkerTimeout(K,this.#U);this.#M.removeTask(U.data.taskId),this.#G()},this.#M.addWorker(M)}#G(){let M=this.#M.getAvailableWorker();if(M){let U=this.#K.shift();if(U)return this.#M.assignPriority1Task(M,U);let J=this.#Z.shift();if(J)return this.#M.assignPriority2Task(M,J)}else if(this.#M.count<this.#$)this.#R(),this.#G()}add(M){return new Promise((U,J)=>{let K=J8();this.#J.set(K,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:U,reject:J}),this.#K.push({id:K,squishId:K,data:M}),this.#G()})}}var d={box:{win:0.5,fn:(M)=>{if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:(M)=>{if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*(0.54+0.46*Math.cos(U/1))}},lanczos2:{win:2,fn:(M)=>{if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/2)/(U/2)}},lanczos3:{win:3,fn:(M)=>{if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/3)/(U/3)}},mks2013:{win:2.5,fn:(M)=>{if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var w8=14;function $8(M){return Math.round(M*((1<<w8)-1))}function c(M,U,J,K,Z){let R=d[M].fn,$=1/K,G=Math.min(1,K),D=d[M].win/G,A,j,V,N,L,q,E,B,C,Q,X,y,O,Y,z,w,I,W=Math.floor((D+1)*2),F=new Int16Array((W+2)*J),H=0,S=!F.subarray||!F.set;for(A=0;A<J;A++){j=(A+0.5)*$+Z,V=Math.max(0,Math.floor(j-D)),N=Math.min(U-1,Math.ceil(j+D)),L=N-V+1,q=new Float32Array(L),E=new Int16Array(L),B=0;for(C=V,Q=0;C<=N;C++,Q++)X=R((C+0.5-j)*G),B+=X,q[Q]=X;y=0;for(Q=0;Q<q.length;Q++)O=q[Q]/B,y+=O,E[Q]=$8(O);E[J>>1]+=$8(1-y),Y=0;while(Y<E.length&&E[Y]===0)Y++;if(Y<E.length){z=E.length-1;while(z>0&&E[z]===0)z--;if(w=V+Y,I=z-Y+1,F[H++]=w,F[H++]=I,!S)F.set(E.subarray(Y,z+1),H),H+=I;else for(Q=Y;Q<=z;Q++)F[H++]=E[Q]}else F[H++]=0,F[H++]=0}return F}function x(M){return M<0?0:M>255?255:M}function v(M){return M>=0?M:0}function Z8(M,U,J,K,Z,R){let $,G,D,A,j,V,N,L,q,E,B,C=0,Q=0;for(q=0;q<K;q++){j=0;for(E=0;E<Z;E++){V=R[j++],N=R[j++],L=C+V*4|0,$=G=D=A=0;for(;N>0;N--)B=R[j++],A=A+B*M[L+3]|0,D=D+B*M[L+2]|0,G=G+B*M[L+1]|0,$=$+B*M[L]|0,L=L+4|0;U[Q+3]=v(A>>7),U[Q+2]=v(D>>7),U[Q+1]=v(G>>7),U[Q]=v($>>7),Q=Q+K*4|0}Q=(q+1)*4|0,C=(q+1)*J*4|0}}function G8(M,U,J,K,Z,R){let $,G,D,A,j,V,N,L,q,E,B,C=0,Q=0;for(q=0;q<K;q++){j=0;for(E=0;E<Z;E++){V=R[j++],N=R[j++],L=C+V*4|0,$=G=D=A=0;for(;N>0;N--)B=R[j++],A=A+B*M[L+3]|0,D=D+B*M[L+2]|0,G=G+B*M[L+1]|0,$=$+B*M[L]|0,L=L+4|0;$>>=7,G>>=7,D>>=7,A>>=7,U[Q+3]=x(A+8192>>14),U[Q+2]=x(D+8192>>14),U[Q+1]=x(G+8192>>14),U[Q]=x($+8192>>14),Q=Q+K*4|0}Q=(q+1)*4|0,C=(q+1)*J*4|0}}function R8(M,U,J,K,Z,R){let $,G,D,A,j,V,N,L,q,E,B,C,Q=0,X=0;for(E=0;E<K;E++){V=0;for(B=0;B<Z;B++){N=R[V++],L=R[V++],q=Q+N*4|0,$=G=D=A=0;for(;L>0;L--)C=R[V++],j=M[q+3],A=A+C*j|0,D=D+C*M[q+2]*j|0,G=G+C*M[q+1]*j|0,$=$+C*M[q]*j|0,q=q+4|0;D=D/255|0,G=G/255|0,$=$/255|0,U[X+3]=v(A>>7),U[X+2]=v(D>>7),U[X+1]=v(G>>7),U[X]=v($>>7),X=X+K*4|0}X=(E+1)*4|0,Q=(E+1)*J*4|0}}function A8(M,U,J,K,Z,R){let $,G,D,A,j,V,N,L,q,E,B,C=0,Q=0;for(q=0;q<K;q++){j=0;for(E=0;E<Z;E++){V=R[j++],N=R[j++],L=C+V*4|0,$=G=D=A=0;for(;N>0;N--)B=R[j++],A=A+B*M[L+3]|0,D=D+B*M[L+2]|0,G=G+B*M[L+1]|0,$=$+B*M[L]|0,L=L+4|0;if($>>=7,G>>=7,D>>=7,A>>=7,A=x(A+8192>>14),A>0)$=$*255/A|0,G=G*255/A|0,D=D*255/A|0;U[Q+3]=A,U[Q+2]=x(D+8192>>14),U[Q+1]=x(G+8192>>14),U[Q]=x($+8192>>14),Q=Q+K*4|0}Q=(q+1)*4|0,C=(q+1)*J*4|0}}function P8(M,U,J){let K=3,Z=U*J*4|0;while(K<Z){if(M[K]!==255)return!0;K=K+4|0}return!1}function W8(M,U,J){let K=3,Z=U*J*4|0;while(K<Z)M[K]=255,K=K+4|0}function D8(M,U,J,K,Z,R,$,G,D,A){let j=c(U,J,Z,$,D),V=c(U,K,R,G,A),N=new Uint8Array(Z*R*4),L=new Uint16Array(Z*K*4);if(P8(M,J,K))R8(M,L,J,K,Z,j),A8(L,N,K,Z,R,V);else Z8(M,L,J,K,Z,j),G8(L,N,K,Z,R,V),W8(N,Z,R);return N}var E8=z8(q8(),1);function k8(M,U,J){let K=U*J,Z=new Uint16Array(K),R,$,G,D;for(let A=0;A<K;A++)R=M[4*A],$=M[4*A+1],G=M[4*A+2],D=R>="<WORKER_CODE>"&R>=G?R:$>=G&&$>=R?$:G,Z[A]=D<<8;return Z}function V8(M,U,J,K,Z,R){let $,G,D,A,j;if(K===0||Z<0.5)return;if(Z>2)Z=2;let V=k8(M,U,J),N=new Uint16Array(V);E8.default(N,U,J,Z);let L=K/100*4096+0.5|0,q=R<<8,E=U*J;for(let B=0;B<E;B++)if($=V[B],A=$-N[B],Math.abs(A)>=q)G=$+(L*A+2048>>12),G=G>65280?65280:G,G=G<0?0:G,$=$!==0?$:1,D=(G<<12)/$|0,j=B*4,M[j]=M[j]*D+2048>>12,M[j+1]=M[j+1]*D+2048>>12,M[j+2]=M[j+2]*D+2048>>12}function N8(M){let U=D8(new Uint8ClampedArray(M.tile),M.filter,M.width,M.height,M.toWidth,M.toHeight,M.scaleX,M.scaleY,M.offsetX,M.offsetY);if(M.unsharpAmount)V8(U,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return U}self.onmessage=async(M)=>{let{taskId:U,squishId:J,taskType:K}=M.data;try{if(K===0){let{blob:Z,maxDimension:R,tileOptions:$}=M.data,G=await M8(Z,R,$),D={taskId:U,squishId:J,taskType:K,output:{from:G.from,fromWidth:G.fromWidth,fromHeight:G.fromHeight,tileTransforms:G.tileTransforms,stages:G.stages}},A=G.tileTransforms.map((j)=>j.tile);self.postMessage(D,[G.from,...A])}if(K===1){let{tileTransform:Z}=M.data;Z.tile=N8(Z).buffer;let R={taskId:U,squishId:J,taskType:K,output:{tileTransform:Z}};self.postMessage(R,[Z.tile])}}catch(Z){self.postMessage({taskId:U,squishId:J,taskType:K,error:Z})}};
`,k8=new Blob([T8],{type:"application/javascript"});var E8=(()=>{let U=0;return()=>++U})();class C8{#U;#$;#J;#Z;constructor(){this.#U=new Map,this.#$=new Map,this.#J=new Map,this.#Z=new Map}get count(){return this.#U.size}#G(U){clearTimeout(this.#$.get(U))}#K(U,J,K,$){this.#U.set(U,J.id),this.#J.set(J.id,U),this.#Z.set(J.id,J),U.postMessage(K,$),this.#G(U)}assignPriority1Task(U,J){let K={taskId:J.id,squishId:J.squishId,taskType:0,blob:J.data.blob,maxDimension:J.data.maxDimension,tileOptions:J.data.tileOptions};this.#K(U,J,K,[])}assignPriority2Task(U,J){let K={taskId:J.id,squishId:J.squishId,taskType:1,tileTransform:J.data.tileTransform};this.#K(U,J,K,[K.tileTransform.tile])}setWorkerTimeout(U,J){let K=setTimeout(()=>{let $=this.#U.get(U);if($)this.#J.delete($);if($)this.#Z.delete($);this.#$.delete(U),this.#U.delete(U),U.terminate()},J);this.#$.set(U,K)}addWorker(U){this.#U.set(U,null)}getWorker(U){return this.#J.get(U)}getTask(U){return this.#Z.get(U)}getAvailableWorker(){for(let[U,J]of this.#U.entries())if(J===null)return U;return null}removeTask(U){let J=this.#J.get(U);if(J)this.#U.set(J,null);this.#J.delete(U),this.#Z.delete(U)}}class s{#U;#$;#J;#Z;#G;#K;constructor(U,J){this.#$=U,this.#U=J,this.#J=new Map,this.#Z=[],this.#G=[],this.#K=new C8}#j(){let U=new Worker(URL.createObjectURL(k8));U.onmessage=(J)=>{let K=this.#J.get(J.data.squishId);if(!K)throw new Error("SquishContext not found");if(J.data.error)K.reject(J.data.error);if(J.data.taskType===0){let{squishId:G,output:A}=J.data,Z=A.stages[0].toWidth,j=A.stages[0].toHeight;K.from=new Uint8ClampedArray(A.from),K.fromWidth=A.fromWidth,K.fromHeight=A.fromHeight,K.to=new Uint8ClampedArray(Z*j*O),K.toWidth=Z,K.toHeight=j,K.stages=A.stages,K.remainingTileCount=A.tileTransforms.length;for(let M of A.tileTransforms)this.#G.push({id:E8(),squishId:G,data:{tileTransform:M}})}if(J.data.taskType===1){let{output:G}=J.data;if(!K.to)throw new Error("SquishContext to not found");if(p(K.to,K.toWidth,G.tileTransform),K.remainingTileCount--,!K.remainingTileCount){let A=new ImageData(K.to,K.toWidth,K.toHeight);createImageBitmap(A).then((Z)=>{K.resolve(Z)})}}let $=this.#K.getWorker(J.data.taskId);if($)this.#K.setWorkerTimeout($,this.#U);this.#K.removeTask(J.data.taskId),this.#A()},this.#K.addWorker(U)}#A(){let U=this.#K.getAvailableWorker();if(U){let J=this.#Z.shift();if(J)return this.#K.assignPriority1Task(U,J);let K=this.#G.shift();if(K)return this.#K.assignPriority2Task(U,K)}else if(this.#K.count<this.#$)this.#j(),this.#A()}add(U){return new Promise((J,K)=>{let $=E8();this.#J.set($,{from:null,fromWidth:0,fromHeight:0,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:J,reject:K}),this.#Z.push({id:$,squishId:$,data:U}),this.#A()})}}class v8{#U;#$;constructor(U){let J=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,K=U.maxWorkerPoolSize||Math.min(J,4),$=U.maxWorkerIdleTime||1e4;this.#U=new s(K,$),this.#$=U}async#J(U,J,K){let $=null,G,A,Z,j,M,L;for(;;){let D=await K8($||U,J,K);G=new Uint8ClampedArray(D.from),A=D.fromWidth,Z=D.fromHeight,M=D.stages[0].toWidth,L=D.stages[0].toHeight,j=new Uint8ClampedArray(M*L*O);for(let R of D.tileTransforms)R.tile=N8(R).buffer,p(j,M,R);if(D.stages.shift(),$={from:j,fromWidth:M,fromHeight:L,stages:D.stages},!D.stages[0])break}let Q=new ImageData($.from,$.fromWidth,$.fromHeight);return await createImageBitmap(Q)}async squish(U,J){let K=J?{...this.#$,...J}:this.#$,$=K.maxDimension,G=K.tileSize||1024,A=K.filter||"mks2013",Z=K.unsharpAmount||0,j=K.unsharpRadius||0,M=K.unsharpThreshold||0,L=K.useMainThread,Q=3,D=Math.ceil(Math.max(3,2.5*j|0)),R={initialSize:G,filterPadding:D,filter:A,unsharpAmount:Z,unsharpRadius:j,unsharpThreshold:M};return await this.#J(U,$,R)}}export{v8 as PicSquish};
