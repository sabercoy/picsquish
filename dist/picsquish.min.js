var Xk=Object.create;var{getPrototypeOf:Yk,defineProperty:s,getOwnPropertyNames:wk}=Object;var Wk=Object.prototype.hasOwnProperty;var Ek=(k,M,q)=>{q=k!=null?Xk(Yk(k)):{};let Q=M||!k||!k.__esModule?s(q,"default",{value:k,enumerable:!0}):q;for(let Z of wk(k))if(!Wk.call(Q,Z))s(Q,Z,{get:()=>k[Z],enumerable:!0});return Q};var Ok=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Dk=Ok((ok,Rk)=>{var f,p,_,c,d,n,Uk,Tk;function Hk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,q=Math.exp(-M),Q=Math.exp(-2*M),Z=(1-q)*(1-q)/(1+2*M*q-Q);return f=Z,p=Z*(M-1)*q,_=Z*(M+1)*q,c=-Z*Q,d=2*q,n=-Q,Uk=(f+p)/(1-d-n),Tk=(_+c)/(1-d-n),new Float32Array([f,p,_,c,d,n,Uk,Tk])}function Gk(k,M,q,Q,Z,J){var I,K,$,U,T,G,B,R,D,A,L,y,j,C,Y,w,N,X,z,E,S,V,O,W,v,h,F,P,H,b;for(v=0;v<J;v++){V=v*Z,O=v,W=0,I=k[V],K=I&255,$=I>>8&255,U=I>>16&255,T=I>>24&255,X=K*Q[6],z=$*Q[6],E=U*Q[6],S=T*Q[6],C=X,Y=z,w=E,N=S,F=Q[0],P=Q[1],H=Q[4],b=Q[5];for(h=0;h<Z;h++)I=k[V],G=I&255,B=I>>8&255,R=I>>16&255,D=I>>24&255,A=G*F+K*P+C*H+X*b,L=B*F+$*P+Y*H+z*b,y=R*F+U*P+w*H+E*b,j=D*F+T*P+N*H+S*b,X=C,z=Y,E=w,S=N,C=A,Y=L,w=y,N=j,K=G,$=B,U=R,T=D,q[W]=C,q[W+1]=Y,q[W+2]=w,q[W+3]=N,W+=4,V++;V--,W-=4,O+=J*(Z-1),I=k[V],K=I&255,$=I>>8&255,U=I>>16&255,T=I>>24&255,X=K*Q[7],z=$*Q[7],E=U*Q[7],S=T*Q[7],C=X,Y=z,w=E,N=S,G=K,B=$,R=U,D=T,F=Q[2],P=Q[3];for(h=Z-1;h>=0;h--)A=G*F+K*P+C*H+X*b,L=B*F+$*P+Y*H+z*b,y=R*F+U*P+w*H+E*b,j=D*F+T*P+N*H+S*b,X=C,z=Y,E=w,S=N,C=A,Y=L,w=y,N=j,K=G,$=B,U=R,T=D,I=k[V],G=I&255,B=I>>8&255,R=I>>16&255,D=I>>24&255,I=(q[W]+C<<0)+(q[W+1]+Y<<8)+(q[W+2]+w<<16)+(q[W+3]+N<<24),M[O]=I,V--,W-=4,O-=J}}function bk(k,M,q,Q){if(!Q)return;var Z=new Uint32Array(k.buffer),J=new Uint32Array(Z.length),I=new Float32Array(Math.max(M,q)*4),K=Hk(Q);Gk(Z,J,I,K,M,q,Q),Gk(J,Z,I,K,q,M,Q)}Rk.exports=bk});function i(k,M,q,Q,Z,J){let I=q/k,K=Q/M,$=(2*J+2+1)/Z;if($>0.5)return[[q,Q]];let U=Math.ceil(Math.log(Math.min(I,K))/Math.log($));if(U<=1)return[[q,Q]];let T=[];for(let G=0;G<U;G++){let B=Math.round(Math.pow(Math.pow(k,U-G-1)*Math.pow(q,G+1),1/U)),R=Math.round(Math.pow(Math.pow(M,U-G-1)*Math.pow(Q,G+1),1/U));T.push([B,R])}return T}function r(k){return k instanceof OffscreenCanvas}function e(k){return k instanceof ImageBitmap}function kk(k,M,q,Q,Z){let J=new OffscreenCanvas(k.width,k.height),I=J.getContext("2d");return I.globalCompositeOperation="copy",I.drawImage(Q.srcImageBitmap||M,k.x,k.y,k.width,k.height,0,0,k.width,k.height),Z.src=I.getImageData(0,0,k.width,k.height).data,J.width=J.height=0,Z}function x(k){var M=Math.round(k);if(Math.abs(k-M)<0.00001)return M;return Math.floor(k)}function Mk(k){var M=Math.round(k);if(Math.abs(k-M)<0.00001)return M;return Math.ceil(k)}function Qk(k){var M=k.toWidth/k.width,q=k.toHeight/k.height,Q=x(k.srcTileSize*M)-2*k.destTileBorder,Z=x(k.srcTileSize*q)-2*k.destTileBorder;if(Q<1||Z<1)throw new Error("Internal error in pica: target tile width/height is too small.");var J,I,K,$,U,T,G=[],B;for($=0;$<k.toHeight;$+=Z)for(K=0;K<k.toWidth;K+=Q){if(J=K-k.destTileBorder,J<0)J=0;if(U=K+Q+k.destTileBorder-J,J+U>=k.toWidth)U=k.toWidth-J;if(I=$-k.destTileBorder,I<0)I=0;if(T=$+Z+k.destTileBorder-I,I+T>=k.toHeight)T=k.toHeight-I;B={toX:J,toY:I,toWidth:U,toHeight:T,toInnerX:K,toInnerY:$,toInnerWidth:Q,toInnerHeight:Z,offsetX:J/M-x(J/M),offsetY:I/q-x(I/q),scaleX:M,scaleY:q,x:x(J/M),y:x(I/q),width:Mk(U/M),height:Mk(T/q)},G.push(B)}return G}var g={box:{win:0.5,fn:function(k){if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:function(k){if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;var M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:function(k){if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;var M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:function(k){if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;var M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:function(k){if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Sk=14;function Ik(k){return Math.round(k*((1<<Sk)-1))}function a(k,M,q,Q,Z){var J=g[k].fn,I=1/Q,K=Math.min(1,Q),$=g[k].win/K,U,T,G,B,R,D,A,L,y,j,C,Y,w,N,X,z,E,S=Math.floor(($+1)*2),V=new Int16Array((S+2)*q),O=0,W=!V.subarray||!V.set;for(U=0;U<q;U++){T=(U+0.5)*I+Z,G=Math.max(0,Math.floor(T-$)),B=Math.min(M-1,Math.ceil(T+$)),R=B-G+1,D=new Float32Array(R),A=new Int16Array(R),L=0;for(y=G,j=0;y<=B;y++,j++)C=J((y+0.5-T)*K),L+=C,D[j]=C;Y=0;for(j=0;j<D.length;j++)w=D[j]/L,Y+=w,A[j]=Ik(w);A[q>>1]+=Ik(1-Y),N=0;while(N<A.length&&A[N]===0)N++;if(N<A.length){X=A.length-1;while(X>0&&A[X]===0)X--;if(z=G+N,E=X-N+1,V[O++]=z,V[O++]=E,!W)V.set(A.subarray(N,X+1),O),O+=E;else for(j=N;j<=X;j++)V[O++]=A[j]}else V[O++]=0,V[O++]=0}return V}function m(k){return k<0?0:k>255?255:k}function u(k){return k>=0?k:0}function qk(k,M,q,Q,Z,J){var I,K,$,U,T,G,B,R,D,A,L,y=0,j=0;for(D=0;D<Q;D++){T=0;for(A=0;A<Z;A++){G=J[T++],B=J[T++],R=y+G*4|0,I=K=$=U=0;for(;B>0;B--)L=J[T++],U=U+L*k[R+3]|0,$=$+L*k[R+2]|0,K=K+L*k[R+1]|0,I=I+L*k[R]|0,R=R+4|0;M[j+3]=u(U>>7),M[j+2]=u($>>7),M[j+1]=u(K>>7),M[j]=u(I>>7),j=j+Q*4|0}j=(D+1)*4|0,y=(D+1)*q*4|0}}function Kk(k,M,q,Q,Z,J){var I,K,$,U,T,G,B,R,D,A,L,y=0,j=0;for(D=0;D<Q;D++){T=0;for(A=0;A<Z;A++){G=J[T++],B=J[T++],R=y+G*4|0,I=K=$=U=0;for(;B>0;B--)L=J[T++],U=U+L*k[R+3]|0,$=$+L*k[R+2]|0,K=K+L*k[R+1]|0,I=I+L*k[R]|0,R=R+4|0;I>>=7,K>>=7,$>>=7,U>>=7,M[j+3]=m(U+8192>>14),M[j+2]=m($+8192>>14),M[j+1]=m(K+8192>>14),M[j]=m(I+8192>>14),j=j+Q*4|0}j=(D+1)*4|0,y=(D+1)*q*4|0}}function Jk(k,M,q,Q,Z,J){var I,K,$,U,T,G,B,R,D,A,L,y,j=0,C=0;for(A=0;A<Q;A++){G=0;for(L=0;L<Z;L++){B=J[G++],R=J[G++],D=j+B*4|0,I=K=$=U=0;for(;R>0;R--)y=J[G++],T=k[D+3],U=U+y*T|0,$=$+y*k[D+2]*T|0,K=K+y*k[D+1]*T|0,I=I+y*k[D]*T|0,D=D+4|0;$=$/255|0,K=K/255|0,I=I/255|0,M[C+3]=u(U>>7),M[C+2]=u($>>7),M[C+1]=u(K>>7),M[C]=u(I>>7),C=C+Q*4|0}C=(A+1)*4|0,j=(A+1)*q*4|0}}function Zk(k,M,q,Q,Z,J){var I,K,$,U,T,G,B,R,D,A,L,y=0,j=0;for(D=0;D<Q;D++){T=0;for(A=0;A<Z;A++){G=J[T++],B=J[T++],R=y+G*4|0,I=K=$=U=0;for(;B>0;B--)L=J[T++],U=U+L*k[R+3]|0,$=$+L*k[R+2]|0,K=K+L*k[R+1]|0,I=I+L*k[R]|0,R=R+4|0;if(I>>=7,K>>=7,$>>=7,U>>=7,U=m(U+8192>>14),U>0)I=I*255/U|0,K=K*255/U|0,$=$*255/U|0;M[j+3]=U,M[j+2]=m($+8192>>14),M[j+1]=m(K+8192>>14),M[j]=m(I+8192>>14),j=j+Q*4|0}j=(D+1)*4|0,y=(D+1)*q*4|0}}function Fk(k,M,q){let Q=3,Z=M*q*4|0;while(Q<Z){if(k[Q]!==255)return!0;Q=Q+4|0}return!1}function Pk(k,M,q){let Q=3,Z=M*q*4|0;while(Q<Z)k[Q]=255,Q=Q+4|0}function $k(k){let{src:M,width:q,height:Q,toWidth:Z,toHeight:J}=k,I=k.scaleX||k.toWidth/k.width,K=k.scaleY||k.toHeight/k.height,$=k.offsetX||0,U=k.offsetY||0,T=k.dest||new Uint8Array(Z*J*4),G=typeof k.filter==="undefined"?"mks2013":k.filter,B=a(G,q,Z,I,$),R=a(G,Q,J,K,U),D=new Uint16Array(Z*Q*4);if(Fk(M,q,Q))Jk(M,D,q,Q,Z,B),Zk(D,T,Q,Z,J,R);else qk(M,D,q,Q,Z,B),Kk(D,T,Q,Z,J,R),Pk(T,Z,J);return T}var jk=Ek(Dk(),1);function mk(k,M,q){var Q=M*q,Z=new Uint16Array(Q),J,I,K,$;for(var U=0;U<Q;U++)J=k[4*U],I=k[4*U+1],K=k[4*U+2],$=J>=I&&J>=K?J:I>=K&&I>=J?I:K,Z[U]=$<<8;return Z}function Bk(k,M,q,Q,Z,J){var I,K,$,U,T;if(Q===0||Z<0.5)return;if(Z>2)Z=2;var G=mk(k,M,q),B=new Uint16Array(G);jk.default(B,M,q,Z);var R=Q/100*4096+0.5|0,D=J<<8,A=M*q;for(var L=0;L<A;L++)if(I=G[L],U=I-B[L],Math.abs(U)>=D)K=I+(R*U+2048>>12),K=K>65280?65280:K,K=K<0?0:K,I=I!==0?I:1,$=(K<<12)/I|0,T=L*4,k[T]=k[T]*$+2048>>12,k[T+1]=k[T+1]*$+2048>>12,k[T+2]=k[T+2]*$+2048>>12}function Lk(k,M){let q=$k(k,M);if(k.unsharpAmount)Bk(q,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return q}function Ak(k,M){return Promise.resolve().then(()=>{return{data:Lk(k,M.__mathCache)}})}function yk(k,M,q){let Q;if(M.bitmap)return q.toCtx.drawImage(M.bitmap,k.toX,k.toY),null;if(Q=new ImageData(new Uint8ClampedArray(M.data),k.toWidth,k.toHeight),!1)q.toCtx.putImageData(Q,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth+0.00001,k.toInnerHeight+0.00001);else q.toCtx.putImageData(Q,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth,k.toInnerHeight);return null}function Ck(k,M,q){let Q={srcCtx:null,srcImageBitmap:null,isImageBitmapReused:!1,toCtx:null},Z=(J)=>{let I={width:J.width,height:J.height,toWidth:J.toWidth,toHeight:J.toHeight,scaleX:J.scaleX,scaleY:J.scaleY,offsetX:J.offsetX,offsetY:J.offsetY,filter:q.filter,unsharpAmount:q.unsharpAmount,unsharpRadius:q.unsharpRadius,unsharpThreshold:q.unsharpThreshold};return Promise.resolve(I).then((K)=>kk(J,k,q,Q,K)).then((K)=>{return Ak(K,q)}).then((K)=>{return Q.srcImageData=null,yk(J,K,Q)})};return Promise.resolve().then(()=>{if(Q.toCtx=M.getContext("2d"),r(k))return null;if(e(k))return Q.srcImageBitmap=k,Q.isImageBitmapReused=!0,null;throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap')}).then(()=>{if(q.canceled)return q.cancelToken;let I=Qk({width:q.width,height:q.height,srcTileSize:1024,toWidth:q.toWidth,toHeight:q.toHeight,destTileBorder:q.__destTileBorder}).map(($)=>Z($));function K($){if($.srcImageBitmap){if(!$.isImageBitmapReused)$.srcImageBitmap.close();$.srcImageBitmap=null}}return Promise.all(I).then(()=>{return K(Q),M},($)=>{throw K(Q),$})})}function l(k,M,q,Q){if(Q.canceled)return Q.cancelToken;let[Z,J]=k.shift(),I=k.length===0;Q.toWidth=Z,Q.toHeight=J;let K;if(!I)K=new OffscreenCanvas(Z,J);return Ck(M,I?q:K,Q).then(()=>{if(I)return q;return Q.width=Z,Q.height=J,l(k,K,q,Q)}).then(($)=>{if(K)K.width=K.height=0;return $})}async function Nk(k,M){let q=await createImageBitmap(k),Q=q.width,Z=q.height,J=M/Q,I=M/Z,K=Math.min(J,I,1),$=Math.floor(Q*K),U=Math.floor(Z*K),T=new OffscreenCanvas($,U),G={filter:"mks2013",unsharpAmount:0,unsharpRadius:0,unsharpThreshold:0,width:Q,height:Z,toWidth:$,toHeight:U,canceled:!1,__destTileBorder:3},B=i(G.width,G.height,G.toWidth,G.toHeight,1024,G.__destTileBorder);return(await l(B,q,T,G)).transferToImageBitmap()}var uk=`
var VM=Object.create;var{getPrototypeOf:XM,defineProperty:o,getOwnPropertyNames:YM}=Object;var EM=Object.prototype.hasOwnProperty;var zM=(M,K,Z)=>{Z=M!=null?VM(XM(M)):{};let J=K||!M||!M.__esModule?o(Z,"default",{value:M,enumerable:!0}):Z;for(let q of YM(M))if(!EM.call(J,q))o(J,q,{get:()=>M[q],enumerable:!0});return J};var TM=(M,K)=>()=>(K||M((K={exports:{}}).exports,K),K.exports);var BM=TM((fM,jM)=>{var _,a,p,c,g,d,GM,IM;function HM(M){if(M<0.5)M=0.5;var K=Math.exp(0.527076)/M,Z=Math.exp(-K),J=Math.exp(-2*K),q=(1-Z)*(1-Z)/(1+2*K*Z-J);return _=q,a=q*(K-1)*Z,p=q*(K+1)*Z,c=-q*J,g=2*Z,d=-J,GM=(_+a)/(1-g-d),IM=(p+c)/(1-g-d),new Float32Array([_,a,p,c,g,d,GM,IM])}function LM(M,K,Z,J,q,U){var Q,$,G,I,L,j,R,B,D,k,N,C,A,y,E,z,V,Y,F,w,O,X,S,T,v,u,H,P,W,b;for(v=0;v<U;v++){X=v*q,S=v,T=0,Q=M[X],$=Q&255,G=Q>>8&255,I=Q>>16&255,L=Q>>24&255,Y=$*J[6],F=G*J[6],w=I*J[6],O=L*J[6],y=Y,E=F,z=w,V=O,H=J[0],P=J[1],W=J[4],b=J[5];for(u=0;u<q;u++)Q=M[X],j=Q&255,R=Q>>8&255,B=Q>>16&255,D=Q>>24&255,k=j*H+$*P+y*W+Y*b,N=R*H+G*P+E*W+F*b,C=B*H+I*P+z*W+w*b,A=D*H+L*P+V*W+O*b,Y=y,F=E,w=z,O=V,y=k,E=N,z=C,V=A,$=j,G=R,I=B,L=D,Z[T]=y,Z[T+1]=E,Z[T+2]=z,Z[T+3]=V,T+=4,X++;X--,T-=4,S+=U*(q-1),Q=M[X],$=Q&255,G=Q>>8&255,I=Q>>16&255,L=Q>>24&255,Y=$*J[7],F=G*J[7],w=I*J[7],O=L*J[7],y=Y,E=F,z=w,V=O,j=$,R=G,B=I,D=L,H=J[2],P=J[3];for(u=q-1;u>=0;u--)k=j*H+$*P+y*W+Y*b,N=R*H+G*P+E*W+F*b,C=B*H+I*P+z*W+w*b,A=D*H+L*P+V*W+O*b,Y=y,F=E,w=z,O=V,y=k,E=N,z=C,V=A,$=j,G=R,I=B,L=D,Q=M[X],j=Q&255,R=Q>>8&255,B=Q>>16&255,D=Q>>24&255,Q=(Z[T]+y<<0)+(Z[T+1]+E<<8)+(Z[T+2]+z<<16)+(Z[T+3]+V<<24),K[S]=Q,X--,T-=4,S-=U}}function PM(M,K,Z,J){if(!J)return;var q=new Uint32Array(M.buffer),U=new Uint32Array(q.length),Q=new Float32Array(Math.max(K,Z)*4),$=HM(J);LM(q,U,Q,$,K,Z,J),LM(U,q,Q,$,Z,K,J)}jM.exports=PM});function s(M,K,Z,J,q,U){let Q=Z/M,$=J/K,G=(2*U+2+1)/q;if(G>0.5)return[[Z,J]];let I=Math.ceil(Math.log(Math.min(Q,$))/Math.log(G));if(I<=1)return[[Z,J]];let L=[];for(let j=0;j<I;j++){let R=Math.round(Math.pow(Math.pow(M,I-j-1)*Math.pow(Z,j+1),1/I)),B=Math.round(Math.pow(Math.pow(K,I-j-1)*Math.pow(J,j+1),1/I));L.push([R,B])}return L}function i(M){return M instanceof OffscreenCanvas}function r(M){return M instanceof ImageBitmap}function t(M,K,Z,J,q){let U=new OffscreenCanvas(M.width,M.height),Q=U.getContext("2d");return Q.globalCompositeOperation="copy",Q.drawImage(J.srcImageBitmap||K,M.x,M.y,M.width,M.height,0,0,M.width,M.height),q.src=Q.getImageData(0,0,M.width,M.height).data,U.width=U.height=0,q}function h(M){var K=Math.round(M);if(Math.abs(M-K)<0.00001)return K;return Math.floor(M)}function MM(M){var K=Math.round(M);if(Math.abs(M-K)<0.00001)return K;return Math.ceil(M)}function JM(M){var K=M.toWidth/M.width,Z=M.toHeight/M.height,J=h(M.srcTileSize*K)-2*M.destTileBorder,q=h(M.srcTileSize*Z)-2*M.destTileBorder;if(J<1||q<1)throw new Error("Internal error in pica: target tile width/height is too small.");var U,Q,$,G,I,L,j=[],R;for(G=0;G<M.toHeight;G+=q)for($=0;$<M.toWidth;$+=J){if(U=$-M.destTileBorder,U<0)U=0;if(I=$+J+M.destTileBorder-U,U+I>=M.toWidth)I=M.toWidth-U;if(Q=G-M.destTileBorder,Q<0)Q=0;if(L=G+q+M.destTileBorder-Q,Q+L>=M.toHeight)L=M.toHeight-Q;R={toX:U,toY:Q,toWidth:I,toHeight:L,toInnerX:$,toInnerY:G,toInnerWidth:J,toInnerHeight:q,offsetX:U/K-h(U/K),offsetY:Q/Z-h(Q/Z),scaleX:K,scaleY:Z,x:h(U/K),y:h(Q/Z),width:MM(I/K),height:MM(L/Z)},j.push(R)}return j}var n={box:{win:0.5,fn:function(M){if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:function(M){if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;var K=M*Math.PI;return Math.sin(K)/K*(0.54+0.46*Math.cos(K/1))}},lanczos2:{win:2,fn:function(M){if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;var K=M*Math.PI;return Math.sin(K)/K*Math.sin(K/2)/(K/2)}},lanczos3:{win:3,fn:function(M){if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;var K=M*Math.PI;return Math.sin(K)/K*Math.sin(K/3)/(K/3)}},mks2013:{win:2.5,fn:function(M){if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var SM=14;function KM(M){return Math.round(M*((1<<SM)-1))}function f(M,K,Z,J,q){var U=n[M].fn,Q=1/J,$=Math.min(1,J),G=n[M].win/$,I,L,j,R,B,D,k,N,C,A,y,E,z,V,Y,F,w,O=Math.floor((G+1)*2),X=new Int16Array((O+2)*Z),S=0,T=!X.subarray||!X.set;for(I=0;I<Z;I++){L=(I+0.5)*Q+q,j=Math.max(0,Math.floor(L-G)),R=Math.min(K-1,Math.ceil(L+G)),B=R-j+1,D=new Float32Array(B),k=new Int16Array(B),N=0;for(C=j,A=0;C<=R;C++,A++)y=U((C+0.5-L)*$),N+=y,D[A]=y;E=0;for(A=0;A<D.length;A++)z=D[A]/N,E+=z,k[A]=KM(z);k[Z>>1]+=KM(1-E),V=0;while(V<k.length&&k[V]===0)V++;if(V<k.length){Y=k.length-1;while(Y>0&&k[Y]===0)Y--;if(F=j+V,w=Y-V+1,X[S++]=F,X[S++]=w,!T)X.set(k.subarray(V,Y+1),S),S+=w;else for(A=V;A<=Y;A++)X[S++]=k[A]}else X[S++]=0,X[S++]=0}return X}function m(M){return M<0?0:M>255?255:M}function x(M){return M>=0?M:0}function QM(M,K,Z,J,q,U){var Q,$,G,I,L,j,R,B,D,k,N,C=0,A=0;for(D=0;D<J;D++){L=0;for(k=0;k<q;k++){j=U[L++],R=U[L++],B=C+j*4|0,Q=$=G=I=0;for(;R>0;R--)N=U[L++],I=I+N*M[B+3]|0,G=G+N*M[B+2]|0,$=$+N*M[B+1]|0,Q=Q+N*M[B]|0,B=B+4|0;K[A+3]=x(I>>7),K[A+2]=x(G>>7),K[A+1]=x($>>7),K[A]=x(Q>>7),A=A+J*4|0}A=(D+1)*4|0,C=(D+1)*Z*4|0}}function ZM(M,K,Z,J,q,U){var Q,$,G,I,L,j,R,B,D,k,N,C=0,A=0;for(D=0;D<J;D++){L=0;for(k=0;k<q;k++){j=U[L++],R=U[L++],B=C+j*4|0,Q=$=G=I=0;for(;R>0;R--)N=U[L++],I=I+N*M[B+3]|0,G=G+N*M[B+2]|0,$=$+N*M[B+1]|0,Q=Q+N*M[B]|0,B=B+4|0;Q>>=7,$>>=7,G>>=7,I>>=7,K[A+3]=m(I+8192>>14),K[A+2]=m(G+8192>>14),K[A+1]=m($+8192>>14),K[A]=m(Q+8192>>14),A=A+J*4|0}A=(D+1)*4|0,C=(D+1)*Z*4|0}}function $M(M,K,Z,J,q,U){var Q,$,G,I,L,j,R,B,D,k,N,C,A=0,y=0;for(k=0;k<J;k++){j=0;for(N=0;N<q;N++){R=U[j++],B=U[j++],D=A+R*4|0,Q=$=G=I=0;for(;B>0;B--)C=U[j++],L=M[D+3],I=I+C*L|0,G=G+C*M[D+2]*L|0,$=$+C*M[D+1]*L|0,Q=Q+C*M[D]*L|0,D=D+4|0;G=G/255|0,$=$/255|0,Q=Q/255|0,K[y+3]=x(I>>7),K[y+2]=x(G>>7),K[y+1]=x($>>7),K[y]=x(Q>>7),y=y+J*4|0}y=(k+1)*4|0,A=(k+1)*Z*4|0}}function qM(M,K,Z,J,q,U){var Q,$,G,I,L,j,R,B,D,k,N,C=0,A=0;for(D=0;D<J;D++){L=0;for(k=0;k<q;k++){j=U[L++],R=U[L++],B=C+j*4|0,Q=$=G=I=0;for(;R>0;R--)N=U[L++],I=I+N*M[B+3]|0,G=G+N*M[B+2]|0,$=$+N*M[B+1]|0,Q=Q+N*M[B]|0,B=B+4|0;if(Q>>=7,$>>=7,G>>=7,I>>=7,I=m(I+8192>>14),I>0)Q=Q*255/I|0,$=$*255/I|0,G=G*255/I|0;K[A+3]=I,K[A+2]=m(G+8192>>14),K[A+1]=m($+8192>>14),K[A]=m(Q+8192>>14),A=A+J*4|0}A=(D+1)*4|0,C=(D+1)*Z*4|0}}function FM(M,K,Z){let J=3,q=K*Z*4|0;while(J<q){if(M[J]!==255)return!0;J=J+4|0}return!1}function OM(M,K,Z){let J=3,q=K*Z*4|0;while(J<q)M[J]=255,J=J+4|0}function UM(M){let{src:K,width:Z,height:J,toWidth:q,toHeight:U}=M,Q=M.scaleX||M.toWidth/M.width,$=M.scaleY||M.toHeight/M.height,G=M.offsetX||0,I=M.offsetY||0,L=M.dest||new Uint8Array(q*U*4),j=typeof M.filter==="undefined"?"mks2013":M.filter,R=f(j,Z,q,Q,G),B=f(j,J,U,$,I),D=new Uint16Array(q*J*4);if(FM(K,Z,J))$M(K,D,Z,J,q,R),qM(D,L,J,q,U,B);else QM(K,D,Z,J,q,R),ZM(D,L,J,q,U,B),OM(L,q,U);return L}var DM=zM(BM(),1);function WM(M,K,Z){var J=K*Z,q=new Uint16Array(J),U,Q,$,G;for(var I=0;I<J;I++)U=M[4*I],Q=M[4*I+1],$=M[4*I+2],G=U>=Q&&U>=$?U:Q>="<WORKER_CODE>"&Q>=U?Q:$,q[I]=G<<8;return q}function AM(M,K,Z,J,q,U){var Q,$,G,I,L;if(J===0||q<0.5)return;if(q>2)q=2;var j=WM(M,K,Z),R=new Uint16Array(j);DM.default(R,K,Z,q);var B=J/100*4096+0.5|0,D=U<<8,k=K*Z;for(var N=0;N<k;N++)if(Q=j[N],I=Q-R[N],Math.abs(I)>=D)$=Q+(B*I+2048>>12),$=$>65280?65280:$,$=$<0?0:$,Q=Q!==0?Q:1,G=($<<12)/Q|0,L=N*4,M[L]=M[L]*G+2048>>12,M[L+1]=M[L+1]*G+2048>>12,M[L+2]=M[L+2]*G+2048>>12}function RM(M,K){let Z=UM(M,K);if(M.unsharpAmount)AM(Z,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return Z}function NM(M,K){return Promise.resolve().then(()=>{return{data:RM(M,K.__mathCache)}})}function kM(M,K,Z){let J;if(K.bitmap)return Z.toCtx.drawImage(K.bitmap,M.toX,M.toY),null;if(J=new ImageData(new Uint8ClampedArray(K.data),M.toWidth,M.toHeight),!1)Z.toCtx.putImageData(J,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth+0.00001,M.toInnerHeight+0.00001);else Z.toCtx.putImageData(J,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth,M.toInnerHeight);return null}function CM(M,K,Z){let J={srcCtx:null,srcImageBitmap:null,isImageBitmapReused:!1,toCtx:null},q=(U)=>{let Q={width:U.width,height:U.height,toWidth:U.toWidth,toHeight:U.toHeight,scaleX:U.scaleX,scaleY:U.scaleY,offsetX:U.offsetX,offsetY:U.offsetY,filter:Z.filter,unsharpAmount:Z.unsharpAmount,unsharpRadius:Z.unsharpRadius,unsharpThreshold:Z.unsharpThreshold};return Promise.resolve(Q).then(($)=>t(U,M,Z,J,$)).then(($)=>{return NM($,Z)}).then(($)=>{return J.srcImageData=null,kM(U,$,J)})};return Promise.resolve().then(()=>{if(J.toCtx=K.getContext("2d"),i(M))return null;if(r(M))return J.srcImageBitmap=M,J.isImageBitmapReused=!0,null;throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap')}).then(()=>{if(Z.canceled)return Z.cancelToken;let Q=JM({width:Z.width,height:Z.height,srcTileSize:1024,toWidth:Z.toWidth,toHeight:Z.toHeight,destTileBorder:Z.__destTileBorder}).map((G)=>q(G));function $(G){if(G.srcImageBitmap){if(!G.isImageBitmapReused)G.srcImageBitmap.close();G.srcImageBitmap=null}}return Promise.all(Q).then(()=>{return $(J),K},(G)=>{throw $(J),G})})}function l(M,K,Z,J){if(J.canceled)return J.cancelToken;let[q,U]=M.shift(),Q=M.length===0;J.toWidth=q,J.toHeight=U;let $;if(!Q)$=new OffscreenCanvas(q,U);return CM(K,Q?Z:$,J).then(()=>{if(Q)return Z;return J.width=q,J.height=U,l(M,$,Z,J)}).then((G)=>{if($)$.width=$.height=0;return G})}async function yM(M,K){let Z=await createImageBitmap(M),J=Z.width,q=Z.height,U=K/J,Q=K/q,$=Math.min(U,Q,1),G=Math.floor(J*$),I=Math.floor(q*$),L=new OffscreenCanvas(G,I),j={filter:"mks2013",unsharpAmount:0,unsharpRadius:0,unsharpThreshold:0,width:J,height:q,toWidth:G,toHeight:I,canceled:!1,__destTileBorder:3},R=s(j.width,j.height,j.toWidth,j.toHeight,1024,j.__destTileBorder);return(await l(R,Z,L,j)).transferToImageBitmap()}self.onmessage=async(M)=>{let{taskId:K,blob:Z,options:J}=M.data;try{let q=await yM(Z,J.maxDimension);self.postMessage({taskId:K,output:q},[q])}catch(q){self.postMessage({taskId:K,error:q})}};
`,hk=new Blob([uk],{type:"application/javascript"}),xk=(()=>{let k=0;return()=>++k})();class Vk{#M;#Q;#I;#k;constructor(){this.#M=new Map,this.#Q=new Map,this.#I=new Map,this.#k=new Map}get count(){return this.#M.size}setWorkerTimeout(k,M){let q=setTimeout(()=>{let Q=this.#M.get(k);if(Q)this.#I.delete(Q);if(Q)this.#k.delete(Q);this.#Q.delete(k),this.#M.delete(k),k.terminate()},M);this.#Q.set(k,q)}clearWorkerTimeout(k){clearTimeout(this.#Q.get(k))}addWorker(k){this.#M.set(k,null)}getWorker(k){return this.#I.get(k)}getTask(k){return this.#k.get(k)}getAvailableWorker(){for(let[k,M]of this.#M.entries())if(M===null)return k;return null}assignTask(k,M){this.#M.set(k,M.id),this.#I.set(M.id,k),this.#k.set(M.id,M);let q={taskId:M.id,blob:M.data.blob,options:M.data.options};k.postMessage(q)}removeTask(k){let M=this.#I.get(k);if(M)this.#M.set(M,null);this.#I.delete(k),this.#k.delete(k)}}class o{#M;#Q;#I;#k;constructor(){let k=typeof navigator==="undefined"?1:navigator.hardwareConcurrency;this.#M=2000,this.#Q=Math.min(k,4),this.#I=[],this.#k=new Vk}#K(){let k=new Worker(URL.createObjectURL(hk));k.onmessage=(M)=>{let{taskId:q,output:Q,error:Z}=M.data,J=this.#k.getWorker(q),I=this.#k.getTask(q);if(Z){if(I)I.reject(Z)}else if(I)I.resolve(Q);if(this.#k.removeTask(q),J)this.#k.setWorkerTimeout(J,this.#M);this.#q()},k.onerror=(M)=>{console.log(M.message),console.log(M)},this.#k.addWorker(k)}#q(){let k=this.#k.getAvailableWorker();if(k){let M=this.#I.shift();if(M)this.#k.assignTask(k,M),this.#k.clearWorkerTimeout(k)}else if(this.#k.count<this.#Q)this.#K(),this.#q()}addTask(k){return new Promise((M,q)=>{this.#I.push({id:xk(),data:{blob:k.blob,options:k.options},resolve:M,reject:q}),this.#q()})}}class vk{#M;#Q;constructor(k){this.#M=new o,this.#Q=k}squish(k,M){let q=M?.maxDimension||this.#Q.maxDimension;if(M?.useMainThread||this.#Q.useMainThread)return Nk(k,q);return this.#M.addTask({blob:k,options:M||this.#Q})}}export{vk as PicSquish};
