var ND=Object.create;var{getPrototypeOf:XD,defineProperty:f,getOwnPropertyNames:ED}=Object;var YD=Object.prototype.hasOwnProperty;var zD=(D,A,J)=>{J=D!=null?ND(XD(D)):{};let U=A||!D||!D.__esModule?f(J,"default",{value:D,enumerable:!0}):J;for(let K of ED(D))if(!YD.call(U,K))f(U,K,{get:()=>D[K],enumerable:!0});return U};var CD=(D,A)=>()=>(A||D((A={exports:{}}).exports,A),A.exports);var jD=CD((G8,BD)=>{var x,n,m,h,w,_,$D,GD;function TD(D){if(D<0.5)D=0.5;var A=Math.exp(0.527076)/D,J=Math.exp(-A),U=Math.exp(-2*A),K=(1-J)*(1-J)/(1+2*A*J-U);return x=K,n=K*(A-1)*J,m=K*(A+1)*J,h=-K*U,w=2*J,_=-U,$D=(x+n)/(1-w-_),GD=(m+h)/(1-w-_),new Float32Array([x,n,m,h,w,_,$D,GD])}function ZD(D,A,J,U,K,G){var $,Z,j,B,b,Q,V,R,y,q,L,N,M,X;for(y=0;y<G;y++){Q=y*K,V=y,R=0,$=D[Q],b=$*U[6],B=b,L=U[0],N=U[1],M=U[4],X=U[5];for(q=0;q<K;q++)Z=D[Q],j=Z*L+$*N+B*M+b*X,b=B,B=j,$=Z,J[R]=B,R++,Q++;Q--,R--,V+=G*(K-1),$=D[Q],b=$*U[7],B=b,Z=$,L=U[2],N=U[3];for(q=K-1;q>=0;q--)j=Z*L+$*N+B*M+b*X,b=B,B=j,$=Z,Z=D[Q],A[V]=J[R]+B,Q--,R--,V-=G}}function kD(D,A,J,U){if(!U)return;var K=new Uint16Array(D.length),G=new Float32Array(Math.max(A,J)),$=TD(U);ZD(D,K,G,$,A,J,U),ZD(K,D,G,$,J,A,U)}BD.exports=kD});class T{raw;width;height;constructor(D,A,J){this.raw=D,this.width=A,this.height=J}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let D=document.createElement("canvas");D.width=this.width,D.height=this.height;let A=D.getContext("2d");if(!A)throw new Error("Picsquish error: canvas 2D context not supported");return A.putImageData(this.toImageData(),0,0),D}toBlob(D="image/png"){let A=new OffscreenCanvas(this.width,this.height),J=A.getContext("2d");if(!J)throw new Error("Picsquish error: canvas 2D context not supported");return J.putImageData(this.toImageData(),0,0),A.convertToBlob({type:D})}}var Y=4;function a(D,A,J){let U=new Uint8ClampedArray(J.tile);for(let K=0;K<J.toHeight;K++){let G=K*J.toWidth*Y,$=((J.toY+K)*A+J.toX)*Y;D.set(U.subarray(G,G+J.toWidth*Y),$)}}var ID=`
var Kk=Object.create;var{getPrototypeOf:$k,defineProperty:m,getOwnPropertyNames:Gk}=Object;var Qk=Object.prototype.hasOwnProperty;var Zk=(k,u,I)=>{I=k!=null?Kk($k(k)):{};let M=u||!k||!k.__esModule?m(I,"default",{value:k,enumerable:!0}):I;for(let q of Gk(k))if(!Qk.call(M,q))m(M,q,{get:()=>k[q],enumerable:!0});return M};var Bk=(k,u)=>()=>(u||k((u={exports:{}}).exports,u),u.exports);var Ik=Bk((sk,Mk)=>{var n,_,x,g,T,H,i,kk;function Xk(k){if(k<0.5)k=0.5;var u=Math.exp(0.527076)/k,I=Math.exp(-u),M=Math.exp(-2*u),q=(1-I)*(1-I)/(1+2*u*I-M);return n=q,_=q*(u-1)*I,x=q*(u+1)*I,g=-q*M,T=2*I,H=-M,i=(n+_)/(1-T-H),kk=(x+g)/(1-T-H),new Float32Array([n,_,x,g,T,H,i,kk])}function uk(k,u,I,M,q,J){var D,R,U,y,K,Z,j,A,G,B,Q,b,$,C;for(G=0;G<J;G++){Z=G*q,j=G,A=0,D=k[Z],K=D*M[6],y=K,Q=M[0],b=M[1],$=M[4],C=M[5];for(B=0;B<q;B++)R=k[Z],U=R*Q+D*b+y*$+K*C,K=y,y=U,D=R,I[A]=y,A++,Z++;Z--,A--,j+=J*(q-1),D=k[Z],K=D*M[7],y=K,R=D,Q=M[2],b=M[3];for(B=q-1;B>=0;B--)U=R*Q+D*b+y*$+K*C,K=y,y=U,D=R,R=k[Z],u[j]=I[A]+y,Z--,A--,j-=J}}function Yk(k,u,I,M){if(!M)return;var q=new Uint16Array(k.length),J=new Float32Array(Math.max(u,I)),D=Xk(M);uk(k,q,J,D,u,I,M),uk(q,k,J,D,I,u,M)}Mk.exports=Yk});var S=4;var jk=2;function a(k,u,I,M,q,J){let D=I/k,R=M/u,U=(2*J+jk+1)/q;if(U>0.5)return[{toWidth:I,toHeight:M}];let y=Math.ceil(Math.log(Math.min(D,R))/Math.log(U));if(y<=1)return[{toWidth:I,toHeight:M}];let K=[];for(let Z=0;Z<y;Z++){let j=Math.round(Math.pow(Math.pow(k,y-Z-1)*Math.pow(I,Z+1),1/y)),A=Math.round(Math.pow(Math.pow(u,y-Z-1)*Math.pow(M,Z+1),1/y));K.push({toWidth:j,toHeight:A})}return K}function bk(k,u){if(k)k.width=k.height=0;k=u=null}function Ck(k,u){let I=new OffscreenCanvas(u.width,u.height),M=I.getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");M.globalCompositeOperation="copy",M.drawImage(k,u.x,u.y,u.width,u.height,0,0,u.width,u.height);let q=M.getImageData(0,0,u.width,u.height).data.buffer;return bk(I,M),q}function Lk(k,u,I){let M=new Uint8ClampedArray(I.width*I.height*S);for(let q=0;q<I.height;q++){let J=((I.y+q)*u+I.x)*S,D=q*I.width*S;M.set(k.subarray(J,J+I.width*S),D)}return M.buffer}function h(k,u,I){if(k instanceof ImageBitmap)return Ck(k,I);else return Lk(k,u,I)}var o=0.00001;function O(k){let u=Math.round(k);if(Math.abs(k-u)<o)return u;return Math.floor(k)}function d(k){let u=Math.round(k);if(Math.abs(k-u)<o)return u;return Math.ceil(k)}function W(k,u,I,M,q,J){let{initialSize:D,filterPadding:R,filter:U,unsharpAmount:y,unsharpRadius:K,unsharpThreshold:Z}=J,j=M/u,A=q/I,G=O(D*j)-2*R,B=O(D*A)-2*R;if(G<1||B<1)throw new Error("Picsquish error: target tile width/height is too small");let Q,b,$,C,V,z,L=[];for(C=0;C<q;C+=B)for($=0;$<M;$+=G){if(Q=$-R,Q<0)Q=0;if(V=$+G+R-Q,Q+V>=M)V=M-Q;if(b=C-R,b<0)b=0;if(z=C+B+R-b,b+z>=q)z=q-b;let w={toX:Q,toY:b,toWidth:V,toHeight:z,toInnerX:$,toInnerY:C,toInnerWidth:G,toInnerHeight:B,offsetX:Q/j-O(Q/j),offsetY:b/A-O(b/A),scaleX:j,scaleY:A,x:O(Q/j),y:O(b/A),width:d(V/j),height:d(z/A),initialSize:D,filterPadding:R,filter:U,unsharpAmount:y,unsharpRadius:K,unsharpThreshold:Z},F=h(k,u,w);L.push({tile:F,...w})}return L}async function wk(k,u,I){let M=await createImageBitmap(k),q=[];for(let J of I){let D=M,R=M.width,U=M.height,y=J/R,K=J/U,Z=Math.min(y,K,1),j=Math.floor(R*Z),A=Math.floor(U*Z),G=a(R,U,j,A,u.initialSize,u.filterPadding),B=W(D,R,U,G[0].toWidth,G[0].toHeight,u);q.push({stages:G,tileTransforms:B})}return M.close(),q}function Vk(k,u){let I=W(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,u);return[{stages:k.stages,tileTransforms:I}]}async function c(k){if(k.image instanceof Blob)return wk(k.image,k.tileOptions,k.dimensionLimits);else return Vk(k.image,k.tileOptions)}var p={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*(0.54+0.46*Math.cos(u/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/2)/(u/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/3)/(u/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var zk=14;function s(k){return Math.round(k*((1<<zk)-1))}function v(k,u,I,M,q){let J=p[k].fn,D=1/M,R=Math.min(1,M),U=p[k].win/R,y,K,Z,j,A,G,B,Q,b,$,C,V,z,L,w,F,P,Ak=Math.floor((U+1)*2),N=new Int16Array((Ak+2)*I),Y=0,Jk=!N.subarray||!N.set;for(y=0;y<I;y++){K=(y+0.5)*D+q,Z=Math.max(0,Math.floor(K-U)),j=Math.min(u-1,Math.ceil(K+U)),A=j-Z+1,G=new Float32Array(A),B=new Int16Array(A),Q=0;for(b=Z,$=0;b<=j;b++,$++)C=J((b+0.5-K)*R),Q+=C,G[$]=C;V=0;for($=0;$<G.length;$++)z=G[$]/Q,V+=z,B[$]=s(z);B[I>>1]+=s(1-V),L=0;while(L<B.length&&B[L]===0)L++;if(L<B.length){w=B.length-1;while(w>0&&B[w]===0)w--;if(F=Z+L,P=w-L+1,N[Y++]=F,N[Y++]=P,!Jk)N.set(B.subarray(L,w+1),Y),Y+=P;else for($=L;$<=w;$++)N[Y++]=B[$]}else N[Y++]=0,N[Y++]=0}return N}function E(k){return k<0?0:k>255?255:k}function X(k){return k>=0?k:0}function f(k,u,I,M,q,J){let D,R,U,y,K,Z,j,A,G,B,Q,b=0,$=0;for(G=0;G<M;G++){K=0;for(B=0;B<q;B++){Z=J[K++],j=J[K++],A=b+Z*4|0,D=R=U=y=0;for(;j>0;j--)Q=J[K++],y=y+Q*k[A+3]|0,U=U+Q*k[A+2]|0,R=R+Q*k[A+1]|0,D=D+Q*k[A]|0,A=A+4|0;u[$+3]=X(y>>7),u[$+2]=X(U>>7),u[$+1]=X(R>>7),u[$]=X(D>>7),$=$+M*4|0}$=(G+1)*4|0,b=(G+1)*I*4|0}}function l(k,u,I,M,q,J){let D,R,U,y,K,Z,j,A,G,B,Q,b=0,$=0;for(G=0;G<M;G++){K=0;for(B=0;B<q;B++){Z=J[K++],j=J[K++],A=b+Z*4|0,D=R=U=y=0;for(;j>0;j--)Q=J[K++],y=y+Q*k[A+3]|0,U=U+Q*k[A+2]|0,R=R+Q*k[A+1]|0,D=D+Q*k[A]|0,A=A+4|0;D>>=7,R>>=7,U>>=7,y>>=7,u[$+3]=E(y+8192>>14),u[$+2]=E(U+8192>>14),u[$+1]=E(R+8192>>14),u[$]=E(D+8192>>14),$=$+M*4|0}$=(G+1)*4|0,b=(G+1)*I*4|0}}function r(k,u,I,M,q,J){let D,R,U,y,K,Z,j,A,G,B,Q,b,$=0,C=0;for(B=0;B<M;B++){Z=0;for(Q=0;Q<q;Q++){j=J[Z++],A=J[Z++],G=$+j*4|0,D=R=U=y=0;for(;A>0;A--)b=J[Z++],K=k[G+3],y=y+b*K|0,U=U+b*k[G+2]*K|0,R=R+b*k[G+1]*K|0,D=D+b*k[G]*K|0,G=G+4|0;U=U/255|0,R=R/255|0,D=D/255|0,u[C+3]=X(y>>7),u[C+2]=X(U>>7),u[C+1]=X(R>>7),u[C]=X(D>>7),C=C+M*4|0}C=(B+1)*4|0,$=(B+1)*I*4|0}}function e(k,u,I,M,q,J){let D,R,U,y,K,Z,j,A,G,B,Q,b=0,$=0;for(G=0;G<M;G++){K=0;for(B=0;B<q;B++){Z=J[K++],j=J[K++],A=b+Z*4|0,D=R=U=y=0;for(;j>0;j--)Q=J[K++],y=y+Q*k[A+3]|0,U=U+Q*k[A+2]|0,R=R+Q*k[A+1]|0,D=D+Q*k[A]|0,A=A+4|0;if(D>>=7,R>>=7,U>>=7,y>>=7,y=E(y+8192>>14),y>0)D=D*255/y|0,R=R*255/y|0,U=U*255/y|0;u[$+3]=y,u[$+2]=E(U+8192>>14),u[$+1]=E(R+8192>>14),u[$]=E(D+8192>>14),$=$+M*4|0}$=(G+1)*4|0,b=(G+1)*I*4|0}}function Nk(k,u,I){let M=3,q=u*I*4|0;while(M<q){if(k[M]!==255)return!0;M=M+4|0}return!1}function Ek(k,u,I){let M=3,q=u*I*4|0;while(M<q)k[M]=255,M=M+4|0}function t(k,u,I,M,q,J,D,R,U,y){let K=v(u,I,q,D,U),Z=v(u,M,J,R,y),j=new Uint8Array(q*J*4),A=new Uint16Array(q*M*4);if(Nk(k,I,M))r(k,A,I,M,q,K),e(A,j,M,q,J,Z);else f(k,A,I,M,q,K),l(A,j,M,q,J,Z),Ek(j,q,J);return j}var Dk=Zk(Ik(),1);function Ok(k,u,I){let M=u*I,q=new Uint16Array(M),J,D,R,U;for(let y=0;y<M;y++)J=k[4*y],D=k[4*y+1],R=k[4*y+2],U=J>=D&&J>=R?J:D>=R&&D>=J?D:R,q[y]=U<<8;return q}function qk(k,u,I,M,q,J){let D,R,U,y,K;if(M===0||q<0.5)return;if(q>2)q=2;let Z=Ok(k,u,I),j=new Uint16Array(Z);Dk.default(j,u,I,q);let A=M/100*4096+0.5|0,G=J<<8,B=u*I;for(let Q=0;Q<B;Q++)if(D=Z[Q],y=D-j[Q],Math.abs(y)>=G)R=D+(A*y+2048>>12),R=R>65280?65280:R,R=R<0?0:R,D=D!==0?D:1,U=(R<<12)/D|0,K=Q*4,k[K]=k[K]*U+2048>>12,k[K+1]=k[K+1]*U+2048>>12,k[K+2]=k[K+2]*U+2048>>12}function Rk(k){let u=t(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)qk(u,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return u}async function yk(k){let{taskId:u,squishId:I,taskType:M,data:q}=k,{image:J,dimensionLimits:D,tileOptions:R}=q;try{let U=await c({image:J,dimensionLimits:D,tileOptions:R});return{taskId:u,squishId:I,taskType:M,output:U}}catch(U){return{taskId:u,squishId:I,taskType:M,output:U}}}function Uk(k){let{taskId:u,squishId:I,workspaceIndex:M,taskType:q,data:J}=k,{tileTransform:D}=J;try{return D.tile=Rk(D).buffer,{taskId:u,squishId:I,workspaceIndex:M,taskType:q,output:D}}catch(R){return{taskId:u,squishId:I,workspaceIndex:M,taskType:q,output:R}}}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let u=k.data,I=await yk(u),M=I.output instanceof Error?[]:I.output.flatMap((q)=>q.tileTransforms.map((J)=>J.tile));return self.postMessage(I,M)}case 1:{let u=k.data,I=Uk(u),M=I.output instanceof Error?[]:[I.output.tile];return self.postMessage(I,M)}}};
`,OD=new Blob([ID],{type:"application/javascript"});class l{#D;#U;#A;#J;constructor(){this.#D=new Map,this.#U=new Map,this.#A=null,this.#J=null}#K(){if(this.#A===null)return;clearTimeout(this.#A),this.#A=null}prepare(D,A,J){if(this.#D.size)return;this.#J=J;let U=URL.createObjectURL(OD);while(this.#D.size<A){let K=new Worker(U);K.onmessage=D,this.#D.set(K,null)}URL.revokeObjectURL(U)}assignTask(D,A,J,U){this.#D.set(D,A),this.#U.set(A,D),this.#K(),D.postMessage(J,U)}setTimeout(){if(this.#A!==null)return;if(this.#D.size===0)return;this.#A=setTimeout(()=>{for(let D of this.#D.keys())D.terminate();this.#D.clear(),this.#U.clear()},this.#J||0)}getAvailableWorkers(){let D=[];for(let[A,J]of this.#D.entries())if(J===null)D.push(A);return D}removeTask(D){let A=this.#U.get(D);if(A)this.#D.set(A,null);this.#U.delete(D)}}var v=new l;var FD=2;function o(D,A,J,U,K,G){let $=J/D,Z=U/A,j=(2*G+FD+1)/K;if(j>0.5)return[{toWidth:J,toHeight:U}];let B=Math.ceil(Math.log(Math.min($,Z))/Math.log(j));if(B<=1)return[{toWidth:J,toHeight:U}];let b=[];for(let Q=0;Q<B;Q++){let V=Math.round(Math.pow(Math.pow(D,B-Q-1)*Math.pow(J,Q+1),1/B)),R=Math.round(Math.pow(Math.pow(A,B-Q-1)*Math.pow(U,Q+1),1/B));b.push({toWidth:V,toHeight:R})}return b}function SD(D,A){if(D)D.width=D.height=0;D=A=null}function HD(D,A){let J=new OffscreenCanvas(A.width,A.height),U=J.getContext("2d");if(!U)throw new Error("Picsquish error: canvas 2D context not supported");U.globalCompositeOperation="copy",U.drawImage(D,A.x,A.y,A.width,A.height,0,0,A.width,A.height);let K=U.getImageData(0,0,A.width,A.height).data.buffer;return SD(J,U),K}function vD(D,A,J){let U=new Uint8ClampedArray(J.width*J.height*Y);for(let K=0;K<J.height;K++){let G=((J.y+K)*A+J.x)*Y,$=K*J.width*Y;U.set(D.subarray(G,G+J.width*Y),$)}return U.buffer}function s(D,A,J){if(D instanceof ImageBitmap)return HD(D,J);else return vD(D,A,J)}var i=0.00001;function W(D){let A=Math.round(D);if(Math.abs(D-A)<i)return A;return Math.floor(D)}function r(D){let A=Math.round(D);if(Math.abs(D-A)<i)return A;return Math.ceil(D)}function k(D,A,J,U,K,G){let{initialSize:$,filterPadding:Z,filter:j,unsharpAmount:B,unsharpRadius:b,unsharpThreshold:Q}=G,V=U/A,R=K/J,y=W($*V)-2*Z,q=W($*R)-2*Z;if(y<1||q<1)throw new Error("Picsquish error: target tile width/height is too small");let L,N,M,X,C,I,E=[];for(X=0;X<K;X+=q)for(M=0;M<U;M+=y){if(L=M-Z,L<0)L=0;if(C=M+y+Z-L,L+C>=U)C=U-L;if(N=X-Z,N<0)N=0;if(I=X+q+Z-N,N+I>=K)I=K-N;let z={toX:L,toY:N,toWidth:C,toHeight:I,toInnerX:M,toInnerY:X,toInnerWidth:y,toInnerHeight:q,offsetX:L/V-W(L/V),offsetY:N/R-W(N/R),scaleX:V,scaleY:R,x:W(L/V),y:W(N/R),width:r(C/V),height:r(I/R),initialSize:$,filterPadding:Z,filter:j,unsharpAmount:B,unsharpRadius:b,unsharpThreshold:Q},P=s(D,A,z);E.push({tile:P,...z})}return E}async function WD(D,A,J){let U=await createImageBitmap(D),K=[];for(let G of J){let $=U,Z=U.width,j=U.height,B=G/Z,b=G/j,Q=Math.min(B,b,1),V=Math.floor(Z*Q),R=Math.floor(j*Q),y=o(Z,j,V,R,A.initialSize,A.filterPadding),q=k($,Z,j,y[0].toWidth,y[0].toHeight,A);K.push({stages:y,tileTransforms:q})}return U.close(),K}function PD(D,A){let J=k(D.from,D.fromWidth,D.fromHeight,D.stages[0].toWidth,D.stages[0].toHeight,A);return[{stages:D.stages,tileTransforms:J}]}async function t(D){if(D.image instanceof Blob)return WD(D.image,D.tileOptions,D.dimensionLimits);else return PD(D.image,D.tileOptions)}var p={box:{win:0.5,fn:(D)=>{if(D<0)D=-D;return D<0.5?1:0}},hamming:{win:1,fn:(D)=>{if(D<0)D=-D;if(D>=1)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*(0.54+0.46*Math.cos(A/1))}},lanczos2:{win:2,fn:(D)=>{if(D<0)D=-D;if(D>=2)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*Math.sin(A/2)/(A/2)}},lanczos3:{win:3,fn:(D)=>{if(D<0)D=-D;if(D>=3)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*Math.sin(A/3)/(A/3)}},mks2013:{win:2.5,fn:(D)=>{if(D<0)D=-D;if(D>=2.5)return 0;if(D>=1.5)return-0.125*(D-2.5)*(D-2.5);if(D>=0.5)return 0.25*(4*D*D-11*D+7);return 1.0625-1.75*D*D}}};var wD=14;function e(D){return Math.round(D*((1<<wD)-1))}function g(D,A,J,U,K){let G=p[D].fn,$=1/U,Z=Math.min(1,U),j=p[D].win/Z,B,b,Q,V,R,y,q,L,N,M,X,C,I,E,z,P,u,qD=Math.floor((j+1)*2),O=new Int16Array((qD+2)*J),H=0,VD=!O.subarray||!O.set;for(B=0;B<J;B++){b=(B+0.5)*$+K,Q=Math.max(0,Math.floor(b-j)),V=Math.min(A-1,Math.ceil(b+j)),R=V-Q+1,y=new Float32Array(R),q=new Int16Array(R),L=0;for(N=Q,M=0;N<=V;N++,M++)X=G((N+0.5-b)*Z),L+=X,y[M]=X;C=0;for(M=0;M<y.length;M++)I=y[M]/L,C+=I,q[M]=e(I);q[J>>1]+=e(1-C),E=0;while(E<q.length&&q[E]===0)E++;if(E<q.length){z=q.length-1;while(z>0&&q[z]===0)z--;if(P=Q+E,u=z-E+1,O[H++]=P,O[H++]=u,!VD)O.set(q.subarray(E,z+1),H),H+=u;else for(M=E;M<=z;M++)O[H++]=q[M]}else O[H++]=0,O[H++]=0}return O}function F(D){return D<0?0:D>255?255:D}function S(D){return D>=0?D:0}function DD(D,A,J,U,K,G){let $,Z,j,B,b,Q,V,R,y,q,L,N=0,M=0;for(y=0;y<U;y++){b=0;for(q=0;q<K;q++){Q=G[b++],V=G[b++],R=N+Q*4|0,$=Z=j=B=0;for(;V>0;V--)L=G[b++],B=B+L*D[R+3]|0,j=j+L*D[R+2]|0,Z=Z+L*D[R+1]|0,$=$+L*D[R]|0,R=R+4|0;A[M+3]=S(B>>7),A[M+2]=S(j>>7),A[M+1]=S(Z>>7),A[M]=S($>>7),M=M+U*4|0}M=(y+1)*4|0,N=(y+1)*J*4|0}}function AD(D,A,J,U,K,G){let $,Z,j,B,b,Q,V,R,y,q,L,N=0,M=0;for(y=0;y<U;y++){b=0;for(q=0;q<K;q++){Q=G[b++],V=G[b++],R=N+Q*4|0,$=Z=j=B=0;for(;V>0;V--)L=G[b++],B=B+L*D[R+3]|0,j=j+L*D[R+2]|0,Z=Z+L*D[R+1]|0,$=$+L*D[R]|0,R=R+4|0;$>>=7,Z>>=7,j>>=7,B>>=7,A[M+3]=F(B+8192>>14),A[M+2]=F(j+8192>>14),A[M+1]=F(Z+8192>>14),A[M]=F($+8192>>14),M=M+U*4|0}M=(y+1)*4|0,N=(y+1)*J*4|0}}function UD(D,A,J,U,K,G){let $,Z,j,B,b,Q,V,R,y,q,L,N,M=0,X=0;for(q=0;q<U;q++){Q=0;for(L=0;L<K;L++){V=G[Q++],R=G[Q++],y=M+V*4|0,$=Z=j=B=0;for(;R>0;R--)N=G[Q++],b=D[y+3],B=B+N*b|0,j=j+N*D[y+2]*b|0,Z=Z+N*D[y+1]*b|0,$=$+N*D[y]*b|0,y=y+4|0;j=j/255|0,Z=Z/255|0,$=$/255|0,A[X+3]=S(B>>7),A[X+2]=S(j>>7),A[X+1]=S(Z>>7),A[X]=S($>>7),X=X+U*4|0}X=(q+1)*4|0,M=(q+1)*J*4|0}}function JD(D,A,J,U,K,G){let $,Z,j,B,b,Q,V,R,y,q,L,N=0,M=0;for(y=0;y<U;y++){b=0;for(q=0;q<K;q++){Q=G[b++],V=G[b++],R=N+Q*4|0,$=Z=j=B=0;for(;V>0;V--)L=G[b++],B=B+L*D[R+3]|0,j=j+L*D[R+2]|0,Z=Z+L*D[R+1]|0,$=$+L*D[R]|0,R=R+4|0;if($>>=7,Z>>=7,j>>=7,B>>=7,B=F(B+8192>>14),B>0)$=$*255/B|0,Z=Z*255/B|0,j=j*255/B|0;A[M+3]=B,A[M+2]=F(j+8192>>14),A[M+1]=F(Z+8192>>14),A[M]=F($+8192>>14),M=M+U*4|0}M=(y+1)*4|0,N=(y+1)*J*4|0}}function _D(D,A,J){let U=3,K=A*J*4|0;while(U<K){if(D[U]!==255)return!0;U=U+4|0}return!1}function uD(D,A,J){let U=3,K=A*J*4|0;while(U<K)D[U]=255,U=U+4|0}function KD(D,A,J,U,K,G,$,Z,j,B){let b=g(A,J,K,$,j),Q=g(A,U,G,Z,B),V=new Uint8Array(K*G*4),R=new Uint16Array(K*U*4);if(_D(D,J,U))UD(D,R,J,U,K,b),JD(R,V,U,K,G,Q);else DD(D,R,J,U,K,b),AD(R,V,U,K,G,Q),uD(V,K,G);return V}var RD=zD(jD(),1);function pD(D,A,J){let U=A*J,K=new Uint16Array(U),G,$,Z,j;for(let B=0;B<U;B++)G=D[4*B],$=D[4*B+1],Z=D[4*B+2],j=G>=$&&G>=Z?G:$>=Z&&$>=G?$:Z,K[B]=j<<8;return K}function bD(D,A,J,U,K,G){let $,Z,j,B,b;if(U===0||K<0.5)return;if(K>2)K=2;let Q=pD(D,A,J),V=new Uint16Array(Q);RD.default(V,A,J,K);let R=U/100*4096+0.5|0,y=G<<8,q=A*J;for(let L=0;L<q;L++)if($=Q[L],B=$-V[L],Math.abs(B)>=y)Z=$+(R*B+2048>>12),Z=Z>65280?65280:Z,Z=Z<0?0:Z,$=$!==0?$:1,j=(Z<<12)/$|0,b=L*4,D[b]=D[b]*j+2048>>12,D[b+1]=D[b+1]*j+2048>>12,D[b+2]=D[b+2]*j+2048>>12}function yD(D){let A=KD(new Uint8ClampedArray(D.tile),D.filter,D.width,D.height,D.toWidth,D.toHeight,D.scaleX,D.scaleY,D.offsetX,D.offsetY);if(D.unsharpAmount)bD(A,D.toWidth,D.toHeight,D.unsharpAmount,D.unsharpRadius,D.unsharpThreshold);return A}async function MD(D){let{taskId:A,squishId:J,taskType:U,data:K}=D,{image:G,dimensionLimits:$,tileOptions:Z}=K;try{let j=await t({image:G,dimensionLimits:$,tileOptions:Z});return{taskId:A,squishId:J,taskType:U,output:j}}catch(j){return{taskId:A,squishId:J,taskType:U,output:j}}}function QD(D){let{taskId:A,squishId:J,workspaceIndex:U,taskType:K,data:G}=D,{tileTransform:$}=G;try{return $.tile=yD($).buffer,{taskId:A,squishId:J,workspaceIndex:U,taskType:K,output:$}}catch(Z){return{taskId:A,squishId:J,workspaceIndex:U,taskType:K,output:Z}}}var c=(()=>{let D=0;return()=>++D})();class LD{#D;#U;#A;constructor(){this.#D=new Map,this.#U=[],this.#A=[]}#J(D,A){let J=c(),U={taskId:J,squishId:D.squishId,taskType:0,data:D.data};if(!A)return MD(U).then((G)=>this.#$(G));let K=D.data.image instanceof ImageBitmap?[D.data.image]:[];v.assignTask(A,J,U,K)}#K(D,A){let J=c(),U={taskId:J,squishId:D.squishId,workspaceIndex:D.workspaceIndex,taskType:1,data:D.data};if(!A)return this.#$(QD(U));v.assignTask(A,J,U,[D.data.tileTransform.tile])}#G(D){let A=this.#U.shift();if(A)return this.#J(A,D);let J=this.#A.shift();if(J)return this.#K(J,D)}#Z(D){if(this.#U.length===0&&this.#A.length===0)return v.setTimeout();if(D)return this.#G();let J=v.getAvailableWorkers();for(let U of J)this.#G(U)}#B(D,A){let{squishId:J,output:U}=A;if(U instanceof Error)return D.workspaceHandlers.forEach((K)=>K.reject(U));for(let[K,G]of U.entries()){let $=G.stages[0].toWidth,Z=G.stages[0].toHeight;D.workspaces.set(K,{to:new Uint8ClampedArray($*Z*Y),toWidth:$,toHeight:Z,stages:G.stages,remainingTileCount:G.tileTransforms.length});for(let j of G.tileTransforms)this.#A.push({squishId:J,workspaceIndex:K,data:{tileTransform:j}})}}#j(D,A){let{squishId:J,workspaceIndex:U,output:K}=A;if(!D.workspaces.has(U))return;let G=D.workspaces.get(U);if(!G)throw new Error("Picsquish error: workspace not found");let $=D.workspaceHandlers.get(U);if(!$)throw new Error("Picsquish error: workspaceHandler not found");if(K instanceof Error)return D.workspaces.delete(U),this.#A=this.#A.filter((j)=>!(j.squishId===J&&j.workspaceIndex===U)),$.reject(K);if(a(G.to,G.toWidth,K),--G.remainingTileCount,G.remainingTileCount)return;if(G.stages.shift(),!G.stages[0])return D.workspaces.delete(U),$.resolve(new T(G.to,G.toWidth,G.toHeight));this.#U.push({squishId:J,data:{image:{from:G.to,fromWidth:G.toWidth,fromHeight:G.toHeight,stages:G.stages},dimensionLimits:[],tileOptions:D.tileOptions}})}#$(D){let A=this.#D.get(D.squishId);if(!A)throw new Error("Picsquish error: squishContext not found");switch(D.taskType){case 0:this.#B(A,D);break;case 1:this.#j(A,D);break}if(!A.workspaces.size)this.#D.delete(D.squishId);v.removeTask(D.taskId),this.#Z(A.useMainThread)}add(D,A,J,U){if(!U)v.prepare((Z)=>this.#$(Z.data),A,J);let K=[],G=new Map;for(let Z=0;Z<D.dimensionLimits.length;Z++)K.push(new Promise((j,B)=>{G.set(Z,{resolve:j,reject:B})}));let $=c();return this.#D.set($,{tileOptions:D.tileOptions,workspaces:new Map,workspaceHandlers:G,useMainThread:U}),this.#U.push({squishId:$,data:D}),queueMicrotask(()=>this.#Z(U)),K}}var d=new LD;function _8(D,A,J={}){let U=J.tileSize||1024,K=J.filter||"mks2013",G=J.unsharpAmount||0,$=J.unsharpRadius||0,Z=J.unsharpThreshold||0,j=!!J.useMainThread,B=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,b=J.maxWorkerPoolSize||Math.min(B,4),Q=J.maxWorkerIdleTime||2000,V=3,R=Math.ceil(Math.max(3,2.5*$|0)),y={initialSize:U,filterPadding:R,filter:K,unsharpAmount:G,unsharpRadius:$,unsharpThreshold:Z};if(A instanceof Array)return d.add({image:D,dimensionLimits:A,tileOptions:y},b,Q,j);return d.add({image:D,dimensionLimits:[A],tileOptions:y},b,Q,j)[0]}export{_8 as squish};
