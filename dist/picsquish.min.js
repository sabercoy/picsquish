var jn=Object.create;var{getPrototypeOf:Gn,defineProperty:t,getOwnPropertyNames:En}=Object;var zn=Object.prototype.hasOwnProperty;var un=(n,k,I)=>{I=n!=null?jn(Gn(n)):{};let T=k||!n||!n.__esModule?t(I,"default",{value:n,enumerable:!0}):I;for(let M of En(n))if(!zn.call(T,M))t(T,M,{get:()=>n[M],enumerable:!0});return T};var Nn=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var Qn=Nn((yk,wn)=>{var l,c,f,_,s,x,Bn,Un;function Wn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,I=Math.exp(-k),T=Math.exp(-2*k),M=(1-I)*(1-I)/(1+2*k*I-T);return l=M,c=M*(k-1)*I,f=M*(k+1)*I,_=-M*T,s=2*I,x=-T,Bn=(l+c)/(1-s-x),Un=(f+_)/(1-s-x),new Float32Array([l,c,f,_,s,x,Bn,Un])}function Cn(n,k,I,T,M,y){var R,m,A,D,U,C,K,B,J,Q,L,$,w,q,j,z,Z,G,V,O,Y,E,X,u,o,h,S,a,W,F;for(o=0;o<y;o++){E=o*M,X=o,u=0,R=n[E],m=R&255,A=R>>8&255,D=R>>16&255,U=R>>24&255,G=m*T[6],V=A*T[6],O=D*T[6],Y=U*T[6],q=G,j=V,z=O,Z=Y,S=T[0],a=T[1],W=T[4],F=T[5];for(h=0;h<M;h++)R=n[E],C=R&255,K=R>>8&255,B=R>>16&255,J=R>>24&255,Q=C*S+m*a+q*W+G*F,L=K*S+A*a+j*W+V*F,$=B*S+D*a+z*W+O*F,w=J*S+U*a+Z*W+Y*F,G=q,V=j,O=z,Y=Z,q=Q,j=L,z=$,Z=w,m=C,A=K,D=B,U=J,I[u]=q,I[u+1]=j,I[u+2]=z,I[u+3]=Z,u+=4,E++;E--,u-=4,X+=y*(M-1),R=n[E],m=R&255,A=R>>8&255,D=R>>16&255,U=R>>24&255,G=m*T[7],V=A*T[7],O=D*T[7],Y=U*T[7],q=G,j=V,z=O,Z=Y,C=m,K=A,B=D,J=U,S=T[2],a=T[3];for(h=M-1;h>=0;h--)Q=C*S+m*a+q*W+G*F,L=K*S+A*a+j*W+V*F,$=B*S+D*a+z*W+O*F,w=J*S+U*a+Z*W+Y*F,G=q,V=j,O=z,Y=Z,q=Q,j=L,z=$,Z=w,m=C,A=K,D=B,U=J,R=n[E],C=R&255,K=R>>8&255,B=R>>16&255,J=R>>24&255,R=(I[u]+q<<0)+(I[u+1]+j<<8)+(I[u+2]+z<<16)+(I[u+3]+Z<<24),k[X]=R,E--,u-=4,X-=y}}function Fn(n,k,I,T){if(!T)return;var M=new Uint32Array(n.buffer),y=new Uint32Array(M.length),R=new Float32Array(Math.max(k,I)*4),m=Wn(T);Cn(M,y,R,m,k,I,T),Cn(y,M,R,m,I,k,T)}wn.exports=Fn});var N=4;var On=2;function e(n,k,I,T,M,y){let R=I/n,m=T/k,A=(2*y+On+1)/M;if(A>0.5)return[{toWidth:I,toHeight:T}];let D=Math.ceil(Math.log(Math.min(R,m))/Math.log(A));if(D<=1)return[{toWidth:I,toHeight:T}];let U=[];for(let C=0;C<D;C++){let K=Math.round(Math.pow(Math.pow(n,D-C-1)*Math.pow(I,C+1),1/D)),B=Math.round(Math.pow(Math.pow(k,D-C-1)*Math.pow(T,C+1),1/D));U.push({toWidth:K,toHeight:B})}return U}function Xn(n,k){let T=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!T)throw new Error("Canvas 2D context not supported");return T.globalCompositeOperation="copy",T.drawImage(n,k.x,k.y,k.width,k.height,0,0,k.width,k.height),T.getImageData(0,0,k.width,k.height).data.buffer}function Vn(n,k,I){let T=new Uint8ClampedArray(I.width*I.height*N);for(let M=0;M<I.height;M++){let y=((I.y+M)*k+I.x)*N,R=M*I.width*N;T.set(n.subarray(y,y+I.width*N),R)}return T.buffer}function r(n,k,I){if(n instanceof ImageBitmap)return Xn(n,I);else return Vn(n,k,I)}var kn=0.00001;function p(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.floor(n)}function nn(n){let k=Math.round(n);if(Math.abs(n-k)<kn)return k;return Math.ceil(n)}function Tn(n,k,I,T,M,y,R,m,A,D,U){let C=T/k,K=M/I,B=p(y*C)-2*R,J=p(y*K)-2*R;if(B<1||J<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let Q,L,$,w,q,j,z=[];for(w=0;w<M;w+=J)for($=0;$<T;$+=B){if(Q=$-R,Q<0)Q=0;if(q=$+B+R-Q,Q+q>=T)q=T-Q;if(L=w-R,L<0)L=0;if(j=w+J+R-L,L+j>=M)j=M-L;let Z={toX:Q,toY:L,toWidth:q,toHeight:j,toInnerX:$,toInnerY:w,toInnerWidth:B,toInnerHeight:J,offsetX:Q/C-p(Q/C),offsetY:L/K-p(L/K),scaleX:C,scaleY:K,x:p(Q/C),y:p(L/K),width:nn(q/C),height:nn(j/K),initialSize:y,filterPadding:R,filter:m,unsharpAmount:A,unsharpRadius:D,unsharpThreshold:U},G=r(n,k,Z);z.push({tile:G,...Z})}return z}async function In(n){let k,I,T,M,y,R;if(n.image instanceof Blob){let A=await createImageBitmap(n.image);k=A,I=A.width,T=A.height;let D=n.maxDimension/I,U=n.maxDimension/T,C=Math.min(D,U,1),K=Math.floor(I*C),B=Math.floor(T*C);M=e(I,T,K,B,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,I=n.image.fromWidth,T=n.image.fromHeight,M=n.image.stages;y=M[0].toWidth,R=M[0].toHeight;let m=Tn(k,I,T,y,R,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);if(k instanceof ImageBitmap)k.close();return{tileTransforms:m,stages:M}}function g(n,k,I){let T=new Uint8ClampedArray(I.tile);for(let M=0;M<I.toHeight;M++){let y=M*I.toWidth*N,R=((I.toY+M)*k+I.toX)*N;n.set(T.subarray(y,y+I.toWidth*N),R)}}var v={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Yn=14;function Rn(n){return Math.round(n*((1<<Yn)-1))}function d(n,k,I,T,M){let y=v[n].fn,R=1/T,m=Math.min(1,T),A=v[n].win/m,D,U,C,K,B,J,Q,L,$,w,q,j,z,Z,G,V,O,Y=Math.floor((A+1)*2),E=new Int16Array((Y+2)*I),X=0,u=!E.subarray||!E.set;for(D=0;D<I;D++){U=(D+0.5)*R+M,C=Math.max(0,Math.floor(U-A)),K=Math.min(k-1,Math.ceil(U+A)),B=K-C+1,J=new Float32Array(B),Q=new Int16Array(B),L=0;for($=C,w=0;$<=K;$++,w++)q=y(($+0.5-U)*m),L+=q,J[w]=q;j=0;for(w=0;w<J.length;w++)z=J[w]/L,j+=z,Q[w]=Rn(z);Q[I>>1]+=Rn(1-j),Z=0;while(Z<Q.length&&Q[Z]===0)Z++;if(Z<Q.length){G=Q.length-1;while(G>0&&Q[G]===0)G--;if(V=C+Z,O=G-Z+1,E[X++]=V,E[X++]=O,!u)E.set(Q.subarray(Z,G+1),X),X+=O;else for(w=Z;w<=G;w++)E[X++]=Q[w]}else E[X++]=0,E[X++]=0}return E}function H(n){return n<0?0:n>255?255:n}function P(n){return n>=0?n:0}function Mn(n,k,I,T,M,y){let R,m,A,D,U,C,K,B,J,Q,L,$=0,w=0;for(J=0;J<T;J++){U=0;for(Q=0;Q<M;Q++){C=y[U++],K=y[U++],B=$+C*4|0,R=m=A=D=0;for(;K>0;K--)L=y[U++],D=D+L*n[B+3]|0,A=A+L*n[B+2]|0,m=m+L*n[B+1]|0,R=R+L*n[B]|0,B=B+4|0;k[w+3]=P(D>>7),k[w+2]=P(A>>7),k[w+1]=P(m>>7),k[w]=P(R>>7),w=w+T*4|0}w=(J+1)*4|0,$=(J+1)*I*4|0}}function Dn(n,k,I,T,M,y){let R,m,A,D,U,C,K,B,J,Q,L,$=0,w=0;for(J=0;J<T;J++){U=0;for(Q=0;Q<M;Q++){C=y[U++],K=y[U++],B=$+C*4|0,R=m=A=D=0;for(;K>0;K--)L=y[U++],D=D+L*n[B+3]|0,A=A+L*n[B+2]|0,m=m+L*n[B+1]|0,R=R+L*n[B]|0,B=B+4|0;R>>=7,m>>=7,A>>=7,D>>=7,k[w+3]=H(D+8192>>14),k[w+2]=H(A+8192>>14),k[w+1]=H(m+8192>>14),k[w]=H(R+8192>>14),w=w+T*4|0}w=(J+1)*4|0,$=(J+1)*I*4|0}}function yn(n,k,I,T,M,y){let R,m,A,D,U,C,K,B,J,Q,L,$,w=0,q=0;for(Q=0;Q<T;Q++){C=0;for(L=0;L<M;L++){K=y[C++],B=y[C++],J=w+K*4|0,R=m=A=D=0;for(;B>0;B--)$=y[C++],U=n[J+3],D=D+$*U|0,A=A+$*n[J+2]*U|0,m=m+$*n[J+1]*U|0,R=R+$*n[J]*U|0,J=J+4|0;A=A/255|0,m=m/255|0,R=R/255|0,k[q+3]=P(D>>7),k[q+2]=P(A>>7),k[q+1]=P(m>>7),k[q]=P(R>>7),q=q+T*4|0}q=(Q+1)*4|0,w=(Q+1)*I*4|0}}function mn(n,k,I,T,M,y){let R,m,A,D,U,C,K,B,J,Q,L,$=0,w=0;for(J=0;J<T;J++){U=0;for(Q=0;Q<M;Q++){C=y[U++],K=y[U++],B=$+C*4|0,R=m=A=D=0;for(;K>0;K--)L=y[U++],D=D+L*n[B+3]|0,A=A+L*n[B+2]|0,m=m+L*n[B+1]|0,R=R+L*n[B]|0,B=B+4|0;if(R>>=7,m>>=7,A>>=7,D>>=7,D=H(D+8192>>14),D>0)R=R*255/D|0,m=m*255/D|0,A=A*255/D|0;k[w+3]=D,k[w+2]=H(A+8192>>14),k[w+1]=H(m+8192>>14),k[w]=H(R+8192>>14),w=w+T*4|0}w=(J+1)*4|0,$=(J+1)*I*4|0}}function Sn(n,k,I){let T=3,M=k*I*4|0;while(T<M){if(n[T]!==255)return!0;T=T+4|0}return!1}function an(n,k,I){let T=3,M=k*I*4|0;while(T<M)n[T]=255,T=T+4|0}function An(n,k,I,T,M,y,R,m,A,D){let U=d(k,I,M,R,A),C=d(k,T,y,m,D),K=new Uint8Array(M*y*4),B=new Uint16Array(M*T*4);if(Sn(n,I,T))yn(n,B,I,T,M,U),mn(B,K,T,M,y,C);else Mn(n,B,I,T,M,U),Dn(B,K,T,M,y,C),an(K,M,y);return K}var Kn=un(Qn(),1);function Hn(n,k,I){let T=k*I,M=new Uint16Array(T),y,R,m,A;for(let D=0;D<T;D++)y=n[4*D],R=n[4*D+1],m=n[4*D+2],A=y>=R&&y>=m?y:R>=m&&R>=y?R:m,M[D]=A<<8;return M}function Jn(n,k,I,T,M,y){let R,m,A,D,U;if(T===0||M<0.5)return;if(M>2)M=2;let C=Hn(n,k,I),K=new Uint16Array(C);Kn.default(K,k,I,M);let B=T/100*4096+0.5|0,J=y<<8,Q=k*I;for(let L=0;L<Q;L++)if(R=C[L],D=R-K[L],Math.abs(D)>=J)m=R+(B*D+2048>>12),m=m>65280?65280:m,m=m<0?0:m,R=R!==0?R:1,A=(m<<12)/R|0,U=L*4,n[U]=n[U]*A+2048>>12,n[U+1]=n[U+1]*A+2048>>12,n[U+2]=n[U+2]*A+2048>>12}function Ln(n){let k=An(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)Jn(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}var Pn=`
var $k=Object.create;var{getPrototypeOf:Zk,defineProperty:f,getOwnPropertyNames:nk}=Object;var Gk=Object.prototype.hasOwnProperty;var Lk=(k,M,D)=>{D=k!=null?$k(Zk(k)):{};let I=M||!k||!k.__esModule?f(D,"default",{value:k,enumerable:!0}):D;for(let y of nk(k))if(!Gk.call(I,y))f(I,y,{get:()=>k[y],enumerable:!0});return I};var jk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Kk=jk((ik,Ck)=>{var d,s,c,l,h,g,Ak,Bk;function Vk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,D=Math.exp(-M),I=Math.exp(-2*M),y=(1-D)*(1-D)/(1+2*M*D-I);return d=y,s=y*(M-1)*D,c=y*(M+1)*D,l=-y*I,h=2*D,g=-I,Ak=(d+s)/(1-h-g),Bk=(c+l)/(1-h-g),new Float32Array([d,s,c,l,h,g,Ak,Bk])}function Uk(k,M,D,I,y,K){var R,A,B,q,U,T,Z,C,n,$,Q,G,J,L,O,E,j,m,X,N,Y,z,V,w,x,u,S,F,H,W;for(x=0;x<K;x++){z=x*y,V=x,w=0,R=k[z],A=R&255,B=R>>8&255,q=R>>16&255,U=R>>24&255,m=A*I[6],X=B*I[6],N=q*I[6],Y=U*I[6],L=m,O=X,E=N,j=Y,S=I[0],F=I[1],H=I[4],W=I[5];for(u=0;u<y;u++)R=k[z],T=R&255,Z=R>>8&255,C=R>>16&255,n=R>>24&255,$=T*S+A*F+L*H+m*W,Q=Z*S+B*F+O*H+X*W,G=C*S+q*F+E*H+N*W,J=n*S+U*F+j*H+Y*W,m=L,X=O,N=E,Y=j,L=$,O=Q,E=G,j=J,A=T,B=Z,q=C,U=n,D[w]=L,D[w+1]=O,D[w+2]=E,D[w+3]=j,w+=4,z++;z--,w-=4,V+=K*(y-1),R=k[z],A=R&255,B=R>>8&255,q=R>>16&255,U=R>>24&255,m=A*I[7],X=B*I[7],N=q*I[7],Y=U*I[7],L=m,O=X,E=N,j=Y,T=A,Z=B,C=q,n=U,S=I[2],F=I[3];for(u=y-1;u>=0;u--)$=T*S+A*F+L*H+m*W,Q=Z*S+B*F+O*H+X*W,G=C*S+q*F+E*H+N*W,J=n*S+U*F+j*H+Y*W,m=L,X=O,N=E,Y=j,L=$,O=Q,E=G,j=J,A=T,B=Z,q=C,U=n,R=k[z],T=R&255,Z=R>>8&255,C=R>>16&255,n=R>>24&255,R=(D[w]+L<<0)+(D[w+1]+O<<8)+(D[w+2]+E<<16)+(D[w+3]+j<<24),M[V]=R,z--,w-=4,V-=K}}function Xk(k,M,D,I){if(!I)return;var y=new Uint32Array(k.buffer),K=new Uint32Array(y.length),R=new Float32Array(Math.max(M,D)*4),A=Vk(I);Uk(y,K,R,A,M,D,I),Uk(K,y,R,A,D,M,I)}Ck.exports=Xk});var p=4;var Ok=2;function _(k,M,D,I,y,K){let R=D/k,A=I/M,B=(2*K+Ok+1)/y;if(B>0.5)return[{toWidth:D,toHeight:I}];let q=Math.ceil(Math.log(Math.min(R,A))/Math.log(B));if(q<=1)return[{toWidth:D,toHeight:I}];let U=[];for(let T=0;T<q;T++){let Z=Math.round(Math.pow(Math.pow(k,q-T-1)*Math.pow(D,T+1),1/q)),C=Math.round(Math.pow(Math.pow(M,q-T-1)*Math.pow(I,T+1),1/q));U.push({toWidth:Z,toHeight:C})}return U}function mk(k,M){let I=new OffscreenCanvas(M.width,M.height).getContext("2d");if(!I)throw new Error("Canvas 2D context not supported");return I.globalCompositeOperation="copy",I.drawImage(k,M.x,M.y,M.width,M.height,0,0,M.width,M.height),I.getImageData(0,0,M.width,M.height).data.buffer}function zk(k,M,D){let I=new Uint8ClampedArray(D.width*D.height*p);for(let y=0;y<D.height;y++){let K=((D.y+y)*M+D.x)*p,R=y*D.width*p;I.set(k.subarray(K,K+D.width*p),R)}return I.buffer}function i(k,M,D){if(k instanceof ImageBitmap)return mk(k,D);else return zk(k,M,D)}var e=0.00001;function a(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.floor(k)}function t(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.ceil(k)}function r(k,M,D,I,y,K,R,A,B,q,U){let T=I/M,Z=y/D,C=a(K*T)-2*R,n=a(K*Z)-2*R;if(C<1||n<1)throw new Error("Internal error in picsquish: target tile width/height is too small.");let $,Q,G,J,L,O,E=[];for(J=0;J<y;J+=n)for(G=0;G<I;G+=C){if($=G-R,$<0)$=0;if(L=G+C+R-$,$+L>=I)L=I-$;if(Q=J-R,Q<0)Q=0;if(O=J+n+R-Q,Q+O>=y)O=y-Q;let j={toX:$,toY:Q,toWidth:L,toHeight:O,toInnerX:G,toInnerY:J,toInnerWidth:C,toInnerHeight:n,offsetX:$/T-a($/T),offsetY:Q/Z-a(Q/Z),scaleX:T,scaleY:Z,x:a($/T),y:a(Q/Z),width:t(L/T),height:t(O/Z),initialSize:K,filterPadding:R,filter:A,unsharpAmount:B,unsharpRadius:q,unsharpThreshold:U},m=i(k,M,j);E.push({tile:m,...j})}return E}async function kk(k){let M,D,I,y,K,R;if(k.image instanceof Blob){let B=await createImageBitmap(k.image);M=B,D=B.width,I=B.height;let q=k.maxDimension/D,U=k.maxDimension/I,T=Math.min(q,U,1),Z=Math.floor(D*T),C=Math.floor(I*T);y=_(D,I,Z,C,k.tileOptions.initialSize,k.tileOptions.filterPadding)}else M=k.image.from,D=k.image.fromWidth,I=k.image.fromHeight,y=k.image.stages;K=y[0].toWidth,R=y[0].toHeight;let A=r(M,D,I,K,R,k.tileOptions.initialSize,k.tileOptions.filterPadding,k.tileOptions.filter,k.tileOptions.unsharpAmount,k.tileOptions.unsharpRadius,k.tileOptions.unsharpThreshold);if(M instanceof ImageBitmap)M.close();return{tileTransforms:A,stages:y}}var v={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Ek=14;function Mk(k){return Math.round(k*((1<<Ek)-1))}function o(k,M,D,I,y){let K=v[k].fn,R=1/I,A=Math.min(1,I),B=v[k].win/A,q,U,T,Z,C,n,$,Q,G,J,L,O,E,j,m,X,N,Y=Math.floor((B+1)*2),z=new Int16Array((Y+2)*D),V=0,w=!z.subarray||!z.set;for(q=0;q<D;q++){U=(q+0.5)*R+y,T=Math.max(0,Math.floor(U-B)),Z=Math.min(M-1,Math.ceil(U+B)),C=Z-T+1,n=new Float32Array(C),$=new Int16Array(C),Q=0;for(G=T,J=0;G<=Z;G++,J++)L=K((G+0.5-U)*A),Q+=L,n[J]=L;O=0;for(J=0;J<n.length;J++)E=n[J]/Q,O+=E,$[J]=Mk(E);$[D>>1]+=Mk(1-O),j=0;while(j<$.length&&$[j]===0)j++;if(j<$.length){m=$.length-1;while(m>0&&$[m]===0)m--;if(X=T+j,N=m-j+1,z[V++]=X,z[V++]=N,!w)z.set($.subarray(j,m+1),V),V+=N;else for(J=j;J<=m;J++)z[V++]=$[J]}else z[V++]=0,z[V++]=0}return z}function P(k){return k<0?0:k>255?255:k}function b(k){return k>=0?k:0}function Ik(k,M,D,I,y,K){let R,A,B,q,U,T,Z,C,n,$,Q,G=0,J=0;for(n=0;n<I;n++){U=0;for($=0;$<y;$++){T=K[U++],Z=K[U++],C=G+T*4|0,R=A=B=q=0;for(;Z>0;Z--)Q=K[U++],q=q+Q*k[C+3]|0,B=B+Q*k[C+2]|0,A=A+Q*k[C+1]|0,R=R+Q*k[C]|0,C=C+4|0;M[J+3]=b(q>>7),M[J+2]=b(B>>7),M[J+1]=b(A>>7),M[J]=b(R>>7),J=J+I*4|0}J=(n+1)*4|0,G=(n+1)*D*4|0}}function Rk(k,M,D,I,y,K){let R,A,B,q,U,T,Z,C,n,$,Q,G=0,J=0;for(n=0;n<I;n++){U=0;for($=0;$<y;$++){T=K[U++],Z=K[U++],C=G+T*4|0,R=A=B=q=0;for(;Z>0;Z--)Q=K[U++],q=q+Q*k[C+3]|0,B=B+Q*k[C+2]|0,A=A+Q*k[C+1]|0,R=R+Q*k[C]|0,C=C+4|0;R>>=7,A>>=7,B>>=7,q>>=7,M[J+3]=P(q+8192>>14),M[J+2]=P(B+8192>>14),M[J+1]=P(A+8192>>14),M[J]=P(R+8192>>14),J=J+I*4|0}J=(n+1)*4|0,G=(n+1)*D*4|0}}function Dk(k,M,D,I,y,K){let R,A,B,q,U,T,Z,C,n,$,Q,G,J=0,L=0;for($=0;$<I;$++){T=0;for(Q=0;Q<y;Q++){Z=K[T++],C=K[T++],n=J+Z*4|0,R=A=B=q=0;for(;C>0;C--)G=K[T++],U=k[n+3],q=q+G*U|0,B=B+G*k[n+2]*U|0,A=A+G*k[n+1]*U|0,R=R+G*k[n]*U|0,n=n+4|0;B=B/255|0,A=A/255|0,R=R/255|0,M[L+3]=b(q>>7),M[L+2]=b(B>>7),M[L+1]=b(A>>7),M[L]=b(R>>7),L=L+I*4|0}L=($+1)*4|0,J=($+1)*D*4|0}}function yk(k,M,D,I,y,K){let R,A,B,q,U,T,Z,C,n,$,Q,G=0,J=0;for(n=0;n<I;n++){U=0;for($=0;$<y;$++){T=K[U++],Z=K[U++],C=G+T*4|0,R=A=B=q=0;for(;Z>0;Z--)Q=K[U++],q=q+Q*k[C+3]|0,B=B+Q*k[C+2]|0,A=A+Q*k[C+1]|0,R=R+Q*k[C]|0,C=C+4|0;if(R>>=7,A>>=7,B>>=7,q>>=7,q=P(q+8192>>14),q>0)R=R*255/q|0,A=A*255/q|0,B=B*255/q|0;M[J+3]=q,M[J+2]=P(B+8192>>14),M[J+1]=P(A+8192>>14),M[J]=P(R+8192>>14),J=J+I*4|0}J=(n+1)*4|0,G=(n+1)*D*4|0}}function wk(k,M,D){let I=3,y=M*D*4|0;while(I<y){if(k[I]!==255)return!0;I=I+4|0}return!1}function Nk(k,M,D){let I=3,y=M*D*4|0;while(I<y)k[I]=255,I=I+4|0}function qk(k,M,D,I,y,K,R,A,B,q){let U=o(M,D,y,R,B),T=o(M,I,K,A,q),Z=new Uint8Array(y*K*4),C=new Uint16Array(y*I*4);if(wk(k,D,I))Dk(k,C,D,I,y,U),yk(C,Z,I,y,K,T);else Ik(k,C,D,I,y,U),Rk(C,Z,I,y,K,T),Nk(Z,y,K);return Z}var Tk=Lk(Kk(),1);function Yk(k,M,D){let I=M*D,y=new Uint16Array(I),K,R,A,B;for(let q=0;q<I;q++)K=k[4*q],R=k[4*q+1],A=k[4*q+2],B=K>=R&&K>=A?K:R>=A&&R>=K?R:A,y[q]=B<<8;return y}function Jk(k,M,D,I,y,K){let R,A,B,q,U;if(I===0||y<0.5)return;if(y>2)y=2;let T=Yk(k,M,D),Z=new Uint16Array(T);Tk.default(Z,M,D,y);let C=I/100*4096+0.5|0,n=K<<8,$=M*D;for(let Q=0;Q<$;Q++)if(R=T[Q],q=R-Z[Q],Math.abs(q)>=n)A=R+(C*q+2048>>12),A=A>65280?65280:A,A=A<0?0:A,R=R!==0?R:1,B=(A<<12)/R|0,U=Q*4,k[U]=k[U]*B+2048>>12,k[U+1]=k[U+1]*B+2048>>12,k[U+2]=k[U+2]*B+2048>>12}function Qk(k){let M=qk(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Jk(M,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return M}var Sk=async(k)=>{let{taskId:M,squishId:D,taskType:I,image:y,maxDimension:K,tileOptions:R}=k,{tileTransforms:A,stages:B}=await kk({image:y,maxDimension:K,tileOptions:R}),q={taskId:M,squishId:D,taskType:I,output:{tileTransforms:A,stages:B}},U=A.map((T)=>T.tile);self.postMessage(q,U)};function Fk(k){let{taskId:M,squishId:D,taskType:I,tileTransform:y}=k;y.tile=Qk(y).buffer;let K={taskId:M,squishId:D,taskType:I,output:{tileTransform:y}};self.postMessage(K,[y.tile])}self.onmessage=async(k)=>{try{switch(k.data.taskType){case 0:return Sk(k.data);case 1:return Fk(k.data)}}catch(M){self.postMessage({taskId:k.data.taskId,squishId:k.data.squishId,taskType:k.data.taskType,error:M})}};
`,bn=new Blob([Pn],{type:"application/javascript"});class $n{#n;#k;#T;#I;constructor(){this.#n=new Map,this.#k=new Map,this.#T=null,this.#I=null}#R(){if(this.#T===null)return;clearTimeout(this.#T),this.#T=null}prepare(n,k,I){if(this.#n.size)return;this.#I=I;let T=URL.createObjectURL(bn);while(this.#n.size<k){let M=new Worker(T);M.onmessage=n,this.#n.set(M,null)}URL.revokeObjectURL(T)}assignTask(n,k,I,T){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#R(),n.postMessage(I,T)}setTimeout(){if(this.#T!==null)return;this.#T=setTimeout(()=>{for(let n of this.#n.keys())n.terminate();this.#n.clear(),this.#k.clear()},this.#I||0)}getAvailableWorkers(){let n=[];for(let[k,I]of this.#n.entries())if(I===null)n.push(k);return n}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n)}}var b=new $n;var i=(()=>{let n=0;return()=>++n})();class qn{#n;#k;#T;constructor(){this.#n=new Map,this.#k=[],this.#T=[]}#I(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions};b.assignTask(n,k,I,[])}#R(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};b.assignTask(n,k,I,[I.tileTransform.tile])}#D(n){let k=this.#k.shift();if(k)return this.#I(n,k);let I=this.#T.shift();if(I)return this.#R(n,I)}#M(){if(this.#k.length===0&&this.#T.length===0)return b.setTimeout();let k=b.getAvailableWorkers();for(let I of k)this.#D(I)}#y(n,k){let{squishId:I,output:T}=k,M=T.stages[0].toWidth,y=T.stages[0].toHeight;n.to=new Uint8ClampedArray(M*y*N),n.toWidth=M,n.toHeight=y,n.stages=T.stages,n.remainingTileCount=T.tileTransforms.length;for(let R of T.tileTransforms)this.#T.push({id:i(),squishId:I,data:{tileTransform:R}})}#m(n,k){let{squishId:I,output:T}=k;if(!n.to)throw new Error("SquishContext to not found");if(g(n.to,n.toWidth,T.tileTransform),n.remainingTileCount--,!n.remainingTileCount)if(n.stages.shift(),n.stages[0])this.#k.push({id:i(),squishId:I,data:{image:{from:n.to,fromWidth:n.toWidth,fromHeight:n.toHeight,stages:n.stages},maxDimension:n.maxDimension,tileOptions:n.tileOptions}});else{let M=new ImageData(n.to,n.toWidth,n.toHeight);createImageBitmap(M).then((y)=>{this.#n.delete(I),n.resolve(y)})}}#A(n){let k=this.#n.get(n.data.squishId);if(!k)throw new Error("SquishContext not found");if(n.data.error)k.reject(n.data.error);switch(n.data.taskType){case 0:this.#y(k,n.data);break;case 1:this.#m(k,n.data);break}b.removeTask(n.data.taskId),this.#M()}add(n,k,I){return b.prepare((T)=>this.#A(T),k,I),new Promise((T,M)=>{let y=i();this.#n.set(y,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:T,reject:M}),this.#k.push({id:y,squishId:y,data:n}),this.#M()})}}var Zn=new qn;class hn{#n;constructor(n){this.#n=n}async#k(n,k,I){let T=null,M,y,R;for(;;){let A=await In({image:T||n,maxDimension:k,tileOptions:I});y=A.stages[0].toWidth,R=A.stages[0].toHeight,M=new Uint8ClampedArray(y*R*N);for(let D of A.tileTransforms)D.tile=Ln(D).buffer,g(M,y,D);if(A.stages.shift(),T={from:M,fromWidth:y,fromHeight:R,stages:A.stages},!A.stages[0])break}let m=new ImageData(T.from,T.fromWidth,T.fromHeight);return await createImageBitmap(m)}async squish(n,k){let I=k?{...this.#n,...k}:this.#n,T=I.maxDimension,M=I.tileSize||1024,y=I.filter||"mks2013",R=I.unsharpAmount||0,m=I.unsharpRadius||0,A=I.unsharpThreshold||0,D=I.useMainThread,U=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,C=I.maxWorkerPoolSize||Math.min(U,4),K=I.maxWorkerIdleTime||2000,B=3,J=Math.ceil(Math.max(3,2.5*m|0)),Q={initialSize:M,filterPadding:J,filter:y,unsharpAmount:R,unsharpRadius:m,unsharpThreshold:A};return await this.#k(n,T,Q)}}export{hn as PicSquish};
