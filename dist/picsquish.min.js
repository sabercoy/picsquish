var Yk=Object.create;var{getPrototypeOf:wk,defineProperty:s,getOwnPropertyNames:zk}=Object;var Ek=Object.prototype.hasOwnProperty;var Pk=(k,M,q)=>{q=k!=null?Yk(wk(k)):{};let Q=M||!k||!k.__esModule?s(q,"default",{value:k,enumerable:!0}):q;for(let $ of zk(k))if(!Ek.call(Q,$))s(Q,$,{get:()=>k[$],enumerable:!0});return Q};var Fk=(k,M)=>()=>(M||k((M={exports:{}}).exports,M),M.exports);var Gk=Fk((tk,jk)=>{var f,a,o,_,h,g,Jk,$k;function Tk(k){if(k<0.5)k=0.5;var M=Math.exp(0.527076)/k,q=Math.exp(-M),Q=Math.exp(-2*M),$=(1-q)*(1-q)/(1+2*M*q-Q);return f=$,a=$*(M-1)*q,o=$*(M+1)*q,_=-$*Q,h=2*q,g=-Q,Jk=(f+a)/(1-h-g),$k=(o+_)/(1-h-g),new Float32Array([f,a,o,_,h,g,Jk,$k])}function Zk(k,M,q,Q,$,j){var U,I,J,K,Z,L,R,G,D,C,A,V,B,y,w,z,N,Y,W,P,S,X,F,E,n,u,O,H,T,m;for(n=0;n<j;n++){X=n*$,F=n,E=0,U=k[X],I=U&255,J=U>>8&255,K=U>>16&255,Z=U>>24&255,Y=I*Q[6],W=J*Q[6],P=K*Q[6],S=Z*Q[6],y=Y,w=W,z=P,N=S,O=Q[0],H=Q[1],T=Q[4],m=Q[5];for(u=0;u<$;u++)U=k[X],L=U&255,R=U>>8&255,G=U>>16&255,D=U>>24&255,C=L*O+I*H+y*T+Y*m,A=R*O+J*H+w*T+W*m,V=G*O+K*H+z*T+P*m,B=D*O+Z*H+N*T+S*m,Y=y,W=w,P=z,S=N,y=C,w=A,z=V,N=B,I=L,J=R,K=G,Z=D,q[E]=y,q[E+1]=w,q[E+2]=z,q[E+3]=N,E+=4,X++;X--,E-=4,F+=j*($-1),U=k[X],I=U&255,J=U>>8&255,K=U>>16&255,Z=U>>24&255,Y=I*Q[7],W=J*Q[7],P=K*Q[7],S=Z*Q[7],y=Y,w=W,z=P,N=S,L=I,R=J,G=K,D=Z,O=Q[2],H=Q[3];for(u=$-1;u>=0;u--)C=L*O+I*H+y*T+Y*m,A=R*O+J*H+w*T+W*m,V=G*O+K*H+z*T+P*m,B=D*O+Z*H+N*T+S*m,Y=y,W=w,P=z,S=N,y=C,w=A,z=V,N=B,I=L,J=R,K=G,Z=D,U=k[X],L=U&255,R=U>>8&255,G=U>>16&255,D=U>>24&255,U=(q[E]+y<<0)+(q[E+1]+w<<8)+(q[E+2]+z<<16)+(q[E+3]+N<<24),M[F]=U,X--,E-=4,F-=j}}function mk(k,M,q,Q){if(!Q)return;var $=new Uint32Array(k.buffer),j=new Uint32Array($.length),U=new Float32Array(Math.max(M,q)*4),I=Tk(Q);Zk($,j,U,I,M,q,Q),Zk(j,$,U,I,q,M,Q)}jk.exports=mk});var Wk=2;function i(k,M,q,Q,$,j){let U=q/k,I=Q/M,J=(2*j+Wk+1)/$;if(J>0.5)return[[q,Q]];let K=Math.ceil(Math.log(Math.min(U,I))/Math.log(J));if(K<=1)return[[q,Q]];let Z=[];for(let L=0;L<K;L++){let R=Math.round(Math.pow(Math.pow(k,K-L-1)*Math.pow(q,L+1),1/K)),G=Math.round(Math.pow(Math.pow(M,K-L-1)*Math.pow(Q,L+1),1/K));Z.push([R,G])}return Z}function r(k,M,q,Q,$){let j=new OffscreenCanvas(k.width,k.height),U=j.getContext("2d");if(!U)throw new Error("Pica: Canvas context is not supported");return U.globalCompositeOperation="copy",U.drawImage(Q.srcImageBitmap||M,k.x,k.y,k.width,k.height,0,0,k.width,k.height),$.src=U.getImageData(0,0,k.width,k.height).data,j.width=j.height=0,$}var e=0.00001;function v(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.floor(k)}function t(k){let M=Math.round(k);if(Math.abs(k-M)<e)return M;return Math.ceil(k)}function kk(k,M,q,Q,$,j){let U=Q/k,I=$/M,J=v(q*U)-2*j,K=v(q*I)-2*j;if(J<1||K<1)throw new Error("Internal error in pica: target tile width/height is too small.");let Z,L,R,G,D,C,A=[];for(G=0;G<$;G+=K)for(R=0;R<Q;R+=J){if(Z=R-j,Z<0)Z=0;if(D=R+J+j-Z,Z+D>=Q)D=Q-Z;if(L=G-j,L<0)L=0;if(C=G+K+j-L,L+C>=$)C=$-L;A.push({toX:Z,toY:L,toWidth:D,toHeight:C,toInnerX:R,toInnerY:G,toInnerWidth:J,toInnerHeight:K,offsetX:Z/U-v(Z/U),offsetY:L/I-v(L/I),scaleX:U,scaleY:I,x:v(Z/U),y:v(L/I),width:t(D/U),height:t(C/I)})}return A}var d={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*(0.54+0.46*Math.cos(M/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/2)/(M/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let M=k*Math.PI;return Math.sin(M)/M*Math.sin(M/3)/(M/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var Sk=14;function Mk(k){return Math.round(k*((1<<Sk)-1))}function p(k,M,q,Q,$){let j=d[k].fn,U=1/Q,I=Math.min(1,Q),J=d[k].win/I,K,Z,L,R,G,D,C,A,V,B,y,w,z,N,Y,W,P,S=Math.floor((J+1)*2),X=new Int16Array((S+2)*q),F=0,E=!X.subarray||!X.set;for(K=0;K<q;K++){Z=(K+0.5)*U+$,L=Math.max(0,Math.floor(Z-J)),R=Math.min(M-1,Math.ceil(Z+J)),G=R-L+1,D=new Float32Array(G),C=new Int16Array(G),A=0;for(V=L,B=0;V<=R;V++,B++)y=j((V+0.5-Z)*I),A+=y,D[B]=y;w=0;for(B=0;B<D.length;B++)z=D[B]/A,w+=z,C[B]=Mk(z);C[q>>1]+=Mk(1-w),N=0;while(N<C.length&&C[N]===0)N++;if(N<C.length){Y=C.length-1;while(Y>0&&C[Y]===0)Y--;if(W=L+N,P=Y-N+1,X[F++]=W,X[F++]=P,!E)X.set(C.subarray(N,Y+1),F),F+=P;else for(B=N;B<=Y;B++)X[F++]=C[B]}else X[F++]=0,X[F++]=0}return X}function b(k){return k<0?0:k>255?255:k}function x(k){return k>=0?k:0}function Qk(k,M,q,Q,$,j){let U,I,J,K,Z,L,R,G,D,C,A,V=0,B=0;for(D=0;D<Q;D++){Z=0;for(C=0;C<$;C++){L=j[Z++],R=j[Z++],G=V+L*4|0,U=I=J=K=0;for(;R>0;R--)A=j[Z++],K=K+A*k[G+3]|0,J=J+A*k[G+2]|0,I=I+A*k[G+1]|0,U=U+A*k[G]|0,G=G+4|0;M[B+3]=x(K>>7),M[B+2]=x(J>>7),M[B+1]=x(I>>7),M[B]=x(U>>7),B=B+Q*4|0}B=(D+1)*4|0,V=(D+1)*q*4|0}}function Uk(k,M,q,Q,$,j){let U,I,J,K,Z,L,R,G,D,C,A,V=0,B=0;for(D=0;D<Q;D++){Z=0;for(C=0;C<$;C++){L=j[Z++],R=j[Z++],G=V+L*4|0,U=I=J=K=0;for(;R>0;R--)A=j[Z++],K=K+A*k[G+3]|0,J=J+A*k[G+2]|0,I=I+A*k[G+1]|0,U=U+A*k[G]|0,G=G+4|0;U>>=7,I>>=7,J>>=7,K>>=7,M[B+3]=b(K+8192>>14),M[B+2]=b(J+8192>>14),M[B+1]=b(I+8192>>14),M[B]=b(U+8192>>14),B=B+Q*4|0}B=(D+1)*4|0,V=(D+1)*q*4|0}}function qk(k,M,q,Q,$,j){let U,I,J,K,Z,L,R,G,D,C,A,V,B=0,y=0;for(C=0;C<Q;C++){L=0;for(A=0;A<$;A++){R=j[L++],G=j[L++],D=B+R*4|0,U=I=J=K=0;for(;G>0;G--)V=j[L++],Z=k[D+3],K=K+V*Z|0,J=J+V*k[D+2]*Z|0,I=I+V*k[D+1]*Z|0,U=U+V*k[D]*Z|0,D=D+4|0;J=J/255|0,I=I/255|0,U=U/255|0,M[y+3]=x(K>>7),M[y+2]=x(J>>7),M[y+1]=x(I>>7),M[y]=x(U>>7),y=y+Q*4|0}y=(C+1)*4|0,B=(C+1)*q*4|0}}function Ik(k,M,q,Q,$,j){let U,I,J,K,Z,L,R,G,D,C,A,V=0,B=0;for(D=0;D<Q;D++){Z=0;for(C=0;C<$;C++){L=j[Z++],R=j[Z++],G=V+L*4|0,U=I=J=K=0;for(;R>0;R--)A=j[Z++],K=K+A*k[G+3]|0,J=J+A*k[G+2]|0,I=I+A*k[G+1]|0,U=U+A*k[G]|0,G=G+4|0;if(U>>=7,I>>=7,J>>=7,K>>=7,K=b(K+8192>>14),K>0)U=U*255/K|0,I=I*255/K|0,J=J*255/K|0;M[B+3]=K,M[B+2]=b(J+8192>>14),M[B+1]=b(I+8192>>14),M[B]=b(U+8192>>14),B=B+Q*4|0}B=(D+1)*4|0,V=(D+1)*q*4|0}}function Ok(k,M,q){let Q=3,$=M*q*4|0;while(Q<$){if(k[Q]!==255)return!0;Q=Q+4|0}return!1}function Hk(k,M,q){let Q=3,$=M*q*4|0;while(Q<$)k[Q]=255,Q=Q+4|0}function Kk(k){let{src:M,width:q,height:Q,toWidth:$,toHeight:j}=k,U=k.scaleX||k.toWidth/k.width,I=k.scaleY||k.toHeight/k.height,J=k.offsetX||0,K=k.offsetY||0,Z=k.dest||new Uint8Array($*j*4),L=typeof k.filter==="undefined"?"mks2013":k.filter,R=p(L,q,$,U,J),G=p(L,Q,j,I,K),D=new Uint16Array($*Q*4);if(Ok(M,q,Q))qk(M,D,q,Q,$,R),Ik(D,Z,Q,$,j,G);else Qk(M,D,q,Q,$,R),Uk(D,Z,Q,$,j,G),Hk(Z,$,j);return Z}var Dk=Pk(Gk(),1);function bk(k,M,q){let Q=M*q,$=new Uint16Array(Q),j,U,I,J;for(let K=0;K<Q;K++)j=k[4*K],U=k[4*K+1],I=k[4*K+2],J=j>=U&&j>=I?j:U>=I&&U>=j?U:I,$[K]=J<<8;return $}function Lk(k,M,q,Q,$,j){let U,I,J,K,Z;if(Q===0||$<0.5)return;if($>2)$=2;let L=bk(k,M,q),R=new Uint16Array(L);Dk.default(R,M,q,$);let G=Q/100*4096+0.5|0,D=j<<8,C=M*q;for(let A=0;A<C;A++)if(U=L[A],K=U-R[A],Math.abs(K)>=D)I=U+(G*K+2048>>12),I=I>65280?65280:I,I=I<0?0:I,U=U!==0?U:1,J=(I<<12)/U|0,Z=A*4,k[Z]=k[Z]*J+2048>>12,k[Z+1]=k[Z+1]*J+2048>>12,k[Z+2]=k[Z+2]*J+2048>>12}function Rk(k){let M=Kk(k);if(k.unsharpAmount)Lk(M,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return M}function Ak(k){return Promise.resolve().then(()=>{return{data:Rk(k)}})}function Ck(k,M,q){let Q;if(Q=new ImageData(new Uint8ClampedArray(M.data),k.toWidth,k.toHeight),!1)q.toCtx?.putImageData(Q,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth+0.00001,k.toInnerHeight+0.00001);else q.toCtx?.putImageData(Q,k.toX,k.toY,k.toInnerX-k.toX,k.toInnerY-k.toY,k.toInnerWidth,k.toInnerHeight);return null}function Bk(k){return k instanceof OffscreenCanvas}function yk(k){return k instanceof ImageBitmap}var uk=(k,M,q,Q,$,j,U)=>{let I={width:k.width,height:k.height,toWidth:k.toWidth,toHeight:k.toHeight,scaleX:k.scaleX,scaleY:k.scaleY,offsetX:k.offsetX,offsetY:k.offsetY,filter:q,unsharpAmount:Q,unsharpRadius:$,unsharpThreshold:j};return Promise.resolve(I).then((J)=>r(k,M,null,U,J)).then((J)=>Ak(J)).then((J)=>Ck(k,J,U))};function Vk(k,M,q,Q,$,j,U,I,J,K,Z,L){let R={srcCtx:null,srcImageBitmap:null,isImageBitmapReused:!1,toCtx:null};return Promise.resolve().then(()=>{if(R.toCtx=M.getContext("2d"),Bk(k))return null;if(yk(k))return R.srcImageBitmap=k,R.isImageBitmapReused=!0,null;throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap')}).then(()=>{let D=kk(q,Q,U,$,j,I).map((A)=>uk(A,k,J,K,Z,L,R));function C(A){if(A.srcImageBitmap){if(!A.isImageBitmapReused)A.srcImageBitmap.close();A.srcImageBitmap=null}}return Promise.all(D).then(()=>{return C(R),M},(A)=>{throw C(R),A})})}async function c(k,M,q,Q,$,j,U,I,J,K,Z,L,R){let G=k.shift();if(!G)throw new Error("Pica: Stages are empty");let[D,C]=G,A=k.length===0;j=D,U=C;let V;if(!A)V=new OffscreenCanvas(D,C);if(await Vk(M,A?q:V,Q,$,j,U,I,J,K,Z,L,R),A)return q;return Q=D,$=C,await c(k,V,q,Q,$,j,U,I,J,K,Z,L,R)}async function Nk(k,M){let q=M.maxDimension,Q=M.tileSize??1024,$=M.unsharpAmount??0,j=M.unsharpRadius??0,U=M.unsharpThreshold??0,I=await createImageBitmap(k),J=I.width,K=I.height,Z=q/J,L=q/K,R=Math.min(Z,L,1),G=Math.floor(J*R),D=Math.floor(K*R),C=new OffscreenCanvas(G,D),A=3,V=Math.ceil(Math.max(3,2.5*j|0)),B=i(J,K,G,D,Q,V),y={filter:"mks2013",unsharpAmount:$,unsharpRadius:j,unsharpThreshold:U,width:J,height:K,toWidth:G,toHeight:D,destTileBorder:V};return(await c(B,I,C,y.width,y.height,y.toWidth,y.toHeight,1024,y.destTileBorder,y.filter,y.unsharpAmount,y.unsharpRadius,y.unsharpThreshold)).transferToImageBitmap()}var vk=`
var yM=Object.create;var{getPrototypeOf:XM,defineProperty:l,getOwnPropertyNames:YM}=Object;var zM=Object.prototype.hasOwnProperty;var wM=(M,U,$)=>{$=M!=null?yM(XM(M)):{};let q=U||!M||!M.__esModule?l($,"default",{value:M,enumerable:!0}):$;for(let Z of YM(M))if(!zM.call(q,Z))l(q,Z,{get:()=>M[Z],enumerable:!0});return q};var EM=(M,U)=>()=>(U||M((U={exports:{}}).exports,U),U.exports);var DM=EM((oM,jM)=>{var f,_,a,o,h,n,$M,ZM;function OM(M){if(M<0.5)M=0.5;var U=Math.exp(0.527076)/M,$=Math.exp(-U),q=Math.exp(-2*U),Z=(1-$)*(1-$)/(1+2*U*$-q);return f=Z,_=Z*(U-1)*$,a=Z*(U+1)*$,o=-Z*q,h=2*$,n=-q,$M=(f+_)/(1-h-n),ZM=(a+o)/(1-h-n),new Float32Array([f,_,a,o,h,n,$M,ZM])}function GM(M,U,$,q,Z,D){var J,K,G,Q,j,A,k,I,L,C,R,N,B,V,z,w,y,Y,S,F,H,X,P,E,g,v,O,W,b,m;for(g=0;g<D;g++){X=g*Z,P=g,E=0,J=M[X],K=J&255,G=J>>8&255,Q=J>>16&255,j=J>>24&255,Y=K*q[6],S=G*q[6],F=Q*q[6],H=j*q[6],V=Y,z=S,w=F,y=H,O=q[0],W=q[1],b=q[4],m=q[5];for(v=0;v<Z;v++)J=M[X],A=J&255,k=J>>8&255,I=J>>16&255,L=J>>24&255,C=A*O+K*W+V*b+Y*m,R=k*O+G*W+z*b+S*m,N=I*O+Q*W+w*b+F*m,B=L*O+j*W+y*b+H*m,Y=V,S=z,F=w,H=y,V=C,z=R,w=N,y=B,K=A,G=k,Q=I,j=L,$[E]=V,$[E+1]=z,$[E+2]=w,$[E+3]=y,E+=4,X++;X--,E-=4,P+=D*(Z-1),J=M[X],K=J&255,G=J>>8&255,Q=J>>16&255,j=J>>24&255,Y=K*q[7],S=G*q[7],F=Q*q[7],H=j*q[7],V=Y,z=S,w=F,y=H,A=K,k=G,I=Q,L=j,O=q[2],W=q[3];for(v=Z-1;v>=0;v--)C=A*O+K*W+V*b+Y*m,R=k*O+G*W+z*b+S*m,N=I*O+Q*W+w*b+F*m,B=L*O+j*W+y*b+H*m,Y=V,S=z,F=w,H=y,V=C,z=R,w=N,y=B,K=A,G=k,Q=I,j=L,J=M[X],A=J&255,k=J>>8&255,I=J>>16&255,L=J>>24&255,J=($[E]+V<<0)+($[E+1]+z<<8)+($[E+2]+w<<16)+($[E+3]+y<<24),U[P]=J,X--,E-=4,P-=D}}function WM(M,U,$,q){if(!q)return;var Z=new Uint32Array(M.buffer),D=new Uint32Array(Z.length),J=new Float32Array(Math.max(U,$)*4),K=OM(q);GM(Z,D,J,K,U,$,q),GM(D,Z,J,K,$,U,q)}jM.exports=WM});var FM=2;function s(M,U,$,q,Z,D){let J=$/M,K=q/U,G=(2*D+FM+1)/Z;if(G>0.5)return[[$,q]];let Q=Math.ceil(Math.log(Math.min(J,K))/Math.log(G));if(Q<=1)return[[$,q]];let j=[];for(let A=0;A<Q;A++){let k=Math.round(Math.pow(Math.pow(M,Q-A-1)*Math.pow($,A+1),1/Q)),I=Math.round(Math.pow(Math.pow(U,Q-A-1)*Math.pow(q,A+1),1/Q));j.push([k,I])}return j}function i(M,U,$,q,Z){let D=new OffscreenCanvas(M.width,M.height),J=D.getContext("2d");if(!J)throw new Error("Pica: Canvas context is not supported");return J.globalCompositeOperation="copy",J.drawImage(q.srcImageBitmap||U,M.x,M.y,M.width,M.height,0,0,M.width,M.height),Z.src=J.getImageData(0,0,M.width,M.height).data,D.width=D.height=0,Z}var t=0.00001;function u(M){let U=Math.round(M);if(Math.abs(M-U)<t)return U;return Math.floor(M)}function r(M){let U=Math.round(M);if(Math.abs(M-U)<t)return U;return Math.ceil(M)}function e(M,U,$,q,Z,D){let J=q/M,K=Z/U,G=u($*J)-2*D,Q=u($*K)-2*D;if(G<1||Q<1)throw new Error("Internal error in pica: target tile width/height is too small.");let j,A,k,I,L,C,R=[];for(I=0;I<Z;I+=Q)for(k=0;k<q;k+=G){if(j=k-D,j<0)j=0;if(L=k+G+D-j,j+L>=q)L=q-j;if(A=I-D,A<0)A=0;if(C=I+Q+D-A,A+C>=Z)C=Z-A;R.push({toX:j,toY:A,toWidth:L,toHeight:C,toInnerX:k,toInnerY:I,toInnerWidth:G,toInnerHeight:Q,offsetX:j/J-u(j/J),offsetY:A/K-u(A/K),scaleX:J,scaleY:K,x:u(j/J),y:u(A/K),width:r(L/J),height:r(C/K)})}return R}var d={box:{win:0.5,fn:(M)=>{if(M<0)M=-M;return M<0.5?1:0}},hamming:{win:1,fn:(M)=>{if(M<0)M=-M;if(M>=1)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*(0.54+0.46*Math.cos(U/1))}},lanczos2:{win:2,fn:(M)=>{if(M<0)M=-M;if(M>=2)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/2)/(U/2)}},lanczos3:{win:3,fn:(M)=>{if(M<0)M=-M;if(M>=3)return 0;if(M<0.00000011920929)return 1;let U=M*Math.PI;return Math.sin(U)/U*Math.sin(U/3)/(U/3)}},mks2013:{win:2.5,fn:(M)=>{if(M<0)M=-M;if(M>=2.5)return 0;if(M>=1.5)return-0.125*(M-2.5)*(M-2.5);if(M>=0.5)return 0.25*(4*M*M-11*M+7);return 1.0625-1.75*M*M}}};var PM=14;function MM(M){return Math.round(M*((1<<PM)-1))}function p(M,U,$,q,Z){let D=d[M].fn,J=1/q,K=Math.min(1,q),G=d[M].win/K,Q,j,A,k,I,L,C,R,N,B,V,z,w,y,Y,S,F,H=Math.floor((G+1)*2),X=new Int16Array((H+2)*$),P=0,E=!X.subarray||!X.set;for(Q=0;Q<$;Q++){j=(Q+0.5)*J+Z,A=Math.max(0,Math.floor(j-G)),k=Math.min(U-1,Math.ceil(j+G)),I=k-A+1,L=new Float32Array(I),C=new Int16Array(I),R=0;for(N=A,B=0;N<=k;N++,B++)V=D((N+0.5-j)*K),R+=V,L[B]=V;z=0;for(B=0;B<L.length;B++)w=L[B]/R,z+=w,C[B]=MM(w);C[$>>1]+=MM(1-z),y=0;while(y<C.length&&C[y]===0)y++;if(y<C.length){Y=C.length-1;while(Y>0&&C[Y]===0)Y--;if(S=A+y,F=Y-y+1,X[P++]=S,X[P++]=F,!E)X.set(C.subarray(y,Y+1),P),P+=F;else for(B=y;B<=Y;B++)X[P++]=C[B]}else X[P++]=0,X[P++]=0}return X}function T(M){return M<0?0:M>255?255:M}function x(M){return M>=0?M:0}function UM(M,U,$,q,Z,D){let J,K,G,Q,j,A,k,I,L,C,R,N=0,B=0;for(L=0;L<q;L++){j=0;for(C=0;C<Z;C++){A=D[j++],k=D[j++],I=N+A*4|0,J=K=G=Q=0;for(;k>0;k--)R=D[j++],Q=Q+R*M[I+3]|0,G=G+R*M[I+2]|0,K=K+R*M[I+1]|0,J=J+R*M[I]|0,I=I+4|0;U[B+3]=x(Q>>7),U[B+2]=x(G>>7),U[B+1]=x(K>>7),U[B]=x(J>>7),B=B+q*4|0}B=(L+1)*4|0,N=(L+1)*$*4|0}}function qM(M,U,$,q,Z,D){let J,K,G,Q,j,A,k,I,L,C,R,N=0,B=0;for(L=0;L<q;L++){j=0;for(C=0;C<Z;C++){A=D[j++],k=D[j++],I=N+A*4|0,J=K=G=Q=0;for(;k>0;k--)R=D[j++],Q=Q+R*M[I+3]|0,G=G+R*M[I+2]|0,K=K+R*M[I+1]|0,J=J+R*M[I]|0,I=I+4|0;J>>=7,K>>=7,G>>=7,Q>>=7,U[B+3]=T(Q+8192>>14),U[B+2]=T(G+8192>>14),U[B+1]=T(K+8192>>14),U[B]=T(J+8192>>14),B=B+q*4|0}B=(L+1)*4|0,N=(L+1)*$*4|0}}function JM(M,U,$,q,Z,D){let J,K,G,Q,j,A,k,I,L,C,R,N,B=0,V=0;for(C=0;C<q;C++){A=0;for(R=0;R<Z;R++){k=D[A++],I=D[A++],L=B+k*4|0,J=K=G=Q=0;for(;I>0;I--)N=D[A++],j=M[L+3],Q=Q+N*j|0,G=G+N*M[L+2]*j|0,K=K+N*M[L+1]*j|0,J=J+N*M[L]*j|0,L=L+4|0;G=G/255|0,K=K/255|0,J=J/255|0,U[V+3]=x(Q>>7),U[V+2]=x(G>>7),U[V+1]=x(K>>7),U[V]=x(J>>7),V=V+q*4|0}V=(C+1)*4|0,B=(C+1)*$*4|0}}function KM(M,U,$,q,Z,D){let J,K,G,Q,j,A,k,I,L,C,R,N=0,B=0;for(L=0;L<q;L++){j=0;for(C=0;C<Z;C++){A=D[j++],k=D[j++],I=N+A*4|0,J=K=G=Q=0;for(;k>0;k--)R=D[j++],Q=Q+R*M[I+3]|0,G=G+R*M[I+2]|0,K=K+R*M[I+1]|0,J=J+R*M[I]|0,I=I+4|0;if(J>>=7,K>>=7,G>>=7,Q>>=7,Q=T(Q+8192>>14),Q>0)J=J*255/Q|0,K=K*255/Q|0,G=G*255/Q|0;U[B+3]=Q,U[B+2]=T(G+8192>>14),U[B+1]=T(K+8192>>14),U[B]=T(J+8192>>14),B=B+q*4|0}B=(L+1)*4|0,N=(L+1)*$*4|0}}function SM(M,U,$){let q=3,Z=U*$*4|0;while(q<Z){if(M[q]!==255)return!0;q=q+4|0}return!1}function HM(M,U,$){let q=3,Z=U*$*4|0;while(q<Z)M[q]=255,q=q+4|0}function QM(M){let{src:U,width:$,height:q,toWidth:Z,toHeight:D}=M,J=M.scaleX||M.toWidth/M.width,K=M.scaleY||M.toHeight/M.height,G=M.offsetX||0,Q=M.offsetY||0,j=M.dest||new Uint8Array(Z*D*4),A=typeof M.filter==="undefined"?"mks2013":M.filter,k=p(A,$,Z,J,G),I=p(A,q,D,K,Q),L=new Uint16Array(Z*q*4);if(SM(U,$,q))JM(U,L,$,q,Z,k),KM(L,j,q,Z,D,I);else UM(U,L,$,q,Z,k),qM(L,j,q,Z,D,I),HM(j,Z,D);return j}var IM=wM(DM(),1);function bM(M,U,$){let q=U*$,Z=new Uint16Array(q),D,J,K,G;for(let Q=0;Q<q;Q++)D=M[4*Q],J=M[4*Q+1],K=M[4*Q+2],G=D>=J&&D>=K?D:J>=K&&J>=D?J:K,Z[Q]=G<<8;return Z}function LM(M,U,$,q,Z,D){let J,K,G,Q,j;if(q===0||Z<0.5)return;if(Z>2)Z=2;let A=bM(M,U,$),k=new Uint16Array(A);IM.default(k,U,$,Z);let I=q/100*4096+0.5|0,L=D<<8,C=U*$;for(let R=0;R<C;R++)if(J=A[R],Q=J-k[R],Math.abs(Q)>=L)K=J+(I*Q+2048>>12),K=K>65280?65280:K,K=K<0?0:K,J=J!==0?J:1,G=(K<<12)/J|0,j=R*4,M[j]=M[j]*G+2048>>12,M[j+1]=M[j+1]*G+2048>>12,M[j+2]=M[j+2]*G+2048>>12}function AM(M){let U=QM(M);if(M.unsharpAmount)LM(U,M.toWidth,M.toHeight,M.unsharpAmount,M.unsharpRadius,M.unsharpThreshold);return U}function kM(M){return Promise.resolve().then(()=>{return{data:AM(M)}})}function RM(M,U,$){let q;if(q=new ImageData(new Uint8ClampedArray(U.data),M.toWidth,M.toHeight),!1)$.toCtx?.putImageData(q,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth+0.00001,M.toInnerHeight+0.00001);else $.toCtx?.putImageData(q,M.toX,M.toY,M.toInnerX-M.toX,M.toInnerY-M.toY,M.toInnerWidth,M.toInnerHeight);return null}function CM(M){return M instanceof OffscreenCanvas}function BM(M){return M instanceof ImageBitmap}var TM=(M,U,$,q,Z,D,J)=>{let K={width:M.width,height:M.height,toWidth:M.toWidth,toHeight:M.toHeight,scaleX:M.scaleX,scaleY:M.scaleY,offsetX:M.offsetX,offsetY:M.offsetY,filter:$,unsharpAmount:q,unsharpRadius:Z,unsharpThreshold:D};return Promise.resolve(K).then((G)=>i(M,U,null,J,G)).then((G)=>kM(G)).then((G)=>RM(M,G,J))};function VM(M,U,$,q,Z,D,J,K,G,Q,j,A){let k={srcCtx:null,srcImageBitmap:null,isImageBitmapReused:!1,toCtx:null};return Promise.resolve().then(()=>{if(k.toCtx=U.getContext("2d"),CM(M))return null;if(BM(M))return k.srcImageBitmap=M,k.isImageBitmapReused=!0,null;throw new Error('Pica: ".from" should be Image, Canvas or ImageBitmap')}).then(()=>{let L=e($,q,J,Z,D,K).map((R)=>TM(R,M,G,Q,j,A,k));function C(R){if(R.srcImageBitmap){if(!R.isImageBitmapReused)R.srcImageBitmap.close();R.srcImageBitmap=null}}return Promise.all(L).then(()=>{return C(k),U},(R)=>{throw C(k),R})})}async function c(M,U,$,q,Z,D,J,K,G,Q,j,A,k){let I=M.shift();if(!I)throw new Error("Pica: Stages are empty");let[L,C]=I,R=M.length===0;D=L,J=C;let N;if(!R)N=new OffscreenCanvas(L,C);if(await VM(U,R?$:N,q,Z,D,J,K,G,Q,j,A,k),R)return $;return q=L,Z=C,await c(M,N,$,q,Z,D,J,K,G,Q,j,A,k)}async function NM(M,U){let $=U.maxDimension,q=U.tileSize??1024,Z=U.unsharpAmount??0,D=U.unsharpRadius??0,J=U.unsharpThreshold??0,K=await createImageBitmap(M),G=K.width,Q=K.height,j=$/G,A=$/Q,k=Math.min(j,A,1),I=Math.floor(G*k),L=Math.floor(Q*k),C=new OffscreenCanvas(I,L),R=3,N=Math.ceil(Math.max(3,2.5*D|0)),B=s(G,Q,I,L,q,N),V={filter:"mks2013",unsharpAmount:Z,unsharpRadius:D,unsharpThreshold:J,width:G,height:Q,toWidth:I,toHeight:L,destTileBorder:N};return(await c(B,K,C,V.width,V.height,V.toWidth,V.toHeight,1024,V.destTileBorder,V.filter,V.unsharpAmount,V.unsharpRadius,V.unsharpThreshold)).transferToImageBitmap()}self.onmessage=async(M)=>{let{taskId:U,blob:$,options:q}=M.data;try{let Z=await NM($,q);self.postMessage({taskId:U,output:Z},[Z])}catch(Z){self.postMessage({taskId:U,error:Z})}};
`,nk=new Blob([vk],{type:"application/javascript"}),hk=(()=>{let k=0;return()=>++k})();class Xk{#M;#Q;#U;#k;constructor(){this.#M=new Map,this.#Q=new Map,this.#U=new Map,this.#k=new Map}get count(){return this.#M.size}setWorkerTimeout(k,M){let q=setTimeout(()=>{let Q=this.#M.get(k);if(Q)this.#U.delete(Q);if(Q)this.#k.delete(Q);this.#Q.delete(k),this.#M.delete(k),k.terminate()},M);this.#Q.set(k,q)}clearWorkerTimeout(k){clearTimeout(this.#Q.get(k))}addWorker(k){this.#M.set(k,null)}getWorker(k){return this.#U.get(k)}getTask(k){return this.#k.get(k)}getAvailableWorker(){for(let[k,M]of this.#M.entries())if(M===null)return k;return null}assignTask(k,M){this.#M.set(k,M.id),this.#U.set(M.id,k),this.#k.set(M.id,M);let q={taskId:M.id,blob:M.data.blob,options:M.data.options};k.postMessage(q)}removeTask(k){let M=this.#U.get(k);if(M)this.#M.set(M,null);this.#U.delete(k),this.#k.delete(k)}}class l{#M;#Q;#U;#k;constructor(k,M){this.#Q=k,this.#M=M,this.#U=[],this.#k=new Xk}#I(){let k=new Worker(URL.createObjectURL(nk));k.onmessage=(M)=>{let{taskId:q,output:Q,error:$}=M.data,j=this.#k.getWorker(q),U=this.#k.getTask(q);if($){if(U)U.reject($)}else if(U)U.resolve(Q);if(this.#k.removeTask(q),j)this.#k.setWorkerTimeout(j,this.#M);this.#q()},k.onerror=(M)=>{console.log(M.message),console.log(M)},this.#k.addWorker(k)}#q(){let k=this.#k.getAvailableWorker();if(k){let M=this.#U.shift();if(M)this.#k.assignTask(k,M),this.#k.clearWorkerTimeout(k)}else if(this.#k.count<this.#Q)this.#I(),this.#q()}addTask(k){return new Promise((M,q)=>{this.#U.push({id:hk(),data:{blob:k.blob,options:k.options},resolve:M,reject:q}),this.#q()})}}class gk{#M;#Q;constructor(k){let M=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,q=k.maxWorkerPoolSize||Math.min(M,4),Q=k.maxWorkerIdleTime||2000;this.#M=new l(q,Q),this.#Q=k}squish(k,M){let q=M?{...this.#Q,...M}:this.#Q;if(q.useMainThread)return Nk(k,q);return this.#M.addTask({blob:k,options:q})}}export{gk as PicSquish};
