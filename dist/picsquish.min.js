var l=4;class u{raw;width;height;constructor(t,n,e){this.raw=t,this.width=n,this.height=e}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let t=document.createElement("canvas");t.width=this.width,t.height=this.height;let n=t.getContext("2d");if(!n)throw new Error("Picsquish error: canvas 2D context not supported");return n.putImageData(this.toImageData(),0,0),t}toBlob(t="image/png"){let n=new OffscreenCanvas(this.width,this.height),e=n.getContext("2d");if(!e)throw new Error("Picsquish error: canvas 2D context not supported");return e.putImageData(this.toImageData(),0,0),n.convertToBlob({type:t})}}function T(t,n,e){let r=new Uint8ClampedArray(e.tile);for(let b=0;b<e.toHeight;b++){let i=b*e.toWidth*l,m=((e.toY+b)*n+e.toX)*l;t.set(r.subarray(i,i+e.toWidth*l),m)}}var E=`
var Ak=Object.create;var{getPrototypeOf:Jk,defineProperty:m,getOwnPropertyNames:Kk}=Object;var $k=Object.prototype.hasOwnProperty;var Gk=(k,I,q)=>{q=k!=null?Ak(Jk(k)):{};let M=I||!k||!k.__esModule?m(q,"default",{value:k,enumerable:!0}):q;for(let u of Kk(k))if(!$k.call(M,u))m(M,u,{get:()=>k[u],enumerable:!0});return M};var Qk=(k,I)=>()=>(I||k((I={exports:{}}).exports,I),I.exports);var qk=Qk((sk,Mk)=>{var n,_,x,g,T,H,i,kk;function Nk(k){if(k<0.5)k=0.5;var I=Math.exp(0.527076)/k,q=Math.exp(-I),M=Math.exp(-2*I),u=(1-q)*(1-q)/(1+2*I*q-M);return n=u,_=u*(I-1)*q,x=u*(I+1)*q,g=-u*M,T=2*q,H=-M,i=(n+_)/(1-T-H),kk=(x+g)/(1-T-H),new Float32Array([n,_,x,g,T,H,i,kk])}function Ik(k,I,q,M,u,K){var D,y,U,R,J,G,B,A,Q,j,Z,b,$,C;for(Q=0;Q<K;Q++){G=Q*u,B=Q,A=0,D=k[G],J=D*M[6],R=J,Z=M[0],b=M[1],$=M[4],C=M[5];for(j=0;j<u;j++)y=k[G],U=y*Z+D*b+R*$+J*C,J=R,R=U,D=y,q[A]=R,A++,G++;G--,A--,B+=K*(u-1),D=k[G],J=D*M[7],R=J,y=D,Z=M[2],b=M[3];for(j=u-1;j>=0;j--)U=y*Z+D*b+R*$+J*C,J=R,R=U,D=y,y=k[G],I[B]=q[A]+R,G--,A--,B-=K}}function Ek(k,I,q,M){if(!M)return;var u=new Uint16Array(k.length),K=new Float32Array(Math.max(I,q)),D=Nk(M);Ik(k,u,K,D,I,q,M),Ik(u,k,K,D,q,I,M)}Mk.exports=Ek});var S=4;var Zk=2;function a(k,I,q,M,u,K){let D=q/k,y=M/I,U=(2*K+Zk+1)/u;if(U>0.5)return[{toWidth:q,toHeight:M}];let R=Math.ceil(Math.log(Math.min(D,y))/Math.log(U));if(R<=1)return[{toWidth:q,toHeight:M}];let J=[];for(let G=0;G<R;G++){let B=Math.round(Math.pow(Math.pow(k,R-G-1)*Math.pow(q,G+1),1/R)),A=Math.round(Math.pow(Math.pow(I,R-G-1)*Math.pow(M,G+1),1/R));J.push({toWidth:B,toHeight:A})}return J}function Bk(k,I){if(k)k.width=k.height=0;k=I=null}function jk(k,I){let q=new OffscreenCanvas(I.width,I.height),M=q.getContext("2d");if(!M)throw new Error("Picsquish error: canvas 2D context not supported");M.globalCompositeOperation="copy",M.drawImage(k,I.x,I.y,I.width,I.height,0,0,I.width,I.height);let u=M.getImageData(0,0,I.width,I.height).data.buffer;return Bk(q,M),u}function bk(k,I,q){let M=new Uint8ClampedArray(q.width*q.height*S);for(let u=0;u<q.height;u++){let K=((q.y+u)*I+q.x)*S,D=u*q.width*S;M.set(k.subarray(K,K+q.width*S),D)}return M.buffer}function h(k,I,q){if(k instanceof ImageBitmap)return jk(k,q);else return bk(k,I,q)}var o=0.00001;function O(k){let I=Math.round(k);if(Math.abs(k-I)<o)return I;return Math.floor(k)}function d(k){let I=Math.round(k);if(Math.abs(k-I)<o)return I;return Math.ceil(k)}function W(k,I,q,M,u,K){let{initialSize:D,filterPadding:y,filter:U,unsharpAmount:R,unsharpRadius:J,unsharpThreshold:G}=K,B=M/I,A=u/q,Q=O(D*B)-2*y,j=O(D*A)-2*y;if(Q<1||j<1)throw new Error("Picsquish error: target tile width/height is too small");let Z,b,$,C,V,z,L=[];for(C=0;C<u;C+=j)for($=0;$<M;$+=Q){if(Z=$-y,Z<0)Z=0;if(V=$+Q+y-Z,Z+V>=M)V=M-Z;if(b=C-y,b<0)b=0;if(z=C+j+y-b,b+z>=u)z=u-b;let w={toX:Z,toY:b,toWidth:V,toHeight:z,toInnerX:$,toInnerY:C,toInnerWidth:Q,toInnerHeight:j,offsetX:Z/B-O(Z/B),offsetY:b/A-O(b/A),scaleX:B,scaleY:A,x:O(Z/B),y:O(b/A),width:d(V/B),height:d(z/A),initialSize:D,filterPadding:y,filter:U,unsharpAmount:R,unsharpRadius:J,unsharpThreshold:G},F=h(k,I,w);L.push({tile:F,...w})}return L}async function Ck(k,I,q){let M=k instanceof ImageBitmap?k:await createImageBitmap(k),u=[];for(let K of q){let D=M,y=M.width,U=M.height,R=K/y,J=K/U,G=Math.min(R,J,1),B=Math.floor(y*G),A=Math.floor(U*G),Q=a(y,U,B,A,I.initialSize,I.filterPadding),j=W(D,y,U,Q[0].toWidth,Q[0].toHeight,I);u.push({stages:Q,tileTransforms:j})}return M.close(),u}function Lk(k,I){let q=W(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,I);return[{stages:k.stages,tileTransforms:q}]}async function c(k){if(k.image instanceof Blob||k.image instanceof ImageBitmap)return Ck(k.image,k.tileOptions,k.dimensionLimits);else return Lk(k.image,k.tileOptions)}var p={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*(0.54+0.46*Math.cos(I/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/2)/(I/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let I=k*Math.PI;return Math.sin(I)/I*Math.sin(I/3)/(I/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var wk=14;function s(k){return Math.round(k*((1<<wk)-1))}function v(k,I,q,M,u){let K=p[k].fn,D=1/M,y=Math.min(1,M),U=p[k].win/y,R,J,G,B,A,Q,j,Z,b,$,C,V,z,L,w,F,P,uk=Math.floor((U+1)*2),N=new Int16Array((uk+2)*q),Y=0,Uk=!N.subarray||!N.set;for(R=0;R<q;R++){J=(R+0.5)*D+u,G=Math.max(0,Math.floor(J-U)),B=Math.min(I-1,Math.ceil(J+U)),A=B-G+1,Q=new Float32Array(A),j=new Int16Array(A),Z=0;for(b=G,$=0;b<=B;b++,$++)C=K((b+0.5-J)*y),Z+=C,Q[$]=C;V=0;for($=0;$<Q.length;$++)z=Q[$]/Z,V+=z,j[$]=s(z);j[q>>1]+=s(1-V),L=0;while(L<j.length&&j[L]===0)L++;if(L<j.length){w=j.length-1;while(w>0&&j[w]===0)w--;if(F=G+L,P=w-L+1,N[Y++]=F,N[Y++]=P,!Uk)N.set(j.subarray(L,w+1),Y),Y+=P;else for($=L;$<=w;$++)N[Y++]=j[$]}else N[Y++]=0,N[Y++]=0}return N}function E(k){return k<0?0:k>255?255:k}function X(k){return k>=0?k:0}function f(k,I,q,M,u,K){let D,y,U,R,J,G,B,A,Q,j,Z,b=0,$=0;for(Q=0;Q<M;Q++){J=0;for(j=0;j<u;j++){G=K[J++],B=K[J++],A=b+G*4|0,D=y=U=R=0;for(;B>0;B--)Z=K[J++],R=R+Z*k[A+3]|0,U=U+Z*k[A+2]|0,y=y+Z*k[A+1]|0,D=D+Z*k[A]|0,A=A+4|0;I[$+3]=X(R>>7),I[$+2]=X(U>>7),I[$+1]=X(y>>7),I[$]=X(D>>7),$=$+M*4|0}$=(Q+1)*4|0,b=(Q+1)*q*4|0}}function l(k,I,q,M,u,K){let D,y,U,R,J,G,B,A,Q,j,Z,b=0,$=0;for(Q=0;Q<M;Q++){J=0;for(j=0;j<u;j++){G=K[J++],B=K[J++],A=b+G*4|0,D=y=U=R=0;for(;B>0;B--)Z=K[J++],R=R+Z*k[A+3]|0,U=U+Z*k[A+2]|0,y=y+Z*k[A+1]|0,D=D+Z*k[A]|0,A=A+4|0;D>>=7,y>>=7,U>>=7,R>>=7,I[$+3]=E(R+8192>>14),I[$+2]=E(U+8192>>14),I[$+1]=E(y+8192>>14),I[$]=E(D+8192>>14),$=$+M*4|0}$=(Q+1)*4|0,b=(Q+1)*q*4|0}}function r(k,I,q,M,u,K){let D,y,U,R,J,G,B,A,Q,j,Z,b,$=0,C=0;for(j=0;j<M;j++){G=0;for(Z=0;Z<u;Z++){B=K[G++],A=K[G++],Q=$+B*4|0,D=y=U=R=0;for(;A>0;A--)b=K[G++],J=k[Q+3],R=R+b*J|0,U=U+b*k[Q+2]*J|0,y=y+b*k[Q+1]*J|0,D=D+b*k[Q]*J|0,Q=Q+4|0;U=U/255|0,y=y/255|0,D=D/255|0,I[C+3]=X(R>>7),I[C+2]=X(U>>7),I[C+1]=X(y>>7),I[C]=X(D>>7),C=C+M*4|0}C=(j+1)*4|0,$=(j+1)*q*4|0}}function e(k,I,q,M,u,K){let D,y,U,R,J,G,B,A,Q,j,Z,b=0,$=0;for(Q=0;Q<M;Q++){J=0;for(j=0;j<u;j++){G=K[J++],B=K[J++],A=b+G*4|0,D=y=U=R=0;for(;B>0;B--)Z=K[J++],R=R+Z*k[A+3]|0,U=U+Z*k[A+2]|0,y=y+Z*k[A+1]|0,D=D+Z*k[A]|0,A=A+4|0;if(D>>=7,y>>=7,U>>=7,R>>=7,R=E(R+8192>>14),R>0)D=D*255/R|0,y=y*255/R|0,U=U*255/R|0;I[$+3]=R,I[$+2]=E(U+8192>>14),I[$+1]=E(y+8192>>14),I[$]=E(D+8192>>14),$=$+M*4|0}$=(Q+1)*4|0,b=(Q+1)*q*4|0}}function Vk(k,I,q){let M=3,u=I*q*4|0;while(M<u){if(k[M]!==255)return!0;M=M+4|0}return!1}function zk(k,I,q){let M=3,u=I*q*4|0;while(M<u)k[M]=255,M=M+4|0}function t(k,I,q,M,u,K,D,y,U,R){let J=v(I,q,u,D,U),G=v(I,M,K,y,R),B=new Uint8Array(u*K*4),A=new Uint16Array(u*M*4);if(Vk(k,q,M))r(k,A,q,M,u,J),e(A,B,M,u,K,G);else f(k,A,q,M,u,J),l(A,B,M,u,K,G),zk(B,u,K);return B}var Dk=Gk(qk(),1);function Xk(k,I,q){let M=I*q,u=new Uint16Array(M),K,D,y,U;for(let R=0;R<M;R++)K=k[4*R],D=k[4*R+1],y=k[4*R+2],U=K>=D&&K>=y?K:D>=y&&D>=K?D:y,u[R]=U<<8;return u}function yk(k,I,q,M,u,K){let D,y,U,R,J;if(M===0||u<0.5)return;if(u>2)u=2;let G=Xk(k,I,q),B=new Uint16Array(G);Dk.default(B,I,q,u);let A=M/100*4096+0.5|0,Q=K<<8,j=I*q;for(let Z=0;Z<j;Z++)if(D=G[Z],R=D-B[Z],Math.abs(R)>=Q)y=D+(A*R+2048>>12),y=y>65280?65280:y,y=y<0?0:y,D=D!==0?D:1,U=(y<<12)/D|0,J=Z*4,k[J]=k[J]*U+2048>>12,k[J+1]=k[J+1]*U+2048>>12,k[J+2]=k[J+2]*U+2048>>12}function Rk(k){let I=t(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)yk(I,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return I}var Yk=async(k)=>{let{taskId:I,squishId:q,taskType:M,data:u}=k,{image:K,dimensionLimits:D,tileOptions:y}=u,U=await c({image:K,dimensionLimits:D,tileOptions:y}),R={taskId:I,squishId:q,taskType:M,output:U},J=U.flatMap((G)=>G.tileTransforms.map((B)=>B.tile));self.postMessage(R,J)};function Ok(k){let{taskId:I,squishId:q,workspaceIndex:M,taskType:u,data:K}=k,{tileTransform:D}=K;D.tile=Rk(D).buffer;let y={taskId:I,squishId:q,workspaceIndex:M,taskType:u,output:{tileTransform:D}};self.postMessage(y,[D.tile])}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let I=k.data;try{return await Yk(I)}catch(q){return self.postMessage({taskId:I.taskId,squishId:I.squishId,taskType:I.taskType,error:q})}}case 1:{let I=k.data;try{return Ok(I)}catch(q){return self.postMessage({taskId:I.taskId,squishId:I.squishId,workspaceIndex:I.workspaceIndex,taskType:I.taskType,error:q})}}}};
`,U=new Blob([E],{type:"application/javascript"});class I{#t;#e;#n;#m;constructor(){this.#t=new Map,this.#e=new Map,this.#n=null,this.#m=null}#r(){if(this.#n===null)return;clearTimeout(this.#n),this.#n=null}prepare(t,n,e){if(this.#t.size)return;this.#m=e;let r=URL.createObjectURL(U);while(this.#t.size<n){let b=new Worker(r);b.onmessage=t,this.#t.set(b,null)}URL.revokeObjectURL(r)}assignTask(t,n,e,r){this.#t.set(t,n),this.#e.set(n,t),this.#r(),t.postMessage(e,r)}setTimeout(){if(this.#n!==null)return;this.#n=setTimeout(()=>{for(let t of this.#t.keys())t.terminate();this.#t.clear(),this.#e.clear()},this.#m||0)}getAvailableWorkers(){let t=[];for(let[n,e]of this.#t.entries())if(e===null)t.push(n);return t}removeTask(t){let n=this.#e.get(t);if(n)this.#t.set(n,null);this.#e.delete(t)}}var h=new I;var d=(()=>{let t=0;return()=>++t})();class R{#t;#e;#n;constructor(){this.#t=new Map,this.#e=[],this.#n=[]}#m(t,n){let e=d(),r={taskId:e,squishId:n.squishId,taskType:0,data:n.data},b=n.data.image instanceof ImageBitmap?[n.data.image]:[];h.assignTask(t,e,r,b)}#r(t,n){let e=d(),r={taskId:e,squishId:n.squishId,workspaceIndex:n.workspaceIndex,taskType:1,data:n.data};h.assignTask(t,e,r,[n.data.tileTransform.tile])}#i(t){let n=this.#e.shift();if(n)return this.#m(t,n);let e=this.#n.shift();if(e)return this.#r(t,e)}#b(){if(this.#e.length===0&&this.#n.length===0)return h.setTimeout();let n=h.getAvailableWorkers();for(let e of n)this.#i(e)}#g(t,n){let{squishId:e,output:r,error:b}=n;if(b)return t.workspaceHandlers.forEach((i)=>i.reject(b));for(let[i,m]of r.entries()){let g=m.stages[0].toWidth,a=m.stages[0].toHeight;t.workspaces.set(i,{to:new Uint8ClampedArray(g*a*l),toWidth:g,toHeight:a,stages:m.stages,remainingTileCount:m.tileTransforms.length});for(let f of m.tileTransforms)this.#n.push({squishId:e,workspaceIndex:i,data:{tileTransform:f}})}}#h(t,n){let{squishId:e,workspaceIndex:r,output:b,error:i}=n;if(!t.workspaces.has(r))return;let m=t.workspaces.get(r);if(!m)throw new Error("Picsquish error: workspace not found");let g=t.workspaceHandlers.get(r);if(!g)throw new Error("Picsquish error: workspaceHandler not found");if(i)return t.workspaces.delete(r),this.#n=this.#n.filter((f)=>!(f.squishId===e&&f.workspaceIndex===r)),g.reject(i);if(T(m.to,m.toWidth,b.tileTransform),--m.remainingTileCount,m.remainingTileCount)return;if(m.stages.shift(),!m.stages[0])return t.workspaces.delete(r),g.resolve(new u(m.to,m.toWidth,m.toHeight));this.#e.push({squishId:e,data:{image:{from:m.to,fromWidth:m.toWidth,fromHeight:m.toHeight,stages:m.stages},dimensionLimits:[],tileOptions:t.tileOptions}})}#a(t){let n=this.#t.get(t.data.squishId);if(!n)throw new Error("Picsquish error: squishContext not found");switch(t.data.taskType){case 0:this.#g(n,t.data);break;case 1:this.#h(n,t.data);break}if(!n.workspaces.size)this.#t.delete(t.data.squishId);h.removeTask(t.data.taskId),this.#b()}add(t,n,e){h.prepare((m)=>this.#a(m),n,e);let r=[],b=new Map;for(let m=0;m<t.dimensionLimits.length;m++)r.push(new Promise((g,a)=>{b.set(m,{resolve:g,reject:a})}));let i=d();return this.#t.set(i,{tileOptions:t.tileOptions,workspaces:new Map,workspaceHandlers:b}),this.#e.push({squishId:i,data:t}),queueMicrotask(()=>this.#b()),r}}var c=new R;function w(t,n,e={}){let r=e.tileSize||1024,b=e.filter||"mks2013",i=e.unsharpAmount||0,m=e.unsharpRadius||0,g=e.unsharpThreshold||0,a=e.useMainThread,f=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,p=e.maxWorkerPoolSize||Math.min(f,4),y=e.maxWorkerIdleTime||2000,A=3,B=Math.ceil(Math.max(3,2.5*m|0)),D={initialSize:r,filterPadding:B,filter:b,unsharpAmount:i,unsharpRadius:m,unsharpThreshold:g};return c.add({image:t,dimensionLimits:n,tileOptions:D},p,y)}export{w as squish};
