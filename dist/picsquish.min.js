var Ln=Object.create;var{getPrototypeOf:Gn,defineProperty:_,getOwnPropertyNames:En}=Object;var On=Object.prototype.hasOwnProperty;var un=(n,k,I)=>{I=n!=null?Ln(Gn(n)):{};let m=k||!n||!n.__esModule?_(I,"default",{value:n,enumerable:!0}):I;for(let T of En(n))if(!On.call(m,T))_(m,T,{get:()=>n[T],enumerable:!0});return m};var zn=(n,k)=>()=>(k||n((k={exports:{}}).exports,k),k.exports);var qn=zn((Tk,Cn)=>{var c,f,i,t,p,x,wn,An;function Fn(n){if(n<0.5)n=0.5;var k=Math.exp(0.527076)/n,I=Math.exp(-k),m=Math.exp(-2*k),T=(1-I)*(1-I)/(1+2*k*I-m);return c=T,f=T*(k-1)*I,i=T*(k+1)*I,t=-T*m,p=2*I,x=-m,wn=(c+f)/(1-p-x),An=(i+t)/(1-p-x),new Float32Array([c,f,i,t,p,x,wn,An])}function an(n,k,I,m,T,y){var R,M,D,B,w,A,Q,U,C,K,q,J,a,$,j,E,Z,L,V,z,N,G,X,O,s,h,Y,S,b,F;for(s=0;s<y;s++){G=s*T,X=s,O=0,R=n[G],M=R&255,D=R>>8&255,B=R>>16&255,w=R>>24&255,L=M*m[6],V=D*m[6],z=B*m[6],N=w*m[6],$=L,j=V,E=z,Z=N,Y=m[0],S=m[1],b=m[4],F=m[5];for(h=0;h<T;h++)R=n[G],A=R&255,Q=R>>8&255,U=R>>16&255,C=R>>24&255,K=A*Y+M*S+$*b+L*F,q=Q*Y+D*S+j*b+V*F,J=U*Y+B*S+E*b+z*F,a=C*Y+w*S+Z*b+N*F,L=$,V=j,z=E,N=Z,$=K,j=q,E=J,Z=a,M=A,D=Q,B=U,w=C,I[O]=$,I[O+1]=j,I[O+2]=E,I[O+3]=Z,O+=4,G++;G--,O-=4,X+=y*(T-1),R=n[G],M=R&255,D=R>>8&255,B=R>>16&255,w=R>>24&255,L=M*m[7],V=D*m[7],z=B*m[7],N=w*m[7],$=L,j=V,E=z,Z=N,A=M,Q=D,U=B,C=w,Y=m[2],S=m[3];for(h=T-1;h>=0;h--)K=A*Y+M*S+$*b+L*F,q=Q*Y+D*S+j*b+V*F,J=U*Y+B*S+E*b+z*F,a=C*Y+w*S+Z*b+N*F,L=$,V=j,z=E,N=Z,$=K,j=q,E=J,Z=a,M=A,D=Q,B=U,w=C,R=n[G],A=R&255,Q=R>>8&255,U=R>>16&255,C=R>>24&255,R=(I[O]+$<<0)+(I[O+1]+j<<8)+(I[O+2]+E<<16)+(I[O+3]+Z<<24),k[X]=R,G--,O-=4,X-=y}}function Wn(n,k,I,m){if(!m)return;var T=new Uint32Array(n.buffer),y=new Uint32Array(T.length),R=new Float32Array(Math.max(k,I)*4),M=Fn(m);an(T,y,R,M,k,I,m),an(y,T,R,M,I,k,m)}Cn.exports=Wn});var u=4;class o{raw;width;height;constructor(n,k,I){this.raw=n,this.width=k,this.height=I}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toBlob(n="image/png"){let k=new OffscreenCanvas(this.width,this.height),I=k.getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");return I.putImageData(this.toImageData(),0,0),k.convertToBlob({type:n})}}var Xn=2;function r(n,k,I,m,T,y){let R=I/n,M=m/k,D=(2*y+Xn+1)/T;if(D>0.5)return[{toWidth:I,toHeight:m}];let B=Math.ceil(Math.log(Math.min(R,M))/Math.log(D));if(B<=1)return[{toWidth:I,toHeight:m}];let w=[];for(let A=0;A<B;A++){let Q=Math.round(Math.pow(Math.pow(n,B-A-1)*Math.pow(I,A+1),1/B)),U=Math.round(Math.pow(Math.pow(k,B-A-1)*Math.pow(m,A+1),1/B));w.push({toWidth:Q,toHeight:U})}return w}function Vn(n,k){let m=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!m)throw new Error("Picsquish error: canvas 2D context not supported");return m.globalCompositeOperation="copy",m.drawImage(n,k.x,k.y,k.width,k.height,0,0,k.width,k.height),m.getImageData(0,0,k.width,k.height).data.buffer}function Nn(n,k,I){let m=new Uint8ClampedArray(I.width*I.height*u);for(let T=0;T<I.height;T++){let y=((I.y+T)*k+I.x)*u,R=T*I.width*u;m.set(n.subarray(y,y+I.width*u),R)}return m.buffer}function nn(n,k,I){if(n instanceof ImageBitmap)return Vn(n,I);else return Nn(n,k,I)}var In=0.00001;function g(n){let k=Math.round(n);if(Math.abs(n-k)<In)return k;return Math.floor(n)}function kn(n){let k=Math.round(n);if(Math.abs(n-k)<In)return k;return Math.ceil(n)}function mn(n,k,I,m,T,y,R,M,D,B,w){let A=m/k,Q=T/I,U=g(y*A)-2*R,C=g(y*Q)-2*R;if(U<1||C<1)throw new Error("Picsquish error: target tile width/height is too small");let K,q,J,a,$,j,E=[];for(a=0;a<T;a+=C)for(J=0;J<m;J+=U){if(K=J-R,K<0)K=0;if($=J+U+R-K,K+$>=m)$=m-K;if(q=a-R,q<0)q=0;if(j=a+C+R-q,q+j>=T)j=T-q;let Z={toX:K,toY:q,toWidth:$,toHeight:j,toInnerX:J,toInnerY:a,toInnerWidth:U,toInnerHeight:C,offsetX:K/A-g(K/A),offsetY:q/Q-g(q/Q),scaleX:A,scaleY:Q,x:g(K/A),y:g(q/Q),width:kn($/A),height:kn(j/Q),initialSize:y,filterPadding:R,filter:M,unsharpAmount:D,unsharpRadius:B,unsharpThreshold:w},L=nn(n,k,Z);E.push({tile:L,...Z})}return E}async function Rn(n){let k,I,m,T,y,R;if(n.image instanceof Blob||n.image instanceof ImageBitmap){let D=n.image instanceof ImageBitmap?n.image:await createImageBitmap(n.image);k=D,I=D.width,m=D.height;let B=n.maxDimension/I,w=n.maxDimension/m,A=Math.min(B,w,1),Q=Math.floor(I*A),U=Math.floor(m*A);T=r(I,m,Q,U,n.tileOptions.initialSize,n.tileOptions.filterPadding)}else k=n.image.from,I=n.image.fromWidth,m=n.image.fromHeight,T=n.image.stages;y=T[0].toWidth,R=T[0].toHeight;let M=mn(k,I,m,y,R,n.tileOptions.initialSize,n.tileOptions.filterPadding,n.tileOptions.filter,n.tileOptions.unsharpAmount,n.tileOptions.unsharpRadius,n.tileOptions.unsharpThreshold);if(k instanceof ImageBitmap)k.close();return{tileTransforms:M,stages:T}}var v={box:{win:0.5,fn:(n)=>{if(n<0)n=-n;return n<0.5?1:0}},hamming:{win:1,fn:(n)=>{if(n<0)n=-n;if(n>=1)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(n)=>{if(n<0)n=-n;if(n>=2)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(n)=>{if(n<0)n=-n;if(n>=3)return 0;if(n<0.00000011920929)return 1;let k=n*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(n)=>{if(n<0)n=-n;if(n>=2.5)return 0;if(n>=1.5)return-0.125*(n-2.5)*(n-2.5);if(n>=0.5)return 0.25*(4*n*n-11*n+7);return 1.0625-1.75*n*n}}};var Yn=14;function Tn(n){return Math.round(n*((1<<Yn)-1))}function l(n,k,I,m,T){let y=v[n].fn,R=1/m,M=Math.min(1,m),D=v[n].win/M,B,w,A,Q,U,C,K,q,J,a,$,j,E,Z,L,V,z,N=Math.floor((D+1)*2),G=new Int16Array((N+2)*I),X=0,O=!G.subarray||!G.set;for(B=0;B<I;B++){w=(B+0.5)*R+T,A=Math.max(0,Math.floor(w-D)),Q=Math.min(k-1,Math.ceil(w+D)),U=Q-A+1,C=new Float32Array(U),K=new Int16Array(U),q=0;for(J=A,a=0;J<=Q;J++,a++)$=y((J+0.5-w)*M),q+=$,C[a]=$;j=0;for(a=0;a<C.length;a++)E=C[a]/q,j+=E,K[a]=Tn(E);K[I>>1]+=Tn(1-j),Z=0;while(Z<K.length&&K[Z]===0)Z++;if(Z<K.length){L=K.length-1;while(L>0&&K[L]===0)L--;if(V=A+Z,z=L-Z+1,G[X++]=V,G[X++]=z,!O)G.set(K.subarray(Z,L+1),X),X+=z;else for(a=Z;a<=L;a++)G[X++]=K[a]}else G[X++]=0,G[X++]=0}return G}function W(n){return n<0?0:n>255?255:n}function P(n){return n>=0?n:0}function Mn(n,k,I,m,T,y){let R,M,D,B,w,A,Q,U,C,K,q,J=0,a=0;for(C=0;C<m;C++){w=0;for(K=0;K<T;K++){A=y[w++],Q=y[w++],U=J+A*4|0,R=M=D=B=0;for(;Q>0;Q--)q=y[w++],B=B+q*n[U+3]|0,D=D+q*n[U+2]|0,M=M+q*n[U+1]|0,R=R+q*n[U]|0,U=U+4|0;k[a+3]=P(B>>7),k[a+2]=P(D>>7),k[a+1]=P(M>>7),k[a]=P(R>>7),a=a+m*4|0}a=(C+1)*4|0,J=(C+1)*I*4|0}}function yn(n,k,I,m,T,y){let R,M,D,B,w,A,Q,U,C,K,q,J=0,a=0;for(C=0;C<m;C++){w=0;for(K=0;K<T;K++){A=y[w++],Q=y[w++],U=J+A*4|0,R=M=D=B=0;for(;Q>0;Q--)q=y[w++],B=B+q*n[U+3]|0,D=D+q*n[U+2]|0,M=M+q*n[U+1]|0,R=R+q*n[U]|0,U=U+4|0;R>>=7,M>>=7,D>>=7,B>>=7,k[a+3]=W(B+8192>>14),k[a+2]=W(D+8192>>14),k[a+1]=W(M+8192>>14),k[a]=W(R+8192>>14),a=a+m*4|0}a=(C+1)*4|0,J=(C+1)*I*4|0}}function Bn(n,k,I,m,T,y){let R,M,D,B,w,A,Q,U,C,K,q,J,a=0,$=0;for(K=0;K<m;K++){A=0;for(q=0;q<T;q++){Q=y[A++],U=y[A++],C=a+Q*4|0,R=M=D=B=0;for(;U>0;U--)J=y[A++],w=n[C+3],B=B+J*w|0,D=D+J*n[C+2]*w|0,M=M+J*n[C+1]*w|0,R=R+J*n[C]*w|0,C=C+4|0;D=D/255|0,M=M/255|0,R=R/255|0,k[$+3]=P(B>>7),k[$+2]=P(D>>7),k[$+1]=P(M>>7),k[$]=P(R>>7),$=$+m*4|0}$=(K+1)*4|0,a=(K+1)*I*4|0}}function Dn(n,k,I,m,T,y){let R,M,D,B,w,A,Q,U,C,K,q,J=0,a=0;for(C=0;C<m;C++){w=0;for(K=0;K<T;K++){A=y[w++],Q=y[w++],U=J+A*4|0,R=M=D=B=0;for(;Q>0;Q--)q=y[w++],B=B+q*n[U+3]|0,D=D+q*n[U+2]|0,M=M+q*n[U+1]|0,R=R+q*n[U]|0,U=U+4|0;if(R>>=7,M>>=7,D>>=7,B>>=7,B=W(B+8192>>14),B>0)R=R*255/B|0,M=M*255/B|0,D=D*255/B|0;k[a+3]=B,k[a+2]=W(D+8192>>14),k[a+1]=W(M+8192>>14),k[a]=W(R+8192>>14),a=a+m*4|0}a=(C+1)*4|0,J=(C+1)*I*4|0}}function Sn(n,k,I){let m=3,T=k*I*4|0;while(m<T){if(n[m]!==255)return!0;m=m+4|0}return!1}function bn(n,k,I){let m=3,T=k*I*4|0;while(m<T)n[m]=255,m=m+4|0}function Un(n,k,I,m,T,y,R,M,D,B){let w=l(k,I,T,R,D),A=l(k,m,y,M,B),Q=new Uint8Array(T*y*4),U=new Uint16Array(T*m*4);if(Sn(n,I,m))Bn(n,U,I,m,T,w),Dn(U,Q,m,T,y,A);else Mn(n,U,I,m,T,w),yn(U,Q,m,T,y,A),bn(Q,T,y);return Q}var Qn=un(qn(),1);function Pn(n,k,I){let m=k*I,T=new Uint16Array(m),y,R,M,D;for(let B=0;B<m;B++)y=n[4*B],R=n[4*B+1],M=n[4*B+2],D=y>=R&&y>=M?y:R>=M&&R>=y?R:M,T[B]=D<<8;return T}function Kn(n,k,I,m,T,y){let R,M,D,B,w;if(m===0||T<0.5)return;if(T>2)T=2;let A=Pn(n,k,I),Q=new Uint16Array(A);Qn.default(Q,k,I,T);let U=m/100*4096+0.5|0,C=y<<8,K=k*I;for(let q=0;q<K;q++)if(R=A[q],B=R-Q[q],Math.abs(B)>=C)M=R+(U*B+2048>>12),M=M>65280?65280:M,M=M<0?0:M,R=R!==0?R:1,D=(M<<12)/R|0,w=q*4,n[w]=n[w]*D+2048>>12,n[w+1]=n[w+1]*D+2048>>12,n[w+2]=n[w+2]*D+2048>>12}function Jn(n){let k=Un(new Uint8ClampedArray(n.tile),n.filter,n.width,n.height,n.toWidth,n.toHeight,n.scaleX,n.scaleY,n.offsetX,n.offsetY);if(n.unsharpAmount)Kn(k,n.toWidth,n.toHeight,n.unsharpAmount,n.unsharpRadius,n.unsharpThreshold);return k}function d(n,k,I){let m=new Uint8ClampedArray(I.tile);for(let T=0;T<I.toHeight;T++){let y=T*I.toWidth*u,R=((I.toY+T)*k+I.toX)*u;n.set(m.subarray(y,y+I.toWidth*u),R)}}var Hn=`
var QI=Object.create;var{getPrototypeOf:$I,defineProperty:l,getOwnPropertyNames:ZI}=Object;var GI=Object.prototype.hasOwnProperty;var wI=(I,k,D)=>{D=I!=null?QI($I(I)):{};let R=k||!I||!I.__esModule?l(D,"default",{value:I,enumerable:!0}):D;for(let B of ZI(I))if(!GI.call(R,B))l(R,B,{get:()=>I[B],enumerable:!0});return R};var jI=(I,k)=>()=>(k||I((k={exports:{}}).exports,k),k.exports);var AI=jI((iI,nI)=>{var d,s,c,f,g,p,qI,mI;function NI(I){if(I<0.5)I=0.5;var k=Math.exp(0.527076)/I,D=Math.exp(-k),R=Math.exp(-2*k),B=(1-D)*(1-D)/(1+2*k*D-R);return d=B,s=B*(k-1)*D,c=B*(k+1)*D,f=-B*R,g=2*D,p=-R,qI=(d+s)/(1-g-p),mI=(c+f)/(1-g-p),new Float32Array([d,s,c,f,g,p,qI,mI])}function UI(I,k,D,R,B,A){var M,q,m,y,U,C,$,n,Z,Q,K,G,J,w,L,O,j,T,X,V,Y,z,N,E,x,b,S,F,a,H;for(x=0;x<A;x++){z=x*B,N=x,E=0,M=I[z],q=M&255,m=M>>8&255,y=M>>16&255,U=M>>24&255,T=q*R[6],X=m*R[6],V=y*R[6],Y=U*R[6],w=T,L=X,O=V,j=Y,S=R[0],F=R[1],a=R[4],H=R[5];for(b=0;b<B;b++)M=I[z],C=M&255,$=M>>8&255,n=M>>16&255,Z=M>>24&255,Q=C*S+q*F+w*a+T*H,K=$*S+m*F+L*a+X*H,G=n*S+y*F+O*a+V*H,J=Z*S+U*F+j*a+Y*H,T=w,X=L,V=O,Y=j,w=Q,L=K,O=G,j=J,q=C,m=$,y=n,U=Z,D[E]=w,D[E+1]=L,D[E+2]=O,D[E+3]=j,E+=4,z++;z--,E-=4,N+=A*(B-1),M=I[z],q=M&255,m=M>>8&255,y=M>>16&255,U=M>>24&255,T=q*R[7],X=m*R[7],V=y*R[7],Y=U*R[7],w=T,L=X,O=V,j=Y,C=q,$=m,n=y,Z=U,S=R[2],F=R[3];for(b=B-1;b>=0;b--)Q=C*S+q*F+w*a+T*H,K=$*S+m*F+L*a+X*H,G=n*S+y*F+O*a+V*H,J=Z*S+U*F+j*a+Y*H,T=w,X=L,V=O,Y=j,w=Q,L=K,O=G,j=J,q=C,m=$,y=n,U=Z,M=I[z],C=M&255,$=M>>8&255,n=M>>16&255,Z=M>>24&255,M=(D[E]+w<<0)+(D[E+1]+L<<8)+(D[E+2]+O<<16)+(D[E+3]+j<<24),k[N]=M,z--,E-=4,N-=A}}function XI(I,k,D,R){if(!R)return;var B=new Uint32Array(I.buffer),A=new Uint32Array(B.length),M=new Float32Array(Math.max(k,D)*4),q=NI(R);UI(B,A,M,q,k,D,R),UI(A,B,M,q,D,k,R)}nI.exports=XI});var h=4;var LI=2;function _(I,k,D,R,B,A){let M=D/I,q=R/k,m=(2*A+LI+1)/B;if(m>0.5)return[{toWidth:D,toHeight:R}];let y=Math.ceil(Math.log(Math.min(M,q))/Math.log(m));if(y<=1)return[{toWidth:D,toHeight:R}];let U=[];for(let C=0;C<y;C++){let $=Math.round(Math.pow(Math.pow(I,y-C-1)*Math.pow(D,C+1),1/y)),n=Math.round(Math.pow(Math.pow(k,y-C-1)*Math.pow(R,C+1),1/y));U.push({toWidth:$,toHeight:n})}return U}function TI(I,k){let R=new OffscreenCanvas(k.width,k.height).getContext("2d");if(!R)throw new Error("Picsquish error: canvas 2D context not supported");return R.globalCompositeOperation="copy",R.drawImage(I,k.x,k.y,k.width,k.height,0,0,k.width,k.height),R.getImageData(0,0,k.width,k.height).data.buffer}function zI(I,k,D){let R=new Uint8ClampedArray(D.width*D.height*h);for(let B=0;B<D.height;B++){let A=((D.y+B)*k+D.x)*h,M=B*D.width*h;R.set(I.subarray(A,A+D.width*h),M)}return R.buffer}function i(I,k,D){if(I instanceof ImageBitmap)return TI(I,D);else return zI(I,k,D)}var e=0.00001;function u(I){let k=Math.round(I);if(Math.abs(I-k)<e)return k;return Math.floor(I)}function t(I){let k=Math.round(I);if(Math.abs(I-k)<e)return k;return Math.ceil(I)}function r(I,k,D,R,B,A,M,q,m,y,U){let C=R/k,$=B/D,n=u(A*C)-2*M,Z=u(A*$)-2*M;if(n<1||Z<1)throw new Error("Picsquish error: target tile width/height is too small");let Q,K,G,J,w,L,O=[];for(J=0;J<B;J+=Z)for(G=0;G<R;G+=n){if(Q=G-M,Q<0)Q=0;if(w=G+n+M-Q,Q+w>=R)w=R-Q;if(K=J-M,K<0)K=0;if(L=J+Z+M-K,K+L>=B)L=B-K;let j={toX:Q,toY:K,toWidth:w,toHeight:L,toInnerX:G,toInnerY:J,toInnerWidth:n,toInnerHeight:Z,offsetX:Q/C-u(Q/C),offsetY:K/$-u(K/$),scaleX:C,scaleY:$,x:u(Q/C),y:u(K/$),width:t(w/C),height:t(L/$),initialSize:A,filterPadding:M,filter:q,unsharpAmount:m,unsharpRadius:y,unsharpThreshold:U},T=i(I,k,j);O.push({tile:T,...j})}return O}async function II(I){let k,D,R,B,A,M;if(I.image instanceof Blob||I.image instanceof ImageBitmap){let m=I.image instanceof ImageBitmap?I.image:await createImageBitmap(I.image);k=m,D=m.width,R=m.height;let y=I.maxDimension/D,U=I.maxDimension/R,C=Math.min(y,U,1),$=Math.floor(D*C),n=Math.floor(R*C);B=_(D,R,$,n,I.tileOptions.initialSize,I.tileOptions.filterPadding)}else k=I.image.from,D=I.image.fromWidth,R=I.image.fromHeight,B=I.image.stages;A=B[0].toWidth,M=B[0].toHeight;let q=r(k,D,R,A,M,I.tileOptions.initialSize,I.tileOptions.filterPadding,I.tileOptions.filter,I.tileOptions.unsharpAmount,I.tileOptions.unsharpRadius,I.tileOptions.unsharpThreshold);if(k instanceof ImageBitmap)k.close();return{tileTransforms:q,stages:B}}var v={box:{win:0.5,fn:(I)=>{if(I<0)I=-I;return I<0.5?1:0}},hamming:{win:1,fn:(I)=>{if(I<0)I=-I;if(I>=1)return 0;if(I<0.00000011920929)return 1;let k=I*Math.PI;return Math.sin(k)/k*(0.54+0.46*Math.cos(k/1))}},lanczos2:{win:2,fn:(I)=>{if(I<0)I=-I;if(I>=2)return 0;if(I<0.00000011920929)return 1;let k=I*Math.PI;return Math.sin(k)/k*Math.sin(k/2)/(k/2)}},lanczos3:{win:3,fn:(I)=>{if(I<0)I=-I;if(I>=3)return 0;if(I<0.00000011920929)return 1;let k=I*Math.PI;return Math.sin(k)/k*Math.sin(k/3)/(k/3)}},mks2013:{win:2.5,fn:(I)=>{if(I<0)I=-I;if(I>=2.5)return 0;if(I>=1.5)return-0.125*(I-2.5)*(I-2.5);if(I>=0.5)return 0.25*(4*I*I-11*I+7);return 1.0625-1.75*I*I}}};var OI=14;function kI(I){return Math.round(I*((1<<OI)-1))}function o(I,k,D,R,B){let A=v[I].fn,M=1/R,q=Math.min(1,R),m=v[I].win/q,y,U,C,$,n,Z,Q,K,G,J,w,L,O,j,T,X,V,Y=Math.floor((m+1)*2),z=new Int16Array((Y+2)*D),N=0,E=!z.subarray||!z.set;for(y=0;y<D;y++){U=(y+0.5)*M+B,C=Math.max(0,Math.floor(U-m)),$=Math.min(k-1,Math.ceil(U+m)),n=$-C+1,Z=new Float32Array(n),Q=new Int16Array(n),K=0;for(G=C,J=0;G<=$;G++,J++)w=A((G+0.5-U)*q),K+=w,Z[J]=w;L=0;for(J=0;J<Z.length;J++)O=Z[J]/K,L+=O,Q[J]=kI(O);Q[D>>1]+=kI(1-L),j=0;while(j<Q.length&&Q[j]===0)j++;if(j<Q.length){T=Q.length-1;while(T>0&&Q[T]===0)T--;if(X=C+j,V=T-j+1,z[N++]=X,z[N++]=V,!E)z.set(Q.subarray(j,T+1),N),N+=V;else for(J=j;J<=T;J++)z[N++]=Q[J]}else z[N++]=0,z[N++]=0}return z}function P(I){return I<0?0:I>255?255:I}function W(I){return I>=0?I:0}function RI(I,k,D,R,B,A){let M,q,m,y,U,C,$,n,Z,Q,K,G=0,J=0;for(Z=0;Z<R;Z++){U=0;for(Q=0;Q<B;Q++){C=A[U++],$=A[U++],n=G+C*4|0,M=q=m=y=0;for(;$>0;$--)K=A[U++],y=y+K*I[n+3]|0,m=m+K*I[n+2]|0,q=q+K*I[n+1]|0,M=M+K*I[n]|0,n=n+4|0;k[J+3]=W(y>>7),k[J+2]=W(m>>7),k[J+1]=W(q>>7),k[J]=W(M>>7),J=J+R*4|0}J=(Z+1)*4|0,G=(Z+1)*D*4|0}}function MI(I,k,D,R,B,A){let M,q,m,y,U,C,$,n,Z,Q,K,G=0,J=0;for(Z=0;Z<R;Z++){U=0;for(Q=0;Q<B;Q++){C=A[U++],$=A[U++],n=G+C*4|0,M=q=m=y=0;for(;$>0;$--)K=A[U++],y=y+K*I[n+3]|0,m=m+K*I[n+2]|0,q=q+K*I[n+1]|0,M=M+K*I[n]|0,n=n+4|0;M>>=7,q>>=7,m>>=7,y>>=7,k[J+3]=P(y+8192>>14),k[J+2]=P(m+8192>>14),k[J+1]=P(q+8192>>14),k[J]=P(M+8192>>14),J=J+R*4|0}J=(Z+1)*4|0,G=(Z+1)*D*4|0}}function DI(I,k,D,R,B,A){let M,q,m,y,U,C,$,n,Z,Q,K,G,J=0,w=0;for(Q=0;Q<R;Q++){C=0;for(K=0;K<B;K++){$=A[C++],n=A[C++],Z=J+$*4|0,M=q=m=y=0;for(;n>0;n--)G=A[C++],U=I[Z+3],y=y+G*U|0,m=m+G*I[Z+2]*U|0,q=q+G*I[Z+1]*U|0,M=M+G*I[Z]*U|0,Z=Z+4|0;m=m/255|0,q=q/255|0,M=M/255|0,k[w+3]=W(y>>7),k[w+2]=W(m>>7),k[w+1]=W(q>>7),k[w]=W(M>>7),w=w+R*4|0}w=(Q+1)*4|0,J=(Q+1)*D*4|0}}function BI(I,k,D,R,B,A){let M,q,m,y,U,C,$,n,Z,Q,K,G=0,J=0;for(Z=0;Z<R;Z++){U=0;for(Q=0;Q<B;Q++){C=A[U++],$=A[U++],n=G+C*4|0,M=q=m=y=0;for(;$>0;$--)K=A[U++],y=y+K*I[n+3]|0,m=m+K*I[n+2]|0,q=q+K*I[n+1]|0,M=M+K*I[n]|0,n=n+4|0;if(M>>=7,q>>=7,m>>=7,y>>=7,y=P(y+8192>>14),y>0)M=M*255/y|0,q=q*255/y|0,m=m*255/y|0;k[J+3]=y,k[J+2]=P(m+8192>>14),k[J+1]=P(q+8192>>14),k[J]=P(M+8192>>14),J=J+R*4|0}J=(Z+1)*4|0,G=(Z+1)*D*4|0}}function EI(I,k,D){let R=3,B=k*D*4|0;while(R<B){if(I[R]!==255)return!0;R=R+4|0}return!1}function VI(I,k,D){let R=3,B=k*D*4|0;while(R<B)I[R]=255,R=R+4|0}function yI(I,k,D,R,B,A,M,q,m,y){let U=o(k,D,B,M,m),C=o(k,R,A,q,y),$=new Uint8Array(B*A*4),n=new Uint16Array(B*R*4);if(EI(I,D,R))DI(I,n,D,R,B,U),BI(n,$,R,B,A,C);else RI(I,n,D,R,B,U),MI(n,$,R,B,A,C),VI($,B,A);return $}var CI=wI(AI(),1);function YI(I,k,D){let R=k*D,B=new Uint16Array(R),A,M,q,m;for(let y=0;y<R;y++)A=I[4*y],M=I[4*y+1],q=I[4*y+2],m=A>=M&&A>=q?A:M>=q&&M>=A?M:q,B[y]=m<<8;return B}function JI(I,k,D,R,B,A){let M,q,m,y,U;if(R===0||B<0.5)return;if(B>2)B=2;let C=YI(I,k,D),$=new Uint16Array(C);CI.default($,k,D,B);let n=R/100*4096+0.5|0,Z=A<<8,Q=k*D;for(let K=0;K<Q;K++)if(M=C[K],y=M-$[K],Math.abs(y)>=Z)q=M+(n*y+2048>>12),q=q>65280?65280:q,q=q<0?0:q,M=M!==0?M:1,m=(q<<12)/M|0,U=K*4,I[U]=I[U]*m+2048>>12,I[U+1]=I[U+1]*m+2048>>12,I[U+2]=I[U+2]*m+2048>>12}function KI(I){let k=yI(new Uint8ClampedArray(I.tile),I.filter,I.width,I.height,I.toWidth,I.toHeight,I.scaleX,I.scaleY,I.offsetX,I.offsetY);if(I.unsharpAmount)JI(k,I.toWidth,I.toHeight,I.unsharpAmount,I.unsharpRadius,I.unsharpThreshold);return k}var SI=async(I)=>{let{taskId:k,squishId:D,taskType:R,image:B,maxDimension:A,tileOptions:M}=I,{tileTransforms:q,stages:m}=await II({image:B,maxDimension:A,tileOptions:M}),y={taskId:k,squishId:D,taskType:R,output:{tileTransforms:q,stages:m}},U=q.map((C)=>C.tile);self.postMessage(y,U)};function FI(I){let{taskId:k,squishId:D,taskType:R,tileTransform:B}=I;B.tile=KI(B).buffer;let A={taskId:k,squishId:D,taskType:R,output:{tileTransform:B}};self.postMessage(A,[B.tile])}self.onmessage=async(I)=>{try{switch(I.data.taskType){case 0:return SI(I.data);case 1:return FI(I.data)}}catch(k){self.postMessage({taskId:I.data.taskId,squishId:I.data.squishId,taskType:I.data.taskType,error:k})}};
`,hn=new Blob([Hn],{type:"application/javascript"});class $n{#n;#k;#I;#m;constructor(){this.#n=new Map,this.#k=new Map,this.#I=null,this.#m=null}#R(){if(this.#I===null)return;clearTimeout(this.#I),this.#I=null}prepare(n,k,I){if(this.#n.size)return;this.#m=I;let m=URL.createObjectURL(hn);while(this.#n.size<k){let T=new Worker(m);T.onmessage=n,this.#n.set(T,null)}URL.revokeObjectURL(m)}assignTask(n,k,I,m){this.#n.set(n,k.id),this.#k.set(k.id,n),this.#R(),n.postMessage(I,m)}setTimeout(){if(this.#I!==null)return;this.#I=setTimeout(()=>{for(let n of this.#n.keys())n.terminate();this.#n.clear(),this.#k.clear()},this.#m||0)}getAvailableWorkers(){let n=[];for(let[k,I]of this.#n.entries())if(I===null)n.push(k);return n}removeTask(n){let k=this.#k.get(n);if(k)this.#n.set(k,null);this.#k.delete(n)}}var H=new $n;var e=(()=>{let n=0;return()=>++n})();class Zn{#n;#k;#I;constructor(){this.#n=new Map,this.#k=[],this.#I=[]}#m(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:0,image:k.data.image,maxDimension:k.data.maxDimension,tileOptions:k.data.tileOptions},m=k.data.image instanceof ImageBitmap?[k.data.image]:[];H.assignTask(n,k,I,m)}#R(n,k){let I={taskId:k.id,squishId:k.squishId,taskType:1,tileTransform:k.data.tileTransform};H.assignTask(n,k,I,[I.tileTransform.tile])}#M(n){let k=this.#k.shift();if(k)return this.#m(n,k);let I=this.#I.shift();if(I)return this.#R(n,I)}#T(){if(this.#k.length===0&&this.#I.length===0)return H.setTimeout();let k=H.getAvailableWorkers();for(let I of k)this.#M(I)}#y(n,k){let{squishId:I,output:m}=k,T=m.stages[0].toWidth,y=m.stages[0].toHeight;n.to=new Uint8ClampedArray(T*y*u),n.toWidth=T,n.toHeight=y,n.stages=m.stages,n.remainingTileCount=m.tileTransforms.length;for(let R of m.tileTransforms)this.#I.push({id:e(),squishId:I,data:{tileTransform:R}})}#B(n,k){let{squishId:I,output:m}=k;if(!n.to)throw new Error("Picsquish error: squishContext.to not found");if(d(n.to,n.toWidth,m.tileTransform),n.remainingTileCount--,n.remainingTileCount)return;if(n.stages.shift(),!n.stages[0])return n.resolve(new o(n.to,n.toWidth,n.toHeight));this.#k.push({id:e(),squishId:I,data:{image:{from:n.to,fromWidth:n.toWidth,fromHeight:n.toHeight,stages:n.stages},maxDimension:n.maxDimension,tileOptions:n.tileOptions}})}#D(n){let k=this.#n.get(n.data.squishId);if(!k)throw new Error("Picsquish error: squishContext not found");if(n.data.error)k.reject(n.data.error);switch(n.data.taskType){case 0:this.#y(k,n.data);break;case 1:this.#B(k,n.data);break}H.removeTask(n.data.taskId),this.#T()}add(n,k,I){return H.prepare((m)=>this.#D(m),k,I),new Promise((m,T)=>{let y=e();this.#n.set(y,{maxDimension:n.maxDimension,tileOptions:n.tileOptions,to:null,toWidth:0,toHeight:0,stages:[],remainingTileCount:1/0,resolve:m,reject:T}),this.#k.push({id:y,squishId:y,data:n}),this.#T()})}}var jn=new Zn;async function gn(n,k,I){let m=null,T,y,R;for(;;){let M=await Rn({image:m||n,maxDimension:k,tileOptions:I});y=M.stages[0].toWidth,R=M.stages[0].toHeight,T=new Uint8ClampedArray(y*R*u);for(let D of M.tileTransforms)D.tile=Jn(D).buffer,d(T,y,D);if(M.stages.shift(),m={from:T,fromWidth:y,fromHeight:R,stages:M.stages},!M.stages[0])break}return new o(T,y,R)}async function Hk(n,k,I={}){let m=I.tileSize||1024,T=I.filter||"mks2013",y=I.unsharpAmount||0,R=I.unsharpRadius||0,M=I.unsharpThreshold||0,D=I.useMainThread,B=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,w=I.maxWorkerPoolSize||Math.min(B,4),A=I.maxWorkerIdleTime||2000,Q=3,U=Math.ceil(Math.max(3,2.5*R|0)),C={initialSize:m,filterPadding:U,filter:T,unsharpAmount:y,unsharpRadius:R,unsharpThreshold:M};if(D)return await gn(n,k,C);return jn.add({image:n,maxDimension:k,tileOptions:C},w,A)}export{Hk as squish};
