var ED=Object.create;var{getPrototypeOf:XD,defineProperty:f,getOwnPropertyNames:YD}=Object;var ID=Object.prototype.hasOwnProperty;var zD=(D,A,U)=>{U=D!=null?ED(XD(D)):{};let B=A||!D||!D.__esModule?f(U,"default",{value:D,enumerable:!0}):U;for(let J of YD(D))if(!ID.call(B,J))f(B,J,{get:()=>D[J],enumerable:!0});return B};var CD=(D,A)=>()=>(A||D((A={exports:{}}).exports,A),A.exports);var jD=CD((G0,ZD)=>{var x,n,m,h,W,_,KD,$D;function pD(D){if(D<0.5)D=0.5;var A=Math.exp(0.527076)/D,U=Math.exp(-A),B=Math.exp(-2*A),J=(1-U)*(1-U)/(1+2*A*U-B);return x=J,n=J*(A-1)*U,m=J*(A+1)*U,h=-J*B,W=2*U,_=-B,KD=(x+n)/(1-W-_),$D=(m+h)/(1-W-_),new Float32Array([x,n,m,h,W,_,KD,$D])}function GD(D,A,U,B,J,$){var K,G,j,Z,y,Q,V,b,R,q,L,N,M,E;for(R=0;R<$;R++){Q=R*J,V=R,b=0,K=D[Q],y=K*B[6],Z=y,L=B[0],N=B[1],M=B[4],E=B[5];for(q=0;q<J;q++)G=D[Q],j=G*L+K*N+Z*M+y*E,y=Z,Z=j,K=G,U[b]=Z,b++,Q++;Q--,b--,V+=$*(J-1),K=D[Q],y=K*B[7],Z=y,G=K,L=B[2],N=B[3];for(q=J-1;q>=0;q--)j=G*L+K*N+Z*M+y*E,y=Z,Z=j,K=G,G=D[Q],A[V]=U[b]+Z,Q--,b--,V-=$}}function kD(D,A,U,B){if(!B)return;var J=new Uint16Array(D.length),$=new Float32Array(Math.max(A,U)),K=pD(B);GD(D,J,$,K,A,U,B),GD(J,D,$,K,U,A,B)}ZD.exports=kD});class T{raw;width;height;constructor(D,A,U){this.raw=D,this.width=A,this.height=U}toImageData(){return new ImageData(this.raw,this.width,this.height)}toImageBitmap(){return createImageBitmap(this.toImageData())}toCanvas(){let D=document.createElement("canvas");D.width=this.width,D.height=this.height;let A=D.getContext("2d");if(!A)throw new Error("Picsquish error: no canvas 2D context");return A.putImageData(this.toImageData(),0,0),D}toBlob(D){let A=new OffscreenCanvas(this.width,this.height),U=A.getContext("2d");if(!U)throw new Error("Picsquish error: no canvas 2D context");return U.putImageData(this.toImageData(),0,0),A.convertToBlob(D)}}var Y=4;function a(D,A,U){let B=new Uint8ClampedArray(U.tile);for(let J=0;J<U.toHeight;J++){let $=J*U.toWidth*Y,K=((U.toY+J)*A+U.toX)*Y;D.set(B.subarray($,$+U.toWidth*Y),K)}}var OD=`
var Jk=Object.create;var{getPrototypeOf:Kk,defineProperty:m,getOwnPropertyNames:$k}=Object;var Gk=Object.prototype.hasOwnProperty;var Qk=(k,u,M)=>{M=k!=null?Jk(Kk(k)):{};let I=u||!k||!k.__esModule?m(M,"default",{value:k,enumerable:!0}):M;for(let D of $k(k))if(!Gk.call(I,D))m(I,D,{get:()=>k[D],enumerable:!0});return I};var Zk=(k,u)=>()=>(u||k((u={exports:{}}).exports,u),u.exports);var Mk=Zk((sk,Ik)=>{var v,_,x,g,T,H,i,kk;function Xk(k){if(k<0.5)k=0.5;var u=Math.exp(0.527076)/k,M=Math.exp(-u),I=Math.exp(-2*u),D=(1-M)*(1-M)/(1+2*u*M-I);return v=D,_=D*(u-1)*M,x=D*(u+1)*M,g=-D*I,T=2*M,H=-I,i=(v+_)/(1-T-H),kk=(x+g)/(1-T-H),new Float32Array([v,_,x,g,T,H,i,kk])}function uk(k,u,M,I,D,B){var q,y,U,R,J,Q,b,A,$,Z,G,j,K,C;for($=0;$<B;$++){Q=$*D,b=$,A=0,q=k[Q],J=q*I[6],R=J,G=I[0],j=I[1],K=I[4],C=I[5];for(Z=0;Z<D;Z++)y=k[Q],U=y*G+q*j+R*K+J*C,J=R,R=U,q=y,M[A]=R,A++,Q++;Q--,A--,b+=B*(D-1),q=k[Q],J=q*I[7],R=J,y=q,G=I[2],j=I[3];for(Z=D-1;Z>=0;Z--)U=y*G+q*j+R*K+J*C,J=R,R=U,q=y,y=k[Q],u[b]=M[A]+R,Q--,A--,b-=B}}function Yk(k,u,M,I){if(!I)return;var D=new Uint16Array(k.length),B=new Float32Array(Math.max(u,M)),q=Xk(I);uk(k,D,B,q,u,M,I),uk(D,k,B,q,M,u,I)}Ik.exports=Yk});var S=4;var bk=2;function a(k,u,M,I,D,B){let q=M/k,y=I/u,U=(2*B+bk+1)/D;if(U>0.5)return[{toWidth:M,toHeight:I}];let R=Math.ceil(Math.log(Math.min(q,y))/Math.log(U));if(R<=1)return[{toWidth:M,toHeight:I}];let J=[];for(let Q=0;Q<R;Q++){let b=Math.round(Math.pow(Math.pow(k,R-Q-1)*Math.pow(M,Q+1),1/R)),A=Math.round(Math.pow(Math.pow(u,R-Q-1)*Math.pow(I,Q+1),1/R));J.push({toWidth:b,toHeight:A})}return J}function jk(k,u){if(k)k.width=k.height=0;k=u=null}function Ck(k,u){let M=new OffscreenCanvas(u.width,u.height),I=M.getContext("2d");if(!I)throw new Error("Picsquish error: canvas 2D context not supported");I.globalCompositeOperation="copy",I.drawImage(k,u.x,u.y,u.width,u.height,0,0,u.width,u.height);let D=I.getImageData(0,0,u.width,u.height).data.buffer;return jk(M,I),D}function Lk(k,u,M){let I=new Uint8ClampedArray(M.width*M.height*S);for(let D=0;D<M.height;D++){let B=((M.y+D)*u+M.x)*S,q=D*M.width*S;I.set(k.subarray(B,B+M.width*S),q)}return I.buffer}function h(k,u,M){if(k instanceof ImageBitmap)return Ck(k,M);else return Lk(k,u,M)}var o=0.00001;function O(k){let u=Math.round(k);if(Math.abs(k-u)<o)return u;return Math.floor(k)}function d(k){let u=Math.round(k);if(Math.abs(k-u)<o)return u;return Math.ceil(k)}function P(k,u,M,I,D,B){let{initialSize:q,filterPadding:y,filter:U,unsharpAmount:R,unsharpRadius:J,unsharpThreshold:Q}=B,b=I/u,A=D/M,$=O(q*b)-2*y,Z=O(q*A)-2*y;if($<1||Z<1)throw new Error("Picsquish error: target tile width/height is too small");let G,j,K,C,V,z,L=[];for(C=0;C<D;C+=Z)for(K=0;K<I;K+=$){if(G=K-y,G<0)G=0;if(V=K+$+y-G,G+V>=I)V=I-G;if(j=C-y,j<0)j=0;if(z=C+Z+y-j,j+z>=D)z=D-j;let w={toX:G,toY:j,toWidth:V,toHeight:z,toInnerX:K,toInnerY:C,toInnerWidth:$,toInnerHeight:Z,offsetX:G/b-O(G/b),offsetY:j/A-O(j/A),scaleX:b,scaleY:A,x:O(G/b),y:O(j/A),width:d(V/b),height:d(z/A),initialSize:q,filterPadding:y,filter:U,unsharpAmount:R,unsharpRadius:J,unsharpThreshold:Q},F=h(k,u,w);L.push({tile:F,...w})}return L}async function wk(k,u,M){let I=k instanceof Blob?await createImageBitmap(k):k,D=[];for(let B of M){let q=I,y=I.width,U=I.height,R=B/y,J=B/U,Q=Math.min(R,J,1),b=Math.floor(y*Q),A=Math.floor(U*Q),$=a(y,U,b,A,u.initialSize,u.filterPadding),Z=P(q,y,U,$[0].toWidth,$[0].toHeight,u);D.push({stages:$,tileTransforms:Z})}return I.close(),D}function Vk(k,u){let M=P(k.from,k.fromWidth,k.fromHeight,k.stages[0].toWidth,k.stages[0].toHeight,u);return[{stages:k.stages,tileTransforms:M}]}async function c(k){if(k.image instanceof Blob||k.image instanceof ImageBitmap)return wk(k.image,k.tileOptions,k.dimensionLimits);else return Vk(k.image,k.tileOptions)}var W={box:{win:0.5,fn:(k)=>{if(k<0)k=-k;return k<0.5?1:0}},hamming:{win:1,fn:(k)=>{if(k<0)k=-k;if(k>=1)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*(0.54+0.46*Math.cos(u/1))}},lanczos2:{win:2,fn:(k)=>{if(k<0)k=-k;if(k>=2)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/2)/(u/2)}},lanczos3:{win:3,fn:(k)=>{if(k<0)k=-k;if(k>=3)return 0;if(k<0.00000011920929)return 1;let u=k*Math.PI;return Math.sin(u)/u*Math.sin(u/3)/(u/3)}},mks2013:{win:2.5,fn:(k)=>{if(k<0)k=-k;if(k>=2.5)return 0;if(k>=1.5)return-0.125*(k-2.5)*(k-2.5);if(k>=0.5)return 0.25*(4*k*k-11*k+7);return 1.0625-1.75*k*k}}};var zk=14;function s(k){return Math.round(k*((1<<zk)-1))}function n(k,u,M,I,D){let B=W[k].fn,q=1/I,y=Math.min(1,I),U=W[k].win/y,R,J,Q,b,A,$,Z,G,j,K,C,V,z,L,w,F,p,Ak=Math.floor((U+1)*2),N=new Int16Array((Ak+2)*M),Y=0,Bk=!N.subarray||!N.set;for(R=0;R<M;R++){J=(R+0.5)*q+D,Q=Math.max(0,Math.floor(J-U)),b=Math.min(u-1,Math.ceil(J+U)),A=b-Q+1,$=new Float32Array(A),Z=new Int16Array(A),G=0;for(j=Q,K=0;j<=b;j++,K++)C=B((j+0.5-J)*y),G+=C,$[K]=C;V=0;for(K=0;K<$.length;K++)z=$[K]/G,V+=z,Z[K]=s(z);Z[M>>1]+=s(1-V),L=0;while(L<Z.length&&Z[L]===0)L++;if(L<Z.length){w=Z.length-1;while(w>0&&Z[w]===0)w--;if(F=Q+L,p=w-L+1,N[Y++]=F,N[Y++]=p,!Bk)N.set(Z.subarray(L,w+1),Y),Y+=p;else for(K=L;K<=w;K++)N[Y++]=Z[K]}else N[Y++]=0,N[Y++]=0}return N}function E(k){return k<0?0:k>255?255:k}function X(k){return k>=0?k:0}function f(k,u,M,I,D,B){let q,y,U,R,J,Q,b,A,$,Z,G,j=0,K=0;for($=0;$<I;$++){J=0;for(Z=0;Z<D;Z++){Q=B[J++],b=B[J++],A=j+Q*4|0,q=y=U=R=0;for(;b>0;b--)G=B[J++],R=R+G*k[A+3]|0,U=U+G*k[A+2]|0,y=y+G*k[A+1]|0,q=q+G*k[A]|0,A=A+4|0;u[K+3]=X(R>>7),u[K+2]=X(U>>7),u[K+1]=X(y>>7),u[K]=X(q>>7),K=K+I*4|0}K=($+1)*4|0,j=($+1)*M*4|0}}function l(k,u,M,I,D,B){let q,y,U,R,J,Q,b,A,$,Z,G,j=0,K=0;for($=0;$<I;$++){J=0;for(Z=0;Z<D;Z++){Q=B[J++],b=B[J++],A=j+Q*4|0,q=y=U=R=0;for(;b>0;b--)G=B[J++],R=R+G*k[A+3]|0,U=U+G*k[A+2]|0,y=y+G*k[A+1]|0,q=q+G*k[A]|0,A=A+4|0;q>>=7,y>>=7,U>>=7,R>>=7,u[K+3]=E(R+8192>>14),u[K+2]=E(U+8192>>14),u[K+1]=E(y+8192>>14),u[K]=E(q+8192>>14),K=K+I*4|0}K=($+1)*4|0,j=($+1)*M*4|0}}function r(k,u,M,I,D,B){let q,y,U,R,J,Q,b,A,$,Z,G,j,K=0,C=0;for(Z=0;Z<I;Z++){Q=0;for(G=0;G<D;G++){b=B[Q++],A=B[Q++],$=K+b*4|0,q=y=U=R=0;for(;A>0;A--)j=B[Q++],J=k[$+3],R=R+j*J|0,U=U+j*k[$+2]*J|0,y=y+j*k[$+1]*J|0,q=q+j*k[$]*J|0,$=$+4|0;U=U/255|0,y=y/255|0,q=q/255|0,u[C+3]=X(R>>7),u[C+2]=X(U>>7),u[C+1]=X(y>>7),u[C]=X(q>>7),C=C+I*4|0}C=(Z+1)*4|0,K=(Z+1)*M*4|0}}function e(k,u,M,I,D,B){let q,y,U,R,J,Q,b,A,$,Z,G,j=0,K=0;for($=0;$<I;$++){J=0;for(Z=0;Z<D;Z++){Q=B[J++],b=B[J++],A=j+Q*4|0,q=y=U=R=0;for(;b>0;b--)G=B[J++],R=R+G*k[A+3]|0,U=U+G*k[A+2]|0,y=y+G*k[A+1]|0,q=q+G*k[A]|0,A=A+4|0;if(q>>=7,y>>=7,U>>=7,R>>=7,R=E(R+8192>>14),R>0)q=q*255/R|0,y=y*255/R|0,U=U*255/R|0;u[K+3]=R,u[K+2]=E(U+8192>>14),u[K+1]=E(y+8192>>14),u[K]=E(q+8192>>14),K=K+I*4|0}K=($+1)*4|0,j=($+1)*M*4|0}}function Nk(k,u,M){let I=3,D=u*M*4|0;while(I<D){if(k[I]!==255)return!0;I=I+4|0}return!1}function Ek(k,u,M){let I=3,D=u*M*4|0;while(I<D)k[I]=255,I=I+4|0}function t(k,u,M,I,D,B,q,y,U,R){let J=n(u,M,D,q,U),Q=n(u,I,B,y,R),b=new Uint8Array(D*B*4),A=new Uint16Array(D*I*4);if(Nk(k,M,I))r(k,A,M,I,D,J),e(A,b,I,D,B,Q);else f(k,A,M,I,D,J),l(A,b,I,D,B,Q),Ek(b,D,B);return b}var qk=Qk(Mk(),1);function Ok(k,u,M){let I=u*M,D=new Uint16Array(I),B,q,y,U;for(let R=0;R<I;R++)B=k[4*R],q=k[4*R+1],y=k[4*R+2],U=B>=q&&B>=y?B:q>=y&&q>=B?q:y,D[R]=U<<8;return D}function Dk(k,u,M,I,D,B){let q,y,U,R,J;if(I===0||D<0.5)return;if(D>2)D=2;let Q=Ok(k,u,M),b=new Uint16Array(Q);qk.default(b,u,M,D);let A=I/100*4096+0.5|0,$=B<<8,Z=u*M;for(let G=0;G<Z;G++)if(q=Q[G],R=q-b[G],Math.abs(R)>=$)y=q+(A*R+2048>>12),y=y>65280?65280:y,y=y<0?0:y,q=q!==0?q:1,U=(y<<12)/q|0,J=G*4,k[J]=k[J]*U+2048>>12,k[J+1]=k[J+1]*U+2048>>12,k[J+2]=k[J+2]*U+2048>>12}function yk(k){let u=t(new Uint8ClampedArray(k.tile),k.filter,k.width,k.height,k.toWidth,k.toHeight,k.scaleX,k.scaleY,k.offsetX,k.offsetY);if(k.unsharpAmount)Dk(u,k.toWidth,k.toHeight,k.unsharpAmount,k.unsharpRadius,k.unsharpThreshold);return u}async function Rk(k){let{taskId:u,squishId:M,taskType:I,data:D}=k,{image:B,dimensionLimits:q,tileOptions:y}=D;try{let U=await c({image:B,dimensionLimits:q,tileOptions:y});return{taskId:u,squishId:M,taskType:I,output:U}}catch(U){return{taskId:u,squishId:M,taskType:I,output:U}}}function Uk(k){let{taskId:u,squishId:M,workspaceIndex:I,taskType:D,data:B}=k,{tileTransform:q}=B;try{return q.tile=yk(q).buffer,{taskId:u,squishId:M,workspaceIndex:I,taskType:D,output:q}}catch(y){return{taskId:u,squishId:M,workspaceIndex:I,taskType:D,output:y}}}self.onmessage=async(k)=>{switch(k.data.taskType){case 0:{let u=k.data,M=await Rk(u),I=M.output instanceof Error?[]:M.output.flatMap((D)=>D.tileTransforms.map((B)=>B.tile));return self.postMessage(M,I)}case 1:{let u=k.data,M=Uk(u),I=M.output instanceof Error?[]:[M.output.tile];return self.postMessage(M,I)}}};
`,FD=new Blob([OD],{type:"application/javascript"});class l{#D;#U;#A;#B;constructor(){this.#D=new Map,this.#U=new Map,this.#A=null,this.#B=null}#J(){if(this.#A===null)return;clearTimeout(this.#A),this.#A=null}prepare(D,A,U){if(this.#D.size)return;this.#B=U;let B=URL.createObjectURL(FD);while(this.#D.size<A){let J=new Worker(B);J.onmessage=D,this.#D.set(J,null)}URL.revokeObjectURL(B)}assignTask(D,A,U,B){this.#D.set(D,A),this.#U.set(A,D),this.#J(),D.postMessage(U,B)}setTimeout(){if(this.#A!==null)return;if(this.#D.size===0)return;this.#A=setTimeout(()=>{for(let D of this.#D.keys())D.terminate();this.#D.clear(),this.#U.clear()},this.#B||0)}getAvailableWorkers(){let D=[];for(let[A,U]of this.#D.entries())if(U===null)D.push(A);return D}removeTask(D){let A=this.#U.get(D);if(A)this.#D.set(A,null);this.#U.delete(D)}}var v=new l;var SD=2;function o(D,A,U,B,J,$){let K=U/D,G=B/A,j=(2*$+SD+1)/J;if(j>0.5)return[{toWidth:U,toHeight:B}];let Z=Math.ceil(Math.log(Math.min(K,G))/Math.log(j));if(Z<=1)return[{toWidth:U,toHeight:B}];let y=[];for(let Q=0;Q<Z;Q++){let V=Math.round(Math.pow(Math.pow(D,Z-Q-1)*Math.pow(U,Q+1),1/Z)),b=Math.round(Math.pow(Math.pow(A,Z-Q-1)*Math.pow(B,Q+1),1/Z));y.push({toWidth:V,toHeight:b})}return y}function HD(D,A){if(D)D.width=D.height=0;D=A=null}function vD(D,A){let U=new OffscreenCanvas(A.width,A.height),B=U.getContext("2d");if(!B)throw new Error("Picsquish error: canvas 2D context not supported");B.globalCompositeOperation="copy",B.drawImage(D,A.x,A.y,A.width,A.height,0,0,A.width,A.height);let J=B.getImageData(0,0,A.width,A.height).data.buffer;return HD(U,B),J}function wD(D,A,U){let B=new Uint8ClampedArray(U.width*U.height*Y);for(let J=0;J<U.height;J++){let $=((U.y+J)*A+U.x)*Y,K=J*U.width*Y;B.set(D.subarray($,$+U.width*Y),K)}return B.buffer}function s(D,A,U){if(D instanceof ImageBitmap)return vD(D,U);else return wD(D,A,U)}var i=0.00001;function w(D){let A=Math.round(D);if(Math.abs(D-A)<i)return A;return Math.floor(D)}function r(D){let A=Math.round(D);if(Math.abs(D-A)<i)return A;return Math.ceil(D)}function p(D,A,U,B,J,$){let{initialSize:K,filterPadding:G,filter:j,unsharpAmount:Z,unsharpRadius:y,unsharpThreshold:Q}=$,V=B/A,b=J/U,R=w(K*V)-2*G,q=w(K*b)-2*G;if(R<1||q<1)throw new Error("Picsquish error: target tile width/height is too small");let L,N,M,E,z,C,X=[];for(E=0;E<J;E+=q)for(M=0;M<B;M+=R){if(L=M-G,L<0)L=0;if(z=M+R+G-L,L+z>=B)z=B-L;if(N=E-G,N<0)N=0;if(C=E+q+G-N,N+C>=J)C=J-N;let I={toX:L,toY:N,toWidth:z,toHeight:C,toInnerX:M,toInnerY:E,toInnerWidth:R,toInnerHeight:q,offsetX:L/V-w(L/V),offsetY:N/b-w(N/b),scaleX:V,scaleY:b,x:w(L/V),y:w(N/b),width:r(z/V),height:r(C/b),initialSize:K,filterPadding:G,filter:j,unsharpAmount:Z,unsharpRadius:y,unsharpThreshold:Q},P=s(D,A,I);X.push({tile:P,...I})}return X}async function PD(D,A,U){let B=D instanceof Blob?await createImageBitmap(D):D,J=[];for(let $ of U){let K=B,G=B.width,j=B.height,Z=$/G,y=$/j,Q=Math.min(Z,y,1),V=Math.floor(G*Q),b=Math.floor(j*Q),R=o(G,j,V,b,A.initialSize,A.filterPadding),q=p(K,G,j,R[0].toWidth,R[0].toHeight,A);J.push({stages:R,tileTransforms:q})}return B.close(),J}function WD(D,A){let U=p(D.from,D.fromWidth,D.fromHeight,D.stages[0].toWidth,D.stages[0].toHeight,A);return[{stages:D.stages,tileTransforms:U}]}async function t(D){if(D.image instanceof Blob||D.image instanceof ImageBitmap)return PD(D.image,D.tileOptions,D.dimensionLimits);else return WD(D.image,D.tileOptions)}var k={box:{win:0.5,fn:(D)=>{if(D<0)D=-D;return D<0.5?1:0}},hamming:{win:1,fn:(D)=>{if(D<0)D=-D;if(D>=1)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*(0.54+0.46*Math.cos(A/1))}},lanczos2:{win:2,fn:(D)=>{if(D<0)D=-D;if(D>=2)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*Math.sin(A/2)/(A/2)}},lanczos3:{win:3,fn:(D)=>{if(D<0)D=-D;if(D>=3)return 0;if(D<0.00000011920929)return 1;let A=D*Math.PI;return Math.sin(A)/A*Math.sin(A/3)/(A/3)}},mks2013:{win:2.5,fn:(D)=>{if(D<0)D=-D;if(D>=2.5)return 0;if(D>=1.5)return-0.125*(D-2.5)*(D-2.5);if(D>=0.5)return 0.25*(4*D*D-11*D+7);return 1.0625-1.75*D*D}}};var _D=14;function e(D){return Math.round(D*((1<<_D)-1))}function g(D,A,U,B,J){let $=k[D].fn,K=1/B,G=Math.min(1,B),j=k[D].win/G,Z,y,Q,V,b,R,q,L,N,M,E,z,C,X,I,P,u,VD=Math.floor((j+1)*2),O=new Int16Array((VD+2)*U),H=0,ND=!O.subarray||!O.set;for(Z=0;Z<U;Z++){y=(Z+0.5)*K+J,Q=Math.max(0,Math.floor(y-j)),V=Math.min(A-1,Math.ceil(y+j)),b=V-Q+1,R=new Float32Array(b),q=new Int16Array(b),L=0;for(N=Q,M=0;N<=V;N++,M++)E=$((N+0.5-y)*G),L+=E,R[M]=E;z=0;for(M=0;M<R.length;M++)C=R[M]/L,z+=C,q[M]=e(C);q[U>>1]+=e(1-z),X=0;while(X<q.length&&q[X]===0)X++;if(X<q.length){I=q.length-1;while(I>0&&q[I]===0)I--;if(P=Q+X,u=I-X+1,O[H++]=P,O[H++]=u,!ND)O.set(q.subarray(X,I+1),H),H+=u;else for(M=X;M<=I;M++)O[H++]=q[M]}else O[H++]=0,O[H++]=0}return O}function F(D){return D<0?0:D>255?255:D}function S(D){return D>=0?D:0}function DD(D,A,U,B,J,$){let K,G,j,Z,y,Q,V,b,R,q,L,N=0,M=0;for(R=0;R<B;R++){y=0;for(q=0;q<J;q++){Q=$[y++],V=$[y++],b=N+Q*4|0,K=G=j=Z=0;for(;V>0;V--)L=$[y++],Z=Z+L*D[b+3]|0,j=j+L*D[b+2]|0,G=G+L*D[b+1]|0,K=K+L*D[b]|0,b=b+4|0;A[M+3]=S(Z>>7),A[M+2]=S(j>>7),A[M+1]=S(G>>7),A[M]=S(K>>7),M=M+B*4|0}M=(R+1)*4|0,N=(R+1)*U*4|0}}function AD(D,A,U,B,J,$){let K,G,j,Z,y,Q,V,b,R,q,L,N=0,M=0;for(R=0;R<B;R++){y=0;for(q=0;q<J;q++){Q=$[y++],V=$[y++],b=N+Q*4|0,K=G=j=Z=0;for(;V>0;V--)L=$[y++],Z=Z+L*D[b+3]|0,j=j+L*D[b+2]|0,G=G+L*D[b+1]|0,K=K+L*D[b]|0,b=b+4|0;K>>=7,G>>=7,j>>=7,Z>>=7,A[M+3]=F(Z+8192>>14),A[M+2]=F(j+8192>>14),A[M+1]=F(G+8192>>14),A[M]=F(K+8192>>14),M=M+B*4|0}M=(R+1)*4|0,N=(R+1)*U*4|0}}function UD(D,A,U,B,J,$){let K,G,j,Z,y,Q,V,b,R,q,L,N,M=0,E=0;for(q=0;q<B;q++){Q=0;for(L=0;L<J;L++){V=$[Q++],b=$[Q++],R=M+V*4|0,K=G=j=Z=0;for(;b>0;b--)N=$[Q++],y=D[R+3],Z=Z+N*y|0,j=j+N*D[R+2]*y|0,G=G+N*D[R+1]*y|0,K=K+N*D[R]*y|0,R=R+4|0;j=j/255|0,G=G/255|0,K=K/255|0,A[E+3]=S(Z>>7),A[E+2]=S(j>>7),A[E+1]=S(G>>7),A[E]=S(K>>7),E=E+B*4|0}E=(q+1)*4|0,M=(q+1)*U*4|0}}function BD(D,A,U,B,J,$){let K,G,j,Z,y,Q,V,b,R,q,L,N=0,M=0;for(R=0;R<B;R++){y=0;for(q=0;q<J;q++){Q=$[y++],V=$[y++],b=N+Q*4|0,K=G=j=Z=0;for(;V>0;V--)L=$[y++],Z=Z+L*D[b+3]|0,j=j+L*D[b+2]|0,G=G+L*D[b+1]|0,K=K+L*D[b]|0,b=b+4|0;if(K>>=7,G>>=7,j>>=7,Z>>=7,Z=F(Z+8192>>14),Z>0)K=K*255/Z|0,G=G*255/Z|0,j=j*255/Z|0;A[M+3]=Z,A[M+2]=F(j+8192>>14),A[M+1]=F(G+8192>>14),A[M]=F(K+8192>>14),M=M+B*4|0}M=(R+1)*4|0,N=(R+1)*U*4|0}}function uD(D,A,U){let B=3,J=A*U*4|0;while(B<J){if(D[B]!==255)return!0;B=B+4|0}return!1}function TD(D,A,U){let B=3,J=A*U*4|0;while(B<J)D[B]=255,B=B+4|0}function JD(D,A,U,B,J,$,K,G,j,Z){let y=g(A,U,J,K,j),Q=g(A,B,$,G,Z),V=new Uint8Array(J*$*4),b=new Uint16Array(J*B*4);if(uD(D,U,B))UD(D,b,U,B,J,y),BD(b,V,B,J,$,Q);else DD(D,b,U,B,J,y),AD(b,V,B,J,$,Q),TD(V,J,$);return V}var bD=zD(jD(),1);function gD(D,A,U){let B=A*U,J=new Uint16Array(B),$,K,G,j;for(let Z=0;Z<B;Z++)$=D[4*Z],K=D[4*Z+1],G=D[4*Z+2],j=$>=K&&$>=G?$:K>=G&&K>=$?K:G,J[Z]=j<<8;return J}function yD(D,A,U,B,J,$){let K,G,j,Z,y;if(B===0||J<0.5)return;if(J>2)J=2;let Q=gD(D,A,U),V=new Uint16Array(Q);bD.default(V,A,U,J);let b=B/100*4096+0.5|0,R=$<<8,q=A*U;for(let L=0;L<q;L++)if(K=Q[L],Z=K-V[L],Math.abs(Z)>=R)G=K+(b*Z+2048>>12),G=G>65280?65280:G,G=G<0?0:G,K=K!==0?K:1,j=(G<<12)/K|0,y=L*4,D[y]=D[y]*j+2048>>12,D[y+1]=D[y+1]*j+2048>>12,D[y+2]=D[y+2]*j+2048>>12}function RD(D){let A=JD(new Uint8ClampedArray(D.tile),D.filter,D.width,D.height,D.toWidth,D.toHeight,D.scaleX,D.scaleY,D.offsetX,D.offsetY);if(D.unsharpAmount)yD(A,D.toWidth,D.toHeight,D.unsharpAmount,D.unsharpRadius,D.unsharpThreshold);return A}async function MD(D){let{taskId:A,squishId:U,taskType:B,data:J}=D,{image:$,dimensionLimits:K,tileOptions:G}=J;try{let j=await t({image:$,dimensionLimits:K,tileOptions:G});return{taskId:A,squishId:U,taskType:B,output:j}}catch(j){return{taskId:A,squishId:U,taskType:B,output:j}}}function QD(D){let{taskId:A,squishId:U,workspaceIndex:B,taskType:J,data:$}=D,{tileTransform:K}=$;try{return K.tile=RD(K).buffer,{taskId:A,squishId:U,workspaceIndex:B,taskType:J,output:K}}catch(G){return{taskId:A,squishId:U,workspaceIndex:B,taskType:J,output:G}}}var c=(()=>{let D=0;return()=>++D})();class qD{#D;#U;#A;constructor(){this.#D=new Map,this.#U=[],this.#A=[]}#B(D,A){let U=c(),B={taskId:U,squishId:D.squishId,taskType:0,data:D.data};if(!A)return MD(B).then(($)=>this.#K($));let J=D.data.image instanceof ImageBitmap?[D.data.image]:[];v.assignTask(A,U,B,J)}#J(D,A){let U=c(),B={taskId:U,squishId:D.squishId,workspaceIndex:D.workspaceIndex,taskType:1,data:D.data};if(!A)return this.#K(QD(B));v.assignTask(A,U,B,[D.data.tileTransform.tile])}#$(D){let A=this.#U.shift();if(A)return this.#B(A,D);let U=this.#A.shift();if(U)return this.#J(U,D)}#G(D){if(this.#U.length===0&&this.#A.length===0)return v.setTimeout();if(D)return this.#$();let U=v.getAvailableWorkers();for(let B of U)this.#$(B)}#Z(D,A){let{squishId:U,output:B}=A;if(B instanceof Error)return D.workspaceHandlers.forEach((J)=>J.reject(B));for(let[J,$]of B.entries()){let K=$.stages[0].toWidth,G=$.stages[0].toHeight;D.workspaces.set(J,{to:new Uint8ClampedArray(K*G*Y),toWidth:K,toHeight:G,stages:$.stages,remainingTileCount:$.tileTransforms.length});for(let j of $.tileTransforms)this.#A.push({squishId:U,workspaceIndex:J,data:{tileTransform:j}})}}#j(D,A){let{squishId:U,workspaceIndex:B,output:J}=A;if(!D.workspaces.has(B))return;let $=D.workspaces.get(B);if(!$)throw new Error("Picsquish error: workspace not found");let K=D.workspaceHandlers.get(B);if(!K)throw new Error("Picsquish error: workspaceHandler not found");if(J instanceof Error)return D.workspaces.delete(B),this.#A=this.#A.filter((j)=>!(j.squishId===U&&j.workspaceIndex===B)),K.reject(J);if(a($.to,$.toWidth,J),--$.remainingTileCount,$.remainingTileCount)return;if($.stages.shift(),!$.stages[0])return D.workspaces.delete(B),K.resolve(new T($.to,$.toWidth,$.toHeight));this.#U.push({squishId:U,data:{image:{from:$.to,fromWidth:$.toWidth,fromHeight:$.toHeight,stages:$.stages},dimensionLimits:[],tileOptions:D.tileOptions}})}#K(D){let A=this.#D.get(D.squishId);if(!A)throw new Error("Picsquish error: squishContext not found");switch(D.taskType){case 0:this.#Z(A,D);break;case 1:this.#j(A,D);break}if(!A.workspaces.size)this.#D.delete(D.squishId);v.removeTask(D.taskId),this.#G(A.useMainThread)}add(D,A,U,B){if(!B)v.prepare((G)=>this.#K(G.data),A,U);let J=[],$=new Map;for(let G=0;G<D.dimensionLimits.length;G++)J.push(new Promise((j,Z)=>{$.set(G,{resolve:j,reject:Z})}));let K=c();return this.#D.set(K,{tileOptions:D.tileOptions,workspaces:new Map,workspaceHandlers:$,useMainThread:B}),this.#U.push({squishId:K,data:D}),queueMicrotask(()=>this.#G(B)),J}}var d=new qD;function LD(D){let A=new OffscreenCanvas(D.width,D.height),U=A.getContext("2d");if(!U)throw new Error("Picsquish error: no canvas 2D context");return U.drawImage(D,0,0),A.transferToImageBitmap()}function p0(D,A,U={}){let B=U.tileSize||1024,J=U.filter||"mks2013",$=U.unsharpAmount||0,K=U.unsharpRadius||0,G=U.unsharpThreshold||0,j=!!U.useMainThread,Z=typeof navigator==="undefined"?1:navigator.hardwareConcurrency,y=U.maxWorkerPoolSize||Math.min(Z,4),Q=U.maxWorkerIdleTime||2000,V=3,b=Math.ceil(Math.max(3,2.5*K|0)),R={initialSize:B,filterPadding:b,filter:J,unsharpAmount:$,unsharpRadius:K,unsharpThreshold:G},q=D instanceof Blob?D:LD(D);if(A instanceof Array)return d.add({image:q,dimensionLimits:A,tileOptions:R},y,Q,j);return d.add({image:q,dimensionLimits:[A],tileOptions:R},y,Q,j)[0]}export{p0 as squish};
